<?xml version="1.0" ?>
<!DOCTYPE ftcs SYSTEM "futuretense_cs.dtd">
<ftcs version="1.2">
<!-- OpenMarket/CSClient/DoFinish
-
- INPUT
-
- OUTPUT
-
-->
<IF COND="IsVariable.finish:DueDate=true">
<THEN>
	<SETVAR NAME="useDefaultDeadline" VALUE="false"/>
	<CALLELEMENT NAME="OpenMarket/CSClient/Util/FixDate">
		<ARGUMENT NAME="cs_InDate" VALUE="Variables.finish:DueDate"/>
		<ARGUMENT NAME="cs_OutDate" VALUE="finish:DueDate"/>
	</CALLELEMENT>
</THEN>
</IF>
<if COND="IsVariable.useDefaultDeadline!=true">
<then>
	<setvar NAME="useDefaultDeadline" VALUE="true"/>
</then>
</if>

<!-- ChooseStep is in the form, "assignmentid,stepid" -->
<STRINGLIST NAME="statustest" STR="Variables.finish:ChooseStep" DELIM=","/>
<SETVAR NAME="assignmentid" VALUE="statustest.ITEM"/>
<SETROW LIST="statustest" ACTION="NEXT"/>
<SETVAR NAME="NextStep" VALUE="statustest.ITEM"/>

<WorkflowEngine.GetStepID ID="Variables.NextStep" OBJVARNAME="stepobj" />
<WorkflowStep.GetStepType NAME="stepobj" VARNAME="steptype" />
<IF COND="Variables.steptype=ask">
<THEN>
	<WORKFLOWENGINE.GetCompleteAssignmentCandidateAssignees SITE="Variables.primarypubid" ID="Variables.assignmentid" NEXTSTEP="Variables.NextStep" OBJVARNAME="partsobj" />
	<Participants.GetAllRoles NAME="partsobj" VARNAME="assigneeroles" />
</THEN>
<ELSE>
	<REMOVEVAR NAME="assigneeroles"/>
</ELSE>
</IF>

<callelement NAME="OpenMarket/Xcelerate/Actions/Workflow/CheckCanSetStatus">
	<argument NAME="id" VALUE="Variables.id"/>
	<argument NAME="AssetType" VALUE="Variables.AssetType"/>
	<argument NAME="Step" VALUE="Variables.NextStep"/>
</callelement>

<if COND="Variables.foundcheckout=true">
<then>
	<XLAT.LOOKUP KEY="dvin/UI/Assetlockedcannotfinish" VARNAME="_XLAT_"/>
	<ERROR CODE="4" DESCRIPTION="Variables._XLAT_" SEVERITY="2" REPLACEALL="Variables._XLAT_"/>
</then>
<else>
	<!-- Perform common processing -->
	
	<!-- if there is a comment, use it -->
	<if COND="IsVariable.finish:ActionToTake=false">
	<then>
		<setvar NAME="actiontotake" VALUE="Variables.empty"/>
	</then>
	<else>
		<setvar name="actiontotake" value="Variables.finish:ActionToTake"/>
		<substitute STR="Variables.actiontotake" WHAT="%26" WITH=" AND " OUTSTR="actiontotake"/>
		<substitute STR="Variables.actiontotake" WHAT="'" WITH=" " OUTSTR="actiontotake"/>
		<substitute STR="Variables.actiontotake" WHAT="%22" WITH=" " OUTSTR="actiontotake"/>
	</else>
	</if>

	<if COND="IsVariable.finish:ActionTaken=false">
	<then>
		<setvar NAME="actiontaken" VALUE="Variables.empty"/>
	</then>
	<else>
		<setvar name="actiontaken" value="Variables.finish:ActionTaken"/>
		<substitute STR="Variables.actiontaken" WHAT="%26" WITH=" AND " OUTSTR="actiontaken"/>
		<substitute STR="Variables.actiontaken" WHAT="'" WITH=" " OUTSTR="actiontaken"/>
		<substitute STR="Variables.actiontaken" WHAT="%22" WITH=" " OUTSTR="actiontaken"/>
	</else>
	</if>

          <if COND="IsVariable.assigneeroles=true">
          <then>
		<WORKFLOWENGINE.NEWPARTICIPANTS  OBJVARNAME="partobj"/>

		<stringlist NAME="AssigneeRoles" STR="Variables.assigneeroles" DELIM=","/>
		<LOOP LIST="AssigneeRoles">
			<!-- SETVAR NAME="users" VALUE="Variables.finish:ask:AssigneeRoles.ITEM"/ -->
			<ICS.RESOLVEVARIABLES NAME="$(Variables.finish:ask:$(AssigneeRoles.ITEM))" OUTPUT="users" DELIMITED="true"/>
			<STRINGLIST STR="Variables.users" NAME="userList" DELIM=","/>
			<LOOP LIST="userList">
				<!-- This substitute makes no sense at all to me... -->
				<SUBSTITUTE STR="userList.ITEM" WHAT=";" WITH="," OUTSTR="currentUser"/>
				<PARTICIPANTS.ADDPARTICIPANT NAME="partobj" ROLE="AssigneeRoles.ITEM" USER="Variables.currentUser"/>
			</LOOP>
		</LOOP>

		<if COND="Variables.useDefaultDeadline=true">
		<then>
			<IGNORETHIS>&#60;![CDATA[
			<WorkflowEngine.CompleteAssignment ID="Variables.assignmentid"
				SITE="SessionVariables.pubid"
				ACTION="Variables.actiontaken"
				COMMENT="Variables.actiontotake"
				NEXTSTEP="Variables.NextStep"
				ASSIGNMENTLIST="partobj"
				VARNAME="condcheckfailreason" />
			]]&#62;</IGNORETHIS>
		</then>
		<else>
			<IGNORETHIS>&#60;![CDATA[
			<WorkflowEngine.CompleteAssignment ID="Variables.assignmentid"
				SITE="SessionVariables.pubid"
				ACTION="Variables.actiontaken"
				COMMENT="Variables.actiontotake"
				NEXTSTEP="Variables.NextStep"
				DEADLINE="Variables.finish:DueDate"
				ASSIGNMENTLIST="partobj"
				VARNAME="condcheckfailreason" />
			]]&#62;</IGNORETHIS>
		</else>
		</if>
          </then>
          <else>
		<if COND="Variables.useDefaultDeadline=true">
		<then>
			<IGNORETHIS>&#60;![CDATA[
			<WorkflowEngine.CompleteAssignment ID="Variables.assignmentid"
				SITE="SessionVariables.pubid"
				ACTION="Variables.actiontaken"
				COMMENT="Variables.actiontotake"
				NEXTSTEP="Variables.NextStep"
				VARNAME="condcheckfailreason" />
			]]&#62;</IGNORETHIS>
		</then>
		<else>
			<IGNORETHIS>&#60;![CDATA[
			<WorkflowEngine.CompleteAssignment ID="Variables.assignmentid"
				SITE="SessionVariables.pubid"
				ACTION="Variables.actiontaken"
				COMMENT="Variables.actiontotake"
				NEXTSTEP="Variables.NextStep"
				DEADLINE="Variables.finish:DueDate"
				VARNAME="condcheckfailreason" />
			]]&#62;</IGNORETHIS>
		</else>
		</if>
          </else>
          </if>

	<!-- Report any errors -->
	<if COND="Variables.errno=0">
	<then>
		<if COND="IsVariable.condcheckfailreason!=true">
		<then>
			<!-- workflow complete success -->
			<AFFECTEDNODES></AFFECTEDNODES>
		</then>
		<else>
			<!-- condition check failure prevented complete success -->
			<XLAT.LOOKUP KEY="dvin/UI/Admin/Conditiondoesnotallowthisstep" VARNAME="_XLAT_"/>
			<ERROR CODE="4" DESCRIPTION="Variables._XLAT_" SEVERITY="2" REPLACEALL="Variables._XLAT_"/>
		</else>
		</if>
	</then>
	<else>
		<XLAT.LOOKUP KEY="dvin/UI/FailedToCompleteTheAssignment" EVALALL="false" errno="Variables.errno, Variables.errdetail1" VARNAME="_XLAT_"/>
		<ERROR CODE="4" DESCRIPTION="Variables._XLAT_" SEVERITY="2" REPLACEALL="Variables._XLAT_"/>
	</else>
	</if>
</else>
</if>

</ftcs>