<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Gator/Rules/GeneratePromotionCondition
--
-- INPUT
--
--
--
-- OUTPUT
--
-->

<!-- Adds conditions to a rule object representing discount conditions -->
<!-- Called by: GeneratePromoDiscRules -->
<!-- Variables coming in are presumed to be: conditionhint, ruleobject, rulesetobject, promotionassetid -->

<!-- Unpack hint string -->
<NVOBJECT.CREATE NAME="condhintobject"/>
<NVOBJECT.FROMSTRING NAME="condhintobject" VALUE="Variables.conditionhint"/>
<!-- Need error check!! -->

<NVOBJECT.GETVALUE NAME="condhintobject" VALUENAME="CONDTYPE" VARNAME="condtype"/>
<NVOBJECT.GETVALUE NAME="condhintobject" VALUENAME="CONDOP" VARNAME="condop"/>
<NVOBJECT.GETVALUE NAME="condhintobject" VALUENAME="CONDVALUE" VARNAME="condvalue"/>

<IF COND="Variables.condtype=subtotal">
<THEN>
	<NVOBJECT.GETVALUE NAME="condhintobject" VALUENAME="STOREID" VARNAME="condstoreid"/>
	<RULEDEF.ADDEXISTS NAME="Variables.ruleobject"
	    ID="Cart" CLASS="Cart" VARIABLE="cart"/>
	<RULEDEF.APPENDCONDITION NAME="Variables.ruleobject"
	     VALUE='cart.getPreliminaryTotal("Variables.condstoreid") Variables.condop Variables.condvalue'/>
</THEN>
<ELSE>
	<SUBSTRING.CREATE NAME="mysubstring"/>
	<RULEDEF.ADDEXISTS NAME="Variables.ruleobject" ID="Cart"
		CLASS="Cart" VARIABLE="cart"/>
	<IF COND="Variables.condtype=count">
	<THEN>
		<SUBSTRING.ADDSTRING NAME="mysubstring"
		    VALUE='cart.queryItemCount(Util.makeList("assettype,assetid","'/>
	</THEN>
	</IF>
	<IF COND="Variables.condtype=price">
	<THEN>
		<SUBSTRING.ADDSTRING NAME="mysubstring"
		    VALUE='cart.queryItemValue(Util.makeList("assettype,assetid","'/>
	</THEN>
	</IF>

	<!-- Build conditional asset list -->
	<SETVAR NAME="stringacc" VALUE="Variables.empty"/>
	<SETCOUNTER NAME="condctr" VALUE="0"/>
	<NVOBJECT.GETVALUE NAME="condhintobject" VALUENAME="NUMASSETS" VARNAME="NumAssets"/>
	<LOOP UNTIL="Counters.condctr=Variables.NumAssets">
		<NVOBJECT.GETVALUE NAME="condhintobject" VALUENAME="ASSETTYPECounters.condctr"
		    VARNAME="thisassettype"/>
		<NVOBJECT.GETVALUE NAME="condhintobject" VALUENAME="ASSETIDCounters.condctr"
		    VARNAME="thisassetid"/>
		<NVOBJECT.GETVALUE NAME="condhintobject" VALUENAME="ASSETKEYCounters.condctr"
		    VARNAME="thisassetkey"/>

		<IF COND="IsVariable.thisassetkey=true">
		<THEN>
			<RULESETDEF.ADDDEPENDENCY NAME="Variables.rulesetobject"
			   TYPE="$(Variables.thisassetkey?x:)" ID="$(Variables.thisassetkey?:x)"/>
			<IF COND="Counters.condctr!=0">
			<THEN>
				<SUBSTRING.ADDSTRING NAME="mysubstring"
					VALUE=","/>
			</THEN>
			</IF>
			<SUBSTRING.ADDVAR NAME="mysubstring" VALUE="Variables.thisassetkey?x:"/>
			<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE=","/>
			<SUBSTRING.ADDVAR NAME="mysubstring" VALUE="Variables.thisassetkey?:x"/>
      		</THEN>
      		</IF>

		<IF COND="IsVariable.thisassettype=true">
		<THEN>
			<RULESETDEF.ADDDEPENDENCY NAME="Variables.rulesetobject"
			   TYPE="Variables.thisassettype" ID="Variables.thisassetid"/>
			<IF COND="Counters.condctr!=0">
			<THEN>
				<SUBSTRING.ADDSTRING NAME="mysubstring"
					VALUE=","/>
			</THEN>
			</IF>
			<SUBSTRING.ADDSTRING NAME="mysubstring"
				VALUE="Variables.thisassettype,Variables.thisassetid"/>
      		</THEN>
      		</IF>

      		<INCCOUNTER NAME="condctr" VALUE="1"/>
	</LOOP>
	<SUBSTRING.ADDSTRING NAME="mysubstring"
	    VALUE='")) Variables.condop Variables.condvalue'/>
	<RULEDEF.APPENDCONDITION NAME="Variables.ruleobject"
		SUBSTRING="mysubstring"/>
</ELSE>
</IF>
</FTCS>
