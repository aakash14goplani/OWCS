<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Gator/Rules/GeneratePromoApplGoal
--
-- INPUT
--
--
--
-- OUTPUT
--
-->

<!-- This element adds a leaf condition to a ruleset -->
<!-- Called by: GenerateSegmentRules -->
<!-- Variables coming in are presumed to be: goalhint, hstartdate, ruleobject, rulesetobject, assetid -->
<NVOBJECT.CREATE NAME="goalhintobject"/>
<NVOBJECT.FROMSTRING NAME="goalhintobject" VALUE="Variables.leafhint"/>

<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="VARNAME"
	VARNAME="historyname"/>
<!-- NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="VARKEY"
	VARNAME="historykey"/ -->
<REMOVEVAR NAME="historykey"/>
<SETVAR NAME="compareop" VALUE="&#60;"/>
<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="CUTOFFVALUE"
	VARNAME="value"/>
<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HOP"
	VARNAME="hop"/>
<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HFIELD"
	VARNAME="hfield"/>
<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HFIELDKEY"
	VARNAME="hfieldkey"/>

<SUBSTRING.CREATE NAME="mysubstring"/>

<SETVAR NAME="henddate" VALUE="Long.MAX_VALUE"/>

<!-- Now, put it all together (based on the op) -->
<IF COND="Variables.hop=count">
<THEN>
	<SUBSTRING.ADDSTRING NAME="mysubstring"
		VALUE='vd.getCountOfHistoryAttribute(null,"'/>
	<IF COND="IsVariable.historykey=true">
	<THEN>
		<SUBSTRING.ADDVAR NAME="mysubstring" VALUE="Variables.historykey?:x"/>
	</THEN>
	<ELSE>
		<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.historyname"/>
	</ELSE>
	</IF>
	<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE='",'/>
	<SETVAR NAME="remainder" VALUE=',Variables.hstartdate,Variables.henddate) Variables.compareop (int)Variables.value'/>
</THEN>
<ELSE>
	<SUBSTRING.ADDSTRING NAME="mysubstring"
		VALUE='vd.getSumForTimePeriodOfHistoryAttribute(null,"'/>
	<IF COND="IsVariable.historykey=true">
	<THEN>
		<SUBSTRING.ADDVAR NAME="mysubstring" VALUE="Variables.historykey?:x"/>
	</THEN>
	<ELSE>
		<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.historyname"/>
	</ELSE>
	</IF>
	<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE='","'/>
	<IF COND="IsVariable.hfieldkey=true">
	<THEN>
		<SUBSTRING.ADDVAR NAME="mysubstring" VALUE="Variables.hfieldkey?:x"/>
	</THEN>
	<ELSE>
		<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.hfield"/>
	</ELSE>
	</IF>
	<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE='",'/>
	<SETVAR NAME="remainder" VALUE=',Variables.hstartdate,Variables.henddate).doubleValue() Variables.compareop (double)Variables.value'/>
</ELSE>
</IF>

<!-- If there is no field restriction code, use 'null' instead -->
<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRFIELD0"
	VARNAME="testdata"/>

<IF COND="IsVariable.testdata=false">
<THEN>
	<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="null"/>
</THEN>
<ELSE>
	<SUBSTRING.ADDSTRING NAME="mysubstring"
	    VALUE='vd.createHistoryAttributeCriteria("'/>
	<IF COND="IsVariable.historykey=true">
	<THEN>
		<SUBSTRING.ADDVAR NAME="mysubstring" VALUE="Variables.historykey?:x"/>
	</THEN>
	<ELSE>
		<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.historyname"/>
	</ELSE>
	</IF>
	<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE='",'/>
	<SETVAR NAME="remainder" VALUE=')Variables.remainder'/>
</ELSE>
</IF>

<!-- Now generate field restriction code -->
<!-- Restriction will be a list with 'field' and 'value' columns -->
<!-- Loop through field restrictions once to generate Util.catList in the right number -->

<SETCOUNTER NAME="fieldcounter" VALUE="1"/>
<SETVAR NAME="fieldterm" VALUE="false"/>
<LOOP UNTIL="Variables.fieldterm=true">
	<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRFIELDCounters.fieldcounter"
		VARNAME="thisconstrfield"/>
	<IF COND="IsVariable.thisconstrfield=true">
	<THEN>
		<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE='Util.catList('/>
	</THEN>
	<ELSE>
		<SETVAR NAME="fieldterm" VALUE="true"/>
	</ELSE>
	</IF>
	<INCCOUNTER NAME="fieldcounter" VALUE="1"/>
</LOOP>

<!-- Loop through the field restrictions and generate them, plus termination -->
<SETCOUNTER NAME="fieldcounter" VALUE="0"/>
<SETVAR NAME="fieldterm" VALUE="false"/>
<LOOP UNTIL="Variables.fieldterm=true">
	<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRFIELDCounters.fieldcounter"
		VARNAME="thisconstrfield"/>
	<IF COND="IsVariable.thisconstrfield=true">
	<THEN>
		<IF COND="Counters.fieldcounter!=0">
		<THEN>
			<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE=","/>
		</THEN>
		</IF>

		<!-- Grab all the rest of the fields -->
		<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRTYPECounters.fieldcounter"
			VARNAME="thisconstrtype"/>

		<!-- Do something different based on the query type -->
		<IF COND="Variables.thisconstrtype=asset">
		<THEN>
			<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRASSETTYPECounters.fieldcounter"
				VARNAME="thisassettype"/>
			<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRASSETTYPEKEYCounters.fieldcounter"
				VARNAME="thisassetkey"/>

			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='Util.addColumn(Util.mapColumn(z.getLeafAssets(Util.makeTypedQueryList("assettype",Util.makeList("assetid","'/>

			<!-- Generate the field/value pairs and build a list (stringvar: newlist) -->
			<!-- Build a comma-separated list of values -->
			<SETCOUNTER NAME="valuecounter" VALUE="0"/>
			<SETVAR NAME="valueterm" VALUE="false"/>
			<LOOP UNTIL="Variables.valueterm=true">
				<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRVALUECounters.fieldcounter-Counters.valuecounter"
					VARNAME="thisvalue"/>
				<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRKEYCounters.fieldcounter-Counters.valuecounter"
					VARNAME="thiskey"/>


				<IF COND="IsVariable.thiskey=true">
				<THEN>
						<RULESETDEF.ADDDEPENDENCY NAME="Variables.rulesetobject" TYPE="$(Variables.thiskey?x:)"
						    ID="$(Variables.thiskey?:x)"/>
						<IF COND="Counters.valuecounter!=0">
						<THEN>
							<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE=","/>
						</THEN>
						</IF>
						<SUBSTRING.ADDVAR NAME="mysubstring" VALUE="Variables.thiskey?:x"/>

				</THEN>
				<ELSE>
					<IF COND="IsVariable.thisvalue=true">
					<THEN>
						<IF COND="IsVariable.thisassetkey=true">
						<THEN>
							<RULESETDEF.ADDDEPENDENCY NAME="Variables.rulesetobject" TYPE="$(Variables.thisassetkey)"
							    ID="Variables.thisvalue"/>
						</THEN>
						<ELSE>
							<RULESETDEF.ADDDEPENDENCY NAME="Variables.rulesetobject" TYPE="Variables.thisassettype"
							    ID="Variables.thisvalue"/>
						</ELSE>
						</IF>
						<IF COND="Counters.valuecounter!=0">
						<THEN>
							<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE=","/>
						</THEN>
						</IF>
						<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.thisvalue"/>
					</THEN>
					<ELSE>
						<SETVAR NAME="valueterm" VALUE="true"/>
					</ELSE>
					</IF>
				</ELSE>
				</IF>
				<INCCOUNTER NAME="valuecounter" VALUE="1"/>
			</LOOP>

			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='")),Util.makeList("assettype","'/>
			<IF COND="IsVariable.thisassetkey=true">
			<THEN>
				<SUBSTRING.ADDVAR NAME="mysubstring" VALUE="Variables.thisassetkey"/>
			</THEN>
			<ELSE>
				<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.thisassettype"/>
			</ELSE>
			</IF>
			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='")),"assetid","value"),"field","'/>
			<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.thisconstrfield"/>
			<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE='")'/>
		</THEN>
		</IF>

		<IF COND="Variables.thisconstrtype=assetattr">
		<THEN>
			<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRATTRCounters.fieldcounter"
				VARNAME="thisattr"/>
			<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRATTRTYPECounters.fieldcounter"
				VARNAME="thisattrtype"/>
			<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRATTRKEYCounters.fieldcounter"
				VARNAME="thisattrkey"/>

			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='Util.addColumn(z.getAttributeValues(z.getLeafAssets(Util.makeTypedQueryList("assettype",Util.makeList("assetid","'/>
			<!-- Find the attribute type -->
			<!-- Build a comma-separated list of attrtype,attrid values -->
			<SETCOUNTER NAME="valuecounter" VALUE="0"/>
			<SETVAR NAME="valueterm" VALUE="false"/>
			<LOOP UNTIL="Variables.valueterm=true">
				<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRVALUECounters.fieldcounter-Counters.valuecounter"
					VARNAME="thisvalue"/>
				<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRATYPECounters.fieldcounter-Counters.valuecounter"
					VARNAME="thisatype"/>
				<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRKEYCounters.fieldcounter-Counters.valuecounter"
					VARNAME="thiskey"/>

				<IF COND="IsVariable.thiskey=true">
				<THEN>
						<IF COND="Counters.valuecounter!=0">
						<THEN>
							<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE=","/>
						</THEN>
						</IF>
						<SUBSTRING.ADDVAR NAME="mysubstring" VALUE="Variables.thiskey?x:"/>
						<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE=","/>
						<SUBSTRING.ADDVAR NAME="mysubstring" VALUE="Variables.thiskey?:x"/>
				</THEN>
				<ELSE>
					<IF COND="IsVariable.thisvalue=true">
					<THEN>
						<IF COND="Counters.valuecounter!=0">
						<THEN>
							<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE=","/>
						</THEN>
						</IF>
						<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.thisatype,Variables.thisvalue"/>
					</THEN>
					<ELSE>
						<SETVAR NAME="valueterm" VALUE="true"/>
					</ELSE>
					</IF>
				</ELSE>
				</IF>
				<INCCOUNTER NAME="valuecounter" VALUE="1"/>
			</LOOP>
			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='")),null),"'/>
			<IF COND="IsVariable.thisattrkey=true">
			<THEN>
				<SUBSTRING.ADDVAR NAME="mysubstring" VALUE="Variables.thisattrkey?x:"/>
			</THEN>
			<ELSE>
				<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.thisattrtype"/>
			</ELSE>
			</IF>
			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='","'/>
			<IF COND="IsVariable.thisattrkey=true">
			<THEN>
				SUBSTRING.ADDVAR NAME="mysubstring" VALUE="Variables.thisattrkey?:x"/>
			</THEN>
			<ELSE>
				<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.thisattr"/>
			</ELSE>
			</IF>
			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='"),"field","'/>
			<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.thisconstrfield"/>
			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='")'/>
		</THEN>
		</IF>

		<IF COND="Variables.thisconstrtype=value">
		<THEN>
			<!-- Generate the field/value pairs and build a list (stringvar: newlist) -->
			<!-- Build a comma-separated list of values -->
			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='Util.addColumn(Util.makeList("value","'/>

			<SETVAR NAME="valuestring" VALUE="Variables.empty"/>
			<SETCOUNTER NAME="valuecounter" VALUE="0"/>
			<SETVAR NAME="valueterm" VALUE="false"/>
			<LOOP UNTIL="Variables.valueterm=true">
				<NVOBJECT.GETVALUE NAME="goalhintobject" VALUENAME="HCONSTRVALUECounters.fieldcounter-Counters.valuecounter"
					VARNAME="thisvalue"/>
				<IF COND="IsVariable.thisvalue=true">
				<THEN>
					<IF COND="Counters.valuecounter!=0">
					<THEN>
						<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE=","/>
					</THEN>
					</IF>
					<SUBSTRING.ADDSTRING NAME="mysubstring"
						VALUE="Variables.thisvalue"/>
				</THEN>
				<ELSE>
					<SETVAR NAME="valueterm" VALUE="true"/>
				</ELSE>
				</IF>
				<INCCOUNTER NAME="valuecounter" VALUE="1"/>
			</LOOP>

			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='"),"field","'/>
			<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.thisconstrfield"/>
			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='")'/>
		</THEN>
		</IF>

		<IF COND="Counters.fieldcounter!=0">
		<THEN>
			<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE=")"/>
		</THEN>
		</IF>
		<INCCOUNTER NAME="fieldcounter" VALUE="1"/>
	</THEN>
	<ELSE>
		<SETVAR NAME="fieldterm" VALUE="true"/>
	</ELSE>
	</IF>
</LOOP>



<!-- Now, put it all together -->
<SUBSTRING.ADDSTRING NAME="mysubstring" VALUE="Variables.remainder"/>
<RULEDEF.ADDEXISTS NAME="Variables.ruleobject"
	ID="VisitorData" CLASS="VisitorData" VARIABLE="vd"/>
<RULEDEF.APPENDCONDITION NAME="Variables.ruleobject"
	SUBSTRING="mysubstring"/>
</FTCS> 
