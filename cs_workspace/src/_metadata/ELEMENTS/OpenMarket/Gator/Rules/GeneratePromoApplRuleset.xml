<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Gator/Rules/GeneratePromoApplRuleset
--
-- INPUT
--
--
--
-- OUTPUT
--
-->

<SETVAR NAME="ratingassetid" VALUE="$(this?:x)"/>
<SETVAR NAME="ratingassettype" VALUE="$(this?x:)"/>

<!-- Variables coming in are presumed to be: hintstring, assetid, targetxml -->
<!-- First, build the empty ruleset to contain the results -->
<RULESETDEF.CREATE NAME="myruleset"/>
<RULESETDEF.SETNAME NAME="myruleset" RULESETNAME="Rating_Variables.ratingassetid"/>
<RULESETDEF.APPENDIMPORT NAME="myruleset" VALUE="com.openmarket.gator.ruleobjects.*"/>

<!-- Unpack hint string -->
<NVOBJECT.CREATE NAME="myhintobject"/>
<NVOBJECT.FROMSTRING NAME="myhintobject" VALUE="Variables.hintstring"/>
<!-- Need error check!! -->

<!-- Grab the default rating -->
<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="DEFAULTRATING" VARNAME="defaultrating"/>
<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="APPLICABILITY" VARNAME="applicability"/>

<!-- Generate the rule for start date -->
<RULEDEF.CREATE NAME="myrule"/>
<RULEDEF.SETNAME NAME="myrule" RULENAME="StartDate_Variables.ratingassetid"/>
<!-- Convert the current startdate hint data to a long -->
<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="STARTDATE" VARNAME="startdate"/>
<RULEDEF.ADDEXISTS NAME="myrule" ID="CurrentDate"
    CLASS="CurrentDate" VARIABLE="cd"/>
<RULEDEF.APPENDCONDITION NAME="myrule"
    VALUE='Util.compareDate(cd.getDate(),Util.parseLong("Variables.startdate")) &#62;= 0'/>
<RULEDEF.ADDASSERT NAME="myrule"
    CLASS="Signal" KEY="startdate_Variables.ratingassetid"/>
<RULESETDEF.ADDRULE NAME="myruleset" RULENAME="myrule"/>

<!-- Generate the rule for end date -->
<RULEDEF.CREATE NAME="myrule"/>
<RULEDEF.SETNAME NAME="myrule" RULENAME="EndDate_Variables.ratingassetid"/>
<!-- Load the end type -->
<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="ENDTYPE" VARNAME="endtype"/>
<REMOVEVAR NAME="enddate"/>
<IF COND="Variables.endtype=fixed">
<THEN>
	<!-- Convert the current enddate hint data to a long -->
	<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="ENDDATE" VARNAME="enddate"/>
</THEN>
</IF>
<IF COND="Variables.endtype=hours">
<THEN>
	<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="DURATION" VARNAME="duration"/>
	<CALCULATOR.GO VALUE="Variables.startdate Variables.duration 60 * 60 * 1000 * +"
		VARNAME="enddate"/>
</THEN>
</IF>
<IF COND="Variables.endtype=days">
<THEN>
	<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="DURATION" VARNAME="duration"/>
	<CALCULATOR.GO VALUE="Variables.startdate Variables.duration 24 * 60 * 60 * 1000 * +"
		VARNAME="enddate"/>
</THEN>
</IF>
<IF COND="Variables.endtype=weeks">
<THEN>
	<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="DURATION" VARNAME="duration"/>
	<CALCULATOR.GO VALUE="Variables.startdate Variables.duration 7 * 24 * 60 * 60 * 1000 * +"
		VARNAME="enddate"/>
</THEN>
</IF>
<IF COND="Variables.endtype=months">
<THEN>
	<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="DURATION" VARNAME="duration"/>
	<CALCULATOR.GO VALUE="Variables.startdate Variables.duration 30 * 24 * 60 * 60 * 1000 * +"
		VARNAME="enddate"/>
</THEN>
</IF>
<IF COND="Variables.endtype=years">
<THEN>
	<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="DURATION" VARNAME="duration"/>
	<CALCULATOR.GO VALUE="Variables.startdate Variables.duration 365 * 24 * 60 * 60 * 1000 * +"
		VARNAME="enddate"/>
</THEN>
</IF>

<IF COND="IsVariable.enddate=true">
<THEN>
	<RULEDEF.ADDEXISTS NAME="myrule" ID="CurrentDate" CLASS="CurrentDate"
		VARIABLE="cd"/>
	<RULEDEF.APPENDCONDITION NAME="myrule"
	    VALUE='Util.compareDate(cd.getDate(),Util.parseLong("Variables.enddate")) &#60; 0'/>
</THEN>
<ELSE>
	<RULEDEF.ADDEXISTS NAME="myrule" ID="CurrentDate"/>
</ELSE>
</IF>

<RULEDEF.ADDASSERT NAME="myrule"
    CLASS="Signal" KEY="enddate_Variables.ratingassetid"/>
<RULESETDEF.ADDRULE NAME="myruleset" RULENAME="myrule"/>

<!-- Create a ruleset for goals -->
<RULEDEF.CREATE NAME="myrule"/>
<RULEDEF.SETNAME NAME="myrule" RULENAME="Goal_Variables.ratingassetid"/>
<!-- Drop this in once -->
<RULEDEF.ADDEXISTS NAME="myrule" ID="UtilObject" CLASS="UtilObject"
	VARIABLE="z"/>

<!-- Generate individual termination conditions for sales goals -->
<SETCOUNTER NAME="goalcounter" VALUE="0"/>
<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="NUMGOALS" VARNAME="NumGoals"/>

<LOOP UNTIL="Counters.goalcounter=Variables.NumGoals">
	<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="GOALCounters.goalcounter"
		VARNAME="myGoalString"/>
	<IF COND="IsVariable.myGoalString=true">
	<THEN>
		<!-- Logic should return "true" to condition promotion -->
		<CALLELEMENT NAME="OpenMarket/Gator/Rules/GeneratePromoApplGoal">
			<ARGUMENT NAME="goalhint" VALUE="Variables.myGoalString"/>
			<ARGUMENT NAME="ruleobject" VALUE="myrule"/>
			<ARGUMENT NAME="rulesetobject" VALUE="myruleset"/>
			<ARGUMENT NAME="hstartdate" VALUE="Variables.startdate"/>
		</CALLELEMENT>
   </THEN>
   </IF>
   <INCCOUNTER NAME="goalcounter" VALUE="1"/>
</LOOP>

<RULEDEF.ADDASSERT NAME="myrule"
    CLASS="Signal" KEY="goal_Variables.ratingassetid"/>
<RULESETDEF.ADDRULE NAME="myruleset" RULENAME="myrule"/>

<!-- Add rule to fire duration condition -->
<RULEDEF.CREATE NAME="myrule"/>
<RULEDEF.SETNAME NAME="myrule" RULENAME="Duration_Variables.ratingassetid"/>
<RULEDEF.ADDEXISTS NAME="myrule"
    ID="Signal:startdate_Variables.ratingassetid"/>
<RULEDEF.ADDEXISTS NAME="myrule"
    ID="Signal:enddate_Variables.ratingassetid"/>
<RULEDEF.ADDEXISTS NAME="myrule"
    ID="Signal:goal_Variables.ratingassetid"/>
<RULEDEF.ADDASSERT NAME="myrule"
    CLASS="Signal" KEY="duration_Variables.ratingassetid"/>
<RULESETDEF.ADDRULE NAME="myruleset" RULENAME="myrule"/>

<IF COND="Variables.applicability=all">
<THEN>
	<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="ALLRATING"
		VARNAME="allrating"/>
	<!-- Build the 'all' rating rule -->
	<RULEDEF.CREATE NAME="myrule"/>
	<RULEDEF.SETNAME NAME="myrule" RULENAME="all_Variables.ratingassetid"/>
	<RULEDEF.ADDEXISTS NAME="myrule"
	    ID="Signal:duration_Variables.assetid"/>
	<RULEDEF.ADDEXISTS NAME="myrule"
	    ID="RatingResults:Promotions(Variables.ratingassetid)"
	    CLASS="RatingResults" VARIABLE="a"/>
	<RULEDEF.APPENDACTION NAME="myrule"
	    VALUE='a.setRating("all",Variables.allrating)'/>
	<RULEDEF.APPENDUNDOACTION NAME="myrule"
	    VALUE='a.clearRating("all")'/>
	<RULEDEF.ADDASSERT NAME="myrule"
	    CLASS="Signal" KEY="all_Variables.ratingassetid"/>
	<RULESETDEF.ADDRULE NAME="myruleset" RULENAME="myrule"/>

	<!-- Build the default rating rule -->
	<RULEDEF.CREATE NAME="myrule"/>
	<RULEDEF.SETNAME NAME="myrule" RULENAME="default_Variables.ratingassetid"/>
	<RULEDEF.ADDNOTEXISTS NAME="myrule"
	    ID="Signal:all_Variables.ratingassetid"/>
	<RULEDEF.ADDEXISTS NAME="myrule"
	    ID="RatingResults:Promotions(Variables.ratingassetid)"
	    CLASS="RatingResults" VARIABLE="a"/>
	<RULEDEF.APPENDACTION NAME="myrule"
	    VALUE='a.setRating("default",Variables.defaultrating)'/>
	<RULEDEF.APPENDUNDOACTION NAME="myrule"
	    VALUE='a.clearRating("default")'/>
	<RULESETDEF.ADDRULE NAME="myruleset" RULENAME="myrule"/>


</THEN>
<ELSE>
	<!-- Loop through all the potential conditions -->
	<SETCOUNTER NAME="mycounter" VALUE="0"/>
   <NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="NUMSEGS" VARNAME="NumSegments"/>
	
	<LOOP UNTIL="Counters.mycounter=Variables.NumSegments">
		<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="SEGIDCounters.mycounter"
			VARNAME="thissegid"/>
		<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="SEGKEYCounters.mycounter"
			VARNAME="thissegkey"/>
		<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="RATINGCounters.mycounter"
			VARNAME="thisrating"/>
		<IF COND="IsVariable.thissegkey=true">
		<THEN>
			<RULESETDEF.ADDDEPENDENCY NAME="myruleset" TYPE="Segments" ID="$(Variables.thissegkey?:x)"/>
			<!-- Build a new rule -->
			<RULEDEF.CREATE NAME="myrule"/>
			<RULEDEF.SETNAME NAME="myrule" RULENAME="SegCounters.mycounter_Variables.ratingassetid"/>
			<RULEDEF.ADDEXISTS NAME="myrule"
			    ID="Signal:duration_Variables.ratingassetid"/>
			<RULEDEF.ADDEXISTS NAME="myrule"
			    ID="EffectiveSegments" CLASS="EffectiveSegments"
			    VARIABLE="es"/>
			<SUBSTRING.CREATE NAME="mysubstring"/>
			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='es.member("'/>
			<SUBSTRING.ADDVAR NAME="mysubstring"
			    VALUE="Variables.thissegkey?:x"/>
			<SUBSTRING.ADDSTRING NAME="mysubstring"
			    VALUE='")'/>
			<RULEDEF.APPENDCONDITION NAME="myrule"
			    SUBSTRING="mysubstring"/>
			<RULEDEF.ADDEXISTS NAME="myrule"
			    ID="RatingResults:Promotions(Variables.ratingassetid)"
			    CLASS="RatingResults" VARIABLE="a"/>
			<RULEDEF.APPENDACTION NAME="myrule"
			    VALUE='a.setRating("segCounters.mycounter",Variables.thisrating)'/>
			<RULEDEF.APPENDUNDOACTION NAME="myrule"
			    VALUE='a.clearRating("segCounters.mycounter")'/>
			<RULEDEF.ADDASSERT NAME="myrule"
			    CLASS="Signal" KEY="segCounters.mycounter_Variables.ratingassetid"/>
			<RULESETDEF.ADDRULE NAME="myruleset" RULENAME="myrule"/>

      		</THEN>
      		</IF>
		<IF COND="IsVariable.thissegid=true">
		<THEN>
			<RULESETDEF.ADDDEPENDENCY NAME="myruleset" TYPE="Segments" ID="Variables.thissegid"/>
			<!-- Build a new rule -->
			<RULEDEF.CREATE NAME="myrule"/>
			<RULEDEF.SETNAME NAME="myrule" RULENAME="SegCounters.mycounter_Variables.ratingassetid"/>
			<RULEDEF.ADDEXISTS NAME="myrule"
			    ID="Signal:duration_Variables.ratingassetid"/>
			<RULEDEF.ADDEXISTS NAME="myrule"
			    ID="EffectiveSegments" CLASS="EffectiveSegments"
			    VARIABLE="es"/>
			<RULEDEF.APPENDCONDITION NAME="myrule"
			    VALUE='es.member("Variables.thissegid")'/>
			<RULEDEF.ADDEXISTS NAME="myrule"
			    ID="RatingResults:Promotions(Variables.ratingassetid)"
			    CLASS="RatingResults" VARIABLE="a"/>
			<RULEDEF.APPENDACTION NAME="myrule"
			    VALUE='a.setRating("segCounters.mycounter",Variables.thisrating)'/>
			<RULEDEF.APPENDUNDOACTION NAME="myrule"
			    VALUE='a.clearRating("segCounters.mycounter")'/>
			<RULEDEF.ADDASSERT NAME="myrule"
			    CLASS="Signal" KEY="segCounters.mycounter_Variables.ratingassetid"/>
			<RULESETDEF.ADDRULE NAME="myruleset" RULENAME="myrule"/>

      		</THEN>
      		</IF>
      		<INCCOUNTER NAME="mycounter" VALUE="1"/>
	</LOOP>

	<!-- Build the default rating rule -->
	<RULEDEF.CREATE NAME="myrule"/>
	<RULEDEF.SETNAME NAME="myrule" RULENAME="default_Variables.ratingassetid"/>
	<SETCOUNTER NAME="mycounter" VALUE="0"/>
	<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="NUMSEGS" VARNAME="NumSegments"/>
	
	<LOOP UNTIL="Counters.mycounter=Variables.NumSegments">

		<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="SEGIDCounters.mycounter"
			VARNAME="thissegid"/>
		<NVOBJECT.GETVALUE NAME="myhintobject" VALUENAME="SEGKEYCounters.mycounter"
			VARNAME="thissegkey"/>

      		<IF COND="IsVariable.thissegkey=true">
		<THEN>
			<RULEDEF.ADDNOTEXISTS NAME="myrule"
			    ID="Signal:segCounters.mycounter_Variables.ratingassetid"/>
      		</THEN>
      		</IF>

      		<IF COND="IsVariable.thissegid=true">
		<THEN>
			<RULEDEF.ADDNOTEXISTS NAME="myrule"
			    ID="Signal:segCounters.mycounter_Variables.ratingassetid"/>
      		</THEN>
      		</IF>
      		<INCCOUNTER NAME="mycounter" VALUE="1"/>
	</LOOP>

	<RULEDEF.ADDEXISTS NAME="myrule"
	    ID="RatingResults:Promotions(Variables.ratingassetid)"
	    CLASS="RatingResults" VARIABLE="a"/>
	<RULEDEF.APPENDACTION NAME="myrule"
	    VALUE='a.setRating("default",Variables.defaultrating)'/>
	<RULEDEF.APPENDUNDOACTION NAME="myrule"
	    VALUE='a.clearRating("default")'/>
	<RULESETDEF.ADDRULE NAME="myruleset" RULENAME="myrule"/>
</ELSE>
</IF>

<RULESETDEF.SETENCODING NAME="myruleset" VALUE="Variables.hintstring"/>
<RULESETDEF.TOXML NAME="myruleset" VARNAME="Variables.targetxml"/>
</FTCS> 
