<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Gator/FlexibleAssets/Common/CDSortSegments
-
- INPUT
-
- OUTPUT
-
-->

<!-- The segment ratings and ids stored inside a ruleset are not currently sorted.
  -- On the ContentForm we use <COMPLEXASSET.GETALLASSETSSORTED> to sort the segments,
  -- but on the ContentDetails we just need to spit out the data in the ruleset.
  -- This is a sort of the segments after we get them from the ruleset.  The display
  -- element used to do an <ASSET.LIST> of the segments to get the names but that slowed
  -- the ContentForm.  This slows the ContentDetails a bit but nobody is complaining about
  -- that right now.  It also sorts the segments on the ContentDetails which needed to be
  -- done anyway.
  -- scarey
-->

<IF COND="IsList.RatingList=true">
<THEN>
	<IF COND="RatingList.#numRows!=0">
	<THEN>
		<ATM.LOCATE TYPE="Segments" VARNAME="segmgr"/>
		<COMPLEXASSETS.GETALLASSETSSORTED NAME="segmgr" LISTVARNAME="seglist" SITE="SessionVariables.pubid"/>
		
		<LISTOBJECT.CREATE NAME="ratingsPlusName" COLUMNS="assetid,name,rating,NOTrating"/>
		
		<HASH.CREATE NAME="segsWithRatings"/>
		
		<LOOP LIST="RatingList">
			<HASH.ADD NAME="segsWithRatings" VALUE="RatingList.assetid"/>
		</LOOP>
		
		<LOOP LIST="seglist">
			<HASH.CONTAINS NAME="segsWithRatings" VALUE="seglist.assetid" VARNAME="hasit"/>
			<IF COND="Variables.hasit=true">
			<THEN>
				<LOOP LIST="RatingList">
					<IF COND="RatingList.assetid=seglist.assetid">
					<THEN>
						<SETVAR NAME="errno" VALUE="0"/>
						<ASSET.LIST TYPE="Segments" LIST="currentSeg" FIELD1="id" VALUE1="RatingList.assetid"/>
						<IF COND="Variables.errno=0">
						<THEN>
							<LISTOBJECT.ADDROW NAME="ratingsPlusName"
								assetid="RatingList.assetid"
								name="currentSeg.name"
								rating="RatingList.rating"
								NOTrating="RatingList.NOTrating"/>
						</THEN>
						</IF>
					</THEN>
					</IF>
				</LOOP>
			</THEN>
			</IF>
		</LOOP>
		<LISTOBJECT.TOLIST NAME="ratingsPlusName" LISTVARNAME="RatingList"/>
	</THEN>
	</IF>
</THEN>
</IF>

</FTCS> 
