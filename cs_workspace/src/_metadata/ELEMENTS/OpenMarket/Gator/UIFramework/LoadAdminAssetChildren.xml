<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<SETVAR NAME="cs.contenttype" VALUE="text/html; charset=UTF-8"/>

<!-- OpenMarket/Gator/UIFramework/LoadAdminAssetChildren
-
- INPUT
-
- OUTPUTr
-
-->
						
<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/BasicEnvironment"/>

<!-- AssetType will always be set.  If op=init then load dummy node.
  -- If op=load then load remaining nodes -->

<ics.literal table="AssetType" column="assettype" string="Variables.AssetType" output="literal"/>
<setvar NAME="errno" VALUE="0"/>
<setvar NAME="tablename" VALUE="AssetType"/>
	
<execsql LIST="ThisAsset" 
		SQL="SELECT AssetType.assettype, AssetType.description, AssetType.id
		FROM AssetType 
		WHERE	AssetType.assettype=Variables.literal"/>
	
<if COND="Variables.errno=0">
<then>
		<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/GetDefaultNodeBehavior" />
		
		<!--  INIT Get Root Level 1 Basic  ASSET Type by name or admin tab  -->
		<IF COND="Variables.op=init">
		<THEN>
			<setvar NAME="errno" VALUE="0"/>
			<setvar NAME="tablename" VALUE="ThisAsset.assettype"/>
			
			<execsql LIST="Testcount" 
					 SQL="SELECT count(*) as mycount FROM ThisAsset.assettype,AssetPublication
						  WHERE status!='VO' AND ThisAsset.assettype.id = AssetPublication.assetid 
						  AND (AssetPublication.pubid = SessionVariables.pubid OR AssetPublication.pubid=0)" 
						  TABLE="ThisAsset.assettype,AssetPublication"/>
		
			<if COND="Testcount.mycount!=0">
			<then>
				<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
					<satellite.argument name="AssetType" value="Variables.AssetType"/>
					<satellite.argument name="populate" value="OpenMarket/Xcelerate/AssetType/Variables.AssetType/LoadTree"/>
					<satellite.argument name="op" value="load"/>
				</SATELLITE.LINK>
			</then>
			<else>
				<REMOVEVAR NAME="LoadURL"/>
			</else>
			</if>

			<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID" SCOPED="STACKED">
				<ARGUMENT NAME="AdHoc" VALUE="Variables.AssetType"/>
				<ARGUMENT NAME="TreeNodeID" VALUE="Variables.empty"/>
			</CALLELEMENT>
			
			<REMOVEVAR NAME="ExecuteURL"/>
			<REMOVEVAR NAME="OKActions"/>
			
			<IF COND="Variables.cs_defaultFunctionParent!=browse">
			<THEN>
				<REMOVEVAR NAME="executeFunction" />
			</THEN>
			<ELSE>
				<SETVAR NAME="executeFunction" VALUE="Variables.cs_defaultFunctionParent" />
			</ELSE>
			</IF>
			
			<!--  Build the node's BrowseURL used to 
			      query all immediate children   
			-->		
			<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="browseURL">
			      <satellite.argument name="AssetType" value="Variables.AssetType"/>
				  <satellite.argument name="populate" value="OpenMarket/Gator/UIFramework/BrowseAdminAssetNode"/>
				  <satellite.argument name="op" value="load"/>				
			</SATELLITE.LINK>
			
			<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
				<ARGUMENT NAME="Label" VALUE="ThisAsset.description"/>
				<ARGUMENT NAME="Description" VALUE="ThisAsset.description"/>
				<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
				<!-- LoadURL implicitly passed in -->
							
				<ARGUMENT NAME="RefreshKeys" VALUE="Dummy__ThisAsset.assettype"/>
				<ARGUMENT NAME="okFunctions" VALUE="treerefresh" />
				<ARGUMENT NAME="executeFunction" VALUE="Variables.executeFunction" />
			</CALLELEMENT>
		</THEN>
		<ELSE>
		
			<!--  Load the NODES IMMEDIATE children   -->
			<SETVAR NAME="queryfields" VALUE="Variables.empty"/>
			<setvar NAME="tablename" VALUE="Variables.AssetType"/>
			<setvar NAME="queryend" VALUE="ORDER BY NAME"/>
			<CALLSQL LIST="ListofAsset" QRYNAME="OpenMarket/Xcelerate/AssetType/Variables.AssetType/SelectSummary"/>
			<if COND="IsList.ListofAsset=true">
			<then>
				<setvar NAME="COUNT" VALUE="ListofAsset.#numRows"/>
			</then>
			<else>
				<setvar NAME="COUNT" VALUE="0"/>
			</else>
			</if>
			
			<PROPERTY.GET PARAM="xcelerate.treeMaxNodes" INIFILE="futuretense_xcel.ini" VARNAME="TOOMANY"/>
			<!-- compare COUNT and TooMany, return tooManyItem if COUNT is larger-->
			<CALCULATOR.GO VALUE="Variables.COUNT Variables.TOOMANY GT" VARNAME="ANS"/>
			
			<!--  Get scrolling result set  -->
			<!-- No need to make query since all nodes are loaded when load count -->
			<if COND="IsList.ListofAsset=true">
			<then>
				<REMOVEVAR NAME="LoadURL"/>
				
				<loop LIST="ListofAsset">
								
					<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID" SCOPED="STACKED">
							<ARGUMENT NAME="ID" VALUE="ListofAsset.id"/>
							<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
							<ARGUMENT NAME="TreeNodeID" VALUE="Variables.empty"/>
					</CALLELEMENT>
													
					<ASSET.GETSUBTYPE TYPE="Variables.AssetType" OBJECTID="ListofAsset.id" OUTPUT="stype" />
				
					<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
						<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
						<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
					</CALLELEMENT>
					<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
						<ARGUMENT NAME="Label" VALUE="ListofAsset.name"/>
						<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>						
						<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
						<ARGUMENT NAME="RefreshKeys" VALUE="ListofAsset.id"/>
						<ARGUMENT NAME="okFunctions" VALUE="edit;delete;treerefresh" />
						<ARGUMENT NAME="executeFunction" VALUE="Variables.cs_defaultFunctionChild" />
					</CALLELEMENT>
								
				</loop>
			</then>
			</if>
			
		</ELSE>
		</IF>
</then>
</if>
</FTCS>