<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<SETVAR NAME="cs.contenttype" VALUE="text/html; charset=UTF-8"/>

<!-- OpenMarket/Gator/UIFramework/LoadChildrenNodes
-
- This element creates ONLY flex parent nodes
-
- INPUT
-
- OUTPUT
-
-->

<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/BasicEnvironment"/>
     
<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/GetDefaultNodeBehavior" />
<SETVAR NAME="GroupName" VALUE="Variables.AssetType"/>
									
<!-- get all the child types of this group type -->
<ics.literal table="FlexAssetTypes" column="assettype" string="Variables.AssetType" output="literal"/>
 	<SETVAR NAME="errno" VALUE="0"/>
	<SETVAR NAME="tablename" VALUE="FlexAssetTypes"/>
	<EXECSQL SQL="SELECT assettype FROM Variables.tablename WHERE assetgroup=Variables.literal" LIST="ChildTypes"/>
	 	 
	<!-- set variables and atm.locate -->
	<atm.locate TYPE="Variables.AssetType" VARNAME="GroupManager"/>
		
	<!-- op=init: this is the initial tab load  Content.. ROOT -->
	<if COND="Variables.op=init">
	<then>
		<!-- get count of all root flex parents -->
		<flexgroups.countroots SITE="SessionVariables.pubid" NAME="GroupManager" VARNAME="rootCount"/>
	
		<!-- get the xcelerate.treeMaxNodes property -->
		<callelement NAME="OpenMarket/Xcelerate/Util/LoadProperty">
			<argument NAME="property" VALUE="xcelerate.treeMaxNodes"/>
			<argument NAME="ini" VALUE="futuretense_xcel.ini"/>
			<argument NAME="varname" VALUE="TOOMANY"/>
		</callelement>
			
		<!-- get root flex parents This will all be displayed -->
		<flexgroups.getroots TYPE="Variables.AssetType" SITE="SessionVariables.pubid" NAME="GroupManager" LISTVARNAME="PGList"/>
		<COMPLEXASSETS.GETSORTEDLIST NAME="GroupManager" LISTVARNAME="PGList" LIST="PGList"/>
			
		<if COND="Variables.errno=0">
		<then>
				<if COND="IsList.PGList=true">
				<then>
					<if COND="PGList.#numRows!=0">
					<then>
						
						<!-- render each root flex parent asset -->						
						<loop LIST="PGList">
							<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID">
								<argument NAME="ID" VALUE="PGList.assetid"/>
							</callelement>
						
							<!--check to see if the current flex parent has children-->
							<flexgroups.countimmediatechildren SITE="SessionVariables.pubid" ID="PGList.assetid"  
								                               NAME="GroupManager" VARNAME="PGChildrenCount"/>
								
							<!--  the cuRrrent flex parent has at least one child, so set LoadURL accordingly.
								  The tree uses the presence of LoadURL to determine whether a tree node should be rendered
								  as expandable or not (usually represented by a "+" icon before the node label)
								
							-->
							<if COND="Variables.PGChildrenCount!=0">
							<then>
								<!--  build its LoadURL -->
								<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
									<satellite.argument name="AssetType" value="Variables.AssetType"/>
									<satellite.argument name="populate" value="OpenMarket/Xcelerate/AssetType/Variables.AssetType/LoadTree"/>
									<satellite.argument name="id" value="PGList.assetid"/>
									<satellite.argument name="op" value="load"/>
								</SATELLITE.LINK>
							</then>
							<else>
								<!--  no child: remove LoadURL from the ics scope so it won't get passed 
								      to BuildTreeNode-->
								<REMOVEVAR NAME="LoadURL"/>
							</else>
							</if>
													
						<ASSET.GETSUBTYPE TYPE="Variables.AssetType" OBJECTID="PGList.assetid" OUTPUT="stype" />
						<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
							<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
							<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
						</CALLELEMENT>
							
						<!--  Build the node's BrowseURL used to 
					          query all immediate children   -->
					      
					    <SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="browseURL">
								<satellite.argument name="AssetType" value="Variables.AssetType"/>
								<satellite.argument name="assetid" value="PGList.assetid"/>						
								<satellite.argument name="populate" value="OpenMarket/Gator/UIFramework/BrowseParentNode"/>
								<satellite.argument name="op" value="load"/>
						</SATELLITE.LINK>
												
							<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
								<ARGUMENT NAME="Label" VALUE="PGList.name"/>						
								<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
								<!-- LoadURL implicitly passed in -->
								<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
								<ARGUMENT NAME="RefreshKeys" VALUE="PGList.assetid"/>												   
								<ARGUMENT NAME="okFunctions" VALUE="inspect;edit;delete;treerefresh" />										
								<ARGUMENT NAME="executeFunction" VALUE="Variables.cs_defaultFunctionParent" />
							</CALLELEMENT>																			
						</loop>
					</then>
					</if>
				</then>
				</if>
		</then>
		</if>	
	</then>
	<!-- else (here op=load), uc1 load all non-roots ( Parents and Asset(s) ALL  -->
	<else>
		<!-- we're in the generic case, i.e. rendering the immediate descendants of a given flex parent -->
		<!-- get the count of immediate children  Parents Only -->
					
		<flexgroups.countimmediatechildren NAME="GroupManager" ID="Variables.id" VARNAME="COUNT" SITE="SessionVariables.pubid"/>
			
		<callelement NAME="OpenMarket/Xcelerate/Util/LoadProperty">
					<argument NAME="property" VALUE="xcelerate.treeMaxNodes"/>
					<argument NAME="ini" VALUE="futuretense_xcel.ini"/>
					<argument NAME="varname" VALUE="TOOMANY"/>
		</callelement>
							
		<!--  Set the Total Count in the immediate children ALL Result Set List -->				
		<setvar NAME="totalNodes" VALUE="Variables.COUNT"/>					
		<setvar NAME="FETCH" VALUE="Variables.COUNT"/>				   	  		  
	  	<setvar NAME="maxNodes" VALUE="no"/>	
	  		
		<!-- compare COUNT and TooMany, SET THE COUNT TO MAXNODES -->
		<CALCULATOR.GO VALUE="Variables.COUNT Variables.TOOMANY GT" VARNAME="ANS"/>							
		<if COND="Variables.ANS=1">
		<then>
			<!--   <CALCULATOR.GO VALUE="Variables.FROM Variables.TOOMANY +" VARNAME="FETCH"/>  --> 							
			<setvar NAME="FETCH" VALUE="Variables.TOOMANY"/>	
			<!-- Set the reached max nodes indicator parameter  --> 
		    <setvar NAME="maxNodes" VALUE="yes"/>	
	  	</then>
		</if>
				
		<!-- if browse tree get type = TYPE="Product_P" -->
		<!--  now list all immediate children (note that we're still rendering FLEX parents only) -->
		
		<flexgroups.getimmediatechildren  ID="Variables.id" SITE="SessionVariables.pubid" NAME="GroupManager"  LISTVARNAME="PGList0"/>				
								
		<COMPLEXASSETS.GETSORTEDLIST NAME="GroupManager" LISTVARNAME="PGList" LIST="PGList0"/>
		<if COND="IsList.PGList=true">
		<then>
			
				<loop LIST="PGList"  FROM="Variables.FROM"  COUNT="Variables.FETCH" >
				
					<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID">
						<argument NAME="ID" VALUE="PGList.assetid"/>
					</callelement>
							
					<!--Now check to see if we have children-->
					<flexgroups.countimmediatechildren SITE="SessionVariables.pubid" NAME="GroupManager" 
								                       ID="PGList.assetid" VARNAME="PGChildrenCount"/> 
								
					<if COND="Variables.PGChildrenCount!=0">
					<then>
						<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
									<satellite.argument name="AssetType" value="Variables.AssetType"/>
									<satellite.argument name="populate" value="OpenMarket/Xcelerate/AssetType/Variables.AssetType/LoadTree"/>
									<satellite.argument name="id" value="PGList.assetid"/>
									<satellite.argument name="op" value="load"/>
						</SATELLITE.LINK>
						
					</then>
					<else>
						<REMOVEVAR NAME="LoadURL"/>
					</else>
					</if>
															
				    <ASSET.GETSUBTYPE TYPE="Variables.AssetType" OBJECTID="PGList.assetid" OUTPUT="stype" />
					
					<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
								<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
								<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
					</CALLELEMENT>
							
					<!--  Build the node's BrowseURL used to 
					      query all immediate children   -->
					      
					<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="browseURL">
								<satellite.argument name="AssetType" value="Variables.AssetType"/>
								<satellite.argument name="assetid" value="PGList.assetid"/>						
								<satellite.argument name="populate" value="OpenMarket/Gator/UIFramework/BrowseParentNode"/>
								<satellite.argument name="op" value="load"/>
					</SATELLITE.LINK>
									
					<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
							<ARGUMENT NAME="Label" VALUE="PGList.name"/>
							<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
							<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
							<ARGUMENT NAME="RefreshKeys" VALUE="PGList.assetid"/>
							<ARGUMENT NAME="executeFunction" VALUE="Variables.cs_defaultFunctionParent" />											   
							<ARGUMENT NAME="okFunctions" VALUE="edit;delete;treerefresh" />										
					</CALLELEMENT>
			   </loop>	   
		   </then>
		   </if>
			 <!--  we've just displayed the child flex parents - 
				   now check for immediate children from legal child flex asset types 
			  -->
		
			<LOOP LIST="ChildTypes">
						<ATM.LOCATE VARNAME="ChildAtm" TYPE="ChildTypes.assettype"/>
						<COMPLEXASSETS.GETSORTEDLIST NAME="ChildAtm" LISTVARNAME="PGList" LIST="PGList0"/>
						<setvar NAME="AssetType" VALUE="ChildTypes.assettype"/>
												
						<if COND="IsList.PGList=true">
						<then>
						
							<!--  Build the Tree Nodes  -->
						
							<loop LIST="PGList"   FROM="Variables.FROM"  COUNT="Variables.FETCH">  
								
								<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID">
									<argument NAME="ID" VALUE="PGList.assetid"/>
								</callelement>
								
								<!--Now check to see if we have children-->
								<flexgroups.countimmediatechildren 
									SITE="SessionVariables.pubid"
									NAME="GroupManager" 
									ID="PGList.assetid" 
									VARNAME="PGChildrenCount"/> 
								<if COND="Variables.PGChildrenCount!=0">
								<then>
									<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
										<satellite.argument name="AssetType" value="Variables.AssetType"/>
										<satellite.argument name="populate" value="OpenMarket/Xcelerate/AssetType/Variables.AssetType/LoadTree"/>
										<satellite.argument name="id" value="PGList.assetid"/>
										<satellite.argument name="op" value="load"/>
									</SATELLITE.LINK>
								</then>
								<else>
									<REMOVEVAR NAME="LoadURL"/>
								</else>
								</if>
								
								
								<ASSET.GETSUBTYPE TYPE="Variables.AssetType" OBJECTID="PGList.assetid" OUTPUT="stype" />
								
								<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
									<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
									<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
								</CALLELEMENT>
														
								<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
									<ARGUMENT NAME="Label" VALUE="PGList.name"/>
									<ARGUMENT NAME="Description" VALUE="PGList.description"/>
									<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
									<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
									<ARGUMENT NAME="RefreshKeys" VALUE="PGList.assetid"/>
									<ARGUMENT NAME="executeFunction" VALUE="Variables.cs_defaultFunctionChild" />													   
									<ARGUMENT NAME="okFunctions" VALUE="edit;delete;treerefresh" />									
								</CALLELEMENT>
							</loop>														
				</then>
				</if>
			</LOOP>
			<!--  End of LOADALL NON-ROOTS ------>				
	</else>
	</if>

</FTCS> 
