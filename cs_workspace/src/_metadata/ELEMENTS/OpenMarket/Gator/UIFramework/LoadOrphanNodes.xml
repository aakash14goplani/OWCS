<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<SETVAR NAME="cs.contenttype" VALUE="text/html; charset=UTF-8"/>

<!-- OpenMarket/Gator/UIFramework/LoadOrphanNodes
-
- INPUT
-
- OUTPUT
-
-->

<IF cond="Variables.cs_environment=ucform">
<THEN>
	<IF cond="Variables.showParents=false">
    <THEN>				
	   <CALLELEMENT NAME="OpenMarket/Gator/UIFramework/LoadOrphanChildrenNodes"/>		 
	 </THEN>
	 </IF>
</THEN>
<ELSE>

<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/BasicEnvironment"/>

<!-- Get root products -->
<IF COND="Variables.command=GetTypes">
<THEN>
	<SETVAR NAME="Variables.varname" VALUE="Variables.AssetType"/>
</THEN>
<ELSE>
    <IF COND="Variables.AssetType!=Page">
	<THEN>
	<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/GetDefaultNodeBehavior" />
	<ATM.LOCATE TYPE="Variables.AssetType" VARNAME="OrphanAtm"/>
	
	<flexgroups.countroots SITE="SessionVariables.pubid" NAME="OrphanAtm" VARNAME="rootCount"/>
			
	<callelement NAME="OpenMarket/Xcelerate/Util/LoadProperty">
		<argument NAME="property" VALUE="xcelerate.treeMaxNodes"/>
		<argument NAME="ini" VALUE="futuretense_xcel.ini"/>
		<argument NAME="varname" VALUE="TOOMANY"/>
	</callelement>
			
	<!-- compare rootCount and TooMany, return dummy node if COUNT is larger-->
	<CALCULATOR.GO VALUE="Variables.rootCount Variables.TOOMANY GT" VARNAME="ANS"/>
	
	<if COND="Variables.ANS=1">
	<then>
		<!-- get search criteria -->
		<if COND="Variables.id=toomanyitem">
		<then>
			<if COND="IsVariable.mode!=true">
			<then>
				<!-- load countroot again, return message, and ask for criteria -->
				<flexgroups.countroots SITE="SessionVariables.pubid" NAME="OrphanAtm" VARNAME="rootCount"/>
				<STRING.LENGTH VALUE="Variables.rootCount" VARNAME="length"/>
				Status:12:tooManyItems:Count:<STRING.STREAM VALUE="Variables.length:Variables.rootCount:"/>END:3:END:
				<throwexception/>
			</then>
			</if>
			
			<!-- else modify criteria and load selected roots -->
			<setvar NAME="input" VALUE="%Variables.criteria%"/> 
			<BEGINS STR="Variables.criteria" WHAT="%"/>
			<if COND="Variables.errno=1">
			<then>
				<setvar NAME="input" VALUE="Variables.criteria"/>
			</then>
			</if>
			<ENDS STR="Variables.criteria" WHAT="%"/>
			<if COND="Variables.errno=1">
			<then>
				<setvar NAME="input" VALUE="Variables.criteria"/>
			</then>
			</if>
			<if COND="Variables.criteria=%">
			<then>
				<setvar NAME="input" VALUE="%"/>
			</then>
			</if>
			
			<flexgroups.getroots SITE="SessionVariables.pubid" NAME="OrphanAtm" LISTVARNAME="PList" FIELD="name" VALUE="Variables.input"/>
			<COMPLEXASSETS.GETSORTEDLIST NAME="OrphanAtm" LISTVARNAME="PList" LIST="PList"/>
			<if COND="Variables.errno=0">
			<then>
				<if COND="IsList.PList=true">
				<then>
					<if COND="PList.#numRows!=0">
					<then>
						<STARTMENU.GETMATCHINGSTARTITEMS ITEMTYPE="ContentForm" PUBID="SessionVariables.pubid" ASSETTYPE="Variables.AssetType" INPUTARGUMENTS="subtype" LISTVARNAME="startitems"/>
						<IF COND="IsList.startitems=true">
						<THEN>
							<IF COND="startitems.#numRows!=0">
							<THEN>
								<SETVAR NAME="OKActions" VALUE="__LIKEMESTARTMENU__;Status;Inspect;Edit;Preview;Delete;refresh"/>
							</THEN>
							<ELSE>
								<SETVAR NAME="OKActions" VALUE="Status;Inspect;Edit;Preview;Delete;refresh"/>
							</ELSE>
							</IF>
						</THEN>
						</IF>
						<loop LIST="PList">
							<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID">
								<argument NAME="ID" VALUE="PList.assetid"/>
							</callelement>
							
							<REMOVEVAR NAME="LoadURL"/>
							<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="ExecuteURL">
								<satellite.argument name="AssetType" value="Variables.AssetType"/>
								<satellite.argument name="n0_" value="Variables.TreeNodeID"/>
								<satellite.argument name="op" value="displayNode"/>
							</SATELLITE.LINK>
							
							<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
								<satellite.argument name="AssetType" value="Variables.AssetType"/>
							</SATELLITE.LINK>
							
							<REMOVEVAR NAME="PreviewURL"/>
							<PREVIEWURL.MAKEURL VARNAME="PreviewURL" ASSETTYPE="Variables.AssetType" ASSETID="PList.assetid" PUBID="SessionVariables.pubid"/>
							
							<ASSET.GETSUBTYPE TYPE="Variables.AssetType" OBJECTID="PList.assetid" OUTPUT="stype" />
							<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
								<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
								<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
							</CALLELEMENT>
							<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
								<ARGUMENT NAME="Label" VALUE="PList.name"/>
								<ARGUMENT NAME="Description" VALUE="PList.description"/>
								<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
								<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
								<ARGUMENT NAME="ExecuteURL" VALUE="Variables.ExecuteURL"/>
								<!-- OKActions passed in implicitly -->
								<!-- PreviewURL passed in implicitly too -->
								<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
								<ARGUMENT NAME="RefreshKeys" VALUE="PList.assetid"/>
								<ARGUMENT NAME="okFunctions" VALUE="Variables.okFunctions" />
								<ARGUMENT NAME="executeFunction" VALUE="Variables.cs_defaultFunctionChild" />
							</CALLELEMENT>
						</loop>
					</then>
					</if>
				</then>
				</if>
			</then>
			</if>
		</then>
		<else>
			<REMOVEVAR NAME="Image"/>
			<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
				<satellite.argument name="AssetType" value="Variables.AssetType"/>
				<satellite.argument name="populate" value="OpenMarket/Xcelerate/AssetType/Variables.AssetType/LoadTree"/>
				<satellite.argument name="id" value="toomanyitem"/>
				<satellite.argument name="op" value="load"/>
			</SATELLITE.LINK>
			
			<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
				<satellite.argument name="AssetType" value="Variables.AssetType"/>
			</SATELLITE.LINK>
			
			<XLAT.LOOKUP KEY="dvin/TreeApplet/SelectMoreItems" ENCODE="false" VARNAME="SelItemForNode"/>
			
			<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
				<ARGUMENT NAME="Label" VALUE="Variables.SelItemForNode"/>
				<ARGUMENT NAME="Description" VALUE="Variables.rootCount"/>
				<ARGUMENT NAME="ID" VALUE="toomanyitem"/>
				<ARGUMENT NAME="Status" VALUE="tooManyItems"/>
				<ARGUMENT NAME="LoadURL" VALUE="Variables.LoadURL"/>
				<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
				<ARGUMENT NAME="ExecuteURL" VALUE="Variables.empty"/>
				<ARGUMENT NAME="OKActions" VALUE="refresh"/>
			</CALLELEMENT>
		</else>
		</if>
	</then>
	<else>
		<flexgroups.getroots SITE="SessionVariables.pubid" NAME="OrphanAtm" LISTVARNAME="PList"/>
		
		<COMPLEXASSETS.GETSORTEDLIST NAME="OrphanAtm" LISTVARNAME="PList" LIST="PList"/>
		<if COND="Variables.errno=0">
		<then>
			<if COND="IsList.PList=true">
			<then>
				<if COND="PList.#numRows!=0">
				<then>
					<STARTMENU.GETMATCHINGSTARTITEMS ITEMTYPE="ContentForm" PUBID="SessionVariables.pubid" ASSETTYPE="Variables.AssetType" INPUTARGUMENTS="subtype" LISTVARNAME="startitems"/>
					<IF COND="IsList.startitems=true">
					<THEN>
						<IF COND="startitems.#numRows!=0">
						<THEN>
							<SETVAR NAME="OKActions" VALUE="__LIKEMESTARTMENU__;Status;Inspect;Edit;Preview;Delete;refresh"/>							
						</THEN>
						<ELSE>
							<SETVAR NAME="OKActions" VALUE="Status;Inspect;Edit;Preview;Delete;refresh"/>
						</ELSE>
						</IF>
					</THEN>
					</IF>
					<loop LIST="PList">
						<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID">
							<argument NAME="ID" VALUE="PList.assetid"/>
						</callelement>
						
						<REMOVEVAR NAME="LoadURL"/>
						<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="ExecuteURL">
							<satellite.argument name="AssetType" value="Variables.AssetType"/>
							<satellite.argument name="n0_" value="Variables.TreeNodeID"/>
							<satellite.argument name="op" value="displayNode"/>
						</SATELLITE.LINK>
						
						<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
							<satellite.argument name="AssetType" value="Variables.AssetType"/>
						</SATELLITE.LINK>
						
						<!-- Flex groups can be previewed now too -->
						<REMOVEVAR NAME="PreviewURL"/>
						<PREVIEWURL.MAKEURL VARNAME="PreviewURL" ASSETTYPE="Variables.AssetType" ASSETID="PList.assetid" PUBID="SessionVariables.pubid"/>
						
						<ASSET.GETSUBTYPE TYPE="Variables.AssetType" OBJECTID="PList.assetid" OUTPUT="stype" />
						<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
							<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
							<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
						</CALLELEMENT>
						
						<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
							<ARGUMENT NAME="Label" VALUE="PList.name"/>
							<ARGUMENT NAME="Description" VALUE="PList.description"/>
							<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
							<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
							<ARGUMENT NAME="ExecuteURL" VALUE="Variables.ExecuteURL"/>
							<!-- OKActions passed in implicitly -->
							<!-- PreviewURL also passed in implicitly -->
							<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
							<ARGUMENT NAME="RefreshKeys" VALUE="PList.assetid"/>
							<ARGUMENT NAME="okFunctions" VALUE="Variables.okFunctions" />
							<ARGUMENT NAME="executeFunction" VALUE="Variables.cs_defaultFunctionChild" />
						</CALLELEMENT>
					</loop>
				</then>
				</if>
			</then>
			</if>
		</then>
		</if>
	</else>
	</if>
</THEN>
</IF>
</ELSE>
</IF>
</ELSE>
</IF>
</FTCS>