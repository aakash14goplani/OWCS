<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateC/install/Gator/Populate/ElementCatalog/OpenMarket/Gator/XMLPost/addData.xml $ 
$Revision: 35 $ 
$Modtime: 4/28/04 3:36p $ 
-->

<!--
- Confidential and Proprietary Information of Open Market Inc.
-					All Rights Reserved.
-
- RemoteContentPost.xml
-
- DESCRIPTION
-    This element handles the posting of content by
-    a remote client (XMLPost, or other)
-
-    Required: None
-->

<CALLELEMENT NAME="OpenMarket/Xcelerate/Util/SetLocale"/>
	
<USERMANAGER.GETLOGINUSER VARNAME="usrname"/>
<IF COND="IsVariable.usrname=true">
<THEN>
	<SETVAR NAME="loggedIn" VALUE="true"/>
</THEN>
<ELSE>
	<USERMANAGER.LOGINUSER USERNAMEVARIABLE="authusername" PASSWORDVARIABLE="authpassword" VARNAME="loggedIn"/>
	<if COND="Variables.loggedIn=false">
	<then>
		<XLAT.STREAM KEY="dvin/UI/Error/LoginfailedremotepostCheckauthusernamepassword"/>
		<throwexception/>
	</then>
	</if>
</ELSE>
</IF>

<if COND="IsVariable.xmlpostdebug=true">
	<then>
	<XLAT.STREAM KEY="dvin/Error/AT/Flex/xmlpostdebugstatus" status="ON" EVALALL="false"/>
	</then>
	<else>
	<XLAT.STREAM KEY="dvin/Error/AT/Flex/xmlpostdebugstatus" status="OFF" EVALALL="false"/>
	</else>
</if>

<!-- Check for a valid publication -->
<if COND="IsVariable.primarypubid=false">
<then>
	<if COND="IsVariable.publication=true">
	<then>
		<PUBLICATION.LOAD NAME="publication" FIELD="name" VALUE="Variables.publication"/>
		<PUBLICATION.GET NAME="publication" FIELD="id" OUTPUT="primarypubid"/>
	</then>
	<else>
		<!-- neither primarypubid nor publication provided -->
		<PUBLICATION.LIST LIST="publist"/>
		<if COND="publist.#numRows=1">
		<then>
			<SETVAR NAME="primarypubid" VALUE="publist.id"/>
		</then>
		</if>
	</else>
	</if>
</then>
<else>
	<PUBLICATION.LOAD NAME="publication" OBJECTID="Variables.primarypubid"/>
	<if COND="IsError.Variables.errno=true">
	<then>
		<if COND="IsVariable.xmlpostdebug=true">
		<then>
		<XLAT.STREAM KEY="dvin/UI/Error/ErrorInvalidprimarypubid"/>
		</then>
		</if>
		<throwexception/>
	</then>
	</if>
</else>
</if>

<if COND="IsVariable.publist=true">
<then>
	<STRINGLIST NAME="pubs" STR="Variables.publist" DELIM=","/>
	<SETVAR NAME="pubidlist" VALUE="Variables.empty"/>
	<LOOP LIST="pubs">
		<PUBLICATION.LOAD NAME="publication" FIELD="name" VALUE="pubs.ITEM"/>
		<PUBLICATION.GET NAME="publication" FIELD="id" OUTPUT="nextpubid"/>
		<if COND="IsError.Variables.errno=false">
		<then>
			<if COND="Variables.pubidlist=Variables.empty">
			<then>
				<SETVAR NAME="pubidlist" VALUE="Variables.nextpubid"/>
				<if COND="IsVariable.primarypubid=false">
				<then>
					<SETVAR NAME="primarypubid" VALUE="Variables.nextpubid"/>
				</then>
				</if>
			</then>
			<else>
				<SETVAR NAME="pubidlist" VALUE="Variables.pubidlist;Variables.nextpubid"/>
			</else>
			</if>
		</then>
		</if>
	</LOOP>
</then>
</if>

<if COND="IsVariable.primarypubid=false">
<then>
	<if COND="IsVariable.xmlpostdebug=true">
	<then>
	<XLAT.STREAM KEY="dvin/UI/Error/Missingorinvalidpublicationvariable"/>
	</then>
	</if>
	<throwexception/>
</then>
</if>

<IF COND="IsVariable._ASSET_!=true">
<THEN>
	<if COND="IsVariable.xmlpostdebug=true">
	<then>
	<XLAT.STREAM KEY="dvin/Error/AT/Flex/Fatalerror_ASSET_notset"/>
	</then>
	</if>
	<THROWEXCEPTION/>        
</THEN>
</IF>

<IF COND="IsVariable._ITEMNAME_!=true">
<THEN>
	<if COND="IsVariable.xmlpostdebug=true">
	<then>
	<XLAT.STREAM KEY="dvin/Error/AT/Flex/Fatalerror_ITEMNAME_notset"/>
	</then>
	</if>
	<THROWEXCEPTION/>        
</THEN>
</IF>

<TEXTFORMAT.LENGTH VALUE="Variables._ITEMNAME_" VARNAME="length"/>
<PROPERTY.GET PARAM="xcelerate.asset.sizeofnamefield" INIFILE="futuretense_xcel.ini" VARNAME="sizeofnamefield"/>
<CALCULATOR.GO VALUE="Variables.length Variables.sizeofnamefield GT" VARNAME="toolong"/>
<IF COND="Variables.toolong=1">
<THEN>
	<if COND="IsVariable.xmlpostdebug=true">
	<then>
	<XLAT.STREAM KEY="dvin/Error/AT/Flex/Fatalerror_ITEMNAME_toolong"/>
	</then>
	</if>
	<THROWEXCEPTION/>
</THEN>
</IF>

<IF COND="IsVariable._TYPE_!=true">
<THEN>
	<if COND="IsVariable.xmlpostdebug=true">
	<then>
	<XLAT.STREAM KEY="dvin/Error/AT/Flex/Fatalerror_TYPE_notset"/>
	</then>
	</if>
	<THROWEXCEPTION/>        
</THEN>
</IF>
	<!-- Find template type and load the asset template -->
	<FATM.GETTEMPLATETYPE ASSETTYPE="Variables._ASSET_" VARNAME="TemplateType"/>
	<IF COND="IsVariable.TemplateType=false">
	<THEN>
		<FGTM.GETTEMPLATETYPE ASSETTYPE="Variables._ASSET_" VARNAME="TemplateType"/>
		<SETVAR NAME="GroupType" VALUE="Variables._ASSET_"/>
		<FGTM.GETATTRIBUTETYPE ASSETTYPE="Variables._ASSET_" VARNAME="AttributeType"/>
		<FGTM.GETTEMPLATETYPE ASSETTYPE="Variables._ASSET_" VARNAME="GroupTemplateType"/>
	</THEN>
	<ELSE>
		<FATM.GETGROUPTYPE ASSETTYPE="Variables._ASSET_" VARNAME="GroupType"/>
		<FATM.GETATTRIBUTETYPE ASSETTYPE="Variables._ASSET_" VARNAME="AttributeType"/>
		<FGTM.GETTEMPLATETYPE ASSETTYPE="Variables.GroupType" VARNAME="GroupTemplateType"/>
	</ELSE>
	</IF>

<!-- Find correct assetid based on name and publication -->
<callelement NAME="OpenMarket/Gator/XMLPost/GetAssetID">
	<argument NAME="theType" VALUE="Variables.TemplateType"/>
   <argument NAME="thePub" VALUE="Variables.primarypubid"/>
	<argument NAME="theName" VALUE="Variables._TYPE_"/>
</callelement>

<IF COND="Variables.myID!=Variables.empty">
<THEN>
	<setvar NAME="tmplid" VALUE="Variables.myID"/>
	<ASSET.LOAD NAME="tmplinst" TYPE="Variables.TemplateType" FIELD="id" VALUE="Variables.tmplid"/>
</THEN>
<ELSE>
	<setvar NAME="errno" VALUE="-101"/>
</ELSE>
</IF>

<IF COND="Variables.errno!=0">
<THEN>
	<if COND="IsVariable.xmlpostdebug=true">
	<then>
	<XLAT.STREAM KEY="dvin/Error/AT/Flex/Loadofdefinitionfailed" TemplateType="Variables.TemplateType" _TYPE_="Variables._TYPE_" errno="Variables.errno" errdetail1="Variables.errdetail1" EVALALL="false"/>
	</then>
	</if>
	<THROWEXCEPTION/>
</THEN>
</IF>

<SETCOUNTER NAME="level" VALUE="1"/>
<SETCOUNTER NAME="child" VALUE="0"/>
<SETCOUNTER NAME="grandchild" VALUE="-1"/>

<setvar NAME="PostDataIsOk" VALUE="yes"/>

<ATM.LOCATE TYPE="Variables.TemplateType" VARNAME="ftmgr"/>
<ATM.LOCATE TYPE="Variables.GroupTemplateType" VARNAME="fgtmgr"/>

<FLEXTEMPLATE.GETALLPARENTS NAME="tmplinst" LISTVARNAME="Counters.childparents"/>

<LISTOBJECT.CREATE NAME="immediateParents" COLUMNS="groupid"/>

<IF COND="IsList.Counters.childparents=true">
<THEN>
	<!-- Recursively find the templates parents -->
	<CALLELEMENT NAME="OpenMarket/Gator/XMLPost/GetTemplateParents"/>
</THEN>
</IF>

<IF COND="Variables.PostDataIsOk=no">
<THEN>
	<if COND="IsVariable.xmlpostdebug=true">
	<then>
	<XLAT.STREAM KEY="dvin/Error/AT/Flex/Badpostdatainparenthierarchy"/>
	</then>
	</if>
	<THROWEXCEPTION/>
</THEN>
</IF>

<!-- All groups, if any, are instantiated.  Create product if possible.  -->
<FLEXTEMPLATES.GETATTRIBUTES NAME="ftmgr" ID="Variables.tmplid" LISTVARNAME="attrlist"/>
<ASSET.CREATE NAME="pinst" TYPE="Variables._ASSET_"/>
<COMPLEXASSET.SETNAME NAME="pinst" VALUE="Variables._ITEMNAME_"/>
<FLEXASSET.SETTEMPLATE NAME="pinst" ID="Variables.tmplid"/>

<IF COND="IsVariable._ITEMDESCRIPTION_=true">
<THEN>
	<ASSET.SET NAME="pinst" FIELD="description" VALUE="Variables._ITEMDESCRIPTION_"/>
</THEN>
</IF>

<IF COND="IsVariable.template=true">
<THEN>
	<SETVAR NAME="displaytype" VALUE="Variables.template"/>
</THEN>
</IF>

<IF COND="IsVariable.startdate=true">
<THEN>
	<ASSET.SET NAME="pinst" FIELD="startdate" VALUE="Variables.startdate"/>
</THEN>
</IF>

<IF COND="IsVariable.enddate=true">
<THEN>
	<ASSET.SET NAME="pinst" FIELD="enddate" VALUE="Variables.enddate"/>
</THEN>
</IF>

<IF COND="IsVariable.locale=true">
<THEN>
	<ASSET.LOAD NAME="localeAsset" TYPE="Dimension" FIELD="name" VALUE="Variables.locale"/>
	<IF COND="Variables.errno!=0">
	<THEN>
		<IF COND="IsVariable.xmlpostdebug=true">
		<THEN>
			<XLAT.STREAM KEY="dvin/UI/Admin/Error/InvalidLocale"/>
		</THEN>
		</IF>
		<THROWEXCEPTION/>
	</THEN>
	<ELSE>
		<!-- check whether to add to a dimension set -->
		<IF COND="IsVariable.masterasset=true">
		<THEN>
			<setvar name="errno" value="0" />
			<ASSET.LOAD NAME="dimparent" TYPE="Variables._ASSET_" FIELD="name" VALUE="Variables.masterasset" EDITABLE="false"/>
			<IF COND="Variables.errno=0">
			<THEN>			
				<!--  check whether the dimension-parent has a dimension assigned-->
				<asset.getlocales name="dimparent" list="dimparentlocale"/>
				<IF COND="dimparentlocale.#numRows!=0">
				<THEN>
					<!-- assuming dimension group as Locale -->
					<asset.get name="dimparent" field="id" output="dimparentid"/>	
					<asset.setdimparents name="pinst">
						<asset.dimensionparentrelationship type="Variables._ASSET_" assetid="Variables.dimparentid" group="Locale"/>
					 </asset.setdimparents>
				</THEN>
				<ELSE>
					<XLAT.STREAM KEY="dvin/UI/Error/dimensionParentLocaleNotAssigned"/>
					<THROWEXCEPTION/>
				</ELSE>
				</IF>					 
			</THEN>
			<ELSE>
				<XLAT.STREAM KEY="dvin/UI/Error/dimensionParentUnableToLoad"/>
				<THROWEXCEPTION/>
			</ELSE>
			</IF>
		</THEN>
		</IF>
		<!-- Invalid locales won't get assigned, this element does not set errno incase of invalid locales -->
		<ASSET.ADDDIMENSION name="pinst" dimensionname="Variables.locale"/>
	</ELSE>
	</IF>
</THEN>
</IF>

<IF COND="IsVariable.displaytype=true">
<THEN>
	<!-- Find correct assetid based on name and publication -->
	<callelement NAME="OpenMarket/Gator/XMLPost/GetAssetID">
		<argument NAME="theType" VALUE="Template"/>
		<argument NAME="thePub" VALUE="Variables.primarypubid"/>
		<argument NAME="theName" VALUE="Variables.displaytype"/>
	</callelement>
	
	<IF COND="Variables.myID!=Variables.empty">
	<THEN>
		<setvar NAME="renderid" VALUE="Variables.myID"/>
		<ASSET.LOAD NAME="ainst" TYPE="Template" FIELD="id" VALUE="Variables.renderid"/>
	</THEN>
	<ELSE>
		<setvar NAME="errno" VALUE="-101"/>
	</ELSE>
	</IF>
	
	<IF COND="Variables.errno=0">
	<THEN>
		<ASSET.SET NAME="pinst" FIELD="template" VALUE="Variables.displaytype"/>
		<FLEXASSET.SETRENDERTEMPLATE NAME="pinst" ID="Variables.renderid"/>
	</THEN>
	<ELSE>
		<if COND="IsVariable.xmlpostdebug=true">
		<then>
		<XLAT.STREAM KEY="dvin/Error/AT/Flex/LoadofrenderTemplatefailed" displaytype="Variables.displaytype" errno="Variables.errno" errdetail1="Variables.errdetail1" EVALALL="false"/>
		</then>
		</if>
	</ELSE>
	</IF>
</THEN>
</IF>

<IF COND="attrlist.#numRows!=0">
<THEN>
	<CALLELEMENT NAME="OpenMarket/Gator/XMLPost/SetAttributes">
		<ARGUMENT NAME="attrlist" VALUE="attrlist"/>
		<ARGUMENT NAME="assettype" VALUE="Variables._ASSET_"/>
		<ARGUMENT NAME="assetname" VALUE="Variables._ITEMNAME_"/>
	</CALLELEMENT>
</THEN>
</IF>

<!-- Add parents, tough to validate -->
<LISTOBJECT.TOLIST  NAME="immediateParents" LISTVARNAME="parentlist"/>
<LOOP LIST="parentlist">
	<FLEXASSET.ADDPARENT NAME="pinst" ID="parentlist.groupid"/>
</LOOP>

<IF COND="Variables.PostDataIsOk=yes">
<THEN>
	<!-- set the status -->
	<ASSET.SET NAME="pinst" FIELD="status" VALUE="RF"/>
	<ASSET.GATHER NAME="pinst" FIELDLIST="externalid,template,filename,path,ruleset,renderid"/> 
    <ASSET.SAVE NAME="pinst"/>
   
	<IF COND="Variables.errno=0">
	<THEN>
      <COMPLEXASSET.GETID NAME="pinst" VARNAME="assetid"/>
      <XLAT.STREAM KEY="dvin/UI/SuccessAssetTypenameidsaved" AssetType="Variables._ASSET_" id="Variables.assetid" name="Variables._ITEMNAME_" EVALALL="false"/>
		
		<if COND="IsVariable.pubidlist=true">
		<then>
			<ASSET.SHARE NAME="pinst" PUBLIST="Variables.pubidlist"/>
		</then>
		</if>
		
		<if COND="IsError.Variables.errno=true">
			 <then>
			 	<if COND="IsVariable.xmlpostdebug=true">
				<then>
				<XLAT.STREAM KEY="dvin/UI/Error/RemotePostShareFailed"  errno="Variables.errno" AssetType="Variables.AssetType" id="Variables.id" pubidlist="Variables.pubidlist" EVALALL="false"/> 
				</then>
				</if>
				<throwexception/>
			 </then>
		</if>

        <!-- See if the Revision Tracking is enabled and if so,  do a checkout and checkin -->

        <SETVAR NAME="id" VALUE="Variables.assetid"/>
		<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
            <argument NAME="AssetType" VALUE="Variables._ASSET_"/>
        </callelement>
        <IF COND="Variables.trackingenabled=true">
            <THEN>
<!-- commit the change -->
                <ASSET.CHECKOUT OBJECTTYPE="Variables.AssetType" OBJECTID="Variables.id"/>
                <ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Commit-Asset"/>
                <XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/VersionbyNew" VARNAME="_xlat_version"/>
                <ASSET.CHECKIN NAME="Commit-Asset" ANNOTATION="Variables._xlat_version" CHECKOUT="false"/>
            </THEN>
        </IF>

		<if COND="IsVariable.startmenu=true">
		<then>
			<SETVAR NAME="AssetType" VALUE="Variables._ASSET_"/>
			
			<STARTMENU.LOAD NAME="Variables.startmenu" OBJVARNAME="si" ITEMTYPE="ContentForm"/>
			<if COND="IsError.Variables.errno=true">
			<then>
				<if COND="IsVariable.xmlpostdebug=true">
				<then>
				<XLAT.STREAM KEY="dvin/UI/Error/RemotePostCannotsetloadstartmenuworkflow" errno="Variables.errno" AssetType="Variables.AssetType" id="Variables.id" name="Variables._ASSET_" ENCODE="false" EVALALL="false"/> 
				</then>
				</if>
			</then>
			<else>	
				<STARTMENUITEM.GETPROCESSES NAME="si" OBJVARNAME="currentProc"/>
				<PROCESSLIST.GETALL NAME="currentProc" VARNAME="__WORKFLOWPROCID__"/>
				
				<WORKFLOWASSET.LOAD ASSETTYPE="Variables.AssetType"
										  ID="Variables.id"
										  OBJVARNAME="workflowasset" />
				<WORKFLOWENGINE.CANSTARTWORKFLOW ID="Variables.__WORKFLOWPROCID__" SITE="Variables.primarypubid" VARNAME="canstartworkflow"/>
				<if COND="Variables.canstartworkflow=true">
				<then>
					<STARTMENUITEM.GETPARTICIPANTS NAME="si" OBJVARNAME="currentParts"/>
					<PARTICIPANTLIST.GETREQUIRED NAME="currentParts" OBJVARNAME="partsList"/>
					<!--
					<WORKFLOWENGINE.SETOBJECTPARTICIPANTS OBJECT="workflowasset" PARTICIPANTS="partsList"/>
					-->
					<WORKFLOWENGINE.STARTOBJECTWORKFLOWPROCESS SITE="Variables.primarypubid"
																			 OBJECT="workflowasset" 
																			 ID="Variables.__WORKFLOWPROCID__"
																			 PARTICIPANTS="partsList"/>
				</then>
				<else>
					<if COND="IsVariable.xmlpostdebug=true">
					<then>
					<XLAT.STREAM KEY="dvin/UI/Error/RemotePostUsernotpermittedstartwfinpub" errno="Variables.errno" AssetType="Variables.AssetType" id="Variables.id" name="Variables._ASSET_" authusername="Variables.authusername" primarypubid="Variables.primarypubid" ENCODE="false" EVALALL="false"/> 
					</then>
					</if>
				</else>
				</if>
			</else>
			</if>
		</then>
		</if>						  
		
	</THEN>
	<ELSE>
		<XLAT.STREAM KEY="dvin/UI/Error/RemotePostSavefailedSameAssetTypeexists" errno="Variables.errno" AssetType="Variables._ASSET_" EVALALL="false"/> 
		<XLAT.STREAM KEY="dvin/UI/Error/Detailserrdetail1" errdetail1="Variables.errdetail1" EVALALL="false"/>
	</ELSE>
	</IF>
</THEN>
<ELSE>
	<XLAT.STREAM KEY="dvin/Error/AT/Flex/Postdatanogood"/>
</ELSE>
</IF>

</FTCS>
