<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Util/SetLocale
-
- INPUT
-
- OUTPUT
-
-->
	<USERMANAGER.GETLOGINUSER VARNAME="loginuser"/>
	<!-- Determine locale.
		  Use user preference if set.  -->
	<IF COND="IsVariable.loginuser=true">
	<THEN>
		<SETVAR NAME="errno" VALUE="0"/>
		<USERISMEMBER GROUP="xceleditor"/>
		<IF COND="Variables.errno=1">
		<THEN>
			<USERMANAGER.GETUSER USER="Variables.loginuser" OBJVARNAME="userobj"/>	  
			<CCUSER.GETLOCALE NAME="userobj" VARNAME="userLocalePref"/>
		</THEN>
		</IF>
	</THEN>
	</IF>
   <REMOVESSVAR NAME="locale"/>

	<SETVAR NAME="errno" VALUE="0"/>
	<SETVAR NAME="tablename" VALUE="LocaleMap"/>
	<EXECSQL SQL="SELECT * FROM Variables.tablename ORDER BY ordinal" LIST="lServerPrefs"/>
	<IF COND="Variables.errno=0">
	<THEN>
		<HASH.CREATE NAME="hServerPrefs" LIST="lServerPrefs" COLUMN="id"/>
		<IF COND="IsVariable.userLocalePref=true">
		<THEN>
			<!-- if for some reason a user preference is no longer in the LocaleMap, pretend
				no preference was set.  -->
			<HASH.CONTAINS NAME="hServerPrefs" VALUE="Variables.userLocalePref" VARNAME="hasit"/>
			<IF COND="Variables.hasit=true">
			<THEN>
				<SETSSVAR NAME="locale" VALUE="Variables.userLocalePref"/>
			</THEN>
			</IF>
		</THEN>
		</IF>

		<!-- next match browser language prefs (HTTP_ACCEPT_LANGUAGE) to server prefs -->
		<!-- browser prefs may be of the format (language-COUNTRY/country) or (language).  The browser
         may also tack on a (;Q=x.y) which is the quality of the translation it wants.  We will ignore 
         this since all our translations are 100%.
			The case of the country is upper for Netscape 4.x and lower for IE and later Netscapes.
			Server prefs are of the (language_COUNTRY) format.
         If no match is found set to first server pref.  -->
		
		<IF COND="IsSessionVariable.locale=false">
		<THEN>
			<STRINGLIST NAME="lBrowserPrefs" STR="CS.Header.Accept-Language" DELIM=","/>
			<SETSSVAR NAME="locale" VALUE="lServerPrefs.id"/>

			<!-- if a browser pref has both language and country (LANGUAGE-COUNTRY)
				look for an ignore case match in server prefs (LANGUAGE_COUNTRY)  --> 
			<LOOP LIST="lBrowserPrefs">
            <STRINGLIST NAME="lLanguageQualitySplit" STR="lBrowserPrefs.ITEM" DELIM=";"/>
            
				<SETVAR NAME="errno" VALUE="0"/>
				<INDEXOF STR="lLanguageQualitySplit.ITEM" WHAT="-" OUTSTR="foo"/>
				<IF COND="Variables.errno=1">
				<THEN>
					<STRINGLIST NAME="lLanguageCountrySplit" STR="lLanguageQualitySplit.ITEM" DELIM="-"/>
					<SETVAR NAME="currentBrowserPref" VALUE="lLanguageCountrySplit.ITEM"/>
               <SETVAR NAME="currentBrowserLanguage" VALUE="lLanguageCountrySplit.ITEM"/>
					<SETROW LIST="lLanguageCountrySplit" ACTION="NEXT"/>
					<TOUPPER STR="lLanguageCountrySplit.ITEM" OUTSTR="upperCountry"/>
					<SETVAR NAME="currentBrowserPref" VALUE="Variables.currentBrowserPref_Variables.upperCountry"/>
					
					<HASH.CONTAINS NAME="hServerPrefs" VALUE="Variables.currentBrowserPref" VARNAME="hasit"/>
					<IF COND="Variables.hasit=true">
					<THEN>
						<SETSSVAR NAME="locale" VALUE="Variables.currentBrowserPref"/>
						<SETROW LIST="lBrowserPrefs" ACTION="LAST"/>
					</THEN>
               <ELSE>
                  <!-- peek at next browser pref and see if it has the same language -->
                  <!-- if it does, try matching it, otherwise try a server pref of anything
                     with that language -->
                  <IF COND="lBrowserPrefs.#curRow!=lBrowserPrefs.#numRows">
                  <THEN>
                     <SETROW LIST="lBrowserPrefs" ACTION="NEXT"/>
                     <STRINGLIST NAME="lLanguageQualitySplit" STR="lBrowserPrefs.ITEM" DELIM=";"/>
                     <STRINGLIST NAME="lLanguageCountrySplit" STR="lLanguageQualitySplit.ITEM" DELIM="-"/>
                     <SETVAR NAME="errno" VALUE="0"/>
         				<INDEXOF STR="lLanguageQualitySplit.ITEM" WHAT="-" OUTSTR="foo"/>
         				<IF COND="Variables.errno=1">
         				<THEN>
         					<SETVAR NAME="currentBrowserPref" VALUE="lLanguageCountrySplit.ITEM"/>
                        
                        <IF COND="lLanguageCountrySplit.ITEM=Variables.currentBrowserLanguage">
                        <THEN>
                           <!-- try for exacy match -->
                           <SETROW LIST="lLanguageCountrySplit" ACTION="NEXT"/>
            					<TOUPPER STR="lLanguageCountrySplit.ITEM" OUTSTR="upperCountry"/>
            					<SETVAR NAME="currentBrowserPref" VALUE="Variables.currentBrowserPref_Variables.upperCountry"/>
                           <HASH.CONTAINS NAME="hServerPrefs" VALUE="Variables.currentBrowserPref" VARNAME="hasit"/>
            					<IF COND="Variables.hasit=true">
            					<THEN>
            						<SETSSVAR NAME="locale" VALUE="Variables.currentBrowserPref"/>
            						<SETROW LIST="lBrowserPrefs" ACTION="LAST"/>
                              <SETVAR NAME="foundLocale" VALUE="true"/>
            					</THEN>
                           </IF>
                        </THEN>
                        <ELSE>
                           <!-- settle for anything of this language -->
                           <LOOP LIST="lServerPrefs">
            						<SETVAR NAME="errno" VALUE="0"/>
            						<BEGINS STR="lServerPrefs.id" WHAT="Variables.currentBrowserLanguage_"/>
            						<IF COND="Variables.errno=1">
            						<THEN>
            							<SETSSVAR NAME="locale" VALUE="lServerPrefs.id"/>
            							<SETROW LIST="lBrowserPrefs" ACTION="LAST"/>
            							<SETROW LIST="lServerPrefs" ACTION="LAST"/>
                                 <SETVAR NAME="foundLocale" VALUE="true"/>
            						</THEN>
            						</IF>
            					</LOOP>
                        </ELSE>
                        </IF>
                     </THEN>
                     <ELSE>
                        <IF COND="lLanguageCountrySplit.ITEM!=Variables.currentBrowserLanguage">
                        <THEN>
                           <!-- settle for anything of this language -->
                           <LOOP LIST="lServerPrefs">
            						<SETVAR NAME="errno" VALUE="0"/>
            						<BEGINS STR="lServerPrefs.id" WHAT="Variables.currentBrowserLanguage_"/>
            						<IF COND="Variables.errno=1">
            						<THEN>
            							<SETSSVAR NAME="locale" VALUE="lServerPrefs.id"/>
            							<SETROW LIST="lBrowserPrefs" ACTION="LAST"/>
            							<SETROW LIST="lServerPrefs" ACTION="LAST"/>
                                 <SETVAR NAME="foundLocale" VALUE="true"/>
            						</THEN>
            						</IF>
            					</LOOP>
                        </THEN>
                        </IF>
                     </ELSE>
                     </IF>

                     <IF COND="Variables.foundLocale!=true">
                     <THEN>
                        <SETROW LIST="lBrowserPrefs" ACTION="PREV"/>
                     </THEN>
                     </IF>
                  </THEN>
                  <ELSE>
                     <!-- settle for anything of this language -->
                     <LOOP LIST="lServerPrefs">
                        <SETVAR NAME="errno" VALUE="0"/>
                        <BEGINS STR="lServerPrefs.id" WHAT="Variables.currentBrowserLanguage_"/>
                        <IF COND="Variables.errno=1">
                        <THEN>
                           <SETSSVAR NAME="locale" VALUE="lServerPrefs.id"/>
                           <SETROW LIST="lBrowserPrefs" ACTION="LAST"/>
                           <SETROW LIST="lServerPrefs" ACTION="LAST"/>
                        </THEN>
                        </IF>
                     </LOOP>
                  </ELSE>
                  </IF>
               </ELSE>
					</IF>
				</THEN>
				<ELSE>
					<!-- browser has only language and no country pref.
						Find first country match with the same language in server prefs -->
					<LOOP LIST="lServerPrefs">
						<SETVAR NAME="errno" VALUE="0"/>
						<BEGINS STR="lServerPrefs.id" WHAT="lLanguageQualitySplit.ITEM_"/>
						<IF COND="Variables.errno=1">
						<THEN>
							<SETSSVAR NAME="locale" VALUE="lServerPrefs.id"/>
							<SETROW LIST="lBrowserPrefs" ACTION="LAST"/>
							<SETROW LIST="lServerPrefs" ACTION="LAST"/>
						</THEN>
						</IF>
					</LOOP>
				</ELSE>
				</IF>
			</LOOP>
		</THEN>
		</IF>
	</THEN>
	<ELSE>
		<!-- for some reason we couldn't query the LocaleMap table.
			fall back to old hardcode of en_US.  -->
		<SETSSVAR NAME="locale" VALUE="en_US"/>
	</ELSE>
	</IF>
</FTCS> 
