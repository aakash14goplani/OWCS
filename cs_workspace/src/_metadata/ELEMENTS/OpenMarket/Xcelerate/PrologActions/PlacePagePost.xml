<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/PrologActions/PlacePagePost.xml $
$Revision: 28 $
$Modtime: 9/01/04 4:52p $
-->
<!-- OpenMarket/Xcelerate/PrologActions/PlacePagePost
--
-- INPUT
--	parentnodeid - has node id of parent node in SitePlanTree
-- AssetType 	- set to 'Page' 
-- Input as dictated by GenRankedItems (Rank-id,assettype)
--							and GenRemoveItems (Remove-id,assettype
-- OUTPUT
--		- nodes are moved as requested
-->

<IF COND="Variables.upcommand!=cancel">
<THEN>
	<PROPERTY.GET PARAM="xcelerate.treeType" INIFILE="futuretense_xcel.ini" VARNAME="proptreetype"/>
	<SETVAR NAME="pageReranked" VALUE="false"/>
	<SETVAR NAME="pagePlaceChanged" VALUE="false"/>
	<SETVAR NAME="changeMade" VALUE="false"/>

	<SITEPLAN.LOAD NAME="parentNode" NODEID="Variables.parentnodeid"/>

<!-- Get a list of ids and ranks that were posted -->

	<setvar NAME="OrderSize" VALUE="0"/>
	<CALLJAVA CLASS="com.openmarket.xcelerate.util.XclUtil">
		<ARGUMENT NAME="ftcmd" VALUE="GenRankedItems"/>
		<ARGUMENT NAME="nofill" VALUE="true"/>
	</CALLJAVA>

	<!-- Loop through the list of items -->
	<SETCOUNTER NAME="numfailed" VALUE="0"/>
	<IF COND="Variables.OrderSize!=0">
	<THEN>
		<SETCOUNTER NAME="currcount" VALUE="0"/>
		<LOOP FROM="0" COUNT="Variables.OrderSize">
			<!-- skip any that are to be removed -->
			<SETVAR NAME="varname" VALUE="Remove-Variables.IdCounters.currcount"/>
			<if COND="IsVariable.Variables.varname=false">
			<then>
				<!-- Set the parent and rank here for the children -->
				<SETVAR NAME="varname" VALUE="OldRank-Variables.IdCounters.currcount"/>
				<SETVAR NAME="oldrank" VALUE="Variables.Variables.varname"/>
            <SETVAR NAME="newrank" VALUE="Variables.RankCounters.currcount"/>
				<SETVAR NAME="errno" VALUE="0"/>
				<BEGINS STR="Variables.oldrank" WHAT="Variables."/>
				<IF COND="Variables.errno=1">
				<THEN>
					<SETVAR NAME="errno" VALUE="0"/>
					<SETVAR NAME="__REFRESHUNPLACED__" VALUE="Self:UnplacedPages"/>
				</THEN>
				</IF>
				<if COND="Variables.newrank!=Variables.oldrank">
				<then>
					<!-- Check function privileges for anything being changed -->
					<ASSET.LOAD NAME="pageToPlace" TYPE="Variables.AssetType" OBJECTID="Variables.IdCounters.currcount" EDITABLE="true"/>
					<if COND="IsError.Variables.errno=true">
					<then>
						<INCCOUNTER NAME="numfailed" VALUE="1"/>
						<setvar NAME="failurereason" VALUE="InvalidContentId"/>
					</then>
					<else>
						<callelement NAME="OpenMarket/Xcelerate/Actions/Workflow/CheckPrivs">
						    <argument NAME="AssetType" VALUE="Variables.AssetType"/>
						    <argument NAME="assetObjectName" VALUE="pageToPlace"/>
						    <argument NAME="Function" VALUE="placepage"/>
						</callelement>
						<if COND="Variables.PrivsFailed=true">
						<then>
							<INCCOUNTER NAME="numfailed" VALUE="1"/>
							<setvar NAME="failurereason" VALUE="Variables.PrivsFailedReason"/>
						</then>
						<else>
							<ASSET.GETSITENODE NAME="pageToPlace" OUTPUT="nid"/>
							<ASSET.GET NAME="pageToPlace" FIELD="id" OUTPUT="pagetoplaceid"/>
							<!-- need to update an Unplaced page so that approval dependents get marked -->
							<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
					  		  <argument NAME="AssetType" VALUE="Variables.AssetType"/>
							</callelement>
							<setvar NAME="doproceed" VALUE="true"/>
							<if COND="Variables.trackingenabled=true">
							<then>
								<if COND="IsVariable.alreadylocked=true">
								<then>
									<setvar NAME="savealreadylocked" VALUE="Variables.alreadylocked"/>
									<removevar NAME="alreadylocked"/>
								</then>
								</if>
			        			<history TABLE="Variables.AssetType" ASSET="Variables.pagetoplaceid" LIST="ItsHistory"/>
				     			<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/LockIfNeeded">
						            <argument NAME="AssetType" VALUE="Variables.AssetType"/>
						            <argument NAME="id" VALUE="Variables.pagetoplaceid"/>
					         	</callelement>
								<if COND="IsVariable.alreadylocked=true">
								<then>
									<setvar NAME="pagealreadylocked" VALUE="Variables.alreadylocked"/>
									<removevar NAME="alreadylocked"/>
								</then>
								</if>
								<if COND="IsVariable.savealreadylocked=true">
								<then>
									<setvar NAME="alreadylocked" VALUE="Variables.savealreadylocked"/>
								</then>
								</if> 
					      	</then>
					      	</if>
					      	<if COND="Variables.doproceed=true">
			      			<then>
								<SITEPLAN.PLACE NAME="parentNode" NODEID="Variables.nid" RANK="Variables.RankCounters.currcount" />
								<ASSET.SAVE NAME="pageToPlace"/>
								<!-- check the unplaced page back in if we implicitly checked it out -->
								<if COND="Variables.checkoutmethod=implicit">
								<then>
										<XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/VersionbyPlacePage" VARNAME="_xlat_version"/>
										<ASSET.CHECKIN NAME="pageToPlace" ANNOTATION="Variables._xlat_version" CHECKOUT="false"/>
										<removevar NAME="checkoutmethod"/>
								</then>
								</if>
								<SETVAR NAME="changeMade" VALUE="true"/>
								<if COND="IsVariable.Variables.varname=true">
								<then>
									<SETVAR NAME="pageReranked" VALUE="true"/>
								</then>
								<else>
									<SETVAR NAME="pagePlaceChanged" VALUE="true"/>
								</else>
								</if>
							</then>
							<else>
								<INCCOUNTER NAME="numfailed" VALUE="1"/>
								<setvar NAME="failurereason" VALUE="Variables.doProceed"/>
							</else>
							</if>
					   </else>
						</if>
					</else>
					</if>
				</then>
				</if>
			</then>
			</if>
			<INCCOUNTER NAME="currcount" VALUE="1"/>
		</LOOP>
	</THEN>
	</IF>
<!-- Get a list of ids to remove -->

	<setvar NAME="OrderSize" VALUE="0"/>
	<CALLJAVA CLASS="com.openmarket.xcelerate.util.XclUtil">
		<ARGUMENT NAME="ftcmd" VALUE="GenRemoveItems"/>
	</CALLJAVA>

	<IF COND="Variables.OrderSize!=0">
	<THEN>
		<!-- Loop through the list of items -->
		<SETCOUNTER NAME="currcount" VALUE="0"/>
		<LOOP FROM="0" COUNT="Variables.OrderSize">
			<!-- Check function privleges for anything being changed -->
			<ASSET.LOAD NAME="pageToRemove" TYPE="Variables.AssetType" OBJECTID="Variables.IdCounters.currcount" EDITABLE="true"/>
			<if COND="IsError.Variables.errno=true">
			<then>
				<setvar NAME="somefailed" VALUE="true"/>
				<setvar NAME="failurereason" VALUE="InvalidContentId"/>
			</then>
			<else>
				<callelement NAME="OpenMarket/Xcelerate/Actions/Workflow/CheckPrivs">
				    <argument NAME="AssetType" VALUE="Variables.AssetType"/>
				    <argument NAME="assetObjectName" VALUE="pageToRemove"/>
				    <argument NAME="Function" VALUE="placepage"/>
				</callelement>
				<if COND="Variables.PrivsFailed=true">
				<then>
					<INCCOUNTER NAME="numfailed" VALUE="1"/>
					<setvar NAME="failurereason" VALUE="Variables.PrivsFailedReason"/>
				</then>
				<else>
					<!-- Set the parent and rank here for the children -->
					<ASSET.GETSITENODE NAME="pageToRemove" OUTPUT="nid"/>
					<ASSET.GET NAME="pageToRemove" FIELD="id" OUTPUT="pagetoremoveid"/>
					<!-- need to update an Unplaced page so that approval dependents get marked -->
					<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
					    <argument NAME="AssetType" VALUE="Variables.AssetType"/>
					</callelement>
					<setvar NAME="doproceed" VALUE="true"/>
					<if COND="Variables.trackingenabled=true">
					<then>
						<if COND="IsVariable.alreadylocked=true">
						<then>
							<setvar NAME="savealreadylocked" VALUE="Variables.alreadylocked"/>
							<removevar NAME="alreadylocked"/>
						</then>
						</if>
	        			<history TABLE="Variables.AssetType" ASSET="Variables.pagetoremoveid" LIST="ItsHistory"/>
		     			<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/LockIfNeeded">
			            <argument NAME="AssetType" VALUE="Variables.AssetType"/>
			            <argument NAME="id" VALUE="Variables.pagetoremoveid"/>
			         </callelement>
						<if COND="IsVariable.alreadylocked=true">
						<then>
							<setvar NAME="unplacepagealreadylocked" VALUE="Variables.alreadylocked"/>
							<removevar NAME="alreadylocked"/>
						</then>
						</if>
						<if COND="IsVariable.savealreadylocked=true">
						<then>
							<setvar NAME="alreadylocked" VALUE="Variables.savealreadylocked"/>
						</then>
						</if> 
			      </then>
			      </if>
			      
			      <if COND="Variables.doproceed=true">
			      <then>
						<ASSET.SAVE NAME="pageToRemove"/>
						<SITEPLAN.UNPLACE NAME="parentNode" NODEID="Variables.nid" />
						<!-- check the unplaced page back in if we implicitly checked it out -->
						<if COND="Variables.checkoutmethod=implicit">
						<then>
								<XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/VersionbyPlacePage" VARNAME="_xlat_version"/>
								<ASSET.CHECKIN NAME="pageToRemove" ANNOTATION="Variables._xlat_version" CHECKOUT="false"/>
								<removevar NAME="checkoutmethod"/>
						</then>
						</if>
						
						<SETVAR NAME="__REFRESHUNPLACED__" VALUE="Self:UnplacedPages"/>
						<SETVAR NAME="pagePlaceChanged" VALUE="true"/>
						<SETVAR NAME="changeMade" VALUE="true"/>
					</then>
					<else>
						<INCCOUNTER NAME="numfailed" VALUE="1"/>
						<setvar NAME="failurereason" VALUE="Variables.doProceed"/>
					</else>
					</if>
				</else>
				</if>
			</else>
			</if>
			<INCCOUNTER NAME="currcount" VALUE="1"/>
		</LOOP>
	</THEN>
	</IF>
	
<!-- call the treeupdate preplace function -->

	<if COND="Variables.changeMade=true">
	<then>
		<!-- save the asssociated asset, in order to update updateddate, updatdeby and
		     inform the publishing Approval system -->
		<SITEPLAN.GET NAME="parentNode" FIELD="otype"/>
		<SITEPLAN.GET NAME="parentNode" FIELD="oid"/>
		<if COND="Variables.otype!=Publication">
		<then>
			<ASSET.LOAD NAME="parentPage" TYPE="Variables.otype" OBJECTID="Variables.oid" EDITABLE="true"/>
			<!-- check the function privs on the parent page -->
			<callelement NAME="OpenMarket/Xcelerate/Actions/Workflow/CheckPrivs">
			    <argument NAME="AssetType" VALUE="Variables.otype"/>
			    <argument NAME="assetObjectName" VALUE="parentPage"/>
			    <argument NAME="Function" VALUE="placepage"/>
			</callelement>
			<if COND="Variables.PrivsFailed=true">
			<then>
				<INCCOUNTER NAME="numfailed" VALUE="1"/>
				<SETVAR NAME="failurereason" VALUE="Variables.PrivsFailedReason"/>
			</then>
			<else>
				<ASSET.SAVE NAME="parentPage"/>
			</else>
			</if>
		</then>
		</if>
	<!-- decide whether to commit and create a new version.
			 If the item was already locked, then no commit is
			 needed. Else commit and ensure that it does not stay
			 locked -->
		<if COND="IsVariable.alreadylocked=true">
			<then>
				<if COND="Variables.alreadylocked!=true">
					<then>
						<XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/VersionbyPlacePage" VARNAME="_xlat_version"/>
						<ASSET.CHECKIN NAME="parentPage" ANNOTATION="Variables._xlat_version" CHECKOUT="false"/>
					</then>
				</if>
			</then>
		</if>
	
		<!-- Remove entry from CheckOutInfo table about implicit checkout. Assume only one entry in the table -->
		
		<if COND="Variables.otype!=Publication">
		<then>
			<IMPLICITCHECKOUT.CLEARCHECKOUT ASSETTYPE="Variables.otype"
				ASSETID="Variables.oid"/>
		</then>
		</if>
		
   <!-- Save the parent node and update the children -->
		<SITEPLAN.SAVE NAME="parentNode"/>
		
		<IF COND="Variables.changeMade=true">
		<THEN>
			<IF COND="IsVariable.__REFRESHUNPLACED__=true">
			<THEN>
				<SETVAR NAME="__REFRESHUNPLACED__" VALUE="Variables.__REFRESHUNPLACED__;Self:Variables.parentnodeid"/>
			</THEN>
			</IF>
		</THEN>
		</IF>
		<if  COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
			<then>
				<SITEPLAN.ROOT LIST="PubRoot" OBJECTID="SessionVariables.pubid" />
				<SETVAR NAME="refreshKeysFinal" VALUE="Variables.__REFRESHUNPLACED__"/>
				
				<!-- to refresh the placed pages -->
				<SITEPLAN.GET NAME="parentNode" FIELD="nparentid" OUTPUT="_nparentid"/>
	  			<if COND="Variables._nparentid=PubRoot.nid">
				<then>
					<SETVAR NAME="refreshKeysFinal" VALUE="Self:PlacedPages;Variables.__REFRESHUNPLACED__"/>
				</then>
				</if>
				
	  			<if COND="Variables.parentnodeid=PubRoot.nid">
				<then>
					<SETVAR NAME="refreshKeysFinal" VALUE="Self:PlacedPages;Variables.__REFRESHUNPLACED__"/>
				</then>
				</if>
				<callelement NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype">
					<argument NAME="__TreeRefreshKeys__" VALUE="Variables.refreshKeysFinal"/>
				</callelement>
			</then>
		</if>
	</then>
	</if>
</THEN>
<ELSE>
	<!-- If this is a cancel operation, release the implicit checkout (if any) -->	
	<if COND="IsVariable.alreadylocked=true">
		<then>	
			<if COND="Variables.alreadylocked!=true">
				<then>		
					<SITEPLAN.LOAD NAME="parentNode" NODEID="Variables.parentnodeid"/>
					<SITEPLAN.GET NAME="parentNode" FIELD="oid"/>
					<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.oid" NAME="Release-Asset"/>
					<ASSET.UNDOCHECKOUT NAME="Release-Asset"/>

					<!-- Remove entry from CheckOutInfo table about implicit checkout. Assume only one entry in the table -->
					
					<IMPLICITCHECKOUT.CLEARCHECKOUT ASSETTYPE="Variables.otype" ASSETID="Variables.oid"/>
				</then>
			</if>
		</then>
	</if>
</ELSE>
</IF>

</FTCS> 
