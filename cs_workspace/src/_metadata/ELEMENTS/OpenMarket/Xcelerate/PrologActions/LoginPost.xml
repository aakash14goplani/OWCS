<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/PrologActions/LoginPost.xml $ 
$Revision: 40 $ 
$Modtime: 8/16/04 4:08p $ 
-->

<!--
- Confidential and Proprietary Information of Open Market, Inc.
-					All Rights Reserved.
-
- DESCRIPTION
-	
-->

<IF COND="IsSessionVariable.PublicationName!=true">
<THEN>
	<setssvar NAME="PublicationName" VALUE="Not Selected"/>
	<setssvar NAME="pubid" VALUE="notSet"/>
        
<!-- Check for a valid login -->

	<SETVAR NAME="errno" VALUE="0"/>
	<USERISMEMBER GROUP="xceleditor"/>
	<IF COND="Variables.errno=0">
		<THEN>
        <!-- login unsuccessful -->
	<USERMANAGER.LOGOUT/>
        <!-- setssvar NAME="username" VALUE="LoginFailed"/ -->
    </THEN>
    <ELSE>
        <!-- username policy may require that the username
             be turned into upper case! -->
			<PROPERTY.GET PARAM="xcelerate.forceusernamecase" INIFILE="futuretense_xcel.ini" VARNAME="propforceusernamecase"/>
        <if COND="Variables.propforceusernamecase!=Variables.empty">
        <then>
            <!-- value is either ToUpper to ToLower -->
            <if COND="Variables.propforceusernamecase=ToUpper">
            <then>
                <toupper STR="SessionVariables.username" OUTSTR="forcedname"/>
            </then>
            <else>
                <tolower STR="SessionVariables.username" OUTSTR="forcedname"/>
            </else>
            </if>
            <USERMANAGER.LOGINUSER USERNAMEVARIABLE="forcedname" PASSWORDVARIABLE="password" VARNAME="IsLoggedIn"/>
        </then>
        </if>
	</ELSE>
	</IF>
</THEN>
</IF>
<SETVAR NAME="errno" VALUE="0"/>
<USERISMEMBER GROUP="xceleditor"/>
<IF COND="Variables.errno=1">
<THEN>
        <!-- login successful. check to see if
             we have one or more publications
             associated with this user -->

			<setvar NAME="errno" VALUE="0"/>
			<USERMANAGER.GETLOGINUSERNAME VARNAME="username"/>
			<setvar NAME="numrows" VALUE="0"/>
			<PROPERTY.GET PARAM="xcelelem.manageuserpub" INIFILE="futuretense_xcel.ini" VARNAME="propmanageuserpub"/>
			<USERMANAGER.GETLOGINUSER VARNAME="loginuser"/>

			<CALLELEMENT NAME="OpenMarket/Xcelerate/Util/SetLocale">
				<ARGUMENT NAME="loginuser" VALUE="Variables.loginuser"/>
			</CALLELEMENT>
        <callelement NAME="Variables.propmanageuserpub">
            <argument NAME="upcommand" VALUE="GetPublications"/>
            <argument NAME="qryprefix" VALUE="UP"/>
            <argument NAME="username" VALUE="Variables.loginuser"/>
            <argument NAME="isLogin" VALUE="true"/>
        </callelement>
        <!-- if anything was returned, process it -->
        <setvar NAME="NumPublications" VALUE="none"/>
        <if COND="Variables.numrows!=0">
            <then>
                <!-- we either have one row returned
                     or many. At this point, we cannot
                     have numRows = 0 -->
                <if COND="Variables.numrows=1">
                    <then>
                        <setvar NAME="NumPublications" VALUE="one"/>
                        <setssvar NAME="pubid" VALUE="UP.pubid"/>
                        <callelement NAME="OpenMarket/Xcelerate/Actions/Security/SetPublicationName"/>
                    </then>
                    <else>
                        <setvar NAME="NumPublications" VALUE="many"/>
                    </else>
                </if>
            </then>
				<else>
						<!-- if no row is returned, we check if user has GeneralAdmin role
							for SITE="0" (in UserPublication table).
							If yes, we let it login.
						-->
						<USERMANAGER.GETUSER USER="Variables.username" OBJVARNAME="u"/>
						<CCUSER.GETSITEROLES NAME="u" SITE="0" OBJVARNAME="srl"/>
						<CCUSER.GETDISPLAYABLENAME NAME="u"  VARNAME="uname"/>
						<ROLELIST.GETALL NAME="srl" VARNAME="roles"/>
						<ROLELIST.HASROLE NAME="srl" ROLE="GeneralAdmin" VARNAME="hasit"/>
						<if COND="Variables.hasit=true">
						<then>
							<setvar NAME="NumPublications" VALUE="one"/>
							<setssvar NAME="pubid" VALUE="0"/>
							<SETSSVAR NAME="PublicationName" VALUE="Management Site"/>
							<setssvar NAME="currentpubACLs" VALUE="Variables.roles"/>
							<SETVAR NAME="userIsAdvancedUser" VALUE="true" />
							<SETSSVAR NAME="PublicationDesc" VALUE="Management Site"/>
							<!-- if any blob data is being served in this environment
							  needs a csblobid session variable to be set -->
							<if COND="IsSessionVariable.csblobid!=true">
							<then>
								 <setssvar NAME="csblobid" VALUE="CS.UniqueID"/>
							</then>
							</if>
						</then>
						</if>

				</else>

        </if>
</THEN>
<ELSE>
    <CALLELEMENT NAME="OpenMarket/Xcelerate/Util/SetLocale"/>
</ELSE>
</IF>
</FTCS>
