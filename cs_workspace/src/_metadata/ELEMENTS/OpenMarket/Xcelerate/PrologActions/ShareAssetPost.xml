<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateC/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/PrologActions/ShareAssetPost.xml $
$Revision: 10 $ 
$Modtime: 11/05/03 12:37p $ 
-->
<!-- OpenMarket/Xcelerate/PrologActions/ShareAssetFront
- Confidential and Proprietary Information of Open Market Inc.
-					All Rights Reserved.
<!-- OpenMarket/Xcelerate/PrologActions/ShareAssetPost
--
-- INPUT
--		Variables.pubidlist - semi-colon separated list of pubid's to save asset into
--		Variables.AssetType	- asset type of asset to be shared
--		Variables.id			- di of asset to be shared
-- OUTPUT
--		Asset is saved or errno is set
-->

<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="theCurrentAsset" EDITABLE="true"/>
<if COND="Variables.upcommand!=cancel">
<then>
	<!-- check whether we can perform this function on this asset (access right may have changed since the front page was displayed) -->
    <CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Workflow/CheckPrivs">
        <ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
        <ARGUMENT NAME="assetObjectName" VALUE="theCurrentAsset"/>
        <ARGUMENT NAME="Function" VALUE="share"/>
    </CALLELEMENT>
	<IF COND="Variables.PrivsFailed=true">
	<THEN>
		<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
			<ARGUMENT NAME="error" VALUE="Variables.PrivsFailedReason"/>
		</CALLELEMENT>
		<SETVAR NAME="hasError" VALUE="true"/>
		<SETVAR NAME="errorAlreadyDisplayed" VALUE="true"/>
	</THEN>
	<ELSE>
		<!-- Make sure that current pub is part of the list, unless we are sharing to 'Any' -->
		<if COND="Variables.pubidlist!=0">
		<then>
			<if COND="IsVariable.pubidlist=true">
			<then>
				<SETVAR NAME="pubidlist" VALUE="Variables.pubidlist;SessionVariables.pubid"/>
			</then>
			<else>
				<SETVAR NAME="pubidlist" VALUE="SessionVariables.pubid"/>
			</else>
			</if>
		</then>
		</if>
		
		<ASSET.SHARE NAME="theCurrentAsset" PUBLIST="Variables.pubidlist"/>
		<ASSET.SAVE NAME="theCurrentAsset"/>
		<!-- decide whether to commit and create a new version.
				 If the item was already locked, then no commit is
				 needed. Else commit and ensure that it does not stay
				 locked -->
		<if COND="IsVariable.alreadylocked=true">
		<then>
			<if COND="Variables.alreadylocked!=true">
				<then>
					<XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/VersionbyShare" VARNAME="_xlat_version"/>
					<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Commit-Asset"/>
					<ASSET.CHECKIN NAME="Commit-Asset" ANNOTATION="Variables._xlat_version" CHECKOUT="false"/>
				</then>
			</if>
		</then>
		</if>
	</ELSE>
	</IF>
</then>
<else>
	<!-- user cancelled -->
	<!-- If this is a cancel operation, release the implicit checkout (if any) -->	
	<if COND="IsVariable.alreadylocked=true">
	<then>	
		<if COND="Variables.alreadylocked!=true">
		<then>		
			<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Release-Asset"/>
			<ASSET.UNDOCHECKOUT NAME="Release-Asset"/>
		</then>
		</if>
	</then>
	</if>
</else>
</if>

<!-- Remove entry from CheckOutInfo table about implicit checkout. Assume only one entry in the table -->
<IMPLICITCHECKOUT.CLEARCHECKOUT ASSETTYPE="Variables.AssetType" ASSETID="Variables.id"/>

<ASSETTYPE.LOAD TYPE="Variables.AssetType" NAME="currAT"/>
<ASSETTYPE.GET NAME="currAT" FIELD="description" OUTPUT="at:description"/>
</FTCS> 
