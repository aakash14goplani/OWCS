<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/PrologActions/ShareAssetFront.xml $
$Revision: 20 $ 
$Modtime: 6/28/04 1:10p $ 
-->
<!-- OpenMarket/Xcelerate/PrologActions/ShareAssetFront
- Confidential and Proprietary Information of Open Market Inc.
-					All Rights Reserved.
-
-- INPUT
--		Variables.username	- logged on user
--		SessionVariables.pubid - pubid of logged in user - user cannot remove it from the logged in site
-- 	Variables.AssetType	- AssetType	
-- OUTPUT
--		possiblePubList 	- list with valid pubs the user can share this asset into
-->

<PROPERTY.GET PARAM="xcelelem.manageuserpub" INIFILE="futuretense_xcel.ini" VARNAME="propmanageuserpub"/>
<USERMANAGER.GETLOGINUSER VARNAME="userid"/>
<callelement NAME="Variables.propmanageuserpub">
    <argument NAME="upcommand" VALUE="GetPublications"/>
    <argument NAME="username" VALUE="Variables.userid"/>
    <argument NAME="qryprefix" VALUE="PublicationResults"/>
</callelement>

<callelement NAME="Variables.propmanageuserpub">
    <argument NAME="upcommand" VALUE="GetPubsEnabledforAsset"/>
    <argument NAME="assetid" VALUE="Variables.id"/>
    <argument NAME="qryprefix" VALUE="PubsEnabledforAsset"/>
</callelement>
 
 
<if COND="IsList.PublicationResults=true">
<then>
	
	<SETVAR NAME="otherpubs" VALUE="Variables.empty"/>
	<LOOP LIST="PublicationResults">
		<SETVAR NAME="errno" VALUE="0"/>
		<!-- exclude the logged on pub - don't want user to make it disappear on themselves -->
		<if COND="PublicationResults.pubid!=SessionVariables.pubid">
		<then>
			<!-- check to see if the AssetType is authorized for the pub -->
			<callelement NAME="OpenMarket/Xcelerate/Actions/AssetMgt/EnableAssetTypePub">
				<argument NAME="upcommand" VALUE="IsAssetTypeEnabled"/>
				<argument NAME="assettype" VALUE="Variables.AssetType"/>
				<argument NAME="pubid" VALUE="PublicationResults.pubid"/>
			</callelement>
			<if COND="Variables.IsAuthorized=true">
			<then>
				<if COND="Variables.otherpubs=Variables.empty">
				<then>
					<SETVAR NAME="otherpubs" VALUE="PublicationResults.pubid"/>
				</then>
				<else>
					<SETVAR NAME="otherpubs" VALUE="Variables.otherpubs,PublicationResults.pubid"/>
				</else>
				</if>
			</then>
			</if>
		</then>
		</if>
	</LOOP>
	<if COND="Variables.otherpubs!=Variables.empty">
	<then>
		<STRINGLIST NAME="possiblePubList" STR="Variables.otherpubs" DELIM=","/>
		<setvar NAME="doproceed" VALUE="true"/>
		
		<!-- see if we are allowed to share to 'Any' -->
		<setvar NAME="allowAnyPub" VALUE="false"/>
		<PROPERTY.GET PARAM="xcelerate.asset.shareToAllAllowed" INIFILE="futuretense_xcel.ini" VARNAME="allowAnyPub"/>
		<!-- specifically disallow for Page (can't have shared SItePlanTree nodes) -->
		<setvar NAME="disallowAny" VALUE="Page"/>
		<ISINLIST STR="Variables.disallowAny" ITEM="Variables.AssetType"/>
		<if COND="Variables.errno=1">
		<then>
			<setvar NAME="allowAnyPub" VALUE="false"/>
		</then>
		</if>
		
	</then>
	<else>
		<SETVAR NAME="doproceed" VALUE="NoPubsToShareTo"/>
	</else>
	</if>
</then>
</if>

<!-- load the asset -->
<if COND="Variables.doproceed=true">
<then>
	<setvar NAME="assetObjectName" VALUE="theCurrentAsset"/>
	<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Variables.assetObjectName"/>
	<if COND="IsError.Variables.errno=true">
	<then>        
	  <setvar NAME="doproceed" VALUE="InvalidContentId"/>
	</then>
	</if>
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="id" OUTPUT="id"/>
	<ASSET.SCATTER NAME="Variables.assetObjectName" PREFIX="asset" FIELDLIST="LocalFields"/>
</then>
</if>
	
<!-- can we edit it now -->
<if COND="Variables.doproceed=true">
<then>
<!-- check whether we can perform this function on this asset -->
	<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/AccessCheck">
		<ARGUMENT NAME="assetObjectName" VALUE="theCurrentAsset"/>
		<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
		<ARGUMENT NAME="pubid" VALUE="SessionVariables.pubid"/>
		<ARGUMENT NAME="id" VALUE="Variables.id"/>
		<ARGUMENT NAME="Function" VALUE="share"/>
	</CALLELEMENT>
	<IF COND="Variables.error!=Variables.empty">
	<THEN>
    	<!-- -12069 means allow edit but display warning, any other error means prohibit edit -->
    	<if COND="Variables.errno=-12069">
    	<then>
			<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
				<argument NAME="elem" VALUE="EditNotAllowed"/>
				<argument NAME="severity" VALUE="info"/>
				<argument NAME="assettype" VALUE="Variables.AssetType"/>
				<argument NAME="id" VALUE="Variables.id"/>
			</callelement>
		</then>
		<else>
	     <setvar NAME="doproceed" VALUE="Variables.error"/>
	   </else>
	   </if>
	 </THEN>
	</IF>
</then>
</if>

<!-- if revtracking is on, check out the asset -->
<if COND="Variables.doproceed=true">
<then>
	<!-- check to see if the table is tracked
     if so, then the current record must
     be locked by the current user -->
	<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
	    <argument NAME="AssetType" VALUE="Variables.AssetType"/>
	</callelement>
	<if COND="Variables.trackingenabled=true">
	<then>
     	<history TABLE="Variables.AssetType" ASSET="Variables.id" LIST="ItsHistory"/>
  		<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/LockIfNeeded">
            <argument NAME="AssetType" VALUE="Variables.AssetType"/>
            <argument NAME="id" VALUE="Variables.id"/>
        </callelement>
        <INPUT TYPE="HIDDEN" NAME="alreadylocked" VALUE="Variables.alreadylocked" REPLACEALL="Variables.alreadylocked"/>
		
		<!-- Add entry in CheckOutInfo for an implicit check out -->
		<if COND="Variables.checkoutmethod=implicit">
		<then>
			<usermanager.getloginuser VARNAME="userID"/>
			<implicitcheckout.logimplicitcheckout ASSETTYPE="Variables.AssetType"
				ASSETID="Variables.id"
				USER="Variables.userID"
				FUNCTION="Share Assets"/>
				<if COND="IsError.Variables.errno=false">
				<then>
					<!-- put out informational message: -->
					<!-- Variables.atdescription has been checked out for Variables.function. -->
					<ASSETTYPE.LOAD NAME="at" TYPE="Variables.AssetType"/>
					<ASSETTYPE.GET NAME="at" FIELD="description" OUTPUT="atdescription"/>
					<XLAT.LOOKUP KEY="dvin/Common/Share" VARNAME="function"/>
					<XLAT.LOOKUP KEY="dvin/UI/AssetImplicitlyCheckout" VARNAME="msgtext"/>
					<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
						<ARGUMENT NAME="severity" VALUE="info"/>
					</CALLELEMENT>
				</then>
				</if>	
		</then>
		</if>
    </then>
	</if>
</then>
</if>
	
</FTCS> 
