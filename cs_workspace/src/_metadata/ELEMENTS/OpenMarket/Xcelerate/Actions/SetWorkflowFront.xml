<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/SetWorkflowFront.xml $ 
$Revision: 93 $ 
$Modtime: 5/28/04 1:35p $ 
-->
<!-- OpenMarket/Xcelerate/Actions/SetWorkflowFront
-
- INPUT
-
- OUTPUT
-

COMMENTS:
		This element is basically responsible for painting the screen that shows up immediately after we say "select workflow proces"
		from the workflow status screen drop down. This page is called from OpenMarket/Xcelerate/Actions/AssetMgt/StatusDetails.xml (used as an input to satellite.link tag)
		
		The page displays the asset name, asset description, lists down the available workflow processes allowed for the selected asset type
		and an optional "Action to take" text area.
		
		This page calls itself"(or reposts itself) based on user actions and each time, some variables are passed to it. So let's look at it in some detail to get the hang of what is going on.
		
		AssetType and id (asset id) are available to this element at ALL times. Without these two, we pretty much CANNOT do anything.
		The element uses the AssetType and id to build a workflowasset object (using which much of the workflow processing is done).
		The variable "process" represents the workflow process id - an integer which uniquely identifies the workflow process (use CSE to see the contents of "Workflow" table).
		Now, when we initially select an asset and decide to put it in workflow for the first time, it is obvious that NO workflow process will be associated with the asset as yet 
		(assuming we did not assign it when the asset was created).
		Hence, for an asset that is not(yet) in workflow, this element has "IsVariable.process" return false.
		
		For an asset that is already in workflow, we will have the value of "process" set to the workflow process id as mentioned above. And in such a case, the element has
		another variable "chosenprocessid" set to the same value.
		
		The element uses the XML tag "WorkflowEngine.GetAllProcesses" to retrieve all the workflow processes associated with the AssetType in the publication/site. The output of this tag
		is a prefix and this prefix is used along with a counter to display all the workflowprocesses in a drop down. Now retrieving the list of workflow process names is not ALL that happens at this point
		using the prefix given by the tag. A bunch of other stuff happens alongside the process-name-retrieval. 
		The workflow process id is also displayed along with the name. If what is displayed is the workflow process name, what is used for further processing is the workflow process id.
		Then the element checks if the user can actually start the given workflow process (does he have enough roles ?) in the given publication/site.
		It also gets the initial step id.
		
		We then determine if the user is workflow admin i.e. he has the roles defined as Admin roles in the workflow process definition. If the user is workflowadmin, then and ONLY then we allow him to 
		set a deadline for the assignment here.
		
		When a user selects a workflow process from the drop down list, <SELECT NAME="process" SIZE="1" ONCHANGE="return chooseNewParticipants();">
		causes the chooseNewParticipants() fucntion to be invoked, which essentially reposts the page (and also sets the variable named "action" to "select")
		When the page is reposted the variable "process" (also the name of the HTML input component) will contain the selected workflow process id.
		
		When a process id is available we use the tag WORKFLOWPROCESS.CHECKPROCESSREQUIRESPARTICIPANTS to check if the workflow process definition specifies that ATLEAST ONE STEP is defined to be
		of the type "Assign from list of participants" or the "full" step type. (refer to the admin/user guide for the five methods of assigning users to an asset in a workflow process). 
		If so we display a hyper link that takes us to the xml element "OpenMarket/Xcelerate/Actions/SelectWorkflowParticipants.xml", within which the action variable is set to the value "setparticipants".
		When we set participants in this manner, we are essentially filtering out the list of users that the asset can be assigned to, for the step that is defined to be of type "Assign from list of participants".
		Note that this opportunity to filter out the assignees for a particular step (of type "full") is only given to the user at the start of the workflow process. 
		
		The SelectWorkflowParticipants.xml basically shows a list of roles and a set of users for each role who can be assigned to this asset. Clicking on "Set Particiants" in that page
		brings us back to SetWorkflowFront.xml with the "action" variable set to "setparticipants". This causes the page to display the selected users in the given roles. It is easy to verify and understand this step.
		Just select an asset, put it in a workflow process (of type "full" or "Assign from a list of participants" type) and select the assignees, the returning page will show you the list of users and assignees.
		
		The same logic can also be applied to understand what happens when we click on "Cancel" in the SelectWorkflowParticipants.xml.
		
		The variable "procdeadlinetype" obtained from the tag "WorkflowProcess.GetDeadlineType" for each of the workflow process, indicates the type of deadline for that process.
		If the deadline type is "ask" then we give the users an option to select the default deadline or to set a specific date and time as deadline. This part of the code should be straight forward. Also refer to 
		"OpenMarket/Xcelerate/Actions/SetDeadlineFront.xml" for related deadline handling.
		
		The remainder of the logic should be easy to follow (I believe) if we keep in mind that these elements use <INPUT TYPE="hidde" NAME="..." > to store values of the variables.
		
		So let the Work keep flowing :)
		
		-Sathish Paul Leo

		If Assignment Deadline is set to "Use default", CS will calculate deadline by adding the estimated time of start state to the current time.
		If Assignment Deadline is set to "Due", CS will do the same calculation and display the calculated time in the input field.
		Since we are localizing the date in the input field, repost of element was used to accomplish this. The repost is called from setDeadline() function.
		Process Deadline does not depend on estimated time of start state so the input field will be blank until specified.

		- Cory L.
-->

<STRING.ENCODE VARIABLE="id" VARNAME="id"/>
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType" />
<STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
<STRING.ENCODE VARIABLE="action" VARNAME="action"/>
<STRING.ENCODE VARIABLE="pdeadline" VARNAME="pdeadline"/>
<STRING.ENCODE VARIABLE="process" VARNAME="process"/>
<STRING.ENCODE VARIABLE="sdeadline" VARNAME="sdeadline"/>
<STRING.ENCODE VARIABLE="pdFieldForRepostN" VARNAME="pdFieldForRepostN"/>
<STRING.ENCODE VARIABLE="ssdFieldForRepostN" VARNAME="ssdFieldForRepostN"/>
<CALLELEMENT NAME="OpenMarket/Xcelerate/Scripts/FormatDate" />
<callelement NAME="OpenMarket/Xcelerate/Util/ClientoffsetInMillis"/>
<SCRIPT LANGUAGE="JavaScript">
var clientOffset = <CSVAR NAME="Variables.clientOffset" />
<![CDATA[
function SelectWorkflow() 
{ 
    var obj = document.forms[0].elements[0];
    var now = new Date();
	var cur_date = new Date(now.getTime() + clientOffset + now.getTimezoneOffset()*60*1000 );
    if (obj.form.process.options.selectedIndex=="-1" || obj.form.process.options.selectedIndex=="0")
    {
        ]]>
        alert("<XLAT.STREAM KEY="dvin/UI/Error/mustspecifyworkflowprocessasset" ESCAPE="true" ENCODE="false"/>");
        <![CDATA[
        obj.form.process.focus();
        return false;                  
    }
    
    if(obj.form.elements['dosetpdeadline'].value=="true")
    {
    
    if (obj.form.elements['donotsetProcessDeadline'][1].checked) 
    {
        var deadline_date = document.getElementById('deadlineFieldDiv').innerHTML;
        if (deadline_date == "")
        {
            ]]>
            alert("<XLAT.STREAM KEY="dvin/UI/Error/processdeadlineenterednotvaliddate" ESCAPE="true" ENCODE="false"/>");
            <![CDATA[
            return false;
        }

        pdeadlineVal = dateToObject(deadline_date).valueOf();
        if (pdeadlineVal < cur_date.valueOf())
        {
           ]]>
           alert("<XLAT.STREAM KEY="dvin/UI/Error/processdeadlineearliercurrenttime" ESCAPE="true" ENCODE="false"/>");
           <![CDATA[
           return false;
 
        }
        obj.form.elements['pdeadline'].value = pdeadlineVal;
    }
    }
   

    if(obj.form.elements['dosetsdeadline'].value=="true")
    {
    if (obj.form.elements['useDefaultDeadline'][1].checked) 
    {
        var deadline_date = document.getElementById('ssdeadlineFieldDiv').innerHTML;
        if (deadline_date == "")
        {
            ]]>
            alert("<XLAT.STREAM KEY="dvin/UI/Error/assignmentdeadlineenterednotvaliddate" ESCAPE="true" ENCODE="false"/>");
            <![CDATA[
            return false;
        }
        
        sdeadlineVal = dateToObject(deadline_date).valueOf();
        if (sdeadlineVal < cur_date.valueOf())
        {
           ]]>
           alert("<XLAT.STREAM KEY="dvin/UI/Error/assignmentdeadlineearliercurrenttime" ESCAPE="true" ENCODE="false"/>");
           <![CDATA[
           return false;
 
        }
        obj.form.elements['sdeadline'].value = sdeadlineVal;
    }
    }
    return true;
}

function SetParticipants() 
{ 
    var obj = document.forms[0].elements[0];
    if (obj.form.process.options.selectedIndex=="-1" || obj.form.process.options.selectedIndex=="0")
    {
        ]]>
        alert("<XLAT.STREAM KEY="dvin/UI/Error/mustspecifyworkflowprocessasset" ESCAPE="true" ENCODE="false"/>");
        <![CDATA[
        obj.form.process.focus();
        return false;
    }

    //if deadline is specified, put it in an inputfield to retain the value before selecting participants.
    if(obj.form.elements['dosetpdeadline'].value=="true")
    {
        if (obj.form.elements['donotsetProcessDeadline'][1].checked)
        {
            document.getElementById('pdeadlineFieldForRepost').value = document.getElementById('deadlineFieldDiv').innerHTML;
        }
    }
    if(obj.form.elements['dosetsdeadline'].value=="true")
    {
        if (obj.form.elements['useDefaultDeadline'][1].checked)
        {
            document.getElementById('ssdeadlineFieldForRepost').value = document.getElementById('ssdeadlineFieldDiv').innerHTML;
        }
    }

    obj.form.elements['pagename'].value = "OpenMarket/Xcelerate/Actions/SelectWorkflowParticipants";
    return true;
}

function chooseNewParticipants()
{
    var obj = document.forms[0].elements[0];
    if (obj.form.process.options.selectedIndex=="0") {
    	obj.form.chosenprocessid.value = "";
    	obj.form.action.value="select";
    	}
    if (obj.form.elements['action'].value=="select")
    {
	obj.form.elements['pagename'].value = "OpenMarket/Xcelerate/Actions/SetWorkflowFront";
	obj.form.submit();
        return false;
    }

    if (SetParticipants())
    {
        obj.form.submit();
    }
    return true;
}



function setDefaultDeadline()
{
    var obj = document.getElementById('ssdeadline_div');
    obj.style.visibility="hidden";
}
    
function setDeadline()
{
    var obj = document.forms[0].elements[0];
    var index = obj.form.elements['process'].selectedIndex;
    if (index == -1 || index == 0) {
        return;
    }
        
    var chosenWorkflow = "Process" + index;

    var rel_deadlineVal = parseInt(obj.form.elements[chosenWorkflow].value);
    if (!isNaN(rel_deadlineVal) && rel_deadlineVal > 0) {
       var cur_time = new Date();
       var sdeadlineVal = cur_time.valueOf() + rel_deadlineVal.valueOf();
       var sdeadline = new Date(sdeadlineVal);

       var jdbcdate = dateToJDBCString(sdeadline);
       document.getElementById('ssdeadlineFieldForRepost').value = jdbcdate;

       //if process deadline is specified, put it in an inputfield to retain the value before reposting for assignmeent deadline.
       //tecnically, these deadline should never be used together. 
        if(obj.form.elements['dosetpdeadline'].value=="true")
        {
            if (obj.form.elements['donotsetProcessDeadline'][1].checked)
            {
                document.getElementById('pdeadlineFieldForRepost').value = document.getElementById('deadlineFieldDiv').innerHTML;
            }
        }

       //repost to get localized date.
       obj.form.elements['pagename'].value = "OpenMarket/Xcelerate/Actions/SetWorkflowFront";
	   obj.form.submit();
    }
    else
    {
        var objd = document.getElementById('ssdeadline_div');
        objd.style.visibility="visible";
    }
}


function setProcessDeadline()
{
    var obj = document.getElementById('pdeadline_div');
    obj.style.visibility='visible';

}

function donotsetPDeadline()
{
    var obj = document.getElementById('pdeadline_div');
    obj.style.visibility='hidden';
    return true;
}

]]>
</SCRIPT>

<setvar NAME="AbortFlag" VALUE="false"/>

<ASSETTYPE.LOAD NAME="currAT" TYPE="Variables.AssetType"/>
<ASSETTYPE.GET NAME="currAT" FIELD="description"/>
<SETVAR NAME="asstdesc"  VALUE="Variables.description"/>

<WorkflowAsset.Load ASSETTYPE="Variables.AssetType" ID="Variables.id" OBJVARNAME="workflowasset" />
<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="theAsset"/>

<setvar NAME="AssetType" VALUE="Variables.AssetType"/>
<setvar NAME="id" VALUE="Variables.id"/>

<setvar NAME="requiresParticipants" VALUE="false"/>
<if COND="IsVariable.process=true">
<then>
	<setvar NAME="chosenprocessid" VALUE="Variables.process"/>
	<WORKFLOWENGINE.GETPROCESSID OBJVARNAME="chosenwf" ID="Variables.chosenprocessid"/>
	<WORKFLOWPROCESS.CHECKPROCESSREQUIRESPARTICIPANTS NAME="chosenwf" VARNAME="requiresParticipants"/>
</then>
</if>

<!-- check if the asset is void -->
<ASSET.GET NAME="theAsset" FIELD="status" OUTPUT="status"/>
<if COND="Variables.status=VO">
<then>
    <SETVAR NAME="AbortFlag" VALUE="true"/>
    <SETVAR NAME="ErrorName" VALUE="CantStartWorkflowVoided"/>
    <SETVAR NAME="severity" VALUE="info"/>
</then>
</if>    

<if COND="Variables.AbortFlag!=true">
<then>
    <ASSET.GET NAME="theAsset" FIELD="name" OUTPUT="assetname"/>
    <ASSET.GET NAME="theAsset" FIELD="description" OUTPUT="assetdesc" />   
    
    <!-- if the asset is already assigned to a user or a group, abort -->
    <WorkflowEngine.IsObjectAssigned OBJECT="workflowasset" VARNAME="isAssigned"/>
    <if COND="Variables.isAssigned=true">
    <then>
        <SETVAR NAME="AbortFlag" VALUE="true"/>
      <SETVAR NAME="ErrorName" VALUE="WorkflowActive"/>
      <SETVAR NAME="severity" VALUE="info"/>
    </then>
    </if>
</then>
</if>

<!-- Check that there is at least one workflow available
  -- get the list of available workflow definitions -->
<if COND="Variables.AbortFlag!=true">
<then>
     <WorkflowEngine.GetAllProcesses ASSETTYPE="Variables.AssetType" PUBID="SessionVariables.pubid" PREFIX="wfe:" />
     <if COND="Variables.workflowsTotal=0">
     <then>
    	  <SETVAR NAME="AbortFlag" VALUE="true"/>
    	  <SETVAR NAME="ErrorName" VALUE="NoWorkflowDefined"/>
    	  <SETVAR NAME="severity" VALUE="info"/>
     </then>
     </if>
</then>
</if>

<if COND="Variables.AbortFlag!=true">
<then>
<table class="width-outer-70" cellspacing="0" cellpadding="0" border="0">
	<tr><td>
		<span class="title-text"><XLAT.STREAM KEY="dvin/UI/SelectWorkflowforAssetTypedesc"/>: <STRING.STREAM VALUE="Variables.assetname"/></span>
	</td></tr>
	<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/TitleBar"/>
</table>
<if COND="IsVariable.useDefaultDeadline!=true">
<then>
    <setvar NAME="useDefaultDeadline" VALUE="true" />
</then>
</if>
<if COND="IsVariable.donotsetProcessDeadline!=true">
<then>
    <setvar NAME="donotsetProcessDeadline" VALUE="true" />
</then>
</if>
<if COND="IsVariable.action!=true">
<then>
    <setvar NAME="action" VALUE="select" />
</then>
</if>
<!-- Table header -->

<table class="width-outer-50" BORDER="0" CELLSPACING="0" CELLPADDING="0">

        <tr>
            <td class="form-label-text" VALIGN="TOP">
                <STRING.STREAM VALUE="Variables.asstdesc"/>&nbsp;<XLAT.STREAM KEY="dvin/AT/Common/Name"/>:
            </td>
            <td class="form-inset" VALIGN="TOP">
               	<STRING.STREAM VALUE="Variables.assetname" />
            </td>
        </tr>
        <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
		<tr>
            <td class="form-label-text" VALIGN="TOP">
                <XLAT.STREAM KEY="dvin/AT/Common/Description"/>:
            </td>
            <td class="form-inset">
				<STRING.STREAM VALUE="Variables.assetdesc" />
            </td>
        </tr>
		    <!-- chosenprocessid is the id of the process chosen. This variable is set while reposting the page -->
		    <if COND="IsVariable.chosenprocessid!=true">
		    <then>
			<setvar NAME="chosenprocessid" VALUE="Variables.empty"/>
		    </then>
		    </if>
		    <INPUT TYPE="hidden" NAME="chosenprocessid" VALUE="Variables.chosenprocessid" REPLACEALL="Variables.chosenprocessid"/>
        <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
		<tr>
            <td class="form-label-text" VALIGN="TOP">
                <span class="alert-color">*</span><XLAT.STREAM KEY="dvin/Common/WorkflowProcess"/>:
            </td>
            <td class="form-inset" VALIGN="top" >
                <SELECT NAME="process" SIZE="1" ONCHANGE="return chooseNewParticipants();">
                    <OPTION VALUE=""/>--<XLAT.STREAM KEY="dvin/Common/SelectWorkflowProcess"/>--
                    
                    <setcounter NAME="NPROCESSES" VALUE="0"/>
                    <if COND="IsVariable.wfe:Total=true">
                    <then>
                        <if COND="Variables.wfe:Total!=0">
                        <then>
                        		<!-- Code added by Sathish Paul Leo for Alloy UI -->
                        		<LISTOBJECT.CREATE NAME="myWorkflowProcessList" COLUMNS="processName,processID,stepType" />
                        
                            <loop FROM="0" COUNT="Variables.wfe:Total">
                                <WorkflowProcess.getprocessname NAME="wfe:Counters.NPROCESSES" VARNAME="processname"/>
                                <WorkflowProcess.getid NAME="wfe:Counters.NPROCESSES" VARNAME="processid"/>
                                <WorkflowEngine.CanStartWorkflow ID="Variables.processid" SITE="SessionVariables.pubid" VARNAME="canStartWorkflow" />
				                				<WorkflowProcess.getinitialstepid NAME="wfe:Counters.NPROCESSES" VARNAME="startstep"/>
				                				<WorkflowProcess.getstep NAME="wfe:Counters.NPROCESSES" VALUE="Variables.startstep" OBJVARNAME="strtstpobj"/>
											<!-- For Alloy UI -->
												<WORKFLOWSTEP.GETSTEPTYPE NAME="strtstpobj" VARNAME="steptype" />
											<!-- For Alloy UI -->
                                <if COND="Variables.canStartWorkflow=true">
                                <then>
                                        <if COND="Variables.chosenprocessid=Variables.processid">
                                        <then>
                                            <OPTION VALUE="Variables.processid" SELECTED="yes" REPLACEALL="Variables.processid"/><STRING.STREAM VALUE="Variables.processname"/>
                                            <!-- get deadlinetype for the process selected -->
                                            <WorkflowProcess.GetDeadlineType NAME="wfe:Counters.NPROCESSES" VARNAME="procdeadlinetype"/>
                                            <!-- get deadlinetype for the start step of the process selected -->
                                            <WorkflowStep.GetDeadlineType NAME="strtstpobj" VARNAME="stpdlinetype"/>
                                            
                                            <!-- determine if user is workflowadmin for the process selected -->
                                            <setvar NAME="userisworkflowadmin" VALUE="false"/>
                                            <WorkflowProcess.GetAdminRoles NAME="wfe:Counters.NPROCESSES" OBJVARNAME="adminrolesobj"/>
                                            <ROLELIST.ISALL NAME="adminrolesobj" VARNAME="roleisall"/>
                                            <!-- roleisall=true means Any role -->
                                            
                                            <if COND="Variables.roleisall=true">
                                            <then>
                                                <setvar NAME="userisworkflowadmin" VALUE="true"/>
                                            </then>
                                            <else>
                                                <ROLELIST.GETALL NAME="adminrolesobj" VARNAME="admnroles"/>
                                                <if COND="Variables.admnroles!=Variables.empty">
                                                <then>
                                                    <STRINGLIST NAME="rlist" STR="Variables.admnroles" DELIM=","/>
                                                    <loop LIST="rlist">
                                                        <setvar NAME="errno" VALUE="0"/>
                                                        <isinlist STR="SessionVariables.currentpubACLs" ITEM="rlist.ITEM"/>
                                                        <if COND="Variables.errno=1">
                                                        <then>
                                                            <setvar NAME="userisworkflowadmin" VALUE="true"/>
                                                        </then>
                                                        </if>
                                                    </loop>
                                                </then>
                                                </if>
                                            </else>
                                            </if> <!-- userisadmin-->
                                        </then>
                                        <else>
                                            <OPTION VALUE="Variables.processid" REPLACEALL="Variables.processid"/><STRING.STREAM VALUE="Variables.processname"/>
                                        </else>
                                        </if>
																				<LISTOBJECT.ADDROW NAME="myWorkflowProcessList" processName="Variables.processname" processID="Variables.processid" stepType="Variables.steptype" />

                                    <WorkflowProcess.GetInitialStepID NAME="wfe:Counters.NPROCESSES" VARNAME="inistepid"/>
                                    <WorkflowProcess.GetStep NAME="wfe:Counters.NPROCESSES" VALUE="Variables.inistepid" OBJVARNAME="stepobj"/>
                                    <WorkflowStep.GetEndState NAME="stepobj" VARNAME="targetstate" />
                                    <if COND="IsVariable.targetstate=true">
                                    <then>
                                         <removevar NAME="endstate_deadline" />
                                         <WorkflowEngine.GetStateID ID="Variables.targetstate" OBJVARNAME="targetobj" />
                                         <WorkflowState.GetEstimatedStateTime NAME="targetobj" VARNAME="endstate_deadline" />
                                    </then>
                                    </if>
                                    <if COND="IsVariable.endstate_deadline!=true">
                                    <then>
                                         <setvar NAME="endstate_deadline" VALUE="0" />
                                    </then>
                                    </if>
                                </then>
                                <else>
                                     <setvar NAME="endstate_deadline" VALUE="0" />
                                </else>
                                </if>
                                
                                <if COND="Counters.NPROCESSES=0">
                                <then>
                                     <setvar NAME="deadlinestr" VALUE="Variables.endstate_deadline" />
                                </then>
                                <else>
                                     <setvar NAME="deadlinestr" VALUE="Variables.deadlinestr Variables.endstate_deadline" />
                                </else>
                                </if>
                                <inccounter NAME="NPROCESSES" VALUE="1"/>
                            </loop>
                            <LISTOBJECT.TOLIST NAME="myWorkflowProcessList" LISTVARNAME="workflowProcessList"/>
                        </then>
                        </if>
                    </then>
                    </if>       

                </SELECT>

                <STRINGLIST STR="Variables.deadlinestr" NAME="deadlinelist" DELIM="%20" />
                <setcounter NAME="deadlinecount" VALUE="1"/>
                <loop LIST="deadlinelist">
                    <setvar NAME="endstate_deadline" VALUE="deadlinelist.ITEM" />
                    <INPUT TYPE="hidden" NAME="ProcessCounters.deadlinecount" VALUE="Variables.endstate_deadline" REPLACEALL="Counters.deadlinecount,Variables.endstate_deadline" />
                    <inccounter NAME="deadlinecount" VALUE="1"/>
                </loop>
                
                <IF COND="Variables.requiresParticipants=true">
                <THEN>
	                <XLAT.LOOKUP KEY="dvin/UI/SetParticipantsforthisworkflowprocess" VARNAME="_XLAT_"/>
	                <XLAT.LOOKUP KEY="dvin/UI/SetParticipantsforthisworkflowprocess" VARNAME="mouseover" ESCAPE="true"/>
	                <A class="inline-right" HREF="javascript:void(0);" onClick="if(SetParticipants()!=false){document.forms['AppForm'].submit(); return false;}" onmouseover="window.status='Variables.mouseover';return true;" onmouseout="window.status='';return true;" REPLACEALL="Variables.mouseover"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/SetParticipants_"/></CALLELEMENT></A>
					</THEN>
					</IF>
            </td>
        </tr>

        <if COND="Variables.action!=select">
        <then>
            <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
			<tr>
                <td class="form-label-text" VALIGN="TOP">
                    <XLAT.STREAM KEY="dvin/Common/Participants"/>:
                </td>
                <td class="form-inset" VALIGN="top" >
                        <table BORDER="0" CELLSPACING="0" CELLPADDING="0">
                        <tr>
                            <td></td><td class="tile-dark" HEIGHT="1"><IMG WIDTH="1" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td><td></td>
                        </tr>
                        <tr>
                            <td class="tile-dark" VALIGN="top" WIDTH="1" NOWRAP="nowrap"><BR /></td>
                            <td >
                            <table width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="#ffffff"><tr><td colspan="6" class="tile-highlight"><IMG WIDTH="1" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td></tr>
                            <tr><td class="tile-a" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;</td>
                                <td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;</td><td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir"><DIV class="new-table-title"><XLAT.STREAM KEY="dvin/Common/Role"/></DIV></td>
                                <td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir"><DIV class="new-table-title"><XLAT.STREAM KEY="dvin/Common/Users"/></DIV></td>
                                <td class="tile-c" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;</td>
                            </tr>
                            <tr><td colspan="6" class="tile-dark"><IMG WIDTH="1" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td></tr>
                                <setvar NAME="rowStyle" VALUE="tile-row-normal"/>
                                <SETVAR NAME="separatorLine" VALUE="0"/>
                                <stringlist NAME="roleslist" STR="Variables.allRoles" DELIM="," />
                                <loop LIST="roleslist">
                                    <IF COND="Variables.separatorLine=1">
                                    <THEN>
                                    </THEN>
                                    </IF>
                                    <SETVAR NAME="separatorLine" VALUE="1"/>
                                    <tr class="Variables.rowStyle"  REPLACEALL="Variables.rowStyle"><td><BR /></td>
                                    <td><BR /></td><td VALIGN="TOP" NOWRAP="NOWRAP" ALIGN="LEFT">
                                        <DIV class="small-text-inset">
                                        <STRING.STREAM VALUE="roleslist.ITEM:"/>
                                        </DIV>
                                    </td>
                                    <td><BR /></td><td VALIGN="TOP" ALIGN="LEFT">
                                        <DIV class="small-text-inset">
                                            <setvar NAME="userNames" VALUE="Variables.empty"/>
                                            
                                            <if COND="Variables.action=setparticipants">
                                            <then>
                                                <ics.getvar name="roleslist.ITEM" encoding="default" OUTPUT="users" />
                                            </then>
                                            <else>
                                                <!-- action is cancelsetparticipants -->
                                                <ics.getvar name="cancel_roleslist.ITEM" encoding="default" OUTPUT="users" />
                                            </else>
                                            </if>
                                                                                       
                                            <if COND="Variables.users!=Variables.empty" >
                                            <then>
                                                <STRINGLIST STR="Variables.users" NAME="userList" DELIM=";"/>
                                                <loop LIST="userList">
                                                    <USERMANAGER.GETDISPLAYABLEUSERNAME USER="userList.ITEM" VARNAME="user_name"/>
                                                    <IF COND="Variables.userNames=Variables.empty">
                                                    <THEN>
                                                        <SETVAR NAME="userNames" VALUE="Variables.user_name"/>
                                                    </THEN>
                                                    <ELSE>
                                                        <SETVAR NAME="userNames" VALUE="Variables.userNames, Variables.user_name"/>
                                                    </ELSE>
                                                    </IF>
                                                </loop>
                                            </then>
                                            </if>
                                                
                                            <STRING.STREAM VALUE="Variables.userNames"/>
                                        </DIV>
                                    </td>
                                    <td><BR /></td>
                                    </tr>
                                    <IF COND="Variables.rowStyle=tile-row-normal">
                                    <THEN><SETVAR NAME="rowStyle" VALUE="tile-row-highlight"/>
                                    </THEN>
                                    <ELSE><SETVAR NAME="rowStyle" VALUE="tile-row-normal"/>
                                    </ELSE>
                                    </IF>
                                    
                                    <setvar NAME="cur_role" VALUE="roleslist.ITEM" />                   
                                    <INPUT TYPE="hidden" NAME="Variables.cur_role" VALUE="Variables.users" REPLACEALL="Variables.cur_role,Variables.users"/>
                                    </loop>
                            </table>
                            </td>
                            
                        </tr>
                        </table> 
						<STRING.ENCODE VARIABLE="allRoles" VARNAME="allRoles"/>
                        <INPUT TYPE="hidden" NAME="allRoles" VALUE="Variables.allRoles" REPLACEALL="Variables.allRoles"/>
                </td>
            </tr>
        </then>
        </if>

        <setvar NAME="dosetpdeadline" VALUE="false"/>
        <if COND="Variables.procdeadlinetype=ask">
        <then>    
            <!-- we allow only workflow admin to set deadline (no privs possible as asset is not in workflow yet) -->
            <if COND="Variables.userisworkflowadmin=true">
            <then>
             <setvar NAME="dosetpdeadline" VALUE="true"/>
            <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
			<tr>
                <td class="form-label-text" VALIGN="TOP">
                	<XLAT.STREAM KEY="dvin/UI/Common/ProcessDeadline"/>:
                </td>
                <td class="form-inset" nowrap="nowrap">
                       <if COND="Variables.donotsetProcessDeadline=true">
                       <then> 
                            <INPUT style="margin-left:0px" TYPE="RADIO" NAME="donotsetProcessDeadline" VALUE="true" CHECKED="true" OnClick="donotsetPDeadline();"/><XLAT.STREAM KEY="dvin/Common/Donotset"/>
                            <br/>
                            <INPUT style="margin-left:0px" TYPE="RADIO" NAME="donotsetProcessDeadline" OnClick="setProcessDeadline()" /><XLAT.STREAM KEY="dvin/Common/Set"/>
                           <setvar NAME="pdeadline_vis" VALUE="hidden"/>
                       </then>
                       <else>
                            <INPUT style="margin-left:0px" TYPE="RADIO" NAME="donotsetProcessDeadline" VALUE="true" OnClick="donotsetPDeadline();"/><XLAT.STREAM KEY="dvin/Common/Donotset"/>
                            <br/>
                            <INPUT style="margin-left:0px" TYPE="RADIO" NAME="donotsetProcessDeadline" VALUE="false" CHECKED="true" OnClick="setProcessDeadline()"/><XLAT.STREAM KEY="dvin/Common/Set"/>
                           <setvar NAME="pdeadline_vis" VALUE="visible"/>
                       </else>
                       </if>     
        
                       <IMG WIDTH="4" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/>
                       <XLAT.LOOKUP KEY="fatwire/Alloy/UI/PickADate" VARNAME="pickADateString" />
                       <CALLELEMENT NAME="OpenMarket/Xcelerate/Util/GetLocalizedDate">
                            <ARGUMENT NAME="inputDate" VALUE="Variables.pdFieldForRepostN" />
                            <ARGUMENT NAME="outputVar" VALUE="localizedDeadlineValue" />
                       </CALLELEMENT>
                       <span ID="pdeadline_div" style="visibility:Variables.pdeadline_vis" REPLACEALL="Variables.pdeadline_vis">
						   <STRING.ENCODE VARIABLE="localizedDeadlineValue" VARNAME="localizedDeadlineValue"/>
                           <div id="deadlineFieldId" name="deadline" dojoType="fw.dijit.UIInput"  clearButton="true" readonly="true" VALUE="Variables.localizedDeadlineValue" REPLACEALL="Variables.localizedDeadlineValue"></div>
							<DIV ID="deadlineFieldDiv" STYLE="display:none"><ICS.GETVAR NAME="pdFieldForRepostN"/></DIV>
							<CALLELEMENT NAME="OpenMarket/Xcelerate/Scripts/DateTimeWidget">
								<ARGUMENT NAME="inputFieldId" value="deadlineFieldId"/>
								<ARGUMENT NAME="inputDivId" value="deadlineFieldDiv"/>
							</CALLELEMENT>
						</span>
						<STRING.ENCODE VARIABLE="pdFieldForRepostN" VARNAME="pdFieldForRepostN"/>
                         <INPUT TYPE="hidden" ID="pdeadlineFieldForRepost" NAME="pdFieldForRepostN" VALUE="Variables.pdFieldForRepostN" REPLACEALL="Variables.pdFieldForRepostN"/>
                </td>
            </tr>
            </then>
            </if>
        </then>
        </if>
        <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
		<tr>
            <td class="form-label-text" VALIGN="TOP"><XLAT.STREAM KEY="dvin/Common/ActionlctoTake"/>:</td>
            <td class="form-inset">
               <TEXTAREA NAME="comment" ROWS="8" COLS="60" WRAP="VIRTUAL">
               <if COND="IsVariable.comment=true">
               <then>
                   <STRING.STREAM VALUE="Variables.comment" />
               </then>
               </if>
               </TEXTAREA>
            </td>
        </tr>
        <setvar NAME="dosetsdeadline" VALUE="false"/>
        <if COND="Variables.stpdlinetype=ask">
        <then> 
            <setvar NAME="dosetsdeadline" VALUE="true"/>
            <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
			<tr>
                <td class="form-label-text" VALIGN="TOP">
                   <span class="alert-color">*</span><XLAT.STREAM KEY="dvin/UI/Common/AssignmentDeadline"/>:
                </td>
                <td class="form-inset" nowrap="nowrap">
                       <if COND="Variables.useDefaultDeadline=true">
                       <then> 
                            <INPUT style="margin-left:0px" TYPE="RADIO" NAME="useDefaultDeadline" VALUE="true" CHECKED="true" OnClick="setDefaultDeadline()" /><XLAT.STREAM KEY="dvin/Common/Usedefault"/> 
                            <br/>
                            <INPUT style="margin-left:0px" TYPE="RADIO" NAME="useDefaultDeadline" VALUE="false" OnClick="setDeadline()"/>
                            <setvar NAME="sdeadline_vis" VALUE="hidden"/>
                       </then>
                       <else>
                            <INPUT style="margin-left:0px" TYPE="RADIO" NAME="useDefaultDeadline" VALUE="true" OnClick="setDefaultDeadline()" /><XLAT.STREAM KEY="dvin/Common/Usedefault"/>
                            <br/>
                            <INPUT style="margin-left:0px" TYPE="RADIO" NAME="useDefaultDeadline" VALUE="false" CHECKED="true" OnClick="setDeadline()" />
                            <setvar Name="sdeadline_vis" VALUE="visible"/>
                       </else>
                       </if>   
                       <XLAT.STREAM KEY="dvin/Common/Due"/>
                       <IMG WIDTH="4" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/>
                        <XLAT.LOOKUP KEY="fatwire/Alloy/UI/PickADate" VARNAME="pickADateString" />
                        <CALLELEMENT NAME="OpenMarket/Xcelerate/Util/GetLocalizedDate">
                            <ARGUMENT NAME="inputDate" VALUE="Variables.ssdFieldForRepostN" />
                            <ARGUMENT NAME="outputVar" VALUE="localizedDeadlineValue" />
                        </CALLELEMENT>
                            <span ID="ssdeadline_div" style="visibility:Variables.sdeadline_vis" REPLACEALL="Variables.sdeadline_vis">
							   <STRING.ENCODE VARIABLE="localizedDeadlineValue" VARNAME="localizedDeadlineValue"/>
                               <div id="ssdeadlineFieldId" name="ssdeadline" dojoType="fw.dijit.UIInput"  clearButton="true" readonly="true" VALUE="Variables.localizedDeadlineValue" REPLACEALL="Variables.localizedDeadlineValue"></div>
								<DIV ID="ssdeadlineFieldDiv" STYLE="display:none"><ICS.GETVAR NAME="ssdFieldForRepostN"/></DIV>
								<CALLELEMENT NAME="OpenMarket/Xcelerate/Scripts/DateTimeWidget">
									<ARGUMENT NAME="inputFieldId" value="ssdeadlineFieldId"/>
									<ARGUMENT NAME="inputDivId" value="ssdeadlineFieldDiv"/>
								</CALLELEMENT>
							</span>
						<STRING.ENCODE VARIABLE="ssdFieldForRepostN" VARNAME="ssdFieldForRepostN"/>
                        <INPUT type="hidden" ID="ssdeadlineFieldForRepost" NAME="ssdFieldForRepostN" VALUE="Variables.ssdFieldForRepostN" REPLACEALL="Variables.ssdFieldForRepostN"/>
                </td>
            </tr>
        </then>
        </if>

		<setvar NAME="action" VALUE="Variables.action"/>
		<setvar NAME="id" VALUE="Variables.id"/>
		<setvar NAME="AssetType" VALUE="Variables.AssetType"/>

		<setvar NAME="pdeadline" VALUE="Variables.pdeadline"/>
		<setvar NAME="donosetprocessdeadline" VALUE="Variables.donotsetprocessdeadline"/>

		<setvar NAME="sdeadline" VALUE="Variables.sdeadline"/>
		<setvar NAME="useDefaultDeadline" VALUE="Variables.useDefaultDeadline"/>
		<STRING.ENCODE VARIABLE="PostPage" VARNAME="PostPage"/>
		<INPUT TYPE="hidden" name="pagename" value="OpenMarket/Xcelerate/Actions/Variables.PostPage" REPLACEALL="Variables.PostPage"/>
		<STRING.ENCODE VARIABLE="action" VARNAME="action"/>
		<INPUT TYPE="hidden" NAME="action" VALUE="Variables.action" REPLACEALL="Variables.action"/>
		<INPUT TYPE="hidden" NAME="id" VALUE="Variables.id" REPLACEALL="Variables.id"/>
		<INPUT TYPE="hidden" NAME="AssetType" VALUE="Variables.AssetType" REPLACEALL="Variables.AssetType"/>
		<if COND="IsVariable.dosetpdeadline!=true">
		<then>
			<setvar NAME="dosetpdeadline" VALUE="false"/>
		</then>
		</if>
		<if COND="IsVariable.dosetsdeadline!=true">
		<then>
			<setvar NAME="dosetsdeadline" VALUE="false"/>
		</then>
		</if>
		<STRING.ENCODE VARIABLE="dosetpdeadline" VARNAME="dosetpdeadline"/>
		<INPUT TYPE="hidden" NAME="dosetpdeadline" VALUE="Variables.dosetpdeadline" REPLACEALL="Variables.dosetpdeadline"/>
		<STRING.ENCODE VARIABLE="dosetsdeadline" VARNAME="dosetsdeadline"/>
		<INPUT TYPE="hidden" NAME="dosetsdeadline" VALUE="Variables.dosetsdeadline" REPLACEALL="Variables.dosetsdeadline"/>
		<if COND="IsVariable.sdeadline!=true">
		<then>
			<setvar NAME="sdeadline" VALUE="0"/>
		</then>
		</if>
		<if COND="IsVariable.pdeadline!=true">
		<then>
			<setvar NAME="pdeadline" VALUE="0"/>
		</then>
		</if>
		<STRING.ENCODE VARIABLE="sdeadline" VARNAME="sdeadline"/>
		<INPUT TYPE="hidden" NAME="sdeadline" VALUE="Variables.sdeadline" REPLACEALL="Variables.sdeadline"/>
		<STRING.ENCODE VARIABLE="pdeadline" VARNAME="pdeadline"/>
		<INPUT TYPE="hidden" NAME="pdeadline" VALUE="Variables.pdeadline" REPLACEALL="Variables.pdeadline"/>

		<XLAT.LOOKUP KEY="dvin/UI/Cancel" VARNAME="_XLAT_"/>
		<XLAT.LOOKUP KEY="dvin/UI/Cancel" VARNAME="mouseover" ESCAPE="true"/>
		<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/StatusDetailsFront" outstring="urlstatusdetfront">
			<satellite.argument name="cs_environment" value="Variables.cs_environment"/>
			<satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
			<satellite.argument name="AssetType" value="Variables.AssetType"/>
			<satellite.argument name="id" value="Variables.id"/>
	    </SATELLITE.LINK>
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
		<tr><td></td><td>
			<A HREF="Variables.urlstatusdetfront" onmouseover="window.status='Variables.mouseover';return true;" onmouseout="window.status='';return true;"  REPLACEALL="Variables.urlstatusdetfront,Variables.mouseover"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/Cancel"/></CALLELEMENT></A>

			<XLAT.LOOKUP KEY="dvin/UI/AssetMgt/SelectWorkflow" VARNAME="_XLAT_"/>
			<XLAT.LOOKUP KEY="dvin/UI/AssetMgt/SelectWorkflow" VARNAME="mouseover" ESCAPE="true"/>
			<A HREF="javascript:void(0);" OnClick="if(SelectWorkflow()!=false){document.forms['AppForm'].submit(); return false;}" onmouseover="window.status='Variables.mouseover';return true;" onmouseout="window.status='';return true;" REPLACEALL="Variables.mouseover"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/SelectWorkflow"/></CALLELEMENT></A>
		</td></tr>
		</table>
</then>
<else>
	<div class="width-outer-70">
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
       	<argument NAME="elem" VALUE="Variables.ErrorName"/>
       	<argument NAME="severity" VALUE="Variables.severity"/>
    </callelement>
	</div> 
    <callelement NAME="OpenMarket/Xcelerate/Actions/StatusDetailsFront">
    	<argument NAME="AssetType" VALUE="Variables.AssetType"/>
    	<argument NAME="id"        VALUE="Variables.id"/>
    </callelement>
</else>
</if>
</FTCS>