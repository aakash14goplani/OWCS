<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/PublishConsoleFront.xml $ 
$Revision: 39 $ 
$Modtime: 9/15/04 3:01p $ 
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- OpenMarket/Xcelerate/Actions/PublishConsoleFront.xml
-
- DESCRIPTION
-	Publish console screen
-
- HISTORY 
-->
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType"/>
<STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
<!-- Continue only if conditions from prologactions are satisfied. -->
<if COND="Variables.doproceed=true">
<then>
<if cond="IsVariable.rows=false">
  <then>
    <SETVAR NAME="rows" VALUE="10"/>
 </then>
</if>
<if cond="IsVariable.displayPage=false">
  <then>
    <SETVAR NAME="displayPage" VALUE="1"/>
 </then>
</if>
<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/PublishConsoleFront_Running" outstring="urlPublishConsoleRun">
	<satellite.argument name="cs_environment" value="Variables.cs_environment"/>
	<satellite.argument name="cs_imagedir" value="Variables.cs_imagedir"/>
	<satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
</SATELLITE.LINK>
<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/PublishConsoleFront_Scheduled" outstring="urlPublishConsoleSch">
	<satellite.argument name="cs_environment" value="Variables.cs_environment"/>
	<satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
	<satellite.argument name="cs_imagedir" value="Variables.cs_imagedir"/>
</SATELLITE.LINK>
<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/PublishConsoleFront_History" outstring="urlPublishConsoleHis">
	<satellite.argument name="cs_environment" value="Variables.cs_environment"/>
	<satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
	<satellite.argument name="cs_imagedir" value="Variables.cs_imagedir"/>
</SATELLITE.LINK>
<STRING.ENCODE VARIABLE="activeCount" VARNAME="activeCount"/>
<STRING.ENCODE VARIABLE="direction" VARNAME="direction"/>
<STRING.ENCODE VARIABLE="rows" VARNAME="rows"/>
<STRING.ENCODE VARIABLE="displayPage" VARNAME="displayPage"/>
<replaceall list="CS.Property.ft.cgipath,Variables.activeCount,Variables.direction,Variables.cs_imagedir,Variables.rows,Variables.displayPage,Variables.urlPublishConsoleHis">
<script type="text/javascript" src="CS.Property.ft.cgipathjs/prototype.js"></script>
<script type="text/javascript" src="CS.Property.ft.cgipathjs/prototabs.js"></script>
<script type="text/javascript" src="CS.Property.ft.cgipathjs/URLDecoder.js"></script>
<script type="text/javascript">
<![CDATA[
//Initialize with default values
var fetchSize = "10";
var displayPage = "1";
var _chbSel = false;
var _freq = true;
var _hisHeaderClickedVal = "1";
var _hisHeaderClickedDir = "up";
var activeCount = "Variables.activeCount";
function updateTab(transport){
var respNode = document.createElement("div");
respNode.innerHTML = transport.responseText;
var hiddenElements=respNode.getElementsByTagName("div");
for (var i = 0; i < hiddenElements.length; i++) {
	var iD = hiddenElements[i].getAttribute("id"); 
    if ( iD == "pubsess:TotalRunning") {
		//If the activeCount is not available set it to 0
	    if(activeCount=="Variables.activeCount"){
			activeCount = "0";
		}
	    var run_value = hiddenElements[i].innerHTML;
		if(run_value){
		    var runningTab = document.getElementById("_runImgTab");
			if(parseInt(run_value) > 0){
			 runningTab.style.display = "inline";
			} 
			if(parseInt(run_value) <= 0) {
			 runningTab.style.display = "none";
			}
			var _runtabtextElement = document.getElementById("_rtasktabtext");
			_runtabtextElement.innerHTML=run_value;
			if(!_freq && (Number(run_value) != Number(activeCount))){
				updatePanel('_t3','ContentServer?pagename=OpenMarket/Xcelerate/Actions/PublishConsoleFront_History&cs_imagedir=Variables.cs_imagedir&rows=' + fetchSize + '&displayPage=' + displayPage);
				//When there is a change in status of the tabs then only clear the stored messages.
				$('consoleInfoMessage').update("&nbsp;").setStyle({ background: '#FFFFFF' });;
			}
			activeCount = run_value;
		}
		_freq=false;
    } else if ( iD == "pubsess:TotalScheduled") {
		var sch_value = hiddenElements[i].innerHTML;
		if(sch_value){
			var _schtabtextElement = document.getElementById("_stasktabtext");
			_schtabtextElement.innerHTML=sch_value;
		}
    } else if ( iD == "pubsess:TotalHistory") {
		var his_value = hiddenElements[i].innerHTML;
		if(his_value){
			var _histabtextElement = document.getElementById("_histabtext");
			_histabtextElement.innerHTML=his_value;
		}
		//Display the arrow in the header,Make the default sort arrow invisible
		var defaultArrowImages = $$('img.arrowDefault');
		for(var q=0;q < defaultArrowImages.length;q++){
			defaultArrowImages[q].style.display='none';
		}
		if(document.getElementById('his_arrow_'+ _hisHeaderClickedDir + '_' + _hisHeaderClickedVal))
			document.getElementById('his_arrow_'+ _hisHeaderClickedDir + '_' + _hisHeaderClickedVal).style.display='inline';
	} else if ( iD == "pubSessionConsoleHistory:displayPage") {
		displayPage = hiddenElements[i].innerHTML;
	}  else if ( iD == "pubSessionConsoleHistory:fetchSize") {
		fetchSize = hiddenElements[i].innerHTML;
	}
}
}

function deleteRows(elm)
{
  var ids_v = "";
  var _cbox=true;
  var _cbox_checked=false;
  for (var i=0; i < (document.getElementsByName("delPubSess")).length; i++)
   {
   if (document.getElementsByName("delPubSess")[i].checked)
      {
	  _cbox_checked=true;
	  if (_cbox){
	  ids_v =document.getElementsByName("delPubSess")[i].value;
	  _cbox=false;
	  } else {
		ids_v = ids_v + "%20" + document.getElementsByName("delPubSess")[i].value;
		}
      }
   }
   document.forms[0].pubSessIds.value=ids_v;
   if(!_cbox_checked){
		$('consoleInfoMessage').update("]]><XLAT.STREAM KEY="dvin/UI/Publish/NoPublishSessionsSelected" ESCAPE="true" ENCODE="false"/><![CDATA[").setStyle({ background: '#FFF1A8' });
	} else {
   _chbSel = true;
   elm.href += '&id=' + document.forms[0].pubSessIds.value;
   }
}

function changeRowColor(chbx) {
		tr = chbx.parentNode.parentNode;
		tr.className = (chbx.checked) ? "pubTile-row-onselect" : tr.getAttribute("class_o");
}
	
function changeCheckBoxes(FormIndex, FieldName, CheckValue){
		if(!document.forms[FormIndex])
			return;
		var objCheckBoxes = document.forms[FormIndex].elements[FieldName];
		if(!objCheckBoxes)
			return;
		var countCheckBoxes = objCheckBoxes.length;
		if(!countCheckBoxes)
			objCheckBoxes.checked = CheckValue;
		else
		// set the check value for all check boxes
		for(var i = 0; i < countCheckBoxes; i++){
			objCheckBoxes[i].checked = CheckValue;
			tr = objCheckBoxes[i].parentNode.parentNode;
			tr.className = (objCheckBoxes[i].checked) ? "pubTile-row-onselect" : tr.getAttribute("class_o");
		}
	}

function executeAction(action,url){
	if(action=='cancelSession' || action=='cancelDelayedSession'){
		if(!confirm("]]><XLAT.STREAM KEY="dvin/UI/Publish/CancelConfirm" ESCAPE="true" ENCODE="false"/><![CDATA[")){
			return false;
		}
	} else if(action=='resumeSession'){
		if(!confirm("]]><XLAT.STREAM KEY="dvin/UI/Publish/ResumeConfirm" ESCAPE="true" ENCODE="false"/><![CDATA[")){
			return false;
		}
	} else if(action=='restartSession'){
		if(!confirm("]]><XLAT.STREAM KEY="dvin/UI/Publish/RestartConfirm" ESCAPE="true" ENCODE="false"/><![CDATA[")){
			return false;
		}
	}
	new Ajax.Request(url, {
	method: 'get',
	onCreate: function(transport) {
		if(action=='cancelSession' || action=='cancelDelayedSession'){
				$('consoleInfoMessage').update("]]><XLAT.STREAM KEY="dvin/UI/Publish/CancellationRequestSent" ESCAPE="true" ENCODE="false"/><![CDATA[").setStyle({ background: '#FFF1A8' });
			} else {
				if(action=='resumeSession' || action=='restartSession'){
					if(action=='resumeSession'){
						$('consoleInfoMessage').update("]]><XLAT.STREAM KEY="dvin/UI/Publish/SessionResumeRequestSent" ESCAPE="true" ENCODE="false"/><![CDATA[").setStyle({ background: '#FFF1A8' });
					} else if(action=='restartSession'){
						$('consoleInfoMessage').update("]]><XLAT.STREAM KEY="dvin/UI/Publish/SessionRestartRequestSent" ESCAPE="true" ENCODE="false"/><![CDATA[").setStyle({ background: '#FFF1A8' });
					}
				}
			}
	},onSuccess: function(transport) {
		if(action=='resumeSession' || action=='restartSession'){
			var status = transport.responseText.evalJSON();
			if(action=='resumeSession'){
				if(!status.resumeStatus){
					$('consoleInfoMessage').update("]]><XLAT.STREAM KEY="dvin/UI/Publish/SessionResumeFailed" ESCAPE="true" ENCODE="false"/><![CDATA[").setStyle({ background: '#FFF1A8' });
				}
			} else if(action=='restartSession'){
				if(!status.restartStatus){
					$('consoleInfoMessage').update("]]><XLAT.STREAM KEY="dvin/UI/Publish/SessionRestartFailed" ESCAPE="true" ENCODE="false"/><![CDATA[").setStyle({ background: '#FFF1A8' });
				}
			}
		}
	}
});
}

function updatePanel(divId,url){
	new Ajax.Request(url,{
		method: 'get',
		onCreate:function(){showLoading(divId);},		
		onSuccess: function(transport){
		hideLoading(divId);
		$(divId).update(transport.responseText);
		updateTab(transport);
		dojo.parser.parse(dojo.byId(divId));}
	});
}

function hisHeaderClicked(id_num,rows,displayPage) {
	var orderBy="";
	if(id_num == 0){
		orderBy = "PubTarget.name";
	} else if(id_num == 1){
		orderBy = "PubSession.cs_sessiondate";
	} else if(id_num == 2){
		orderBy = "PubSession.cs_status";
	} else if(id_num == 3){
		orderBy = "PubSession.cs_sessionuser";
	}
	if(_hisHeaderClickedVal == id_num && _hisHeaderClickedDir == "down") {
		_hisHeaderClickedDir = "up";
		updatePanel('_t3','Variables.urlPublishConsoleHis&rows=' + rows + '&displayPage=' + displayPage + '&direction=DESC&orderBy=' + orderBy);
	}
	else {
		_hisHeaderClickedVal = id_num;
		_hisHeaderClickedDir = "down";
		updatePanel('_t3','Variables.urlPublishConsoleHis&rows=' + rows + '&displayPage=' + displayPage + '&direction=ASC&orderBy=' + orderBy);
	}
}
function showLoading(waitingDiv){
	$(waitingDiv).style.cursor ='wait';
    $('ajaxLoading').style.display='block';
}
function hideLoading(waitingDiv){
	$(waitingDiv).style.cursor ='default'
    $('ajaxLoading').style.display='none';
}
//shows the element with the given id directly below parent
function showhide(id) {
    var elem = document.getElementById(id);
    if (!elem)
        return false;
    if (elem.style['position'] != 'absolute') {
        //make element 'hover' separate from page flow
        elem.style['position'] = 'absolute';
    }
    if (elem.style['display'] == 'none')
        elem.style['display'] = '';
    else
        elem.style['display'] = 'none';
}
]]>
</script>
</replaceall>
<IF COND="IsVariable.startPublishing=true">
	<THEN>
	    <CALLELEMENT NAME="OpenMarket/Xcelerate/Admin/Publish/PublishingConsole">
			<argument NAME="publishConsoleFrontAction" VALUE="setDepMapInICS" />
		</CALLELEMENT>
		<STRING.ENCODE VARIABLE="target" VARNAME="target"/>
		<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/PublishApprovedAssets">
			<argument NAME="target" VALUE="Variables.target" />
			<argument NAME="publishedby" VALUE="SessionVariables.username" />
		</CALLELEMENT>
	</THEN>
</IF>
<STRING.ENCODE VARIABLE="PostPage" VARNAME="PostPage"/>
<INPUT TYPE="hidden" NAME="pagename" VALUE="OpenMarket/Xcelerate/Actions/Variables.PostPage" REPLACEALL="Variables.PostPage"/>
<div id="toolTip"></div>
<table class="width-outer-70" border="0" cellpadding="0" cellspacing="0">
<tr>
    <td class="title-text"><XLAT.STREAM KEY="dvin/UI/PublishConsole"/></td>
</tr>
<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/TitleBar"/>
</table>

<table class="width-outer-70" border="0" cellpadding="0" cellspacing="0">
<tr>
    <td>
        <setvar NAME="doproceed" VALUE="true" />
        <callelement NAME="OpenMarket/Xcelerate/Actions/Publish/PublishOptions">
            <argument NAME="dest" VALUE="none" />
        </callelement>
        
    	<if COND="Variables.doproceed=NoPublishDest">
    	<then>
              <XLAT.STREAM KEY="dvin/UI/Noexistingpublishdestsite"/>
    	</then>
    	</if>
    </td>
</tr>
<tr>
   <td><img height="15" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
</tr>

<if COND="Variables.doproceed=true">
<then>
    <tr>
       <td>
			<STRING.ENCODE VARIABLE="urlsitepost" VARNAME="urlsitepost"/>
       		<a HREF="javascript:void(0)" onclick="javascript:document.AppForm.submit();" REPLACEALL="Variables.urlsitepost" ><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/SelectDestination"/></CALLELEMENT></a>
        </td>
    </tr>
</then>
</if>

<tr>
   <td><img height="10" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
</tr>
</table>
<div class="width-outer-70" >
<span class="alertMsg" style="height:15px;vertical-align:middle;" id="consoleInfoMessage">&nbsp;</span>
<div class="tabs6 width">
	<div class="minwidth">
		<div class="container">
			<ul id="consoletabs">
				<li><a style="text-decoration:none;width:auto;" href="#_t1"><span><img id="_runImgTab" height="11" src="Variables.cs_imagedir/graphics/common/icon/loading.gif" class="runImg" REPLACEALL="Variables.cs_imagedir"/>&nbsp;&nbsp;&nbsp;<XLAT.STREAM KEY="dvin/UI/Active"/>&nbsp;(<div style="display:inline" id="_rtasktabtext">0</div>)&nbsp;&nbsp;&nbsp;</span></a></li>
				<li><a style="text-decoration:none;width:auto;" href="#_t2"><span>&nbsp;&nbsp;&nbsp;<XLAT.STREAM KEY="dvin/UI/Scheduled"/>&nbsp;(<div style="display:inline" id="_stasktabtext">0</div>)&nbsp;&nbsp;&nbsp;</span></a></li>
				<li><a style="text-decoration:none;width:auto;" href="#_t3" onclick="return dojo.parser.parse(dojo.byId('_t3'));"><span>&nbsp;&nbsp;&nbsp;<XLAT.STREAM KEY="dvin/UI/History"/>&nbsp;(<div style="display:inline" id="_histabtext">0</div>)&nbsp;&nbsp;&nbsp;</span></a></li>
			</ul>
		</div>
	</div>
</div>
<div id ="_main" style="display:none;">
	<div id="_t1" class="panel width-inner-100"></div>
	<div id="_t2" class="panel width-inner-100"></div>
	<div id="_t3" class="panel width-inner-100"></div>
</div>
</div>
<IF COND="IsVariable.defaultTab=false">
	<THEN>
		<SETVAR NAME="defaultTab" VALUE="_t1"/>
	</THEN>
</IF>
<div id="ajaxLoading" style="width:200px;height:100px;position:absolute; top: 350px; display:none; left: 320px;" bgcolor="white">
<table width="100%" height="100%" cellspacing="0" cellpadding="0" bgcolor="#ffffff" align="center" style="border: 1px solid rgb(204,204,204);">
<tbody>
<tr>
<td valign="middle" align="center">
<img src="Variables.cs_imagedir/graphics/common/icon/wait_ax.gif" REPLACEALL="Variables.cs_imagedir"/>
<br/>
<br/>
<b>
<span id="loadingMsg"><XLAT.STREAM KEY="dvin/UI/Loading"/></span>
<img src="Variables.cs_imagedir/graphics/common/icon/short_Progress.gif" REPLACEALL="Variables.cs_imagedir"/>
</b>
<a id="hider2" style="cursor: pointer; text-decoration: underline;"/>
</td>
</tr>
</tbody>
</table>
</div>
<STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
<STRING.ENCODE VARIABLE="rows" VARNAME="rows"/>
<STRING.ENCODE VARIABLE="displayPage" VARNAME="displayPage"/>
<STRING.ENCODE VARIABLE="orderBy" VARNAME="orderBy"/>
<STRING.ENCODE VARIABLE="direction" VARNAME="direction"/>
<STRING.ENCODE VARIABLE="sessionIds:Total" VARNAME="sessionIds:Total"/>
<STRING.ENCODE VARIABLE="defaultTab" VARNAME="defaultTab"/>
<replaceall list="CS.Property.ft.cgipath,Variables.cs_imagedir,Variables.rows,Variables.displayPage,Variables.orderBy,Variables.direction,Variables.sessionIds:Total,Variables.defaultTab,Variables.urlPublishConsoleRun,Variables.urlPublishConsoleSch,Variables.urlPublishConsoleHis">
<script type="text/javascript">
<![CDATA[
var tabSet1 = new ProtoTabs('consoletabs',{defaultPanel:'Variables.defaultTab', ajaxUrls: {_t1:'Variables.urlPublishConsoleRun',_t2:'Variables.urlPublishConsoleSch'},nonajaxUrls:{_t3:'Variables.urlPublishConsoleHis&rows=Variables.rows&displayPage=Variables.displayPage'}});
var _mainDiv= document.getElementById("_main");
_mainDiv.style.display="inline";
]]>
</script>
<script type="text/javascript">
<![CDATA[
	function confirmDelete(){
	]]>
		if(confirm("<XLAT.STREAM KEY="dvin/UI/Publish/DeleteAllPublishSessionsConfirmation" ESCAPE="true" ENCODE="false"/>"))
		<![CDATA[
		{
			return true;
		}
		else
		{
		return false;
		}
    }
	
	dojo.addOnLoad(function() {
		dojo.addClass(dojo.body(), 'ttip');
	});
	var tooltips = {};
	function showTooltip(evt,text,id){
		var target = evt.target || evt.srcElement;
		if(!tooltips[id]){
			var ttip = new dijit.Tooltip({
				connectId: dojo.query('td', dojo.byId(id)),
				label: text,
				showDelay : 250
			});
			ttip.open(target);
			tooltips[id] = ttip;
		}
	}
]]>
</script>
<script type="text/javascript" src="CS.Property.ft.cgipathjs/tooltip.js"></script>
</replaceall>
</then></if>
</FTCS>
