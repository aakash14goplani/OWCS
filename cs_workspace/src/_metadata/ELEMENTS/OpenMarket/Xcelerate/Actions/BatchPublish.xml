<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Actions/BatchPublish 
- INPUT
-    Variables.TARGETID -- id of publishing target
-    Variables.PUBSESSIONID -- pubsession id
-->
    <ics.loggingcontext NAME="pubsessionid" VALUE="Variables.PUBSESSIONID" />
<setvar NAME="tablename" VALUE="LocaleMap" />
<EXECSQL SQL="SELECT * FROM Variables.tablename WHERE ordinal=1" LIST="localelist" />
<setssvar NAME="locale" VALUE="localelist.id" />

<setvar NAME="AbortFlag" VALUE="false" />
<setvar NAME="isWaiting" VALUE="false" />
<setvar NAME="pubsessloaded" VALUE="false" />
<PROPERTY.GET PARAM="xcelerate.batchuser" INIFILE="futuretense_xcel.ini" VARNAME="batchuser" />
<if COND="SessionVariables.username!=Variables.batchuser">
<then>
     <XLAT.LOOKUP KEY="dvin/UI/Error/notloginbatchpublishbatchuserCheck" VARNAME="_XLAT_" />
     <setvar NAME="errlog" VALUE="Variables._XLAT_" />
     <setvar NAME="AbortFlag" VALUE="true" />
</then>
</if>

<if COND="Variables.AbortFlag!=true">
<then>
     <setvar NAME="errno" VALUE="0" />
     <USERISMEMBER GROUP="xceladmin" />
     <if COND="Variables.errno=0">
     <then>
          <XLAT.LOOKUP KEY="dvin/UI/Error/publishfailedbatchusernotmemberadminC" VARNAME="_XLAT_" />
          <setvar NAME="errlog" VALUE="Variables._XLAT_" />
          <setvar NAME="AbortFlag" VALUE="true" />
     </then>
     </if>
</then>
</if>

<if COND="Variables.AbortFlag!=true">
<then>
     <PUBSESSIONMANAGER.LOAD OBJVARNAME="pubsess" ID="Variables.PUBSESSIONID" />
     <if COND="IsError.Variables.errno=true">
     <then>
     		 <SETVAR NAME="puberr" VALUE="errno" />
          <XLAT.LOOKUP KEY="dvin/UI/Error/notloadpublishingsessionerrno" VARNAME="_XLAT_" errno="Variables.errno"
                       EVALALL="false" />
          <setvar NAME="errlog" VALUE="Variables._XLAT_" />
          <setvar NAME="AbortFlag" VALUE="true" />
     </then>
     <else>
          <setvar NAME="pubsessloaded" VALUE="true" />
     </else>
     </if>
</then>
</if>

<if COND="Variables.AbortFlag!=true">
<then>
	<PUBTARGETMANAGER.LOAD ID="Variables.TARGETID" OBJVARNAME="pubtgt" />
	<PUBTARGET.SCATTER NAME="pubtgt" PREFIX="pubfact:" />
     <if COND="IsError.Variables.errno=true">
     <then>
     	  <SETVAR NAME="puberr" VALUE="errno" />
        <XLAT.LOOKUP KEY="dvin/UI/Error/notgetpublishableassetserrno2" VARNAME="_XLAT_" errno="Variables.errno"
                     EVALALL="false" />
        <setvar NAME="errlog" VALUE="Variables._XLAT_" />
        <setvar NAME="AbortFlag" VALUE="true" />
     </then>
     </if>
</then>
</if>

<if COND="Variables.AbortFlag!=true">
<then>
     <DELIVERYTYPE.LOAD NAME="pubdt" OBJECTID="Variables.pubfact:type" />
     <DELIVERYTYPE.GET NAME="pubdt" FIELD="path" OUTPUT="pubdt:path" />
     <if COND="IsError.Variables.errno=true">
     <then>
        <SETVAR NAME="puberr" VALUE="errno" />
        <XLAT.LOOKUP KEY="dvin/UI/Error/notloadgetpatpublishingdeliverytypeerrno" VARNAME="_XLAT_"
                     errno="Variables.errno" EVALALL="false" />
        <setvar NAME="errlog" VALUE="Variables._XLAT_" />
        <setvar NAME="AbortFlag" VALUE="true" />
     </then>
     </if>
</then>
</if>

<if COND="Variables.AbortFlag!=true">
<then>
     <PUBTARGET.UNPACK NAME="pubtgt" PREFIX="pubfact:" FIELD="factors" />

     <if COND="IsVariable.IsRestart=false">
     <then>
        <if COND="IsVariable.OnDemandAssetIds=false">
        <then>
            <ApprovedAssets.GetAssetsToPublish TARGET="Variables.TARGETID" PREFIX="PublishableAssets" />
            <if COND="IsError.Variables.errno=true">
             <then>
                  <SETVAR NAME="puberr" VALUE="errno" />
                <XLAT.LOOKUP KEY="dvin/UI/Error/notgetpublishableassetserrno2" VARNAME="_XLAT_" errno="Variables.errno"
                             EVALALL="false" />
                <setvar NAME="errlog" VALUE="Variables._XLAT_" />
                <setvar NAME="AbortFlag" VALUE="true" />
             </then>
             </if>
        </then>
        </if>
    </then>
    <else>
		  <!-- Signal that we don't need publishable assets for the restart -->
        <SETVAR NAME="PublishableAssetsTotal" VALUE="-1" />
    </else>
    </if>
</then>
</if>

<if COND="Variables.isImport=true">
<then>
  <!-- Signal that we don't need publishable assets for import -->
  <SETVAR NAME="PublishableAssetsTotal" VALUE="-1" />
</then>
</if>

<if COND="Variables.AbortFlag!=true">
<then>
     <if COND="Variables.PublishableAssetsTotal=0">
     <then>
     	<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Publish/CountTagsToPublish">
			<ARGUMENT NAME="target" VALUE="Variables.TARGETID"/>
		</CALLELEMENT>
		<IF COND="Variables.PublishableTagsCount=0">
		<THEN>
			<!-- If no publishable asset and no publishable tags, we're done -->
            <XLAT.LOOKUP KEY="dvin/UI/Nothingtopublish" VARNAME="_XLAT_" />
            <CSVAR NAME="Variables._XLAT_" />
            <PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.PUBSESSIONID" VALUE="Variables._XLAT_" />
            <PUBSESSIONMANAGER.DONE ID="Variables.PUBSESSIONID" />
         	<setvar NAME="AbortFlag" VALUE="true" />
       	</THEN>
       	</IF>
     </then>
     </if>
</then>
<else>
     <XLAT.STREAM KEY="dvin/Common/numbererrormsg" />:<STRING.STREAM VALUE="Variables.errlog" />
     <LOGMSG STR="Variables.errlog" />
     <if COND="Variables.pubsessloaded=true">
     <then>
 			<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.PUBSESSIONID"
                                           VALUE="Variables.errlog (errno Variables.puberr)" />
			<PUBSESSIONMANAGER.FAIL ID="Variables.PUBSESSIONID" />
     </then>
     </if>
</else>
</if>

<if COND="Variables.AbortFlag!=true">
	<then>
	  	<!-- expects the pubsession object loaded as 'pubsess' -->
        <callelement NAME="Variables.pubdt:path/PublishApprovedAssets">
          <argument NAME="PREFIX" VALUE="PublishableAssets" />
            <argument NAME="target" VALUE="Variables.TARGETID" />
        </callelement>

        <if COND="IsError.Variables.errno=true">
        <then>
            <SETVAR NAME="puberr" VALUE="errno" />
            <XLAT.LOOKUP KEY="dvin/UI/Error/Publishapprovedassetsfailederrno" errno="Variables.errno" VARNAME="_XLAT_"
                         EVALALL="false" />
            <setvar NAME="errlog" VALUE="Variables._XLAT_" />
            <if COND="IsVariable.errdetail1=true">
            <then>
                 <setvar NAME="errlog" VALUE="Variables.errlog Variables.errdetail1" />
            </then>
            </if>

            <XLAT.STREAM KEY="dvin/Common/numbererror" /> <STRING.STREAM VALUE="Variables.errlog" />
            <LOGMSG STR="Variables.errlog" />
            <PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.PUBSESSIONID" VALUE="Variables.errlog" />
            <PUBSESSIONMANAGER.FAIL ID="Variables.PUBSESSIONID" />
        </then>
        <else>
            <XLAT.STREAM KEY="dvin/Common/Successfulcompletion" />
            <if COND="Variables.isWaiting=true">
            <then>
                <PUBSESSIONMANAGER.WAIT ID="Variables.PUBSESSIONID" />
            </then>
            <else>
                <if COND="Variables.isCancelled=true">
                <then>
                    <PUBSESSIONMANAGER.CANCEL ID="Variables.PUBSESSIONID" />
                </then>
                <else>
                    <PUBSESSIONMANAGER.DONE ID="Variables.PUBSESSIONID" />
                </else>
                </if>
            </else>
            </if>
        </else>
        </if>
	</then>
</if>

<ics.loggingcontext NAME="pubsessionid" VALUE="Variables.empty" />
</FTCS>