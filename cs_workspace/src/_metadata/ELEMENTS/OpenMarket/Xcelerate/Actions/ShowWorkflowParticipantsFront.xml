<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/ShowWorkflowParticipantsFront.xml $ 
$Revision: 47 $ 
$Modtime: 9/17/04 2:09p $ 
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- ShowWorkflowParticipants.xml
-
- DESCRIPTION
-	Display the workflow particpants for this asset, 
-	organized by steps.
-
- HISTORY 
-->
<STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
<PROPERTY.GET PARAM="xcelelem.manageuserpub" INIFILE="futuretense_xcel.ini" VARNAME="propmanageuserpub"/>

<WorkflowAsset.Load ASSETTYPE="Variables.AssetType" ID="Variables.id" OBJVARNAME="workflowasset" />
<WorkflowAsset.GetObjectName OBJECT="workflowasset" VARNAME="objectname" />

<!-- 
-   Check FunctionPrivs to decide if user can Show Participants now.
-->
<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="theAsset"/>
<ASSET.GET NAME="theAsset" FIELD="id" OUTPUT="id"/>
<ASSET.GET NAME="theAsset" FIELD="name" OUTPUT="assetname"/>

<IF COND="Variables.cs_environment!=ucform">
<THEN>
	<div style="position:fixed;z-index:999;width:100%;left:0px;top:0px;">
	<div class='toolbarContent'>
	<table>
	<tr>
		<td align="left">
			<XLAT.LOOKUP KEY="UI/Forms/Back" VARNAME="_XLAT_" ESCAPE="true"/>
			<XLAT.LOOKUP KEY="UI/Forms/Back" VARNAME="_ALT_"/>
			<A HREF="#" onclick="javascript:history.go(-1);return false;" onmouseover="window.status='Variables._XLAT_';return true;" onmouseout="window.status='';return true;" REPLACEALL="Variables._XLAT_">
				<IMG onclick="this.src='Variables.cs_imagedir/../js/fw/images/ui/ui/toolbar/goBackClick.png';return true;" onmouseover="this.src='Variables.cs_imagedir/../js/fw/images/ui/ui/toolbar/goBackHover.png';return true;" onmouseout="this.src='Variables.cs_imagedir/../js/fw/images/ui/ui/toolbar/goBack.png'" src="Variables.cs_imagedir/../js/fw/images/ui/ui/toolbar/goBack.png" ALT="Variables._XLAT_" title="Variables._ALT_" BORDER="0"  REPLACEALL="Variables.cs_imagedir,SessionVariables.locale,Variables._XLAT_,Variables._ALT_"/>
			</A>
		</td>
	</tr>
	</table>
	</div>
	<div id="msgArea"></div>
	<div class="toolbarBorder"></div></div>
	<div style="height:50px;"></div>
</THEN>
</IF>

<WorkflowEngine.isFunctionLegal OBJECT="workflowasset" FUNCTIONNAME="showparticipants" SITE="SessionVariables.pubid" VARNAME="isLegal" REASONVARNAME="denialreason" MUSTBEASSIGNED="false"/>
<if COND="Variables.isLegal=false">
<then>
     <SETVAR NAME="AbortFlag" VALUE="true"/>
     <SETVAR NAME="ErrorName" VALUE="IllegalTransition"/>
     <SETVAR NAME="severity" VALUE="info"/>
</then>
<else>
    <WorkflowEngine.GetObjectWorkflowProcess OBJECT="workflowasset" VARNAME="workflowid" />
	<IF COND="IsVariable.workflowid!=true">
	<THEN>
		<SETVAR NAME="AbortFlag" VALUE="true"/>
		<SETVAR NAME="ErrorName" VALUE="NeedsWorkflow"/>
		<SETVAR NAME="severity" VALUE="error"/>
	</THEN>
	<ELSE>
        <WorkflowEngine.GetProcessID ID="Variables.workflowid" OBJVARNAME="workflow"/>
        <WorkflowProcess.GetSteps NAME="workflow" PREFIX="steps" />
        <IF COND="Variables.stepsTotal=0">
        <THEN>
             <XLAT.LOOKUP KEY="dvin/UI/AssetNotInWorkflowOrWorkflowNoSteps" VARNAME="_XLAT_"/>
             <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                 <argument NAME="msgtext" VALUE="Variables._XLAT_"/>
		         <argument NAME="severity" VALUE="info"/>	
             </callelement>
             <setvar NAME="AbortFlag" VALUE="true"/>
        </THEN>
        <ELSE>
            <!-- 
            -   Check to see if we have participants defined
            -->
            <WORKFLOWENGINE.GETOBJECTPARTICIPANTS OBJECT="workflowasset" OBJVARNAME="myParts"/>
            <PARTICIPANTS.GETALLPARTICIPANTS NAME="myParts" LISTVARNAME="userlist"/>
            <if COND="userlist.#numRows=0">
            <then>
            <XLAT.LOOKUP KEY="dvin/UI/Error/assetnowfparticipantsassociated" VARNAME="_XLAT_"/>
                <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                    <argument NAME="msgtext" VALUE="Variables._XLAT_"/>
                    <argument NAME="severity" VALUE="info"/>	
                </callelement>
                <setvar NAME="AbortFlag" VALUE="true"/>    
            </then>
            </if>
        </ELSE>
        </IF>
    </ELSE>
    </IF>
</else>
</if>
	
<!--
 -   Begin report table, where each row is a workflow step
-->
<if COND="Variables.AbortFlag!=true">
<then>	  
	  
    <ASSETTYPE.LOAD NAME="type" TYPE="Variables.AssetType"/>
    <ASSETTYPE.GET NAME="type" FIELD="description" OUTPUT="ATdesc"/>
    
    <TABLE class="width-outer-70" BORDER="0" CELLSPACING="0" CELLPADDING="0">
    <TR>
        <TD>
            <span class="title-text"><XLAT.STREAM KEY="dvin/UI/ShowParticipants"/></span>
        </TD>
    </TR>
    <TR>
        <TD>
    	    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/TitleBar"/>
    	</TD>
    </TR>
    </TABLE>
    
	<TABLE class="width-outer-50" BORDER="0" CELLSPACING="0" CELLPADDING="0">
		<tr>
			<td></td>
			<td class="tile-dark" valign="TOP" HEIGHT="1">
				<IMG WIDTH="1" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/> 
			</td>
			<td></td>
		</tr>
		<tr>
			<td class="tile-dark" VALIGN="top" WIDTH="1"><BR/></td>
			<td> 
				<TABLE BGCOLOR="#FFFFFF" CELLPADDING="0" CELLSPACING="0" BORDER="0" width="100%">
				<tr>
					<td colspan="7" class="tile-highlight"><IMG WIDTH="1" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/>
					</td>
				</tr>
				<tr>
					<td class="tile-a" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;&nbsp;&nbsp;&nbsp;</td>
					
					<td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir"><DIV class="new-table-title"><XLAT.STREAM KEY="dvin/Common/Step"/></DIV></td>
					
					<td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;&nbsp;&nbsp;&nbsp;</td>
					
					<td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir"><DIV class="new-table-title"><XLAT.STREAM KEY="dvin/UI/UsersAuthorized"/></DIV></td>
		
					<td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;&nbsp;&nbsp;&nbsp;</td>
					
					<td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir"><DIV class="new-table-title"><XLAT.STREAM KEY="dvin/UI/UsersNotified"/></DIV></td>
									
					<td class="tile-c" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;&nbsp;&nbsp;&nbsp;</td>
				</tr>

		        <setcounter NAME="count" VALUE="0"/>
		        <!-- Create a List for Alloy UI -->
				<LISTOBJECT.CREATE NAME="myListForWorkflowParticipants" COLUMNS="stepName,aclUsers,notifyAclUsers" />
				
		        <setvar NAME="rowStyle" VALUE="tile-row-normal"/>	
	            <LOOP FROM="0" COUNT="Variables.stepsTotal">
	                <WorkflowStep.GetName NAME="stepsCounters.count" VARNAME="stepname" />
	                <WorkflowStep.GetStepType NAME="stepsCounters.count" VARNAME="steptype" />
	                
	                <WorkflowStep.GetAuthorizationRoles NAME="stepsCounters.count" OBJVARNAME="authrolesobj" />
	                <RoleList.GetAll NAME="authrolesobj" VARNAME="authroles" /> 
	                
	                <STRINGLIST NAME="authRoles" STR="Variables.authroles" DELIM=","/>
	                <HASH.CREATE NAME="hashauthusers"/>
	                <LOOP LIST="authRoles">
	                    <PARTICIPANTS.GetParticipantsForRole NAME="myParts" ROLE="authRoles.ITEM" LISTVARNAME="authuserlist" />
	                    <if COND="authuserlist.#numRows!=0">
	                    <then>
	                        <loop LIST="authuserlist">
	                            <UserManager.GetDisplayableUserName USER="authuserlist.ITEM" VARNAME="uname" />
	                            <HASH.ADD NAME="hashauthusers" VALUE="Variables.uname"/>
	                        </loop>
	                    </then>
	                    </if>
	                </LOOP>
	                <HASH.TOSTRING NAME="hashauthusers" VARNAME="aclusers" DELIM=","/>
	                <SUBSTITUTE STR="Variables.aclusers" WHAT="," WITH=",%20" OUTSTR="aclusers"/>   
	                
	                <if COND="Variables.steptype=inplace">
	                <then>
	                    <XLAT.LOOKUP KEY="dvin/UI/KeepAssignList" VARNAME="notifyaclusers" ENCODE="false"/>
	                </then>
	                <else>
	                    <WorkflowStep.GetNotifyRoles NAME="stepsCounters.count" OBJVARNAME="notifyrolesobj" />
	                    <RoleList.GetAll NAME="notifyrolesobj" VARNAME="notifyroles" />
	                    
	                    <STRINGLIST NAME="notifyRoles" STR="Variables.notifyroles" DELIM=","/>
	                    <HASH.CREATE NAME="hashnotifyusers"/>
	                    <LOOP LIST="notifyRoles">
	                        <PARTICIPANTS.GetParticipantsForRole NAME="myParts" ROLE="notifyRoles.ITEM" LISTVARNAME="notifyuserlist" />
	                        <if COND="notifyuserlist.#numRows!=0">
	                        <then>
	                            <loop LIST="notifyuserlist">
	                                <UserManager.GetDisplayableUserName USER="notifyuserlist.ITEM" VARNAME="uname" />
	                                <HASH.ADD NAME="hashnotifyusers" VALUE="Variables.uname"/>
	                            </loop>
	                        </then>
	                        </if>
	                    </LOOP>
	                    <HASH.TOSTRING NAME="hashnotifyusers" VARNAME="notifyusers" DELIM=","/>
	                    <SUBSTITUTE STR="Variables.notifyusers" WHAT="," WITH=",%20" OUTSTR="notifyaclusers"/>
	                 </else>
	                 </if>
	                                 
	                 <if COND="Variables.aclusers=Variables.empty">
	                 <then>
	                      <XLAT.LOOKUP KEY="dvin/UI/NoUsers" VARNAME="aclusers"/>
	                 </then>
	                 </if>
	                 
	                 <if COND="Variables.notifyaclusers=Variables.empty">
	                 <then>
	                      <XLAT.LOOKUP KEY="dvin/UI/NoUsers" VARNAME="notifyaclusers"/>
	                 </then>
	                 </if>
	                
	                <!--
	                -   Display the computed authorized and notified users
	                -->
		          	<tr class="Variables.rowStyle"  REPLACEALL="Variables.rowStyle">
						<td></td>
						<td><STRING.STREAM VALUE="Variables.stepname"/></td>
						<td></td>
						<td><STRING.STREAM VALUE="Variables.aclusers"/></td>
						<td></td>
						<td><STRING.STREAM VALUE="Variables.notifyaclusers"/></td>
						<td></td>
					</tr>

					<!-- Code for Alloy UI, we add the participant information to a list which is accessed by showWorkflowParticipants.jsp for Alloy UI -->
	                		<LISTOBJECT.ADDROW NAME="myListForWorkflowParticipants" stepName="Variables.stepname" aclUsers="Variables.aclusers" notifyAclUsers="Variables.notifyaclusers" />
	                	<!-- end of code for Alloy UI-->
	                <inccounter NAME="count" VALUE="1"/>
	            	<IF COND="Variables.rowStyle=tile-row-normal"><THEN>
						<SETVAR NAME="rowStyle" VALUE="tile-row-highlight"/>
					</THEN><ELSE>
						<SETVAR NAME="rowStyle" VALUE="tile-row-normal"/>
					</ELSE></IF>
		        </LOOP>	
				
				<!-- Convert the list object to resultset list so that we can do a ics:listloop inside the jsp -->
       			<LISTOBJECT.TOLIST NAME="myListForWorkflowParticipants" LISTVARNAME="workflowParticipantsList_for_AlloyUI" />
       			<!-- end of code for Alloy UI -->		
				</TABLE>
			</td>
			<td class="tile-dark" VALIGN="top" WIDTH="1"><BR /></td>
		</tr>
		<tr>
			<td colspan="3" class="tile-dark" VALIGN="TOP" HEIGHT="1"><IMG WIDTH="1" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
		</tr>
		<tr>
			<td></td>
			<td background="Variables.cs_imagedir/graphics/common/screen/shadow.gif" REPLACEALL="Variables.cs_imagedir"><IMG WIDTH="1" HEIGHT="5" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
			<td></td>
		</tr>
	</TABLE>	    	
</then>
<else>
     <if COND="IsVariable.ErrorName=true">
     <then>
		<div class="width-outer-70">
       	 <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
       		<argument NAME="elem" VALUE="Variables.ErrorName"/>
       		<argument NAME="severity" VALUE="Variables.severity"/>
    	 </callelement>
		</div> 
     </then>
     </if>
</else>
</if>
</FTCS>
