<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!--
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/NewContentPost.xml $
$Revision: 81 $
$Modtime: 8/25/04 11:18a $
-->

<!--
- Confidential and Proprietary Information of Open Market Inc.
-					All Rights Reserved.
-
- NewContentPost.xml
-
- DESCRIPTION
-	 create a new content item
-    Required input variable: AssetType
-    When content fields are posted, each content
-    category gets the opportunity to perform
-    some pre- and post-processing. For instance,
-    this may be required if any of the fields need
-    to be stored as file references from the database
-->

<PROPERTY.GET PARAM="xcelerate.treeType" INIFILE="futuretense_xcel.ini" VARNAME="proptreetype"/>
<STRING.ENCODE VARIABLE="id" VARNAME="id"/>
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType" />
<STRING.ENCODE VARIABLE="cs_environment" VARNAME="cs_environment" />
<STRING.ENCODE VARIABLE="cs_formmode" VARNAME="cs_formmode" />
<STRING.ENCODE VARIABLE="cancelpage" VARNAME="cancelpage"/>
<!-- Do the following logic only if the user has chosen to submit the asset (not cancel) -->
<IF COND="Variables.upcommand!=cancel">
<THEN>

<!-- Attempt to create an asset given the asset type -->

	<ASSET.CREATE TYPE="Variables.AssetType" NAME="theCurrentAsset"/>
	<IF COND="IsError.Variables.errno!=true">
	<THEN>
		<IF COND="IsVariable.id=true">
			<THEN>
				<ASSET.SET TYPE="Variables.AssetType" NAME="theCurrentAsset" FIELD="id" VALUE="Variables.id"/>
			</THEN>
		</IF>
		<HASH.CREATE NAME="refreshHash"/>
		<callelement NAME="OpenMarket/Xcelerate/Actions/convertAssetFormsTZ" />
<!-- call the preupdate function -->
			<callelement NAME="OpenMarket/Xcelerate/AssetType/Variables.AssetType/PreUpdate">
				<argument NAME="updatetype" VALUE="create"/>
				<argument NAME="AssignToUser" VALUE="SessionVariables.username"/>
				<argument NAME="prefix" VALUE="Variables.AssetType"/>
			</callelement>

      <IF COND="IsError.Variables.errno!=true">
      <THEN>
<!-- force status to PL -->

			<ASSET.SET NAME="theCurrentAsset" FIELD="status" VALUE="PL"/>

<!--If the Asset has an id it was already saved, so if it is being tracked we need to
	check it out so it can get saved again without error-->

					<SETVAR NAME="didcheckout" VALUE="false"/>
					<ASSET.ISNEW NAME="theCurrentAsset" VARNAME="isNew"/>
					<ASSET.GET NAME="theCurrentAsset" FIELD="id"/>
					<IF COND="Variables.isNew=false">
						<THEN>
							<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
								<argument NAME="AssetType" VALUE="Variables.AssetType"/>
							</callelement>
							<IF COND="Variables.trackingenabled=true">
								<THEN>
									<ASSET.CHECKOUT OBJECTTYPE="Variables.AssetType" OBJECTID="Variables.id"/>
									<IMPLICITCHECKOUT.LOGIMPLICITCHECKOUT ASSETTYPE="Variables.AssetType"
										ASSETID="Variables.id" USER="Variables.userID" FUNCTION="Implicit Checkout"/>
									<SETVAR NAME="didcheckout" VALUE="true"/>
								</THEN>
							</IF>
						</THEN>
					</IF>

<!-- Save the asset -->

			<ASSET.SAVE NAME="theCurrentAsset"/>
			<IF COND="Variables.errno=0">
			<THEN>
<!-- If we already checkout and saved alright, check it in now -->

				<IF COND="Variables.didcheckout=true">
					<THEN>
						<XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/VersionbyNew" ENCODE="false" VARNAME="_xlat_version"/>
						<ASSET.CHECKIN NAME="theCurrentAsset" ANNOTATION="Variables._xlat_version" CHECKOUT="false"/>
						<IF COND="IsError.Variables.errno=false">
						<THEN>
							<IMPLICITCHECKOUT.CLEARCHECKOUT ASSETTYPE="Variables.AssetType" ASSETID="Variables.id"/>
						</THEN>
						</IF>
					</THEN>
				</IF>

<!-- Get the asset id from the new asset -->

					<ASSET.GET NAME="theCurrentAsset" FIELD="id"/>

<!-- Index the asset in the search engine -->

					<callelement NAME="OpenMarket/Xcelerate/Actions/Search/ManageSeIndex">
						<argument NAME="msicommand" VALUE="Add"/>
					</callelement>

<!-- call the postupdate function -->

					<callelement NAME="OpenMarket/Xcelerate/AssetType/Variables.AssetType/PostUpdate">
						<argument NAME="updatetype" VALUE="create"/>
					</callelement>

					<HASH.ADD NAME="refreshHash" VALUE="Self:Dummy__Variables.AssetType"/>
					<HASH.TOSTRING NAME="refreshHash" VARNAME="__TreeRefreshKeys__" DELIM=";"/>

<!-- call the treeupdate function -->
					<if  COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
						<then>
  							<callelement NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype">
								<argument NAME="assetname" VALUE="theCurrentAsset"/>
								<argument NAME="treecommand" VALUE="create"/>
							</callelement>
						</then>
					</if>
<!--Update the content tree in the UI -->
					<if COND="Variables.cs_environment=ucform">
						<then>
							<SETVAR NAME="contentFormReposted" VALUE="false" />
							<callelement NAME="OpenMarket/Xcelerate/UIFramework/UpdateUITree">
								<argument NAME="refreshKeys" VALUE="Variables.__TreeRefreshKeys__"/>
							</callelement>
						</then>
					</if>

<!-- if revision tracking has been turned on for this
	 contentcategory, then ensure that the just
	 created content is checked in (but we don't need to do this twice-->

				<IF COND="Variables.didcheckout=false">
					<THEN>
						<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
							<argument NAME="AssetType" VALUE="Variables.AssetType"/>
						</callelement>
						<IF COND="Variables.trackingenabled=true">
							<THEN>
<!-- commit the change -->
								<ASSET.CHECKOUT OBJECTTYPE="Variables.AssetType" OBJECTID="Variables.id"/>
								<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Commit-Asset"/>
								<XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/VersionbyNew" ENCODE="false" VARNAME="_xlat_version"/>
								<ASSET.CHECKIN NAME="Commit-Asset" ANNOTATION="Variables._xlat_version" CHECKOUT="false"/>
							</THEN>
						</IF>
					</THEN>
				</IF>

<!-- set access permissions from start menu item -->
             <IF COND="IsVariable.cs_StartMenuPermissions=true">
             <THEN>
                 <STRINGLIST NAME="lPermissions" STR="Variables.cs_StartMenuPermissions" DELIM=";"/>
                 <LOOP LIST="lPermissions">
                     <STRINGLIST NAME="lPermissionSplit" STR="lPermissions.ITEM" DELIM="-"/>
                     <SETVAR NAME="cs_PermissionRole" VALUE="lPermissionSplit.ITEM"/>
                     <SETROW LIST="lPermissionSplit" ACTION="NEXT"/>
                     <SETVAR NAME="cs_PermissionFunction" VALUE="lPermissionSplit.ITEM"/>
                     <SETROW LIST="lPermissionSplit" ACTION="NEXT"/>
                     <SETVAR NAME="Variables.cs_PermissionRole-Variables.cs_PermissionFunction" VALUE="lPermissionSplit.ITEM"/>
                 </LOOP>
                 <CALLELEMENT NAME="OpenMarket/Xcelerate/PrologActions/AssetSecurityDetailsPost"/>
             </THEN>
             </IF>
<!-- enter into workflow if necessary -->
							<IF COND="IsVariable.__WORKFLOWPROCID__=true">
							<THEN>
                                <STRINGLIST STR="Variables.__PARTROLES__" NAME="allRoles" DELIM=","/>
                                <setvar NAME="process" VALUE="Variables.__WORKFLOWPROCID__" />

                                <WorkflowEngine.GetProcessID ID="Variables.process" OBJVARNAME="workflow"/>
                                <WorkflowProcess.GetInitialStepID NAME="workflow" VARNAME="inistepid"/>
                                <WorkflowProcess.GetStep NAME="workflow" VALUE="Variables.inistepid" OBJVARNAME="stepobj"/>
                                <WorkflowStep.GetStepType NAME="stepobj" VARNAME="steptype" />

                                <if COND="Variables.steptype!=ask">
                                <then>
                                    <WORKFLOWASSET.LOAD ASSETTYPE="Variables.AssetType"
														  ID="Variables.id"
														  OBJVARNAME="workflowasset" />
										<!--
    								<WORKFLOWENGINE.GETOBJECTPARTICIPANTS OBJECT="workflowasset" OBJVARNAME="myParts"/>
    								<PARTICIPANTS.CLEAR NAME="myParts"/>
										-->
										<WORKFLOWENGINE.NEWPARTICIPANTS  OBJVARNAME="myParts"/>
    								<LOOP LIST="allRoles">
    									<SETVAR NAME="users" VALUE="Variables.__ROLE__allRoles.ITEM__"/>
    									<STRINGLIST STR="Variables.users" NAME="userList" DELIM=";"/>
    									<LOOP LIST="userList">
    										<PARTICIPANTS.ADDPARTICIPANT NAME="myParts" ROLE="allRoles.ITEM" USER="userList.ITEM"/>
    									</LOOP>
    								</LOOP>
										<!--
    								<WORKFLOWENGINE.SETOBJECTPARTICIPANTS OBJECT="workflowasset" PARTICIPANTS="myParts"/>
										-->
    								<WORKFLOWENGINE.STARTOBJECTWORKFLOWPROCESS SITE="SessionVariables.pubid"
    																						 OBJECT="workflowasset"
    																						 ID="Variables.__WORKFLOWPROCID__"
																								 PARTICIPANTS="myParts"/>

                                    <callelement name="OpenMarket/Xcelerate/Actions/PostSaveActions"/>
                                </then>
                                <else>
                                    <CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/SetWorkflowPost">
                                        <ARGUMENT NAME="useDefaultDeadline" VALUE="true"/>
                                        <ARGUMENT NAME="cs_FromCreate" VALUE="true"/>
                                    </CALLELEMENT>
                                    <callelement name="OpenMarket/Xcelerate/Actions/PostSaveActions"/>
                                </else>
                                </if>
							</THEN>
                            <ELSE>
                                <callelement name="OpenMarket/Xcelerate/Actions/PostSaveActions"/>
                            </ELSE>
							</IF>

							<!-- Load the detail screen of popup -->
                            <IF COND="Variables.cs_environment=popup">
                            <THEN>
                                <callelement NAME="OpenMarket/Xcelerate/Actions/ContentDetailsFront">
                                    <argument NAME="assettype" VALUE="Variables.AssetType"/>
                                    <argument NAME="id" VALUE="Variables.id"/>
                                </callelement>
                            </THEN>
                            </IF>
							<IF COND="Variables.IFCKEditor=true">
							<THEN>
							<IF COND="IsVariable.FCKName=false">
							<THEN>
								<SETVAR NAME="FCKName" VALUE=""/>
							</THEN>
							</IF>
							
							<STRING.ENCODE VARIABLE="FCKName" VARNAME="FCKName"/>
							<STRING.ENCODE VARIABLE="FCKAssetType" VARNAME="FCKAssetType" />
							<STRING.ENCODE VARIABLE="fielddesc" VARNAME="fielddesc" />
							<STRING.ENCODE VARIABLE="formFieldName" VARNAME="formFieldName" />
							<STRING.ENCODE VARIABLE="attrEditingStyle" VARNAME="attrEditingStyle" />
							
							<IF COND="Variables.embedtype=include">
							<THEN>
							<callelement NAME="OpenMarket/Xcelerate/Actions/AddInclusion">
								<argument NAME="tn_id" VALUE="Variables.id"/>
								<argument NAME="tn_AssetType" VALUE="Variables.AssetType"/>
								<argument NAME="name" VALUE="Variables.FCKName"/>
								<argument NAME="AssetType" VALUE="Variables.FCKAssetType"/>
								<argument NAME="fielddesc" VALUE="Variables.fielddesc"/>
								<argument NAME="formFieldName" VALUE="Variables.formFieldName"/>
								<!--  EditingStyle can conflict with the attribute of the new asset being created 
								from ckeditor so we are using different name to avoid the conflict.-->
								<argument NAME="EditingStyle" VALUE="Variables.attrEditingStyle"/>
							</callelement>
							</THEN>
							</IF>
							<IF COND="Variables.embedtype=link">
							<THEN>
							<callelement NAME="OpenMarket/Xcelerate/Actions/EmbeddedLink">
								<argument NAME="tn_id" VALUE="Variables.id"/>
								<argument NAME="tn_AssetType" VALUE="Variables.AssetType"/>
								<argument NAME="name" VALUE="Variables.FCKName"/>
								<argument NAME="AssetType" VALUE="Variables.FCKAssetType"/>
								<argument NAME="fielddesc" VALUE="Variables.fielddesc"/>
								<argument NAME="formFieldName" VALUE="Variables.formFieldName"/>
								<!--  EditingStyle can conflict with the attribute of the new asset being created 
								from ckeditor so we are using different name to avoid the conflict.-->
								<argument NAME="EditingStyle" VALUE="Variables.attrEditingStyle"/>
							</callelement>
							</THEN>
							</IF>
							</THEN>
							</IF>
						</THEN>
        				<ELSE>
        					<!-- asset.save failed -->
        					<callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
        						<argument NAME="error" VALUE="EnterAssetFailed"/>
        						<argument NAME="AssetType" VALUE="Variables.AssetType"/>
        					</callelement>
                   </ELSE>
                   </IF>
                  </THEN>
                  <ELSE>
                 <!-- error from PreUpdate -->
    			    <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
    				   <argument NAME="error" VALUE="EnterAssetFailed"/>
    				   <argument NAME="AssetType" VALUE="Variables.AssetType"/>
    			    </callelement>
                </ELSE>
                </IF>
				
	
    		</THEN>
    		<ELSE>
    		<!-- asset.create failed -->
			 <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
				<argument NAME="error" VALUE="EnterAssetFailed"/>
				<argument NAME="AssetType" VALUE="Variables.AssetType"/>
			</callelement>
		</ELSE>
	</IF>
	
</THEN>
<ELSE>
	<!-- cancel -->
	<ASSETTYPE.LOAD NAME="type" TYPE="Variables.AssetType"/>
	<ASSETTYPE.SCATTER NAME="type" PREFIX="AssetTypeObj"/>
	<IF COND="Variables.EditFlag=copy">
    <THEN>
	  <XLAT.LOOKUP KEY="dvin/UI/AssetMgt/NewContent-CancelCopy" VARNAME="_xlat_cancel"/>
    	<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
    		<argument NAME="msgtext" VALUE="Variables._xlat_cancel"/>
    		<argument NAME="severity" VALUE="info"/>
    	</callelement>
		<!-- Display the details page -->
		<STRING.ENCODE VARIABLE="CopyAssetType" VARNAME="CopyAssetType"/>
		<callelement NAME="OpenMarket/Xcelerate/Actions/ContentDetailsFront">
			<argument NAME="assettype" VALUE="Variables.CopyAssetType"/>
			<argument NAME="id" VALUE="Variables.Copyid"/>
        </callelement>

    </THEN>
    <ELSE>
	    <setvar name="didCancel" value="true" />
		<IF COND="IsVariable.cancelpage!=true">
			<THEN>
		        <!-- Go back to the ShowStartMenuItems page by default -->
				<SETVAR NAME="cancelpage" VALUE="OpenMarket/Xcelerate/Actions/ShowStartMenuItems" />
			</THEN>
		</IF>
        <callelement NAME="Variables.cancelpage"></callelement>
	</ELSE>
    </IF>
</ELSE>
</IF><!-- end if upcommand=submit -->
</FTCS>
