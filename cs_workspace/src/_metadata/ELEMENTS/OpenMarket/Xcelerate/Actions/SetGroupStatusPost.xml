<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Actions/SetGroupStatusPost
-
- INPUT
-
- OUTPUT
-
-->
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType" />
<STRING.ENCODE VARIABLE="groupid" VARNAME="groupid"/>
<div class="width-outer-70">
<!-- load and scatter the group -->
<WORKFLOWENGINE.GETGROUPID ID="Variables.groupid" OBJVARNAME="group"/>
<WORKFLOWGROUP.SCATTER PREFIX="wfg:" NAME="group"/>
<setvar NAME="name" VALUE="Variables.wfg:name"/>
<IF COND="IsVariable.clearassignments=true">
<THEN>
		<STRINGLIST NAME="items" STR="Variables.clearassignments" DELIM=";"/>
		<XLAT.LOOKUP KEY="dvin/UI/Wf/ProcessingAssignmentsforGroupname" VARNAME="_XLAT_"/>
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			<argument NAME="severity" VALUE="info"/>
			<argument NAME="msgtext" VALUE="Variables._XLAT_"/>
		</callelement>
		<IF COND="items.#numRows=1">
		<THEN>
			<XLAT.LOOKUP KEY="dvin/UI/Wf/SingularNumAssignmenttoComplete" num="1" EVALALL="false" VARNAME="_XLAT_"/>
		</THEN>
		<ELSE>
			<XLAT.LOOKUP KEY="dvin/UI/Wf/PluralNumAssignmentstoComplete" num="items.#numRows" EVALALL="false" VARNAME="_XLAT_"/>
		</ELSE>
		</IF>
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			<argument NAME="severity" VALUE="info"/>
			<argument NAME="msgtext" VALUE="Variables._XLAT_"/>
		</callelement>

<LOOP LIST="items">
<WORKFLOWENGINE.GETASSIGNMENTID ID="items.ITEM" OBJVARNAME="wflAssignment"/>
		<WorkflowAssignment.GetAssignedObject NAME="wflAssignment" OBJVARNAME="workflowObject"/>
		<WorkflowAsset.GetAssetId OBJECT="workflowObject" VARNAME="workflow_assetid" />
		<WorkflowAsset.GetAssetType OBJECT="workflowObject" VARNAME="workflow_assettype" />
		<ASSET.LOAD TYPE="Variables.workflow_assettype" OBJECTID="Variables.workflow_assetid" NAME="theAsset"/>
<ASSET.GET NAME="theAsset" FIELD="name" OUTPUT="assetname"/>
<ASSET.GET NAME="theAsset" FIELD="description" OUTPUT="assetdesc" />
</LOOP>
</THEN>
</IF>

<if COND="IsVariable.useDefaultDeadline!=true">
<then>
	<setvar NAME="useDefaultDeadline" VALUE="true"/>
</then>
</if>

<!-- ChooseStep is in the form "stepid" -->
<SETVAR NAME="NextStep" VALUE="Variables.ChooseStep"/>

<WorkflowEngine.GetStepID ID="Variables.NextStep" OBJVARNAME="stepobj" />
<WorkflowStep.GetStepType NAME="stepobj" VARNAME="steptype" />

<setvar NAME="needsetassignees" VALUE="true" />

<if COND="Variables.steptype!=ask">
<then>
     <setvar NAME="needsetassignees" VALUE="false" />
</then>
<else>
    <if COND="IsVariable.assigneeroles=true">
    <then>
         <setvar NAME="needsetassignees" VALUE="false" />
    </then>
    </if>
</else>
</if>
</div>
<if COND="Variables.needsetassignees!=true">
<then>
	<div class="width-outer-70" style="margin-top:0px" >
     <!-- if there is a comment, use it -->
	 <if COND="IsVariable.actiontaken=false">
	 <then>
	       <setvar NAME="actiontaken" VALUE="Variables.empty"/>
	 </then>
	 <else>
	   <!-- Encodes unsafe characters-->
	     <STRING.ENCODE VARNAME="actiontaken" VARIABLE="actiontaken"/>
	 </else>
	 </if>
	
	 <if COND="IsVariable.actiontotake=false">
	 <then>
	      <setvar NAME="actiontotake" VALUE="Variables.empty"/>
	 </then>
	 <else>
	   <!-- Encodes unsafe characters -->
	     <STRING.ENCODE VARNAME="actiontotake" VARIABLE="actiontotake"/>
	 </else>
	 </if>

<LOOP LIST="items">
	<WORKFLOWENGINE.GETASSIGNMENTID ID="items.ITEM" OBJVARNAME="wflAssignment"/>
	<WorkflowAssignment.GetAssignedObject NAME="wflAssignment" OBJVARNAME="workflowObject"/>
	<WorkflowAsset.GetAssetId OBJECT="workflowObject" VARNAME="workflow_assetid" />
	<WorkflowAsset.GetAssetType OBJECT="workflowObject" VARNAME="workflow_assettype" />
	<ASSET.LOAD TYPE="Variables.workflow_assettype" OBJECTID="Variables.workflow_assetid" NAME="theAsset"/>
	<ASSET.GET NAME="theAsset" FIELD="name" OUTPUT="assetname"/>
	<ASSET.GET NAME="theAsset" FIELD="description" OUTPUT="assetdesc" />
	

    <callelement NAME="OpenMarket/Xcelerate/Actions/Workflow/CheckCanSetStatus">
         <argument NAME="id" VALUE="Variables.workflow_assetid"/>
         <argument NAME="AssetType" VALUE="Variables.workflow_assettype"/>
         <argument NAME="Step" VALUE="Variables.NextStep"/>
    </callelement>	
    <IF COND="Variables.foundcheckout=true">
    <THEN>
		<STRING.ENCODE VARIABLE="lockedby" VARNAME="lockedby"/>
         <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
             <argument NAME="error" VALUE="CantSetStatusLocked"/>	
             <argument NAME="AssetType" VALUE="Variables.AssetType"/>
             <argument NAME="lockedby" VALUE="Variables.lockedby"/>
         </callelement>
         <REMOVEVAR NAME="error"/>
	</THEN>
	<ELSE>
	  <if COND="IsVariable.assigneeroles=true">
          <then>
                <!-- from set assignees for ask step screen -->
                <WORKFLOWENGINE.GETOBJECTPARTICIPANTS OBJECT="workflowObject" OBJVARNAME="partobj"/> 
    	        <PARTICIPANTS.CLEAR NAME="partobj"/>
                
                <stringlist NAME="AssigneeRoles" STR="Variables.assigneeroles" DELIM=","/>
                <LOOP LIST="AssigneeRoles">
                    <SETVAR NAME="users" VALUE="Variables.ask:AssigneeRoles.ITEM"/>
                    <STRINGLIST STR="Variables.users" NAME="userList" DELIM=";"/>
                    <LOOP LIST="userList">
                         <PARTICIPANTS.ADDPARTICIPANT NAME="partobj" ROLE="AssigneeRoles.ITEM" USER="userList.ITEM"/>
                    </LOOP>
                </LOOP>
                                
                <if COND="IsVariable.actiontotake=false">
                <then>
                    <setvar NAME="actiontotake" VALUE="Variables.empty"/>
                </then>
                </if>
                
                <if COND="IsVariable.actiontaken=false">
                <then>
                    <setvar NAME="actiontaken" VALUE="Variables.empty"/>
                </then>
                </if>
             
                <if COND="Variables.useDefaultDeadline=true">
                <then>
                    <WorkflowEngine.CompleteAssignment ID="items.ITEM" 
                       SITE="SessionVariables.pubid"
                       ACTION="Variables.actiontaken"
                       COMMENT="Variables.actiontotake"
                       NEXTSTEP="Variables.NextStep"
                       ASSIGNMENTLIST="partobj"
                       VARNAME="condcheckfailreason" />
                </then>
                <else>
                    <WorkflowEngine.CompleteAssignment ID="items.ITEM" 
                       SITE="SessionVariables.pubid"
                       ACTION="Variables.actiontaken"
                       COMMENT="Variables.actiontotake"
                       NEXTSTEP="Variables.NextStep"
                       DEADLINE="Variables.deadline"
                       ASSIGNMENTLIST="partobj"
                       VARNAME="condcheckfailreason" />
                </else>
                </if>
          </then>
          <else>

	
		<!--	The asset isn't currently locked, so we should make the transition. -->
			 <if COND="Variables.useDefaultDeadline=true">
              <then>
                    <WorkflowEngine.CompleteAssignment ID="items.ITEM" 
                       SITE="SessionVariables.pubid"
                       ACTION="Variables.actiontaken"
                       COMMENT="Variables.actiontotake"
                       NEXTSTEP="Variables.NextStep"
                       VARNAME="condcheckfailreason" />
              </then>
              <else>
                    <WorkflowEngine.CompleteAssignment ID="items.ITEM" 
                       SITE="SessionVariables.pubid"
                       ACTION="Variables.actiontaken"
                       COMMENT="Variables.actiontotake"
                       NEXTSTEP="Variables.NextStep"
                       DEADLINE="Variables.deadline"
                       VARNAME="condcheckfailreason" />
              </else>
              </if>
              <DIV>
				<IF COND="Variables.errno=0">
				<THEN>
					<IF COND="IsVariable.condcheckfailreason!=true">
					<THEN>
			            <!-- workflow complete success -->
			            <XLAT.LOOKUP KEY="dvin/UI/Assignmentcompletedsuccessfully" VARNAME="_XLAT_"/>
						<SETVAR NAME="msg_txt" VALUE="Variables.assetname"/>
						<SETVAR NAME="msg_txt" VALUE="Variables._XLAT_ - ( Variables.msg_txt )"/>
			          <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			                <argument NAME="msgtext" VALUE="Variables.msg_txt "/> 
			                <argument NAME="severity" VALUE="info"/>
			            </callelement>
	            	</THEN>
					<ELSE>
			            <!-- condition check failure prevented complete success -->
			            <XLAT.LOOKUP KEY="dvin/UI/Admin/Conditiondoesnotallowthisstep" VARNAME="_XLAT_"/>
			            <SETVAR NAME="msg_txt" VALUE="Variables.assetname"/>
						<SETVAR NAME="msg_txt" VALUE="Variables._XLAT_ - ( Variables.msg_txt )"/>
						<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			                <argument NAME="msgtext" VALUE="Variables.msg_txt"/>
			                <argument NAME="severity" VALUE="info"/>
			            </callelement>
		            </ELSE>
					</IF>
				</THEN>
				<ELSE>
			        <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			            <argument NAME="elem" VALUE="CompleteAssignmentFailed"/>
			            <argument NAME="severity" VALUE="error"/>
			        </callelement>
				</ELSE>
				</IF>

			</DIV>
		</else>
		</if>
	
	
	</ELSE>
	</IF>
	<SETVAR NAME="errno" VALUE="0"/>
	<REMOVEVAR NAME="condcheckfailreason"/>
	<REMOVEVAR NAME="elem"/>
</LOOP>
</div>
<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/WorkflowGroupDetailsFront">
	<ARGUMENT NAME="id" VALUE="Variables.groupid"/>
	<ARGUMENT NAME="action" VALUE="contents"/>
</CALLELEMENT>
</then>
<else>
    <if COND="IsVariable.actiontotake=true">
    <then>
        <!-- needs to encode comment before placing in input field -->
        <STRING.ENCODE VARNAME="actiontotake" VARIABLE="actiontotake"/>
        <INPUT TYPE="hidden" NAME="actiontotake" VALUE="Variables.actiontotake" REPLACEALL="Variables.actiontotake"/>
    </then>
    </if>
    
    <if COND="IsVariable.actiontaken=true">
    <then>
        <!-- needs to encode comment before placing in input field -->
        <STRING.ENCODE VARNAME="actiontaken" VARIABLE="actiontaken"/>
        <INPUT TYPE="hidden" NAME="actiontaken" VALUE="Variables.actiontaken" REPLACEALL="Variables.actiontaken"/>
    </then>
    </if>
    <STRING.ENCODE VARNAME="NextStep" VARIABLE="NextStep"/>
    <INPUT TYPE="hidden" NAME="ChooseStep" VALUE="Variables.NextStep" REPLACEALL="Variables.NextStep"/>
	<STRING.ENCODE VARNAME="useDefaultDeadline" VARIABLE="useDefaultDeadline"/>
    <INPUT TYPE="hidden" NAME="useDefaultDeadline" VALUE="Variables.useDefaultDeadline" REPLACEALL="Variables.useDefaultDeadline"/>
    <if COND="Variables.useDefaultDeadline!=true" >
    <then>
		<STRING.ENCODE VARNAME="deadline" VARIABLE="deadline"/>
        <INPUT TYPE="hidden" NAME="deadline" VALUE="Variables.deadline" REPLACEALL="Variables.deadline"/>
    </then>
    </if>
    
    <INPUT type="hidden" name="pagename" value="OpenMarket/Xcelerate/Actions/SetGroupStatusPost" />
	<STRING.ENCODE VARNAME="groupid" VARIABLE="groupid"/>
    <INPUT TYPE="hidden" NAME="groupid" VALUE="Variables.groupid" REPLACEALL="Variables.groupid"/>
	<STRING.ENCODE VARNAME="stateid" VARIABLE="stateid"/>
    <INPUT TYPE="hidden" NAME="stateid" VALUE="Variables.stateid" REPLACEALL="Variables.stateid"/>
	<STRING.ENCODE VARNAME="clearassignments" VARIABLE="clearassignments"/>
    <INPUT TYPE="hidden" NAME="clearassignments" VALUE="Variables.clearassignments" REPLACEALL="Variables.clearassignments"/>

    <callelement NAME="OpenMarket/Xcelerate/Actions/Workflow/SetGroupAssigneesForAskStep">
    	<argument NAME="groupid"   VALUE="Variables.groupid"/>
        <argument NAME="AskStep"   VALUE="Variables.NextStep"/>
    </callelement>
</else>
</if>
</FTCS> 
