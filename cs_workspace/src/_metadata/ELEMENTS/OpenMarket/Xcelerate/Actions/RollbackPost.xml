<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateC/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/RollbackPost.xml $ 
$Revision: 40 $ 
$Modtime: 4/29/04 10:43a $ 
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- RollbackPost.xml
-
- DESCRIPTION
-	The back half of the rollback operation
-
- INPUT
-	Variables.id
-	Variables.AssetType
-	Variables.trackingenabled - should be 'true' 
-  Variables.hasError - true or false
-->
<STRING.ENCODE VARIABLE="id" VARNAME="id"/>
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType" />
<IF COND="Variables.hasError=false">
<THEN>
<!-- Perform a rollback -->
      <history TABLE="Variables.AssetType" ASSET="Variables.id" LIST="ItsHistory"/>
  	   <callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/LockIfNeeded">
         <argument NAME="AssetType" VALUE="Variables.AssetType"/>
         <argument NAME="id" VALUE="Variables.id"/>
         <argument NAME="checkedoutby" VALUE="Rollback"/>
      </callelement>
	    <if COND="Variables.locked=true">
       	<then>
    		    <!-- Add an entry in CheckOutInfo table about this implicit check out -->
    
    		    <if COND="Variables.checkoutmethod=implicit">
    		    <then>
			<usermanager.getloginuser VARNAME="userID"/>
			<implicitcheckout.logimplicitcheckout ASSETTYPE="Variables.AssetType"
				ASSETID="Variables.id" USER="Variables.userID" FUNCTION="Rollback"/>

			    </then>
			    </if>
          </then>
       </if>
    <if COND="IsVariable.rollbackversion=true">
    <then>
	    <setvar NAME="errno" VALUE="0"/>
	    <ASSET.ROLLBACK OBJECTTYPE="Variables.AssetType" OBJECTID="Variables.id" REVISION="Variables.rollbackversion"/>
	    <if COND="Variables.errno!=0">
	    <then>
            <if COND="Variables.errno!=-10094">
            <then>
	    	    <setvar NAME="error" VALUE="RollbackFailed"/>
            </then>
            <else>
                <setvar NAME="errno" VALUE="0"/>
                <setvar NAME="assetWarn" VALUE="assetWarn"/>
            </else>
            </if>
	    </then>
	    </if>    	    	
	 </then>
	 <else>
	 	<setvar NAME="error" VALUE="RollbackNoVersion"/>
	 </else>
	 </if>
    
    <if COND="IsVariable.error=true">
        <then>
            <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
                <argument NAME="error" VALUE="Variables.error"/>
            </callelement>
            <BR/>
		       <if COND="Variables.errdetail!=0">
		       <then>
			        <CALLELEMENT NAME="FutureTense/Apps/AdminForms/RevisionMgt/errors"/>
		  		 </then>
		  		 </if>
        </then>
        <else>


			<!-- Update the updateddate so that an incremental publish will pick up this asset -->
				<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="theCurrentAsset" EDITABLE="true"/>
				<!-- force status to PL -->
				<ASSET.SET NAME="theCurrentAsset" FIELD="updateddate" VALUE="CS.SQLDate"/>
				<ASSET.SAVE NAME="theCurrentAsset"/>
				<IF COND="IsError.Variables.errno=false">
				<THEN>
					<SETVAR NAME="__TreeRefreshKeys__" VALUE="Root:Variables.AssetType;Parent:Variables.id" />
					<IF COND="Variables.cs_environment!=ucform">
					<THEN>
						<STRING.ENCODE VARIABLE="__TreeRefreshKeys__" VARNAME="__TreeRefreshKeys__"/>
						<REPLACEALL LIST="Variables.__TreeRefreshKeys__">
							<SCRIPT LANGUAGE="JavaScript">
								function updateTrees(keys)
								{
									parent.frames["XcelTree"].document.TreeApplet.updateTrees(keys);
								}
								updateTrees('Variables.__TreeRefreshKeys__');
							</SCRIPT>
						</REPLACEALL>
					</THEN>
					</IF>
                <IF COND="IsVariable.assetWarn=true">
                <THEN>
                    <XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/Rollback-MissingAssets" VARNAME="_xlat_success"/>
                    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                        <argument NAME="msgtext" VALUE="Variables._xlat_success"/>
                        <argument NAME="severity" VALUE="info"/>
                    </callelement>
                </THEN>
                <ELSE>
                    <XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/Rollback-Success" VARNAME="_xlat_success"/>
                    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                        <argument NAME="msgtext" VALUE="Variables._xlat_success"/>
                        <argument NAME="severity" VALUE="info"/>
                    </callelement>
                </ELSE>
                </IF>			
            </THEN>
            <ELSE>
                <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                    <argument NAME="elem" VALUE="EnterAssetFailed"/>
                    <argument NAME="severity" VALUE="error"/>
                    <argument NAME="AssetType" VALUE="Variables.AssetType"/>
                </callelement>
            </ELSE>
            </IF>
            <!-- decide whether to unlock record.
         If the item was already locked, then no unlock is
         needed. Else commit it to create a new version-->
    
        <if COND="IsVariable.alreadylocked=true">
        <then>
          <if COND="Variables.alreadylocked!=true">
          <then>
		<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Commit-Asset"/>
		<XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/VersionbyRollback" ENCODE="false" VARNAME="_xlat_version"/>
		<ASSET.CHECKIN NAME="Commit-Asset" ANNOTATION="Variables._xlat_version" CHECKOUT="false"/>
         </then>
         </if>
    
        </then>
        </if>
        </else>
    </if>
    
<!-- Remove entry from CheckOutInfo table about implicit checkout. Assume only one entry in the table -->

	<IMPLICITCHECKOUT.CLEARCHECKOUT ASSETTYPE="Variables.AssetType" ASSETID="Variables.id"/>
</THEN>
</IF> <!-- end hasError=false -->

<IF COND="Variables.cs_environment=ucform">
<THEN>
<SCRIPT type="text/javascript">    
		parent.SitesApp.event('active' , 'goback');	
</SCRIPT>
</THEN>
<ELSE>
	<callelement NAME="OpenMarket/Xcelerate/Actions/ContentDetailsFront">
		<argument NAME="AssetType" VALUE="Variables.AssetType"/>
		<argument NAME="id" VALUE="Variables.id"/>
	</callelement>
</ELSE>
</IF>

</FTCS>
