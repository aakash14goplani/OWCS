<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.2">
<!-- OpenMarket/Xcelerate/Actions/SBSearchPost
-
- INPUT
-
- OUTPUT
-
-->
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType" />
<STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
<STRING.ENCODE VARIABLE="parenttype" VARNAME="parenttype"/>
<STRING.ENCODE VARIABLE="parentid" VARNAME="parentid" />
<STRING.ENCODE VARIABLE="listname" VARNAME="listname" />
<STRING.ENCODE VARIABLE="type" VARNAME="type" />
<if COND="Variables.action=select">
<then>
    <STRINGLIST STR="Variables.assetref" DELIM=";" NAME="assetreflist" />
    <GOTOROW LIST="assetreflist" ROWNUM="2"/>
    <setvar NAME="id" VALUE="assetreflist.ITEM" />
    <asset.load TYPE="Variables.parenttype" EDITABLE="true" OBJECTID="Variables.parentid" NAME="theAsset"/>
    
    <if COND="Variables.cs_environment=addref">
    <then>
        <LISTOBJECT.CREATE NAME="lo" COLUMNS="membertype,memberid,ordinal"/>
        <LISTOBJECT.ADDROW NAME="lo" membertype="Variables.AssetType" memberid="Variables.id" ordinal="0"/>
        <LISTOBJECT.TOLIST NAME="lo" LISTVARNAME="addreflist" />
        <ASSET.ADDMEMBERS NAME="theAsset" FIELD="Variables.parentfield" LIST="addreflist"/>
    </then>
    <else>
        <LISTOBJECT.CREATE NAME="lo" COLUMNS="memberid,newmembertype,newmemberid"/>
        <LISTOBJECT.ADDROW NAME="lo" memberid="Variables.memberid" newmembertype="Variables.AssetType" newmemberid="Variables.id"/>
        <LISTOBJECT.TOLIST NAME="lo" LISTVARNAME="changereflist" />
        <ASSET.CHANGEREF NAME="theAsset" FIELD="Variables.parentfield" LIST="changereflist"/>
    </else>
    </if>

    <!-- run standard PreUpdate, with the InSite updatetype -->
    <IF COND="IsElement.OpenMarket/Xcelerate/AssetType/Variables.parenttype/PreUpdate=true"><THEN>
        <CALLELEMENT NAME="OpenMarket/Xcelerate/AssetType/Variables.parenttype/PreUpdate">
            <ARGUMENT NAME="updatetype" VALUE="InSite"/>
            <ARGUMENT NAME="AssetType" VALUE="Variables.parenttype"/>
            <ARGUMENT NAME="prefix" VALUE="Variables.parenttype:Variables.parentid"/>
            <ARGUMENT NAME="FieldsOnForm" VALUE="Variables.listname"/>
        </CALLELEMENT>
    </THEN></IF> 
    
    <ASSET.SAVE NAME="theAsset" />

    <!-- run standard PostUpdate -->
    <IF COND="IsElement.OpenMarket/Xcelerate/AssetType/Variables.type/PostUpdate=true"><THEN>
        <CALLELEMENT NAME="OpenMarket/Xcelerate/AssetType/Variables.type/PostUpdate">
            <ARGUMENT NAME="updatetype" VALUE="InSite"/>
            <ARGUMENT NAME="prefix" VALUE="Variables.parenttype_Variables.parentid"/>
        </CALLELEMENT>
    </THEN></IF> 

    <callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
        <argument NAME="AssetType" VALUE="Variables.parenttype"/>
    </callelement>
    <if COND="Variables.trackingenabled=true">
    <then>
        <IMPLICITCHECKOUT.IsCheckedOut ASSETID="Variables.parentid" ASSETTYPE="Variables.parenttype" VARNAME="checkoutuser" />
        <IF COND="IsVariable.checkoutuser=true">
        <THEN>
            <UserManager.GetLoginUser VARNAME="loginuser" />
            <if COND="Variables.checkoutuser=Variables.loginuser">
            <then>
                <XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/VersionbyInsiteEdit" VARNAME="_xlat_version"/>
                <ASSET.CHECKIN NAME="theAsset" ANNOTATION="Variables._xlat_version" CHECKOUT="false"/>

                <IMPLICITCHECKOUT.ClearCheckout ASSETID="Variables.parentid" ASSETTYPE="Variables.parenttype" />
            </then>
            </if>
        </THEN>
        </IF>     
    </then>
    </if>    
    
    <script language="JavaScript">
    <![CDATA[                                                                                    
        window.opener.location.reload();
        window.close();
    ]]>
    </script>
    <THROWEXCEPTION/>
</then>
</if>
 
<INPUT TYPE="HIDDEN" NAME="paginate" VALUE="false"/>
<SETVAR NAME="SearchError" VALUE="false"/>
<IF COND="IsError.Variables.errno=true">
<THEN>
    <SETVAR NAME="SearchError" VALUE="true"/>
    <!--  Save errno since AssetMaker SimpleSearch can modify errno -->
    <SETVAR NAME="saveerrno" VALUE="Variables.errno"/>
</THEN>
</IF>

<IF COND="IsVariable.suser!=true">
<THEN>

   <USERMANAGER.GETLOGINUSER  VARNAME="cuserid"/>
   <USERMANAGER.GETLOGINUSERNAME  VARNAME="LoginuserName"/>
   <setvar NAME="suser"  VALUE="Variables.LoginuserName"/>
   
</THEN>
</IF>
   

     
 <!-- Test for a successful search. --> 
<table border="0" cellpadding="0" cellspacing="0">
<IF COND="IsVariable.SaveSearchErrno=true">
<THEN>
      <tr>
             <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                <argument NAME="elem" VALUE="SaveSearch"/>
                <argument NAME="severity" VALUE="error"/>
                <argument NAME="AssetType" VALUE="Variables.AssetType"/>
            </callelement>

      </tr>
</THEN>
</IF>
   
<IF COND="IsVariable.RPP=true">
<THEN>
    <SETVAR NAME="ResultLimit" VALUE="Variables.RPP"/>
</THEN>
</IF>		

<tr>
    <td class="title-text"><XLAT.STREAM KEY="dvin/UI/ListofAssetTypeObjplural"/></td>
</tr>
<tr>
    <td><img height="5" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
</tr>
<tr>
    <td class="dark-line-color"><img height="2" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
</tr>
<tr>
    <td><img height="10" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
</tr>
<tr>
    <td>
        <callelement NAME="OpenMarket/Xcelerate/Actions/Search/SimpleSearch"/>
    </td>
</tr>
<tr>
    <td><img height="10" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
</tr>
</table>

<STRING.ENCODE VARIABLE="filterstring" VARNAME="filterstring"/>
<INPUT type="hidden" name="filterstring" VALUE="Variables.filterstring" REPLACEALL="Variables.filterstring"/>
<!-- Test for a successful search. -->
<IF COND="Variables.SearchError!=true">
<THEN>

	<!-- Display the number of items found. -->

    <table cellpadding="0" cellspacing="0" border="0" WIDTH="98%">
    <tr>
    <td NOWRAP="NOWRAP"><span style="float:right">
    	<SETVAR NAME="TotalResults" VALUE="Content.#numRows"/>
        <CALCULATOR.GO VALUE="Variables.pagenum Variables.ResultLimit *" VARNAME="currCount"/>
        <CALCULATOR.GO VALUE="Variables.TotalResults Variables.currCount GT" VARNAME="MoreResults"/>
        <IF COND="Variables.MoreResults=1">
        <THEN>
            <!-- there are more items left to show -->
            <!-- if we are not on the first page, then we can show a link to the previous page -->
            <IF COND="Variables.pagenum!=1">
            <THEN>

                <CALCULATOR.GO VALUE="Variables.pagenum 1 -" VARNAME="pageprev"/>
                <A HREF="javascript:void(0)" onClick="javascript:document.forms[0].elements['pagename'].value='OpenMarket/Xcelerate/Actions/SBSearchPost';document.forms[0].elements['pagenum'].value=Variables.pageprev;document.forms[0].elements['RPP'].value=Variables.ResultLimit;document.forms[0].elements['paginate'].value='searchpaginate';doSearch();" REPLACEALL="Variables.pageprev,Variables.ResultLimit"><IMG src="Variables.cs_imagedir/graphics/common/icon/leftArrow.gif" HEIGHT="12" WIDTH="11" BORDER="0" REPLACEALL="Variables.cs_imagedir"/><XLAT.STREAM KEY="dvin/UI/PreviousResultLimit"/></A> |
            </THEN>
            </IF>
            
            <CALCULATOR.GO VALUE="Variables.TotalResults Variables.currCount -" VARNAME="numLeft"/>
            <CALCULATOR.GO VALUE="Variables.ResultLimit Variables.numLeft LTE" VARNAME="IsMore"/>
             <CALCULATOR.GO VALUE="Variables.pagenum 1 +" VARNAME="pagenext"/>
            <IF COND="Variables.IsMore=1">
            <THEN>
                <A HREF="javascript:void(0)" onClick="javascript:document.forms[0].elements['pagename'].value='OpenMarket/Xcelerate/Actions/SBSearchPost';document.forms[0].elements['pagenum'].value=Variables.pagenext;document.forms[0].elements['RPP'].value=Variables.ResultLimit;document.forms[0].elements['paginate'].value='searchpaginate'; doSearch();" REPLACEALL="Variables.pagenext,Variables.ResultLimit"><XLAT.STREAM KEY="dvin/Common/Next"/>&nbsp;<STRING.STREAM VALUE="Variables.ResultLimit"/><IMG src="Variables.cs_imagedir/graphics/common/icon/rightArrow.gif" HEIGHT="12" WIDTH="11" BORDER="0" REPLACEALL="Variables.cs_imagedir"/></A>
            </THEN>
            <ELSE>
                <A HREF="javascript:void(0)" onClick="javascript:document.forms[0].elements['pagename'].value='OpenMarket/Xcelerate/Actions/SBSearchPost';document.forms[0].elements['pagenum'].value=Variables.pagenext;document.forms[0].elements['RPP'].value=Variables.ResultLimit;document.forms[0].elements['paginate'].value='searchpaginate';doSearch();" REPLACEALL="Variables.pagenext,Variables.ResultLimit"><XLAT.STREAM KEY="dvin/Common/Next"/>&nbsp;<STRING.STREAM VALUE="Variables.numLeft"/><IMG src="Variables.cs_imagedir/graphics/common/icon/rightArrow.gif" HEIGHT="12" WIDTH="11" BORDER="0" REPLACEALL="Variables.cs_imagedir"/></A>
            </ELSE>
            </IF>
            <SETVAR NAME="LastItem" VALUE="Variables.currCount"/>
        </THEN>
        <ELSE>
            <SETVAR NAME="LastItem" VALUE="Variables.TotalResults"/>
            <!-- there are no more rows after this set -->
            <IF COND="Variables.pagenum!=1">
            <THEN>
                <CALCULATOR.GO VALUE="Variables.pagenum 1 -" VARNAME="pageprev"/>
                <A HREF="javascript:void(0)" onClick="javascript:document.forms[0].elements['pagename'].value='OpenMarket/Xcelerate/Actions/SBSearchPost';document.forms[0].elements['pagenum'].value=Variables.pageprev;document.forms[0].elements['RPP'].value=Variables.ResultLimit;document.forms[0].elements['paginate'].value='searchpaginate';doSearch();" REPLACEALL="Variables.pageprev,Variables.ResultLimit"><IMG src="Variables.cs_imagedir/graphics/common/icon/leftArrow.gif" HEIGHT="12" WIDTH="11" BORDER="0" REPLACEALL="Variables.cs_imagedir"/><XLAT.STREAM KEY="dvin/UI/PreviousResultLimit"/></A> |
            </THEN>
            <ELSE>
            </ELSE>
            </IF>
        </ELSE>
        </IF>
        <CALCULATOR.GO VALUE="Variables.pagenum 1 - Variables.ResultLimit * 1 +" VARNAME="startingPoint"/></span><XLAT.STREAM KEY="dvin/UI/ItemsstartingPointLastItemTotalResults"/> 
                    
        <IF COND="IsVariable.OrderByDesc=true"><THEN> &nbsp; <XLAT.STREAM KEY="dvin/UI/sortedby"/> &nbsp; &quot;<STRING.STREAM VALUE="Variables.OrderByDesc"/>&quot;</THEN></IF>
        <BR />
        <CALCULATOR.GO VALUE="Variables.pagenum 1 +" VARNAME="pagenext"/>

        <INPUT TYPE="HIDDEN" NAME="pagenum" VALUE="1"/>
        <INPUT TYPE="HIDDEN" NAME="RPP" VALUE=""/>
         </td>
        </tr>

        <tr>
            <td><img height="10" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
        </tr>
    	<tr>
    		<td valign="top" class="light-text-color" ><IF COND="IsVariable.filterstring=true"><THEN><STRING.STREAM VALUE="Variables.filterstring"/></THEN></IF>
            </td>
		</tr>
        <tr>
            <td><img height="10" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
        </tr>
		</table>
		<table border="0" cellspacing="0" cellpadding="0">
        <tr>
            <td>
            <!-- Start of search results -->
            <!-- Jason -->
            <callelement NAME="OpenMarket/Xcelerate/ControlPanel/Tile"/>

            <!-- End of search results -->
            </td>
        </tr>
        <tr>
            <td>
                <XLAT.STREAM KEY="dvin/Common/Show"/>&nbsp; 	
                <A HREF="javascript:void(0)" onClick="javascript:document.forms[0].elements['pagename'].value='OpenMarket/Xcelerate/Actions/SBSearchPost';document.forms[0].elements['ResultLimit'].selectedIndex=0;document.forms[0].elements['paginate'].value='true';doSearch();">10</A>&nbsp; 
                <A HREF="javascript:void(0)" onClick="javascript:document.forms[0].elements['pagename'].value='OpenMarket/Xcelerate/Actions/SBSearchPost';document.forms[0].elements['ResultLimit'].selectedIndex=1;document.forms[0].elements['paginate'].value='true';doSearch();">20</A>&nbsp;
                <A HREF="javascript:void(0)" onClick="javascript:document.forms[0].elements['pagename'].value='OpenMarket/Xcelerate/Actions/SBSearchPost';document.forms[0].elements['ResultLimit'].selectedIndex=2;document.forms[0].elements['paginate'].value='true';doSearch();">30</A>&nbsp;
                <A HREF="javascript:void(0)" onClick="javascript:document.forms[0].elements['pagename'].value='OpenMarket/Xcelerate/Actions/SBSearchPost';document.forms[0].elements['ResultLimit'].selectedIndex=3;document.forms[0].elements['paginate'].value='true';doSearch();">50</A>&nbsp;
                <A HREF="javascript:void(0)" onClick="javascript:document.forms[0].elements['pagename'].value='OpenMarket/Xcelerate/Actions/SBSearchPost';document.forms[0].elements['ResultLimit'].selectedIndex=4;document.forms[0].elements['paginate'].value='true';doSearch();">100</A>&nbsp;
                <A HREF="javascript:void(0)" onClick="javascript:document.forms[0].elements['pagename'].value='OpenMarket/Xcelerate/Actions/SBSearchPost';document.forms[0].elements['ResultLimit'].selectedIndex=5;document.forms[0].elements['paginate'].value='true';doSearch();">200</A>&nbsp;
                <A HREF="javascript:void(0)" onClick="javascript:document.forms[0].elements['pagename'].value='OpenMarket/Xcelerate/Actions/SBSearchPost';document.forms[0].elements['ResultLimit'].selectedIndex=6;document.forms[0].elements['paginate'].value='true';doSearch();">300</A>&nbsp;
                <XLAT.STREAM KEY="dvin/UI/itemsperpage"/>
            </td>
        </tr>
		</table>
		</THEN>
		<!-- Display an appropriate search failure message. -->
		<ELSE>
		<table border="0" cellspacing="0" cellpadding="0">
            <IF COND="IsVariable.filterstring=true">
             <THEN>
     			<tr>
                    <td valign="top" class="light-text-color" ><STRING.STREAM VALUE="Variables.filterstring"/> </td>
      				<td></td>
      			</tr>

                <tr>
                    <td><img height="10" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
                </tr>
            </THEN>
             </IF>
 			<tr>
			<IF COND="Variables.saveerrno=-101">
			<THEN>
				<!-- [insert a callelement for in informational message] -->

				<td><span class="alert-color"><XLAT.STREAM KEY="dvin/UI/NoAssetTypeObjpluralwerefound"/></span>
 				<img height="11" width="10" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/>
 
                    <!--XLAT.LOOKUP KEY="dvin/UI/Savelcthislcsearch" VARNAME="_XLAT_"/>
                    <XLAT.LOOKUP KEY="dvin/UI/Savelcthislcsearch" VARNAME="mouseover" ESCAPE="true"/>
                    (<A HREF="javascript:savethisSearch('Variables.suser');" OnMouseOver="window.status='Variables.mouseover'; return true" OnMouseOut="return window.status='';" title="Variables._XLAT_" REPLACEALL="Variables.suser,Variables._XLAT_,Variables.mouseover"><XLAT.STREAM KEY="dvin/UI/SaveThisSearch"/></A>)
                    -->
                </td>
			</THEN>
			<ELSE>
			   <!-- [insert a callelement for in informational message] -->
				<td><span class="alert-color"><XLAT.STREAM KEY="dvin/UI/Invalidsearchcriteria"/></span></td>
			</ELSE>
			</IF>
			</tr>
		</table>
		</ELSE>
		</IF>

		<!-- Display the page footer. -->

        <input type="hidden" name="action" value="search" />
        <if COND="Variables.cs_environment=popup">
        <then>
			<STRING.ENCODE VARIABLE="idwhere" VARNAME="idwhere"/>
            <input type="hidden" name="idwhere" value="Variables.idwhere" replaceall="Variables.idwhere" />
			<STRING.ENCODE VARIABLE="where" VARNAME="where"/>
            <input type="hidden" name="where" value="Variables.where" replaceall="Variables.where" />
        </then>
        </if>

        <if COND="Variables.cs_environment=addref">
        <then>
			<STRING.ENCODE VARIABLE="parentid" VARNAME="parentid"/>
			<input type="hidden" name="parentid" value="Variables.parentid" replaceall="Variables.parentid" />
			<STRING.ENCODE VARIABLE="parenttype" VARNAME="parenttype"/>
			<input type="hidden" name="parenttype" value="Variables.parenttype" replaceall="Variables.parenttype" />
			<STRING.ENCODE VARIABLE="parentfield" VARNAME="parentfield"/>
			<input type="hidden" name="parentfield" value="Variables.parentfield" replaceall="Variables.parentfield" />
        </then>
        </if>


<if COND="Variables.cs_environment=changeref">
<then>
	<STRING.ENCODE VARIABLE="parentid" VARNAME="parentid"/>
    <input type="hidden" name="parentid" VALUE="Variables.parentid" replaceall="Variables.parentid" />
	<STRING.ENCODE VARIABLE="parenttype" VARNAME="parenttype"/>
    <input type="hidden" name="parenttype" VALUE="Variables.parenttype" replaceall="Variables.parenttype" />
	<STRING.ENCODE VARIABLE="parentfield" VARNAME="parentfield"/>
    <input type="hidden" name="parentfield" VALUE="Variables.parentfield" replaceall="Variables.parentfield" />
	<STRING.ENCODE VARIABLE="memberid" VARNAME="memberid"/>
    <input type="hidden" name="memberid" VALUE="Variables.memberid" replaceall="Variables.memberid" />
</then>
</if>

</FTCS>
