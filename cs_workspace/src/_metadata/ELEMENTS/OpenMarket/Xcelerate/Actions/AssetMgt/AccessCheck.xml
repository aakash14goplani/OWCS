<?xml version="1.0" ?>
<!DOCTYPE ftcs SYSTEM "futuretense_cs.dtd">
<ftcs version="1.2">
<!-- OpenMarket/Xcelerate/Actions/AssetMgt/AccessCheck
- element called to check whether user can access this asset for the desired function
-
- INPUT
-	Variables.assetObjectName
-  Variables.pubid
-  Variables.AssetType
-  Variables.id
-  Variables.Function - edit, inspect, delete, status, approve, etc.
- OUTPUT
-  error - name of Error element to display for error condition
-	errno - possibly
-->

<SETVAR NAME="reterrno" VALUE="0"/>
<SETVAR NAME="error" VALUE="Variables.empty"/>

<IF COND="IsVariable.pubid=true">
<THEN>
   <SETVAR NAME="temppubid" VALUE="Variables.pubid"/>
</THEN>
<ELSE>
   <SETVAR NAME="temppubid" VALUE="SessionVariables.pubid"/>
</ELSE>
</IF>

<!-- Check whether the asset is in this site and therefore if it can be viewed here -->
<ASSET.SITES NAME="Variables.assetObjectName" LIST="pubCheck" PUBID="Variables.temppubid"/>
<if COND="IsError.Variables.errno=true">
<then>
	<SETVAR NAME="reterrno" VALUE="Variables.errno"/>
	<setvar NAME="error" VALUE="AssetNotInUsersSite"/>
</then>
<else>
	<!-- Check whether asset has been voided -->
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="status" OUTPUT="asset:status"/>
	<IF COND="Variables.asset:status=VO">
	<THEN>			 
		<!-- consult cs_environment if coming from NEW  UI Contributor  
		     Error with smart close tab message element 
		  -->
 		<IF COND="Variables.cs_environment=ucform">
	    <THEN>
	     	<setvar NAME="error" VALUE="CantEditVoidedAssetInTab"/>
		</THEN>
		<ELSE> 
			<setvar NAME="error" VALUE="CantEditVoidedAsset"/>
		</ELSE>   
		</IF>
		 <SETVAR NAME="reterrno" VALUE="-12077"/>
	</THEN>
	<ELSE>
		
		<!-- further checks if function edits the asset -->
		<SETVAR NAME="errno" VALUE="0"/>
		<SETVAR NAME="noneditingFunctions" VALUE="inspect,authorize,preview,showstatus"/>
		<ISINLIST ITEM="Variables.Function" STR="Variables.noneditingFunctions"/>
		
		<!-- for all functions that edit the asset (i.e. not inspect ), check that publish is not running -->
		<IF COND="Variables.errno=0">
		<THEN>
			<ASSET.GET NAME="Variables.assetObjectName" FIELD="id" OUTPUT="id"/>
			<!-- if a publish is in progress that involves this asset we cannot proceed -->
			<ASSET.CANEDIT NAME="Variables.assetObjectName"/>
			<if COND="IsError.Variables.errno=true">
			<then>  
				<SETVAR NAME="error" VALUE="EditNotAllowed"/> 	      
				<SETVAR NAME="reterrno" VALUE="Variables.errno"/>			
			 </then>
			</if>
		
			<!-- do check workflow check privileges -->
		    <callelement NAME="OpenMarket/Xcelerate/Actions/Workflow/CheckPrivs">
		        <argument NAME="AssetType" VALUE="Variables.AssetType"/>
		        <argument NAME="assetObjectName" VALUE="Variables.assetObjectName"/>
		        <argument NAME="Function" VALUE="Variables.Function"/>
		    </callelement>
		    <if COND="Variables.PrivsFailed=true">
			<then>
				<setvar NAME="error" VALUE="Variables.PrivsFailedReason"/>
				<SETVAR NAME="reterrno" VALUE="Variables.errno"/>
			</then>
			</if>
		</THEN>
		<ELSE>
			<IF COND="Variable.errno=1">
			<THEN>
				<SETVAR NAME="reterrno" VALUE="0"/>
			</THEN>
			</IF>
		</ELSE>
		</IF>
	</ELSE>
	</IF>
</else>
</if>
<SETVAR NAME="errno" VALUE="Variables.reterrno"/>

</ftcs>