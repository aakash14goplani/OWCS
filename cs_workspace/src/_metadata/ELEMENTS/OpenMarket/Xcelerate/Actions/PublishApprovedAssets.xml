<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/PublishApprovedAssets.xml $ 
$Revision: 27 $ 
$Modtime: 9/15/04 3:01p $ 
-->

    <!--
    - Confidential and Proprietary Information of FutureTense Inc.
    -					All Rights Reserved.
    -
    - DESCRIPTION
    -    Run a publish session in batch thread
    -
    - INPUT
    -    Variables.target -- id of publishing target
    -    Variables.publishedby -- username
    -
    - OUTPUT
    -    Variables.pubsess:id -- pubsession id
    -
    - HISTORY
    -->

    <setvar NAME="pubsess_created" VALUE="false" />

    <!-- check if any assets need to be published -->
    <if COND="IsError.Variables.errno=false">
<then>
    <if COND="Variables.ISIMPORT!=true">
    <then>
         <if COND="Variables.publishOnDemandQueue=true">
         <then>
             <ApprovedAssets.GetAssetsToPublishOnDemand TARGET="Variables.target" PREFIX="PublishableAssets" ONDEMANDMAP="ODQueue:Variables.target"/>
        </then>
        <else>
            <ApprovedAssets.GetAssetsToPublish TARGET="Variables.target" PREFIX="PublishableAssets" />
        </else>
        </if>
    </then>
    </if>
    
    <if COND="IsError.Variables.errno=true">
	<then>     
		 <P><XLAT.STREAM KEY="dvin/UI/Error/notgetpublishableassetserrno2" errno="Variables.errno" EVALALL="false" /><BR/>
		 <STRING.STREAM VALUE="Variables.errdetail1"/>
		 </P>
	</then>
	<else>
		<if COND="IsVariable.PublishableAssetsTotal=true">
		<then>
		  <if COND="Variables.PublishableAssetsTotal!=0">
		  <then>
				<!-- create pubsession, only when there is something to publish -->
			  <PUBSESSIONMANAGER.CREATE TARGET="Variables.target" USER="Variables.publishedby" VARNAME="pubsess:id" />
				<if COND="IsError.Variables.errno=true">
				<then>
					  <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
					 <argument NAME="error" VALUE="PubSessionCreate" />
					  </callelement>
				</then>
				<else>
					  <setvar NAME="pubsess_created" VALUE="true" />
				</else>
				</if>
		  </then>
		  </if>


        </then>
		</if>
		
		<IF COND="Variables.pubsess_created!=true">
		<THEN>
			<!-- Also create a pubsession if there are tags to publish TODO: this depends on target type-->
			<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Publish/CountTagsToPublish">
				<ARGUMENT NAME="target" VALUE="Variables.target"/>
			</CALLELEMENT>
			<IF COND="Variables.PublishableTagsCount!=0">
			<THEN>
				<!-- create pubsession, only when there is something to publish -->
				  <PUBSESSIONMANAGER.CREATE TARGET="Variables.target" USER="Variables.publishedby" VARNAME="pubsess:id" />
					<if COND="IsError.Variables.errno=true">
					<then>
						  <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
						 <argument NAME="error" VALUE="PubSessionCreate" />
						  </callelement>
					</then>
					<else>
						  <setvar NAME="pubsess_created" VALUE="true" />
					</else>
					</if>
			</THEN>
			</IF>
		</THEN>
		</IF>
	</else>
	</if>
</then>
</if>

    <if COND="Variables.pubsess_created!=true">
        <then>
    <if COND="Variables.ISIMPORT=true">
    <then>
            <!-- create import pubsession -->
      <PUBSESSIONMANAGER.CREATE TARGET="Variables.target" USER="Variables.publishedby" VARNAME="pubsess:id" />
        <if COND="IsError.Variables.errno=true">
        <then>
              <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
             <argument NAME="error" VALUE="PubSessionCreate" />
              </callelement>
        </then>
        <else>
              <setvar NAME="pubsess_created" VALUE="true" />
        </else>
        </if>
    </then>
    </if>
    </then>
    </if>

    <!-- start background publishing -->
    <if COND="Variables.pubsess_created=true">
<then>
    <if cond="Variables.cs_environment=portal">
    <then>
        <callelement NAME="OpenMarket/Flame/Common/Script/RefreshPortal" />
    </then>
    </if>
	<if COND="Variables.publishOnDemandQueue=true">
	<then>
     <PUBLISHCLIENT.PUBLISH PAGENAME="OpenMarket/Xcelerate/Actions/BatchPublish" TARGETID="Variables.target"
                            PUBSESSIONID="Variables.pubsess:id" ONDEMANDQUEUE="true" ISIMPORT="Variables.ISIMPORT"
                            PKGNAME="Variables.pkgname" RUNMODE="Variables.runmode" SITES="Variables.sites"/>
	 </then>
	 <else>
		<PUBLISHCLIENT.PUBLISH PAGENAME="OpenMarket/Xcelerate/Actions/BatchPublish" TARGETID="Variables.target"
                               PUBSESSIONID="Variables.pubsess:id" ISIMPORT="Variables.ISIMPORT"
                               PKGNAME="Variables.pkgname" RUNMODE="Variables.runmode" SITES="Variables.sites"/>
	 </else>
	 </if>
</then>
</if>

</FTCS>

