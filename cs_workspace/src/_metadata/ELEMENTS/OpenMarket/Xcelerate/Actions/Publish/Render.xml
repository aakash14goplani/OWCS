<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!--
$Logfile: /VerticalApps/XcelerateC/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/Publish/Render.xml $
$Revision: 52 $
$Modtime: 3/29/04 3:08p $
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- Render.xml
-
- DESCRIPTION
-    SiteCatalog rendering function.  Called by URL (via SiteCatalog entries
-    which point at this) or called directly by the Render element.
-    This loads the "primary" asset, computes the Template and calls the
-    rootelement.
-
-    If a publication id has not been established in the session variable
-    "pubid", then a publication will be established by a call to the element
-    named by the property xcelerate.SetPub.  If it fails to set pubid then 
-    rendering cannot proceed.  This call only happens on the first page of
-    each visitor's session.
-
- INPUT
-    Variables.c		Asset type name
-    variables.cid		Asset ID
-    Variables.rendermode	(optional) "preview", "export", or "live".
-    				Default is live.
-    Variables.t		(optional) Override template name. Default is
-    				computed by Asset.getTemplate.
-    Variables.p		(optional) Parent Page asset's ID.
-				If the selected asset is a Page, p is overridden.
-    SessionVariables.pubid	(optional) publication id.
-
- OUTPUT
-    SessionVariables.render:errno
-    				This is set if an error occurred.
-->
<STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
<STRING.ENCODE VARIABLE="cs_formmode" VARNAME="cs_formmode"/>
<STRING.ENCODE VARIABLE="cs_environment" VARNAME="cs_environment"/>
<if COND="IsVariable.c!=true">
<then>
    <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
        <argument NAME="error" VALUE="NoContentCategory"/>
        <argument NAME="errorbyemail" VALUE="false"/>
    </callelement>
</then>
<else>
    <if COND="IsVariable.cid!=true">
    <then>
        <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
            <argument NAME="error" VALUE="NoContentId"/>
            <argument NAME="errorbyemail" VALUE="false"/>
        </callelement>
    </then>
    <else>
    	<!--Establish the pubid session variable-->
    	<if COND="IsSessionVariable.pubid=false">
    	<then>
    	    <!-- Not there.  Log this new visitor in.  -->
    		<PROPERTY.GET PARAM="xcelelem.setpubid" INIFILE="futuretense_xcel.ini" VARNAME="propsetpubid"/>
    	    <callelement NAME="Variables.propsetpubid"/>
    	    <if COND="IsSessionVariable.pubid=false">
    	    <then>
        		<!-- Abrupt termination of rendering since we are w/o a pubid -->
        		<callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
        		    <argument NAME="error" VALUE="NoPubid"/>
        		    <argument NAME="errorbyemail" VALUE="false"/>
        		</callelement>
        		<throwexception/>
    	    </then>
    	    </if>
    	</then>
    	</if>
    
    	<!-- Default rendermode to live, if missing -->
    	<if COND="IsVariable.rendermode=false">
    	<then>
    	    <setvar NAME="rendermode" VALUE="live"/>
    	</then>
    	</if>
    
    	<!-- Henceforth, error message reporting is deferred -->
    	<setvar NAME="render:doproceed" VALUE="true"/>
    
    	<!--
    	- Load the selected asset
    	-->
    	<ASSET.LOAD TYPE="Variables.c" OBJECTID="Variables.cid" NAME="asset"/>
    
    	<if COND="IsError.Variables.errno=true">
    	<then>
    	    <setssvar NAME="render:errno" VALUE="Variables.errno"/>
    	    <setvar NAME="render:doproceed" VALUE="InvalidContentId"/>
    
    	    <if COND="Variables.rendermode=preview">
    	    <then>
    		<!--Use description instead of name for assettype-->
        		<ASSETTYPE.LOAD NAME="type" TYPE="Variables.c"/>
        		<ASSETTYPE.GET NAME="type" FIELD="description" OUTPUT="ATdesc"/>
    	        <HR/><FONT COLOR="#FF0000"><STRONG><XLAT.STREAM KEY="dvin/UI/Publish/PREVIEWWARNINGnotfindassetATdesccid"/></STRONG></FONT><HR/>
    	        <removessvar NAME="render:errno"/>
    	    </then>
    	    </if>
    	</then>
    	<else>
    	    <ASSET.SCATTER NAME="asset" PREFIX="asset"/>
    
    	    <!--If this is a Page, override p -->
    	    <if COND="Variables.c=Page">
    	    <then>
    	        <ASSET.SITEPARENT NAME="asset" OUTNAME="render:parent"/>
        		<if COND="IsError.Variables.errno=false">
        		<then>
        		    <ASSET.GET NAME="render:parent" FIELD="id" OUTPUT="p"/>
        		</then>
        		</if>
    	    </then>
    	    </if>
    
            <!-- get root element -->
            <if COND="IsVariable.t=true">
            <then>
                <ASSET.GETTEMPLATEROOTELEMENT NAME="asset" OUTPUT="render:element" TEMPLATE="Variables.t"/>
            </then>
            <else>
                <ASSET.GETTEMPLATEROOTELEMENT NAME="asset" OUTPUT="render:element"/>
            </else>
            </if>
     
    	    <if COND="Variables.errno!=0">
    	    <then>
        		<setssvar NAME="render:errno" VALUE="Variables.errno"/>
        		<setvar NAME="render:doproceed" VALUE="NoTemplate"/>
                <if COND="IsVariable.t=true">
                <then> 
        		    <setvar NAME="render:name" VALUE="Variables.t"/>
                </then>
                </if>
    	    </then>
    	    </if>
    
    	    <!--
    	    - Call the Template's rootelement
    	    -->
    	    <if COND="Variables.render:doproceed=true">
    	    <then>
        		<if COND="IsElement.Variables.render:element=true">
        		<then>
        			<callelement NAME="Variables.render:element" />
        
        		    <if COND="IsError.Variables.errno=true">
        		    <then>
            			<setssvar NAME="render:errno" VALUE="Variables.errno"/>
            			<!--
            			- The element code failed internally.  The Template
            			- developer should display a custom message.
            			- We only display the errno (below).
            			-->
            			<setvar NAME="render:doproceed" VALUE="Variables.empty"/>
        		    </then>
        		    </if>
        		</then>
        		<else>
                    <if COND="IsVariable.t=true">
                    <then>
                        <ASSET.GETTEMPLATE NAME="asset" TEMPLATE="Variables.t" OUT="templateobj" />
                    </then>
                    <else>
                        <ASSET.GETTEMPLATE NAME="asset" OUT="templateobj" />
               		</else>
            		</if>
                    <ASSET.GET NAME="templateobj" FIELD="id" OUTPUT="render:id" />
                    <ASSET.GET NAME="templateobj" FIELD="name" OUTPUT="render:name" />
        		    <setvar NAME="render:doproceed" VALUE="NoTemplateElement"/>
        		</else>
        		</if>
    	    </then>
    	    </if>
    
    	    <if COND="IsSessionVariable.render:errno=true">
    	    <then>
        		<if COND="Variables.rendermode=preview">
        		<then>
        			<ASSETTYPE.LOAD NAME="type" TYPE="Variables.c"/>
        			<ASSETTYPE.GET NAME="type" FIELD="description" OUTPUT="ATdesc"/>
    
    	            <HR/><FONT COLOR="#FF0000"><STRONG><XLAT.STREAM KEY="dvin/UI/Publish/PREVIEWWARNINGRendererrorwhileAsset"/></STRONG></FONT><HR/>
    		        <removessvar NAME="render:errno"/>
        		</then>
        		</if>
    	    </then>
    	    </if>
    	</else>
    	</if>
    
    	<if COND="Variables.render:doproceed!=true">
    	<then>
    	    <if COND="Variables.render:doproceed!=Variables.empty">
    	    <then>
        		<table>
                <tr>
                    <td>
            		<callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
            		    <argument NAME="error" VALUE="Variables.render:doproceed"/>
            		    <argument NAME="AssetType" VALUE="Variables.c"/>
            		    <argument NAME="id" VALUE="Variables.cid"/>
            		    <argument NAME="errorbyemail" VALUE="false"/>
            		</callelement>
        		    </td>
                </tr>
                </table>
    	    </then>
    	    </if>
    	</then>
    	</if>
    </else>
    </if>
</else>
</if>

</FTCS>
 
