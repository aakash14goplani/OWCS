<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateB/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/Publish/GetURL.xml $ 
$Revision: 22 $ 
$Modtime: 10/30/02 2:08p $ 
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- GetURL.xml
-
- DESCRIPTION
-    This is the standard code for constructing a URL to refer to an asset.
-    The URL varies depending on the current rendering mode, dynamic or static.
-    Preview and live sites require a dynamic URL.  Export to Disk will
-    want static URLs.  The cue is the variable "urltype", which is set
-    by a variable in te resargs of the current page.
-
-    If a particular asset type must override the behavior of GetURL, it can
-    define its own element.  The asset will have been pre-loaded and 
-    scattered.  The handle is Variables.GetURL:handle, and the scatter
-    prefix is "GetURLAsset".  If that override element sets the variable
-    GetURL:continue to "false", then this standard element takes no further
-    action.
-
- INPUT
-    render:pubsession		Object name of loaded PubSession.
-    Variable.pubfact:URLPREFIX	The prefix for static URLs.  This comes from
-    				the publish target factors, and the variable is
-    				automatically defined by Render during Export
-				and other static delivery types.
-    Variables.urltype		URL type, "static" or "dynamic".  Optional.
-    				If missing, default is "dynamic".  Live pages
-				can omit this.
-    Variables.pubfact:depth	(required if urltype is static). How many
-    				URL links should be followed.  0 for no limit.
-    Variables.PARENTID		Parent page asset ID.  Overrides Variables.cid.
-    Variables.TEMPLATE		Override template name.  Optional.  If missing,
-    				the asset's "template" field value is used.
-    Variables.EXPORT		(optional) "true" means the referenced asset
-    				will be queued for publishing if urltype=static.
-				"false" means it won't be.  
-				The default is "true".
-				Use "false" to prevent "up" links from causing
-				the entire site to be published when publishing
-				Listed+Linked. (Despite the name EXPORT, this
-				argument applies to any static delivery type.)
-    Variables.c		(optional) Name of the Asset type of the 
-    				referencing asset.
-    Variables.cid		(optional) ID of the referencing asset.  
-    				Overrides p if cid is "Page".
-    Variables.PAGENAME         (optional) overrides Variables.pagename. 
-                               Changing the pagename is useful so you can 
-                               control page caching behavior. 
-                               Default is same as referencing page's pagename. 
-                               If there is no referencing page, the default is 
-                               OpenMarket/Xcelerate/preview if rendermode=preview, 
-                               OpenMarket/Xcelerate/Export if rendermode=export, 
-                               and OpenMarket/Xcelerate/Render for all other 
-                               values of rendermode.
-    Variables.rendermode       (optional)the kind of rendering being performed. 
-                               Normally this variable is set as a resarg in the 
-                               SiteCatalog. Recognized modes are live, preview, 
-                               and export. The default is "live".
-    Variables.inifile          (optional)overrides the default inifile value list. 
-                               The default is "futuretense.ini;futuretense_xcel.ini".
-                               Property ft.cgipath - used when generating the URL
-                               Property ft.approot - used when generating the URL
-    Variables.p		(optional) Parent page asset ID.  
-				Reserved for future use.
-
- ...Asset selection is done using one of the following argument combinations:
-    Variables.NAME		Loaded asset's object handle.  This is the
-    				asset which is the target of the URL.
- ...or
-    Variables.NAME		Loaded asset's object handle.  This is the 
-    				"parent" asset in an asset association.
-    Variables.CODE		Association name of the child to point to.
-    				This asset does not have to be loaded. This is
-    				the asset which is the target of the URL.
- ...or
-    Variables.TYPE		Asset type name of the target asset.
-    Variables.OBJECTID		Asset ID of the target asset.
-    Variables.OBJECTVERSION	Optional version of the target asset.  
-    				This is reserved for future use.  Do not
-				pass it until Open Market readies the 
-				interface.
-
- OUTPUT
-    Variables.referURL
-
- SCRATCH
-    Variables.GetURL*		Temporary names for variables, lists, and such.
-->

<!-- Debug to log if uncommented: ->
    <LOGMSG STR="TRACE GetURL TRACE"/>
    <LOGMSG STR="Current asset: Variables.asset:name (Variables.c #Variables.cid)"/>
    <LOGMSG STR="NAME: Variables.NAME"/>
    <LOGMSG STR="CODE: Variables.CODE"/>
    <LOGMSG STR="TYPE: Variables.TYPE"/>
    <LOGMSG STR="OBJECTID: Variables.OBJECTID"/>
    <LOGMSG STR="TEMPLATE: Variables.TEMPLATE"/>
    <LOGMSG STR="EXPORT: Variables.EXPORT"/>
    <LOGMSG STR="PARENTID: Variables.PARENTID"/>
    <LOGMSG STR="pagename: Variables.pagename"/>
    <LOGMSG STR="inifile: Variables.inifile"/>
    <LOGMSG STR="pubid: SessionVariables.pubid"/>
    <LOGMSG STR="rendermode: Variables.rendermode"/>
    <LOGMSG STR="urltype: Variables.urltype"/>
<!-end debug-->

<!-- Default parentid -->
<if COND="IsVariable.PARENTID=true">
<then>
    <setvar NAME="GetURL:parentid" VALUE="Variables.PARENTID"/>
</then>
<else>
    <if COND="Variables.c=Page">
    <then>
        <setvar NAME="GetURL:parentid" VALUE="Variables.cid"/>
    </then>
    </if>
</else>
</if>

<!--
- Precompute where to place each generated URL
-->

<BEGINS STR="Variables.rendermode" WHAT="export"/>
<IF COND="Variables.errno=1">
<THEN>
    <setvar NAME="urltype" VALUE="static"/>
</THEN>
</IF>

<if COND="IsVariable.urltype=false">
<then>
    <setvar NAME="urltype" VALUE="dynamic"/>
</then>
</if>

<if COND="Variables.urltype=static">
<then>
    <setvar NAME="GetURL:static" VALUE="referURL"/>
    <setvar NAME="GetURL:dynamic" VALUE="GetURL:notUsed"/>
</then>
<else>
    <setvar NAME="GetURL:static" VALUE="GetURL:notUsed"/>
    <setvar NAME="GetURL:dynamic" VALUE="referURL"/>
</else>
</if>

<setvar NAME="errno" VALUE="0"/>

<if COND="IsVariable.CODE=true">
<then>
    <!-- NAME + CODE -->
    <setvar NAME="GetURL:handle" VALUE="GetURL:tempHandle"/>
    <ASSET.CHILDREN LIST="GetURL:child" CODE="Variables.CODE" NAME="Variables.NAME"/>
    <if COND="IsError.Variables.errno=false">
    <then>
        <setvar NAME="GetURL:AssetType" VALUE="GetURL:child.otype"/>
        <setvar NAME="GetURL:id" VALUE="GetURL:child.oid"/>
        <setvar NAME="GetURL:version" VALUE="GetURL:child.oversion"/>
    </then>
    </if>
</then>
<else>
    <if COND="IsVariable.NAME=true">
    <then>
        <!-- NAME only -->
        <setvar NAME="GetURL:handle" VALUE="Variables.NAME"/>
        <setvar NAME="GetURL:AssetLoaded" VALUE="true"/>
        <ASSET.GETASSETTYPE NAME="Variables.NAME" OUTNAME="GetURL:AssetTypeObj"/>
        <ASSETTYPE.GET NAME="GetURL:AssetTypeObj" FIELD="assettype" OUTPUT="GetURL:AssetType"/>
        <ASSET.GET NAME="Variables.NAME" FIELD="id" OUTPUT="GetURL:id"/>
        <ASSET.GET NAME="Variables.NAME" FIELD="version" OUTPUT="GetURL:version"/>
    </then>
    <else>
        <!-- TYPE, OBJECTID and OBJECTVERSION -->
        <setvar NAME="GetURL:handle" VALUE="GetURL:tempHandle"/>
        <setvar NAME="GetURL:AssetType" VALUE="Variables.TYPE"/>
        <setvar NAME="GetURL:id" VALUE="Variables.OBJECTID"/>
        <setvar NAME="GetURL:version" VALUE="Variables.OBJECTVERSION"/>
    </else>
    </if>
</else>
</if>

<!--
- Call override element, if it exists.
-->
<setvar NAME="GetURL:overrideElement" VALUE="OpenMarket/Xcelerate/AssetType/Variables.GetURL:AssetType/GetURL"/>
<setvar NAME="GetURL:continue" VALUE="true"/>
<if COND="IsElement.Variables.GetURL:overrideElement=true">
<then>
   <callelement NAME="Variables.GetURL:overrideElement"/>
   <!-- It set continue to false if it failed or it computed referURL -->
</then>
</if>

<!--
-call RENDER.GETURL
-->
<if COND="Variables.GetURL:continue=true">
<then>
    <!-- Save pagename value, which is used by RENDER.GETURL, in pagenametmp
         and set pagename value to optional input argument PAGENAME. -->
    <IF COND="IsVariable.PAGENAME=true">
    <THEN>
        <IF COND="Variables.PAGENAME!=Variables.empty">
        <THEN>
            <IF COND="IsVariable.pagename=true">
            <THEN>
               <setvar NAME="GetURL:pagenametmp" VALUE="Variables.pagename"/>
            </THEN>
            </IF>
            <setvar NAME="pagename" VALUE="Variables.PAGENAME"/>

        </THEN>
        </IF>
    </THEN>
    </IF>
    
    <BEGINS STR="Variables.rendermode" WHAT="export"/>
    <IF COND="Variables.errno=1">
    <THEN>
    
        <IF COND="IsVariable.EXPORT=false">
        <THEN>
            <SETVAR NAME="EXPORT" VALUE="true" />
        </THEN>
        </IF>
        
        <IF COND="IsVariable.TEMPLATE=true">
        <THEN>
            <RENDER.GETPAGEURL PAGENAME="OpenMarket/Xcelerate/Export" 
                cid="Variables.GetURL:id" 
                p="Variables.GetURL:parentid"
                c="Variables.GetURL:AssetType"
                EXPORT="Variables.EXPORT"
                ARGS_t="Variables.TEMPLATE"
                OUTSTR="Variables.GetURL:static" />
        </THEN>
        <ELSE>
            <RENDER.GETPAGEURL PAGENAME="OpenMarket/Xcelerate/Export" 
                cid="Variables.GetURL:id" 
                p="Variables.GetURL:parentid"
                c="Variables.GetURL:AssetType"
                EXPORT="Variables.EXPORT"
                OUTSTR="Variables.GetURL:static" />
        </ELSE>
        </IF>
    </THEN>
    <ELSE>
          <RENDER.GETURL 
	      TYPE="Variables.GetURL:AssetType"
	      OBJECTID="Variables.GetURL:id"
	      OBJECTVERSION="Variables.GetURL:version"
	      TEMPLATEVAR="TEMPLATE"
	      PARENTIDVAR="GetURL:parentid"
	      EXPORTURL="Variables.GetURL:static"
	      CSURL="Variables.GetURL:dynamic"/>
    </ELSE>
    </IF>

    <!-- Restore original value of the pagename -->
    <IF COND="IsVariable.GetURL:pagenametmp=true">
    <THEN>
       <setvar NAME="pagename" VALUE="Variables.GetURL:pagenametmp"/>
       <REMOVEVAR NAME="GetURL:pagenametmp"/>
    </THEN>
    </IF>
        
</then>
</if>

<REMOVEVAR NAME="NAME"/>
<REMOVEVAR NAME="CODE"/>
<REMOVEVAR NAME="TYPE"/>
<REMOVEVAR NAME="OBJECTID"/>
<REMOVEVAR NAME="OBJECTVERSION"/>
<REMOVEVAR NAME="TEMPLATE"/>
<REMOVEVAR NAME="PARENTID"/>
<REMOVEVAR NAME="EXPORT"/>
<REMOVEVAR NAME="GetURL:parentid"/>
<REMOVEVAR NAME="GetURL:AssetLoaded"/>

</FTCS>
