<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Actions/BrowseAssetChildren
-
- INPUT
-
- OUTPUT
-
-->

<STRING.ENCODE VARIABLE="c" VARNAME="c"/>
<STRING.ENCODE VARIABLE="cid" VARNAME="cid"/>

<ASSET.LOAD NAME="theAsset" FIELD="id" VALUE="Variables.cid" TYPE="Variables.c"/>
<ASSET.SCATTER NAME="theAsset" PREFIX="asset"/>
<ASSETTYPE.LOAD NAME="theAssetType" TYPE="Variables.c"/>
<ASSETTYPE.GET NAME="theAssetType" FIELD="description" OUTPUT="atdescription"/>

<!-- Check whether the asset is in this site and therefore if it can be viewed here -->
<ASSET.SITES NAME="theAsset" LIST="pubCheck" PUBID="SessionVariables.pubid"/>
<if COND="IsError.Variables.errno=true">
<then>
	<callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
		<argument NAME="error" VALUE="AssetNotInUsersSite"/>
	</callelement>
</then>
<else>
	<!-- Action bar -->
	<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ActionsBar">
		<argument NAME="Screen" VALUE="Browse"/>
		<argument NAME="AssetType" VALUE="Variables.c"/>
		<argument NAME="id" VALUE="Variables.cid"/>
		<argument NAME="assetname" VALUE="theAsset"/>
	</callelement>
	
	<table border="0" cellpadding="0" cellspacing="0" class="width-outer-70">
		<tr>
			<td class="title-text"><XLAT.STREAM KEY="dvin/UI/BrowsePublicationNameSitePlanassetname"/></td>
		</tr>
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TitleBar"/>
		<tr>
			<td>
				<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/ShowBriefDetails">
					<ARGUMENT NAME="assetObj" VALUE="theAsset"/>
				</CALLELEMENT>
			</td>
		</tr>
	
		<!--<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacerBar">
		</CALLELEMENT>-->
	
		<tr>
			<td>
				<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/BrowseAssetBreadcrumb">
					<ARGUMENT NAME="assetname" VALUE="theAsset"/>
				</CALLELEMENT>
			</td>
		</tr>
	
	
			<IF COND="IsVariable.p=true">
			<THEN>
				<SETVAR NAME="prev_p" VALUE="Variables.p"/>
	    		<SETVAR NAME="p" VALUE="Variables.p,Variables.cid"/>
			</THEN>
			<ELSE>
	        	<SETVAR NAME="p" VALUE="Variables.cid"/>
			</ELSE>
			</IF>
			<IF COND="Variables.c=Page">
			<THEN>
				<tr>
					<td>
						<ASSET.GETSITENODE NAME="Variables.assetname" OUTPUT="sitenode"/>
						<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/BrowsePageChildren">
							<ARGUMENT NAME="sitenode" VALUE="Variables.sitenode"/>
						</CALLELEMENT>
					</td>
				</tr>
			</THEN>
			</IF>
			<IF COND="Variables.c=SitePlan">
			<THEN>
				<tr>
					<td>
						<ASSET.GETSITENODE NAME="Variables.assetname" OUTPUT="sitenode"/>
						<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/BrowsePageChildren">
							<ARGUMENT NAME="sitenode" VALUE="Variables.sitenode"/>
							<ARGUMENT NAME="sitenodeType" VALUE="Variables.AssetType" /> 
						</CALLELEMENT>
					</td>
				</tr>
			</THEN>
			</IF>
	
		<!--<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacerBar">
		</CALLELEMENT>-->
		<tr>
			<td>
				<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/BrowseAssetChildren">
					<ARGUMENT NAME="assetname" VALUE="theAsset"/>
				</CALLELEMENT>
			</td>
		</tr>
		<STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
		<tr>
			<td><img height="5" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
		</tr>
		<tr>
			<!--<td class="light-line-color"><img height="1" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>-->
		</tr> 	
		<tr>
			<td><img height="5" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
		</tr>
		<tr>
			<td>
			<ASSET.REFERENCEDBY  NAME="theAsset" LIST="ParentList"/>
			<SETVAR NAME="tablename" VALUE="AssetRelationTree"/>
	
			<IF COND="IsList.ParentList=true">
			<THEN>
				<IF COND="ParentList.#numRows!=0">
				<THEN>
					<SETVAR NAME="ShowLabel" VALUE="true"/>
					<TABLE class="width-inner-100" BORDER="0" CELLSPACING="0" CELLPADDING="0">
				
					<LOOP LIST="ParentList">
	
					<!-- check to see that we're not looking at the current parent asset -->
					<IF COND="ParentList.oid!=Variables.lastParent">
					<THEN>
					
						<ASSET.LOAD NAME="anAsset" TYPE="ParentList.otype" OBJECTID="ParentList.oid"/>
						<ASSET.GET NAME="anAsset" FIELD="name"/>
						<ASSET.GET NAME="anAsset" FIELD="description"/>
											
						<IF COND="Variables.assettype!=ParentList.otype">
						<THEN>
							<SETVAR NAME="assettype" VALUE="ParentList.otype"/>
						</THEN>
						</IF>
						<IF COND="Variables.ShowLabel=true">
						<THEN>
							<TR><TD class="form-label-text">
								<XLAT.STREAM KEY="dvin/UI/atdescriptionassetnamealsoreferencedby"/><BR/>
								</TD><TD COLSPAN="4"></TD>
							</TR>
							<TR>
								<td>&nbsp;&nbsp;</td><TD><XLAT.STREAM KEY="dvin/AT/Common/Name"/></TD><TD>&nbsp;&nbsp;</TD><TD><XLAT.STREAM KEY="dvin/AT/Common/Description"/></TD><TD>&nbsp;&nbsp;</TD><TD><XLAT.STREAM KEY="dvin/Common/Type"/></TD>
							</TR>
							<SETVAR NAME="ShowLabel" VALUE="false"/>
						</THEN>
						</IF>
						<TR>
				        <!-- at this point, we have the id of our immediate parent (the other asset that refers to the current one)
				        - now we need to walk back up the AssetRelationTree, looking for its parents
				        - until we hit a page asset. Then, we need to walk back up the siteplan tree looking for parents of the 
				        - page asset.
				        -->
						<SETVAR NAME="foundTop" VALUE="false"/>
						<SETVAR NAME="ancestors" VALUE="Variables.empty"/>
						<SETVAR NAME="tablename" VALUE="AssetRelationTree"/>
						<SETVAR NAME="currObjId" VALUE="ParentList.oid"/>
						<SETVAR NAME="currType" VALUE="ParentList.otype"/>
						<IF COND="Variables.currType!=Page">
						<THEN>
						<LOOP UNTIL="Variables.foundTop=true">
							<SETVAR NAME="errno" VALUE="0"/>
							
							<ASSET.LOAD NAME="junk" OBJECTID="Variables.currObjId" TYPE="Variables.currType"/>
							<SETVAR NAME="errno" VALUE="0"/>
							<ASSET.REFERENCEDBY NAME="junk" LIST="RelatedAncestors"/>
	
						
							<IF COND="Variables.errno!=-101">
							<THEN>
								<IF COND="IsList.RelatedAncestors=true">
								<THEN>
									<IF COND="RelatedAncestors.#numRows!=0">
									<THEN>
	
										<IF COND="Variables.ancestors!=Variables.empty">
										<THEN>
                                            <SETVAR NAME="ancestors" VALUE="RelatedAncestors.oid,Variables.ancestors"/>
										</THEN>
										<ELSE>
                                            <SETVAR NAME="ancestors" VALUE="RelatedAncestors.oid"/>
										</ELSE>
										</IF>
										<SETVAR NAME="currObjId" VALUE="RelatedAncestors.oid"/>
										<SETVAR NAME="currType" VALUE="RelatedAncestors.otype"/>
										<IF COND="RelatedAncestors.otype=Page">
										<THEN>
											<SETVAR NAME="foundTop" VALUE="true"/>
										</THEN>
										</IF>
									</THEN>
									<ELSE>
										<!-- we found no ancestors for this asset, so we must be at the top -->
										<SETVAR NAME="foundTop" VALUE="true"/>
									</ELSE>
									</IF>
								</THEN>
								</IF>
							</THEN>
							<ELSE>
								<SETVAR NAME="foundTop" VALUE="true"/>
							</ELSE>
							</IF>
						</LOOP>
						</THEN>
						</IF>
	
						<!-- at this point, ancestors should be a comma-separated list of assets
						- if the last asset we found is a page asset, then we need to walk up the
						- siteplantree until we get to the root.
						-->
						<IF COND="Variables.currType=Page">
						<THEN>
							<SETVAR NAME="errno" VALUE="0"/>
                            <IF COND="IsList.RelatedAncestors=true">
								<THEN>
									<IF COND="RelatedAncestors.#numRows!=0">
									<THEN>
                                        <GOTOROW LIST="RelatedAncestors" ROWNUM="1"/>
                                        <ASSET.LOAD NAME="parentpage" TYPE="Page" OBJECTID="RelatedAncestors.oid"/>	
                                        <LOOP UNTIL="Variables.errno!=0">
                                            <ASSET.SITEPARENT NAME="parentpage" OUTNAME="parentpage"/>
                                            <IF COND="Variables.errno=0">
                                            <THEN>
                                                <ASSET.GET NAME="parentpage" FIELD="id" OUTPUT="ParentId"/>
                                                <SETVAR NAME="ancestors" VALUE="Variables.ParentId,Variables.ancestors"/>
                                            </THEN>
                                            </IF>
                                        </LOOP>
                                    </THEN>
						            </IF>
                               </THEN>
						       </IF>     
                        </THEN>
						</IF>
	
					<td>&nbsp;&nbsp;</td>
					<TD NOWRAP="NOWRAP" VALIGN="TOP">
						<IF COND="Variables.ancestors=Variables.empty">
						<THEN>
                             <SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/BrowseAssetChildren" outstring="BrowseURL">
                                 <satellite.argument name="cs_environment" value="Variables.cs_environment"/>
                                <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
                            <satellite.argument name="c" value="ParentList.otype"/>
                            <satellite.argument name="cid" value="ParentList.oid"/>
                            </SATELLITE.LINK>
							<A HREF="Variables.BrowseURL" REPLACEALL="Variables.BrowseURL" TITLE="Browse this asset"><STRING.STREAM VALUE="Variables.name"/></A><BR/>
						</THEN>
						<ELSE>
                            <SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/BrowseAssetChildren" outstring="BrowseURL">
                                <satellite.argument name="cs_environment" value="Variables.cs_environment"/>
                                <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
                            <satellite.argument name="c" value="ParentList.otype"/>
                            <satellite.argument name="p" value="Variables.ancestors"/>
                            <satellite.argument name="cid" value="ParentList.oid"/>
                            </SATELLITE.LINK>
							<A HREF="Variables.BrowseURL" REPLACEALL="Variables.BrowseURL" TITLE="Browse this asset"><STRING.STREAM VALUE="Variables.name"/></A><BR/>
						</ELSE>
						</IF>
					</TD>
					<TD>&nbsp;&nbsp;</TD>
					<TD VALIGN="TOP"><STRING.STREAM VALUE="Variables.description"/></TD>
					<TD>&nbsp;&nbsp;</TD><TD VALIGN="TOP"><STRING.STREAM VALUE="Variables.assettype"/></TD></TR>
	
					</THEN>
					</IF><!-- end COND="ParentList.nparentid!=currentParent.nid" -->
					</LOOP> <!-- end LOOP ParentList -->
					</TABLE>
				</THEN>
				</IF>
			</THEN>
		</IF>
	
			</td>
		</tr>
	</table>
</else>
</if>


</FTCS> 
