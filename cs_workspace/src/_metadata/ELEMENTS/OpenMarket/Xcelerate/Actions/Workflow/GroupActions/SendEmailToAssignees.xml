<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Actions/Workflow/GroupActions/SendEmailToAssignees
-
- INPUT
-
- OUTPUT
-
-->

<!-- user code goes here -->
<!-- This is an action element called by step actions SendAssignmentEmail and SendRejectionEmail-->

<XLAT.LOOKUP KEY="dvin/UI/Wf/GroupActionSendEmail" VARNAME="displayMsg" />

<!-- load email object -->
<EMAILMANAGER.LOAD NAME="Variables.emailname" OBJVARNAME="emailobject"/>
<!-- get group -->
<WORKFLOWENGINE.GETGROUPID ID="Variables.Group" OBJVARNAME="grpobj"/>
<WORKFLOWGROUP.GETNAME NAME="grpobj" VARNAME="GroupName"/>
<XLAT.LOOKUP KEY="dvin/UI/Wf/Assetsusersstepsinvolvedgroupdeadlock" VARNAME="_XLAT" /> 
<SETVAR NAME="displayMsg" VALUE="Variables.displayMsg %3cbr/%3e Variables._XLAT:" />
<REMOVEVAR NAME="_XLAT" />
<!-- get total steps -->
<if COND="IsVariable.StepTotal=true">
<then>
<setvar NAME="NumOfSteps" VALUE="Variables.StepTotal"/>
</then>
<else>
<setvar NAME="NumOfSteps" VALUE="0"/>
</else>
</if>
	
<removevar NAME="Step"/>
<setvar NAME="Assets" VALUE="Variables.empty"/>
<setvar NAME="Header" VALUE="The following users have chosen the corresponding steps that has resulted in a deadlock for the group: Variables.GroupName. Please take appropriate actions to resolve deadlock. &#13;--"/>
<setvar NAME="Message" VALUE="Variables.empty"/>
<!-- For each assignment object, get asignee -->
<setcounter NAME="COUNT" VALUE="0"/>
<if COND="Variables.NumOfSteps!=0">
<then>
	<loop FROM="0" COUNT="Variables.NumOfSteps">
		<!-- get assigner -->

		<setvar NAME="userid" VALUE="Variables.StepUserCounters.COUNT"/>
		<!-- get email address -->
		<USERMANAGER.GETUSER USER="Variables.userid" OBJVARNAME="userobj"/>
		<CCUSER.GETDISPLAYABLENAME NAME="userobj" VARNAME="user_name"/>
		<CCUSER.GETEMAIL NAME="userobj" VARNAME="EmailAddress"/>

		<WORKFLOWSTEP.GETNAME NAME="StepCounters.COUNT" VARNAME="stepname"/>
		<WORKFLOWSTEP.GETSTARTSTATE NAME="StepCounters.COUNT" VARNAME="startstate"/>
		<WORKFLOWSTEP.GETENDSTATE NAME="StepCounters.COUNT" VARNAME="endstate"/>

		<WORKFLOWSTATE.GETSTATENAME NAME="Variables.startstate" VARNAME="startstatename"/>
		<WORKFLOWSTATE.GETSTATENAME NAME="Variables.endstate" VARNAME="endstatename"/>

		<!-- get asset -->
		<WORKFLOWABLEOBJECT.GETDISPLAYABLENAME OBJECT="StepObjectCounters.COUNT" VARNAME="assetname"/>
		<setvar NAME="Assets" VALUE="Variables.Assets,Variables.assetname"/>
		<XLAT.LOOKUP KEY="dvin/Common/User" VARNAME="UserLabel" />
		<XLAT.LOOKUP KEY="dvin/Common/Step" VARNAME="StepLabel" />
		<SETVAR NAME="displayMsg" VALUE="Variables.displayMsg %3cbr/%3e Variables.assetname, Variables.UserLabel: Variables.user_name, Variables.StepLabel: Variables.stepname" />
		<!-- set message -->
		<setvar NAME="Message" VALUE="Variables.MessageVariables.assetname, User: Variables.user_name, Step: Variables.stepname &#13;--  "/>

	<inccounter NAME="COUNT" VALUE="1"/>
	</loop>

	<!-- get ready to translate  -->
	<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Workflow/GroupActions/EncodeUtil">
					<ARGUMENT NAME="header" VALUE="Variables.Header"/>
					<ARGUMENT NAME="message" VALUE="Variables.Message"/>
					<ARGUMENT NAME="assetname" VALUE="Variables.Assets"/>
	</CALLELEMENT>
	
	
	<!-- translate subject -->
	<EMAIL.TRANSLATESUBJECT NAME="emailobject" PARAMS="Variables.params" VARNAME="subject" DECODE="true"/>

	<!-- translate body -->
	<EMAIL.TRANSLATEBODY NAME="emailobject" PARAMS="Variables.params" VARNAME="body" DECODE="true" />

	<!-- e-mail mesage is constructed, now send email -->
	<setcounter NAME="COUNT" VALUE="0"/>
	<loop FROM="0" COUNT="Variables.NumOfSteps">
		<setvar NAME="userid" VALUE="Variables.StepUserCounters.COUNT"/>
		<!-- get email address -->
		<USERMANAGER.GETUSER USER="Variables.userid" OBJVARNAME="userobj"/>
		<CCUSER.GETDISPLAYABLENAME NAME="userobj" VARNAME="user_name"/>
		<CCUSER.GETEMAIL NAME="userobj" VARNAME="EmailAddress"/>
        <MAIL.SEND TO="Variables.EmailAddress" SUBJECT="Variables.subject" BODY="Variables.body" CONTENTTYPE="text/html" />  
		<inccounter NAME="COUNT" VALUE="1"/>

	</loop>

</then>
</if>
<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
		<ARGUMENT NAME="severity" VALUE="info"/>
		<ARGUMENT NAME="msgtext" VALUE="Variables.displayMsg"/>
	</CALLELEMENT>
</FTCS> 
