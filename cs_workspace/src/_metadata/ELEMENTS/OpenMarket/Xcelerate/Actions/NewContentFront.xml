<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!--
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/NewContentFront.xml $
$Revision: 52 $
$Modtime: 9/02/04 4:27p $
-->

<!-----------------------------------------------------------------------------------------------
- Confidential and Proprietary Information of Open Market Inc.
-					All Rights Reserved.
-
- NewContentFront.xml
-
- DESCRIPTION
-    Front for new content item screen   (VIA) STARTMENU 

Modified       By        Reason
------------   ---       ------
Feb 22,2011    JAG       Added Functionality support and asset mode
                         processing for the following StartMenu UI Enhancements
                         1) Capability for the user via Startmenu to  assign
                            and set Default Group/Parents based on
                            selected Flex Definition / Family
                            for both Single Value(SV) and Multi Value(MV) Parents
                         2) Assign  Default Associated/Customized Attributes
                            both SingleValue(SV) and MultiValue(MV)

March 22,2011  JAG       Added Enhancement functionality which includes the following
                         1)  Added "asset" as allowable attribute type
                             asset Reference both for Single Value and MultiValue
                         2)  SV Named Associations
                         3)  MV Named Associations

Modified:  April 25, 2011
By:        JAG
Reason:    PR#25709 Fixed the creating start menu for an extensible page asset type
           to select a Flex Page Definition ( Template ) and to collect, process, display
           and set default values for all Extended and associated custom attributes
           for that start menu selected page  definition.
----------------------------------------------------------------------------------------------------->
    
<!-- if we are engaged in a copy but came here from a repost, set the copy variables (bug9971)-->
<STRING.ENCODE VARIABLE="id" VARNAME="id"/>
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType" />
<STRING.ENCODE VARIABLE="cs_environment" VARNAME="cs_environment" />
<STRING.ENCODE VARIABLE="cs_formmode" VARNAME="cs_formmode" />
<STRING.ENCODE VARIABLE="cancelpage" VARNAME="cancelpage" />
<IF COND="IsVariable._parentAssetName=true">
<THEN>
	<STRING.ENCODE VARIABLE="ID" VARNAME="ID"/>
	<INPUT TYPE="hidden" NAME="ID" VALUE="Variables.ID" REPLACEALL="Variables.ID"/>
	<STRING.ENCODE VARIABLE="_parentAssetName" VARNAME="_parentAssetName"/>
	<INPUT TYPE="hidden" NAME="_parentAssetName" VALUE="Variables._parentAssetName" REPLACEALL="Variables._parentAssetName"/>
	<STRING.ENCODE VARIABLE="_assetsubtype" VARNAME="_assetsubtype"/>
	<INPUT TYPE="hidden" NAME="_assetsubtype" VALUE="Variables._assetsubtype" REPLACEALL="Variables._assetsubtype"/>
</THEN>
</IF>

<callelement NAME="OpenMarket/Gator/Scripts/TabDirtyScript"/>
<if COND="IsVariable.Copyid=true">
<then>
	<STRING.ENCODE VARIABLE="EditFlag" VARNAME="EditFlag" />
	<INPUT TYPE="hidden" NAME="EditFlag" VALUE="Variables.EditFlag" REPLACEALL="Variables.EditFlag"/>
	<STRING.ENCODE VARIABLE="Copyid" VARNAME="Copyid" />
	<INPUT TYPE="hidden" NAME="Copyid" VALUE="Variables.Copyid" REPLACEALL="Variables.Copyid"/>
	<STRING.ENCODE VARIABLE="CopyAssetType" VARNAME="CopyAssetType" />
	<INPUT TYPE="hidden" NAME="CopyAssetType" VALUE="Variables.CopyAssetType" REPLACEALL="Variables.CopyAssetType"/>
	<IF COND="IsVariable.preselected_dimensionid=true">
	<THEN>
		<STRING.ENCODE VARIABLE="preselected_dimensionid" VARNAME="preselected_dimensionid" />
		<INPUT TYPE="hidden" NAME="preselected_dimensionid" VALUE="Variables.preselected_dimensionid" REPLACEALL="Variables.preselected_dimensionid"/>
	</THEN>
	</IF>
	<IF COND="IsVariable.preselected_dimensiontype=true">
	<THEN>
		<STRING.ENCODE VARIABLE="preselected_dimensiontype" VARNAME="preselected_dimensiontype" />
		<INPUT TYPE="hidden" NAME="preselected_dimensiontype" VALUE="Variables.preselected_dimensiontype" REPLACEALL="Variables.preselected_dimensiontype"/>
	</THEN>
	</IF>
</then>
</if>
<STRING.ENCODE VARIABLE="cancelpage" VARNAME="cancelpage"/>
<if COND="IsVariable.cancelpage!=true">
<then>
	<SETVAR NAME="cancelpage" VALUE="OpenMarket/Xcelerate/Actions/ShowStartMenuItems" />

	<IF COND="Variables.cs_environment=changeref">
	<THEN>
		<SETVAR NAME="cancelpage" VALUE="OpenMarket/Xcelerate/Actions/AddRefFront" />
	</THEN>
	<ELSE>
		<IF COND="Variables.cs_environment=addref">
		<THEN>
			<SETVAR NAME="cancelpage" VALUE="OpenMarket/Xcelerate/Actions/AddRefFront" />
		</THEN>
		</IF>
	   </ELSE>
	</IF>
</then>
</if>

<!-- Pass assettypes parameter, if any, as hidden input to the next page. -->
<if COND="IsVariable.assettypes=true">
<then>
	<STRING.ENCODE VARIABLE="assettypes" VARNAME="assettypes" />
	<input type="hidden" name="assettypes" value="Variables.assettypes" replaceall="Variables.assettypes" />
</then>
</if>

<!-- Pass startmenu parameter, if any, as hidden input to the next page. -->
<if COND="IsVariable.startmenu=true">
<then>
	<STRING.ENCODE VARIABLE="startmenu" VARNAME="startmenu" />
	<input type="hidden" name="startmenu" value="Variables.startmenu" replaceall="Variables.startmenu" />
</then>
</if>

<!-- Preserve certain variables that we were TOLD to preserve by the caller -->
<if COND="IsVariable.VarsToPreserve=true">
<then>
	<STRING.ENCODE VARIABLE="VarsToPreserve" VARNAME="VarsToPreserve" />
	<input type="hidden" name="VarsToPreserve" value="Variables.VarsToPreserve" replaceall="Variables.VarsToPreserve"/>
	<stringlist STR="Variables.VarsToPreserve" NAME="preslist" DELIM=","/>
	<if COND="IsList.preslist=true">
	<then>
		<if COND="preslist.#numRows!=0">
		<then>
			<loop LIST="preslist">
				<!-- Issue a hidden for each variable so mentioned -->
				<setvar NAME="varname" VALUE="preslist.ITEM"/>
				<setvar NAME="varvalue" VALUE="Variables.Variables.varname"/>
				<input type="hidden" name="Variables.varname" value="Variables.varvalue" replaceall="Variables.varname,Variables.varvalue"/>
			</loop>
		</then>
		</if>
	</then>
	</if>
</then>
</if>

<if COND="Variables.doproceed=true">
<then>
	<STRING.ENCODE VARIABLE="PostPage" VARNAME="PostPage"/>
	<INPUT type="hidden" name="pagename" value="OpenMarket/Xcelerate/Actions/Variables.PostPage" REPLACEALL="Variables.PostPage"/>

	<!-- check for repost of cs_StartMenuPermissions -->
	<IF COND="IsVariable.cs_StartMenuPermissions=true">
	<THEN>
		<STRING.ENCODE VARIABLE="cs_StartMenuPermissions" VARNAME="cs_StartMenuPermissions" />
		<INPUT TYPE="hidden" NAME="cs_StartMenuPermissions" VALUE="Variables.cs_StartMenuPermissions" REPLACEALL="Variables.cs_StartMenuPermissions"/>
	</THEN>
	</IF>

	<!-- check for repost of __WORKFLOWPROCID__ -->
	<STRING.ENCODE VARIABLE="__WORKFLOWPROCID__" VARNAME="__WORKFLOWPROCID__" />
	<STRING.ENCODE VARIABLE="__PARTROLES__" VARNAME="__PARTROLES__" />
	<IF COND="IsVariable.__WORKFLOWPROCID__=true">
	<THEN>
		<STRINGLIST NAME="lPartRoles" STR="Variables.__PARTROLES__" DELIM=","/>
		<LOOP LIST="lPartRoles">
			<SETVAR NAME="currentParticipant" VALUE="Variables.__ROLE__lPartRoles.ITEM__"/>
			<STRING.ENCODE VARIABLE="currentParticipant" VARNAME="currentParticipant" />
			<INPUT TYPE="HIDDEN" NAME="__ROLE__lPartRoles.ITEM__" VALUE="Variables.currentParticipant" REPLACEALL="Variables.currentParticipant,lPartRoles.ITEM"/>
		</LOOP>
	</THEN>
	</IF>
		
    <!--Removed the else clause. PR #16742.
		When an assettype has more than one definitions, we need to make a call to the element OpenMarket/Gator/FlexibleAssets/Common/AssocTmpls to show the list of definitions.
		That element posts back to this element after defintion is selected.  Before we show the actual edit screen we need to do an asset gather of the default values from the 
		startmenu (if available) and scatter them back to the prefix. And we need to do this irrespective of the workflow process selected. 
		This will ensure that the default values for the asset from the start menu item get displayed correctly in the edit screen.
	-->
	<IF COND="IsVariable.StartItem=true">
	<THEN>
		<STRING.ENCODE VARIABLE="StartItem" VARNAME="StartItem" />
	        <input type="hidden" name="StartItem" value="Variables.StartItem" REPLACEALL="Variables.StartItem"/>
		<STARTMENU.LOAD ID="Variables.StartItem" OBJVARNAME="si"/>
		<STARTMENUITEM.GETLEGALROLES NAME="si" OBJVARNAME="legalRolesList" />
		<ROLELIST.ISALL NAME="legalRolesList" VARNAME="check" />
		<IF COND="Variables.check=false">
			<THEN>
				<ROLELIST.GETALL NAME="legalRolesList" VARNAME="legalRolesListTemp" />
				<STRINGLIST STR="Variables.legalRolesListTemp" NAME="atlist" DELIM=","/>
				<USERMANAGER.GETUSERFROMNAME USERNAME="SessionVariables.username" OBJVARNAME="userObject"/>
				<CCUSER.GETSITEROLES NAME="userObject" SITE="SessionVariables.pubid" OBJVARNAME="roleObject"/>
				<SETVAR NAME="roleExists" VALUE="false" />
				<LOOP LIST="atlist">
					<IF COND="Variables.roleExists=false">
						<THEN>
							<ROLELIST.HASROLE NAME="roleObject" ROLE="atlist.ITEM" VARNAME="roleExists"/>
						</THEN>
					</IF>
				</LOOP>
				<IF COND="Variables.roleExists=false">
					<THEN>
						<XLAT.LOOKUP KEY="WorkflowNoRolesFound" VARNAME="statusmsg"/>
						<div class="width-outer-70">
						<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
							<ARGUMENT NAME="msgtext" VALUE="Variables.statusmsg"/>
							<ARGUMENT NAME="severity" VALUE="error"/>
						</CALLELEMENT>
						</div>
						<throwexception/>
					</THEN>
				</IF>
			</THEN>
		</IF>

		<STARTMENUITEM.GETPROCESSES NAME="si" OBJVARNAME="currentProc"/>
		<PROCESSLIST.GETALL NAME="currentProc" VARNAME="__WORKFLOWPROCID__"/>
		<if COND="Variables.__WORKFLOWPROCID__!=Variables.empty">
		<then>
			<WORKFLOWENGINE.CANSTARTWORKFLOW ID="Variables.__WORKFLOWPROCID__" SITE="SessionVariables.pubid" VARNAME="canstartworkflow"/>
			<if COND="Variables.canstartworkflow=true">
			<then>
				<WorkflowEngine.GetProcessID ID="Variables.__WORKFLOWPROCID__" OBJVARNAME="currentProc"/>
				<WorkflowProcess.GetInitialStepID NAME="currentProc" VARNAME="inistepid"/>
				<WorkflowProcess.GetStep NAME="currentProc" VALUE="Variables.inistepid" OBJVARNAME="stepobj"/>
				<WorkflowStep.GetStepType NAME="stepobj" VARNAME="steptype" />

				<IF COND="Variables.steptype=ask">
				<THEN>
					<SETVAR NAME="cs_StepID" VALUE="Variables.inistepid"/>
					<IF COND="IsVariable.cs_AlreadyHaveAssignees=true">
					<THEN>
						<INPUT TYPE="HIDDEN" NAME="__WORKFLOWPROCID__" VALUE="Variables.__WORKFLOWPROCID__" REPLACEALL="Variables.__WORKFLOWPROCID__"/>
						<STARTMENUITEM.GETPARTICIPANTS NAME="si" OBJVARNAME="currentParts"/>

						<PARTICIPANTLIST.GETREQUIRED NAME="currentParts" OBJVARNAME="partsList"/>
						<PARTICIPANTS.GETALLROLES NAME="partsList" VARNAME="allRoles"/>
        						<IF COND="Variables.allRoles!=Variables.empty">
        						<THEN>
        							<INPUT TYPE="hidden" NAME="__PARTROLES__" VALUE="Variables.allRoles" REPLACEALL="Variables.allRoles"/>

        							<STRINGLIST STR="Variables.allRoles" NAME="rlist" DELIM=","/>
        							<LOOP LIST="rlist">
        								<PARTICIPANTS.GETPARTICIPANTSFORROLE NAME="partsList" ROLE="rlist.ITEM" LISTVARNAME="users"/>
        								<HASH.CREATE NAME="uhash" LIST="users" COLUMN="ITEM"/>
        								<HASH.TOSTRING NAME="uhash" VARNAME="postUsers" DELIM=";"/>
        								<INPUT TYPE="hidden" NAME="__ROLE__rlist.ITEM__" VALUE="Variables.postUsers" REPLACEALL="rlist.ITEM,Variables.postUsers"/>
        							</LOOP>
        						</THEN>
        						</IF>
					</THEN>
					</IF>
				</THEN>
				<ELSE>
					<INPUT TYPE="HIDDEN" NAME="__WORKFLOWPROCID__" VALUE="Variables.__WORKFLOWPROCID__" REPLACEALL="Variables.__WORKFLOWPROCID__"/>
					<STARTMENUITEM.GETPARTICIPANTS NAME="si" OBJVARNAME="currentParts"/>

					<PARTICIPANTLIST.GETREQUIRED NAME="currentParts" OBJVARNAME="partsList"/>
					<PARTICIPANTS.GETALLROLES NAME="partsList" VARNAME="allRoles"/>
					<IF COND="Variables.allRoles!=Variables.empty">
					<THEN>
						<INPUT TYPE="hidden" NAME="__PARTROLES__" VALUE="Variables.allRoles" REPLACEALL="Variables.allRoles"/>

						<STRINGLIST STR="Variables.allRoles" NAME="rlist" DELIM=","/>
						<LOOP LIST="rlist">
							<PARTICIPANTS.GETPARTICIPANTSFORROLE NAME="partsList" ROLE="rlist.ITEM" LISTVARNAME="users"/>
							<HASH.CREATE NAME="uhash" LIST="users" COLUMN="ITEM"/>
							<HASH.TOSTRING NAME="uhash" VARNAME="postUsers" DELIM=";"/>
							<INPUT TYPE="hidden" NAME="__ROLE__rlist.ITEM__" VALUE="Variables.postUsers" REPLACEALL="rlist.ITEM,Variables.postUsers"/>
						</LOOP>
					</THEN>
    					</IF>
				</ELSE>
				</IF>

			</then>
			<else>
				<WorkflowEngine.GetProcessID ID="Variables.__WORKFLOWPROCID__" OBJVARNAME="workflow"/>
				<WorkflowProcess.GetProcessName NAME="workflow" VARNAME="workflowname" />
				<setvar NAME="doproceed" VALUE="NoStartWorkflowPriv"/>
			</else>
			</if>
		</then>
		</if>

        <STARTMENUITEM.GETARGUMENTS NAME="si" OBJVARNAME="currentArgs"/>
        <ARGUMENTLIST.GETALL NAME="currentArgs" PREFIX="itemArgs:"/>

        <IF COND="Variables.itemArgs:Total!=0">
		<THEN>
			<SETCOUNTER NAME="argNum" VALUE="0"/>

            <HASH.CREATE NAME="hStartMenuArgs"/>

			<WORKFLOWENGINE.GETALLFUNCTIONS PREFIX="functions:"/>
			<SETCOUNTER NAME="nthFunction" VALUE="0"/>
			<HASH.CREATE NAME="hFunctionIDMap"/>
			<HASH.CREATE NAME="hStartMenuPermissions"/>
			<LOOP COUNT="Variables.functions:Total">
				<WORKFLOWFUNCTION.GETNAME NAME="functions:Counters.nthFunction" VARNAME="functions:name"/>
				<WORKFLOWFUNCTION.GETID NAME="functions:Counters.nthFunction" VARNAME="functions:id"/>
				<HASH.ADD NAME="hFunctionIDMap" KEY="Variables.functions:name" VALUE="Variables.functions:id"/>
				<INCCOUNTER NAME="nthFunction" VALUE="1"/>
			</LOOP>

            <SETCOUNTER NAME="argNum" VALUE="0"/>
            <!--
               Process AssetType / Subtype Loaded StartMenu Default Arguments
               Create a  List named ' hStartMenuAssocList' Used
               to Process and set all Related Default Child Associations
             -->
            <LISTOBJECT.CREATE NAME="SMNamedChildAssoc" COLUMNS="name,value"/>
            <LISTOBJECT.CREATE NAME="SMNamedCustom" COLUMNS="name,value"/>

            <LOOP COUNT="Variables.itemArgs:Total">

                <ARGUMENT.GETNAME NAME="itemArgs:Counters.argNum" VARNAME="argname"/>
				<ARGUMENT.GETVALUE NAME="itemArgs:Counters.argNum" VARNAME="argval"/>
                 <!--
                     Collect All Named Association Arguments
                     will be processed to set ICS Variables
                     for  Default named Child ASSOCATIONS 
                 -->

                <!--
                       Set All Custom Attributes
                  -->

                <BEGINS STR="Variables.argname" WHAT="Attribute_"/>
                <IF COND="Variables.errno=1">
                  <THEN>
                      <LISTOBJECT.ADDROW NAME="SMNamedCustom" name="Variables.argname" value="Variables.argval"/>
                  </THEN>
                </IF>

                <BEGINS STR="Variables.argname" WHAT="Association-named"/>
                   <IF COND="Variables.errno=1">
                   <THEN>
                       <LISTOBJECT.ADDROW NAME="SMNamedChildAssoc" name="Variables.argname" value="Variables.argval"/>
                   </THEN>
                   </IF>

                  <!-- If we have a default value for the Dimension attribute set it in a prefixed ICS variable so that the PickDimensionform.jsp can pick it up.
				    	We need to do this because, asset gather does not work as expected for Dimension attributes.-->
				<!-- KDW - Uh, why not just fix asset gather for dimension attributes??? Seems silly to fix the problem in the wrong place!  However,
				      I am preserving this change because I don't have the history.  -->
				<IF COND="Variables.argname=Dimension">
				<THEN>
                   <SETVAR NAME="ContentDetails:Variables.argname:0" VALUE="Variables.argval" />
				</THEN>
				</IF>

				<SETVAR NAME="errno" VALUE="0"/>
				<BEGINS STR="Variables.argname" WHAT="cs_Permission_"/>
				<IF COND="Variables.errno=1">
				<THEN>
					<!-- strip cs_Permission_ and change function name to id to get to [RoleName]-[function id| format for save -->
					<SUBSTRING STR="Variables.argname" INDEX="14" OUTSTR="argname"/>
					<STRINGLIST NAME="lSplitName" STR="Variables.argname" DELIM="-"/>
					<SETVAR NAME="cs_nameBase" VALUE="lSplitName.ITEM"/>
					<SETROW ACTION="LAST" LIST="lSplitName"/>
					<HASH.GET NAME="hFunctionIDMap" VALUE="lSplitName.ITEM" VARNAME="cs_functionID"/>
					<HASH.ADD NAME="hStartMenuPermissions" VALUE="Variables.cs_nameBase-Variables.cs_functionID-Variables.argval" REPLACEALL="Variables.cs_nameBase,Variables.cs_functionID,Variables.argval"/>
				</THEN>
				<ELSE>
					<HASH.ADD NAME="hStartMenuArgs" VALUE="Variables.argname"/>
                    <!--
                       This will set if any  all StartMenu
                       Single Value(SV) Parent, Named Associations and
                       Custom Attribute Asset References
                       DEFAULT values
                      -->
                    <BEGINS STR="Variables.argname" WHAT="Group_"/>
                    <IF COND="Variables.errno=1">
				    <THEN>
                        <SETVAR NAME="ContentDetails:Variables.argname"  VALUE="Variables.argval"/>
                    </THEN>
                    </IF>
                 </ELSE>
			   </IF>
               <SETVAR NAME="startmenuarg:Variables.argname" VALUE="Variables.argval"/>
               <INCCOUNTER NAME="argNum" VALUE="1"/>
			</LOOP>
			
			<LISTOBJECT.TOLIST  NAME="SMNamedCustom"  LISTVARNAME="SMVCustomList"/>
			<CALLELEMENT NAME="OpenMarket/Xcelerate/Util/SetCustomValues"></CALLELEMENT>

            <!-- Need More Pre-Processing   StartMenu Args..
                 1) AssetReferences ( Child )
                 2) Named Asset Associations
                 3) Attribute Asset References
              -->
            <IF COND="IsVariable.startmenuarg:subtype=true">
            <THEN>
               <ASSET.INSPECT TYPE="Variables.AssetType" LIST="lInspectFields" SUBTYPE="Variables.startmenuarg:subtype"/>
            </THEN>
            <ELSE>
               <ASSET.INSPECT TYPE="Variables.AssetType" LIST="lInspectFields" />
            </ELSE>
            </IF>

<!-- 
   TODO - April 01, 2011 
          Need to Visist Recommendations as an exmple which  CONTAINS 
          Prefix "ManualRecs" and/or different child reference type 
          In turn it will not be detected   Need to Include Would be nice !  
  --> 

            <SETCOUNTER NAME="argNum" VALUE="0"/>
            <LOOP COUNT="Variables.itemArgs:Total">

                      <ARGUMENT.GETNAME NAME="itemArgs:Counters.argNum" VARNAME="argname"/>
                      <ARGUMENT.GETVALUE NAME="itemArgs:Counters.argNum" VARNAME="argval"/>

                      <!--   Transverse All StartMenu Attributes that WHOS default VALUES are
                             Asset References in the format ${AssetType}:{AssetID} and
                             parse and set the Asset Id ( Part ) Only All Attributes (SV)
                       -->
                     <SETVAR  NAME="childtype"  VALUE="assetreference"  />
                     <LOOP LIST="lInspectFields">
   
                         <INSPECTOR.PARSETYPESTRING VALUE="lInspectFields.spec" ATTRIBUTE="lInspectFields.name" LISTVARNAME="lTypeInfo"/>
                         <IF COND="Variables.argname=lInspectFields.name">
                         <THEN>
                            <BEGINS STR="lInspectFields.name" WHAT="Attribute_"/>
                            <IF COND="Variables.errno=1">
                            <THEN>
                              <IF COND="lTypeInfo.type=Variables.childtype">
                              <THEN>
                                  <!--
                                    Child Asset Reference ! Extract Asset Type set Details to ID Only
                                    assetlist is in the form: AssetType_AssetId
                                  -->
                                  <STRINGLIST STR="Variables.argval" DELIM=":" NAME="asset"/>
                                  <SETROW LIST="asset" ACTION="FIRST"/>
                                  <SETVAR NAME="type" VALUE="asset.ITEM"/>
                                  <SETROW LIST="asset" ACTION="NEXT"/>
                                  <SETVAR NAME="id" VALUE="asset.ITEM"/>

                                  <SETVAR NAME="startmenuarg:Variables.argname"  VALUE="Variables.id"/>
                                </THEN>
                              </IF>
                             </THEN>
                             </IF>
                          </THEN>
                          </IF>
                     </LOOP>

                     <INCCOUNTER NAME="argNum" VALUE="1"/>
            </LOOP>

            <HASH.HASDATA NAME="hStartMenuPermissions" VARNAME="hasit"/>
			<IF COND="Variables.hasit=true">
			<THEN>
				<HASH.TOSTRING NAME="hStartMenuPermissions" VARNAME="cs_StartMenuPermissions" DELIM=";"/>
				<INPUT TYPE="hidden" NAME="cs_StartMenuPermissions" VALUE="Variables.cs_StartMenuPermissions" REPLACEALL="Variables.cs_StartMenuPermissions"/>
			</THEN>
			</IF>

			<HASH.HASDATA NAME="hStartMenuArgs" VARNAME="hasit"/>
			<IF COND="Variables.hasit=true">
			<THEN>
				<HASH.TOSTRING NAME="hStartMenuArgs" VARNAME="startmenuargs" DELIM=","/>
                <IF COND="IsVariable.startmenuarg:subtype=true">
				<THEN>
                    <ASSET.SETSUBTYPE NAME="theCurrentAsset" VALUE="Variables.startmenuarg:subtype"/>
                 </THEN>
				</IF>

                 <!-- Collect All default Values -->
                 <ASSET.GATHER NAME="theCurrentAsset" FIELDLIST="Variables.startmenuargs" PREFIX="startmenuarg"/>
            </THEN>
			</IF>
		</THEN>
		</IF>

		<STARTMENUITEM.GETLEGALARGS NAME="si" OBJVARNAME="currentLegalArgs"/>
		<LEGALARGLIST.GETALL NAME="currentLegalArgs" PREFIX="itemLegalArgs:"/>

        <if COND="Variables.itemLegalArgs:Total!=0">
		<then>
			<SETCOUNTER NAME="argNum" VALUE="0"/>
			<HASH.CREATE NAME="hStartMenuLegalArgs"/>
			<LOOP COUNT="Variables.itemLegalArgs:Total">
                <LEGALARG.GETNAME NAME="itemLegalArgs:Counters.argNum" VARNAME="argname"/>
                <SETVAR NAME="errno" VALUE="0"/>
				<ICS.RESOLVEVARIABLES NAME="$(Variables.Arg:$(Variables.argname))" DELIMITED="true" OUTPUT="xxx"/>
				<if COND="Variables.errno=0">
				<then>
					<HASH.ADD NAME="hStartMenuLegalArgs" VALUE="Variables.argname"/>
                </then>
				<else>
					<!-- error if required: finish this when the UI supports it -->
				</else>
				</if>
				<IF COND="Variables.argname=Group_%">
				<THEN>
					<!-- add all fields that start with Group_ -->
					<IF COND="IsVariable.Arg:subtype=true">
					<THEN>
						<ASSET.INSPECT TYPE="Variables.AssetType" LIST="lInspectFields" SUBTYPE="Variables.Arg:subtype"/>
                        <LOOP LIST="lInspectFields">
                            <SETVAR NAME="errno" VALUE="0"/>
							<BEGINS STR="lInspectFields.name" WHAT="Group_"/>
							<IF COND="Variables.errno=1">
							<THEN>
								<HASH.ADD NAME="hStartMenuLegalArgs" VALUE="lInspectFields.name"/>
                            </THEN>
							</IF>
						</LOOP>
					</THEN>
					</IF>
				</THEN>
				</IF>
				<INCCOUNTER NAME="argNum" VALUE="1"/>
			</LOOP>
			<HASH.HASDATA NAME="hStartMenuLegalArgs" VARNAME="hasData"/>
			<if COND="Variables.hasData=true">
			<then>
				<HASH.TOSTRING NAME="hStartMenuLegalArgs" VARNAME="startmenulegalargs" DELIM=","/>
				<IF COND="IsVariable.Arg:subtype=true">
				<THEN>
                  <ASSET.SETSUBTYPE NAME="theCurrentAsset" VALUE="Variables.Arg:subtype"/>
				</THEN>
				</IF>
                  <ASSET.GATHER NAME="theCurrentAsset" FIELDLIST="Variables.startmenulegalargs" PREFIX="Arg"/>
			</then>
			</if>
		</then>
		</if>

        <ASSET.SCATTER NAME="theCurrentAsset" PREFIX="ContentDetails"/>
        <IF COND="IsVariable.parentid=true">
		<THEN>
			<SETVAR NAME="ContentDetails:GroupsTotal" VALUE="1"/>
			<SETVAR NAME="ContentDetails:Groups0" VALUE="Variables.parentid"/>
        </THEN>
		</IF>
         <!--  
                LAST Step in vador-NEW-via StartMenu Item via StartMenu Item
                Create a HASHMAP to save the Argument Name AND VALUE to consume and
                set each array element VARNAME AND VALUE and the Total
         -->
         <SETCOUNTER NAME="argNum" VALUE="0"/>
         <!--
             Create a MultiValue List named ' hStartMenuMV' Used
             as defined by StartMenu Item
             to set all MV ( Parents ) and Extended / Customized
             Attributes
           -->
         <LISTOBJECT.CREATE NAME="hStartMenuMV" COLUMNS="name,value"/>

         <!-- Determine For Flex Type Asset and of Subtype ( Flex Definition )
              do a Asset Inspect which Creates an object with ALL asset's attributes
              and the specification for each attribute.
           -->

          <IF COND="IsVariable.startmenuarg:subtype=true">
          <THEN>
              <ASSET.INSPECT TYPE="Variables.AssetType" LIST="lInspectFields" SUBTYPE="Variables.startmenuarg:subtype"/>
          </THEN>
          <ELSE>
             <ASSET.INSPECT TYPE="Variables.AssetType" LIST="lInspectFields" />
          </ELSE>
          </IF>

          <!--
              Transverse and collect ALL MultiValue Defined Attributes Only
              The list Object is Hashed where Attribute name acts as the Key
              fieldsMV will be the List of MV attributes
           -->
         <SETVAR NAME="fieldsMV" VALUE=""/>
         <HASH.CREATE NAME="hInspectMVArgs"/>

         <!--
             IF AND FRO ALL Create a  List named ' hStartMenuAssocListMV' Used
             to Process and set all Related Default Child Associations
          -->

     <IF COND="Variables.itemArgs:Total!=0">
     <THEN>
          <LISTOBJECT.TOLIST NAME="SMNamedChildAssoc" LISTVARNAME="SMNamedAssocationList"/>
          <LISTOBJECT.TOLIST NAME="SMNamedChildAssoc" LISTVARNAME="SMNamedAllList"/>
     </THEN>
     </IF>
     <LISTOBJECT.CREATE NAME="SMNamedChildAssocMV" COLUMNS="name"/>
     <IF COND="IsList.SMNamedAllList=true">
     <THEN>
         <HASH.CREATE NAME="SMNamedAll" LIST="SMNamedAllList" COLUMN="name"/>
     </THEN>
     <ELSE>
         <HASH.CREATE NAME="SMNamedAll" />
     </ELSE>
     </IF>


     <!--
              Transverse All StartMenu Attributes
              Use the Generated MV Attribute Table to
              build a List of AllStartMenu
              MultiValue Attributes
     -->
     <LOOP LIST="lInspectFields">
            <INSPECTOR.PARSETYPESTRING VALUE="lInspectFields.spec" ATTRIBUTE="lInspectFields.name" LISTVARNAME="lTypeInfo"/>
            <IF COND="lTypeInfo.multiple=true">
            <THEN>
                    <HASH.ADD NAME="hInspectMVArgs" VALUE="lInspectFields.name"/>
                    <!--
                         Is it a Named Association
                         Collect All Named Association Arguments
                         will be processed to set ICS Variables
                         for  Default named Child ASSOCATIONS
                      -->
                     <BEGINS STR="lInspectFields.name" WHAT="Association-named"/>
                     <IF COND="Variables.errno=1">
                     <THEN>
                         <!-- For now need just the name, But it needs to add properties
                              to be used in ranking etc
                           -->
                         <HASH.CONTAINS NAME="SMNamedAll" VALUE="lInspectFields.name" VARNAME="hasit"/>
                         <IF COND="Variables.hasit=true">
							<THEN>
                               <LISTOBJECT.ADDROW NAME="SMNamedChildAssocMV" name="lInspectFields.name"  />
                               <SETVAR NAME="fieldsMV" VALUE="Variables.fieldsMV;lInspectFields.name"/>
                            </THEN>
                         </IF>
                       </THEN>
                       </IF>
            </THEN>
            </IF>
         </LOOP>

        <!--
              Transverse All StartMenu Attributes
              Use the Generated MV Attribute Table to
              build a List of AllStartMenu
              MultiValue Attributes
         -->
       <LOOP COUNT="Variables.itemArgs:Total">

            <ARGUMENT.GETNAME NAME="itemArgs:Counters.argNum" VARNAME="argname"/>
            <ARGUMENT.GETVALUE NAME="itemArgs:Counters.argNum" VARNAME="argval"/>

            <HASH.CONTAINS NAME="hInspectMVArgs" VALUE="Variables.argname" VARNAME="hasit"/>
            <IF COND="Variables.hasit=true">
            <THEN>
               <LISTOBJECT.ADDROW NAME="hStartMenuMV" name="Variables.argname" value="Variables.argval"/>
            </THEN>
            </IF>
          
            <INCCOUNTER NAME="argNum" VALUE="1"/>
        </LOOP>

        <LISTOBJECT.TOLIST NAME="hStartMenuMV" LISTVARNAME="startMenuMVList"/>
        
      <!--
           If MV List table Created and populated we now need to process and Set
           ALL MV Attributes including ALL Parent/Group and Flex Definition
           Extended Attributes via helper element
        -->
       <IF COND="IsVariable.contentFormReposted!=true">
            <THEN>
                <IF COND="startmenuMVGroup.#numRows!=0">
                 <THEN>
                     <CALLELEMENT NAME="OpenMarket/Xcelerate/Util/SetAssocParentGroups">
                     </CALLELEMENT>
                 </THEN>
                </IF>

               <!--  Handle all Named Asset Assocations
                    Create a  List named 'SMNamedAssocationList' Used
                   to Process and set all Related Default Child Associations
                   Consumed and processed to set ICS Assocation Variable names
                   and Child Asset Values
               -->
              <LISTOBJECT.TOLIST NAME="SMNamedChildAssocMV" LISTVARNAME="SMNamedAssocationListMV"/>
              <STRING.ENCODE VARIABLE="fieldsMV" VARNAME="fieldsMV" />               
              <CALLELEMENT NAME="OpenMarket/Xcelerate/Util/SetChildAssocations">
                    <ARGUMENT NAME="MvNamedAssocList" VALUE="Variables.fieldsMV"/>			
              </CALLELEMENT>

            </THEN>
       </IF>


        <!--
            Finally Lets Gather and Set all of the  New associated ASSET instant
            StartMenu Default Values
         -->
        <ASSET.GATHER NAME="theCurrentAsset" FIELDLIST="Attribute_FSIIKeyword" />

       </THEN>
	</IF>
</then>
</if>

<if COND="Variables.doproceed=true">
<then>
	<!-- Provide the "pick asset" javascript -->
	<callelement NAME="OpenMarket/Xcelerate/Scripts/PickAssetPopup"/>
	
	<!-- On 5/10/2008, added new support infrastructure for ContentForms.   The idea is to allow a ContentForm coder to not
	      need to worry about the details of reposting, and also to allow certain widgets (e.g., the related asset widget) to
	      be written in a way that can work without modification for lots of different situations.  This code is also present in
	      CopyFront and EditFront, and should probably be made an element in its own right. -->
	      
	<!-- Leave chicken tracks so that the ContentForm elements do not need to do arcane calculation if they want to repost -->
	<SETVAR NAME="AssetRepostPage" VALUE="OpenMarket/Xcelerate/Actions/NewContentFront"/>
	
	<!-- Provide standard javascript function that reposts -->
	<SCRIPT TYPE="text/javascript">
	function repostContentForm()
	{
		document.forms[0].pagename.value='OpenMarket/Xcelerate/Actions/NewContentFront';
		document.forms[0].submit();
    }
	</SCRIPT>
	
	<!-- Provide variables that describe how to submit and repost in Javascript.  These variables can be superceded by individual
	      Content Form elements to include code that causes fields to be checked, etc., allowing various widgets to be written that
	      use just these variables to figure out what to do. -->
	<SETVAR NAME="repostContentFormJavascript" VALUE="repostContentForm();"/>
	<SETVAR NAME="submitContentFormJavascript" VALUE="document.forms[0].submit();"/>

	<!-- Lastly, provide an indication to content forms, as a convenience, as to whether or not this is a repost.  This is
	       mostly provided because we cannot make AssetMaker stub elements get updated, but it is potentially useful
	       for all asset types.  -->
	<INPUT TYPE="hidden" NAME="contentFormReposted" VALUE="true"/>
	<IF COND="IsVariable.contentFormReposted!=true">
	<THEN>
		<SETVAR NAME="contentFormReposted" VALUE="false"/>
	</THEN>
	</IF>

	<IF COND="IsVariable.cs_StepID=true">
	<THEN>
		<STRING.ENCODE VARIABLE="cs_StepID" VARNAME="cs_StepID" />
		<INPUT TYPE="hidden" NAME="cs_StepID" VALUE="Variables.cs_StepID" REPLACEALL="Variables.cs_StepID"/>
		<INPUT TYPE="hidden" NAME="cs_AlreadyHaveAssignees" VALUE="yes"/> 
		<IF COND="Variables.cs_environment=portal">
		<THEN>
			<IF COND="Variables.AssetType=SparkDoc">
			<THEN>
				<!-- This variable is needed only for the SparkDoc asset in portal environment -->
				<STRING.ENCODE VARIABLE="Arg:Group_Folder" VARNAME="Arg:Group_Folder" />
				<INPUT TYPE="hidden" NAME="Arg:Group_Folder" VALUE="Variables.Arg:Group_Folder" REPLACEALL="Variables.Arg:Group_Folder"/>
			</THEN>
			</IF>
		</THEN>
		</IF>

		<IF COND="IsVariable.cs_AlreadyHaveAssignees=false">
		<THEN>
			<IF COND="IsVariable.id=true">
			<THEN>
				<SETVAR NAME="cs_SavedID" VALUE="Variables.id"/>
				<REMOVEVAR NAME="id"/>
			</THEN>
			</IF>
			<STRING.ENCODE VARIABLE="cs_StepID" VARNAME="cs_StepID" />
			<STRING.ENCODE VARIABLE="__WORKFLOWPROCID__" VARNAME="__WORKFLOWPROCID__" />
			<STRING.ENCODE VARIABLE="cancelpage" VARNAME="cancelpage" />
			<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/SetAssigneesForAskStep">
				<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
				<ARGUMENT NAME="AskStep" VALUE="Variables.cs_StepID"/>
				<ARGUMENT NAME="workflowid" VALUE="Variables.__WORKFLOWPROCID__"/>
				<ARGUMENT NAME="cancelpage" VALUE="Variables.cancelpage"/>
				<ARGUMENT NAME="cs_environment" VALUE="Variables.cs_environment"/>
				<ARGUMENT NAME="cs_formmode" VALUE="Variables.cs_formmode"/>
			</CALLELEMENT>
			<IF COND="IsVariable.cs_SavedID=true">
			<THEN>
				<SETVAR NAME="id" VALUE="Variables.cs_SavedID"/>
			</THEN>
			</IF>
		</THEN>
		<ELSE>
			<!-- repost role selections and call the ContentForm -->
			<STRING.ENCODE VARIABLE="assigneeroles" VARNAME="assigneeroles" />
			<INPUT TYPE="hidden" NAME="assigneeroles" VALUE="Variables.assigneeroles" REPLACEALL="Variables.assigneeroles"/>
			<STRINGLIST NAME="lAssigneeRoles" STR="Variables.assigneeroles" DELIM="," />
			<LOOP LIST="lAssigneeRoles">
				<ICS.RESOLVEVARIABLES NAME="$(Variables.ask:$(lAssigneeRoles.ITEM))" DELIMITED="true" OUTPUT="cs_currentRoleVal"/>
				<STRING.ENCODE VARIABLE="cs_currentRoleVal" VARNAME="cs_currentRoleVal"/>
				<INPUT TYPE="hidden" NAME="ask:lAssigneeRoles.ITEM" VALUE="Variables.cs_currentRoleVal" REPLACEALL="Variables.cs_currentRoleVal,lAssigneeRoles.ITEM"/>
			</LOOP>
			<callelement NAME="OpenMarket/Xcelerate/AssetType/Variables.AssetType/ContentForm"/>
		</ELSE>
		</IF>
	</THEN>
	<ELSE>
		<callelement NAME="OpenMarket/Xcelerate/AssetType/Variables.AssetType/ContentForm"/>
	</ELSE>
	</IF>

	<if COND="Variables.doproceed=true">
	<then>
		<callelement NAME="OpenMarket/Xcelerate/Actions/Util/InsertStdVariables"/>
	</then>
	</if>
</then>
</if>
<if COND="Variables.doproceed!=true">
<then>
	<div class="width-outer-70">
	<STRING.ENCODE VARIABLE="doproceed" VARNAME="doproceed" />
	<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
		<argument NAME="elem" VALUE="Variables.doproceed"/>
		<argument NAME="severity" VALUE="error"/>
	</callelement>
	</div>

	<!-- Return to the new asset screen -->
	<callelement NAME="Variables.cancelpage"></callelement>
</then>
</if>

<input type="hidden" name="cancelpage" value="Variables.cancelpage" replaceall="Variables.cancelpage" />

<if COND="Variables.cs_environment=addref">
<then>
    <IF COND="IsVariable.parentid=true">
	<THEN>
	<STRING.ENCODE VARIABLE="parentid" VARNAME="parentid" />
	<input type="hidden" name="parentid" VALUE="Variables.parentid" replaceall="Variables.parentid" />
	<STRING.ENCODE VARIABLE="parenttype" VARNAME="parenttype" />
	<input type="hidden" name="parenttype" VALUE="Variables.parenttype" replaceall="Variables.parenttype" />
	<STRING.ENCODE VARIABLE="parentfield" VARNAME="parentfield" />
    <input type="hidden" name="parentfield" VALUE="Variables.parentfield" replaceall="Variables.parentfield" />
	</THEN>
	</IF>
	<IF COND="IsVariable.childtypes=true">
	<THEN>
	<STRING.ENCODE VARIABLE="childtypes" VARNAME="childtypes" />
    <input type="hidden" name="childtypes" VALUE="Variables.childtypes" replaceall="Variables.childtypes" />
	</THEN>
	</IF>
	<STRING.ENCODE VARIABLE="title" VARNAME="title" />
    <input type="hidden" name="title" VALUE="Variables.title" replaceall="Variables.title" />
</then>
</if>
<if COND="Variables.IFCKEditor=true">
<then>
    <IF COND="IsVariable.FCKName=true">
	<THEN>
	<STRING.ENCODE VARIABLE="FCKName" VARNAME="FCKName" />
    <INPUT TYPE="HIDDEN" NAME="FCKName" VALUE="Variables.FCKName" replaceall="Variables.FCKName"/>
	</THEN>
	</IF>
	<STRING.ENCODE VARIABLE="fielddesc" VARNAME="fielddesc" />
	<INPUT TYPE="HIDDEN" NAME="fielddesc" VALUE="Variables.fielddesc" replaceall="Variables.fielddesc"/>
	<STRING.ENCODE VARIABLE="FCKAssetId" VARNAME="FCKAssetId" />
	<INPUT TYPE="HIDDEN" NAME="FCKAssetId" VALUE="Variables.FCKAssetId" replaceall="Variables.FCKAssetId"/>
	<STRING.ENCODE VARIABLE="FCKAssetType" VARNAME="FCKAssetType" />
	<INPUT TYPE="HIDDEN" NAME="FCKAssetType" VALUE="Variables.FCKAssetType" replaceall="Variables.FCKAssetType"/>
	<STRING.ENCODE VARIABLE="embedtype" VARNAME="embedtype" />
	<INPUT TYPE="HIDDEN" NAME="embedtype" VALUE="Variables.embedtype" replaceall="Variables.embedtype"/>
	<STRING.ENCODE VARIABLE="IFCKEditor" VARNAME="IFCKEditor" />
	<INPUT TYPE="HIDDEN" NAME="IFCKEditor" VALUE="Variables.IFCKEditor" replaceall="Variables.IFCKEditor"/>
	<STRING.ENCODE VARIABLE="formFieldName" VARNAME="formFieldName" />
	<INPUT TYPE="HIDDEN" NAME="formFieldName" VALUE="Variables.formFieldName" replaceall="Variables.formFieldName"/>
	<!--  EditingStyle can conflict with the attribute of the new asset being created 
								from ckeditor so we are using different name to avoid the conflict.-->
	<STRING.ENCODE VARIABLE="attrEditingStyle" VARNAME="attrEditingStyle" />
	<INPUT TYPE="HIDDEN" NAME="attrEditingStyle" VALUE="Variables.attrEditingStyle" replaceall="Variables.attrEditingStyle"/>
</then>
</if>
<if COND="Variables.cs_environment=changeref">
<then>
	<STRING.ENCODE VARIABLE="parentid" VARNAME="parentid" />
    <input type="hidden" name="parentid" VALUE="Variables.parentid" replaceall="Variables.parentid" />
    <STRING.ENCODE VARIABLE="parenttype" VARNAME="parenttype" />
    <input type="hidden" name="parenttype" VALUE="Variables.parenttype" replaceall="Variables.parenttype" />
    <STRING.ENCODE VARIABLE="parentfield" VARNAME="parentfield" />
    <input type="hidden" name="parentfield" VALUE="Variables.parentfield" replaceall="Variables.parentfield" />
    <STRING.ENCODE VARIABLE="assetid" VARNAME="assetid" />
    <input type="hidden" name="assetid" VALUE="Variables.assetid" replaceall="Variables.assetid" />
    <STRING.ENCODE VARIABLE="title" VARNAME="title" />
    <input type="hidden" name="title" VALUE="Variables.title" replaceall="Variables.title" />
    <input type="hidden" name="assettype" VALUE="Variables.AssetType" replaceall="Variables.AssetType" />
    <STRING.ENCODE VARIABLE="memberid" VARNAME="memberid" />
    <input type="hidden" name="memberid" VALUE="Variables.memberid" replaceall="Variables.memberid" />
</then>
</if>
</FTCS>
