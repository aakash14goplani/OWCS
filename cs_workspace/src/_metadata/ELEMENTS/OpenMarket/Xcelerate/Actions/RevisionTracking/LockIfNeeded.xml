<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateC/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/RevisionTracking/LockIfNeeded.xml $ 
$Revision: 14 $ 
$Modtime: 4/08/03 3:34p $ 
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- LockIfNeeded.xml
-
- DESCRIPTION
-	Given a content category item,
-       lock it if is not already locked.
-       If it is already locked, then
-       set the variable alreadylocked
-       to true
-
- HISTORY 
-->

<setvar NAME="locked" VALUE="false"/>
<setvar NAME="alreadylocked" VALUE="false"/>
<setvar NAME="lockit" VALUE="false"/>
<setvar NAME="checkoutmethod" VALUE="explicit"/>

<!--Flags for Alloy UI -->
<SETVAR NAME="currentUserExplicitlyCheckedOutAsset" VALUE="false" />
<SETVAR NAME="assetCheckedOutBySomeOtherUser" VALUE="false" />
<!--Flags for Alloy UI -->

<if COND="ItsHistory.#numRows!=0">
<then>
<if COND="ItsHistory.lockedby=Variables.empty">
	 <then>
		  <setvar NAME="lockit" VALUE="true"/>
	 </then>
	 <else>
		  <if COND="ItsHistory.lockedby!=SessionVariables.username">
		  <then>
				<setvar NAME="doproceed" VALUE="OtherLock"/>
				<!-- Flag for Alloy UI - Content Server 7.0 -->
				<SETVAR NAME="assetCheckedOutBySomeOtherUser" VALUE="true" />
				<!-- Flag for Alloy UI -->
		  </then>
		  <else>
				<setvar NAME="locked" VALUE="true"/>
				<!-- It's always going to appear in the CheckOutInfo table, so
				     looking there is not meaningful.  I can only think of one
				     case where the following would be an issue - if this element
				     were to be called multiple times -->
				<setvar NAME="alreadylocked" VALUE="true"/>
			
				<!-- Flag for Alloy UI -->
					<SETVAR NAME="currentUserExplicitlyCheckedOutAsset" VALUE="true" />

				<!-- Flag for Alloy UI -->
				<!-- implicitcheckout.ischeckedout ASSETTYPE="Variables.AssetType" ASSETID="Variables.id"
					VARNAME="checkVar"/>
				<IF COND="IsVariable.checkVar=false">
				<THEN>
					<setvar NAME="alreadylocked" VALUE="true"/>
				</THEN>
				</IF -->

			</else>
		  </if>
	 </else>
</if>
</then>
<else>
	 <setvar NAME="lockit" VALUE="true"/>
</else>
</if>

<!-- if we need to lock it, do so -->
<if COND="Variables.lockit=true">
<then>
	 <ASSET.CHECKOUT OBJECTTYPE="Variables.AssetType" OBJECTID="Variables.id"/>
	 <setvar NAME="locked" VALUE="true"/>
	 <setvar NAME="checkoutmethod" VALUE="implicit"/>
		 
</then>
</if>

</FTCS>
