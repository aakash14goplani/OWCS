<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Admin/Publish/ApproveChunk
-
- INPUT
		Varibles.chunksize
		Variables.query
		Variables.assettypes

- OUTPUT
-
-->
<DIV STYLE="margin-left : 20px">
<SETCOUNTER NAME="listnum" VALUE="1"/>
<STRINGLIST NAME="types" STR="Variables.assettypes" DELIM=";"/>
<IF COND="IsList.types=true">
<THEN>
	<LOOP LIST="types">
		<br/>
		<SETVAR NAME="errno" VALUE="0"/>
		<SETVAR NAME="tablename" VALUE="types.ITEM"/>
		<SETVAR NAME="assettype" VALUE="types.ITEM"/>
		<setvar NAME="thequery" VALUE="Variables.query"/>
		<EXECSQL SQL="Variables.thequery" LIST="assetsToApproveCounters.listnum"/>
		<IF COND="IsError.Variables.errno=true">
		<THEN>
			<IF COND="Variables.errno=-101">
			<THEN>
				<XLAT.STREAM KEY="dvin/UI/Admin/QueryquerynumthequeryNoassetsreturned" ENCODE="false"/><br/>
			</THEN>
			<ELSE>
				<XLAT.STREAM KEY="dvin/UI/Admin/Error/errnoexecutingqueryquerynumthequery" errno="Variables.errno" thequery="Variables.thequery" querynum="Counters.querynum" EVALALL="false"/><br/>
			</ELSE>
			</IF>		  
		</THEN>
		<ELSE>
			<ASSETTYPE.LOAD NAME="at" FIELD="assettype" VALUE="Variables.assettype"/>
			<ASSETTYPE.GET NAME="at" FIELD="description"/>
			<XLAT.STREAM KEY="dvin/UI/Admin/ApprovingAssets"/><br/>
			<XLAT.STREAM KEY="dvin/UI/Admin/Queryquerynumthequeryassetsreturned" ENCODE="false"/><br/>
		</ELSE>
		</IF>
		<INCCOUNTER NAME="listnum" VALUE="1"/>
		<INCCOUNTER NAME="querynum" VALUE="1"/>
		<REMOVEVAR NAME="assettype"/>
		<REMOVEVAR NAME="description"/>
		<STREAM.FLUSH/>
	</LOOP>
	
	<SETCOUNTER NAME="numEntries" VALUE="0"/>
	<SETCOUNTER NAME="listnum" VALUE="1"/>
	<GOTOROW LIST="types" ROWNUM="1"/>
	
	<LISTOBJECT.CREATE NAME="listobject" COLUMNS="assetid,assettype" />
	<LOOP LIST="types">
		<SETVAR NAME="listname" VALUE="assetsToApproveCounters.listnum"/>
		<if COND="IsList.Variables.listname=true">
		<then>
			<IF COND="Variables.listname.#numRows!=0">
			<THEN>
				<!-- approve by chunk size assets at a time to avoid timeout -->
				<LOOP LIST="Variables.listname">
					<REMOVEVAR NAME="id"/>
					<REMOVEVAR NAME="type"/>
					<setvar NAME="assetid" VALUE="Variables.listname.id"/>
					<!-- debug 
					ID=<CSVAR NAME="Variables.assetid"/>type=<CSVAR NAME="types.ITEM"/><br/>
					-->
				    <LISTOBJECT.ADDROW NAME="listobject"
					        assetid="Variables.assetid"
					        assettype="types.ITEM" />
					   <INCCOUNTER NAME="numEntries" VALUE="1"/>
						<!-- if we have reached our chunksize then send this chunk-->
						<if COND="Counters.numEntries=Variables.chunksize">
						<then>
							<b><XLAT.STREAM KEY="dvin/UI/Admin/Approvingchunksizeassets"/></b><br/>
							<STREAM.FLUSH/>
							<SETVAR NAME="errno" VALUE="0"/>
							<LISTOBJECT.TOLIST NAME="listobject" LISTVARNAME="assetlist" />
							<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/ApproveAssets">
								<ARGUMENT NAME="target" VALUE="Variables.target"/>
								<ARGUMENT NAME="list" VALUE="assetlist"/>
								<ARGUMENT NAME="recursive" VALUE="Variables.recursive"/>
								<ARGUMENT NAME="force" VALUE="Variables.force"/>
							</CALLELEMENT>
							<!-- check for session timeout -->
							<if COND="IsError.Variables.errno=true">
							<then>
								<USERISMEMBER GROUP="xceladmin"/>
								<if COND="Variables.errno!=1">
								<then> 
									<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/BulkApprovalSessionTimeout" VARNAME="msgtext"/>
									<div class="width-outer-70">
									<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
										<ARGUMENT NAME="severity" VALUE="error"/>
									</CALLELEMENT>
									</div>
								  	<throwexception/>
								</then>
								</if>
							</then>
							</if>

							<LISTOBJECT.CREATE NAME="listobject" COLUMNS="assetid,assettype" />
							<SETCOUNTER NAME="numEntries" VALUE="0"/>
						</then>
						</if>
					</LOOP>
			</THEN>
			</IF>
		</then>
		</if>
		<INCCOUNTER NAME="listnum" VALUE="1"/>
	</LOOP>
	<if COND="Counters.numEntries!=0">
	<then>
		<b><XLAT.STREAM KEY="dvin/UI/Admin/ApprovingCountersnumEntriesassets"/></b><br/>
		<STREAM.FLUSH/>
		<SETVAR NAME="errno" VALUE="0"/>
		<LISTOBJECT.TOLIST NAME="listobject" LISTVARNAME="assetlist" />
		<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/ApproveAssets">
			<ARGUMENT NAME="target" VALUE="Variables.target"/>
			<ARGUMENT NAME="list" VALUE="assetlist"/>
			<ARGUMENT NAME="recursive" VALUE="Variables.recursive"/>
			<ARGUMENT NAME="force" VALUE="Variables.force"/>
		</CALLELEMENT>
		<!-- check for session timeout -->
		<if COND="IsError.Variables.errno=true">
		<then>
			<USERISMEMBER GROUP="xceladmin"/>
			<if COND="Variables.errno!=1">
			<then>
				<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/BulkApprovalSessionTimeout" VARNAME="msgtext"/>
				<div class="width-outer-70">
				<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					<ARGUMENT NAME="severity" VALUE="error"/>
				</CALLELEMENT>
				</div>
			  	<throwexception/>
			</then>
			</if>
		</then>
		</if>
	</then>
	</if>
</THEN>
</IF>
</DIV>
		

</FTCS> 
