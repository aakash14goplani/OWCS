<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
    <PROPERTY.GET PARAM="xcelerate.charset" INIFILE="futuretense_xcel.ini" VARNAME="charset"/>
<SETVAR NAME="cs.contenttype" VALUE="text/html; charset=Variables.charset"/>
<!-- OpenMarket/Xcelerate/Admin/Publish/CopyAuxiliaryTablesPost
-
- INPUT
-
- OUTPUT
-
-->
<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/BasicEnvironment"/>
<STRING.ENCODE VARIABLE="cs_environment" VARNAME="cs_environment"/>
<STRING.ENCODE VARIABLE="cs_formmode" VARNAME="cs_formmode"/>
<HTML>
<HEAD>
<PROPERTY.GET PARAM="xcelerate.domain" INIFILE="futuretense_xcel.ini" VARNAME="docDomain"/>
<IF COND="IsVariable.docDomain=true">
<THEN>
	<IF COND="Variables.docDomain!=Variables.empty">
	<THEN>
	    <SCRIPT LANGUAGE="JavaScript">
		document.domain = "<CSVAR NAME="Variables.docDomain"/>";
	    </SCRIPT>
	</THEN>
	</IF>
</THEN>
</IF>
</HEAD>
<setvar NAME="doproceed" VALUE="true"/>
<!-- first check to see if the user is logged in or not -->
<SETVAR NAME="errno" VALUE="0"/>
<USERISMEMBER GROUP="xceladmin"/>
<if COND="Variables.errno=0">
	<then>
        <SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/Util/ShowError" outstring="urlshowerror">
            <satellite.argument name="cs_environment" value="Variables.cs_environment"/>
            <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
                                          <satellite.argument name="error" value="AdminTimeoutError"/>
                                           </SATELLITE.LINK>
		<REPLACE STR="Variables.urlshowerror">
			<script LANGUAGE="JavaScript">
				parent.parent.location="Variables.urlshowerror";
			</script>
		</REPLACE>
		<throwexception/>
	</then>
</if>
<BODY BGCOLOR="#FFFFFF">

<PUBTARGETMANAGER.LOAD ID="Variables.pubtargetid" OBJVARNAME="pubtgt"/>
<PUBTARGET.GETNAME NAME="pubtgt" VARNAME="pubtgt:name"/>
<setcounter NAME="pubsDone" VALUE="0"/>

<PUBSESSIONMANAGER.CREATE TARGET="Variables.pubtargetid" USER="SessionVariables.username" VARNAME="pubsess:id"/>
<if COND="IsError.Variables.errno=true">
<then>
 	<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/notcreatepublishingsessionerrno" errno="Variables.errno" EVALALL="false" VARNAME="msgtext"/>
 	<div class="width-outer-70">
	<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
	    <ARGUMENT NAME="severity" VALUE="error"/>
	</CALLELEMENT>            
	</div>
 	<setvar NAME="doproceed" VALUE="false"/>            
	<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Variables.msgtext"/>
	<PUBSESSIONMANAGER.FAIL ID="Variables.pubsess:id"/>
</then>
<else>
	<PUBSESSIONMANAGER.LOAD ID="Variables.pubsess:id" OBJVARNAME="pubsess"/>
	<PROPERTY.GET PARAM="xcelerate.remotecall" INIFILE="futuretense_xcel.ini" VARNAME="propremotecall"/>
	<MIRRORQUEUE.CREATE NAME="pubMirrorQ" SESSION="pubsess" PAGENAME="Variables.propremotecall"/>
	<if COND="IsError.Variables.errno=true">
	<then>
    	<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/notcreatemirrorqueueerrno" errno="Variables.errno" EVALALL="false" VARNAME="msgtext"/>
		<if COND="IsVariable.errdetail1=true">
		<then>
			<SETVAR NAME="msgtext" VALUE="Variables.msgtext Variables.errdetail1"/>
		</then>
		</if>
		<div class="width-outer-70">
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
		    <ARGUMENT NAME="severity" VALUE="error"/>
		</CALLELEMENT>   
		</div>         
 		<setvar NAME="doproceed" VALUE="false"/>            
		<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Variables.msgtext"/>
		<PUBSESSIONMANAGER.FAIL ID="Variables.pubsess:id"/>
	</then>
	</if>
</else>
</if>

<if COND="Variables.doproceed=true">
<then>
	
		
	<!-- Auxilliary tables -->
	<SETCOUNTER NAME="catalogsDone" VALUE="0"/>
	 <if COND="IsVariable.catalogs=true">
	 <then>
	    <STRINGLIST NAME="tablesToMirror" STR="Variables.catalogs" DELIM=";"/>
	    <LOOP LIST="tablesToMirror">
			<PROPERTY.GET PARAM="cc.tablesToMirror.ITEMKey" INIFILE="futuretense.ini" VARNAME="key"/>
			<if COND="Variables.key=Variables.empty">
			<then>
				<PROPERTY.GET PARAM="cc.contentkey" INIFILE="futuretense.ini" VARNAME="key"/>
			</then>
			</if>
		    <SELECTTO LIST="allItems" FROM="tablesToMirror.ITEM" WHAT="*"/>
		    <if COND="IsList.allItems=true">
		    <then>
			    <if COND="allItems.#numRows!=0">
			    <then>
			    	<INCCOUNTER NAME="catalogsDone" VALUE="1"/>
				 	<XLAT.LOOKUP KEY="dvin/UI/Admin/AddingallItemtablesToMirrortablemirrorq" VARNAME="msgtext1"/>
					<XLAT.LOOKUP KEY="dvin/Common/Successfulcompletion" VARNAME="msgtext2"/>
					<SETVAR NAME="msgtext" VALUE="Variables.msgtext1 Variables.msgtext2"/>
				 	<div class="width-outer-70" style="margin-top:0">
					<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					    <ARGUMENT NAME="severity" VALUE="info"/>
					</CALLELEMENT> 
					</div>           
				    <LOOP LIST="allItems">
					 	<MIRRORQUEUE.SENDROW NAME="pubMirrorQ" TABLENAME="tablesToMirror.ITEM" FIELD1="Variables.key" VALUE1="allItems.Variables.key"/>
					 </LOOP>
				 </then>
				 <else>
				 	<XLAT.LOOKUP KEY="dvin/UI/Admin/NorowsfoundfortablesToMirrorITEM" VARNAME="msgtext"/>
				 </else>
				 </if>
			</then>
			<else>
				<SETVAR NAME="tablename" VALUE="tablesToMirror.ITEM"/>
				<STRING.ENCODE VARIABLE="tablename" VARNAME="tablename"/>
		    	<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/ErrorGettingTableDaterrno" errno="Variables.errno" EVALALL="false" VARNAME="msgtext"/>
		    	<div class="width-outer-70" style="margin-top:0">
				<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
				    <ARGUMENT NAME="severity" VALUE="warning"/>
				</CALLELEMENT>   
				</div>         
			</else>
			</if>
		</LOOP>
	</then>
	</if>
	
	<!-- if no data to mirror, do nothing -->
	<if COND="Counters.pubsDone=0">
	<then>
		<if COND="Counters.catalogsDone=0">
		<then>
			<SETVAR NAME="cancelled" VALUE="true"/>
			<XLAT.LOOKUP KEY="dvin/UI/Admin/NoDatatomirror" VARNAME="msgtext"/>
			<div class="width-outer-70" style="margin-top:0">
			<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			    <ARGUMENT NAME="severity" VALUE="error"/>
			</CALLELEMENT> 
			</div>           
			<MIRRORQUEUE.CANCEL NAME="pubMirrorQ"/>
		</then>
		</if>
	</then>
	</if>
	
	<if COND="Variables.cancelled!=true">
	<then>
		<MIRRORQUEUE.CLOSE NAME="pubMirrorQ"/>
	</then>
	</if>

	<if COND="IsError.Variables.errno!=false">
	<then>
		<SETVAR NAME="saveerrno" VALUE="Variables.errno"/>
	 	<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/duringmirroroperationerrno" errno="Variables.errno" EVALALL="false" VARNAME="msgtext"/>
		<if COND="Variables.saveerrno=-103">
		<then>
	 		<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/DescriptionOfError-103" VARNAME="errdetail1"/>
		</then>
		</if>
		<if COND="IsVariable.errdetail1=true">
		<then>
			<SETVAR NAME="msgtext" VALUE="Variables.msgtext Variables.errdetail1"/>
		</then>
		</if>
	 	<div class="width-outer-70" style="margin-top:0">
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
		    <ARGUMENT NAME="severity" VALUE="error"/>
		</CALLELEMENT>   
		</div>         
		<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Variables.msgtext"/>
		<PUBSESSIONMANAGER.FAIL ID="Variables.pubsess:id"/>
	</then>
	</if>
</then>
</if>
	
<!-- only save in PubHistory if we were unsuccessful -->
<PUBSESSIONMANAGER.STATUS ID="Variables.pubsess:id" VARNAME="status"/>
<if COND="Variables.status=done">
<then>
	<PUBSESSIONMANAGER.DELETE ID="Variables.pubsess:id"/>
</then>
</if>

<CALLELEMENT NAME="OpenMarket/Xcelerate/Admin/Publish/CopyAuxiliaryTablesEdit">
		    <ARGUMENT NAME="id" VALUE="Variables.pubtargetid"/>
		</CALLELEMENT> 


</BODY>
</HTML>

</FTCS> 
