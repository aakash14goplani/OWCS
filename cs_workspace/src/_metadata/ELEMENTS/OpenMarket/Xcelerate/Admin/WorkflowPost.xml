<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<PROPERTY.GET PARAM="xcelerate.charset" INIFILE="futuretense_xcel.ini" VARNAME="charset"/>
<SETVAR NAME="cs.contenttype" VALUE="text/html; charset=Variables.charset"/>

<!--
Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Admin/WorkflowPost.xml 

-->

<!--
- Confidential and Proprietary Information of Oracle Corp.
-					All Rights Reserved.
-
- DESCRIPTION
-	Admin things about a workflow process
-->
<!--
 [2007-09-1x KG]
 * XSS fixes (adapted from 6.3 fixes):
   * isCleanString function usage
   * CSVAR -> STRING.STREAM
 [2007-10-09 KG]
 * XSS revision: minimized set of restricted characters.
-->

<!-- Perform all the basic initialization. -->

<HTML>
<HEAD>
	<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/StandardHeader"/>
	<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/SetStylesheet"/>
</HEAD>
 <CALLELEMENT NAME="OpenMarket/Xcelerate/Admin/UserProfileCommon"/>




<!--*****************************  POST PAGE *************************-->


    	<if COND="Variables.action=delete">
    	<then>
		<!-- Process deletion of stuff, and display either an error, or confirmation that the delete was successful.
			The hidden form element "processid" will also be set!
		-->
		<TABLE BGCOLOR="#FFFFFF" CELLSPACING="0" CELLPADDING="0" class="width-outer-70">
		<TR>
			<TD BGCOLOR="#FFFFFF" COLSPAN="2">
				<FONT FACE="Arial, Helvetica" SIZE="2">
					<h3>
						<XLAT.STREAM KEY="dvin/UI/Admin/DeleteProcess"/> <em><STRING.STREAM VARIABLE="wfp:name"/></em>
					</h3>
				</FONT>
			</TD>
		</TR>
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/TitleBar"/>
		<TR>
			<TD BGCOLOR="#FFFFFF">

				<!-- Attempt to delete the workflow -->
				<WORKFLOWENGINE.GETPROCESSNAME OBJVARNAME="deleteprocess" NAME="Variables.wfp:name"/>
				<WORKFLOWPROCESS.GETID NAME="deleteprocess" VARNAME="processid"/>

				<WORKFLOWENGINE.DELETEPROCESSID OBJVARNAME="deleteprocess" ID="Variables.processid"/>

				<FONT FACE="Arial, Helvetica" SIZE="2">
					<if COND="IsError.Variables.errno=true">
					<then>
						<callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
							<argument NAME="error" VALUE="DeleteFailed"/>
						</callelement>
					</then>
					<else>
						<XLAT.STREAM KEY="dvin/UI/Deletesuccessful"/>
						<PROPERTY.GET PARAM="xcelerate.treeType" INIFILE="futuretense_xcel.ini" VARNAME="proptreetype"/>
						<if COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
						<then>
							<callelement NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype">
								<argument NAME="__TreeRefreshKeys__" VALUE="Self:Workflow_Process"/>
							</callelement>	
						</then>
						</if>
					</else>
					</if>
				</FONT>
			</TD>
		</TR>
		</TABLE>
	</then>
	</if> <!--delete-->

    	<if COND="Variables.action=cancel">
    	<then>

		<!-- Cancel process work, and display confirmation that that's what happened -->

		<TABLE BGCOLOR="#FFFFFF" CELLSPACING="0" CELLPADDING="0" class="width-outer-70">
		<TR>
			<TD BGCOLOR="#FFFFFF" COLSPAN="2">
				<FONT FACE="Arial, Helvetica" SIZE="2">
					<h3>
						<setvar NAME="key" VALUE="dvin/UI/Admin/Variables.CancelFrom"/>
						<if COND="IsVariable.wfp:id=false">
						<then>
							<XLAT.STREAM KEY="dvin/UI/Admin/CancelCreatingNewProcess"/> 
						</then>
						<else>
							<setvar NAME="key" VALUE="dvin/UI/Admin/Variables.CancelFrom"/>
							<XLAT.STREAM KEY="Variables.key" REPLACEALL="Variables.key"/> <em><STRING.STREAM VALUE="   Variables.wfp:name"/></em>
						</else>
						</if>
					</h3>
				</FONT>
			</TD>
		</TR>
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/TitleBar"/>
		<TR>
			<TD BGCOLOR="#FFFFFF">
				<XLAT.STREAM KEY="dvin/UI/Cancelsuccessful"/>
			</TD>
		</TR>
		</TABLE>
		
		<setvar NAME="DisplayDetailsOfProcess" VALUE="no"/>
		<if COND="Variables.CancelFrom=CancelDeletingProcess">
		<then>
			<setvar NAME="DisplayDetailsOfProcess" VALUE="yes"/>
		</then>
		</if>
		<if COND="Variables.CancelFrom=CancelEditingProcess">
		<then>
			<setvar NAME="DisplayDetailsOfProcess" VALUE="yes"/>
		</then>
		</if>
		<if COND="Variables.CancelFrom=CancelCopyingProcess">
		<then>
			<setvar NAME="DisplayDetailsOfProcess" VALUE="yes"/>
		</then>
		</if>
	
		<if COND="Variables.CancelFrom!=CancelCreatingNewProcess">
		<then>
			<if COND="Variables.DisplayDetailsOfProcess=yes">
			<then>
				<!-- We canceled the creation of a new process -->
				<!-- Call the front form to display the details of the workflow as it exists
					now that the current editing work was canceled.
				-->
				<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowFront">
					<argument NAME="workflow" VALUE="Variables.wfp:name"/>
					<argument NAME="action" VALUE="details"/>
					<argument NAME="showtitle" VALUE="false"/>
				</callelement>
			</then>
			<else>
				<!-- We canceled editing of an existing process -->
				<!-- Call the front form. -->
				<!-- Hmm.   The code here attempts to gather stuff that was posted from 
					the edit page.  That seems strange because we should be 
					abandoning that info....  KDW
				-->
				<!-- WORKFLOWENGINE.GETPROCESSNAME OBJVARNAME="sprocess" NAME="Variables.wfp:name"/>
				<WORKFLOWPROCESS.SCATTER PREFIX="wfp:" NAME="sprocess"/>
				<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowData">
					<argument NAME="DataAction" VALUE="datafromprocesspage"/>
				</callelement>
				<WORKFLOWPROCESS.GATHER PREFIX="wfp:" NAME="sprocess"/ -->
				<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowFront">
					<argument NAME="workflow" VALUE="Variables.wfp:name"/>
					<argument NAME="action" VALUE="update"/>
					<argument NAME="showtitle" VALUE="false"/>
				</callelement>
			</else>
			</if>
		</then>
		</if>

	</then>
    	</if> <!--cancel-->

    	<if COND="Variables.action=save">
    	<then>
		<!-- Post occurred because of save -->
		 
		<if COND="Variables.Copy=yes">
		<then>
			<!-- We are doing a copy.  The id, name, and description should be cleared first -->
			<WORKFLOWENGINE.GETPROCESSNAME OBJVARNAME="cprocess" NAME="Variables.wfp:name"/>
			<WORKFLOWPROCESS.SCATTER PREFIX="wfp:" NAME="cprocess"/>

			<setvar NAME="wfp:id" VALUE="Variables.empty"/>
			<setvar NAME="wfp:name" VALUE="Variables.pName"/>
			<setvar NAME="wfp:description" VALUE="Variables.description"/>

			<WORKFLOWENGINE.CREATENEWPROCESS OBJVARNAME="newprocess"/>
			<WORKFLOWPROCESS.GATHER PREFIX="wfp:" NAME="newprocess"/>

			<WORKFLOWENGINE.SETPROCESS OBJECT="newprocess"/>
			<if COND="Variables.errno!=0">
			<then>
				<!-- Presume an error return means that process already exists -->
				<setvar NAME="errno" VALUE="0"/>
				<WORKFLOWENGINE.GETPROCESSNAME NAME="Variables.wfp:name" OBJVARNAME="newprocess"/>
				<if COND="Variables.errno=0">
				<then>
					<callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
						<argument NAME="error" VALUE="AlreadyExistingProcess"/>
					</callelement>  
					<throwexception/>
				</then>
				</if>
			</then>
			<else>
				<!-- No error code meant that the process saved properly -->
				<!-- update tree -->
				<PROPERTY.GET PARAM="xcelerate.treeType" INIFILE="futuretense_xcel.ini" VARNAME="proptreetype"/>
				<if COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
				<then>
					<callelement NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype">
						<argument NAME="__TreeRefreshKeys__" VALUE="Self:Workflow_Process"/>
					</callelement>	
				</then>
				</if>
			</else>
			</if><!-- existing process -->
			
			<!-- Hmm.  Looks like we throw some hidden variables into the mix, not sure why -->

			<WORKFLOWPROCESS.SCATTER PREFIX="wfp:" NAME="newprocess"/>
			<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowData">
				<argument NAME="DataAction" VALUE="hiddenvariables"/>
			</callelement>

		</then> <!-- copy ends here -->
		<else>
		
			<!-- We are doing a save, but NOT doing a copy -->
			
			<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowData">
				<argument NAME="DataAction" VALUE="datafromprocesspage"/>
			</callelement>

			<!-- As an effect of the save, we want everything to be reloaded from the
				database.  This means that we do *not* repost variables!  Just the one
				we need to describe the workflow process.
			-->

			<!-- create process and gather with prefix wfp:-->
			<WORKFLOWENGINE.CREATENEWPROCESS OBJVARNAME="newprocess"/>
			<WORKFLOWPROCESS.GATHER PREFIX="wfp:" NAME="newprocess"/>
			
			<!-- Save the process now -->
			<WORKFLOWENGINE.SETPROCESS OBJECT="newprocess"/>  

			<if COND="Variables.errno!=0">
			<then>
				<!-- if process already existed, log an error making sure to mention existing process name etc. -->
				<if COND="IsVariable.wfp:id=false">
				<then>
					<!-- We should be able to tell you about the already-existing process -->
					<setvar NAME="errno" VALUE="0"/>
					<WORKFLOWENGINE.GETPROCESSNAME NAME="Variables.wfp:name" OBJVARNAME="newprocess"/>
					<if COND="Variables.errno=0">
					<then>
						<callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
							<argument NAME="error" VALUE="AlreadyExistingProcess"/>
						</callelement>  
						<throwexception/>
					</then>
					<else>
						<!-- We really need to handle the error if we create the process but it fails!! -->
						<callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
							<argument NAME="error" VALUE="ErrorSavingProcess"/>
						</callelement> 
						<throwexception/>
					</else>
					</if>
				</then>
				<else>
					<!-- We really need to handle the error if we update the process but it fails!! -->
					<callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
						<argument NAME="error" VALUE="ErrorSavingProcess"/>
					</callelement> 
					<throwexception/>
				</else>
				</if>
			</then>
			<else>
				<!-- Save succeeded, process updated or new process created -->
				
				<PROPERTY.GET PARAM="xcelerate.treeType" INIFILE="futuretense_xcel.ini" VARNAME="proptreetype"/>
				<if COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
				<then>
					<callelement NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype">
						<argument NAME="__TreeRefreshKeys__" VALUE="Self:Workflow_Process"/>
					</callelement>	
				</then>
				</if>
				<!-- The variable is used to determine later if the workflow has been saved/updated or just being loaded.
				 If its updated, suitable message will be displayed.-->
				<INPUT TYPE="HIDDEN" NAME="updated" VALUE="true"/>
				
			</else>
			
			</if><!-- existing process -->
			
			<!-- Looks like we rescatter just-saved process, probably just to get the id -->
			<WORKFLOWPROCESS.SCATTER PREFIX="wfp:" NAME="newprocess"/>
		</else>
		</if>

		<INPUT TYPE="HIDDEN" NAME="pagename" VALUE=""/>
		<STRING.ENCODE VARIABLE="action" VARNAME="action"/>
		<INPUT TYPE="HIDDEN" NAME="action" VALUE="Variables.action" REPLACEALL="Variables.action"/>
		
		<!-- Post "processid", so details knows what to display -->
		<if COND="IsVariable.wfp:id=true">
		<then>
			<STRING.ENCODE VARIABLE="wfp:id" VARNAME="wfp:id"/>
			<INPUT TYPE="HIDDEN" NAME="processid" VALUE="Variables.wfp:id" REPLACEALL="Variables.wfp:id"/>
		</then>
		</if>
		
		<SCRIPT LANGUAGE="JavaScript">
<![CDATA[
frm = document.forms[0];
frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFront";
frm.elements['action'].value = "details";
frm.submit();
]]>
		</SCRIPT>

	</then>
	</if>

 <!--post-->

</HTML>
</FTCS>
