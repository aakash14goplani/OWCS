<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Admin/WorkflowSubjectPost

 INPUT

 OUTPUT

-->
<!--
 [2007-09-17 KGF]
 * XSS fixes (adapted from 6.3 fixes):
   * isCleanString function usage
   * CSVAR NAME -> STRING.STREAM VALUE
 * changed definitions of 'obj' to just forms[0] (not .elements[0])
 [2007-10-09 KGF]
 * XSS revision: minimized set of restricted characters.
 [2008-02-26 KGF]
 * further XSS fix: encode HTML special chars in description/subject.
-->



<!-- process deletion of stuff -->


    <!-- process deletion of stuff -->
    <if COND="Variables.action=delete">
    <then>

                <setvar NAME="errno" VALUE="0"/>
	  
	  			<EMAILMANAGER.LOAD OBJVARNAME="delaction" ID="Variables.id"/>
		    		<EMAIL.SCATTER PREFIX="wfdelete:" NAME="delaction"/>
			
					
		
		    		<EMAILMANAGER.DELETE OBJVARNAME="delaction" ID="Variables.wfdelete:id"/>

                <if COND="Variables.errno!=0">
                <then>
                    <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
                        <argument NAME="error" VALUE="DeleteFailed"/>
                    </callelement>            
                </then>
                <else>
                    <XLAT.STREAM KEY="dvin/UI/Deletesuccessful"/>
                    <callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowSubjectFront">
                        <argument NAME="action" VALUE="list"/>
                        <argument NAME="showtitle" VALUE="true"/>
                    </callelement>
                </else>
                </if>
    </then>
    </if>

    <!-- process addition of stuff -->
    <if COND="Variables.action=new">
    <then>
                <if COND="IsVariable.name!=true">
                <then>
                    <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
                        <argument NAME="error" VALUE="NoName"/>
                    </callelement>            
                    <throwexception/>
                </then>
                </if>
                <!-- insert the specified information
                    into the table. Report any errors.
                    Refresh the navigation -->
                <if COND="IsVariable.description!=true">
                <then>
                    <setvar NAME="description" VALUE="Variables.empty"/>
                </then>
                </if>
                <if COND="IsVariable.subject!=true">
                <then>
                    <setvar NAME="subject" VALUE="Workflow Notice"/>
                </then>
                </if>
                <if COND="IsVariable.body!=true">
                <then>
                    <setvar NAME="body" VALUE="Variables.empty"/>
                </then>
                </if>
	          <if COND="Variables.existingaction=false">
		    <then>
	  				<EMAILMANAGER.CREATE OBJVARNAME="newemailobject"/>
		    </then>
		    <else>
	  				<EMAILMANAGER.LOAD OBJVARNAME="newemailobject" ID="Variables.id"/>
		    </else>
		    </if>	

			<REMOVEVAR NAME="action"/>
		    <EMAIL.SCATTER PREFIX="wfa:" NAME="newemailobject"/>
		    <setvar NAME="wfa:name" VALUE="Variables.name"/>
		    <setvar NAME="wfa:description" VALUE="Variables.description"/>
		    <setvar NAME="wfa:subject" VALUE="Variables.subject"/>
		    <setvar NAME="wfa:body" VALUE="Variables.body"/>

		    <EMAIL.GATHER PREFIX="wfa:" NAME="newemailobject"/>
		    <EMAIL.SCATTER PREFIX="wf:" NAME="newemailobject"/>

		    <EMAILMANAGER.SAVE OBJECT="newemailobject"/>
	  		<EMAIL.GETID NAME="newemailobject" VARNAME="subid"/>
            <SETVAR NAME="action" VALUE="new"/>
                    <callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowSubjectFront">
                        <argument NAME="id" VALUE="Variables.subid"/>
                        <argument NAME="action" VALUE="details"/>
                        <argument NAME="showtitle" VALUE="true"/>
                    </callelement>
    </then>
    </if>
	 
	<PROPERTY.GET PARAM="xcelerate.treeType" INIFILE="futuretense_xcel.ini" VARNAME="proptreetype"/>
	<if COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
	<then>
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype">
			<argument NAME="__TreeRefreshKeys__" VALUE="Self:Workflow_Email"/>
		</callelement>		
	</then>
	</if>
 

</FTCS> 
