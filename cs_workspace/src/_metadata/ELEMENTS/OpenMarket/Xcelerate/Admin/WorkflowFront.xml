<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<PROPERTY.GET PARAM="xcelerate.charset" INIFILE="futuretense_xcel.ini" VARNAME="charset"/>
<SETVAR NAME="cs.contenttype" VALUE="text/html; charset=Variables.charset"/>

<!--
Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Admin/Workflow.xml 

-->

<!--
- Confidential and Proprietary Information of Oracle Corp.
-					All Rights Reserved.
-
- DESCRIPTION
-	Admin things about a workflow process
-->
<!--
 [2007-09-1x KG]
 * XSS fixes (adapted from 6.3 fixes):
   * isCleanString function usage
   * CSVAR -> STRING.STREAM
 [2007-10-09 KG]
 * XSS revision: minimized set of restricted characters.
-->

<!-- Perform all the basic initialization. -->


<CALLELEMENT NAME="OpenMarket/Xcelerate/Scripts/ValidateInputForXSS" />
<HTML>
<HEAD>
	<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/StandardHeader"/>
	<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/SetStylesheet"/>
</HEAD>

 <CALLELEMENT NAME="OpenMarket/Xcelerate/Admin/UserProfileCommon"/>


<!--*****************************  FRONT PAGE *************************-->

	<!-- Do the "front" page -->
	
	<SCRIPT LANGUAGE="JavaScript">

<![CDATA[

function AddStep(frm) 
{  
    action = frm.elements['action'].value;
    choice = "steps";    
    frm.elements['action'].value = action;
    frm.elements['subaction'].value = choice;    
     
	frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowRoutesFront";
	frm.elements['stepaction'].value = "add";
	frm.submit();
}
function EditStep(frm,id) 
{ 
	frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowRoutesFront";
	frm.elements['stepaction'].value = "edit";
	frm.elements['stepid'].value = id;
	frm.submit();
}

function RemoveStep(frm,id) 
{ 
        if (confirm(]]>"<XLAT.STREAM KEY="dvin/UI/Admin/RemoveStep" ESCAPE="true" ENCODE="false"/>"<![CDATA[))
        {
	
	frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowRoutesFront";
	frm.elements['stepaction'].value = "delete";
	frm.elements['stepid'].value = id;
	frm.submit();
	}
}

function AddFunctionPrivs(frm,id) 
{ 
	frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFunctionPrivsFront";
	frm.elements['privaction'].value = "new";
	frm.elements['fprole'].value = id;
	frm.submit();
}

function RemoveFunctionPrivs(frm, func, state, role) 
{ 
        if (confirm(]]>"<XLAT.STREAM KEY="dvin/UI/Admin/RemovePriv" ESCAPE="true" ENCODE="false"/>"<![CDATA[))
        {
	frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFunctionPrivsFront";
	frm.elements['privaction'].value = "delete";
	frm.elements['fpfunctionid'].value = func;
	frm.elements['fpstateid'].value = state;
	frm.elements['fprole'].value = role;
	frm.submit(); 
	}
}
function Apply(obj) 
{ 
	obj.form.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowRoutesFront";
	obj.form.elements['stepaction'].value = "apply";
	obj.form.submit();
}

function SaveProcess(frm) 
{ 
	frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowPost";
	frm.elements['action'].value = "save";
	frm.submit();
}

function DeleteProcess(frm, id) 
{ 
	frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowPost";
	frm.elements['action'].value = "delete";
	frm.elements['processid'].value = id;
	frm.submit();
}

function InspectProcess(frm) 
{ 
	frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFront";
	frm.elements['action'].value = "details";
	frm.submit();
}
function CheckStartStepOnly(frm)
{
	if (frm.elements['IsStartStep'].value=="false")
	{
		]]>
		alert("<XLAT.STREAM KEY="dvin/UI/Error/specifystartstepprocess" ESCAPE="true" ENCODE="false"/>");
		<![CDATA[
		return false;
	}
	return true;
}
function DetailProcess(frm) 
{
	var isclean = isCleanString(frm.elements['pName'].value, '<">', true);	
	if (!isclean) {
		alert("]]><XLAT.STREAM KEY="dvin/FlexibleAssets/Attributes/ApostropheNotAllowedMinimal" ESCAPE="true" ENCODE="false"/><![CDATA[");
		return false;
	}
	if (frm.elements.Copy.value=="yes")
	{
		if (frm.elements['pName'].value=="")
		{
			]]>
			alert("<XLAT.STREAM KEY="dvin/UI/Error/specifynameprocess" ESCAPE="true" ENCODE="false"/>");
			<![CDATA[
			return false;
		}
		if (frm.elements['description'].value=="")
		{
			]]>
			alert("<XLAT.STREAM KEY="dvin/UI/Error/specifydescriptionprocess" ESCAPE="true" ENCODE="false"/>");
			<![CDATA[
			return false;
		}
		if (frm.elements['pName'].value==frm.elements.oldname.value)
		{
			]]>
			alert("<XLAT.STREAM KEY="dvin/UI/Admin/Error/specifyadifferentname" ESCAPE="true" ENCODE="false"/>");
			<![CDATA[
			return false;
		}

		if (frm.elements.description.value==frm.elements.olddescription.value)
		{
			]]>
			alert("<XLAT.STREAM KEY="dvin/UI/Admin/Error/specifyadifferentdescription" ESCAPE="true" ENCODE="false"/>");
			<![CDATA[
			return false;
		}
	}
	else
	{
		if (frm.elements['pName'].value=="")
		{
			]]>
			alert("<XLAT.STREAM KEY="dvin/UI/Error/specifynameprocess" ESCAPE="true" ENCODE="false"/>");
			<![CDATA[
			return false;
		}
		if (frm.elements['description'].value=="")
		{
			]]>
			alert("<XLAT.STREAM KEY="dvin/UI/Error/specifydescriptionprocess" ESCAPE="true" ENCODE="false"/>");
			<![CDATA[
			return false;
		}
		if (frm.pubid.options.selectedIndex=="-1")
		{
			]]>
			alert("<XLAT.STREAM KEY="dvin/UI/Error/specifysiteprocess" ESCAPE="true" ENCODE="false"/>");
			<![CDATA[
			return false;
		}
		if (frm.assettype.options.selectedIndex=="-1")
		{
			]]>
			alert("<XLAT.STREAM KEY="dvin/UI/Error/specifyassettypeprocess" ESCAPE="true" ENCODE="false"/>");
			<![CDATA[
			return false;
		}
		if (frm.roles.options.selectedIndex=="-1")
		{
			]]>
			alert("<XLAT.STREAM KEY="dvin/UI/Error/specifyroleprocess" ESCAPE="true" ENCODE="false"/>");
			<![CDATA[
			return false;
		}
		
		if (frm.elements['IsStartStep'].value=="false")
		{
			]]>
			alert("<XLAT.STREAM KEY="dvin/UI/Error/specifystartstepprocess" ESCAPE="true" ENCODE="false"/>");
			<![CDATA[
			return false;
		}
	}
	return true;
}

function CheckOtherFields(frm) 
{
	if (frm.elements['pName'].value=="")
	{
		]]>
		alert("<XLAT.STREAM KEY="dvin/UI/Error/specifynameprocess" ESCAPE="true" ENCODE="false"/>");
		<![CDATA[
		return false;
	}
	var isclean = isCleanString(frm.elements['pName'].value, '<">', true);	
	if (!isclean) {
		alert("]]><XLAT.STREAM KEY="dvin/FlexibleAssets/Attributes/ApostropheNotAllowedMinimal" ESCAPE="true" ENCODE="false"/><![CDATA[");
		return false;
	}
	if (frm.elements['description'].value=="")
	{
		]]>
		alert("<XLAT.STREAM KEY="dvin/UI/Error/specifydescriptionprocess" ESCAPE="true" ENCODE="false"/>");
		<![CDATA[
		return false;
	}
	if (frm.pubid.options.selectedIndex=="-1")
	{
		]]>
		alert("<XLAT.STREAM KEY="dvin/UI/Error/specifysiteprocess" ESCAPE="true" ENCODE="false"/>");
		<![CDATA[
		return false;
	}
	if (frm.assettype.options.selectedIndex=="-1")
	{
		]]>
		alert("<XLAT.STREAM KEY="dvin/UI/Error/specifyassettypeprocess" ESCAPE="true" ENCODE="false"/>");
		<![CDATA[
		return false;
	}
	if (frm.roles.options.selectedIndex=="-1")
	{
		]]>
		alert("<XLAT.STREAM KEY="dvin/UI/Error/specifyroleprocess" ESCAPE="true" ENCODE="false"/>");
		<![CDATA[
		return false;
	}
	return true;
}

function EditProcess(frm) 
{ 
	frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFront";
	frm.elements['action'].value = "update";
	frm.submit();
}

function GraphProcess(frm) 
{ 
	frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFront";
	frm.elements['subaction'].value = "graph";
	frm.submit();
}


function CancelProcess(frm, wflow) 
{ 
	frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowPost";
	frm.elements['action'].value = "cancel";
	frm.elements['wfp:name'].value = wflow;
	frm.submit();
}

function workflowHandler(frm, obj)
{
    action = frm.elements['action'].value;
    choice = obj.options[obj.selectedIndex].value;

    if (choice=="copy")
    {
     action = "update";
    }
         
    // Valid Actions:  details, update
    // Valid SubActions: steps, functions, process
    
    frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFront";
    frm.elements['action'].value = action;
    frm.elements['subaction'].value = choice;
    frm.submit();
    
}

function AddEditSteps(frm)
{

    frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFront";
    frm.elements['action'].value = "update";
    frm.elements['subaction'].value = "steps";
    frm.submit();
    
}
function ViewSteps(frm)
{

    frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFront";
    frm.elements['action'].value = "details";
    frm.elements['subaction'].value = "steps";
    frm.submit();
    
}
function AddEditFunctionPrivs(frm)
{

    frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFront";
    frm.elements['action'].value = "update";
    frm.elements['subaction'].value = "functions";
    frm.submit();
    
}
function ViewFunctionPrivs(frm)
{

    frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFront";
    frm.elements['action'].value = "details";
    frm.elements['subaction'].value = "functions";
    frm.submit();
    
}

function UpdateProcess(obj, wflow) 
{ 
	obj.form.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFront";
	obj.form.elements['action'].value = "update";
	obj.form.submit();
}

function confirmDeleteProcess(frm) 
{ 
	frm.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFront";
	frm.elements['action'].value = "confirmdelete";
	frm.elements['subaction'].value = "process";
	frm.submit();
}

function ResetPrivs(obj, wflow) 
{ 
	obj.form.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowFront";
	obj.form.elements['action'].value = "update";
	obj.form.elements['subaction'].value = "resetprivs";
	obj.form.submit();
}

function ShowStep(obj,name) 
{ 
	obj.form.elements['pagename'].value = "OpenMarket/Xcelerate/Admin/WorkflowRoutesFront";
	obj.form.elements['action'].value = "showstep";
	obj.form.elements['stepbyname'].value = name;
	obj.form.submit();
}

]]>
	</SCRIPT>

	<!-- These variables are filled in by various Javascript methods, as a way of telling the
		post page what to do.
	-->
	<STRING.ENCODE VARIABLE="action" VARNAME="action" />
	<INPUT TYPE="HIDDEN" NAME="pagename" VALUE=""/>
	<INPUT TYPE="HIDDEN" NAME="action" VALUE="Variables.action" REPLACEALL="Variables.action"/>
	<INPUT TYPE="HIDDEN" NAME="stepaction" VALUE=""/>
	<INPUT TYPE="HIDDEN" NAME="privaction" VALUE=""/>
	<INPUT TYPE="HIDDEN" NAME="stepid" VALUE=""/>
	<INPUT TYPE="HIDDEN" NAME="processid" VALUE=""/>
	<INPUT TYPE="HIDDEN" NAME="subaction" VALUE="" REPLACEALL=""/>

	<!-- Show the save message.-->

	<if COND="Variables.action=details">
    <then>
	<if COND="Variables.updated=true">
	<then>
	<table BORDER="0" CELLSPACING="0" CELLPADDING="0" class="width-outer-70">
	<tr><td>
	<XLAT.LOOKUP KEY="dvin/UI/WorkflowSaveWarning" ENCODE="false"  VARNAME="_xlat_save_warning"/>
					<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
						<argument NAME="msgtext" VALUE="Variables._xlat_save_warning"/>
						<argument NAME="severity" VALUE="warning"/>
					</callelement>	
	</td></tr>
	</table>
	</then>
	</if>
	</then>
	</if>

	<!-- End of message. -->
	
	<if COND="Variables.action=details">
	<then>
		<!--****** VIEW EXISTING PROCESS ******-->
		<!-- Note well: "Existing" means only that the process has been edited, and its details have been
			filled in.  It is possible to view a process that has not yet been saved!
			This action requires either the workflow id in a variable called "wfp:id", or in a variable called "processid",
			or, barring that, the name in a variable called "wfp:name", or in a variable called "workflow".
		-->

		<!-- load process -->
		<if COND="IsVariable.wfp:id=true">
		<then>
			<setvar NAME="processid" VALUE="Variables.wfp:id"/>
		</then>
		</if>
		
		<if COND="IsVariable.wfp:name=true">
		<then>
			<setvar NAME="workflow" VALUE="Variables.wfp:name"/>
		</then>
		</if>

		<!-- The load loads by name if the process id isn't available -->
		<if COND="IsVariable.processid!=true">
		<then>
			<substitute STR="Variables.workflow" WITH="%20" WHAT="/XCEL-SEP/" OUTSTR="sanefunction"/>
			<setvar NAME="workflow" VALUE="Variables.sanefunction"/>
			<WORKFLOWENGINE.GETPROCESSNAME NAME="Variables.workflow" OBJVARNAME="newprocess"/>
		</then>
		<else>
			<WORKFLOWENGINE.GETPROCESSID ID="Variables.processid" OBJVARNAME="newprocess"/>
		</else>
		</if>
		
		<!-- Um, we really should detect an error condition here! Such as, workflow not found?? -->
		<!-- MHL -->
		
		<!-- Scatter the loaded workflow -->
		<WORKFLOWPROCESS.SCATTER PREFIX="wfp:" NAME="newprocess"/>

		<!-- type can be Any -->
		<WORKFLOWPROCESS.GETTYPES NAME="newprocess" OBJVARNAME="typeobject1"/>
		<TYPELIST.ISALL NAME="typeobject1" VARNAME="typeisall"/>
		<if COND="Variables.typeisall=true">
		<then>
			<setvar NAME="wfp:typestypes" VALUE="_ALL_"/>
		</then>
		</if>	

		<!-- role can be Any -->
		<WORKFLOWPROCESS.GETROLES NAME="newprocess" OBJVARNAME="roleobject1"/>
		<ROLELIST.ISALL NAME="roleobject1" VARNAME="roleisall"/>
		<if COND="Variables.roleisall=true">
		<then>
			<setvar NAME="wfp:rolesroles" VALUE="_ALL_"/>
		</then>
		</if>	

		<!-- site can be Any -->
		<WORKFLOWPROCESS.GETSITES NAME="newprocess" OBJVARNAME="siteobject1"/>
		<SITELIST.ISALL NAME="siteobject1" VARNAME="siteisall"/>
		<if COND="Variables.siteisall=true">
		<then>
			<setvar NAME="wfp:sitessites" VALUE="_ALL_"/>
		</then>
		</if>
		
		<!-- This variable should be used for PRESENTATION and UI FLOW ONLY.  False = we've been
			this way before -->
		<setvar NAME="new" VALUE="false"/>
		
		<!--Not clear that this is used anywhere- jrws-->
		<XLAT.LOOKUP KEY="dvin/UI/Admin/DeleteWfProcessWarning" ENCODE="false" VARNAME="deletemessage"/>
		
		<!-- save data as hidden variables -->
		<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowData">
			<argument NAME="DataAction" VALUE="hiddenvariables"/>
		</callelement>
        <callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowInspect"/>
		<SCRIPT LANGUAGE="JavaScript">

function setAction(F, action)
{
	if (action=='Delete')
	{
		F.pagename.value='OpenMarket/Xcelerate/Admin/WorkflowPost';
		F.action.value='delete';
	}
	F.submit();
}

function setCheck(F, message)
{
	if (confirm(message)) 
	{
		setAction(F, 'Delete');
	}
	else
		return false;
}

		</SCRIPT>

		<if COND="IsVariable.wfp:id=true">
		<then>
			<STRING.ENCODE VARIABLE="wfp:id" VARNAME="wfp:id"/>
			<INPUT TYPE="HIDDEN" NAME="id" VALUE="Variables.wfp:id" REPLACEALL="Variables.wfp:id"/>
		</then>
		</if>
		<ICS.ENCODE BASE="ContentServer" OUTPUT="listprocurl" SESSION="true">
			<ICS.ARGUMENT NAME="pagename" VALUE="OpenMarket/Xcelerate/Admin/WorkflowProcessListFront"/>
		</ICS.ENCODE>
		
		<div class="width-outer-70">
			<A HREF="Variables.listprocurl" REPLACEALL="Variables.listprocurl"><XLAT.STREAM KEY="dvin/UI/Admin/ListallWorkflowProcesses"/></A>
		</div>

	</then> <!-- action = details ends here -->
	<else>     

		<!--****** CONFIRM DELETION OF SOMETHING ******-->
		<!-- Deletion is only appropriate if something has already been saved, so expect the process to be
			in the database.
		-->
			
		<if COND="Variables.action=confirmdelete">
		<then>
			<if COND="Variables.subaction=process">
			<then>
				<!--****** CONFIRM DELETION OF WORKFLOW PROCESS OBJECT ******-->
				<table class="width-outer-70" cellspacing="0" cellpadding="0" border="0">
					<tr><td>
						<span class="title-text"><XLAT.STREAM KEY="dvin/UI/Admin/DeleteWorkflowProcess"/>:</span>&nbsp;<span class="title-value-text"><STRING.STREAM VARIABLE="wfp:description"/></span>
					</td></tr>
					<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/TitleBar"/>
				</table>
				
				<!-- get the process process -->
				<WORKFLOWENGINE.CREATENEWPROCESS OBJVARNAME="newprocess"/>
				<WORKFLOWPROCESS.GATHER PREFIX="wfp:" NAME="newprocess"/>
        		
				<!-- save data as hidden variables -->
				<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowData">
					<argument NAME="DataAction" VALUE="hiddenvariables"/>
				</callelement>
				<div class="width-outer-70">
					<XLAT.LOOKUP KEY="dvin/UI/Admin/DeleteWfProcessWarning" ENCODE="false" VARNAME="deletemessage"/>
					<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
						<argument NAME="msgtext" VALUE="Variables.deletemessage"/>
						<argument NAME="severity" VALUE="warning"/>
					</callelement>							
				</div>

				<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowInspect">
					<argument NAME="inspectlevel" VALUE="short"/>
				</callelement>
			</then>
			</if>
		</then> <!-- action = delete ends here -->
		<else>
			<!--****** UPDATE EXISTING PROCESS or CREATE NEW PROCESS or COPY ******-->
			<div class="width-outer-70">
			<setvar NAME="Copy" VALUE="no"/>
			<if COND="Variables.subaction=copy">
			<then>
				<setvar NAME="Copy" VALUE="yes"/>
			</then>
			</if>
			
			<INPUT TYPE="hidden" NAME="Copy" VALUE="Variables.Copy" REPLACEALL="Variables.Copy"/>

			<WORKFLOWENGINE.CREATENEWPROCESS OBJVARNAME="newprocess"/>

			<!-- If we got here from process edit form, gather that data -->
			<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowData">
				<argument NAME="DataAction" VALUE="datafromprocesspage"/>
			</callelement>

			<WORKFLOWPROCESS.GATHER PREFIX="wfp:" NAME="newprocess"/>

			<!-- If we got here from step edit form, gather that data -->
			<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowData">
				<argument NAME="DataAction" VALUE="datafromsteppage"/>
			</callelement>                                                                            
			
			<!-- The code at this point doesn't do quite what I'd expect.  I would have expected that
				the activity of gathering data from the step page to have performed the necessary
				modifications on the workflow process itself.  Instead, all the code that should have
				been part of the step form post gathering operation is below, keyed off of subaction.
			-->
			</div>
			<!-- subaction= addstep -->
			<if COND="Variables.subaction=addstep">
			<then>
 
				<setvar NAME="errno" VALUE="0"/>

				<WORKFLOWPROCESS.GETSTEPS NAME="newprocess" PREFIX="wfp:"/>
				<WORKFLOWPROCESS.ADDSTEP NAME="newprocess" OBJVARNAME="outputstepobject"/>
				<WORKFLOWSTEP.SETNAME NAME="outputstepobject" VALUE="Variables.stpname"/>  
   			
				<!-- beginstate can be empty. This requires special handling -->
				<removevar NAME="tmp"/>
				<if COND="Variables.beginstate=none">
				<then>
					<setvar NAME="beginstate" VALUE="Variables.empty"/>
				</then>
				</if>
				<WORKFLOWSTEP.SETSTARTSTATE NAME="outputstepobject" VALUE="Variables.beginstate"/>
				
				<!-- endstate can be empty. This requires special handling -->
				<removevar NAME="tmp"/>
				<if COND="Variables.endstate=none">
				<then>
					<setvar NAME="endstate" VALUE="Variables.empty"/>
				</then>
				</if>
				<WORKFLOWSTEP.SETENDSTATE NAME="outputstepobject" VALUE="Variables.endstate"/>
                
				<!-- override -->
				<if COND="Variables.ovrd=true">
				<then>
					<setvar NAME="clearall" VALUE="true"/>
				</then>
				<else>
					<setvar NAME="clearall" VALUE="false"/>
				</else>
				</if>
				<WORKFLOWSTEP.SETOVERRIDEFLAG NAME="outputstepobject" FLAG="Variables.clearall"/>

				<!-- group lock flag -->
				<if COND="Variables.lock=true">
				<then>
					<setvar NAME="lockflag" VALUE="true"/>
				</then>
				<else>
					<setvar NAME="lockflag" VALUE="false"/>
				</else>
				</if>
				<WORKFLOWSTEP.SETGROUPLOCKFLAG NAME="outputstepobject" FLAG="Variables.lockflag"/>

				<!-- step deadlinetype -->
				<WORKFLOWSTEP.SETDEADLINETYPE NAME="outputstepobject" TYPE="Variables.sdeadlinetype"/>

				<!-- Step type -->
				<WORKFLOWSTEP.SETSTEPTYPE NAME="outputstepobject" TYPE="Variables.stptype"/>

				<!-- Authorization Roles -->
				<WORKFLOWSTEP.GETAUTHORIZATIONROLES NAME="outputstepobject" OBJVARNAME="aroles"/>
				<ROLELIST.CLEAR NAME="aroles"/>
				<if COND="IsVariable.acls=true">
				<then>
					<STRINGLIST NAME="newauthrole" STR="Variables.acls" DELIM=";"/>
					<LOOP LIST="newauthrole">
						<ROLELIST.ADD NAME="aroles" ROLE="newauthrole.ITEM"/>
					</LOOP>
				</then>
				<else>
					<ROLELIST.ADD NAME="aroles" ROLE="Variables.null"/>
				</else>
				</if>
				<WORKFLOWSTEP.SETAUTHORIZATIONROLES NAME="outputstepobject" OBJECT="aroles"/>

				<!-- Notify Roles -->
				<WORKFLOWSTEP.GETNOTIFYROLES NAME="outputstepobject" OBJVARNAME="nroles"/>
				<ROLELIST.CLEAR NAME="nroles"/>
				<!-- for empty endstate, no notify roles -->
				<if COND="Variables.endstate!=Variables.empty">
				<then>
					<if COND="Variables.stptype=full">
					<then>
						<STRINGLIST NAME="newnotifyrole" STR="Variables.notifyacls" DELIM=";"/>
						<LOOP LIST="newnotifyrole">
							<ROLELIST.ADD NAME="nroles" ROLE="newnotifyrole.ITEM"/>
						</LOOP>
						<WORKFLOWSTEP.SETNOTIFYROLES NAME="outputstepobject" OBJECT="nroles"/>
						</then>
					</if>

					<if COND="Variables.stptype=ask">
					<then>
						<STRINGLIST NAME="newnotifyrole" STR="Variables.notifyacls" DELIM=";"/>
						<LOOP LIST="newnotifyrole">
							<ROLELIST.ADD NAME="nroles" ROLE="newnotifyrole.ITEM"/>
						</LOOP>
						<WORKFLOWSTEP.SETNOTIFYROLES NAME="outputstepobject" OBJECT="nroles"/>
					</then>
					</if>

					<if COND="Variables.stptype=all">
					<then>
						<STRINGLIST NAME="newnotifyrole" STR="Variables.notifyacls" DELIM=";"/>
						<LOOP LIST="newnotifyrole">
							<ROLELIST.ADD NAME="nroles" ROLE="newnotifyrole.ITEM"/>
						</LOOP>
						<WORKFLOWSTEP.SETNOTIFYROLES NAME="outputstepobject" OBJECT="nroles"/>
					</then>
					</if>
				</then>
				<else>
					<WORKFLOWSTEP.SETNOTIFYROLES NAME="outputstepobject" OBJECT="nroles"/>
				</else>
				</if>			

				<!-- Deadlock Actions -->
				<WORKFLOWSTEP.GETDEADLOCKACTIONS NAME="outputstepobject" OBJVARNAME="dactions"/>
				<WORKFLOWACTIONLIST.CLEARACTIONS NAME="dactions"/>
				<LOOP LIST="newdlkactions">
					<WORKFLOWACTIONLIST.ADDACTION NAME="dactions" VALUE="newdlkactions.ITEM"/>
				</LOOP>
				<WORKFLOWSTEP.SETDEADLOCKACTIONS NAME="outputstepobject" OBJECT="dactions"/>
                
				<!-- Completion Actions -->
				<WORKFLOWSTEP.GETCOMPLETIONACTIONS NAME="outputstepobject" OBJVARNAME="sactions"/>
				<WORKFLOWACTIONLIST.CLEARACTIONS NAME="sactions"/>
				<LOOP LIST="newstpactions">
					<WORKFLOWACTIONLIST.ADDACTION NAME="sactions" VALUE="newstpactions.ITEM"/>
				</LOOP>
				<WORKFLOWSTEP.SETCOMPLETIONACTIONS NAME="outputstepobject" OBJECT="sactions"/>
                
				<!-- Conditions -->
				<WORKFLOWSTEP.GETCONDITIONS NAME="outputstepobject" OBJVARNAME="cactions"/>
				<WORKFLOWACTIONLIST.CLEARACTIONS NAME="cactions"/>
				<LOOP LIST="newconactions">
					<WORKFLOWACTIONLIST.ADDACTION NAME="cactions" VALUE="newconactions.ITEM"/>
				</LOOP>
				<WORKFLOWSTEP.SETCONDITIONS NAME="outputstepobject" OBJECT="cactions"/>
         
				<!-- Go back to the StepDetails page when completed -->
				<setvar NAME="subaction" VALUE="steps"/>
				<WORKFLOWPROCESS.SCATTER PREFIX="wfp:" NAME="newprocess"/>
			</then>
			</if> 

			<!-- subaction= deletestep -->
			<if COND="Variables.subaction=deletestep">
			<then>
				<WORKFLOWPROCESS.DELETESTEP NAME="newprocess" VALUE="Variables.stepid"/>
                    
				<!-- Go back to the StepDetails page when completed -->
				<setvar NAME="subaction" VALUE="steps"/>
				<WORKFLOWPROCESS.SCATTER PREFIX="wfp:" NAME="newprocess"/>
			</then>
			</if> 

			<!-- subaction= editstep -->
			<if COND="Variables.subaction=editstep">
			<then>

				<WORKFLOWPROCESS.GETSTEP NAME="newprocess" OBJVARNAME="outputstepobject" VALUE="Variables.stepid"/>
				<WORKFLOWSTEP.SETNAME NAME="outputstepobject" VALUE="Variables.stpname"/>
				<!-- beginstate can be empty. This requires special handling -->
				<if COND="Variables.beginstate=none">
				<then>
					<setvar NAME="beginstate" VALUE="Variables.empty"/>
				</then>
				</if>
        
				<WORKFLOWSTEP.SETSTARTSTATE NAME="outputstepobject" VALUE="Variables.beginstate"/>
				<!-- endstate can be empty. This requires special handling -->
				<if COND="Variables.endstate=none">
				<then>
					<setvar NAME="endstate" VALUE="Variables.empty"/>
				</then>
				</if>
				<WORKFLOWSTEP.SETENDSTATE NAME="outputstepobject" VALUE="Variables.endstate"/>
            
				<if COND="Variables.ovrd=true">
				<then>
					<setvar NAME="clearall" VALUE="true"/>
				</then>
				<else>
					<setvar NAME="clearall" VALUE="false"/>
				</else>
				</if>
				<WORKFLOWSTEP.SETOVERRIDEFLAG NAME="outputstepobject" FLAG="Variables.clearall"/>

				<if COND="Variables.lock=true">
				<then>
					<setvar NAME="lockflag" VALUE="true"/>
				</then>
				<else>
					<setvar NAME="lockflag" VALUE="false"/>
				</else>
				</if>
				<WORKFLOWSTEP.SETGROUPLOCKFLAG NAME="outputstepobject" FLAG="Variables.lockflag"/>

				<WORKFLOWSTEP.SETSTEPTYPE NAME="outputstepobject" TYPE="Variables.stptype"/>

				<WORKFLOWSTEP.SETDEADLINETYPE NAME="outputstepobject" TYPE="Variables.sdeadlinetype"/>

				<WORKFLOWSTEP.GETAUTHORIZATIONROLES NAME="outputstepobject" OBJVARNAME="aroles"/>
				<ROLELIST.CLEAR NAME="aroles"/>

				<STRINGLIST NAME="newauthrole" STR="Variables.acls" DELIM=";"/>
				<LOOP LIST="newauthrole">
					<ROLELIST.ADD NAME="aroles" ROLE="newauthrole.ITEM"/>
				</LOOP>
				<WORKFLOWSTEP.SETAUTHORIZATIONROLES NAME="outputstepobject" OBJECT="aroles"/>

				<WORKFLOWSTEP.GETNOTIFYROLES NAME="outputstepobject" OBJVARNAME="nroles"/>
				<ROLELIST.CLEAR NAME="nroles"/>
                
				<!-- for empty endstate, no notify roles -->
				<if COND="Variables.endstate!=Variables.empty">
				<then>
					<if COND="Variables.stptype=full">
					<then>
						<STRINGLIST NAME="newnotifyrole" STR="Variables.notifyacls" DELIM=";"/>
						<LOOP LIST="newnotifyrole">
							<ROLELIST.ADD NAME="nroles" ROLE="newnotifyrole.ITEM"/>
						</LOOP>
						<WORKFLOWSTEP.SETNOTIFYROLES NAME="outputstepobject" OBJECT="nroles"/>
					</then>
					</if>
					<if COND="Variables.stptype=ask">
					<then>
						<STRINGLIST NAME="newnotifyrole" STR="Variables.notifyacls" DELIM=";"/>
						<LOOP LIST="newnotifyrole">
							<ROLELIST.ADD NAME="nroles" ROLE="newnotifyrole.ITEM"/>
						</LOOP>
						<WORKFLOWSTEP.SETNOTIFYROLES NAME="outputstepobject" OBJECT="nroles"/>
					</then>
					</if>
					<if COND="Variables.stptype=all">
					<then>
						<STRINGLIST NAME="newnotifyrole" STR="Variables.notifyacls" DELIM=";"/>
						<LOOP LIST="newnotifyrole">
							<ROLELIST.ADD NAME="nroles" ROLE="newnotifyrole.ITEM"/>
						</LOOP>
						<WORKFLOWSTEP.SETNOTIFYROLES NAME="outputstepobject" OBJECT="nroles"/>
					</then>
					</if>
				</then>
				<else>
					<WORKFLOWSTEP.SETNOTIFYROLES NAME="outputstepobject" OBJECT="nroles"/>
				</else>
				</if>

				<WORKFLOWSTEP.GETDEADLOCKACTIONS NAME="outputstepobject" OBJVARNAME="dactions"/>
				<WORKFLOWACTIONLIST.CLEARACTIONS NAME="dactions"/>
				<LOOP LIST="newdlkactions">
					<WORKFLOWACTIONLIST.ADDACTION NAME="dactions" VALUE="newdlkactions.ITEM"/>
				</LOOP>
				<WORKFLOWSTEP.SETDEADLOCKACTIONS NAME="outputstepobject" OBJECT="dactions"/>

				<WORKFLOWSTEP.GETCOMPLETIONACTIONS NAME="outputstepobject" OBJVARNAME="sactions"/>
				<WORKFLOWACTIONLIST.CLEARACTIONS NAME="sactions"/>
				<LOOP LIST="newstpactions">
					<WORKFLOWACTIONLIST.ADDACTION NAME="sactions" VALUE="newstpactions.ITEM"/>
				</LOOP>
				<WORKFLOWSTEP.SETCOMPLETIONACTIONS NAME="outputstepobject" OBJECT="sactions"/>

				<WORKFLOWSTEP.GETCONDITIONS NAME="outputstepobject" OBJVARNAME="cactions"/>
				<WORKFLOWACTIONLIST.CLEARACTIONS NAME="cactions"/>
				<LOOP LIST="newconactions">
					<WORKFLOWACTIONLIST.ADDACTION NAME="cactions" VALUE="newconactions.ITEM"/>
				</LOOP>
				<WORKFLOWSTEP.SETCONDITIONS NAME="outputstepobject" OBJECT="cactions"/>
           
				<!-- Go back to the StepDetails page when completed -->
				<setvar NAME="subaction" VALUE="steps"/>
				<WORKFLOWPROCESS.SCATTER PREFIX="wfp:" NAME="newprocess"/>
			</then>
			</if> 
        
			<!-- subaction= addprivs -->
			<if COND="Variables.subaction=addprivs">
			<then>
				<setvar NAME="functionid" VALUE="Variables.fprole"/>
				<WORKFLOWPROCESS.GATHER PREFIX="wfp:" NAME="newprocess"/>
				<WORKFLOWPROCESS.GETFUNCTIONPRIVS NAME="newprocess" OBJVARNAME="fprivobject"/>
				<stringlist NAME="wfprivrole" STR="Variables.acls" DELIM=";"/>
				<stringlist NAME="wfprivfunction" STR="Variables.functionid" DELIM=";"/>
				<stringlist NAME="wfprivstate" STR="Variables.state" DELIM=";"/>
                                                                   
				<loop LIST="wfprivrole">
					<loop LIST="wfprivfunction">
						<loop LIST="wfprivstate">
							<WORKFLOWPRIVS.CREATE NAME="fprivobject" OBJVARNAME="newpriv"/>
							<WORKFLOWPRIV.SETFUNCTIONID NAME="newpriv" VALUE="wfprivfunction.ITEM"/>
							<WORKFLOWPRIV.SETSTATEID NAME="newpriv" VALUE="wfprivstate.ITEM"/>
							<WORKFLOWPRIV.SETROLE NAME="newpriv" ROLE="wfprivrole.ITEM"/>
					
							<if COND="IsVariable.allowed!=true">
							<then>
								<setvar NAME="allowed" VALUE="false"/>
							</then>
							</if>
							<WORKFLOWPRIV.SETALLOWED NAME="newpriv" ALLOWED="Variables.allowed"/>
							<WORKFLOWPRIVS.ADD NAME="fprivobject" OBJECT="newpriv"/>
						</loop>
					</loop>
				</loop>    
				<setvar NAME="subaction" VALUE="functions"/>
				<WORKFLOWPROCESS.SCATTER PREFIX="wfp:" NAME="newprocess"/>
			</then>
			</if> 
        
			<!-- subaction= deleteprivs -->
			<if COND="Variables.subaction=deleteprivs">
			<then>
				<WORKFLOWPROCESS.GATHER PREFIX="wfp:" NAME="newprocess"/>
				<WORKFLOWPROCESS.GETFUNCTIONPRIVS NAME="newprocess" OBJVARNAME="fprivobject"/>
				<WORKFLOWPRIVS.CREATE NAME="fprivobject" OBJVARNAME="newpriv"/>
				<WORKFLOWPRIV.SETFUNCTIONID NAME="newpriv" VALUE="Variables.fpfunctionid"/>
				<WORKFLOWPRIV.SETSTATEID NAME="newpriv" VALUE="Variables.fpstateid"/>
				<WORKFLOWPRIV.SETROLE NAME="newpriv" ROLE="Variables.fprole"/>
				<WORKFLOWPRIVS.REMOVE NAME="fprivobject" OBJECT="newpriv"/>
            
                   
				<setvar NAME="subaction" VALUE="functions"/>
				<WORKFLOWPROCESS.SCATTER PREFIX="wfp:" NAME="newprocess"/>
			</then>
			</if> 

			<!-- subaction= editprivs: not activated at this time -->
			<if COND="Variables.subaction=editprivs">
			<then>
	
			</then>
			</if> 

			<!-- save data as hidden variables -->
			<!-- return all hidden data back to process page via hidden variables -->
			<INPUT TYPE="hidden" NAME="fpfunctionid" VALUE=""/>
			<INPUT TYPE="hidden" NAME="fpstateid" VALUE=""/>
			<INPUT TYPE="hidden" NAME="fprole" VALUE=""/>
			
			<!-- Set the "new" variable.  This should be used for UI flow effects ONLY -->
			<if COND="Variables.action=new">
			<then>
				<setvar NAME="new" VALUE="true"/>
 
				<!-- I'm afraid this part made no sense to me at all.  We've already gathered form elements
					earlier in this sequence!  I think I'm just going to get rid of this utterly and see what
					happens...
				-->
				<!-- callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowData">
					<argument NAME="DataAction" VALUE="datafromprocesspage"/>
				</callelement -->
			</then>
			<else>
				<setvar NAME="new" VALUE="false"/>
			</else>   
			</if>


			<!-- Create all the pertinent hidden variables for this workflow process -->
			<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowData">
				<argument NAME="DataAction" VALUE="hiddenvariables"/>
			</callelement>               

			<!-- Display the appropriate view based on the requested subaction -->

			<if COND="Variables.subaction=functions">
			<then>
				<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowInspect">
					<argument NAME="inspectlevel" VALUE="short"/>
				</callelement>
        	</then>
			<else>
				<if COND="Variables.subaction=steps">
				<then>
					<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowInspect">
						<argument NAME="inspectlevel" VALUE="short"/>
					</callelement>
				</then>
				<else>
					<if COND="Variables.subaction=graph">
					<then>
						<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowInspect">
							<argument NAME="inspectlevel" VALUE="short"/>
						</callelement>
					</then>
					<else>
						<callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowNew"/>
					</else>
					</if>
				</else>
				</if>
			</else>
			</if>
			<!-- Buttons on process editing page -->
		</else>
		</if>
	</else>
	</if>
 <!--front-->



</HTML>
</FTCS>
