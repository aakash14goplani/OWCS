<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<PROPERTY.GET PARAM="xcelerate.charset" INIFILE="futuretense_xcel.ini" VARNAME="charset"/>
<SETVAR NAME="cs.contenttype" VALUE="text/html; charset=Variables.charset"/>

<!-- OpenMarket/Xcelerate/ControlPanel/LockManager
-
- INPUT
-   AssetType
-   id
-   action = lock | unlock
- 
- OUTPUT
-
-->
<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
    <argument NAME="AssetType" VALUE="Variables.AssetType"/>
</callelement>

<if COND="Variables.trackingenabled=true">
<then>
    <history TABLE="Variables.AssetType" ASSET="Variables.id" LIST="ItsHistory"/>
	<if COND="Variables.action=lock">
    <then>  
        <setvar NAME="lockit" VALUE="false"/>
        <setvar NAME="disable_edit" VALUE="false" />
        
        <if COND="ItsHistory.#numRows!=0">
        <then>
			<if COND="ItsHistory.lockedby=Variables.empty">
            <then>
                <setvar NAME="lockit" VALUE="true"/>
            </then>
            <else>
                <if COND="ItsHistory.lockedby!=SessionVariables.username">
                <then>
                    <!-- locked by other -->
                    <setvar NAME="disable_edit" VALUE="true"/>
                </then>
				</if>
            </else>
            </if>
		</then>
        <else>
            <setvar NAME="lockit" VALUE="true"/>
        </else>
        </if>
        <!-- if we need to lock it, do so -->
        <if COND="Variables.lockit=true">
        <then>
            <ASSET.CHECKOUT OBJECTTYPE="Variables.AssetType" OBJECTID="Variables.id"/>
          
            <if COND="Variables.errno=0">
            <then>
		<USERMANAGER.GETLOGINUSER VARNAME="userID"/>
		<IMPLICITCHECKOUT.LOGIMPLICITCHECKOUT ASSETTYPE="Variables.AssetType"
			ASSETID="Variables.id" USER="Variables.userID"
			FUNCTION="Edit"/>
            </then>
            <else>
                <!-- checkout failed -->
                <setvar NAME="disable_edit" VALUE="true"/>
            </else>
            </if>
        </then>
        </if>
            
        <if COND="Variables.disable_edit=true">
        <then>failed</then>
        <else>succeed</else>
        </if>
    </then>
    <else><!-- unlock -->
        <if COND="ItsHistory.#numRows!=0">
        <then>
            <if COND="ItsHistory.lockedby=SessionVariables.username">
            <then>
                <!-- don't unlock the asset if the asset is explicitly checked out -->
		<IMPLICITCHECKOUT.ISCHECKEDOUT ASSETTYPE="Variables.AssetType"
			ASSETID="Variables.id" VARNAME="checkVar"/>
				<if COND="IsVariable.checkVar=true">
				<then>
					<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Release-Asset"/>
		            <ASSET.UNDOCHECKOUT NAME="Release-Asset"/>
					<!--Remove the entry from the checkout info table-->
					<IMPLICITCHECKOUT.CLEARCHECKOUT ASSETTYPE="Variables.AssetType"
			ASSETID="Variables.id"/>
				</then>
                </if>
            </then>
            </if>
        </then>
        </if>    
    </else>
    </if>
</then>
<else>succeed</else>
</if>
</FTCS> 
