<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<SETVAR NAME="cs.contenttype" VALUE="text/html; charset=UTF-8"/>

<!-- OpenMarket/Gator/UIFramework/LoadQueries
-
- INPUT
-
- OUTPUT
-
-->

<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/BasicEnvironment"/>

<IF COND="Variables.command=GetTypes">
<THEN>
	<SETVAR NAME="Variables.varname" VALUE="Query"/>
</THEN>
<ELSE>
	<IF COND="Variables.op=init">
	<THEN>
		<!-- get list of asset types for all queries for this site -->
      <SETVAR NAME="AssetType" VALUE="Query"/>
		<SETVAR NAME="tablename" VALUE="Query"/>
		<SETVAR NAME="errno" VALUE="0"/>
		<EXECSQL SQL="SELECT DISTINCT Query.subtype AS assettype FROM Query,AssetPublication WHERE Query.id = AssetPublication.assetid AND (AssetPublication.pubid = SessionVariables.pubid OR AssetPublication.pubid=0) AND Query.status!='VO'" LIST="allQueryTypes" TABLE="Query,AssetPublication"/>
		<IF COND="IsList.allQueryTypes=true">
		<THEN>
			<IF COND="allQueryTypes.#numRows!=0">
			<THEN>
				<ASSETTYPE.LISTALL TYPELIST="allQueryTypes" LIST="allTypes" ORDER="description"/>
				<LOOP LIST="allTypes">
					<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID" SCOPED="STACKED">
						<argument NAME="AdHoc" VALUE="allTypes.assettype"/>
						<argument NAME="TreeNodeID" VALUE="Variables.empty"/>
					</callelement>
					
               				<REMOVEVAR NAME="Description"/>
					<REMOVEVAR NAME="ExecuteURL"/>
					<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
						<satellite.argument name="populate" value="OpenMarket/Gator/UIFramework/LoadQueries"/>
						<satellite.argument name="op" value="load"/>
						<satellite.argument name="Depth" value="2"/>
						<satellite.argument name="subtype" value="allTypes.assettype"/>
					</SATELLITE.LINK>
					<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
						<satellite.argument name="AssetType" value="Query"/>
					</SATELLITE.LINK>
					<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
						<ARGUMENT NAME="Label" VALUE="allTypes.description"/>
						<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
						<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
						<ARGUMENT NAME="LoadURL" VALUE="Variables.LoadURL"/>
						<ARGUMENT NAME="OKActions" VALUE="refresh"/>
						<ARGUMENT NAME="Image" VALUE="Variables.cs_imagedir/OMTree/TreeImages/AssetTypes/allTypes.assettype.png"/>
						<ARGUMENT NAME="RefreshKeys" VALUE="Dummy__allTypes.assettype"/>
					</CALLELEMENT>
				</LOOP>
			</THEN>
			</IF>
		</THEN>
		</IF>
	</THEN>
	<ELSE>
		<IF COND="Variables.Depth=2">
		<THEN>
         <SETVAR NAME="errno" VALUE="0"/>
			<SETVAR NAME="AssetType" VALUE="Query"/>
			<ASSET.LIST TYPE="Query" FIELD1="subtype" VALUE1="Variables.subtype" LIST="QueryList" PUBID="SessionVariables.pubid" EXCLUDEVOIDED="true"/>
			<IF COND="IsList.QueryList=true">
			<THEN>
				<IF COND="QueryList.#numRows!=0">
				<THEN>
					<LOOP LIST="QueryList">
						<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID" SCOPED="STACKED">
							<argument NAME="ID" VALUE="QueryList.id"/>
							<argument NAME="AssetType" VALUE="Variables.AssetType"/>
							<argument NAME="TreeNodeID" VALUE="Variables.empty"/>
						</callelement>
						<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="ExecuteURL">
							<satellite.argument name="AssetType" value="Variables.AssetType"/>
							<satellite.argument name="n0_" value="Variables.TreeNodeID"/>
							<satellite.argument name="op" value="displayNode"/>
						</SATELLITE.LINK>
						<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
							<satellite.argument name="AssetType" value="Variables.AssetType"/>
							<satellite.argument name="populate" value="OpenMarket/Gator/UIFramework/LoadQueries"/>
							<satellite.argument name="op" value="load"/>
							<satellite.argument name="Depth" value="3"/>
							<satellite.argument name="subtype" value="allTypes.assettype"/>
							<satellite.argument name="QueryID" value="QueryList.id"/>
						</SATELLITE.LINK>
						<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
							<satellite.argument name="AssetType" value="Variables.AssetType"/>
						</SATELLITE.LINK>

						<ASSET.GETSUBTYPE TYPE="Variables.AssetType" OBJECTID="QueryList.id" OUTPUT="stype" />
						<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
							<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
							<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
						</CALLELEMENT>
						
						<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
							<ARGUMENT NAME="Label" VALUE="QueryList.name"/>
							<ARGUMENT NAME="Description" VALUE="QueryList.description"/>
							<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
							<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
							<ARGUMENT NAME="ExecuteURL" VALUE="Variables.ExecuteURL"/>
							<ARGUMENT NAME="LoadURL" VALUE="Variables.LoadURL"/>
							<ARGUMENT NAME="OKActions" VALUE="Status;Inspect;Edit;Delete;refresh"/>
							<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
							<ARGUMENT NAME="RefreshKeys" VALUE="QueryList.id"/>
						</CALLELEMENT>
					</LOOP>
				</THEN>
				</IF>
			</THEN>
			</IF>
		</THEN>
		<ELSE>
			<IF COND="Variables.Depth=3">
			<THEN>
				<!-- run the query -->
				<SETVAR NAME="errno" VALUE="0"/>
				<ASSET.LIST TYPE="Query" FIELD1="id" VALUE1="Variables.QueryID" LIST="theQuery"/>
				<IF COND="IsList.theQuery=true">
				<THEN>
					<IF COND="theQuery.#numRows!=0">
					<THEN>
						<CALLELEMENT NAME="OpenMarket/Xcelerate/AssetType/Query/ExecuteQuery">
							<ARGUMENT NAME="list" VALUE="Content"/>
							<ARGUMENT NAME="inputlist" VALUE="theQuery"/>
							<ARGUMENT NAME="ResultLimit" VALUE="-1"/>
						</CALLELEMENT>
						
						<IF COND="IsList.Content=true">
						<THEN>
							<IF COND="Content.#numRows!=0">
							<THEN>
							
								<!-- try to figure out column names...look for assetid,id,name,value,description -->
								<MISC.GETLISTCOLUMNNAMES LIST="Content" LISTVARNAME="columnList"/>
								<HASH.CREATE NAME="hColumns" LIST="columnList" COLUMN="name"/>
								
								<SETVAR NAME="Executable" VALUE="false"/>
								<REMOVEVAR NAME="ExecuteURL"/>
								
								<SETVAR NAME="idColumn" VALUE="id"/>
								<HASH.CONTAINS NAME="hColumns" VALUE="id" VARNAME="hasit"/>
								<IF COND="Variables.hasit=true">
								<THEN>
									<SETVAR NAME="Executable" VALUE="true"/>
								</THEN>
								<ELSE>
									<HASH.CONTAINS NAME="hColumns" VALUE="assetid" VARNAME="hasit"/>
									<IF COND="Variables.hasit=true">
									<THEN>
										<SETVAR NAME="Executable" VALUE="true"/>
										<SETVAR NAME="idColumn" VALUE="assetid"/>
									</THEN>
									</IF>
								</ELSE>
								</IF>
								
								<SETVAR NAME="Displayable" VALUE="false"/>
								<SETVAR NAME="nameColumn" VALUE="name"/>
								<HASH.CONTAINS NAME="hColumns" VALUE="name" VARNAME="hasit"/>
								<IF COND="Variables.hasit=true">
								<THEN>
									<SETVAR NAME="Displayable" VALUE="true"/>
								</THEN>
								<ELSE>
									<HASH.CONTAINS NAME="hColumns" VALUE="value" VARNAME="hasit"/>
									<IF COND="Variables.hasit=true">
									<THEN>
										<SETVAR NAME="Displayable" VALUE="true"/>
										<SETVAR NAME="nameColumn" VALUE="value"/>
									</THEN>
									</IF>
								</ELSE>
								</IF>
								
								<SETVAR NAME="showDescription" VALUE="false"/>
								<HASH.CONTAINS NAME="hColumns" VALUE="description" VARNAME="hasit"/>
								<IF COND="Variables.hasit=true">
								<THEN>
									<SETVAR NAME="showDescription" VALUE="true"/>
								</THEN>
								<ELSE>
									<REMOVEVAR NAME="Description"/>
								</ELSE>
								</IF>
							
								<SETVAR NAME="AssetType" VALUE="theQuery.subtype"/>
								
								<IF COND="Variables.AssetType=Collection">
								<THEN>
									<SETVAR NAME="OKActions" VALUE="Build;Status;Inspect;Edit;Delete;refresh"/>
								</THEN>
								<ELSE>
									<SETVAR NAME="OKActions" VALUE="Status;Inspect;Edit;Delete;refresh"/>
								</ELSE>
								</IF>
								
								<IF COND="Variables.Displayable=true">
								<THEN>
                           <LOOP LIST="Content">
										<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID" SCOPED="STACKED">
											<argument NAME="ID" VALUE="Content.Variables.idColumn"/>
											<argument NAME="AssetType" VALUE="Variables.AssetType"/>
											<argument NAME="TreeNodeID" VALUE="Variables.empty"/>
										</callelement>
										
										<IF COND="Variables.showDescription=true">
										<THEN>
											<SETVAR NAME="Description" VALUE="Content.description"/>
										</THEN>
										</IF>
										
										<IF COND="Variables.Executable=true">
										<THEN>
											<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="ExecuteURL">
												<satellite.argument name="AssetType" value="Variables.AssetType"/>
												<satellite.argument name="n0_" value="Variables.TreeNodeID"/>
												<satellite.argument name="op" value="displayNode"/>
											</SATELLITE.LINK>
										</THEN>
										</IF>

										<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
											<satellite.argument name="AssetType" value="Variables.AssetType"/>
										</SATELLITE.LINK>

										<REMOVEVAR NAME="LoadURL"/>
										
										<ASSET.GETSUBTYPE TYPE="Variables.AssetType" OBJECTID="Content.Variables.idColumn" OUTPUT="stype" />
										<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
											<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
											<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
										</CALLELEMENT>
										
										<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
											<ARGUMENT NAME="Label" VALUE="Content.Variables.nameColumn"/>
                                 			<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
											<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
                                 			<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
											<ARGUMENT NAME="RefreshKeys" VALUE="Content.Variables.idColumn"/>
										</CALLELEMENT>
									</LOOP>
								</THEN>
								<ELSE>
									<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID" SCOPED="STACKED">
										<argument NAME="AdHoc" VALUE="Unknown"/>
										<argument NAME="TreeNodeID" VALUE="Variables.empty"/>
									</callelement>
									
									<REMOVEVAR NAME="LoadURL"/>
									<REMOVEVAR NAME="Image"/>
									<REMOVEVAR NAME="RefreshKeys"/>

									<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
										<satellite.argument name="AssetType" value="Variables.AssetType"/>
									</SATELLITE.LINK>

									<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
										<ARGUMENT NAME="Label" VALUE="[Unknown query columns]"/>
										<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
										<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
										<ARGUMENT NAME="OKActions" VALUE="refresh"/>
									</CALLELEMENT>
								</ELSE>
								</IF>
							</THEN>
							</IF>
						</THEN>
						</IF>
					</THEN>
					</IF>
				</THEN>
				</IF>
			</THEN>
			</IF>
		</ELSE>
		</IF>
	</ELSE>
	</IF>
</ELSE>
</IF>

</FTCS> 
