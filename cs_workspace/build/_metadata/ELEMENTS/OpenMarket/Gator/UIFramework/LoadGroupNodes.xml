<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<SETVAR NAME="cs.contenttype" VALUE="text/html; charset=UTF-8"/>

<!-- OpenMarket/Gator/UIFramework/LoadGroupNodes
-
- This element creates flex parent nodes and potentially their child flex assets.
- Orphan children are handled through the LoadOrphanNodes element.
-
- INPUT
-
- OUTPUT
-
-->

<IF cond="Variables.cs_environment=ucform">
<THEN>

	<IF cond="Variables.showParents=true">
    <THEN>				
	   <CALLELEMENT NAME="OpenMarket/Gator/UIFramework/LoadParentNodes"/>		 
	 </THEN>
	 <ELSE>
	   <CALLELEMENT NAME="OpenMarket/Gator/UIFramework/LoadChildrenNodes"/>		
	 </ELSE>
	 </IF>
</THEN>
<ELSE>
 <CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/BasicEnvironment"/>
 <!-- The _enableForms property enables/disables following assettypes from the advanced ui.
		�	All Flex assets and their parent assets
		�	All basic assets
		�	Engage assets like Recommendation, Segment and Promotion
		�	Special assets like Query and Collection
-->
<PROPERTY.GET PARAM="advancedUI.enableAssetForms" INIFILE="futuretense_xcel.ini" VARNAME="_enableForms"/>
 <if cond="Variables._enableForms!=true">
<then>
	<callelement NAME="OpenMarket/Xcelerate/Util/CheckTypeForGenerateLink">
		<argument NAME="assettype" VALUE="Variables.AssetType"/>
	</callelement>
</then>
</if>
<if cond="Variables.navigateLink=true">
<then>
	<if cond="Variables.cs_environment=ucform">
	<then>
		<setvar name="IsAuthorized" value="true"/>
	</then>
	<else>
		<setvar name="IsAuthorized" value="false"/>
	</else>
	</if>
</then>
<else>
	<setvar name="IsAuthorized" value="true"/>
</else>
</if>
<IF COND="Variables.IsAuthorized=true">
<THEN>
<IF COND="Variables.command=GetTypes">
<THEN>
	<SETVAR NAME="Variables.varname" VALUE="Variables.AssetType"/>
</THEN>
<ELSE>
	<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/GetDefaultNodeBehavior" />
	<SETVAR NAME="GroupName" VALUE="Variables.AssetType"/>
	
	<!-- get all the child types of this group type -->
	<ics.literal table="FlexAssetTypes" column="assettype" string="Variables.AssetType" output="literal"/>

 	<SETVAR NAME="errno" VALUE="0"/>
	<SETVAR NAME="tablename" VALUE="FlexAssetTypes"/>
	<EXECSQL SQL="SELECT assettype FROM Variables.tablename WHERE assetgroup=Variables.literal" LIST="ChildTypes"/>
	
	<!-- set variables and atm.locate -->
	<atm.locate TYPE="Variables.AssetType" VARNAME="GroupManager"/>
	
	<!-- op=init: this is the initial tab load -->
	<if COND="Variables.op=init">
	<then>
		<!-- get count of all root flex parents -->
		<flexgroups.countroots SITE="SessionVariables.pubid" NAME="GroupManager" VARNAME="rootCount"/>
		
		<!-- get the xcelerate.treeMaxNodes property -->
		<callelement NAME="OpenMarket/Xcelerate/Util/LoadProperty">
			<argument NAME="property" VALUE="xcelerate.treeMaxNodes"/>
			<argument NAME="ini" VALUE="futuretense_xcel.ini"/>
			<argument NAME="varname" VALUE="TOOMANY"/>
		</callelement>
		
		<!-- compare rootCount and TooMany, return dummy node if count is larger -->
		<CALCULATOR.GO VALUE="Variables.rootCount Variables.TOOMANY GT" VARNAME="ANS"/>
		<if COND="Variables.ANS=1">
		<then>
			<REMOVEVAR NAME="Image"/>
			<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
				<satellite.argument name="AssetType" value="Variables.AssetType"/>
				<satellite.argument name="populate" value="OpenMarket/Xcelerate/AssetType/Variables.AssetType/LoadTree"/>
				<satellite.argument name="id" value="toomanycatalog"/>
				<satellite.argument name="op" value="load"/>
			</SATELLITE.LINK>
			
			<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
				<satellite.argument name="AssetType" value="Variables.AssetType"/>
			</SATELLITE.LINK>
			
			<SETVAR NAME="SelCatForNode" VALUE=""/>
			<XLAT.LOOKUP KEY="dvin/UI/SelCatalog" ENCODE="false" VARNAME="SelCatForNode"/>
			<XLAT.LOOKUP KEY="dvin/UI/RootCountCatalog" ENCODE="false" VARNAME="RootCountCatalog"/>
			
			<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
				<ARGUMENT NAME="Label" VALUE="Variables.SelCatForNode"/>
				<ARGUMENT NAME="Description" VALUE="Variables.RootCountCatalog"/>
				<ARGUMENT NAME="ID" VALUE="toomanycatalog"/>
				<ARGUMENT NAME="LoadURL" VALUE="Variables.LoadURL"/>
				<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
				<ARGUMENT NAME="ExecuteURL" VALUE="Variables.empty"/>
				<ARGUMENT NAME="OKActions" VALUE="refresh"/>
			</CALLELEMENT>
		</then>
		<else>
			<!-- get root flex parents -->
			<flexgroups.getroots SITE="SessionVariables.pubid" NAME="GroupManager" LISTVARNAME="PGList"/>
			<COMPLEXASSETS.GETSORTEDLIST NAME="GroupManager" LISTVARNAME="PGList" LIST="PGList"/>
			
			<if COND="Variables.errno=0">
			<then>
				<if COND="IsList.PGList=true">
				<then>
					<if COND="PGList.#numRows!=0">
					<then>
						<!-- try to find at least 1 start menu item allowing to create instance of the flex asset tyoe -->
						<STARTMENU.GETMATCHINGSTARTITEMS ITEMTYPE="ContentForm" PUBID="SessionVariables.pubid" ASSETTYPE="Variables.AssetType" INPUTARGUMENTS="subtype" LISTVARNAME="startitems"/>
						<IF COND="IsList.startitems=true">
						<THEN>
							<IF COND="startitems.#numRows!=0">
							<THEN>
								<!--  we found at least one, display the 'new (like me)' menu option -->
								<SETVAR NAME="OKActions" VALUE="__LIKEMESTARTMENU__;__CHILDSTARTMENU__;Status;Inspect;Edit;Preview;Delete;refresh"/>
								<SETVAR NAME="okFunctions" VALUE="viewstatus;inspect;edit;preview;delete;treerefresh" />
							</THEN>
							<ELSE>
								<!-- otherwise, don't - just show the 'new child' menu option -->
								<SETVAR NAME="OKActions" VALUE="__CHILDSTARTMENU__;Status;Inspect;Edit;Preview;Delete;refresh"/>
								<SETVAR NAME="okFunctions" VALUE="viewstatus;inspect;edit;preview;delete;treerefresh" />
							</ELSE>
							</IF>
						</THEN>
						</IF>
						<!-- render each root flex parent asset -->
						<loop LIST="PGList">
							<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID">
								<argument NAME="ID" VALUE="PGList.assetid"/>
							</callelement>
							
							<!--check to see if the current flex parent has children-->
							<flexgroups.countimmediatechildren 
								SITE="SessionVariables.pubid"
								NAME="GroupManager" 
								ID="PGList.assetid" 
								VARNAME="PGChildrenCount"/>
							<!--  the current flex parent has at least one child, so set LoadURL accordingly.
								  The tree uses the presence of LoadURL to determine whether a tree node should be rendered
								  as expandable or not (usually represented by a "+" icon before the node label)
							-->
							<if COND="Variables.PGChildrenCount!=0">
							<then>
								<!--  build its LoadURL -->
								<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
									<satellite.argument name="AssetType" value="Variables.AssetType"/>
									<satellite.argument name="populate" value="OpenMarket/Xcelerate/AssetType/Variables.AssetType/LoadTree"/>
									<satellite.argument name="id" value="PGList.assetid"/>
									<satellite.argument name="op" value="load"/>
								</SATELLITE.LINK>
							</then>
							<else>
								<!--  no child: remove LoadURL from the ics scope so it won't get passed to BuildTreeNode-->
								<REMOVEVAR NAME="LoadURL"/>
							</else>
							</if>
							
							<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="ExecuteURL">
								<satellite.argument name="AssetType" value="Variables.AssetType"/>
								<satellite.argument name="n0_" value="Variables.TreeNodeID"/>
								<satellite.argument name="op" value="displayNode"/>
							</SATELLITE.LINK>
							
							<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
								<satellite.argument name="AssetType" value="Variables.AssetType"/>
							</SATELLITE.LINK>
							
							<REMOVEVAR NAME="PreviewURL"/>
							<PREVIEWURL.MAKEURL VARNAME="PreviewURL" ASSETTYPE="Variables.AssetType" ASSETID="PGList.assetid" PUBID="SessionVariables.pubid"/>
							
							<ASSET.GETSUBTYPE TYPE="Variables.AssetType" OBJECTID="PGList.assetid" OUTPUT="stype" />
							<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
								<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
								<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
							</CALLELEMENT>
							
							<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
								<ARGUMENT NAME="Label" VALUE="PGList.name"/>
								<ARGUMENT NAME="Description" VALUE="PGList.description"/>
								<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
								<!-- LoadURL implicitly passed in -->
								<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
								<ARGUMENT NAME="ExecuteURL" VALUE="Variables.ExecuteURL"/>
								<!-- OKActions implicitly passed in -->
								<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
								<ARGUMENT NAME="RefreshKeys" VALUE="PGList.assetid"/>
								<ARGUMENT NAME="okFunctions" VALUE="Variables.okFunctions" />
								<ARGUMENT NAME="executeFunction" VALUE="Variables.cs_defaultFunctionParent" />
							</CALLELEMENT>
						</loop>
					</then>
					</if>
				</then>
				</if>
			</then>
			</if>
		</else> <!--	end of load all roots -->
		</if>
	</then>
	<!-- else (here op=load), load all non-roots OR load roots if DUMMY root node is previously loaded -->
	<else>
		<!-- check if DUMMY root node is previously loaded (i.e. we tried to render the root flex parents
		     and determined that their number was greater than the allowed max tree nodes  -->
		<if COND="Variables.id=toomanycatalog">
		<then>
			<!-- Note: this section of the code is only relevant for the tree applet -->
			<!-- the 'mode' parameter is set by the applet when the search criteria window
				 has been presented to the user and a search criteria has been provided
			 -->
			<if COND="IsVariable.mode!=true">
			<then>
				<!-- load countroot again, return message, and ask for criteria -->
				<flexgroups.countroots SITE="SessionVariables.pubid" NAME="GroupManager" VARNAME="rootCount"/>
				<STRING.LENGTH VALUE="Variables.rootCount" VARNAME="length"/>
				Status:12:tooManyItems:Count:<STRING.STREAM VALUE="Variables.length:Variables.rootCount:"/>END:3:END:
				<throwexception/>
			</then>
			</if>
			<!-- else modify criteria and load selected roots -->
			<setvar NAME="input" VALUE="%Variables.criteria%"/> 
			<BEGINS STR="Variables.criteria" WHAT="%"/>
			<if COND="Variables.errno=1">
			<then>
				<setvar NAME="input" VALUE="Variables.criteria"/>
			</then>
			</if>
			<ENDS STR="Variables.criteria" WHAT="%"/>
			<if COND="Variables.errno=1">
			<then>
				<setvar NAME="input" VALUE="Variables.criteria"/>
			</then>
			</if>
			<if COND="Variables.criteria=%">
			<then>
				<setvar NAME="input" VALUE="%"/>
			</then>
			</if>
			
			<!-- load selected flex parents (search is on the 'name' field) -->
			<flexgroups.getroots SITE="SessionVariables.pubid" NAME="GroupManager" LISTVARNAME="PGList" FIELD="name" VALUE="Variables.input"/>
			<COMPLEXASSETS.GETSORTEDLIST NAME="GroupManager" LISTVARNAME="PGList" LIST="PGList"/>
			<if COND="Variables.errno=0">
			<then>
				<if COND="IsList.PGList=true">
				<then>
					<if COND="PGList.#numRows!=0">
					<then>
						<STARTMENU.GETMATCHINGSTARTITEMS ITEMTYPE="ContentForm" PUBID="SessionVariables.pubid" ASSETTYPE="Variables.AssetType" INPUTARGUMENTS="subtype" LISTVARNAME="startitems"/>
						<IF COND="IsList.startitems=true">
						<THEN>
							<IF COND="startitems.#numRows!=0">
							<THEN>
								<SETVAR NAME="OKActions" VALUE="__LIKEMESTARTMENU__;__CHILDSTARTMENU__;Status;Inspect;Edit;Preview;Delete;refresh"/>
							</THEN>
							<ELSE>
								<SETVAR NAME="OKActions" VALUE="__CHILDSTARTMENU__;Status;Inspect;Edit;Preview;Delete;refresh"/>
							</ELSE>
							</IF>
						</THEN>
						</IF>
						<loop LIST="PGList">
							<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID">
								<argument NAME="ID" VALUE="PGList.assetid"/>
							</callelement>
							
							<!--Now check to see if we have children-->
							<flexgroups.countimmediatechildren 
								SITE="SessionVariables.pubid"
								NAME="GroupManager" 
								ID="PGList.assetid" 
								VARNAME="PGChildrenCount"/> 
							<if COND="Variables.PGChildrenCount!=0">
							<then>
								<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
									<satellite.argument name="AssetType" value="Variables.AssetType"/>
									<satellite.argument name="populate" value="OpenMarket/Xcelerate/AssetType/Variables.AssetType/LoadTree"/>
									<satellite.argument name="id" value="PGList.assetid"/>
									<satellite.argument name="op" value="load"/>
								</SATELLITE.LINK>								
							</then>
							<else>
								<REMOVEVAR NAME="LoadURL"/>
							</else>
							</if>
							<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="ExecuteURL">
								<satellite.argument name="AssetType" value="Variables.AssetType"/>
								<satellite.argument name="n0_" value="Variables.TreeNodeID"/>
								<satellite.argument name="op" value="displayNode"/>
							</SATELLITE.LINK>

							<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
								<satellite.argument name="AssetType" value="Variables.AssetType"/>
							</SATELLITE.LINK>

							<REMOVEVAR NAME="PreviewURL"/>
							<PREVIEWURL.MAKEURL VARNAME="PreviewURL" ASSETTYPE="Variables.AssetType" ASSETID="PGList.assetid" PUBID="SessionVariables.pubid"/>

							<ASSET.GETSUBTYPE TYPE="Variables.AssetType" OBJECTID="PGList.assetid" OUTPUT="stype" />
							<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
								<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
								<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
							</CALLELEMENT>
							
							<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
								<ARGUMENT NAME="Label" VALUE="PGList.name"/>
								<ARGUMENT NAME="Description" VALUE="PGList.description"/>
								<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
								<!-- LoadURL implicitly passed in -->
								<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
								<ARGUMENT NAME="ExecuteURL" VALUE="Variables.ExecuteURL"/>
								<!-- OKActions implicitly passed in -->
								<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
								<ARGUMENT NAME="RefreshKeys" VALUE="PGList.assetid"/>
							</CALLELEMENT>
						</loop>
					</then>
					</if>
				</then>
				</if>
			</then>
			</if>
		<!-- end of load selected roots -->
		</then>
		<else>
			<!-- we're in the generic case, i.e. rendering the immediate descendants of a given flex parent -->
			<!-- mode is set if the applet wants us to load descendants given a search criteria (i.e. when treeMaxNodes is exceeded -->
			<if COND="IsVariable.mode!=true">
			<then>
				<!-- if mode is not set by the applet, we're in the generic case: just load all descendants (no search criteria) -->
				<!-- get the count of immediate children  -->
				<flexgroups.countimmediatechildren NAME="GroupManager" ID="Variables.id" VARNAME="COUNT" SITE="SessionVariables.pubid"/>
				<callelement NAME="OpenMarket/Xcelerate/Util/LoadProperty">
					<argument NAME="property" VALUE="xcelerate.treeMaxNodes"/>
					<argument NAME="ini" VALUE="futuretense_xcel.ini"/>
					<argument NAME="varname" VALUE="TOOMANY"/>
				</callelement>
				
				<!-- compare COUNT and TooMany, return tooManyItem if COUNT is larger-->
				<CALCULATOR.GO VALUE="Variables.COUNT Variables.TOOMANY GT" VARNAME="ANS"/>
				
				<if COND="Variables.ANS=1">
				<then>
					<STRING.LENGTH VALUE="Variables.COUNT" VARNAME="length"/>
					<!--  Add the MAX COUNT into the Exception  -->
					<STRING.LENGTH VALUE="Variables.TOOMANY" VARNAME="mlength"/>
					Status:12:tooManyItems:Count:<STRING.STREAM VALUE="Variables.length:Variables.COUNT:"/>TOOMANY:<STRING.STREAM VALUE="Variables.mlength:Variables.TOOMANY:"/>END:3:END:
					<throwexception/>
				</then>
				<else>
					<!--  now list all immediate children (note that we're still rendering flex parents only) -->
					<flexgroups.getimmediatechildren SITE="SessionVariables.pubid" NAME="GroupManager" ID="Variables.id" LISTVARNAME="PGList0"/>
					<COMPLEXASSETS.GETSORTEDLIST NAME="GroupManager" LISTVARNAME="PGList" LIST="PGList0"/>
					<if COND="IsList.PGList=true">
					<then>
						<STARTMENU.GETMATCHINGSTARTITEMS ITEMTYPE="ContentForm" PUBID="SessionVariables.pubid" ASSETTYPE="Variables.AssetType" INPUTARGUMENTS="subtype" LISTVARNAME="startitems"/>
						<IF COND="IsList.startitems=true">
						<THEN>
							<IF COND="startitems.#numRows!=0">
							<THEN>
								<SETVAR NAME="OKActions" VALUE="__LIKEMESTARTMENU__;__CHILDSTARTMENU__;Status;Inspect;Edit;Preview;Delete;refresh"/>
							</THEN>
							<ELSE>
								<SETVAR NAME="OKActions" VALUE="Status;__CHILDSTARTMENU__;Inspect;Edit;Preview;Delete;refresh"/>
							</ELSE>
							</IF>
						</THEN>
						</IF>
						<loop LIST="PGList">
							<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID">
								<argument NAME="ID" VALUE="PGList.assetid"/>
							</callelement>
							
							<!--Now check to see if we have children-->
							<flexgroups.countimmediatechildren 
								SITE="SessionVariables.pubid"
								NAME="GroupManager" 
								ID="PGList.assetid" 
								VARNAME="PGChildrenCount"/> 
							<if COND="Variables.PGChildrenCount!=0">
							<then>
								<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
									<satellite.argument name="AssetType" value="Variables.AssetType"/>
									<satellite.argument name="populate" value="OpenMarket/Xcelerate/AssetType/Variables.AssetType/LoadTree"/>
									<satellite.argument name="id" value="PGList.assetid"/>
									<satellite.argument name="op" value="load"/>
								</SATELLITE.LINK>
							</then>
							<else>
								<REMOVEVAR NAME="LoadURL"/>
							</else>
							</if>
							<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="ExecuteURL">
								<satellite.argument name="AssetType" value="Variables.AssetType"/>
								<satellite.argument name="n0_" value="Variables.TreeNodeID"/>
								<satellite.argument name="op" value="displayNode"/>
							</SATELLITE.LINK>
							
							<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
								<satellite.argument name="AssetType" value="Variables.AssetType"/>
							</SATELLITE.LINK>
							
							<REMOVEVAR NAME="PreviewURL"/>
							<PREVIEWURL.MAKEURL VARNAME="PreviewURL" ASSETTYPE="Variables.AssetType" ASSETID="PGList.assetid" PUBID="SessionVariables.pubid"/>
							
							<ASSET.GETSUBTYPE TYPE="Variables.AssetType" OBJECTID="PGList.assetid" OUTPUT="stype" />
							<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
								<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
								<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
							</CALLELEMENT>
							<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
								<ARGUMENT NAME="Label" VALUE="PGList.name"/>
								<ARGUMENT NAME="Description" VALUE="PGList.description"/>
								<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
								<!-- LoadURL implicitly passed in -->
								<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
								<ARGUMENT NAME="ExecuteURL" VALUE="Variables.ExecuteURL"/>
								<!-- LoadURL implicitly passed in -->
								<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
								<ARGUMENT NAME="RefreshKeys" VALUE="PGList.assetid"/>
								<ARGUMENT NAME="executeFunction" VALUE="Variables.cs_defaultFunctionParent" />
								<ARGUMENT NAME="okFunctions" VALUE="Variables.okFunctions" />
							</CALLELEMENT>
						</loop>
					</then>
					</if>
					<!--  we've just displayed the child flex parents - now check for immediate children from legal child flex asset types -->
					<LOOP LIST="ChildTypes">
						<ATM.LOCATE VARNAME="ChildAtm" TYPE="ChildTypes.assettype"/>
						<COMPLEXASSETS.GETSORTEDLIST NAME="ChildAtm" LISTVARNAME="PGList" LIST="PGList0"/>
						<setvar NAME="AssetType" VALUE="ChildTypes.assettype"/>
						<if COND="IsList.PGList=true">
						<then>
							<STARTMENU.GETMATCHINGSTARTITEMS ITEMTYPE="ContentForm" PUBID="SessionVariables.pubid" ASSETTYPE="Variables.AssetType" INPUTARGUMENTS="subtype" LISTVARNAME="startitems"/>
							<IF COND="IsList.startitems=true">
							<THEN>
								<IF COND="startitems.#numRows!=0">
								<THEN>
									<SETVAR NAME="OKActions" VALUE="__LIKEMESTARTMENU__;Status;Inspect;Edit;Preview;Delete;refresh"/>
									<SETVAR NAME="okFunctions" VALUE="viewstatus;inspect;edit;preview;delete;treerefresh" />
								</THEN>
								<ELSE>
									<SETVAR NAME="OKActions" VALUE="Status;Inspect;Edit;Preview;Delete;refresh"/>
									<SETVAR NAME="okFunctions" VALUE="viewstatus;inspect;edit;preview;delete;treerefresh" />
								</ELSE>
								</IF>
							</THEN>
							</IF>
							<loop LIST="PGList">
								<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID">
									<argument NAME="ID" VALUE="PGList.assetid"/>
								</callelement>
								
								<!--Now check to see if we have children-->
								<flexgroups.countimmediatechildren 
									SITE="SessionVariables.pubid"
									NAME="GroupManager" 
									ID="PGList.assetid" 
									VARNAME="PGChildrenCount"/> 
								<if COND="Variables.PGChildrenCount!=0">
								<then>
									<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
										<satellite.argument name="AssetType" value="Variables.AssetType"/>
										<satellite.argument name="populate" value="OpenMarket/Xcelerate/AssetType/Variables.AssetType/LoadTree"/>
										<satellite.argument name="id" value="PGList.assetid"/>
										<satellite.argument name="op" value="load"/>
									</SATELLITE.LINK>
								</then>
								<else>
									<REMOVEVAR NAME="LoadURL"/>
								</else>
								</if>
								<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="ExecuteURL">
									<satellite.argument name="AssetType" value="Variables.AssetType"/>
									<satellite.argument name="n0_" value="Variables.TreeNodeID"/>
									<satellite.argument name="op" value="displayNode"/>
								</SATELLITE.LINK>
								
								<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
									<satellite.argument name="AssetType" value="Variables.AssetType"/>
								</SATELLITE.LINK>
								
								<REMOVEVAR NAME="PreviewURL"/>
								<PREVIEWURL.MAKEURL VARNAME="PreviewURL" ASSETTYPE="Variables.AssetType" ASSETID="PGList.assetid" PUBID="SessionVariables.pubid"/>
								
								<ASSET.GETSUBTYPE TYPE="Variables.AssetType" OBJECTID="PGList.assetid" OUTPUT="stype" />
								<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
									<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
									<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
								</CALLELEMENT>
								<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
									<ARGUMENT NAME="Label" VALUE="PGList.name"/>
									<ARGUMENT NAME="Description" VALUE="PGList.description"/>
									<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
									<!-- LoadURL implicitly passed in -->
									<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
									<ARGUMENT NAME="ExecuteURL" VALUE="Variables.ExecuteURL"/>
									<!-- OKActions implicitly passed in -->
									<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
									<ARGUMENT NAME="RefreshKeys" VALUE="PGList.assetid"/>
									<ARGUMENT NAME="executeFunction" VALUE="Variables.cs_defaultFunctionChild" />
									<ARGUMENT NAME="okFunctions" VALUE="Variables.okFunctions" />
								</CALLELEMENT>
							</loop>
						</then>
						</if>
					</LOOP>
					<!--  End of LOADALL NON-ROOTS ---------------------------------------------------------------------------   -->
				</else>
				</if>
				</then>
			<else>
				<!-- mode = true, load nodes according to search criteria -->
				<!-- if criteria is received -->
				<if COND="IsVariable.criteria=true">
				<then>
					<!-- add wildcard at head and tail of user input -->
					<setvar NAME="input" VALUE="%Variables.criteria%"/> 
					<BEGINS STR="Variables.criteria" WHAT="%"/>
					<if COND="Variables.errno=1">
					<then>
						<setvar NAME="input" VALUE="Variables.criteria"/>
					</then>
					</if>
					<ENDS STR="Variables.criteria" WHAT="%"/>
					<if COND="Variables.errno=1">
					<then>
						<setvar NAME="input" VALUE="Variables.criteria"/>
					</then>
					</if>
					<if COND="Variables.criteria=%">
					<then>
						<setvar NAME="input" VALUE="%"/>
					</then>
					</if>
					
					<if COND="Variables.criteria=*">
					<then>					    
						<setvar NAME="input" VALUE="%"/>
					</then>
					</if>
				
				<!-- make query to get non-root nodes with the search criteria -->
				<TOLOWER STR="Variables.input" OUTSTR="input"/>
				<ics.literal table="Variables.GroupName" column="name" string="Variables.input" output="literal"/>
				
				<setvar NAME="tablename" VALUE="ChildTypes.assettype"/>
				<SETVAR NAME="sql" VALUE="select * from (
				select Variables.GroupName.id as assetid,AssetPublication.assettype as assettype,Variables.GroupName.name as name,Variables.GroupName.description as description
				from	Variables.GroupName,AssetPublication,Variables.GroupName_Group pgg
				where Variables.GroupName.id=AssetPublication.assetid
					and (AssetPublication.pubid=SessionVariables.pubid or AssetPublication.pubid=0)
					and Variables.GroupName.status!='VO'
					and lower(Variables.GroupName.name) like Variables.literal
					and pgg.parentid=Variables.id
					and pgg.childid=Variables.GroupName.id
					and pgg.primarycount>0"/>
								   
				<LOOP LIST="ChildTypes">  
					<SETVAR NAME="sql" VALUE="Variables.sql  
					  UNION
					select ChildTypes.assettype.id as assetid,AssetPublication.assettype as assettype,ChildTypes.assettype.name as name,ChildTypes.assettype.description as description
					from  ChildTypes.assettype,AssetPublication,Variables.GroupName_Group pgg
					where ChildTypes.assettype.id=AssetPublication.assetid
						and (AssetPublication.pubid=SessionVariables.pubid or AssetPublication.pubid=0)
						and ChildTypes.assettype.status!='VO'
						and lower(ChildTypes.assettype.name) like Variables.literal
						and pgg.parentid=Variables.id
						and pgg.childid=ChildTypes.assettype.id
						and pgg.primarycount>0"/>
				</LOOP>	
				<SETVAR NAME="sql" VALUE="Variables.sql) t1 order by t1.assettype, t1.name asc"/>
				<CALLELEMENT NAME="OpenMarket/Xcelerate/Util/validateFields">
					<ARGUMENT NAME="columnvalue" VALUE="Variables.id"/>
					<ARGUMENT NAME="type" VALUE="Long"/>
				</CALLELEMENT>
				<IF COND="Variables.validatedstatus=true">
				<THEN>
					<execsql LIST="PGList" SQL="Variables.sql"/>
				</THEN>
				</IF>
				<if COND="IsList.PGList=true">
				<then>
					<IF COND="PGList.#numRows!=0">
					<THEN>
						<STARTMENU.GETMATCHINGSTARTITEMS ITEMTYPE="ContentForm" PUBID="SessionVariables.pubid" ASSETTYPE="PGList.assettype" INPUTARGUMENTS="subtype" LISTVARNAME="startitems"/>
						<IF COND="IsList.startitems=true">
						<THEN>
							<IF COND="startitems.#numRows!=0">
							<THEN>
								<SETVAR NAME="OKActions" VALUE="__LIKEMESTARTMENU__;__CHILDSTARTMENU__;Status;Inspect;Edit;Preview;Delete;refresh"/>
							</THEN>
							<ELSE>
								<SETVAR NAME="OKActions" VALUE="Status;Inspect;Edit;Preview;Delete;refresh"/>
							</ELSE>
							</IF>
						</THEN>
						</IF>
						<loop LIST="PGList">
							<callelement NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID">
								<argument NAME="ID" VALUE="PGList.assetid"/>
								<argument NAME="AssetType" VALUE="PGList.assettype"/>
							</callelement>
							
							<!--Now check to see if we have children-->
							<flexgroups.countimmediatechildren 
								SITE="SessionVariables.pubid"
								NAME="GroupManager" 
								ID="PGList.assetid" 
								VARNAME="PGChildrenCount"/> 
							<if COND="Variables.PGChildrenCount!=0">
							<then>
								<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
									<satellite.argument name="AssetType" value="PGList.assettype"/>
									<satellite.argument name="populate" value="OpenMarket/Xcelerate/AssetType/PGList.assettype/LoadTree"/>
									<satellite.argument name="id" value="PGList.assetid"/>
									<satellite.argument name="op" value="load"/>
								</SATELLITE.LINK>
							</then>
							<else>
								<REMOVEVAR NAME="LoadURL"/>
							</else>
							</if>
							<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="ExecuteURL">
								<satellite.argument name="AssetType" value="PGList.assettype"/>
								<satellite.argument name="n0_" value="Variables.TreeNodeID"/>
								<satellite.argument name="op" value="displayNode"/>
							</SATELLITE.LINK>

							<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/TreeOpURL" outstring="OpURL">
								<satellite.argument name="AssetType" value="PGList.assettype"/>
							</SATELLITE.LINK>

							<REMOVEVAR NAME="PreviewURL"/>
							<PREVIEWURL.MAKEURL VARNAME="PreviewURL" ASSETTYPE="Variables.AssetType" ASSETID="PGList.assetid" PUBID="SessionVariables.pubid"/>

							<ASSET.GETSUBTYPE TYPE="PGList.assettype" OBJECTID="PGList.assetid" OUTPUT="stype" />
							<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/FindAssetImage">
								<ARGUMENT NAME="AssetType" VALUE="PGList.assettype"/>
								<ARGUMENT NAME="AssetDef" VALUE="Variables.stype"/>
							</CALLELEMENT>
							<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
								<ARGUMENT NAME="Label" VALUE="PGList.name"/>
								<ARGUMENT NAME="Description" VALUE="PGList.description"/>
								<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>
								<!-- LoadURL implicitly passed in -->
								<ARGUMENT NAME="OpURL" VALUE="Variables.OpURL"/>
								<ARGUMENT NAME="ExecuteURL" VALUE="Variables.ExecuteURL"/>
								<!-- OKActions implicitly passed in -->
								<ARGUMENT NAME="Image" VALUE="Variables.imageUsed"/>
								<ARGUMENT NAME="RefreshKeys" VALUE="PGList.assetid"/>
							</CALLELEMENT>
						</loop>
					</THEN>
					<ELSE>
						<!-- mode set but no criteria received, which is basically impossible -->
						Status:26:InvalidNoCriteriaForSearch:END:3:END:
					</ELSE>
					</IF>
				</then>
            </if>
				<!--  End of LOADSelect ---------------------------------------  -->
				</then>
				<else>
					<!-- mode set but no criteria received, which is basically impossible -->
					Status:26:InvalidNoCriteriaForSearch:END:3:END:
				</else>
				</if>
			</else>
			</if>
		</else>
		</if>
	</else>
	</if>
</ELSE>
</IF>
</THEN>
</IF>
</ELSE>
</IF>
</FTCS> 
