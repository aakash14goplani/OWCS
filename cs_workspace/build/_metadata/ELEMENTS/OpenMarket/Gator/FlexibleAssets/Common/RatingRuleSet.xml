<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Gator/FlexibleAssets/Common/RatingRuleSet
--
-- INPUT
--	 
   This is a common module for FlexAssets and FlexGroups
-- OUTPUT
--
-->

<if COND="IsVariable.RuleFieldsValid=true">
<then>
    <if COND="Variables.RuleFieldsValid=true">
    <then>
    <!-- 
	<IF COND="Variables.flextypes=assets">
	<THEN>
		<FLEXASSET.GETRATINGRULESETMAP NAME="theCurrentAsset" OBJVARNAME="theAppMap"/> 
	</THEN>
	</IF>
	<IF COND="Variables.flextypes=groups">
	<THEN>
		<FLEXGROUP.GETRATINGRULESETMAP NAME="theCurrentAsset" OBJVARNAME="theAppMap"/> 
	</THEN>
	</IF>
	 -->

	<!-- set up for "this" rulemap value -->
	<!-- 
	<ASSET.GET NAME="theCurrentAsset" FIELD="id"/>
	<RULESETMAP.SET NAME="theAppMap" KEY="this" TYPE="asset" VALUE="Variables.AssetType:Variables.id"/>
 	-->
	<if COND="Variables.RuleCreation=UI">
	<then>
		<!-- Construct hintstring -->
		<setvar NAME="OrderSize" VALUE="0"/>
	
		<CALLJAVA CLASS="com.openmarket.xcelerate.util.XclUtil">
			<ARGUMENT NAME="ftcmd" VALUE="GenRankedItems"/>
		</CALLJAVA>
		<setcounter NAME="currcount" VALUE="0"/>
		<!--  The new logic  is 
			-to build the ID-val  list   and IDNOT-val list 
			- form a nested loop to construct a triplet 
			and set the nvobject 
		--> 
			
		<!--  <NVOBJECT.CREATE NAME="myhintobject"/>  -->
		<setcounter  NAME="segcounter"  VALUE="0"/>
		<if COND="IsVariable.OrderSize=true">
		<then>
			<if COND="Variables.OrderSize!=0">
			<then>
				<listobject.create  NAME="IDList" COLUMNS="id,val,set"/>
				<listobject.create  NAME="NOTIDList" COLUMNS="id,val,set"/>
				<loop FROM="0" COUNT="Variables.OrderSize">
					<setvar NAME="errno"  VALUE="0"/>
					<setvar NAME="idvar"  VALUE="Variables.IdCounters.currcount"/>
					<setvar NAME="varvalue" VALUE="RankCounters.currcount"/>
					<setvar NAME="currentval" VALUE="Variables.RankCounters.currcount"/>
					<setvar NAME="errno" VALUE="0"/>
					<BEGINS STR="Variables.currentval" WHAT="0"/>
					<IF COND="Variables.errno=1">
					<THEN>
						<SUBSTRING STR="Variables.currentval" OUTSTR="Variables.varvalue" INDEX="1"/>
						<setvar NAME="currentval" VALUE="Variables.RankCounters.currcount"/>
						<setvar NAME="errno" VALUE="0"/>
						<BEGINS STR="Variables.currentval" WHAT="0"/>
						<IF COND="Variables.errno=1">
						<THEN>
							<SUBSTRING STR="Variables.currentval" OUTSTR="Variables.varvalue" INDEX="1"/>
						</THEN>
						</IF>
					</THEN>
					</IF>
					<ENDS STR="Variables.idvar" WHAT="NOT"/>
					<IF COND="Variables.errno=1">
					<THEN>
						<listobject.addrow  NAME="NOTIDList" id="Variables.IdCounters.currcount" val="Variables.RankCounters.currcount" set="no"/>
						<TEXTFORMAT.LENGTH VALUE="Variables.idvar" VARNAME="length"/>
						<CALCULATOR.GO VALUE="Variables.length 3 -" VARNAME="newlength"/>
						<SUBSTRING STR="Variables.idvar" OUTSTR="outid" ENDINDEX="Variables.newlength"/>
						<setvar NAME="NOTVariables.outid" VALUE="Variables.RankCounters.currcount"/>
					</THEN>
					<ELSE>
						<listobject.addrow  NAME="IDList"  id="Variables.IdCounters.currcount" val="Variables.RankCounters.currcount" set="no"/> 
						<setvar NAME="Variables.idvar" VALUE="Variables.RankCounters.currcount"/>
					</ELSE>
					</IF>
					<inccounter NAME="currcount" VALUE="1"/>
				</loop>
				
				<listobject.tolist  NAME="NOTIDList" LISTVARNAME="NOTlist"/>
				<listobject.tolist  NAME="IDList" LISTVARNAME="ratlist"/>
				<if COND="IsList.ratlist=true">
				<then>
					<if COND="ratlist.#numRows!=0">
					<then>
						<setvar NAME="rrows"  VALUE="ratlist.#numRows"/>
					</then>
					</if>
				</then>
				</if>
				<if COND="IsList.NOTlist=true">
				<then>
					<if COND="NOTlist.#numRows!=0">
					<then>
						<setvar NAME="NOTrows"  VALUE="NOTlist.#numRows"/>
						<!-- initialize the NOTlist.idset=no -->
							
						<loop LIST="NOTlist">
							<setvar NAME="foundNOTSet" VALUE="NOTlist.idset"/>
							<setvar NAME="Variables.foundNOTSet"  VALUE="no"/>
						</loop>
					</then>
					</if>
				</then>
				</if>
							
				<if COND="IsVariable.rrows=true">
				<then>
					<!--  there are some ratings -->
					<loop  LIST="ratlist">
						<if COND="IsVariable.NOTrows=true">
						<then>
							<!-- there are some NOT ratings -->
							<setvar NAME="foundset" VALUE="ratlist.idset"/>
							<setvar NAME="Variables.foundset"  VALUE="no"/>
									 
 									 
							<loop LIST="NOTlist">
								<setvar NAME="errno"  VALUE="0"/>
								<setvar NAME="NOTlist.set"  VALUE="no"/>
								<BEGINS STR="NOTlist.id" WHAT="ratlist.id"/>
								<IF COND="Variables.errno=1">
								<THEN>
									<!-- we found a id-NOTid pair, update the  third list-->									
									<!--  <ASSET.LIST TYPE="Segments" LIST="rsList" FIELD1="id" VALUE1="ratlist.id"/> -->
									<ASSET.LIST TYPE="Segments" LIST="rsList" FIELD1="id" VALUE1="ratlist.id"/>
									<setvar NAME="segid"  VALUE="rsList.name"/>
									<!-- <NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="SEGIDCounters.segcounter" VALUE="Variables.segid"/> -->
									<!-- <NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="SEGKEYCounters.segcounter" VALUE="SEGKEYCounters.segcounter"/> 
									<SETVAR NAME="ourKey" VALUE="SEGKEYCounters.segcounter"/>
									<SETVAR NAME="ourValue" VALUE="Segments:Variables.segid"/>
									<RULESETMAP.SET NAME="theAppMap" KEY="Variables.ourKey" TYPE="asset" VALUE="Variables.ourValue"/>
                                                    
									<NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="RATINGCounters.segcounter" VALUE="ratlist.val"/>
									<NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="NOTRATINGCounters.segcounter" VALUE="NOTlist.val"/>
									 -->
									<setvar NAME="foundNOTSet" VALUE="NOTlist.idset"/>
									<setvar NAME="Variables.foundset"  VALUE="yes"/>
									<setvar NAME="Variables.foundNOTSet"  VALUE="yes"/>
									<setvar NAME="NOTlist.set"  VALUE="yes"/>
									
									
									<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_segID" VALUE="Variables.segid"/>
									<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_inRating" VALUE="ratlist.val"/>
									<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_outRating" VALUE="NOTlist.val"/>
									
									
									<inccounter NAME="segcounter"  VALUE="1"/>
								</THEN>
								</IF>
							</loop>
							<setvar NAME="tempvar1"  VALUE="Variables.Variables.foundset"/>
							<if COND="Variables.tempvar1=no">
							<then>
								<ASSET.LIST TYPE="Segments" LIST="rsList" FIELD1="id" VALUE1="ratlist.id"/> 
								<setvar NAME="segid"  VALUE="rsList.name"/>
								<!--  have not found a matching NOT, so set it to empty -->
								<!-- <NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="SEGIDCounters.segcounter" VALUE="ratlist.id"/> -->
								<!-- <NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="SEGKEYCounters.segcounter" VALUE="SEGKEYCounters.segcounter"/>
								<SETVAR NAME="ourKey" VALUE="SEGKEYCounters.segcounter"/>
								<SETVAR NAME="ourValue" VALUE="Segments:ratlist.id"/>
								<RULESETMAP.SET NAME="theAppMap" KEY="Variables.ourKey" TYPE="asset" VALUE="Variables.ourValue"/> 
                                                    
								<NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="RATINGCounters.segcounter" VALUE="ratlist.val"/>
								<NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="NOTRATINGCounters.segcounter" VALUE="Variables.empty"/>
								-->
								<!--setvar NAME="NOTlist.idset"  VALUE="no"/-->
								<setvar NAME="foundset" VALUE="ratlist.idset"/>
								<setvar NAME="Variables.foundset"  VALUE="yes"/>
								
								
								<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_segID" VALUE="Variables.segid"/>
								<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_inRating" VALUE="ratlist.val"/>
								
								<inccounter NAME="segcounter"  VALUE="1"/>
								
							</then>
							</if>
										
							<!--  if there are any NOTID's for which a matching ID was not found, in
								which case,  the NOTlist.idset=no -->
						</then>
						<else>
							<ASSET.LIST TYPE="Segments" LIST="rsList" FIELD1="id" VALUE1="ratlist.id"/> 
							<setvar NAME="segid"  VALUE="rsList.name"/>
							<!-- there are only rrows , so set NOTrows to Emptty -->
							<!--  have not found a matching NOT, so set it to empty -->
							<!-- <NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="SEGIDCounters.segcounter" VALUE="ratlist.id"/> -->
							<!-- <NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="SEGKEYCounters.segcounter" VALUE="SEGKEYCounters.segcounter"/>
							<SETVAR NAME="ourKey" VALUE="SEGKEYCounters.segcounter"/>
							<SETVAR NAME="ourValue" VALUE="Segments:ratlist.id"/>
							 <RULESETMAP.SET NAME="theAppMap" KEY="Variables.ourKey" TYPE="asset" VALUE="Variables.ourValue"/>
                                    
							<NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="RATINGCounters.segcounter" VALUE="ratlist.val"/>
							<NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="NOTRATINGCounters.segcounter" VALUE="Variables.empty"/>
							 -->
							<!--setvar NAME="NOTlist.idset"  VALUE="no"/-->
							<setvar NAME="foundset" VALUE="ratlist.idset"/>
							<setvar NAME="Variables.foundset"  VALUE="yes"/>
							
							
							<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_segID" VALUE="Variables.segid"/>
							<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_inRating" VALUE="ratlist.val"/>
							
							<inccounter NAME="segcounter"  VALUE="1"/>
	 
						</else>
						</if>
					</loop>
					<!-- go through the NOTlist and find out if there are any NOTId's for which  a matching ID is  not found -->
					<loop LIST="NOTlist">
						<setvar NAME="2foundNOTSet" VALUE="NOTlist.idset"/>
						<setvar NAME="tempvar2"  VALUE="Variables.Variables.2foundNOTSet"/>
						<if COND="Variables.tempvar2=no">
						<then>
							<INDEXOF STR="NOTlist.id" WHAT="NOT" OUTSTR="index" />
							<IF COND="Variables.errno=1">
							<THEN>
								<setcounter NAME="endindex" VALUE="Variables.index"/>
								<SUBSTRING STR="NOTlist.id" OUTSTR="myID" INDEX="0" ENDINDEX="Variables.index"/>
								
								<ASSET.LIST TYPE="Segments" LIST="rsList" FIELD1="id" VALUE1="Variables.myID"/> 
								<setvar NAME="segid"  VALUE="rsList.name"/>
								<!-- <NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="SEGIDCounters.segcounter" VALUE="Variables.myID"/>  -->
								<!-- <NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="SEGKEYCounters.segcounter" VALUE="SEGKEYCounters.segcounter"/>
								<SETVAR NAME="ourKey" VALUE="SEGKEYCounters.segcounter"/>
								<SETVAR NAME="ourValue" VALUE="Segments:Variables.myID"/>
								<RULESETMAP.SET NAME="theAppMap" KEY="Variables.ourKey" TYPE="asset" VALUE="Variables.ourValue"/>

								<NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="RATINGCounters.segcounter" VALUE="Variables.empty"/>
								<NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="NOTRATINGCounters.segcounter" VALUE="NOTlist.val"/>
								 -->
								<setvar NAME="Variables.foundNOTSet"  VALUE="yes"/>	
								
								
									<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_segID" VALUE="Variables.segid"/>
									<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_outRating" VALUE="NOTlist.val"/>
									
								<inccounter NAME="segcounter"  VALUE="1"/>
							</THEN>
							</IF>
						</then>
						</if>
					</loop>

				</then>
				<else>
					<if COND="IsVariable.NOTrows=true">
					<then>
						<loop LIST="NOTlist">
							<setvar NAME="foundNOTSet" VALUE="NOTlist.idset"/>
							<!-- there are ony  NOT ratings no ratings set ratings to empty -->
							<setvar NAME="errno"  VALUE="0"/>
							<INDEXOF STR="NOTlist.id" WHAT="NOT" OUTSTR="index"/>
							<IF COND="Variables.errno=1">
							<THEN>
								<setcounter NAME="endindex" VALUE="Variables.index"/>
								<!--inccounter  NAME="endindex"  VALUE="-1"/-->
								<SUBSTRING STR="NOTlist.id" OUTSTR="myID" INDEX="0" ENDINDEX="Variables.index"/>
								<ASSET.LIST TYPE="Segments" LIST="rsList" FIELD1="id" VALUE1="Variables.myID"/> 
								<setvar NAME="segid"  VALUE="rsList.name"/>
								<!-- <NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="SEGIDCounters.segcounter" VALUE="Variables.myID"/>  -->
								<!-- <NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="SEGKEYCounters.segcounter" VALUE="SEGKEYCounters.segcounter"/> 
								<SETVAR NAME="ourKey" VALUE="SEGKEYCounters.segcounter"/>
								<SETVAR NAME="ourValue" VALUE="Segments:Variables.myID"/>
								<RULESETMAP.SET NAME="theAppMap" KEY="Variables.ourKey" TYPE="asset" VALUE="Variables.ourValue"/>

								<NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="RATINGCounters.segcounter" VALUE="Variables.empty"/>
								<NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="NOTRATINGCounters.segcounter" VALUE="NOTlist.val"/>
								 -->
								<setvar NAME="Variables.foundNOTSet"  VALUE="yes"/>												
								
								
									<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_segID" VALUE="Variables.segid"/>
									<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_outRating" VALUE="NOTlist.val"/>
								
								<inccounter NAME="segcounter"  VALUE="1"/>
							</THEN>
							</IF>
						</loop>
					</then>
					<else>
						<!-- there are neither rrows ,not  NOTrows  everything becomes empty -->
					</else>
					</if>
				</else>
				</if>
			</then>
			</if>
		</then>
		</if>
			
		<if COND="Counters.segcounter=0">
		<then>
			<if COND="IsVariable.SegDefRating=true">
			<then>
				<if COND="Variables.SegDefRating!=Variables.empty">
				<then>
					<!-- <NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="DEFAULTRATING" VALUE="Variables.SegDefRating"/> -->
					
					<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_segID" VALUE="DEFAULTRATING"/>
					<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_inRating" VALUE="Variables.SegDefRating"/>
					<SETVAR NAME="flexVariables.flextypes:SegRating:Total" VALUE="1"/>
				</then>
				</if>
			</then>
			<else>
				<!--NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="DEFAULTRATING" VALUE="50"/-->
				<!-- should we set a default value ?? -->
			</else>
			</if>
		</then>
		<else>
			<if COND="IsVariable.SegDefRating=true">
			<then>
				<SUBSTITUTE STR="Variables.SegDefRating" WHAT="%20" WITH ="" OUTSTR="SegDefRating"/>

				<if COND="Variables.SegDefRating!=Variables.empty">
				<then>
					<!-- <NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="DEFAULTRATING" VALUE="Variables.SegDefRating"/> -->
					<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_segID" VALUE="DEFAULTRATING"/>
					<SETVAR NAME="flexVariables.flextypes:SegRating:Counters.segcounter_inRating" VALUE="Variables.SegDefRating"/>
					
					<CAlCULATOR.GO VALUE="Counters.segcounter 1 +" VARNAME="segTotal"/>
					<SETVAR NAME="flexVariables.flextypes:SegRating:Total" VALUE="Variables.segTotal"/>
				</then>
				</if>
			</then>
			<else>
					<SETVAR NAME="flexVariables.flextypes:SegRating:Total" VALUE="Counters.segcounter"/>
			</else>
			</if>
		</else>
		</if>
		<!-- 
		<IF COND="Variables.flextypes=assets">
		<THEN>
			<FLEXASSET.SETRATINGRULESETMAP NAME="theCurrentAsset" OBJECT="theAppMap"/>
		</THEN>
		</IF>
		<IF COND="Variables.flextypes=groups">
		<THEN>
			<FLEXGROUP.SETRATINGRULESETMAP NAME="theCurrentAsset" OBJECT="theAppMap"/>
		</THEN>
		</IF>

		<ASSET.SCATTER NAME="theCurrentAsset" PREFIX="flexVariables.flextypes" FIELDLIST="ruleset"/>
		 -->
		 <!--  Ideally we should asset.scatter field segRatings... this element is manually constructing the ics variables to post -->

<!-- do not generate ruleset
 		<NVOBJECT.SETVALUE NAME="myhintobject" VALUENAME="NUMSEGS" VALUE="Counters.segcounter"/>
		<NVOBJECT.TOSTRING NAME="myhintobject" VARNAME="hintstring"/>
		<IF COND="Variables.id!=Variables.empty">
		<THEN> -->
			<!-- asset has been saved already, ok to create ruleset -->
			<!-- Variables needed are hintstring, assettype, assetid, targetxml -->
			<!-- 
			<callelement NAME="OpenMarket/Gator/Rules/GenerateRatingRuleset">
				<argument NAME="assettype" VALUE="Variables.AssetType"/>
				<argument NAME="assetid" VALUE="Variables.id"/>
				<argument NAME="targetxml" VALUE="flexVariables.flextypes:ruleset"/>
			</callelement>
		</THEN>
		</IF>
		
		 -->
	</then>


	</if>
    </then>
    </if>
</then>

</if>



</FTCS> 

  
	  
