<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Gator/FlexibleAssets/FlexAssets/Recommendations
--
-- INPUT
--
-- OUTPUT
--
-->

    <!-- Display recommendations only if we are allowed to.  There is a toggle link which controls this by reposting the form,
	called "displayRecommendations".  If it is not there, or it is false, don't display recommendations at all (in fact, we
	treat it as if there are no recommendations at all in the system). -->
    <IF COND="IsVariable.displayRecommendations=false">
    <THEN>
	<SETVAR NAME="displayRecommendations" VALUE="false"/>
    </THEN>
    </IF>
	<STRING.ENCODE VARIABLE="displayRecommendations" VARNAME="displayRecommendations"/>
    <INPUT TYPE="hidden" NAME="displayRecommendations" VALUE="Variables.displayRecommendations" REPLACEALL="Variables.displayRecommendations"/>

    <SETVAR NAME="recommendationsList" VALUE=""/>
    
	
 	<!-- get all recommendation assets for this site -->
	<ATM.LOCATE TYPE="AdvCols" VARNAME="recmgr"/>
	<COMPLEXASSETS.GETALLASSETSSORTED NAME="recmgr" LISTVARNAME="reclist" SITE="SessionVariables.pubid"/>
	<IF COND="IsList.reclist=true">
	<THEN>
		<!-- For all these assets, get the encoding of their rulesets -->
		<ACOLLECTIONS.GETENCODING NAME="recmgr" LISTVARNAME="encodinglist" ASSETS="reclist"/>
		<!-- Build a hash from the results -->
		<HASH.CREATE NAME="encodinghash"/>
		<IF COND="encodinglist.#numRows!=0">
		<THEN>
			<LOOP LIST="encodinglist">
				<HASH.ADD NAME="encodinghash" KEY="encodinglist.assetid" VALUE="encodinglist.encoding"/>
			</LOOP>
		</THEN>
		</IF>

		<IF COND="reclist.#numRows!=0">
		<THEN>
 			<SETCOUNTER NAME="numRecs" VALUE="0"/>
			<LOOP LIST="reclist">
 				<setvar NAME="recType" VALUE="unknown"/>
				<setvar NAME="encodingstring" VALUE="Variables.empty"/>
				<HASH.GET NAME="encodinghash" VALUE="reclist.assetid" VARNAME="encodingstring"/>
				<IF COND="IsVariable.encodingstring=false">
				<THEN>
					<SETVAR NAME="encodingstring" VALUE="Variables.empty"/>
				</THEN>
				</IF>
				<IF COND="Variables.encodingstring!=Variables.empty">
				<THEN>
					<nvobject.create NAME="nvRuleSet"/>
					<nvobject.fromstring NAME="nvRuleSet" VALUE="Variables.encodingstring"/>  
					<nvobject.getvalue NAME="nvRuleSet" VALUENAME="ADVCOLTYPE" VARNAME="recType"/>
				</THEN>
				</IF>

 				<IF COND="Variables.recType=assetlocal">
				<THEN>
					<setvar NAME="varname" VALUE="Counters.numRecsAssetStr"/>
					<callelement NAME="OpenMarket/Gator/FlexibleAssets/Common/AssetListDnD">
						<argument NAME="list" VALUE="ContentDetails:Relationships"/>
						<argument NAME="recname" VALUE="reclist.name"/>
						<argument NAME="recid" VALUE="reclist.assetid"/>
						<argument NAME="displaytype" VALUE="input"/>
					</callelement>
					<IF COND="Variables.recommendationsList=Variables.empty">
					<THEN>
						<SETVAR NAME="recommendationsList" VALUE="reclist.assetid"/>
					</THEN>
					<ELSE>
						<SETVAR NAME="recommendationsList" VALUE="Variables.recommendationsList,reclist.assetid"/>
					</ELSE>
					</IF>
					<INCCOUNTER NAME="numRecs" VALUE="1"/>
				</THEN>
 				</IF>
			</LOOP>
			<IF COND="Variables.numRecs=0">
			<THEN>
				<span class="disabledText"><XLAT.STREAM KEY="UI/Forms/NotAvailable"/></span>
			</THEN>
			</IF>
			<INPUT TYPE="hidden" NAME="numberRecommendations" VALUE="Counters.numRecs" REPLACEALL="Counters.numRecs"/>
			<INPUT TYPE="hidden" NAME="recommendationsList" VALUE="Variables.recommendationsList" REPLACEALL="Variables.recommendationsList"/>
		</THEN>
		<ELSE>
			<span class="disabledText"><XLAT.STREAM KEY="dvin/FlexibleAssets/Common/NoRecommendationsDef"/></span>
		</ELSE>
		</IF>
	</THEN>
	<ELSE>
		<span class="disabledText"><XLAT.STREAM KEY="dvin/FlexibleAssets/Common/NoRecommendationsDef"/></span>
	</ELSE>
	</IF>
   
 </FTCS> 
