<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Gator/FlexibleAssets/Common/CDLoadRuleset
--
-- INPUT
--
-- OUTPUT
--
-->
<!-- Read from DB do we have some API/tags?! sorry, bear w/ scatter-->
<if COND="Variables.ContentDetails:SegRating!=Variables.empty">
<then>
	<SETCOUNTER NAME="count" VALUE="0"/>
	<LISTOBJECT.CREATE NAME="myList" COLUMNS="assetid,rating,NOTrating"/>
	<LOOP COUNT="Variables.ContentDetails:SegRating:Total">
		<ICS.RESOLVEVARIABLES NAME="$(Variables.ContentDetails:SegRating:$(Counters.count)_segID)" OUTPUT="segName" DELIMITED="true"/>
		<IF COND="Variables.segName!=DEFAULTRATING">
		<THEN>
			<!-- UI elements expects a segment id number to show ratings correctly and we save segment name in tables.-->
			<!-- <ASSET.LIST TYPE="Segments" LIST="rsList" FIELD1="NAME" VALUE1="Variables.segName"/> -->
			<ASSET.LIST TYPE="Segments" LIST="rsList" FIELD1="name" VALUE1="Variables.segName"/>
						
			<setvar NAME="segID"  VALUE="rsList.id"/>
		
			<ICS.RESOLVEVARIABLES NAME="$(Variables.ContentDetails:SegRating:$(Counters.count)_inRating)" OUTPUT="inRating" DELIMITED="true"/>
			<ICS.RESOLVEVARIABLES NAME="$(Variables.ContentDetails:SegRating:$(Counters.count)_outRating)" OUTPUT="outRating" DELIMITED="true"/>

			<!-- In SQL Server the values are coming in float so we are removing off the float value and retaining only integer value -->			
			<INDEXOF STR='Variables.inRating' WHAT='.' OUTSTR='inRatingFloatIndex' INDEX='0'/>
			<INDEXOF STR='Variables.outRating' WHAT='.' OUTSTR='outRatingFloatIndex' INDEX='0'/>			
			<SUBSTRING STR="Variables.inRating" INDEX='0' ENDINDEX='Variables.inRatingFloatIndex' OUTSTR="inRating"/>
			<SUBSTRING STR="Variables.outRating" INDEX='0' ENDINDEX='Variables.outRatingFloatIndex' OUTSTR="outRating"/>
			<REMOVEVAR NAME='inRatingFloatIndex'/>
			<REMOVEVAR NAME='outRatingFloatIndex'/>
			
			<LISTOBJECT.ADDROW NAME="myList" assetid="Variables.segID" rating="Variables.inRating" NOTrating="Variables.outRating"/>
			<!-- <LOGMSG STR="Variables.inRating Variables.segID"/>  -->
			<setvar NAME="Variables.segID" VALUE="Variables.inRating"/>
		</THEN>
		<ELSE>
			<ICS.RESOLVEVARIABLES NAME="$(Variables.ContentDetails:SegRating:$(Counters.count)_inRating)" OUTPUT="inRating" DELIMITED="true"/>			
			<setvar NAME="segID"  VALUE="Variables.segName"/>
			
			<!-- In SQL Server the values are coming in float so we are removing the float value and retaining only integer value -->			
			<INDEXOF STR='Variables.inRating' WHAT='.' OUTSTR='inRatingFloatIndex' INDEX='0'/>
			<SUBSTRING STR="Variables.inRating" INDEX='0' ENDINDEX='Variables.inRatingFloatIndex' OUTSTR="inRating"/>
			<REMOVEVAR NAME='inRatingFloatIndex'/>
			
			<setvar NAME="SegDefRating" VALUE="Variables.inRating"/>
		</ELSE>
		</IF>
		
		<INCCOUNTER NAME="count" VALUE="1"/>	
	</LOOP>
	<LISTOBJECT.TOLIST NAME="myList" LISTVARNAME="RatingList"/>
</then>
</if>

<!-- 
<if COND="Variables.ContentDetails:ruleset!=Variables.empty">
<then>
	<rulesetdef.create NAME="theRule"/>
	<if COND="Variables.errno=0">
	<then>
		<rulesetdef.fromxml NAME="theRule" XML="Variables.ContentDetails:ruleset"/>
		<if COND="Variables.errno=0">
		<then>
			<rulesetdef.getencoding NAME="theRule" VARNAME="SegRuleSetHint"/>
			<nvobject.create NAME="nvRuleSet"/>
			<nvobject.fromstring NAME="nvRuleSet" VALUE="Variables.SegRuleSetHint"/>  
			<nvobject.getvalue NAME="nvRuleSet" VALUENAME="NUMSEGS" VARNAME="numberSegments"/>
  		<nvobject.getvalue NAME="nvRuleSet" VALUENAME="DEFAULTRATING" VARNAME="SegDefRating"/>
			
		
			<SETCOUNTER NAME="count" VALUE="0"/>
			<LISTOBJECT.CREATE NAME="myList" COLUMNS="assetid,rating,NOTrating"/>
			<if COND="IsVariable.numberSegments=true">
			<then>
			   <if COND="Variables.numberSegments!=0">
				 <then> 
						<LOOP COUNT="Variables.numberSegments">
							<nvobject.getvalue NAME="nvRuleSet" VALUENAME="SEGIDCounters.count" VARNAME="segid"/>
                            <IF COND="IsVariable.segid=true">
                               <THEN>
                                   !-- continue ... nothing to do here yet --
                               </THEN>
                               <ELSE>
            						<nvobject.getvalue NAME="nvRuleSet" VALUENAME="SEGKEYCounters.count" VARNAME="ourKey"/>
                                    <CALLELEMENT NAME="OpenMarket/Gator/Rules/RuleSetMapKeyLookup">
                                        <ARGUMENT NAME="ourKey" VALUE="Variables.ourKey"/>
                                        <ARGUMENT NAME="ourMap" VALUE="theAppMap"/>
                                    </CALLELEMENT>
                                    <SETVAR NAME="segid" VALUE="Variables.ourAssetid"/>
                                    
                               </ELSE>
                           </IF>
							<nvobject.getvalue NAME="nvRuleSet" VALUENAME="RATINGCounters.count" VARNAME="rating"/>
							<nvobject.getvalue NAME="nvRuleSet" VALUENAME="NOTRATINGCounters.count" VARNAME="NOTrating"/>
							
							
							<LISTOBJECT.ADDROW NAME="myList" assetid="Variables.segid" rating="Variables.rating" 
										 NOTrating="Variables.NOTrating"/>
							<setvar NAME="Variables.segid" VALUE="Variables.rating"/>
							<INCCOUNTER NAME="count" VALUE="1"/>
						</LOOP>
					</then>
					</if>
				</then>
				</if>
			<LISTOBJECT.TOLIST NAME="myList" LISTVARNAME="RatingList"/>
		</then>
		<else>
			<br/><XLAT.STREAM KEY="dvin/FlexibleAssets/Common/RluleSeterror" errno="Variables.errno" EVALALL="false"/> 	
        </else>
		</if>
	</then>
	<else>
		<br/><XLAT.STREAM KEY="dvin/AT/AdvCols/ErrorRuleSetCreate" errno="Variables.errno" EVALALL="false"/> 
	</else>
	</if>
</then>
</if>
 -->

</FTCS> 
