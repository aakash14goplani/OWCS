<?xml version="1.0" ?>
<!DOCTYPE ftcs SYSTEM "futuretense_cs.dtd">
<ftcs version="1.2">
<!-- OpenMarket/Gator/FlexibleAssets/Common/RemotePost
-
- INPUT
- flextype - [asset|group]
- OUTPUT
-
-->
<IF COND="Variables.flextype=asset">
<THEN>
    <FATM.GETTEMPLATETYPE ASSETTYPE="Variables.AssetType" VARNAME="templatetype"/>
    <FATM.GETGROUPTYPE ASSETTYPE="Variables.AssetType" VARNAME="grouptype"/>
    <FGTM.GETTEMPLATETYPE ASSETTYPE="Variables.grouptype" VARNAME="parentdeftype"/>
    <SETVAR NAME="prefix" VALUE="flexasset"/>
    <SETVAR NAME="defColname" VALUE="flextemplateid"/>
</THEN>
<ELSE>
    <FGTM.GETTEMPLATETYPE ASSETTYPE="Variables.AssetType" VARNAME="templatetype"/>
    <SETVAR NAME="grouptype" VALUE="Variables.AssetType"/>
    <SETVAR NAME="prefix" VALUE="flexgroup"/>
    <SETVAR NAME="defColname" VALUE="flexgrouptemplateid"/>
</ELSE>
</IF>

<!-- Check core fields -->
<if COND="IsVariable._TYPE_=true">
<then>
    <SETVAR NAME="definitionName" VALUE="Variables._TYPE_"/>
</then>
</if>
<if COND="IsVariable._DEFINITION_=true">
<then>
    <SETVAR NAME="definitionName" VALUE="Variables._DEFINITION_"/>
</then>
</if>
<if COND="IsVariable.pgrouptemplatename=true">
<then>
    <SETVAR NAME="definitionName" VALUE="Variables.pgrouptemplatename"/>
</then>
</if>
<if COND="IsVariable.fgrouptemplatename=true">
<then>
    <SETVAR NAME="definitionName" VALUE="Variables.fgrouptemplatename"/>
</then>
</if>

<IF COND="IsVariable.definitionName!=true">
<THEN>
    <XLAT.STREAM KEY="dvin/FlexibleAssets/FlexAssets/FatalErrorDefine"/> 
    <THROWEXCEPTION/>        
</THEN>
</IF>
<SETVAR NAME="errno" VALUE="0"/>
<ASSET.LIST TYPE="Variables.templatetype" LIST="currentDef" FIELD1="name" VALUE1="Variables.definitionName"/>
<IF COND="Variables.errno=0">
<THEN>
    <setvar NAME="Variables.prefixs:Variables.defColname"  VALUE="currentDef.id"/>
</THEN>
</IF>

<if COND="IsVariable._ITEMNAME_=true">
<then>
    <setvar  NAME="Variables.prefixs:name"  VALUE="Variables._ITEMNAME_"/>
</then>
</if>

<if COND="IsVariable.internalname=true">
<then>
    <setvar  NAME="Variables.prefixs:name"  VALUE="Variables.internalname"/>
    <setvar NAME="_ITEMNAME_" VALUE="Variables.internalname"/>
</then>
</if>

<IF COND="IsVariable._ITEMNAME_!=true">
<THEN>
    <XLAT.STREAM KEY="dvin/FlexibleAssets/FlexAssets/FatalErrorItemName"/> 
    <THROWEXCEPTION/>        
</THEN>
</IF>

<if COND="IsVariable.internaldescription=true">
<then>
    <setvar  NAME="Variables.prefixs:description"  VALUE="Variables.internaldescription"/>
</then>
</if>
<if COND="IsVariable._ITEMDESCRIPTION_=true">
<then>
    <setvar  NAME="Variables.prefixs:description"  VALUE="Variables._ITEMDESCRIPTION_"/>
</then>
</if>

<if COND="IsVariable.startdate=true">
<then>
    <setvar  NAME="Variables.prefixs:startdate"  VALUE="Variables.startdate"/>
</then>
</if>
<if COND="IsVariable.enddate=true">
<then>
    <setvar  NAME="Variables.prefixs:enddate"  VALUE="Variables.enddate"/>
</then>
</if>


<IF COND="IsVariable.filename=true">
<THEN>
    <SETVAR  NAME="Variables.prefixs:filename"  VALUE="Variables.filename"/>
</THEN>
</IF>

<IF COND="IsVariable.path=true">
<THEN>
    <SETVAR  NAME="Variables.prefixs:path"  VALUE="Variables.path"/>
</THEN>
</IF>

<if COND="IsVariable.externalid=true">
<then>
    <setvar NAME="Variables.prefixs:externalid"  VALUE="Variables.externalid"/>
</then>
</if>

<if COND="IsVariable.ruleset=true">
<then>
    <setvar NAME="Variables.prefixs:ruleset"  VALUE="Variables.ruleset"/>
</then>
</if>

<IF COND="IsVariable.displaystyle=true">
<THEN>
	<SETVAR NAME="template" VALUE="Variables.displaystyle"/>
</THEN>
</IF>

<SETVAR NAME="Variables.prefixs:renderid" VALUE="Variables.empty"/>
<IF COND="IsVariable.template=true">
<THEN>
	<SETVAR NAME="errno" VALUE="0"/>
	<ASSET.LIST TYPE="Template" LIST="currentTemplate" FIELD1="name" VALUE1="Variables.template"/>
	<IF COND="Variables.errno=0">
	<THEN>
		<SETVAR NAME="Variables.prefixs:template" VALUE="Variables.template"/>
		<SETVAR NAME="Variables.prefixs:renderid" VALUE="currentTemplate.id"/>
	</THEN>
	</IF>
</THEN>
</IF>

<!-- Check for parents -->

<if COND="IsVariable.ParentGroups=true">
<then>
    <setvar  NAME="ParentList"  VALUE="Variables.ParentGroups"/>
</then>
</if>
<if COND="IsVariable.ParentList=true">
<then>
    <STRINGLIST NAME="myparents" STR="Variables.ParentList" DELIM=";"/>
    <HASH.CREATE NAME="pHash"/>
    <loop LIST="myparents">
        <ASSET.LIST TYPE="Variables.grouptype" LIST="currentParent" FIELD1="name" VALUE1="myparents.ITEM" PUBID="Variables.primarypubid"/>
        <if COND="Variables.errno=0">
        <then>
            <HASH.ADD NAME="pHash" VALUE="currentParent.id"/>
        </then>
        </if>
    </loop>
    <HASH.TOSTRING NAME="pHash" VARNAME="sMyParentGroups" DELIM=";"/>
</then>
<else>
    <ASSET.LOAD NAME="tinst" TYPE="Variables.templatetype" FIELD="name" VALUE="Variables.definitionName"/>
    <IF COND="Variables.errno=0">
    <THEN>
        <HASH.CREATE NAME="pHash"/>
        <FLEXTEMPLATE.GETALLPARENTS NAME="tinst" LISTVARNAME="parentDefs"/>
        <LOOP LIST="parentDefs">
            <SETVAR NAME="errno" VALUE="0"/>
            <ASSET.LIST TYPE="Variables.parentdeftype" LIST="currentDef" FIELD1="id" VALUE1="parentDefs.assetid"/>
            <IF COND="Variables.errno=0">
            <THEN>
                <ICS.RESOLVEVARIABLES NAME="$(Variables._GROUP_$(currentDef.name))" OUTPUT="currentName" DELIMITED="true"/>
                <IF COND="Variables.errno=0">
                <THEN>
                    <ASSET.LIST TYPE="Variables.grouptype" LIST="currentParent" FIELD1="name" VALUE1="Variables.currentName"/>
                    <IF COND="Variables.errno=0">
                    <THEN>
                        <HASH.ADD NAME="pHash" VALUE="currentParent.id"/>
                    </THEN>
                    </IF>
                </THEN>
                </IF>
            </THEN>
            </IF>
        </LOOP>
        <HASH.TOSTRING NAME="pHash" VARNAME="sMyParentGroups" DELIM=";"/>
    </THEN>
    </IF>
</else>
</if>

	<atm.locate TYPE="Variables.templatetype" VARNAME="ptmgr"/>
<IF COND="Variables.flextype=asset">
<THEN>
	<FLEXTEMPLATES.GETATTRIBUTEINFO NAME="ptmgr" ID="Variables.Variables.prefixs:Variables.defColname" LISTVARNAME="tmplattrlist"/>
</THEN>
<ELSE>
	<FLEXGROUPTEMPLATES.GETATTRIBUTEINFO NAME="ptmgr" ID="Variables.Variables.prefixs:Variables.defColname" LISTVARNAME="tmplattrlist"/>
</ELSE>
</IF>
	<if COND="IsList.tmplattrlist=true">
	<then>     
		<if COND="tmplattrlist.#numRows!=0">
		<then>    
			<loop LIST="tmplattrlist">
				<setvar NAME="cs_currentAttrName" VALUE="tmplattrlist.name"/>
				<SETVAR NAME="currentType" VALUE="tmplattrlist.type"/>
				<IF COND="Variables.currentType=blob">
				<THEN>
					<SETVAR NAME="currentType" VALUE="url"/>
				</THEN>
				</IF>

            <IF COND="Variables.currentType=url">
            <THEN>
               <VECTOR.CREATE NAME="vtmplattrlist.assetid"/>
            </THEN>
            </IF>
                <setvar NAME="errno" VALUE="0"/>
                <ICS.RESOLVEVARIABLES NAME="$(Variables.$(Variables.cs_currentAttrName))" OUTPUT="tempvar" DELIMITED="true"/>
                <if COND="Variables.errno=0">
				<then>		
					<IF COND="tmplattrlist.valuestyle!=S">
					<THEN>
                        <IF COND="Variables.currentType=url">
                        <THEN>
                            <CALLELEMENT NAME="OpenMarket/Gator/FlexibleAssets/Common/GetInputName">
                              <ARGUMENT NAME="cs_AttrName" VALUE="Variables.cs_currentAttrName"/>
                              <ARGUMENT NAME="cs_IsMultiple" VALUE="true"/>
                              <ARGUMENT NAME="cs_ValueNum" VALUE="1"/>
                              <ARGUMENT NAME="cs_IsMultiSelect" VALUE="false"/>
                              <ARGUMENT NAME="cs_Varname" VALUE="cs_CurrentInputName"/>
                            </CALLELEMENT>
                            <SETVAR NAME="Variables.cs_CurrentInputName" VALUE="Variables.tempvar"/>
                            <ICS.RESOLVEVARIABLES NAME="$(Variables.$(Variables.cs_CurrentInputName)_file)" OUTPUT="Variables.cs_CurrentInputName_file" DELIMITED="true"/>
                        </THEN>
                        <ELSE>
							<STRINGLIST STR="Variables.tempvar" NAME="valList" DELIM=";"/>
							<setvar NAME="Variables.cs_currentAttrNameVC" VALUE="valList.#numRows"/>
							<IF COND="tmplattrlist.assettypename=Variables.empty">
							<THEN>
								<LOOP LIST="valList">
                                    <CALLELEMENT NAME="OpenMarket/Gator/FlexibleAssets/Common/GetInputName">
                                      <ARGUMENT NAME="cs_AttrName" VALUE="Variables.cs_currentAttrName"/>
                                      <ARGUMENT NAME="cs_IsMultiple" VALUE="true"/>
                                      <ARGUMENT NAME="cs_ValueNum" VALUE="valList.#curRow"/>
                                      <ARGUMENT NAME="cs_IsMultiSelect" VALUE="false"/>
                                      <ARGUMENT NAME="cs_Varname" VALUE="cs_CurrentInputName"/>
                                    </CALLELEMENT>
									<setvar NAME="Variables.cs_CurrentInputName" VALUE="valList.ITEM"/>
                                    <IF COND="tmplattrlist.valuestyle=O">
                                    <THEN>
                                        <setvar name="cs_Variables.cs_currentAttrName_ordinal_valList.#curRow" VALUE="valList.#curRow"/>
                                    </THEN>
                                    </IF>
								</LOOP>
							</THEN>
							<ELSE>
								<LOOP LIST="valList">
                                    <setvar NAME="errno" VALUE="0"/>
									<ASSET.LIST TYPE="tmplattrlist.assettypename" LIST="assetAttr" FIELD1="name" VALUE1="valList.ITEM"/>
									<IF COND="Variables.errno=0">
									<THEN>
                                        <CALLELEMENT NAME="OpenMarket/Gator/FlexibleAssets/Common/GetInputName">
                                          <ARGUMENT NAME="cs_AttrName" VALUE="Variables.cs_currentAttrName"/>
                                          <ARGUMENT NAME="cs_IsMultiple" VALUE="true"/>
                                          <ARGUMENT NAME="cs_ValueNum" VALUE="valList.#curRow"/>
                                          <ARGUMENT NAME="cs_IsMultiSelect" VALUE="false"/>
                                          <ARGUMENT NAME="cs_Varname" VALUE="cs_CurrentInputName"/>
                                        </CALLELEMENT>
										<setvar NAME="Variables.cs_CurrentInputName" VALUE="assetAttr.id"/>
                                        <IF COND="tmplattrlist.valuestyle=O">
                                        <THEN>
                                            <setvar name="cs_Variables.cs_currentAttrName_ordinal_valList.#curRow" VALUE="valList.#curRow"/>
                                        </THEN>
                                        </IF>
									</THEN>
									<ELSE>
										<STRING.STREAM VALUE="Error: Could not find (tmplattrlist.assettypename) valList.ITEM: Variables.errno"/>
									</ELSE>
									</IF>
								</LOOP>
							</ELSE>
							</IF>
                        </ELSE>
                        </IF>
					</THEN>
					<ELSE>
                        <CALLELEMENT NAME="OpenMarket/Gator/FlexibleAssets/Common/GetInputName">
                          <ARGUMENT NAME="cs_AttrName" VALUE="Variables.cs_currentAttrName"/>
                          <ARGUMENT NAME="cs_IsMultiple" VALUE="false"/>
                          <ARGUMENT NAME="cs_Varname" VALUE="cs_CurrentInputName"/>
                        </CALLELEMENT>
						<IF COND="tmplattrlist.assettypename!=Variables.empty">
						<THEN>
							<setvar NAME="errno" VALUE="0"/>
							<ASSET.LIST TYPE="tmplattrlist.assettypename" LIST="assetAttr" FIELD1="name" VALUE1="Variables.tempvar"/>
							<IF COND="Variables.errno=0">
							<THEN>
								<setvar NAME="Variables.cs_CurrentInputName" VALUE="assetAttr.id"/>
							</THEN>
							<ELSE>
								<STRING.STREAM VALUE="Error: Could not find (tmplattrlist.assettypename) Variables.tempvar: Variables.errno"/>
							</ELSE>
							</IF>
						</THEN>
                        <ELSE>
                            <setvar NAME="Variables.cs_CurrentInputName" VALUE="Variables.tempvar"/>
                        </ELSE>
						</IF>
					</ELSE>
               </IF>
            </then><else> <!-- no value found, maybe a multi valued blob -->
                <IF COND="Variables.currentType=url">
                <THEN>
                    <SETCOUNTER NAME="currentFile" VALUE="1"/>
                    <SETVAR NAME="doneVar" VALUE="no"/>
                    <LOOP UNTIL="Variables.doneVar=yes">
                        <SETVAR NAME="errno" VALUE="0"/>
                        <ICS.RESOLVEVARIABLES NAME="$(Variables.$(Variables.cs_currentAttrName)_$(Counters.currentFile)_file)" OUTPUT="currentVal" DELIMITED="true"/>
                        <IF COND="Variables.errno!=0">
                        <THEN>
                            <SETVAR NAME="doneVar" VALUE="yes"/>
                        </THEN>
                        <ELSE>							                       
                            <TEMPOBJECTS.SET BINVARNAME="Variables.cs_currentAttrName_Counters.currentFile" FILE="Variables.currentVal" VARNAME="tempid"/>
                            <VECTOR.ADD NAME="vtmplattrlist.assetid" VALUE="Variables.tempid"/>
                            <IF COND="tmplattrlist.valuestyle=O">
                            <THEN>
                                <setvar name="cs_Variables.cs_currentAttrName_ordinal_Counters.currentFile" VALUE="Counters.currentFile"/>
                            </THEN>
                            </IF>
                            <INCCOUNTER NAME="currentFile" VALUE="1"/>
                        </ELSE>
                        </IF>
                    </LOOP>
                </THEN>
                </IF>
        </else>
        </if>
        
			</loop>
		</then>
		</if>
	</then>
	</if>
	
	<callelement NAME="OpenMarket/Gator/FlexibleAssets/Common/AssetGather">
		<argument NAME="GetOrSet" VALUE="set"/>
	</callelement>
</ftcs>