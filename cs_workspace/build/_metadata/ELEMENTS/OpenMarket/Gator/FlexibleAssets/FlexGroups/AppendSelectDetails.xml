<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Gator/Populate/ElementCatalog/OpenMarket/Gator/FlexibleAssets/FlexGroups/AppendSelectDetails.xml $ 
$Revision: 24 $ 
$Modtime: 7/12/04 6:19p $ 
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- AppendSelectDetails.xml
-
- DESCRIPTION
-	 The basic idea: start with a minimum, default
-    query. Then append additional criteria depending
-    on fields that have been selected in the search
-    form
-
- HISTORY 
-->

<!-- Set the table name for SQLEXP use -->
<SETVAR NAME="tablename" VALUE="Variables.AssetType"/>

<!-- ---------------------- -->
<!-- Asset table search -->
<!-- ---------------------- -->

<!-- To search for a standard column in the Variables.AssetType table:
  -- 
  -- Every row in the following list corresponds to a search parameter. Each
  -- row has four columns: formname, columnname, guiname, operator.
  --
  -- formname is the name of the input field in SearchForm
  -- columnname is the database columnname in the table named <Variables.AssetType>
  -- guiname is the user-friendly display name
  -- operator is the SQL verb to use in the SQLEXP statement
  --
  -- The list must be named 'srchFlds'
-->

<LISTOBJECT.CREATE NAME="flds" COLUMNS="formname,columnname,guiname,operator"/>

<XLAT.LOOKUP KEY="dvin/AT/Common/ID" VARNAME="guiid"/>
 <LISTOBJECT.ADDROW NAME="flds" formname="Id" columnname="id" guiname="Variables.guiid" operator="="/>

 <XLAT.LOOKUP KEY="dvin/AT/Common/FWUID" VARNAME="guiuid"/>
 <LISTOBJECT.ADDROW NAME="flds" formname="uId" columnname="fw_uid" guiname="Variables.guiuid" operator="="/>

   <XLAT.LOOKUP  KEY="dvin/AT/Common/Name"  VARNAME="guiName"/>

 <LISTOBJECT.ADDROW NAME="flds" formname="Name" columnname="name" guiname="Variables.guiName" operator="LIKE"/>


 <XLAT.LOOKUP KEY="dvin/Common/Description" VARNAME="guiDesc"/>
 <LISTOBJECT.ADDROW NAME="flds" formname="Description" columnname="description" guiname="Variables.guiDesc" operator="LIKE"/>


 <XLAT.LOOKUP KEY="dvin/FlexibleAssets/FlexAssets/ParentDef" VARNAME="guiflextmpl"/>

<LISTOBJECT.ADDROW NAME="flds" formname="flexgrouptemplateid" columnname="flexgrouptemplateid" guiname="Variables.guiflextmpl" operator="="/>
 
<LISTOBJECT.TOLIST NAME="flds" LISTVARNAME="srchFlds"/>

<CALLELEMENT NAME="OpenMarket/Gator/FlexibleAssets/Common/AppendSelectDetailsCommon"/>
<!-- constrain by attributes if necessary -->
<fgtm.getattributetype  ASSETTYPE="Variables.AssetType"  VARNAME="attributetype"/> 

<ATM.LOCATE TYPE="Variables.attributetype" VARNAME="amgr"/>
<COMPLEXASSETS.GETALLASSETS NAME="amgr" SITE="SessionVariables.pubid" LISTVARNAME="attrlst"/>

<SETVAR NAME="ssCreated" VALUE="0"/>

<if COND="IsVariable.SelectedAttrs=true">
<then>
    <setvar NAME="sMyTmplAttributes"  VALUE="true"/>
</then>
</if>
<if COND="IsVariable.AttrValueBasedSch!=true">
<then>
    <IF COND="IsVariable.AttrBasedSch=true">
    <THEN>

    	  <!-- This is Attribute Based Search and Not attr-value based search -->
          <SEARCHSTATE.CREATE NAME="rtss"/> 
      	  <SETVAR NAME="ssCreated" VALUE="1"/>
          <if COND="IsVariable.SelectedAttrs=true">
          <then>
                    
    			<STRINGLIST NAME="alist" STR="Variables.SelectedAttrs" DELIM=","/>
          </then>
          <else>
                <IF COND="IsVariable.sMyTmplAttributes=true">
                <THEN>
     			    <STRINGLIST NAME="alist" STR="Variables.sMyTmplAttributes" DELIM=";"/>
                </THEN>
                </IF>
          </else>
          </if>
    			<if COND="IsList.alist=true">
    			<then>
    			  <if COND="alist.#numRows!=0">
    				<then>
     						<VECTOR.CREATE NAME="vAttrList"/>
    						<loop LIST="alist">
    							<ASSET.LOAD TYPE="Variables.attributetype" NAME="attrinst" OBJECTID="alist.ITEM"/>
    							<COMPLEXASSET.GETNAME NAME="attrinst" VARNAME="attrname"/>
     							<searchstate.addstandardconstraint NAME="rtss"  ATTRIBUTE="Variables.attrname" TYPENAME="Variables.attributetype"/>
                                <VECTOR.ADD NAME="vAttrList" VALUE="Variables.attrname"/>
    						</loop>
                            <VECTOR.TOSTRING NAME="vAttrList" VARNAME="attrList" DELIM="  "/>
                            <XLAT.LOOKUP KEY="dvin/UI/Search/AttributesareattrList" VARNAME="_XLAT_"/>
                            <SETVAR NAME="filterstring" VALUE="Variables.filterstring : Variables._XLAT_"/> 
    				</then>
    				</if>
    			</then>
    			</if>
      </THEN>

       <ELSE>
            <INDEXOF STR="Variables.SelectedAttrs" WHAT="SelectedAttrs" OUTSTR="index" />
            <if cond="Variables.index=-1">
            <then>
                   <if COND="IsList.attrlst=true"><then>
                    <if COND="attrlst.#numRows!=0"><then>
                        <SEARCHSTATE.CREATE NAME="rtss"/>
                        <loop LIST="attrlst">
                            <if COND="IsVariable.attrlst.assetid=true"><then>
                                <!-- load attribute and see if it is full-text indexed -->
                                <ASSET.LOAD TYPE="Variables.attributetype" NAME="attrinst" OBJECTID="attrlst.assetid"/>
                                <ATTRIBUTE.GETENGINE NAME="attrinst" VARNAME="searchengine"/>
                                <ATTRIBUTE.GETASSETTYPE NAME="attrinst" VARNAME="attrassettype"/>
                                <COMPLEXASSET.GETNAME NAME="attrinst" VARNAME="attrname"/>
                                <SETVAR NAME="ssCreated" VALUE="1"/>
                                <SETVAR NAME="attrval" VALUE="Variables.attrlst.assetid"/>

                                <if COND="Variables.attrassettype!=Variables.empty"><then>
                                    <ASSET.LIST TYPE="Variables.attrassettype" FIELD1="id" VALUE1="Variables.attrval" LIST="AssetFields"/>
                                    <setvar NAME="displayName" VALUE="AssetFields.name"/>
                                </then><else>
                                    <setvar NAME="displayName" VALUE="Variables.attrval"/>
                                </else></if>

                                <if COND="Variables.searchengine!=Variables.empty"><then>
                                    <XLAT.LOOKUP KEY="dvin/UI/Search/attrnamecontainsdisplayname" VARNAME="_XLAT_"/>
                                    <SETVAR NAME="filterstring" VALUE="Variables.filterstring : Variables._XLAT_"/>
                                    <searchstate.addrichtextconstraint NAME="rtss"  ATTRIBUTE="Variables.attrname" TYPENAME="Variables.attributetype" VALUE="Variables.attrval" CONFIDENCE="0"/>
                                </then><else>
                                    <XLAT.LOOKUP KEY="dvin/UI/Search/attrnameisdisplayname" VARNAME="_XLAT_"/>
                                    <SETVAR NAME="filterstring" VALUE="Variables.filterstring : Variables._XLAT_"/>
                                    <searchstate.addsimplestandardconstraint NAME="rtss"  ATTRIBUTE="Variables.attrname" TYPENAME="Variables.attributetype" VALUE="Variables.attrval"/>
                                </else></if>
                            </then></if>
                        </loop>
                    </then></if>
                </then></if>
          </then>
          </if>
       </ELSE>
     
      </IF>
</then>
<else>
		<if COND="IsList.attrlst=true"><then>
			<if COND="attrlst.#numRows!=0"><then>
				<SEARCHSTATE.CREATE NAME="rtss"/>    
				<loop LIST="attrlst">
		
					<if COND="IsVariable.attrlst.assetid=true"><then>
				
						<!-- load attribute and see if it is full-text indexed -->
						<ASSET.LOAD TYPE="Variables.attributetype" NAME="attrinst" OBJECTID="attrlst.assetid"/>
						<ATTRIBUTE.GETENGINE NAME="attrinst" VARNAME="searchengine"/>
						<ATTRIBUTE.GETASSETTYPE NAME="attrinst" VARNAME="attrassettype"/>
						<COMPLEXASSET.GETNAME NAME="attrinst" VARNAME="attrname"/>
						<SETVAR NAME="ssCreated" VALUE="1"/>
						<SETVAR NAME="attrval" VALUE="Variables.attrlst.assetid"/>
			
						<if COND="Variables.attrassettype!=Variables.empty"><then>
							<ASSET.LIST TYPE="Variables.attrassettype" FIELD1="id" VALUE1="Variables.attrval" LIST="AssetFields"/>
							<setvar NAME="displayName" VALUE="AssetFields.name"/>
						</then><else>
							<setvar NAME="displayName" VALUE="Variables.attrval"/>
						</else></if>
						
						<if COND="Variables.searchengine!=Variables.empty"><then>
							<XLAT.LOOKUP KEY="dvin/UI/Search/attrnamecontainsdisplayname" VARNAME="_XLAT_"/>
                            <SETVAR NAME="filterstring" VALUE="Variables.filterstring : Variables._XLAT_"/>
							<searchstate.addrichtextconstraint NAME="rtss"  ATTRIBUTE="Variables.attrname" TYPENAME="Variables.attributetype" VALUE="Variables.attrval" CONFIDENCE="0"/>
						</then><else>
							<XLAT.LOOKUP KEY="dvin/UI/Search/attrnameisdisplayname" VARNAME="_XLAT_"/>
                            <SETVAR NAME="filterstring" VALUE="Variables.filterstring : Variables._XLAT_"/>
							<searchstate.addsimplestandardconstraint NAME="rtss"  ATTRIBUTE="Variables.attrname" TYPENAME="Variables.attributetype" VALUE="Variables.attrval"/>
						</else></if>
					</then></if>
				</loop>
			</then></if>
		</then></if>
</else>
</if>

<!-- only generate an assetlist if a searchstate has been created -->
<IF COND="Variables.ssCreated=1"><THEN>
	<ASSETSET.SETSEARCHEDASSETS NAME="as" ASSETTYPES="Variables.AssetType" SITE="SessionVariables.pubid" CONSTRAINT="rtss"/>
	<ASSETSET.GETASSETLIST NAME="as" LISTVARNAME="asrtlist"/>

	<IF COND="asrtlist.#numRows=0"><THEN>
		<!-- no matches exist, apply a permanently false condition to query -->
		<SETVAR NAME="queryend" VALUE="Variables.queryend AND 1 = 0"/>
	</THEN><ELSE>
		<!-- matches exist, apply to query -->
		<textformat.tostring MAXCOUNT="2000" ELLIPSIS="FALSE" LIST="asrtlist" FIELD="assetid" VARNAME="limitlst"/>
        <IF COND="IsVariable.limitlst=true">
        <THEN>
 		    <SETVAR NAME="queryend" VALUE="Variables.queryend AND Variables.AssetType.id IN (Variables.limitlst)"/>
        </THEN>
        </IF>
	</ELSE></IF>
</THEN></IF>

<!-- <CSVAR NAME="Variables.queryend"/> -->

</FTCS>
