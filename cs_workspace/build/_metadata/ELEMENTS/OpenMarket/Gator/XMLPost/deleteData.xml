<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateC/install/Gator/Populate/ElementCatalog/OpenMarket/Gator/XMLPost/deleteData.xml $ 
$Revision: 23 $ 
$Modtime: 4/28/04 3:37p $ 
-->

<!--
- Confidential and Proprietary Information of Open Market Inc.
-					All Rights Reserved.
-
- deleteData.xml
-
- DESCRIPTION
-    This element handles the posting of content by
-    a remote client (XMLPost, or other)
-
-    Required: None
-->

<CALLELEMENT NAME="OpenMarket/Xcelerate/Util/SetLocale"/>
	
<USERMANAGER.GETLOGINUSER VARNAME="usrname"/>
<IF COND="IsVariable.usrname=true">
<THEN>
	<SETVAR NAME="loggedIn" VALUE="true"/>
</THEN>
<ELSE>
	<USERMANAGER.LOGINUSER USERNAMEVARIABLE="authusername" PASSWORDVARIABLE="authpassword" VARNAME="loggedIn"/>
	<if COND="Variables.loggedIn=false">
	<then>
		<XLAT.STREAM KEY="dvin/UI/Error/LoginfailedremotepostCheckauthusernamepassword"/>
		<throwexception/>
	</then>
	</if>
</ELSE>
</IF>

<if COND="IsVariable.xmlpostdebug=true">
	<then>
	<XLAT.STREAM KEY="dvin/Error/AT/Flex/xmlpostdebugstatus" status="ON" EVALALL="false"/>
	</then>
	<else>
	<XLAT.STREAM KEY="dvin/Error/AT/Flex/xmlpostdebugstatus" status="OFF" EVALALL="false"/>
	</else>
</if>
<!-- Check for a valid publication -->
<if COND="IsVariable.primarypubid=false">
<then>
	<if COND="IsVariable.publication=true">
	<then>
		<PUBLICATION.LOAD NAME="publication" FIELD="name" VALUE="Variables.publication"/>
		<PUBLICATION.GET NAME="publication" FIELD="id" OUTPUT="primarypubid"/>
	</then>
	<else>
		<!-- neither primarypubid nor publication provided -->
		<PUBLICATION.LIST LIST="publist"/>
		<if COND="publist.#numRows=1">
		<then>
			<SETVAR NAME="primarypubid" VALUE="publist.id"/>
		</then>
		</if>
	</else>
	</if>
</then>
<else>
	<PUBLICATION.LOAD NAME="publication" OBJECTID="Variables.primarypubid"/>
	<if COND="IsError.Variables.errno=true">
	<then>
		<if COND="IsVariable.xmlpostdebug=true">
		<then>
		<XLAT.STREAM KEY="dvin/UI/Error/ErrorInvalidprimarypubid"/>
		</then>
		</if>
		
		<throwexception/>
	</then>
	</if>
</else>
</if>

<if COND="IsVariable.primarypubid=false">
<then>
	<if COND="IsVariable.xmlpostdebug=true">
	<then>
	<XLAT.STREAM KEY="dvin/UI/Error/Missingorinvalidpublicationvariable"/>
	</then>
	</if>
	
	<throwexception/>
</then>
</if>

<IF COND="IsVariable._ASSET_!=true">
<THEN>
   <if COND="IsVariable.xmlpostdebug=true">
   <then>
  <XLAT.STREAM KEY="dvin/Error/AT/Flex/Fatalerror_ASSET_notset"/>
   </then>
   </if>
   
   <THROWEXCEPTION/>        
</THEN>
</IF>

<IF COND="IsVariable._ITEMNAME_!=true">
<THEN>
   <if COND="IsVariable.xmlpostdebug=true">
   <then>
  <XLAT.STREAM KEY="dvin/Error/AT/Flex/Fatalerror_ITEMNAME_notset"/>
   </then>
   </if>
   
   <THROWEXCEPTION/>        
</THEN>
</IF>


<IF COND="IsVariable._ID_=true">
	<THEN>
		<SETVAR NAME="myID" VALUE="Variables._ID_"/>
	</THEN>
	<ELSE>
		<!-- Find correct assetid based on name and publication -->
		<callelement NAME="OpenMarket/Gator/XMLPost/GetAssetID">
			<argument NAME="theType" VALUE="Variables._ASSET_"/>
			<argument NAME="thePub" VALUE="Variables.primarypubid"/>
			<argument NAME="theName" VALUE="Variables._ITEMNAME_"/>
		</callelement>
	</ELSE>
</IF>


<IF COND="Variables.myID!=Variables.empty">
<THEN>
	<!-- Load the asset -->
	<setvar NAME="errno" VALUE="0"/>
	<ASSET.LOAD NAME="ainst" TYPE="Variables._ASSET_" FIELD="id" VALUE="Variables.myID"/>
	<IF COND="Variables.errno!=0">
	<THEN>
		<if COND="IsVariable.xmlpostdebug=true">
		<then>
		<XLAT.STREAM KEY="dvin/Error/AT/Flex/AssetLoadFailed" assettype="my assettype" name="my assetname" errno="Variables.errno" errdetail="Variables.errdetail" EVALALL="false"/>
		</then>
		</if>
		
		<THROWEXCEPTION/>
	</THEN>
	</IF>
     
	 
	<!-- Check asset references PR 14113 -->
	<ASSET.REFERENCEDBY NAME="ainst" LIST="refererList"/>
    <IF COND="IsList.refererList=true">
		<THEN>
               <IF COND="refererList.#numRows!=0">
               <THEN>
				   <SETVAR NAME="atDescription" VALUE="Variables._ITEMNAME_"/>
				   <XLAT.STREAM KEY="dvin/UI/AssetTypeassetsreferencesInstruction"/> 
				   
				   <LOOP LIST="refererList">
						<ASSET.LOAD NAME="referer" TYPE="refererList.otype" OBJECTID="refererList.oid"/>
						<ASSET.GETASSETTYPE NAME="referer" OUTNAME="at"/>
						<ASSETTYPE.GET NAME="at" FIELD="description" OUTPUT="myAssetType"/>
						<ASSET.GET NAME="referer" FIELD="name" OUTPUT="myName"/>
						<ASSET.GET NAME="referer" FIELD="description" OUTPUT="myDescription"/>
						
						<XLAT.STREAM KEY="dvin/UI/Error/AssetTypeassetsreferencesXmlpost"/> 
				   </LOOP>
				   
				   <THROWEXCEPTION/>
               </THEN>
               </IF>
		</THEN>
   </IF>
   
	<!-- If a publish is in progress that involves this asset we cannot proceed. PR 14115 -->
	<ASSET.CANEDIT NAME="ainst"/>
	<IF COND="Variables.errno=-12034">
	<THEN>
		<XLAT.STREAM KEY="fatwire/Alloy/Authorization/EditNotAllowed1"/>
		<THROWEXCEPTION/>
	</THEN>
	</IF>
	   
	 
    <!-- Code added for revision tracking  -->

    <!-- check to see if the table is tracked if so, then the current record must be locked by the current user -->
    <callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
        <argument NAME="AssetType" VALUE="Variables._ASSET_"/>
    </callelement>

        <!-- Check if the item is checked out. If not, check it out -->
    <SETVAR NAME="doproceed"  VALUE="true"/>
    <if COND="Variables.trackingenabled=true">
        <then>
            <history TABLE="Variables.AssetType" ASSET="Variables.myID" LIST="ItsHistory"/>
            <callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/LockIfNeeded">
                <argument NAME="AssetType" VALUE="Variables.AssetType"/>
                <argument NAME="id" VALUE="Variables.myID"/>
                <argument NAME="checkedoutby" VALUE="Delete"/>
            </callelement>

            <!-- If the asset is locked by another user, LockIfNeeded will set doProceed -->
            <LOGMSG  STR="doproceed: Variables.doproceed"/>
            <if COND="Variables.doproceed!=true">
                <then>
                    <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
                    <argument NAME="error" VALUE="Variables.doproceed"/>
                    </callelement>
                     <THROWEXCEPTION/>
                </then>
            </if>
            <if COND="Variables.locked=true">
                        <then>

                        <!-- Add an entry in CheckOutInfo table about this implicit check out -->
                        <if COND="Variables.checkoutmethod=implicit">
                        <then>
				<usermanager.getloginuser VARNAME="thisUser"/>
				<implicitcheckout.logimplicitcheckout ASSETTYPE="Variables.AssetType"
					ASSETID="Variables.myID"
					FUNCTION="Delete"
					USER="Variables.thisUser"/>

                                <!-- CATALOGMANAGER>
                                <ARGUMENT NAME="checkout" VALUE="CS.UniqueID"/>
                                <ARGUMENT NAME="tablename" VALUE="CheckOutInfo"/>
                                <ARGUMENT NAME="assetid" VALUE="Variables.myID"/>
                                <ARGUMENT NAME="assettype" VALUE="Variables.AssetType"/>
                                <ARGUMENT NAME="functionid" VALUE="Delete"/>
                                <ARGUMENT NAME="checkoutdate" VALUE="CS.SQLDate"/>
                                <ARGUMENT NAME="username" VALUE="Variables.authusername"/>
                                <ARGUMENT NAME="ftcmd" VALUE="addrow"/>
                            </CATALOGMANAGER -->
                            </then>
                        </if>
                </then>
                </if>
        </then>
    </if>
    <!--    Original code that checked if the asset is tracked 
 	<IF COND="IsTracked.Variables._ASSET_=true">
	<THEN>
		<SETVAR NAME="errno" VALUE="0"/>
		<ASSET.CHECKOUT OBJECTTYPE="Variables._ASSET_" OBJECTID="Variables.myID"/>
		<IF COND="Variables.errno!=0">
		<THEN>
			<if COND="IsVariable.xmlpostdebug=true">
			<then>
			<XLAT.STREAM KEY="dvin/Error/AT/Flex/AssetAlreadyCheckedOut" errno="Variables.errno" errdetail1="Variables.errdetail1" EVALALL="false"/>
			</then>
			</if>
			
			<THROWEXCEPTION/>
		</THEN>
		</IF>
	</THEN>
	</IF>
     --> 
	<WorkflowAsset.Load ASSETTYPE="Variables._ASSET_" ID="Variables.myID" OBJVARNAME="workflowasset" />
	<WorkflowEngine.IsObjectAssigned OBJECT="workflowasset" VARNAME="isAssigned"/>
	<if COND="Variables.isAssigned=true">
	<then>
		 <WorkflowEngine.CloseAssignments OBJECT="workflowasset" SITE="Variables.primarypubid" />
		 <if COND="Variables.errno!=0">
		 <then>
			 <if COND="IsVariable.xmlpostdebug=true">
			 <then>
			 <XLAT.STREAM KEY="dvin/Error/AT/Flex/FailedRemoveFromWorkflow" errno="Variables.errno" errdetail1="Variables.errdetail1" EVALALL="false"/>
			 </then>
			 </if>
			 
		 </then>
		 </if>
	  </then>
	</if>
    <!-- decide whether to unlock record.
   If the item was already locked, then no unlock is
   needed. Else unlock it -->

   
    <setvar NAME="errno" VALUE="0"/>
	<ASSET.VOID NAME="ainst"/>
	<IF COND="IsError.Variables.errno=false">
	<THEN>
		<XLAT.STREAM KEY="dvin/AT/Common/AssetVoidSuccess" name="Variables._ITEMNAME_" EVALALL="false"/>
		
	</THEN>
	<ELSE>
		<XLAT.STREAM KEY="dvin/Error/AT/Flex/AssetVoidFailed" asset="Variables._ASSET_" name="Variables._ITEMNAME_" errno="Variables.errno" errdetail="Variables.errdetail1" EVALALL="false"/>
		<THROWEXCEPTION/>
	</ELSE>
	</IF>
   
<!-- Remove entry from CheckOutInfo table about implicit checkout. Assume only one entry in the table -->

	<IMPLICITCHECKOUT.CLEARCHECKOUT ASSETTYPE="Variables.AssetType" ASSETID="Variables.myID"/>

   <!-- SETVAR NAME="errno" VALUE="0"/>
   <SETVAR NAME="assetid" VALUE="Variables.myID"/>
   <SETVAR NAME="username" VALUE="Variables.authusername"/>
   <SELECTTO LIST="COI" FROM="CheckOutInfo" WHAT="checkout" WHERE="assetid,username"/>
   <IF COND="Variables.errno=0">
       <THEN>
           <CATALOGMANAGER SCOPED="STACKED">
               <ARGUMENT NAME="tablename" VALUE="CheckOutInfo"/>
               <ARGUMENT NAME="checkout" VALUE="COI.checkout"/>
               <ARGUMENT NAME="ftcmd" VALUE="deleterow"/>
           </CATALOGMANAGER>
       </THEN>
   </IF -->



</THEN>
<ELSE>
	<if COND="IsVariable.xmlpostdebug=true">
	<then>
	<XLAT.STREAM KEY="dvin/Error/AT/Flex/AssetNotInPub" asset="Variables._ASSET_" name="Variables._ITEMNAME_" pub="Variables.publication" errno="Variables.errno" errdetail1="Variables.errdetail1" EVALALL="false"/>
	</then>
	</if>
	
	<THROWEXCEPTION/>
</ELSE>
</IF>

</FTCS>
