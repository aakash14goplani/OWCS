<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateC/install/Gator/Populate/ElementCatalog/OpenMarket/Gator/XMLPost/GetTemplateParents.xml $ 
$Revision: 27 $ 
$Modtime: 4/05/04 1:01p $ 
-->

<!--
- Confidential and Proprietary Information of Open Market Inc.
-					All Rights Reserved.
-
- RemoteContentPost.xml
-
- DESCRIPTION
-    This element handles the posting of content by
-    a remote client (XMLPost, or other)
-
-    Required: None
-->

<!-- Recursively find the templates parents -->
<!-- global scope.  use counters for scoping. -->
<LOOP LIST="Counters.childparents">
   
   <!-- Find parents of this template -->
	<SETVAR NAME="errno" VALUE="0"/>
    <ICS.RESOLVEVARIABLES NAME="$(Variables.$(Counters.child)tmplid)" OUTPUT="parentTmpl" DELIMITED="true"/>
	<ICS.RESOLVEVARIABLES NAME="$($(Counters.child)parents.assetid)" OUTPUT="currentTmpl" DELIMITED="true"/>
	<IF COND="Variables.currentTmpl!=Variables.parentTmpl">
	<THEN>
		<ASSET.LOAD NAME="Counters.leveltinst" TYPE="Variables.GroupTemplateType" EDITABLE="true" FIELD="id" VALUE="Variables.currentTmpl"/>
		<IF COND="Variables.errno!=0">
		<THEN>
			<STRING.STREAM VALUE="ASSET.LOAD of Variables.GroupTemplateType: Variables.currentTmpl failed.  "/>
			<STRING.STREAM VALUE="Error: Variables.errno: Variables.errdetail1"/>
			<THROWEXCEPTION/>
		</THEN>
		</IF>
		<COMPLEXASSET.GETNAME NAME="Counters.leveltinst" VARNAME="Counters.leveltmplname"/>
		<COMPLEXASSET.GETID NAME="Counters.leveltinst" VARNAME="Counters.leveltmplid"/>
		<FLEXGROUPTEMPLATE.GETALLPARENTS NAME="Counters.leveltinst" LISTVARNAME="Counters.levelparents"/>
		
		<IF COND="Counters.child=0">
		<THEN>
		   <HASH.CREATE NAME="hParentDefForRemovedAsset"/>
		</THEN>
	     </IF>

		<HASH.ADD NAME="hParentDefForRemovedAsset" VALUE="Variables.currentTmpl"/>

		<INCCOUNTER NAME="level" VALUE="1"/>
		<INCCOUNTER NAME="grandchild" VALUE="1"/>
		<INCCOUNTER NAME="child" VALUE="1"/>
		<IF COND="Variables.immediateParentsOnly!=true">
		<THEN>
			<CALLELEMENT NAME="OpenMarket/Gator/XMLPost/GetTemplateParents"/>
		</THEN>
		</IF>
		
		<!-- Finally, determine if instance is correctly loaded -->
		<SETVAR NAME="errno" VALUE="0"/>
		<ICS.RESOLVEVARIABLES NAME="$(Variables.$(Counters.child)tmplname)" OUTPUT="stringtest" DELIMITED="true"/>
		<IF COND="Variables.errno=0">
		<THEN>
			<ICS.RESOLVEVARIABLES NAME="$(Variables._GROUP_$(Variables.stringtest))" OUTPUT="currentGroupName" DELIMITED="true"/>
			<IF COND="Variables.errno=0">
			<THEN>
				<!-- check for multiple parents -->
				<!-- if level is 1 then asset is a producttemplate -->
				<ICS.RESOLVEVARIABLES NAME="$(Variables.$(Counters.child)tmplid)" OUTPUT="currentDefID" DELIMITED="true"/>
				<IF COND="Counters.child=1">
				<THEN>
					<FLEXTEMPLATE.CHECKMULTIPLEPARENT NAME="tmplinst" ID="Variables.currentDefID" VARNAME="multiple"/>
				</THEN>
				<ELSE>
					<FLEXGROUPTEMPLATE.CHECKMULTIPLEPARENT NAME="Counters.grandchildtinst" ID="Variables.currentDefID" VARNAME="multiple"/>
				</ELSE>
				</IF>
				<IF COND="Variables.multiple=true">
				<THEN>
					<!-- parse semicolon delimited list of groups -->
					<STRINGLIST NAME="linst" STR="Variables.currentGroupName" DELIM=";"/>
					<LISTOBJECT.CREATE NAME="valinst" COLUMNS="ITEM"/>
					<LOOP LIST="linst">
						<LISTOBJECT.ADDROW NAME="valinst" ITEM="linst.ITEM"/>
					</LOOP>
					<LISTOBJECT.TOLIST NAME="valinst" LISTVARNAME="grouplist"/>
				</THEN>
				<ELSE>
					<STRINGLIST NAME="searchdelimList" STR="Variables.currentGroupName" DELIM=";"/>
					<!-- The parent child relationship is single, hence we shouldn't expect ; in the parent asset name specified in the source file -->
					<IF COND="searchdelimList.#numRows=1">
					<THEN>
						<LISTOBJECT.CREATE NAME="valinst" COLUMNS="ITEM"/>
						<LISTOBJECT.ADDROW NAME="valinst" ITEM="Variables.currentGroupName"/>
						<LISTOBJECT.TOLIST NAME="valinst" LISTVARNAME="grouplist"/>
					</THEN>
					</IF>
				</ELSE>
				</IF>
				
				<!-- This list is not populated when the flexparentgroup is single valued and multivalued parent values are specified in the xmlpost source file -->
				<IF COND="IsList.grouplist=true">
				<THEN>
					<!-- need to create group if possible.  get required attrs (have parents already) -->
					<LOOP LIST="grouplist">
						<!-- Find correct assetid based on name and publication -->
						<!-- added theFlexGroupTempId so that if there are 2 parent with name it works correctly -->
						<callelement NAME="OpenMarket/Gator/XMLPost/GetAssetID">
							<argument NAME="theType" VALUE="Variables.GroupType"/>
							<argument NAME="thePub" VALUE="Variables.primarypubid"/>
							<argument NAME="theName" VALUE="grouplist.ITEM"/>
							<argument NAME="theFlexGroupTempId" VALUE="Variables.currentDefID"/>
						</callelement>

						<IF COND="Variables.myID!=Variables.empty">
						<THEN>
							<setvar NAME="grpid" VALUE="Variables.myID"/>
							<ASSET.LOAD NAME="pginst" TYPE="Variables.GroupType" EDITABLE="true" FIELD="id" VALUE="Variables.grpid"/>
						</THEN>
						<ELSE>
							<setvar NAME="errno" VALUE="-101"/>
						</ELSE>
						</IF>

						<IF COND="Variables.errno!=0">
						<THEN>
							<FLEXGROUPTEMPLATES.GETATTRIBUTES NAME="fgtmgr" ID="Variables.currentDefID" LISTVARNAME="Counters.childattrlist"/>
							<ASSET.CREATE NAME="pginst" TYPE="Variables.GroupType"/>
							<TEXTFORMAT.LENGTH VALUE="grouplist.ITEM" VARNAME="length"/>
							<PROPERTY.GET PARAM="xcelerate.asset.sizeofnamefield" INIFILE="futuretense_xcel.ini" VARNAME="sizeofnamefield"/>
							<CALCULATOR.GO VALUE="Variables.length Variables.sizeofnamefield GT" VARNAME="toolong"/>
							<IF COND="Variables.toolong=1">
							<THEN>
								Fatal error: Group name <STRING.STREAM VALUE="grouplist.ITEM is Variables.length characters."/>
								The maximum length of a group name is <STRING.STREAM VALUE="Variables.sizeofnamefield"/> characters.
								<setvar NAME="PostDataIsOk" VALUE="no"/>
								<THROWEXCEPTION/>
							</THEN>
							</IF>
							<COMPLEXASSET.SETNAME NAME="pginst" VALUE="grouplist.ITEM"/>
							<FLEXGROUP.SETTEMPLATE NAME="pginst" ID="Variables.currentDefID"/>

							<ICS.RESOLVEVARIABLES NAME="$($(Counters.child)attrlist.#numRows)" OUTPUT="currentRows" DELIMITED="true"/>
							<IF COND="Variables.currentRows!=0">
							<THEN>
								<CALLELEMENT NAME="OpenMarket/Gator/XMLPost/SetAttributes">
									<ARGUMENT NAME="attrlist" VALUE="Counters.childattrlist"/>
									<ARGUMENT NAME="assettype" VALUE="Variables.GroupType"/>
									<ARGUMENT NAME="assetname" VALUE="grouplist.ITEM"/>
								</CALLELEMENT>
							</THEN>
							</IF>

							<!-- If parent template has group, addparent -->
							<IF COND="Variables.immediateParentsOnly!=true">
							<THEN>
								<SETVAR NAME="errno" VALUE="0"/>
								<ICS.RESOLVEVARIABLES NAME="$($(Counters.child)parents.#numRows)" OUTPUT="parentCount" DELIMITED="true"/>
								<IF COND="Variables.parentCount!=0">
								<THEN>
									<SETVAR NAME="errno" VALUE="0"/>
									<ICS.RESOLVEVARIABLES NAME="$(Variables.$(Counters.level)groupid)" OUTPUT="currentParentID" DELIMITED="true"/>
									<IF COND="Variables.errno=0">
									<THEN>
									<FLEXGROUP.ADDPARENT NAME="pginst" ID="Variables.currentParentID"/>
									</THEN>
									<ELSE>
										<REMOVEVAR NAME="currentParentID"/>
									</ELSE>
									</IF>
								</THEN>
								<ELSE>
									<ICS.RESOLVEVARIABLES NAME="$(Variables.$(Counters.level)tmplidid)" OUTPUT="currentParentDefID" DELIMITED="true"/>
									<FLEXGROUPTEMPLATE.CHECKREQUIREDPARENT NAME="Counters.childtinst" ID="Variables.currentParentDefID" VARNAME="required"/>
									<IF COND="Variables.required=true">
									<THEN>
										<STRING.STREAM VALUE="Required parent: Variables.currentParentDefID not specified."/>
										<setvar NAME="PostDataIsOk" VALUE="no"/>
										<THROWEXCEPTION/>
									</THEN>
									</IF>
								</ELSE>
								</IF>
							</THEN>
							</IF>

							<!-- if all required attrs exist, save group -->
							<IF COND="Variables.PostDataIsOk=yes">
							<THEN>
								<ASSET.SET NAME="pginst" FIELD="status" VALUE="RF"/>

								<setvar NAME="currentDescription" VALUE="Variables.empty"/>
								<IF COND="IsVariable._GROUPDESCRIPTIONS_=true">
								<THEN>
									<STRINGLIST NAME="nameval" STR="Variables._GROUPDESCRIPTIONS_" DELIM=":"/>
									<LOOP LIST="nameval">
										<STRINGLIST NAME="split" STR="nameval.ITEM" DELIM="="/>
										<CSVAR NAME="equals delimiter list has split.#numRows rows."/>
										<IF COND="split.#numRows!=1">
										<THEN>
											<LOOP LIST="split">
												<IF COND="split.ITEM=grouplist.ITEM">
												<THEN>
													<SETROW LIST="split" ACTION="NEXT"/>
													<setvar NAME="currentDescription" VALUE="split.ITEM"/>
												</THEN>
												</IF>
											</LOOP>
										</THEN>
										</IF>
									</LOOP>

									<ASSET.SET NAME="pginst" FIELD="description" VALUE="Variables.currentDescription"/>
								</THEN>
								</IF>

								<ASSET.SAVE NAME="pginst"/>

								<IF COND="Variables.errno=0">
								<THEN>
									<COMPLEXASSET.GETID NAME="pginst" VARNAME="Counters.childgroupid"/>
									<ICS.RESOLVEVARIABLES NAME="$(Variables.$(Counters.child)groupid)" OUTPUT="currentParentID" DELIMITED="true"/>
							Asset save success: <STRING.STREAM VALUE=" Variables.currentParentID"/>
									<!-- if level is 1 then need to add to list of immediate parents -->
									<IF COND="Counters.child=1">
									<THEN>
										<LISTOBJECT.ADDROW NAME="immediateParents" groupid="Variables.currentParentID"/>
									</THEN>
									</IF>
								</THEN>
								<ELSE>
									Asset save error: <STRING.STREAM VALUE=" grouplist.ITEM: Variables.errno, Variables.errdetail1"/>
									<setvar NAME="PostDataIsOk" VALUE="no"/>
									<THROWEXCEPTION/>
								</ELSE>
								</IF>
							</THEN>
							</IF> <!-- PostDataIsOk -->
						</THEN>
						<ELSE>
							<!-- good load -->
							<COMPLEXASSET.GETID NAME="pginst" VARNAME="Counters.childgroupid"/>
							<IF COND="IsVariable.modify=true">
							<THEN>
								<setvar NAME="NeedToSave" VALUE="no"/>
								<ICS.RESOLVEVARIABLES NAME="$(Variables.$(Counters.child)tmplid)" OUTPUT="currentDefID" DELIMITED="true"/>
								<FLEXGROUPTEMPLATES.GETATTRIBUTES NAME="fgtmgr" ID="Variables.currentDefID" LISTVARNAME="Counters.childattrlist"/>
								<ICS.RESOLVEVARIABLES NAME="$($(Counters.child)attrlist.#numRows)" OUTPUT="attrCount" DELIMITED="true"/>
								<IF COND="Variables.attrCount!=0">
								<THEN>
									<CALLELEMENT NAME="OpenMarket/Gator/XMLPost/ModifyAttributes">
										<ARGUMENT NAME="attrlist" VALUE="Counters.childattrlist"/>
										<ARGUMENT NAME="assettype" VALUE="Variables.GroupType"/>
										<ARGUMENT NAME="assetname" VALUE="grouplist.ITEM"/>
									</CALLELEMENT>

									<!-- if all required attrs exist, save group -->
									<IF COND="Variables.PostDataIsOk=yes">
									<THEN>
										<setvar NAME="NeedToSave" VALUE="yes"/>
									</THEN>
									</IF> <!-- PostDataIsOk -->
								</THEN>
								</IF>
								<IF COND="Variables.removeParent!=Variables.empty">
								<THEN>
									<COMPLEXASSET.GETNAME NAME="pginst" VARNAME="curName"/>
									<STRINGLIST STR="Variables.removeParent" NAME="lParentsToRemove" DELIM=";"/>
									
									<LOOP LIST="lParentsToRemove">
										Remove parent <STRING.STREAM VALUE="Variables.removeParent from Variables.curName"/>...
										<FLEXGROUP.REMOVEPARENT NAME="pginst" ID="lParentsToRemove.ITEM"/>
									</LOOP>
									<setvar NAME="removeParent" VALUE="Variables.empty"/>
									<setvar NAME="NeedToSave" VALUE="yes"/>
								</THEN>
								</IF>
								<IF COND="Variables.addParent!=Variables.empty">
								<THEN>
									<COMPLEXASSET.GETNAME NAME="pginst" VARNAME="curName"/>
									Add parent <STRING.STREAM VALUE="Variables.addParent to Variables.curName"/>...
									<!-- check for self -->
									<setvar NAME="canWeAdd" VALUE="true"/>
									<IF COND="Variables.addParent=Variables.grpid">
									<THEN>
										<setvar NAME="canWeAdd" VALUE="false"/>
									</THEN>
									</IF>
									<SETVAR NAME="errno" VALUE="0"/>
									<ICS.RESOLVEVARIABLES NAME="$(Variables.$(Counters.level)groupid)" OUTPUT="cparentID" DELIMITED="true"/>
									<IF COND="Variables.errno!=0">
									<THEN>
									<SETVAR NAME="errno" VALUE="0"/>
									<setvar NAME="canWeAdd" VALUE="false"/>
									</THEN>
									</IF>
									<IF COND="Variables.cparentID=Variables.grpid">
									<THEN>
										<setvar NAME="canWeAdd" VALUE="false"/>
									</THEN>
									</IF>
									<IF COND="Variables.canWeAdd=true">
									<THEN>
									<FLEXGROUP.ADDPARENT NAME="pginst" ID="Variables.addParent"/>
									</THEN>
									</IF>
									<setvar NAME="addParent" VALUE="Variables.empty"/>
									<setvar NAME="NeedToSave" VALUE="yes"/>
								</THEN>
								</IF>
								<IF COND="Variables.NeedToSave=yes">
								<THEN>
									<ASSET.SET NAME="pginst" FIELD="status" VALUE="ED"/>
									<ASSET.SAVE NAME="pginst"/>

									<IF COND="Variables.errno=0">
									<THEN>
										<COMPLEXASSET.GETID NAME="pginst" VARNAME="Counters.childgroupid"/>
										Asset save success: <STRING.STREAM VALUE=" Variables.Counters.childgroupid"/>
										<!-- if level is 1 then need to add to list of immediate parents -->
									</THEN>
									<ELSE>
										Asset save error: <STRING.STREAM VALUE=" grouplist.ITEM: Variables.errno, Variables.errdetail1"/>
										<setvar NAME="PostDataIsOk" VALUE="no"/>
										<THROWEXCEPTION/>
									</ELSE>
									</IF>
								</THEN>
								</IF>
							</THEN>
							</IF>
							<ICS.RESOLVEVARIABLES NAME="$(Variables.$(Counters.child)tmplid)" OUTPUT="currentDefID" DELIMITED="true"/>
							<FLEXGROUPTEMPLATES.GETATTRIBUTES NAME="fgtmgr" ID="Variables.currentDefID" LISTVARNAME="Counters.childattrlist"/>
							<IF COND="Counters.child=1">
							<THEN>
								<ICS.RESOLVEVARIABLES NAME="$(Variables.$(Counters.child)groupid)" OUTPUT="currentParentID" DELIMITED="true"/>
								<LISTOBJECT.ADDROW NAME="immediateParents" groupid="Variables.currentParentID"/>
							</THEN>
							</IF>
						</ELSE>
						</IF>	<!-- errno!=0 on load-->
						<!-- if group not created yet, determine if required attributes and parents exist -->
					</LOOP>
				
				</THEN>
				</IF>
			</THEN>
			<ELSE>
				<REMOVEVAR NAME="currentParentName"/>
         </ELSE>
			</IF>
		</THEN>
		<ELSE>
			<!-- no group name defined for grouptemplate, error if parent is required -->
			<!-- this error will be caught one level below when he tries to addparent. -->
			<REMOVEVAR NAME="stringtest"/>
		</ELSE>
		</IF>
		
		<IF COND="IsVariable.modify=true">
		<THEN>
			<SETVAR NAME="errno" VALUE="0"/>
			<ICS.RESOLVEVARIABLES NAME="$(Variables._REMOVE_$(Variables.$(Counters.child)tmplname))" OUTPUT="removeName" DELIMITED="true"/>
			<IF COND="Variables.errno=0">
			<THEN>
				<HASH.CREATE NAME="hParentsToRemove"/>
				<STRINGLIST STR="Variables.removeName" NAME="lParentsToRemove" DELIM=";"/>
				<SETVAR NAME="errno" VALUE="0"/>

				<LOOP LIST="lParentsToRemove">
					<!-- go over every def -->
					<HASH.HASDATA NAME="hParentDefForRemovedAsset" VARNAME="hasDef"/>
					<IF COND="Variables.hasDef=true">
					<THEN>
					<HASH.TOSTRING NAME="hParentDefForRemovedAsset" VARNAME="removeDef" DELIM=";"/>
					<STRINGLIST STR="Variables.removeDef" NAME="lParentsToRemoveDef" DELIM=";"/>

					<LOOP LIST="lParentsToRemoveDef">
					<!-- look for the parents to be removed.-->
				
					<ASSET.LIST LIST="GroupList" TYPE="Variables.GroupType" FIELD1="name" VALUE1="lParentsToRemove.ITEM" FIELD2="flexgrouptemplateid" VALUE2="lParentsToRemoveDef.ITEM"/>
					<IF COND="Variables.errno=0">
					<THEN>
						<HASH.ADD NAME="hParentsToRemove" VALUE="GroupList.id"/>
						<IF COND="Counters.child=1">
						<THEN>
							<HASH.ADD NAME="hImmediateParentsToRemove" VALUE="GroupList.id"/>
						</THEN>
						</IF>
					</THEN>
					<ELSE>
							<!-- Grab the parent definition name from id and check if that variable was populated -->
					
							<ASSET.LIST LIST="FilterParentDefs" TYPE="Variables.GroupTemplateType" FIELD1="id" VALUE1="lParentsToRemoveDef.ITEM"/>
							<IF COND="Variables.errno=0">
							<THEN>
								<ICS.RESOLVEVARIABLES NAME="$(Variables._REMOVE_$(FilterParentDefs.name))" OUTPUT="verifyName" DELIMITED="true"/>
								<IF COND="Variables.errno=0">
								<THEN>
									<IF COND ="Variables.verifyName=lParentsToRemove.ITEM">
									<THEN>
										Warning!  <STRING.STREAM VALUE="Variables.GroupType: lParentsToRemove.ITEM of type FilterParentDefs.name not found."/>
									</THEN>
									<ELSE>
										<SETVAR NAME="errno" VALUE="0"/>
									</ELSE>	
									</IF>		
								</THEN>
								<ELSE>
									<SETVAR NAME="errno" VALUE="0"/>
								</ELSE>	
								</IF>
							</THEN>
							<ELSE>
								<SETVAR NAME="errno" VALUE="0"/>
							</ELSE>
							</IF>


					</ELSE>
					</IF>
					</LOOP>
					</THEN>
					</IF>
				</LOOP>
				<HASH.HASDATA NAME="hParentsToRemove" VARNAME="hasit"/>
				<IF COND="Variables.hasit=true">
				<THEN>
					<HASH.TOSTRING NAME="hParentsToRemove" VARNAME="removeParent" DELIM=";"/>
				</THEN>
				<ELSE>
					<SETVAR NAME="removeParent" VALUE="Variables.empty"/>
				</ELSE>
				</IF>
			</THEN>
			<ELSE>
				<REMOVEVAR NAME="removeName"/>
			</ELSE>
			</IF>
		
			<SETVAR NAME="errno" VALUE="0"/>
			<ICS.RESOLVEVARIABLES NAME="$(Variables._GROUP_$(Variables.$(Counters.child)tmplname))" OUTPUT="addName" DELIMITED="true"/>
			<IF COND="Variables.errno=0">
			<THEN>
				<ASSET.LIST LIST="GroupList" TYPE="Variables.GroupType" FIELD1="name" VALUE1="Variables.addName"/>
				<IF COND="Variables.errno=0">
				<THEN>
					<setvar NAME="addParent" VALUE="GroupList.id"/>
				</THEN>
				<ELSE>
					 Warning!  <STRING.STREAM VALUE="Variables.GroupType: Variables.addName not found."/>
				</ELSE>
				</IF>
			</THEN>
			<ELSE>
				<REMOVEVAR NAME="addName"/>
			</ELSE>
			</IF>
		</THEN>
		</IF>
	
		<INCCOUNTER NAME="level" VALUE="-1"/>
		<INCCOUNTER NAME="grandchild" VALUE="-1"/>
		<INCCOUNTER NAME="child" VALUE="-1"/>
	</THEN>
	</IF>
</LOOP>

</FTCS>
