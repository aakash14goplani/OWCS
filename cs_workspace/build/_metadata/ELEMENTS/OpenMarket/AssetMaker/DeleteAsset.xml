<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- 
$Revision: 22 $ 
$Modtime: 8/06/04 12:20p $ 
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- DeleteAsset.xml
-
- DESCRIPTION
-
- HISTORY 
-->

<!--
	1.	Delete the Asset Table
	2.  Delete the entry(s) for the asset type from the Category table.
	3.  Delete the entry for the asset type from the AssetType table.
	4.  Delete the entry(s) for the asset type from the AssetPublication table.
-->


<!-- if we are deleting the asset type and all related configuration, do it all -->
<if COND="IsVariable.deleteRelated=true">
<then>
	<ASSET.DELETEASSETTYPE TYPE="Variables.assettype"/>
   <if COND="Variables.errno!=0">
    <then>
        <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
            <argument NAME="error" VALUE="DeleteFailed"/>
        </callelement>
    </then>
    <else>
        <XLAT.STREAM KEY="dvin/UI/Deletesuccessful"/>
		<!-- Delete any categories for the asset type (don't check	error because it returns -105) -->
		<CATALOGMANAGER>
			<ARGUMENT NAME="ftcmd" VALUE="deleterow"/>
			<ARGUMENT NAME="tablename" VALUE="Category"/>
			<ARGUMENT NAME="tablekey" VALUE="assettype"/>
			<ARGUMENT NAME="tablekeyvalue" VALUE="Variables.assettype"/>
		</CATALOGMANAGER>
    </else>
    </if>
</then>
<else>
<!--
	First see if the table exists
-->
<setvar NAME="errno" VALUE="0"/>
<CATALOGDEF LIST="AssetTable" FROM="Variables.assettype"/>
<if COND="Variables.errno=0">
<then>
<!--
	delete all the Assets - includes deleting AssetPublication and AssetRelation children  
-->
	<SETCOUNTER NAME="numDeleted" VALUE="0"/>
	<ASSET.LIST LIST="assetsToDelete" TYPE="Variables.assettype"/>
	<if COND="IsList.assetsToDelete=true">
	<then>
		<LOOP LIST="assetsToDelete">
			<ASSET.LOAD NAME="anAsset" TYPE="Variables.assettype" OBJECTID="assetsToDelete.id"/>
			<if COND="IsError.Variables.errno=false">
			<then>
				<ASSET.DELETE NAME="anAsset"/>
				<if COND="IsError.Variables.errno=false">
				<then>
					<INCCOUNTER NAME="numDeleted" VALUE="1"/>
				</then>
				<else>
					<SETVAR NAME="deleteid" VALUE="assetsToDelete.id"/>
					<XLAT.STREAM KEY="dvin/Assetmaker/ErrorDeleteId" errno="Variables.errno" assettype="Variables.assettype" deleteid="Variables.deleteid" EVALALL="false"/>  <br/>
				</else>
				</if>
			</then>
			<else>
				<SETVAR NAME="deleteid" VALUE="assetsToDelete.id"/>
				<XLAT.STREAM KEY="dvin/Assetmaker/ErrorLoadId" errno="Variables.errno" assettype="Variables.assettype" deleteid="Variables.deleteid" EVALALL="false"/>  <br/>
			</else>
			</if>
		</LOOP>
		<XLAT.LOOKUP KEY="dvin/Assetmaker/DeleteAsset-deleted" VARNAME="_xlat_deleted"/>
		<setvar NAME="deletewarnings" VALUE="Variables.deletewarningsVariables._xlat_deleted&#60;br&#62;"/>
	</then>
	</if>
<!--
	delete the asset table
-->
	<setvar NAME="errno" VALUE="0"/>
	<ASSET.DEINSTALL TYPE="Variables.assettype"/>
	<if COND="Variables.errno!=0">
	<then>
		<XLAT.STREAM KEY="dvin/Assetmaker/ErrorDeletTable"/> &nbsp;<csvar NAME="Variables.errno"/><br/>
	</then>
	</if>
</then>
<else>
	<XLAT.LOOKUP KEY="dvin/Assetmaker/DeleteAsset-noTable" VARNAME="_xlat_deleted"/>
	<setvar NAME="deletewarnings" VALUE="Variables.deletewarningsVariables._xlat_deleted&#60;br&#62;"/>
	<setvar NAME="errno" VALUE="0"/>
</else>
</if>

<!-- Delete the AssetType entry -->
<if COND="Variables.errno=0">
<then>
	<ASSETTYPE.LOAD NAME="atToDelete" FIELD="assettype" VALUE="Variables.assettype"/>
	<if COND="IsError.Variables.errno=false">
	<then>
		<ASSETTYPE.DELETE NAME="atToDelete"/>
		<if COND="IsError.Variables.errno=true">
		<then>
			<XLAT.STREAM KEY="dvin/Assetmaker/ErrorDeleteAssettype"/>  &nbsp;<csvar NAME="Variables.errno"/><br/>
		</then>                          
		</if>
	</then>
	<else>
		<XLAT.LOOKUP KEY="dvin/Assetmaker/DeleteAsset-noAssetTypeRow" errno="Variables.errno" assettype="Variables.assettype" EVALALL="false" VARNAME="_xlat_deleted"/>
		<setvar NAME="deletewarnings" VALUE="Variables.deletewarningsVariables._xlat_deleted&#60;br&#62;"/>
		<setvar NAME="errno" VALUE="0"/>
	</else>
	</if>
</then>
</if>

</else>
</if>

<PROPERTY.GET PARAM="xcelerate.treeType" INIFILE="futuretense_xcel.ini" VARNAME="proptreetype"/>
<if COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
<then>
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype">
        <argument NAME="__TreeRefreshKeys__" VALUE="Self:AssetTypes;Self:AssetMaker;Parent:StartMenuContentForm"/>
    </callelement>		
</then>
</if>
</FTCS> 
