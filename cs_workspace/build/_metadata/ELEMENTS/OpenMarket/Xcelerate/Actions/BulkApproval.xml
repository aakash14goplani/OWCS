<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.2">
<!-- OpenMarket/Xcelerate/Actions/BulkApproval
-
- INPUT
- Variables.authusername	- Required, user will xceleditor  privileges
- Variables.authpassword - Required password for authusername
- Variables.ApprovalTargetList  - semicolon separated list of approval target names
- Variables.multiValueDelimiter  - delimiter in approvaltargetlist - default is semicolon
- Variables.doApprovalNotification - boolean (true/false)
- Variables.doApprovalProcessing   - boolean (true/false)
- Variables.doMarkPublish - boolean (true/false)
- Variable.notificationIds - comma seperated list of asset ids to notify approval about
- Variable.notificationAtypes - corresponding comma seperated list of asset types to notify approval about
- Variable.notificationUDates - corresponding comma seperated list of updated dates to notify approval about
- Variable.notificationNtypes - corresponding comma seperated list of notification to notify approval about
  Variable.apprIds - comma seperated list of asset ids to approve / mark_publish
- Variable.apprAtypes - corresponding comma seperated list of asset types to approve / mark_publish
- Variable.apprUDates - corresponding comma seperated list of updated dates to approve / mark_publish
- 
- OUTPUT : mostly xml like outputs in the following tags
    <fatal_error> : contains error mesgs that force abort of this page
    <notify_success> : contains comma seperated list of assetids which have succeeded in approval notify
    <notify_error> : ids and error mesgs for assetids which failed approval notify
    <approval_error> : approval error messages
    <mark_publish_error>  : mark_publish error messages
    <page_done> : page done and final mesg
-
 if doApprovalProcessing=true, get list of approval targets. For 
 each target name, get delivery type. For each list member, get list of 
 asset ids, and asset types that need approval.  Call the approval 
 processing element.  Reset the loop. For each asset id, update 
 bulkloader_ids column need_approval to 'F'.  Also for each asset id, if 
 Variables.doMarkPublish is true, call note_publish if the target is a mirror type  */

-
-->

<IF COND="IsVariable.locale!=true"><THEN>
   <SETSSVAR NAME="locale" VALUE="en_US"/>
</THEN><ELSE>
   <SETSSVAR NAME="locale" VALUE="Variables.locale"/>
</ELSE></IF>

<misc.decrypt STR="Variables.authpassword" OUTSTR="authpassword" />

<SETVAR NAME="errno" VALUE="0"/>
<USERMANAGER.LOGINUSER USERNAMEVARIABLE="authusername" PASSWORDVARIABLE="authpassword" VARNAME="loggedIn"/>

<IF COND="Variables.loggedIn=false"><THEN>
     <CSVAR NAME="&#60;fatal_error&#62;"/>
     <XLAT.STREAM KEY="dvin/UI/Error/LoginfailedremotepostCheckauthusernamepassword"/>
     <CSVAR NAME="&#60;/fatal_error&#62;"/>
     <THROWEXCEPTION/>
</THEN></IF>
<SETVAR NAME="errno" VALUE="0"/>
<USERISMEMBER GROUP="xceladmin"/>
<IF COND="Variables.errno=0"><THEN>
     <CSVAR NAME="&#60;fatal_error&#62;"/>
     <STRING.STREAM VALUE="User Variables.authusername needs to have xceladmin role"/>
     <CSVAR NAME="&#60;/fatal_error&#62;"/>
     <THROWEXCEPTION/>
</THEN> </IF>

<IF COND="IsVariable.doApprovalNotification=false"> <THEN>
    <SETVAR NAME="doApprovalNotification"  VALUE="false"/>
</THEN></IF>
<IF COND="IsVariable.doMarkPublish=false"><THEN>
    <SETVAR NAME="doMarkPublish" VALUE="false"/>
</THEN></IF>
<IF COND="IsVariable.doApprovalProcessing=false"><THEN>
    <SETVAR NAME="doApprovalProcessing" VALUE="false"/>
</THEN></IF>
    

<IF COND="Variables.doApprovalNotification=true"><THEN>

    
    <SETVAR NAME="notifysuccessIds" VALUE="Variables.empty"/>
    <SETVAR NAME="notifyerrors" VALUE="Variables.empty"/>

    <IF COND="IsList.notifyList=false"><THEN>
        <IF COND="IsVariable.notificationIds=false"> 
        <THEN>
            <SETVAR NAME="notifyerrors" VALUE="Variables.notifyerrors notificationIds not available"/>
        </THEN>
        <ELSE>
            <STRINGLIST DELIM="," STR="Variables.notificationIds" 
            NAME="notifyIDList"/>
        </ELSE>
        </IF>
    
        <IF COND="IsVariable.notificationATypes=false"> 
        <THEN>
            <SETVAR NAME="notifyerrors" VALUE="Variables.notifyerrors notificationATypes not available"/>
        </THEN>
        <ELSE>
            <STRINGLIST DELIM="," STR="Variables.notificationATypes" 
            NAME="notifyATypesList"/>
        </ELSE>
        </IF>
    
        <IF COND="IsVariable.notificationUDates=false"> 
        <THEN>
            <SETVAR NAME="notifyerrors" VALUE="Variables.notifyerrors notificationUDates not available"/>
        </THEN>
        <ELSE>
            <STRINGLIST DELIM="," STR="Variables.notificationUDates" 
            NAME="notifyUDatesList"/>
        </ELSE>
        </IF>
    
        <IF COND="IsVariable.notificationNTypes=false"> 
        <THEN>
            <SETVAR NAME="notifyerrors" VALUE="Variables.notifyerrors notificationNTypes not available"/>
        </THEN>
        <ELSE>
            <STRINGLIST DELIM="," STR="Variables.notificationNTypes" 
            NAME="notifyNTypesList"/>
        </ELSE>
        </IF>

        <!-- create the required list -->
        <IF COND="IsList.notifyIDList=true"><THEN>
        <IF COND="notifyIDList.#numRows!=0"><THEN>
            <LISTOBJECT.CREATE NAME="lon" COLUMNS="asset_id,asset_type,approval_notify,updated_date"/>
            <LOOP LIST="notifyIDList">
                <LISTOBJECT.ADDROW NAME="lon" asset_id="notifyIDList.ITEM" asset_type="notifyATypesList.ITEM" approval_notify="notifyNTypesList.ITEM" updated_date="notifyUDatesList.ITEM"/>
                <!-- increment other two lists -->
                <SETROW LIST="notifyATypesList" ACTION="NEXT"/>
                <SETROW LIST="notifyNTypesList" ACTION="NEXT"/>
                <SETROW LIST="notifyUDatesList" ACTION="NEXT"/>
            </LOOP>
            <LISTOBJECT.TOLIST NAME="lon" LISTVARNAME="notifyList"/>
        </THEN></IF>
        </THEN></IF>

    </THEN></IF>
    
    <IF COND="IsList.notifyList=true"><THEN>
        <IF COND="notifyList.#numRows!=0"><THEN>
            <LOOP LIST="notifyList">
                <IF COND="notifyList.approval_notify=T"><THEN>
                      <SETVAR NAME="errno" VALUE="0"/>
                      <APPROVEDASSETS.NOTESAVE TYPE="notifyList.asset_type" ID="notifyList.asset_id" UPDATEDDATE="notifyList.updated_date"/>
                </THEN></IF>
                <IF COND="notifyList.approval_notify=V"><THEN>
                      <SETVAR NAME="errno" VALUE="0"/>
                      <APPROVEDASSETS.NOTESAVE TYPE="notifyList.asset_type" ID="notifyList.asset_id" UPDATEDDATE="notifyList.updated_date" VOIDED="true"/>
                </THEN></IF>
                    <IF COND="IsError.Variables.errno=false"><THEN>
                        <IF COND="Variables.notifysuccessIds=Variables.empty">
                        <THEN>
                            <SETVAR NAME="notifysuccessIds" VALUE="notifyList.asset_id"/>
                        </THEN>
                        <ELSE>
                            <SETVAR NAME="notifysuccessIds" VALUE="Variables.notifysuccessIds,notifyList.asset_id"/>
                        </ELSE>
                        </IF>
                  </THEN>
                  <ELSE>
                            <SETVAR NAME="notifyerrors" VALUE="Variables.notifyerrorsErrorno: Variables.errno, Errdetail1: Variables.errdetail1 for notifyList.asset_id "/>
                  </ELSE>
                  </IF>
            </LOOP>
        </THEN><ELSE>
                    <SETVAR NAME="notifyerrors" VALUE="Variables.notifyerrors List of assetids to notify unavailable"/>
        </ELSE></IF>
    </THEN><ELSE>
            <SETVAR NAME="notifyerrors" VALUE="Variables.notifyerrors List of assetids to notify unavailable"/>
    </ELSE></IF>

    <CSVAR NAME="&#60;notify_success&#62;Variables.notifysuccessIds&#60;/notify_success&#62;"/>
    <BR/>
    <CSVAR NAME="&#60;notify_error&#62;Variables.notifyerrors&#60;/notify_error&#62;"/>

</THEN></IF>  <!-- doApprovalNotification=true -->


<IF COND="Variables.doApprovalProcessing=false"><THEN>
    <CSVAR NAME="&#60;page_done&#62;"/>
     <CSVAR NAME="Approve Function Not Requested"/>
     <CSVAR NAME="&#60;/page_done&#62;"/>
    <CATALOGMANAGER> 
     <ARGUMENT NAME="ftcmd" VALUE="logout"/> 
     <ARGUMENT NAME="killsession" VALUE="true"/>
    </CATALOGMANAGER>
    <THROWEXCEPTION/>
</THEN></IF>

<IF COND="IsVariable.ApprovalTargetList=false"><THEN>
    <SETVAR NAME="ApprovalTargetList" VALUE="Variables.empty"/>
</THEN></IF>

<IF COND="IsVariable.multiValueDelimiter=false"><THEN>
    <SETVAR NAME="multiValueDelimiter" VALUE=";" />
</THEN></IF>

<STRINGLIST DELIM="Variables.multiValueDelimiter" STR="Variables.ApprovalTargetList" 
    NAME="targetList"/>

<IF COND="IsList.targetList=false"><THEN>
    <CSVAR NAME="&#60;fatal_error&#62;"/>
    <CSVAR NAME="No approval targets specified for processing. Exiting.."/>
    <CSVAR NAME="&#60;/fatal_error&#62;"/>
    <CATALOGMANAGER> 
        <ARGUMENT NAME="ftcmd" VALUE="logout"/> 
        <ARGUMENT NAME="killsession" VALUE="true"/>
    </CATALOGMANAGER>
    <THROWEXCEPTION/>
</THEN></IF>

<IF COND="targetList.#numRows=0"><THEN>
    <CSVAR NAME="&#60;fatal_error&#62;"/>
    <CSVAR NAME="No approval targets specified for processing. Exiting.."/>
    <CSVAR NAME="&#60;/fatal_error&#62;"/>
    <CATALOGMANAGER> 
        <ARGUMENT NAME="ftcmd" VALUE="logout"/> 
        <ARGUMENT NAME="killsession" VALUE="true"/>
    </CATALOGMANAGER>
    <THROWEXCEPTION/>
</THEN></IF>

                         
<LOOP LIST="targetList">
    


    <SETVAR NAME="apprerrors" VALUE="Variables.empty"/>
    <SETVAR NAME="mperrors" VALUE="Variables.empty"/>

    <!-- fetch input variables and create the required list -->
    <IF COND="IsList.assetList=false"><THEN>
        <IF COND="IsVariable.apprIds=false"> 
        <THEN>
            <SETVAR NAME="apprerrors" VALUE="Variables.apprerrors No assetids to approve"/>
        </THEN>
        <ELSE>
            <STRINGLIST DELIM="," STR="Variables.apprIds" 
            NAME="apprList"/>
        </ELSE>
        </IF>
    
        <IF COND="IsVariable.apprATypes=false"> 
        <THEN>
            <SETVAR NAME="apprerrors" VALUE="Variables.apprerrors No assettypes to approve"/>
        </THEN>
        <ELSE>
            <STRINGLIST DELIM="," STR="Variables.apprATypes" 
            NAME="apprATypesList"/>
        </ELSE>
        </IF>
    
        <IF COND="IsVariable.apprUDates=false"> 
        <THEN>
            <SETVAR NAME="apprerrors" VALUE="Variables.apprerrors No updateddates to approve"/>
        </THEN>
        <ELSE>
            <STRINGLIST DELIM="," STR="Variables.apprUDates" 
            NAME="apprUDatesList"/>
        </ELSE>
        </IF>
        
        <IF COND="IsList.apprList=true"><THEN>
            <IF COND="apprList.#numRows!=0"><THEN>
                <LISTOBJECT.CREATE NAME="lo" COLUMNS="assetid,assettype,upd_date"/>
                <LOOP LIST="apprList">
                    <LISTOBJECT.ADDROW NAME="lo" assetid="apprList.ITEM" assettype="apprATypesList.ITEM" upd_date="apprUDatesList.ITEM"/>
                    <!-- increment other two lists -->
                    <SETROW LIST="apprATypesList" ACTION="NEXT"/>
                    <SETROW LIST="apprUDatesList" ACTION="NEXT"/>
                </LOOP>
                <LISTOBJECT.TOLIST NAME="lo" LISTVARNAME="assetList"/>
            </THEN></IF>
        </THEN></IF>
    </THEN></IF>

    <IF COND="IsList.assetList=false"><THEN>
        <SETVAR NAME="bNoAssets" VALUE="true"/>
        <SETVAR NAME="apprerrors" VALUE="Variables.apprerrors No list of assets for approve available"/>
    </THEN><ELSE>
        <IF COND="assetList.#numRows=0"><THEN>
            <SETVAR NAME="bNoAssets" VALUE="true"/>
            <SETVAR NAME="apprerrors" VALUE="Variables.apprerrors No list of assets for approve available"/>
        </THEN><ELSE>
            <SETVAR NAME="bNoAssets" VALUE="false"/>
        </ELSE></IF>
    </ELSE></IF>


    <SETVAR NAME="findDeliveryElementSql" 
        VALUE="select p.id targetid, d.path path, d.name type from DeliveryType d ,pubtarget p where p.name='targetList.ITEM' and p.type=d.id"/>
    
    <SETVAR NAME="tablename" VALUE="DeliveryType"/>
    <SETVAR NAME="errno" VALUE="0"/>
	<CALLELEMENT NAME="OpenMarket/Xcelerate/Util/validateFields">
		<ARGUMENT NAME="columnvalue" VALUE="targetList.ITEM"/>
		<ARGUMENT NAME="type" VALUE="String"/>
	</CALLELEMENT>
	<IF COND="Variables.validatedstatus=true">
	<THEN>
		<EXECSQL  SQL="Variables.findDeliveryElementSql" LIST="deliveryList" TABLE="DeliveryType,pubtarget"/>
    </THEN>
	</IF>
	<IF COND="IsError.Variables.errno=true"><THEN>
        <CSVAR NAME="&#60;fatal_error&#62;"/>
        <STRING.STREAM VALUE="Error Variables.errno, Variables.errdetail1 for doing sql Variables.findDeliveryElementSql"/>
        <CSVAR NAME="&#60;/fatal_error&#62;"/>
        <THROWEXCEPTION/>
    </THEN></IF>
    <IF COND="IsList.deliveryList=false"><THEN>
        <SETVAR NAME="apprerrors" VALUE="Variables.apprerrors Could not locate deliverytype table entry for target targetList.ITEM"/>
        <SETVAR NAME="bNoAssets" VALUE="true"/>
    </THEN><ELSE>
         <IF COND="deliveryList.#numRows=0"><THEN>
             <SETVAR NAME="apprerrors" VALUE="Variables.apprerrors Could not locate deliverytype table entry for target targetList.ITEM"/>
             <SETVAR NAME="bNoAssets" VALUE="true"/>
         </THEN></IF>
    </ELSE></IF>
    
    <GOTOROW LIST="deliveryList" ROWNUM="1"/>
    <SETVAR NAME="elementPath" VALUE="deliveryList.path"/>
    <SETVAR NAME="approvalElement" VALUE="Variables.elementPath/ApproveAssets"/>
    <SETVAR NAME="target" VALUE="deliveryList.targetid"/>

     
    
    <IF COND="IsElement.Variables.approvalElement=false"><THEN>
        <SETVAR NAME="bNoAssets" VALUE="true"/>
        <SETVAR NAME="apprerrors" VALUE="Variables.apprerrors CS-Direct element Variables.approvalElement  is missing."/>
    </THEN></IF>
    <IF COND="Variables.bNoAssets=false">
        <THEN>
        <STRING.STREAM VALUE="Calling element Variables.approvalElement for approving assets for target targetList.ITEM"/>
        
        <SETVAR NAME="errno" VALUE="0"/>
		<!-- AC Setting force to true -->
		<!-- force option is set to true because we already have a list of assets that are updated and needs approval. We don't need to create this list again -->
        <CALLELEMENT NAME="Variables.approvalElement">
            <ARGUMENT NAME="list" VALUE="assetList"/>
            <ARGUMENT NAME="target" VALUE="Variables.target"/>
            <ARGUMENT NAME="force" VALUE="true"/>
            <ARGUMENT NAME="recursive" VALUE="false"/>
        </CALLELEMENT>
        
        <IF COND="IsError.Variables.errno=true">
         <THEN>
            <SETVAR NAME="apprerrors" VALUE="Variables.apprerrors Error Variables.errno, Variables.errdetail1 from approval processing for target targetList.ITEM. Continuing to the next approval target.."/>
        </THEN>
        <ELSE>
            <SETVAR NAME="resetFlag" VALUE="true"/>
            <IF COND="Variables.doMarkPublish=true">
                <THEN>
                <IF COND="deliveryList.type=Mirror to Server">
                    <THEN>
                    <GOTOROW LIST="assetList" ROWNUM="1"/>
                    <!--  do fake publish all the approved assets in the list Variables.list -->
                    <SETCOUNTER NAME="BulkPublishCounter" VALUE="0"/>
                    <LOOP LIST="assetList">
                     <MIRRORKEY.CREATE TYPE="assetList.assettype" ID="assetList.assetid" OBJVARNAME="BulkPublishCounter.count"/>
                    <PUBLISHSUBASSETS.ADD TYPE="assetList.assettype" ID="assetList.assetid" DATE="assetList.upd_date"/>
                     <PUBLISHEDASSETS.ADD KEY="BulkPublishCounter.count"/>
                     <INCCOUNTER NAME="BulkPublishCounter" VALUE="1"/>
                    </LOOP>
                    <SETVAR NAME="errno" VALUE="0"/>
                    <APPROVEDASSETS.NOTEPUBLISH TARGET="Variables.target"/>
                    <IF COND="IsError.Variables.errno=true">
                    <THEN>
                        <CSVAR NAME="&#60;mark_publish_error&#62;Error Variables.errno doing ApprovedAssets.NotePublish, Variables.errdetail1&#60;/mark_publish_error&#62;"/>
                    </THEN>
                    </IF>
                </THEN>
                </IF>
            </THEN>
            </IF>
            
        </ELSE>
        </IF>
    </THEN>
    <ELSE>
         <SETVAR NAME="apprerrors" VALUE="Variables.apprerrors No Assets to Approve: Error Variables.errno, Variables.errdetail1 from approval processing for target targetList.ITEM. Continuing to the next approval target.."/>
    </ELSE>
    </IF>
    <IF COND="Variables.apprerrors!=Variables.empty">
    <THEN>
               <CSVAR NAME="&#60;approval_error&#62;Variables.apprerrors&#60;/approval_error&#62;"/>
    </THEN>
    </IF>
    
</LOOP>

 
 <CATALOGMANAGER> 
     <ARGUMENT
         NAME="ftcmd" VALUE="logout"/> <ARGUMENT NAME="killsession" VALUE="true"/>
 </CATALOGMANAGER>
 

 <CSVAR NAME="&#60;page_done&#62;"/>
 <CSVAR NAME="&nbsp;&nbsp;Bulk Approval Processing Done"/>
 <CSVAR NAME="&#60;/page_done&#62;"/>
 <!-- check if recursive needs to be true for approval processing -->
</FTCS>