<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!--
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/DeletePost.xml $
$Revision: 64 $
$Modtime: 6/10/04 4:01p $
-->

<!--
- Confidential and Proprietary Information of Open Market, Inc.
-					All Rights Reserved.
-
- DESCRIPTION
-	Delete an asset
- 	Required input variables: id and AssetType
-->

<STRING.ENCODE VARIABLE="id" VARNAME="id"/>
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType"/>

<PROPERTY.GET PARAM="xcelerate.treeType" INIFILE="futuretense_xcel.ini" VARNAME="proptreetype"/>

	<if COND="Variables.upcommand=delete">
		<then>
			<!-- //Check if its global asset, if yes, remove all site affiliations silently. -->
			<CALLELEMENT NAME="OpenMarket/Xcelerate/Util/CheckForGlobalAssets" />
			<IF COND='Variables.isGlobal=yes'>
					  <THEN>
							 <CALLELEMENT NAME="OpenMarket/Xcelerate/Util/UnshareAssetFromAllSites" />
							 <IF COND="Variables.errno!=0">
							   <THEN>
							        <SETVAR NAME="doproceed" VALUE="false"/>
							   </THEN>
							  </IF>
					  </THEN>
			</IF>
			<ASSET.GET NAME="theCurrentAsset" FIELD="name" OUTPUT="name"/>

<!-- Load the asset type information -->
		
			<ASSETTYPE.LOAD NAME="type" TYPE="Variables.AssetType"/>
			<ASSETTYPE.GET NAME="type" FIELD="description" OUTPUT="atdescription"/>

			<!-- Check if the item is checked out. If not, check it out -->
			<if COND="Variables.trackingenabled=true">
			<then>
				<setvar NAME="doproceed" VALUE="true"/>
				<history TABLE="Variables.AssetType" ASSET="Variables.id" LIST="ItsHistory"/>
				<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/LockIfNeeded">
					<argument NAME="AssetType" VALUE="Variables.AssetType"/>
					<argument NAME="id" VALUE="Variables.id"/>
					<argument NAME="checkedoutby" VALUE="Delete"/>
				</callelement>
			
				<!-- If the asset is locked by another user, LockIfNeeded will set doProceed -->
				<if COND="Variables.doproceed!=true">
				<then>
					<STRING.ENCODE VARIABLE="doproceed" VARNAME="doproceed"/>
					<callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
						<argument NAME="error" VALUE="Variables.doproceed"/>
					</callelement>
				</then>
				</if>
				<if COND="Variables.locked=true">
				<then>
					<!-- Add an entry in CheckOutInfo table about this implicit check out -->
					<if COND="Variables.checkoutmethod=implicit">
					<then>
						<usermanager.getloginuser VARNAME="userID"/>
						<implicitcheckout.logimplicitcheckout ASSETTYPE="Variables.AssetType" ASSETID="Variables.id" FUNCTION="Delete" USER="Variables.userID"/>
					</then>
					</if>
				</then>
				</if>
			</then>
			</if>

<!-- call the treeupdate predelete function -->
         <if  COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
				<then>
  					<callelement NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype">
						<argument NAME="assetname" VALUE="theCurrentAsset"/>
						<argument NAME="treecommand" VALUE="predelete"/>
					</callelement>
				</then>
			</if>
			
<!-- call the preupdate function -->
			<ASSET.GetAssetTypeProperties TYPE="Variables.AssetType"/>
			<IF COND="Variables.IsProxyAssetType=false">
				<THEN>
					<callelement NAME="OpenMarket/Xcelerate/AssetType/Variables.AssetType/PreUpdate">
						<argument NAME="updatetype" VALUE="delete"/>
					</callelement>
				</THEN>
			</IF>
            
            
<!-- Check if the item is assigned. If yes, clear all the assignment -->
            <WorkflowAsset.Load ASSETTYPE="Variables.AssetType" ID="Variables.id" OBJVARNAME="workflowasset" />
            <WorkflowEngine.IsObjectAssigned OBJECT="workflowasset" VARNAME="isAssigned"/>
            <if COND="Variables.isAssigned=true">
            <then>
                <WorkflowEngine.CloseAssignments OBJECT="workflowasset" SITE="SessionVariables.pubid" />
                <if COND="Variables.errno!=0">
                <then>
                     <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
                        <argument NAME="error" VALUE="RemoveFromWorkflowFailed"/>
                     </callelement>
                     <throwexception/>
                </then>
                </if>
              </then>
            </if>           
                
<!-- Request that the asset be deleted -->
			<ASSET.VOID NAME="theCurrentAsset"/>
			<if COND="IsError.Variables.errno=true">
				<then>
					<callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
						<argument NAME="error" VALUE="DeleteFailed"/>
					</callelement>
					<throwexception/>
				</then>
			</if>
<!-- Remove references to the asset from the ActiveList -->
	<ACTIVELIST.DELETEASSET ASSETTYPE="Variables.AssetType" ASSETID="Variables.id"/>
	
<!-- Remove the asset from the history -->
<IF COND="Variables.cs_environment=portal">
<THEN>
      <callelement NAME="OpenMarket/Flame/Common/RemoveFromPortalHistory">
          <argument NAME="id" VALUE="Variables.id"/>
      </callelement>
</THEN>
<ELSE>
    <SCRIPT Language="JavaScript">
    parent.parent.XcelBanner.removeFromHistory('<STRING.STREAM VARIABLE="id"/>','<STRING.STREAM VARIABLE="AssetType"/>');
    </SCRIPT>
</ELSE>
</IF>

<!-- Remove the search index for the asset -->

			<callelement NAME="OpenMarket/Xcelerate/Actions/Search/ManageSeIndex">
				<argument NAME="msicommand" VALUE="Remove"/>
			</callelement>

<!-- Call the post update function -->
			<HASH.CREATE NAME="refreshHash"/>
			<ASSET.GetAssetTypeProperties TYPE="Variables.AssetType"/>
			<IF COND="Variables.IsProxyAssetType=false">
				<THEN>
					<callelement NAME="OpenMarket/Xcelerate/AssetType/Variables.AssetType/PostUpdate">
						<argument NAME="updatetype" VALUE="delete"/>
					</callelement>
				</THEN>
			</IF>
			
			<HASH.ADD NAME="refreshHash" VALUE="Parent:Variables.id"/>
			<HASH.TOSTRING NAME="refreshHash" VARNAME="__TreeRefreshKeys__" DELIM=";"/>
			
<!-- call the treeupdate postdelete function -->

			<if  COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
				<then>
  					<callelement NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype">
						<argument NAME="assetname" VALUE="theCurrentAsset"/>
						<argument NAME="treecommand" VALUE="postdelete"/>
					</callelement>	
				</then>
			</if>
			<ASSET.GET NAME="theCurrentAsset" FIELD="createdby" OUTPUT="createdby"/>
			<ASSET.GET NAME="theCurrentAsset" FIELD="createddate" OUTPUT="createddate"/>
			<ASSET.GET NAME="theCurrentAsset" FIELD="updatedby" OUTPUT="updatedby"/>
			<ASSET.GET NAME="theCurrentAsset" FIELD="updateddate" OUTPUT="updateddate"/>
			<ASSET.GET NAME="theCurrentAsset" FIELD="description" OUTPUT="description"/>
			<ASSET.GET NAME="theCurrentAsset" FIELD="status" OUTPUT="statuscode"/>
		
		<table Border="0" cellpadding="0" cellspacing="0" class="width-outer-70">
		<tr>
			<td>
			<XLAT.LOOKUP KEY="dvin/UI/AssetMgt/Delete-Success" atdescription="Variables.atdescription" name="Variables.name" EVALALL="false" VARNAME="_xlat_delete"/>
			<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
				<argument NAME="msgtext" VALUE="Variables._xlat_delete"/>
				<argument NAME="severity" VALUE="info"/>
			</callelement>
			</td>
		</tr>
		<tr>
			<td><span class="title-text"><STRING.STREAM VARIABLE="atdescription"/>: </span><span class="title-value-text"><STRING.STREAM VARIABLE="name"/></span></td>
		</tr>
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/TitleBar">
			<argument NAME="SpaceBelow" VALUE="No"/>
		</callelement>
		<tr>
			<td>
				<table border="0" cellpadding="0" cellspacing="0">

				<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
				<tr>
					<td class="form-label-text"><XLAT.STREAM KEY="dvin/AT/Common/Name"/>:</td>
					<STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
					<td><img height="1" width="5" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
					<td class="form-inset"><STRING.STREAM VARIABLE="name"/></td>
				</tr>

				<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
				<tr>
					<td class="form-label-text"><XLAT.STREAM KEY="dvin/AT/Common/Description"/>:</td>
					<td></td>
					<td class="form-inset"><STRING.STREAM VARIABLE="description"/></td>
				</tr>

				<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
				<tr>
					<td class="form-label-text"><XLAT.STREAM KEY="dvin/AT/Common/Status"/>:</td>
					<td></td>
					<td class="form-inset"><span class="alert-color"><XLAT.STREAM KEY="dvin/AT/Common/StatusCode-Variables.statuscode"/></span></td>
				</tr>
				
				<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
				<tr>
					<td class="form-label-text"><XLAT.STREAM KEY="dvin/AT/Common/Created"/>:</td>
					<td></td>
					<td class="form-inset">
						<DATEFORMAT.GETDATETIME NAME="_FormatDate_" VALUE="Variables.createddate" VALUETYPE="jdbcdate"  VARNAME="createddate"/>
						<XLAT.STREAM KEY="dvin/UI/createddatebycreatedby"/>
					</td>
				</tr>
			
				<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
				<tr>
					<td class="form-label-text"><XLAT.STREAM KEY="dvin/AT/Common/Modified"/>:</td>
					<td></td>
					<td class="form-inset">
					<DATEFORMAT.GETDATETIME NAME="_FormatDate_" VALUE="Variables.updateddate" VALUETYPE="jdbcdate"  VARNAME="updateddate"/>
					<XLAT.STREAM KEY="dvin/UI/updateddatebyupdatedby"/>
					</td>
				</tr>
			</table>
			</td>
		</tr>
		</table>

		</then>
	</if>

<!-- decide whether to unlock record.
	 If the item was already locked, then no unlock is
	 needed. Else unlock it -->

	<if COND="Variables.trackingenabled=true">
	<then>

	<if COND="IsVariable.alreadylocked=true">
	<then>
		<if COND="Variables.upcommand=delete">
		<then>
			<XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/VersionbyDelete" VARNAME="_xlat_version"/>
			<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Commit-Asset"/>
			<ASSET.CHECKIN NAME="Commit-Asset" ANNOTATION="Variables._xlat_version" CHECKOUT="false"/>
		</then>
		<else>
			<if COND="Variables.alreadylocked!=true">
			<then>
				<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Release-Asset"/>
				<ASSET.UNDOCHECKOUT NAME="Release-Asset"/>
			</then>
			</if>
		</else>
		</if>
	</then>
	</if>
	</then>
	</if>

<!-- Remove entry from CheckOutInfo table about implicit checkout. Assume only one entry in the table -->

	<IMPLICITCHECKOUT.CLEARCHECKOUT ASSETTYPE="Variables.AssetType" ASSETID="Variables.id"/>

<IF COND="Variables.cs_environment=portal">
<THEN>
      <CALLELEMENT NAME="OpenMarket/Flame/Common/Script/RefreshPortal"/>
</THEN>
<ELSE>
    <!-- if action is delete, goto DeletePost page, else display details -->
    <IF COND="Variables.upcommand=delete">
    <THEN>
    	<REMOVEVAR NAME="InAssetType"/>
    </THEN>
    <ELSE>
    <CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/ContentDetailsFront"/>
    </ELSE>
    </IF>
</ELSE>
</IF>

</FTCS>
