<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Actions/SetAssetExportDataPost
-
- INPUT
-	Variables.target = pubtarget id
-  Variables.AssetType - asset type
-  Variables.id - id of affected asset 
-  Variables.ex:filename - specified filename
-  Variables.ex:path - specified path
-  Variables.ex:isPublishPoint - is export starting point or not
-  Variables.ex:templates - templates used by publish points
- OUTPUT
-
-->
<STRING.ENCODE VARIABLE="id" VARNAME="id"/>
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType" />
<IF COND="Variables.upcommand!=cancel">
<THEN>
	<AssetTargetManager.Load OBJVARNAME="targetdata" TARGET="Variables.target" TYPE="Variables.AssetType" ID="Variables.id"/>
	<if COND="IsVariable.ex:filename=false">
	<then>
		<SETVAR NAME="ex:filename" VALUE="Variables.empty"/>
	</then>
	</if>
	<if COND="IsVariable.ex:path=false">
	<then>
		<SETVAR NAME="ex:path" VALUE="Variables.empty"/>
	</then>
	</if>
	<AssetTarget.SetFileName NAME="targetdata" VALUE="Variables.ex:filename"/>
	<AssetTarget.SetPath NAME="targetdata" VALUE="Variables.ex:path"/>
	<AssetTargetManager.Save OBJECT="targetdata"/>
	<if COND="IsError.Variables.errno=true">
	<then>
	  <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
	      <argument NAME="error" VALUE="EnterFailed"/>
	  </callelement>
	</then>
	</if>
	
	 <PUBTARGETMANAGER.LOAD ID="Variables.target" OBJVARNAME="pubtgt"/>
	 <PUBTARGET.SCATTER NAME="pubtgt" PREFIX="pubfact:"/>
	<PUBTARGET.UNPACK NAME="pubtgt" PREFIX="pubfact:" FIELD="factors"/>
	
	<ApprovedAssets.GetPerm TARGET="Variables.target" ASSETID="Variables.id" OBJVARNAME="publishpoints" />
	<PublishPoints.Clear NAME="publishpoints" />
	
	<if COND="Variables.ex:isPublishPoint=yes" >
	<then>
	    <if COND="Variables.pubfact:OLDTEMPLATE!=true">
		<then>
			<SETCOUNTER NAME="templateCount" VALUE="0"/>
			<loop COUNT="Variables.numTemplates">
	        <if COND="IsVariable.ex:templatesCounters.templateCount=true">
	        <then>
	           <setvar NAME="ref" VALUE="c=Variables.AssetType&#38;cid=Variables.id&#38;pagename=Variables.ex:templatesCounters.templateCount" />
	        	  <!-- if a wrapper page is in use, adjust the url accordingly -->
	        	 <IF COND="IsVariable.ex:wrapperpageCounters.templateCount=true">
	        	 <THEN>
				  		<setvar NAME="ref" VALUE="Variables.ref&#38;WRAPPERPAGE=Variables.ex:wrapperpageCounters.templateCount"/>
				 </THEN>
				 </IF>	
				  <if COND="IsVariable.ex:simplepathCounters.templateCount=true">
				  <then>
				  		<setvar NAME="ref" VALUE="Variables.ref&#38;SIMPLEDIR=true"/>
			  		</then>
				  	</if>
				  <if COND="IsVariable.ex:simplefilenameCounters.templateCount=true">
				  <then>
				  		<setvar NAME="ref" VALUE="Variables.ref&#38;SIMPLENAME=true"/>
				  	</then>
				  	</if>
	             <EXPORTKEY.CREATE REFERENCE="Variables.ref" ID="Variables.id" OBJVARNAME="exportkey" />
	             <PUBLISHPOINTS.ADD NAME="publishpoints" KEY="exportkey" />
					 <ApprovedAsset.InvalidateKey TARGET="Variables.target" KEY="exportkey"/>
		     </then>
	        </if>
	        <INCCOUNTER NAME="templateCount" VALUE="1"/>
	     </loop>
	    </then>
	    <else>
	          <setvar NAME="ref" VALUE="c=Variables.AssetType&#38;cid=Variables.id&#38;pagename=OpenMarket/Xcelerate/Export" />
	          <EXPORTKEY.CREATE REFERENCE="Variables.ref" ID="Variables.id" OBJVARNAME="exportkey" />
	          <PUBLISHPOINTS.ADD NAME="publishpoints" KEY="exportkey" />
	 			 <ApprovedAsset.InvalidateKey TARGET="Variables.target" KEY="exportkey"/>
	   </else>
	    </if>          
	</then>
	</if>
	
	<ApprovedAssets.SetPerm TARGET="Variables.target" ASSETID="Variables.id" POINTS="publishpoints" />

</THEN>
<ELSE>
<XLAT.LOOKUP KEY="dvin/UI/CancelledtheSpecifyPathFilenameoperation" VARNAME="_XLAT_"/>
	<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
		<argument NAME="msgtext" VALUE="Variables._XLAT_"/>
		<argument NAME="severity" VALUE="info"/>
	</callelement>		
</ELSE>
</IF>
	
<callelement NAME="OpenMarket/Xcelerate/Actions/StatusDetailsFront">
  <argument NAME="AssetType" VALUE="Variables.AssetType"/>
  <argument NAME="id"        VALUE="Variables.id"/>
</callelement>

</FTCS> 
