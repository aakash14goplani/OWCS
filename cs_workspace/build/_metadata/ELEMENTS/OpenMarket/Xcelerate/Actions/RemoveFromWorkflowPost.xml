<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Actions/RemoveFromWorkflowPost
-
- INPUT
-
- OUTPUT
-
-->
<STRING.ENCODE VARIABLE="id" VARNAME="id"/>
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType" />
<WorkflowAsset.Load ASSETTYPE="Variables.AssetType" ID="Variables.id" OBJVARNAME="workflowasset" />

<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="theAsset"/>
<ASSET.GET NAME="theAsset" FIELD="name" OUTPUT="assetname"/>

<setvar NAME="AbortFlag" VALUE="false"/>
<setvar NAME="needUnlock" VALUE="false" />
<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
    <argument NAME="AssetType" VALUE="Variables.AssetType"/>
</callelement>

<if COND="Variables.trackingenabled=true">
<then>
    <ASSET.CHECKOUT OBJECTTYPE="Variables.AssetType" OBJECTID="Variables.id"/>
    <if COND="Variables.errno!=0">
    <then>
        <history TABLE="Variables.AssetType" ASSET="Variables.id" LIST="ItsHistory"/>
        <if COND="ItsHistory.#numRows!=0">
        <then>
            <if COND="ItsHistory.lockedby!=Variables.empty">
            <then>
                <setvar NAME="AbortFlag" VALUE="true"/>
                <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                    <argument NAME="elem" VALUE="CantAddToGroupLocked"/>
                    <argument NAME="lockedby" VALUE="ItsHistory.lockedby"/>
                    <argument NAME="severity" VALUE="warning"/>
                </callelement>
            </then>
            </if>
        </then>
        </if>
        
        <if COND="Variables.AbortFlag!=true">
        <then>
             <!-- add to group failed for unknown reason -->
             <setvar NAME="AbortFlag" VALUE="true"/>
			 <STRING.ENCODE VARIABLE="groupname" VARNAME="groupname"/>
             <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
                <argument NAME="error" VALUE="AddToGroupFailed"/>
                <argument NAME="groupname" VALUE="Variables.groupname"/>
             </callelement>
        </then>
        </if>		
    </then>
    <else>
        <setvar NAME="needUnlock" VALUE="true" />
	<IMPLICITCHECKOUT.LOGIMPLICITCHECKOUT ASSETTYPE="Variables.AssetType"
		ASSETID="Variables.id" USER="Variables.userID" FUNCTION="Remove From Workflow"/>
    </else>
    </if>
</then>
</if>     

<if COND="Variables.AbortFlag!=true">
<then>
    <WorkflowEngine.GetProcessID ID="Variables.workflowid" OBJVARNAME="workflowobj" />
    <WorkflowProcess.GetProcessName NAME="workflowobj" VARNAME="workflowname" />
    
    <if COND="IsVariable.removecomment!=true">
    <then>
        <setvar NAME="removecomment" VALUE=""/>
    </then>
    <else>
         <!-- Make unsafe characters safe again (late fix) -->
         <substitute STR="Variables.removecomment" WHAT="%26" WITH=" AND " OUTSTR="removecomment"/>
         <substitute STR="Variables.removecomment" WHAT="'" WITH=" " OUTSTR="removecomment"/>
         <substitute STR="Variables.removecomment" WHAT="%22" WITH=" " OUTSTR="removecomment"/>
    </else>
    </if>
    
    <WorkflowEngine.CloseAssignments OBJECT="workflowasset" COMMENT="Variables.removecomment" SITE="SessionVariables.pubid" />
    <if COND="Variables.errno!=0">
    <then>
         <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
    	    <argument NAME="error" VALUE="RemoveFromWorkflowFailed"/>
            <argument NAME="workflowname" VALUE="Variables.workflowname"/>
         </callelement>
    </then>
    <else>
         <ASSETTYPE.LOAD NAME="type" TYPE="Variables.AssetType"/>
         <ASSETTYPE.GET NAME="type" FIELD="description" OUTPUT="ATdesc"/>
         <XLAT.LOOKUP KEY="dvin/UI/AssetRemovedFromWorkflow" VARNAME="_XLAT_"/>
         <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
            <argument NAME="msgtext" VALUE="Variables._XLAT_"/>
    	    <argument NAME="severity" VALUE="info"/>
         </callelement> 
		<if COND="Variables.cs_environment=ucform">
		<then>
			<SCRIPT TYPE="text/javascript">
				dojo.addOnLoad(function(){
					SitesApp.notifyModelUpdate('workflowStatus');
				});
			</SCRIPT>
		</then>
		</if>	
    </else>
    </if>    
</then>
</if>

<if COND="Variables.needUnlock=true">
<then>
    <ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Release-Asset"/>
    <ASSET.UNDOCHECKOUT NAME="Release-Asset"/>
    <IMPLICITCHECKOUT.CLEARCHECKOUT ASSETTYPE="Variables.AssetType"
	ASSETID="Variables.id"/>
</then>
</if>

    
<callelement NAME="OpenMarket/Xcelerate/Actions/StatusDetailsFront">
	<argument NAME="AssetType" VALUE="Variables.AssetType"/>
	<argument NAME="id"        VALUE="Variables.id"/>
</callelement>

</FTCS> 
