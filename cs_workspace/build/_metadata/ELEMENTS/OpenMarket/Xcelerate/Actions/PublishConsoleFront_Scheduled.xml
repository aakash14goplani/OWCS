<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- Verifies if user has publishing permission. Normally this check will be called from prologactions however
PublishConsoleFront_Scheduled is a pagelet of PublishConsoleFront and does not have related prologaction-->
<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/BasicEnvironment"/>
<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Security/PublishAccessCheck"/>
<if COND="Variables.doproceed=true">
<then>
<html>
<head>
</head>
<body>
<SETCOUNTER NAME="schCount" VALUE="0"/>
<table border="0" cellpadding="0" cellspacing="0" class="width-inner-100">
<setvar NAME="errno" VALUE="0"/>
<PUBTARGETMANAGER.FIND PREFIX="pbt" PUBID="SessionVariables.pubid" FILTERFORPUBLISH="true"/>
<setvar NAME="PUBTARGETS" VALUE=""/>
<if COND="Variables.pbtTotal!=0">
<then>
	<SETCOUNTER NAME="nthTarget" VALUE="0"/>
	<loop COUNT="Variables.pbtTotal">
	    <PUBTARGET.SCATTER NAME="pbtCounters.nthTarget" PREFIX="pubtarget:"/>
		<setvar NAME="PUBTARGETS" VALUE="Variables.PUBTARGETS,Variables.pubtarget:id" REPLACEALL="Variables.pubtarget:id,Variables.PUBTARGETS"/>
		<INCCOUNTER NAME="nthTarget" VALUE="1"/>
	</loop>
</then>
</if>
<!-- read SystemEvents table -->
<ics.queryevents LIST="scheduledtasks" ENABLED="true" NAME="PublishEvent_%"/>

<!-- this code assumes that if there is no list the errno is not zero, but that isn't always true for reasons that are not clear to me. Therefore, I'm forcing an errno if there is no list. JRWS-->	
<IF COND="IsError.Variables.errno!=true">
<THEN>
     <IF COND="IsList.scheduledtasks!=true">
     <THEN>
	      <SETVAR NAME="errno" VALUE="-101"/>
     </THEN>
	 <ELSE>
		<loop LIST="scheduledtasks" UNTIL="Variables.errnumber=1">
         <url.scatter VALUE="scheduledtasks.params" PREFIX="scheduled" />
		 <!-- get PubTarget name -->
			<PUBTARGETMANAGER.LOAD ID="Variables.scheduled:target" OBJVARNAME="pubtgt"/>
			<PUBTARGET.SCATTER NAME="pubtgt" PREFIX="pubtgt:"/>
			<ISINLIST 
				ITEM="Variables.pubtgt:id" 
				STR="Variables.PUBTARGETS"/>
			<IF COND="Variables.errno=1">
			<THEN>
				<!-- Setting the errnumber variable because the loop tag resets errno to 0 after each iteration(May be Bug?) -->
				<SETVAR NAME="errnumber" VALUE="1"/>
			</THEN>
			</IF>
		</loop>
	 </ELSE>
     </IF>
</THEN>
</IF>
<IF COND="Variables.errnumber!=1">
<THEN>
	<SETVAR NAME="errno" VALUE="-101"/>
</THEN>
</IF>
<if COND="IsError.Variables.errno=true">
<then>
	<tr height="35px"><td NOWRAP="NOWRAP" class="width-inner-100"><XLAT.STREAM KEY="dvin/UI/NoScheduledPublishTasks"/></td></tr>
</then>
<else>
    <tr>
	<td>
	<table BORDER="0" CELLSPACING="0" CELLPADDING="0" class="width-inner-100">
		<tr>
			<td/>
			<td><font size="2"><CALLELEMENT NAME="OpenMarket/Xcelerate/Util/SetServerTimeZoneVar"/><XLAT.STREAM KEY="UI/Forms/datesInServerTime"/></font></td>
			<td/>
		</tr>
		<tr>
			<td/>
			<td class="tile-dark" VALIGN="TOP" HEIGHT="1">
				<IMG WIDTH="1" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/>
			</td>
			<td/>
		</tr>
		<tr>
			<td class="tile-dark" VALIGN="top" WIDTH="1"><IMG WIDTH="1" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
			<td>
	<SETVAR NAME="rowStyle" VALUE="pubTile-row-normal"/>
	<SETVAR NAME="separatorLine" VALUE="0"/>
	<table class="width-inner-100" cellpadding="0" cellspacing="0" border="0" bgcolor="#ffffff">
	<tr><td colspan="9" class="tile-highlight"><IMG WIDTH="1" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td></tr>
	<tr><td class="tile-a" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;</td>
        <td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir"><DIV class="new-table-title"><BR /></DIV></td>
        <td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;&nbsp;&nbsp;&nbsp;</td>
		<td NOWRAP="NOWRAP" class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir"><DIV class="new-table-title"><XLAT.STREAM KEY="dvin/Common/Destination"/></DIV></td>
		<td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;&nbsp;&nbsp;&nbsp;</td>
		<td NOWRAP="NOWRAP" class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir"><DIV class="new-table-title"><XLAT.STREAM KEY="dvin/UI/PublishSchedule"/></DIV></td>
        <td class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;&nbsp;&nbsp;&nbsp;</td>
		<td NOWRAP="NOWRAP" class="tile-b" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir"><DIV class="new-table-title"><XLAT.STREAM KEY="dvin/UI/ScheduledBy"/></DIV></td>
        <td class="tile-c" background="Variables.cs_imagedir/graphics/common/screen/grad.gif" REPLACEALL="Variables.cs_imagedir">&nbsp;</td>
	</tr>
	<tr><td colspan="9" class="tile-dark"><IMG WIDTH="1" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td></tr>
	<loop LIST="scheduledtasks">
         <url.scatter VALUE="scheduledtasks.params" PREFIX="scheduled" />
    
         <!-- get PubTarget name -->
			<PUBTARGETMANAGER.LOAD ID="Variables.scheduled:target" OBJVARNAME="pubtgt"/>
			<PUBTARGET.SCATTER NAME="pubtgt" PREFIX="pubtgt:"/>
			<ISINLIST 
				ITEM="Variables.pubtgt:id" 
				STR="Variables.PUBTARGETS" />
			<IF COND="Variables.errno=1">
			<THEN>
			<IF COND="Variables.separatorLine=1">
			<THEN>
			<tr>
				<!--<td colspan="9" class="light-line-color">
				<img height="1" width="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/>
				</td>-->
			</tr>
			</THEN>																		
			</IF>
			<SETVAR NAME="separatorLine" VALUE="1"/>
			<tr class="Variables.rowStyle" REPLACEALL="Variables.rowStyle">
		    <td></td>
			<td></td>
			<td></td>
            <td NOWRAP="NOWRAP">
            <SETVAR NAME="errno" VALUE="0"/>
			<USERISMEMBER GROUP="xceladmin"/>
			<IF COND="Variables.errno=1">
			<THEN>
				<satellite.link assembler="query" pagename="OpenMarket/Xcelerate/Admin/Publish/PublishEventEdit" outstring="urlConfSch">
					<satellite.argument name="action" value="edit"/>
					<satellite.argument name="target" value="Variables.scheduled:target"/>
					<satellite.argument name="cs_environment" value="Variables.cs_environment"/>
					<satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
					<satellite.argument name="returnToPubConsole" value="true"/> 
				</satellite.link>
				<a href="Variables.urlConfSch" REPLACEALL="Variables.urlConfSch"><STRING.STREAM VALUE="Variables.pubtgt:name"/></a>
			</THEN>
			<ELSE>
				<STRING.STREAM VALUE="Variables.pubtgt:name"/>
			</ELSE>
			</IF>
			</td>
			<td></td>
			<td><span onmouseover="showhide('etip_Variables.scheduled:target');" onmouseout="showhide('etip_Variables.scheduled:target');" REPLACEALL="Variables.scheduled:target"><STRING.STREAM VALUE="scheduledtasks.time"/></span><br />
				<div id="etip_Variables.scheduled:target" class="eventtip" style="display: none" REPLACEALL="Variables.scheduled:target">
					<callelement NAME="OpenMarket/Xcelerate/Admin/Util/EventDetailTable">
						<argument NAME="eventtime" VALUE="scheduledtasks.time"/>
					</callelement>
                </div>
			</td>
			<td></td>
			<td NOWRAP="NOWRAP"><STRING.STREAM VALUE="Variables.scheduled:scheduledby"/></td>
			<td></td>
         </tr>
		 <INCCOUNTER NAME="schCount" VALUE="1"/>
		 <IF COND="Variables.rowStyle=pubTile-row-normal">
				<THEN>
					<SETVAR NAME="rowStyle" VALUE="pubTile-row-highlight"/>
				</THEN>
				<ELSE>
					<SETVAR NAME="rowStyle" VALUE="pubTile-row-normal"/>
				</ELSE>
		</IF>
	 </THEN>
	 </IF>
	 </loop>
</table>
</td>
<td class="tile-dark" VALIGN="top" WIDTH="1"><IMG WIDTH="1" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
	</tr>
	<tr>
		<td colspan="3" class="tile-dark" VALIGN="TOP" HEIGHT="1"><IMG WIDTH="1" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
	</tr>
	<tr>
		<td></td><td background="Variables.cs_imagedir/graphics/common/screen/shadow.gif" REPLACEALL="Variables.cs_imagedir"><IMG WIDTH="1" HEIGHT="5" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td><td></td>
	</tr>
</table>
</td></tr>
<FLUSH LIST="scheduledtasks"/>
</else>
</if>
</table>
<div id="pubsess:TotalScheduled" style="display:none"><STRING.STREAM VALUE="Counters.schCount"/></div>
</body>
</html>
</then></if>
</FTCS>
