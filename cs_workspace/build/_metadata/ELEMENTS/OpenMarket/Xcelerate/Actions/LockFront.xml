<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateC/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/LockFront.xml $ 
$Revision: 28 $ 
$Modtime: 5/09/03 11:44a $ 
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- LockFront.xml
-
- DESCRIPTION
-	Use to lock a content category record
-
- HISTORY 
-->


<!-- 
    Check to see if tracking is enabled on
    the content category. If not, then
    indicate error and get out.

    Check to see if anybody has it locked. If
    current user has it locked, then we're all
    done. If somebody else has it locked, then
    we cannot lock it.
-->
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType"/> 
<STRING.ENCODE VARIABLE="id" VARNAME="id"/> 
<STRING.ENCODE VARIABLE="PrivsFailedReason" VARNAME="PrivsFailedReason"/> 

<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
    <argument NAME="AssetType" VALUE="Variables.AssetType"/>
</callelement>
<if COND="Variables.trackingenabled=true">
    <then>

		 <setvar NAME="assetname" VALUE="theAsset"/>
		 <SETVAR NAME="assetObjectName" VALUE="theAsset"/>
		 <ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Variables.assetObjectName"/>
		 <ASSET.GET NAME="Variables.assetObjectName" FIELD="id" OUTPUT="id"/>

        <callelement NAME="OpenMarket/Xcelerate/Actions/Workflow/CheckPrivs">
            <argument NAME="AssetType" VALUE="Variables.AssetType"/>
    		  <argument NAME="assetObjectName" VALUE="Variables.assetObjectName"/>
            <argument NAME="Function" VALUE="checkout"/>
        </callelement>    
        
        <if COND="Variables.PrivsFailed=true">
        <then>

            <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
                <argument NAME="error" VALUE="Variables.PrivsFailedReason"/>
            </callelement>
        </then>
	  <else>

        <history TABLE="Variables.AssetType" ASSET="Variables.id" LIST="ItsHistory"/>
        <setvar NAME="canlock" VALUE="false"/>
        <if COND="ItsHistory.#numRows=0">
            <then>
                <setvar NAME="canlock" VALUE="true"/>
            </then>
        </if>
        <if COND="ItsHistory.lockedby=Variables.empty">
            <then>
                <setvar NAME="canlock" VALUE="true"/>
            </then>
        </if>
        <!-- check some more -->
        <if COND="Variables.canlock=true">
            <then>
                <!-- this is when we can lock it! -->
                <setvar NAME="errno" VALUE="0"/>
		<ASSET.CHECKOUT OBJECTTYPE="Variables.AssetType" OBJECTID="Variables.id"/>
                <if COND="Variables.errno=0">
                    <then>
			<USERMANAGER.GETLOGINUSERNAME VARNAME="userID"/>
			<IMPLICITCHECKOUT.LOGIMPLICITCHECKOUT ASSETTYPE="Variables.AssetType"
				ASSETID="Variables.id" USER="Variables.userID" FUNCTION="Checkout"/>
                    	<XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/Lock-checkoutSuccess" VARNAME="_xlat_success"/>
                    	<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
							<argument NAME="msgtext" VALUE="Variables._xlat_success"/>
							<argument NAME="severity" VALUE="info"/>
						</callelement>
                    </then>
                    <else>
                        <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
                            <argument NAME="error" VALUE="LockWillFail"/>
                        </callelement>
                    </else>
                </if>
            </then>
            <else>        
                <if COND="ItsHistory.lockedby=SessionVariables.username">
                    <then>
                    	<XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/Lock-alreadyCheckedOut" VARNAME="_xlat_checkedout"/>
                   	<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
							<argument NAME="msgtext" VALUE="Variables._xlat_checkedout"/>
							<argument NAME="severity" VALUE="warning"/>
						</callelement>
                        
                    </then>
                    <else>
                        <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
                            <argument NAME="error" VALUE="OtherLock"/>
                        </callelement>
                    </else>
                </if>
            </else>
        </if>
	</else>
	</if>
    </then>
    <else>
        <!-- lock is going to fail -->
        <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
            <argument NAME="error" VALUE="LockWillFail"/>
        </callelement>
        <BR/>
        <CALLELEMENT NAME="FutureTense/Apps/AdminForms/RevisionMgt/errors"/>
    </else>
</if>

<callelement NAME="OpenMarket/Xcelerate/Actions/ContentDetailsFront">
	<argument NAME="AssetType" VALUE="Variables.AssetType"/>
	<argument NAME="id"        VALUE="Variables.id"/>
</callelement>


</FTCS>
