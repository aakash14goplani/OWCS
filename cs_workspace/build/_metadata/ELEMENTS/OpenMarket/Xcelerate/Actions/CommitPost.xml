<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!--
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/CommitPost.xml $
$Revision: 26 $
$Modtime: 6/10/04 4:01p $
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- CommitPost.xml
-
- DESCRIPTION
-	The back half of the commit operation
-
- HISTORY
-->
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType"/>
<STRING.ENCODE VARIABLE="id" VARNAME="id"/>

<setvar NAME="errno" VALUE="0"/>
<setvar NAME="showDetailsPage" VALUE="true"/>
<setvar NAME="continuelock" VALUE="false"/>
<if COND="Variables.keeplocked=on">
    <then>
        <setvar NAME="continuelock" VALUE="true"/>
    </then>
</if>
<if COND="IsVariable.commitcomment=false">
    <then>
        <setvar NAME="commitcomment" VALUE=" "/>
    </then>
    <else>
	<!-- Make unsafe characters safe again (late fix)
	<substitute STR="Variables.commitcomment" WHAT="%26" WITH=" AND " OUTSTR="commitcomment"/>
	<substitute STR="Variables.commitcomment" WHAT="'"   WITH=" "     OUTSTR="commitcomment"/>
	<substitute STR="Variables.commitcomment" WHAT="%22" WITH=" "     OUTSTR="commitcomment"/>
        No need for this substitution -->
    </else>
</if>
<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Commit-Asset"/>
<ASSET.CHECKIN NAME="Commit-Asset" ANNOTATION="Variables.commitcomment" CHECKOUT="Variables.continuelock"/>
<if COND="Variables.errno=0">
    <then>
		<if COND="Variables.continuelock!=true">
		<then>
			<!-- Remove entry from CheckOutInfo table about implicit checkout. Assume only one entry in the table -->
			<IMPLICITCHECKOUT.CLEARCHECKOUT ASSETTYPE="Variables.AssetType" ASSETID="Variables.id"/>
		</then>
		</if>

		<IF COND="Variables.continuelock=true">
    	<THEN>
    		  <XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/Commit-checkinoutSuccess" VARNAME="_xlat_success"/>
    	     <CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
		        <ARGUMENT NAME="msgtext" VALUE="Variables._xlat_success"/>
		        <ARGUMENT NAME="severity" VALUE="info"/>
		     </CALLELEMENT>
        </THEN>
		<ELSE>
   		  <XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/Commit-checkinSuccess" VARNAME="_xlat_success"/>
    	     <CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
		        <ARGUMENT NAME="msgtext" VALUE="Variables._xlat_success"/>
		        <ARGUMENT NAME="severity" VALUE="info"/>
		     </CALLELEMENT>
		</ELSE>
		</IF>

		<if COND="Variables.cs_environment=portal">
            <then>
                 <setvar NAME="showDetailsPage" VALUE="false"/>
                 <callelement NAME="OpenMarket/Flame/Common/Script/RefreshPortal"/>
            </then>
            </if>
    </then>
    <else>
        <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
            <argument NAME="error" VALUE="CommitFailed"/>
        </callelement>
        <BR/>
        <CALLELEMENT NAME="FutureTense/Apps/AdminForms/RevisionMgt/errors"/>
    </else>
</if>

 <if COND="Variables.showDetailsPage=true">
 <then>
      <callelement NAME="OpenMarket/Xcelerate/Actions/ContentDetailsFront">
 	     <argument NAME="AssetType" VALUE="Variables.AssetType"/>
 	     <argument NAME="id"        VALUE="Variables.id"/>
      </callelement>
 </then>
 </if>

</FTCS>
