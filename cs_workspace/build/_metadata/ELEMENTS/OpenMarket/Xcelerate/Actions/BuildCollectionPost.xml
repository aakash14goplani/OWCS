<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!--
$Logfile: /VerticalApps/XcelerateC/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/BuildCollectionPost.xml $
$Revision: 56 $
$Modtime: 4/08/03 3:17p $
-
- DESCRIPTION
-		updates ranked children list and displays the updated list
- INPUT
-	Variables.upcommand	= cancel or submit
-  Variables.id
-  Variables.AssetType
-	collection	- loaded Collection asset
- OUTPUT
-
-->


<!-- Do the following logic only if the user has chosen to submit the asset (not cancel) -->
<IF COND="Variables.upcommand!=cancel">
<THEN>
 		<HASH.CREATE NAME="refreshHash"/>
     <!-- get the list of children -->
      <ASSET.CHILDREN NAME="collection" LIST="theAssetChildren" CODE="-"/>
 
      <!-- add remove flag to children which are not ranked -->
      <IF COND="IsList.theAssetChildren=true">
      <THEN>
         <LOOP LIST="theAssetChildren">
            <IF COND="IsVariable.Rank-theAssetChildren.oid,theAssetChildren.otype!=true">
            <THEN>
                <SETVAR NAME="Remove-theAssetChildren.oid,theAssetChildren.otype" VALUE="on"/>
            </THEN>
            </IF>
         </LOOP>
      </THEN>
      </IF>

<!-- Update children relations based on standard form values -->
	<SETVAR NAME="doOrder" VALUE="true"/>
	<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/UpdateRelations">
		<ARGUMENT NAME="assetname" VALUE="collection"/>
		<ARGUMENT NAME="prefix" VALUE="Collection"/>
	</CALLELEMENT>

<!-- Update the rank date in the collection -->

	<ASSET.SAVE NAME="collection"/>
	<IF COND="IsError.Variables.errno=true">
	<THEN>
        <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
            <argument NAME="error" VALUE="CollectionOrderFailed"/>
        </callelement>    
   </THEN>
   </IF>
   
   <!-- update the tree display -->
	<HASH.ADD NAME="refreshHash" VALUE="Self:Variables.id"/>
	<HASH.TOSTRING NAME="refreshHash" VARNAME="__TreeRefreshKeys__" DELIM=";"/>
	<PROPERTY.GET PARAM="xcelerate.treeType" INIFILE="futuretense_xcel.ini" VARNAME="proptreetype"/>
	<if COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
   <then>
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype"/>
	</then>
	</if>


	<!-- decide whether to commit and create a new version.
			 If the item was already locked, then no commit is
			 needed. Else commit and ensure that it does not stay
			 locked -->
	<if COND="IsVariable.alreadylocked=true">
		<then>
			<if COND="Variables.alreadylocked!=true">
				<then>
					<XLAT.LOOKUP KEY="dvin/UI/RevisionTracking/VersionbyBuild" VARNAME="_xlat_version"/>
					<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Commit-Asset"/>
					<ASSET.CHECKIN NAME="Commit-Asset" ANNOTATION="Variables._xlat_version" CHECKOUT="false"/>
				</then>
			</if>
		</then>
	</if>
	
</THEN>
<ELSE>
	<!-- If this is a cancel operation, release the implicit checkout (if any) -->	
	<if COND="IsVariable.alreadylocked=true">
		<then>	
			<if COND="Variables.alreadylocked!=true">
				<then>		
					<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Release-Asset"/>
					<ASSET.UNDOCHECKOUT NAME="Release-Asset"/>

				</then>
			</if>
		</then>
	</if>
</ELSE>
</IF><!-- end if upcommand=submit -->
<!-- Remove entry from CheckOutInfo table about implicit checkout. Assume only one entry in the table -->

<IMPLICITCHECKOUT.CLEARCHECKOUT ASSETTYPE="Collection" ASSETID="Variables.id"/>

<SETVAR NAME="AssetType" VALUE="Collection"/>
<callelement NAME="OpenMarket/Xcelerate/Actions/ContentDetailsFront"/>

</FTCS>
