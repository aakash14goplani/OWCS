<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/CopyFront.xml $ 
$Revision: 28 $ 
$Modtime: 8/23/04 6:02p $ 
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- CopyFront.xml
-
- DESCRIPTION
-	Copy a content item
-
- HISTORY 
-->
<callelement NAME="OpenMarket/Gator/Scripts/TabDirtyScript"/>
<STRING.ENCODE VARIABLE="id" VARNAME="id" />
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType" />

<SETVAR NAME="TranslationFlag" VALUE="true"/>
<SETVAR NAME="Copyid" VALUE="Variables.id"/>
<SETVAR NAME="CopyAssetType" VALUE="Variables.AssetType"/>
<IF COND="IsVariable.preselected_dimensionid=true">
<THEN>
<STRING.ENCODE VARIABLE="preselected_dimensionid" VARNAME="preselected_dimensionid" />
<INPUT TYPE="hidden" NAME="preselected_dimensionid" VALUE="Variables.preselected_dimensionid" REPLACEALL="Variables.preselected_dimensionid"/>
</THEN>
</IF>
<IF COND="IsVariable.preselected_dimensiontype=true">
<THEN>
<STRING.ENCODE VARIABLE="preselected_dimensiontype" VARNAME="preselected_dimensiontype" />
<INPUT TYPE="hidden" NAME="preselected_dimensiontype" VALUE="Variables.preselected_dimensiontype" REPLACEALL="Variables.preselected_dimensiontype"/>
</THEN>
</IF>
<INPUT TYPE="hidden" NAME="EditFlag" VALUE="copy"/>     
<INPUT TYPE="hidden" NAME="Copyid" VALUE="Variables.Copyid" REPLACEALL="Variables.Copyid"/>     
<INPUT TYPE="hidden" NAME="CopyAssetType" VALUE="Variables.CopyAssetType" REPLACEALL="Variables.CopyAssetType"/>     

<!-- check for repost of __WORKFLOWPROCID__ -->
<STRING.ENCODE VARIABLE="__WORKFLOWPROCID__" VARNAME="__WORKFLOWPROCID__" />
<STRING.ENCODE VARIABLE="__PARTROLES__" VARNAME="__PARTROLES__" />
<IF COND="IsVariable.__WORKFLOWPROCID__=true">
<THEN>
    <INPUT TYPE="HIDDEN" NAME="__WORKFLOWPROCID__" VALUE="Variables.__WORKFLOWPROCID__" REPLACEALL="Variables.__WORKFLOWPROCID__"/>
    <STRINGLIST NAME="lPartRoles" STR="Variables.__PARTROLES__" DELIM=","/>
    <INPUT TYPE="HIDDEN" NAME="__PARTROLES__" VALUE="Variables.__PARTROLES__" REPLACEALL="Variables.__PARTROLES__"/>
    <LOOP LIST="lPartRoles">
        <SETVAR NAME="currentParticipant" VALUE="Variables.__ROLE__lPartRoles.ITEM__"/>
		<STRING.ENCODE VARIABLE="currentParticipant" VARNAME="currentParticipant" />
        <INPUT TYPE="HIDDEN" NAME="__ROLE__lPartRoles.ITEM__" VALUE="Variables.currentParticipant" REPLACEALL="Variables.currentParticipant,lPartRoles.ITEM"/>
    </LOOP>
</THEN>
<ELSE>
    <IF COND="IsVariable.StartItem=true">
    <THEN>
        <STARTMENU.LOAD ID="Variables.StartItem" OBJVARNAME="si"/>
        <STARTMENUITEM.GETPROCESSES NAME="si" OBJVARNAME="currentProc"/>
        <PROCESSLIST.GETALL NAME="currentProc" VARNAME="__WORKFLOWPROCID__"/>
        <if COND="Variables.__WORKFLOWPROCID__!=Variables.empty">
        <then>
            <WORKFLOWENGINE.CANSTARTWORKFLOW ID="Variables.__WORKFLOWPROCID__" SITE="SessionVariables.pubid" VARNAME="canstartworkflow"/>
            <if COND="Variables.canstartworkflow=true">
            <then>
                <INPUT TYPE="HIDDEN" NAME="__WORKFLOWPROCID__" VALUE="Variables.__WORKFLOWPROCID__" REPLACEALL="Variables.__WORKFLOWPROCID__"/>
                <STARTMENUITEM.GETPARTICIPANTS NAME="si" OBJVARNAME="currentParts"/>
                
                <PARTICIPANTLIST.GETREQUIRED NAME="currentParts" OBJVARNAME="partsList"/>
                <PARTICIPANTS.GETALLROLES NAME="partsList" VARNAME="allRoles"/>
                <IF COND="Variables.allRoles!=Variables.empty">
                <THEN>
                    <INPUT TYPE="hidden" NAME="__PARTROLES__" VALUE="Variables.allRoles" REPLACEALL="Variables.allRoles"/>
                    
                    <STRINGLIST STR="Variables.allRoles" NAME="rlist" DELIM=","/>
                    <LOOP LIST="rlist">
                        <PARTICIPANTS.GETPARTICIPANTSFORROLE NAME="partsList" ROLE="rlist.ITEM" LISTVARNAME="users"/>
                        <HASH.CREATE NAME="uhash" LIST="users" COLUMN="ITEM"/>
                        <HASH.TOSTRING NAME="uhash" VARNAME="postUsers" DELIM=";"/>
                        <INPUT TYPE="hidden" NAME="__ROLE__rlist.ITEM__" VALUE="Variables.postUsers" REPLACEALL="rlist.ITEM,Variables.postUsers"/>
                    </LOOP>
                </THEN>
                </IF>

                <WorkflowEngine.GetProcessID ID="Variables.__WORKFLOWPROCID__" OBJVARNAME="currentProc"/>
                <WorkflowProcess.GetInitialStepID NAME="currentProc" VARNAME="inistepid"/>
                <WorkflowProcess.GetStep NAME="currentProc" VALUE="Variables.inistepid" OBJVARNAME="stepobj"/>
                <WorkflowStep.GetStepType NAME="stepobj" VARNAME="steptype" />
                <IF COND="Variables.steptype=ask">
                <THEN>
                    <SETVAR NAME="cs_StepID" VALUE="Variables.inistepid"/>
                </THEN>
                </IF>

            </then>
            <else>
                <WorkflowEngine.GetProcessID ID="Variables.__WORKFLOWPROCID__" OBJVARNAME="workflow"/>
                <WorkflowProcess.GetProcessName NAME="workflow" VARNAME="workflowname" />
                <setvar NAME="doproceed" VALUE="NoStartWorkflowPriv"/>
            </else>
            </if>
        </then>
        </if>
    </THEN>
    </IF>
</ELSE>
</IF>
<if COND="Variables.doproceed=true">
    <then>
		<!-- Provide standard javascript function that reposts -->
		<SCRIPT TYPE="text/javascript">
			function repostContentForm()
			{
				document.forms[0].pagename.value='OpenMarket/Xcelerate/Actions/NewContentFront';
				document.forms[0].submit();
			}
		</SCRIPT>
		<STRING.ENCODE VARIABLE="PostPage" VARNAME="PostPage" />
		<INPUT type="hidden" name="pagename" value="OpenMarket/Xcelerate/Actions/Variables.PostPage" REPLACEALL="Variables.PostPage"/>

        <ASSET.CREATE TYPE="Variables.AssetType" NAME="copyAssetInstance"/>
        <ASSET.GET NAME="copyAssetInstance" FIELD="id" OUTPUT="id"/>
    	<IF COND="IsError.Variables.errno!=true">
		<THEN>
			<IF COND="IsVariable.id=true">
            <THEN>
                <ASSET.SET NAME="Variables.assetObjectName" FIELD="id" VALUE="Variables.id"/>
            </THEN>
			</IF>
        </THEN>
        </IF>

        <IF COND="IsVariable.cs_StepID=true">
       <THEN>
		<STRING.ENCODE VARIABLE="cs_StepID" VARNAME="cs_StepID" />
           <INPUT TYPE="hidden" NAME="cs_StepID" VALUE="Variables.cs_StepID" REPLACEALL="Variables.cs_StepID"/>
           <INPUT TYPE="hidden" NAME="cs_AlreadyHaveAssignees" VALUE="yes"/>
           <IF COND="IsVariable.cs_AlreadyHaveAssignees=false">
           <THEN>
               <INPUT TYPE="hidden" NAME="id" VALUE="Variables.Copyid" REPLACEALL="Variables.Copyid"/>
               <INPUT TYPE="hidden" NAME="AssetType" VALUE="Variables.AssetType" REPLACEALL="Variables.AssetType"/>
			<STRING.ENCODE VARIABLE="ccsourceid" VARNAME="ccsourceid" />
               <INPUT TYPE="hidden" NAME="ccsourceid" VALUE="Variables.ccsourceid" REPLACEALL="Variables.ccsourceid"/>
               <SETVAR NAME="cs_SavedID" VALUE="Variables.id"/>
               <REMOVEVAR NAME="id"/>
				<STRING.ENCODE VARIABLE="cs_environment" VARNAME="cs_environment" />
				<STRING.ENCODE VARIABLE="cs_formmode" VARNAME="cs_formmode" />
                <CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/SetAssigneesForAskStep">
                    <ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
                    <ARGUMENT NAME="AskStep" VALUE="Variables.cs_StepID"/>
                    <ARGUMENT NAME="workflowid" VALUE="Variables.__WORKFLOWPROCID__"/>
                    <ARGUMENT NAME="cancelpage" VALUE="OpenMarket/Xcelerate/Actions/ShowStartMenuItems"/>
                    <ARGUMENT NAME="cs_environment" VALUE="Variables.cs_environment"/>
                    <ARGUMENT NAME="cs_formmode" VALUE="Variables.cs_formmode"/>
                </CALLELEMENT>
                <SETVAR NAME="id" VALUE="Variables.cs_SavedID"/>
            </THEN>
           <ELSE>
               <!-- repost role selections and call the ContentForm -->
			   <STRING.ENCODE VARIABLE="assigneeroles" VARNAME="assigneeroles" />
               <INPUT TYPE="hidden" NAME="assigneeroles" VALUE="Variables.assigneeroles" REPLACEALL="Variables.assigneeroles"/>
               <STRINGLIST NAME="lAssigneeRoles" STR="Variables.assigneeroles" DELIM="," />
               <LOOP LIST="lAssigneeRoles">
                   <ICS.RESOLVEVARIABLES NAME="$(Variables.ask:$(lAssigneeRoles.ITEM))" DELIMITED="true" OUTPUT="cs_currentRoleVal"/>
				   <STRING.ENCODE VARIABLE="cs_currentRoleVal" VARNAME="cs_currentRoleVal" />
                   <INPUT TYPE="hidden" NAME="ask:lAssigneeRoles.ITEM" VALUE="Variables.cs_currentRoleVal" REPLACEALL="Variables.cs_currentRoleVal,lAssigneeRoles.ITEM"/>
               </LOOP>

               <!-- display assignee selections -->
				<callelement NAME="OpenMarket/Xcelerate/AssetType/Variables.AssetType/ContentForm"/>
				<!-- Check if the tab container was loaded in the call to content form. We already show the assignees in that page. So need to check here before we show it -->
				<if cond="IsVariable.tabContent!=true">
				<then>
					<!-- This should not show up in the definition selection page so make sure that AssocTmpls was not called by checking this list-->
					<if cond="IsList.lAllDefs!=true">
					<then>
						<callelement NAME="OpenMarket/Xcelerate/Actions/Workflow/ShowAssigneeSelectionsBelow"/>
					</then>
					</if>
				</then>
				</if>
				<callelement NAME="OpenMarket/Xcelerate/Actions/Util/InsertStdVariables"/>
           </ELSE>
           </IF>
       </THEN>
       <ELSE>
            <callelement NAME="OpenMarket/Xcelerate/AssetType/Variables.AssetType/ContentForm"/>
			<callelement NAME="OpenMarket/Xcelerate/Actions/Util/InsertStdVariables"/>
       </ELSE>
        </IF>
    </then>
    <else>
	    <STRING.ENCODE VARIABLE="doproceed" VARNAME="doproceed" />
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
            <argument NAME="elem" VALUE="Variables.doproceed"/>
            <argument NAME="severity" VALUE="info"/>
			<argument NAME="assettype" VALUE="Variables.AssetType"/>
			<argument NAME="id" VALUE="Variables.id"/>
        </callelement>
		
		<!-- Display the details page -->
		<callelement NAME="OpenMarket/Xcelerate/Actions/ContentDetailsFront">
			<argument NAME="assettype" VALUE="Variables.AssetType"/>
			<argument NAME="id" VALUE="Variables.id"/>
        </callelement>
		     
    </else>
</if>

</FTCS>

