<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.2">
<!-- OpenMarket/Xcelerate/Actions/Workflow/StepActions/NotifyAllParticipants
-
- INPUT
-
- OUTPUT
-
-->
<!-- This is an action element called by step action NotifyAllParticipants -->

<XLAT.LOOKUP KEY="dvin/UI/Wf/StepActionSendEmailAll" VARNAME="displayMsg" />

<!-- load email object -->
<EMAILMANAGER.LOAD NAME="Variables.emailname" OBJVARNAME="emailobject"/>

<!-- get total assignments -->
<if COND="IsVariable.ObjectTotal=true">
<then>
<setvar NAME="NumOfAssignments" VALUE="Variables.ObjectTotal"/>
</then>
<else>
<setvar NAME="NumOfAssignments" VALUE="0"/>
</else>
</if>

<!-- For each assignment object, get asignee -->
<setcounter NAME="COUNT" VALUE="0"/>
<if COND="Variables.NumOfAssignments!=0">
<then>
	<loop FROM="0" COUNT="Variables.NumOfAssignments">
		<removevar NAME="Step"/>

		<setvar NAME="assignednamesemilist" VALUE="Variables.StepTargetUsersCounters.COUNT"/>
		<stringlist NAME="assignednamelist" STR="Variables.assignednamesemilist" DELIM=";"/>

		<if COND="IsVariable.StepTargetRolesCounters.COUNT=true">
		<then>
			<setvar NAME="assignedrolecommalist" VALUE="Variables.StepTargetRolesCounters.COUNT"/>
			<stringlist NAME="assignedrolelist" STR="Variables.assignedrolecommalist" DELIM=","/>
		</then>
		</if>

		<setvar NAME="assignername" VALUE="Variables.StepUser"/>

		<!-- get assigner -->
		<!-- get assigner's name -->
		<USERMANAGER.GETDISPLAYABLEUSERNAME USER="Variables.assignername" VARNAME="assigner_user_name"/>

		<XLAT.LOOKUP KEY="dvin/UI/Wf/Assignername" VARNAME="assignerNameLabel" />
		<SETVAR NAME="displayMsg" VALUE="Variables.displayMsg %3cbr/%3e Variables.assignerNameLabel: Variables.assigner_user_name" />
		<!-- get asset -->
		<WORKFLOWABLEOBJECT.GETDISPLAYABLENAME OBJECT="ObjectCounters.COUNT" VARNAME="assetname"/>
		<XLAT.LOOKUP KEY="dvin/Common/Object" VARNAME="cobject" />
		<SETVAR NAME="displayMsg" VALUE="Variables.displayMsg %3cbr/%3e Variables.cobject: Variables.assetname" />
		<XLAT.LOOKUP KEY="dvin/UI/Wf/NotSpecified" VARNAME="comment" />
		<if COND="IsVariable.AssignCommentsCounters.COUNT=true">
		<then>
			<setvar NAME="temp" VALUE="Variables.AssignCommentsCounters.COUNT"/>
			<if COND="Variables.temp!=Variables.empty">
			<then>
				<setvar NAME="comment" VALUE="Variables.AssignCommentsCounters.COUNT"/>
			</then>
			</if>
		</then>
		</if>
		<XLAT.LOOKUP KEY="dvin/UI/Wf/actiontotake" VARNAME="actionToTakeLabel" />
		<SETVAR NAME="displayMsg" VALUE="Variables.displayMsg %3cbr/%3e Variables.actionToTakeLabel: Variables.comment %3cbr/%3e" />

		<setvar NAME="listofassignees" VALUE="Variables.empty"/>
		<IF COND="assignednamelist.#numRows!=0">
        <THEN>
        <loop LIST="assignednamelist">
			<setvar NAME="assignedname" VALUE="assignednamelist.ITEM"/>
			<if COND="IsList.assignedrolelist=true">
			<then>
				<gotorow LIST="assignedrolelist" ROWNUM="assignednamelist.#curRow"/>
				<setvar NAME="assignedrole" VALUE="assignedrolelist.ITEM"/>
			</then>
			<else>
				<XLAT.LOOKUP KEY="dvin/UI/Wf/Unimportant" VARNAME="assignedrole" />
			</else>
			</if>

			<!-- info about asignee -->
			<USERMANAGER.GETUSER USER="Variables.assignedname" OBJVARNAME="assigneeobj"/>
			<CCUSER.GETDISPLAYABLENAME NAME="assigneeobj" VARNAME="assigned_user_name"/>
			<setvar NAME="listofassignees" VALUE="Variables.listofassignees, Variables.assigned_user_name"/>
		</loop>  <!-- loop over list of assignees -->

			<substring STR="Variables.listofassignees" INDEX="1" OUTSTR="listofassignees"/>
        </THEN>
        </IF>
            <!-- get a list of participants -->
			<WORKFLOWENGINE.GETOBJECTPARTICIPANTS OBJECT="ObjectCounters.COUNT" OBJVARNAME="myParts"/>
			<PARTICIPANTS.GETALLPARTICIPANTS NAME="myParts" LISTVARNAME="userlist"/>
            <SETVAR NAME="showSubjectBody" VALUE="false"/>
			<if COND="userlist.#numRows!=0">
			<then>
				<loop LIST="userlist">

					<!-- get email address -->
					<USERMANAGER.GETUSER USER="userlist.ITEM" OBJVARNAME="userobj"/>
					<CCUSER.GETDISPLAYABLENAME NAME="userobj" VARNAME="participantname"/>
					<CCUSER.GETEMAIL NAME="userobj" VARNAME="EmailAddress"/>

					
					<IF COND="IsVariable.EmailAddress=true">
					<THEN>
						
					<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Workflow/StepActions/EncodeUtil">
					<ARGUMENT NAME="assignee" VALUE="Variables.listofassignees"/>
					<ARGUMENT NAME="assigneerole" VALUE="Variables.assignedrole"/>
					<ARGUMENT NAME="assigner" VALUE="Variables.assigner_user_name"/>
					<ARGUMENT NAME="assetname" VALUE="Variables.assetname"/>
					<ARGUMENT NAME="instruction" VALUE="Variables.comment"/>
				</CALLELEMENT>
				
						<!-- translate subject -->
						<EMAIL.TRANSLATESUBJECT NAME="emailobject" PARAMS="Variables.paramString" VARNAME="subject" DECODE="true" />

						<!-- translate body -->
						<EMAIL.TRANSLATEBODY NAME="emailobject" PARAMS="Variables.paramString" VARNAME="body" DECODE="true" />

						<!-- send mail -->
                        <MAIL.SEND TO="Variables.EmailAddress" SUBJECT="Variables.subject" BODY="Variables.body" CONTENTTYPE="text/html" />                        
						<XLAT.LOOKUP KEY="dvin/UI/Wf/EmailSentTo" VARNAME="emailSentToLabel" />
						<SETVAR NAME="displayMsg" VALUE="Variables.displayMsg %3cbr/%3e Variables.emailSentToLabel" />					
                        <SETVAR NAME="showSubjectBody" VALUE="true"/>
                    </THEN>
					<ELSE>
						<XLAT.LOOKUP KEY="dvin/UI/Wf/EmailAddressNotAvailable" VARNAME="_XLAT" />
						<SETVAR NAME="displayMsg" VALUE="Variables.displayMsg %3cbr/%3e Variables._XLAT" />
					</ELSE>
					</IF>
				</loop> <!-- loop over list of participants -->
			</then>
			</if>
            <br/>
            <IF COND="Variables.showSubjectBody=true">
            <THEN>
                <XLAT.LOOKUP KEY="dvin/UI/Wf/Translatedsubject" VARNAME="tsubject" />
				<SETVAR NAME="displayMsg" VALUE="Variables.displayMsg %3cbr/%3e Variables.tsubject: %3cbr/%3e Variables.subject" />				
                <XLAT.LOOKUP KEY="dvin/UI/Wf/Translatedbody" VARNAME="tbody" />
				<SETVAR NAME="displayMsg" VALUE="Variables.displayMsg %3cbr/%3e Variables.tbody: %3cbr/%3e Variables.body" />				
            </THEN>
            </IF>

		<inccounter NAME="COUNT" VALUE="1"/>
	</loop> <!-- loop over objects -->
	
	<REMOVEVAR NAME="assignerNameLabel" />
	<REMOVEVAR NAME="tbody" />
	<REMOVEVAR NAME="tsubject" />
	<REMOVEVAR NAME="_XLAT" />
	<REMOVEVAR NAME="emailSentToLabel" />
	<REMOVEVAR NAME="actionToTakeLabel" />
	<REMOVEVAR NAME="cobject" />
</then>
</if>
<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
		<ARGUMENT NAME="severity" VALUE="info"/>
		<ARGUMENT NAME="msgtext" VALUE="Variables.displayMsg"/>
	</CALLELEMENT>
</FTCS>