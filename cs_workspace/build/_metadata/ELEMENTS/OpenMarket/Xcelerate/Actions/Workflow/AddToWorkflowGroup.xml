<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/Workflow/AddToWorkflowGroup.xml $ 
$Revision: 6 $ 
$Modtime: 7/13/04 11:36p $ 
-->
<!-- OpenMarket/Xcelerate/Actions/Workflow/AddToWorkFlowGroup
-
- INPUT
		TreeSelectStr - String from tree with list of assets to add.
		groupid - id of workflow group to which they will be added.-
- OUTPUT
-
-->
	<!--Let's see if we need to ask-->
	<WORKFLOWENGINE.GETGROUPID ID="Variables.groupid" OBJVARNAME="groupobj" />
	<WORKFLOWGROUP.GETWORKFLOWPROCESSID NAME="groupobj" VARNAME="workflowid" />
	<WORKFLOWENGINE.GETPROCESSID ID="Variables.workflowid" OBJVARNAME="workflow"/>
	<WORKFLOWPROCESS.GETINITIALSTEPID NAME="workflow" VARNAME="inistepid"/>
	<WORKFLOWPROCESS.GETSTEP NAME="workflow" VALUE="Variables.inistepid" OBJVARNAME="stepobj"/>
	<WORKFLOWSTEP.GETSTEPTYPE NAME="stepobj" VARNAME="steptype" />

	<SETVAR NAME="needsetassignees" VALUE="true" />

	<IF COND="Variables.steptype!=ask">
		<THEN>
			<SETVAR NAME="needsetassignees" VALUE="false" />
		</THEN>
		<ELSE>
			<IF COND="IsVariable.assigneeroles=true">
				<THEN>
					<SETVAR NAME="needsetassignees" VALUE="false" />
				</THEN>
			</IF>
		</ELSE>
	</IF>

	<IF COND="IsVariable.useDefaultDeadline!=true">
		<THEN>
			<SETVAR NAME="useDefaultDeadline" VALUE="true"/>
		</THEN>
	</IF>

	<!--Here means we don't need to ask-->
	<IF COND="Variables.needsetassignees!=true">
		<THEN>
			<!---Save and restore ID and AssetType since ParseTreeNode clobbers them-->
			<IF COND="IsVariable.ID=true">
				<THEN>
					<SETVAR NAME="SaveID" VALUE="Variables.ID"/>
				</THEN>
			</IF>
			<IF COND="IsVariable.AssetType=true">
				<THEN>
					<SETVAR NAME="SaveAssetType" VALUE="Variables.AssetType"/>
				</THEN>
			</IF>
			<STRINGLIST NAME="ForGroupList" STR="Variables.TreeSelectStr" DELIM=":"/>
			<LOOP LIST="ForGroupList">
				<SETVAR NAME="errno" VALUE="0"/>
				<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/ParseTreeNodeID">
					<ARGUMENT NAME="TreeNodeID" VALUE="ForGroupList.ITEM"/>
				</CALLELEMENT>
				<SETVAR NAME="errno" VALUE="0"/>
				<ISINLIST STR="Variables.SelectedAssets" ITEM="Variables.ID"/>
				<IF COND="Variables.errno=1">
					<THEN>
						<WORKFLOWASSET.LOAD ASSETTYPE="Variables.AssetType" ID="Variables.ID" OBJVARNAME="workflowasset" />
						<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.ID" NAME="theAsset"/>
						<!-- the assetname is used in the message we display when the asset is added to the group -->
						<ASSET.GET NAME="theAsset" FIELD="name" OUTPUT="assetname"/>
						<WORKFLOWENGINE.GETGROUPID ID="Variables.groupid" OBJVARNAME="groupobj" />
						<WORKFLOWGROUP.GETNAME NAME="groupobj" VARNAME="groupname" />
						<WORKFLOWENGINE.CANEDITGROUP ID="Variables.groupid" SITE="SessionVariables.pubid" VARNAME="canAddToGroup" />
						<IF COND="Variables.canAddToGroup=false">
							<THEN>
								<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
									<ARGUMENT NAME="error" VALUE="NoAddToGroupPriv"/>
									<ARGUMENT NAME="groupname" VALUE="Variables.groupname"/>
								</CALLELEMENT>
							</THEN>
							<ELSE>
								<SETVAR NAME="AbortFlag" VALUE="false"/>
								<SETVAR NAME="needUnlock" VALUE="false" />
								<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
									<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
								</CALLELEMENT>
		

								<IF COND="Variables.trackingenabled=true">
									<THEN>
										<ASSET.CHECKOUT OBJECTTYPE="Variables.AssetType" OBJECTID="Variables.ID"/>
										<IF COND="Variables.errno!=0">
											<THEN>
												<HISTORY TABLE="Variables.AssetType" ASSET="Variables.ID" LIST="ItsHistory"/>
												<IF COND="ItsHistory.#numRows!=0">
													<THEN>
														<IF COND="ItsHistory.lockedby!=Variables.empty">
															<THEN>
																<SETVAR NAME="AbortFlag" VALUE="true"/>
																<div class="width-outer-70">
																<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
																	<ARGUMENT NAME="elem" VALUE="CantAddToGroupLocked"/>
																	<ARGUMENT NAME="lockedby" VALUE="ItsHistory.lockedby"/>
																	<ARGUMENT NAME="errorassetname" VALUE="Variables.assetname"/>
																	<ARGUMENT NAME="severity" VALUE="warning"/>
																</CALLELEMENT>
																</div>
															</THEN>
														</IF>
													</THEN>
												</IF>
		

												<IF COND="Variables.AbortFlag!=true">
													<THEN>
														<!-- add to group failed for unknown reason -->
														<SETVAR NAME="AbortFlag" VALUE="true"/>
														<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
															<ARGUMENT NAME="errorassetname" VALUE="Variables.assetname"/>
															<ARGUMENT NAME="error" VALUE="AddToGroupFailed"/>
															<ARGUMENT NAME="groupname" VALUE="Variables.groupname"/>
														</CALLELEMENT>
													</THEN>
												</IF>
											</THEN>
											<ELSE>
												<SETVAR NAME="needUnlock" VALUE="true" />
											</ELSE>
										</IF>
									</THEN>
								</IF>
							
								<!-- Checks for B - prevent assignment to group if already in workflow -->
								<IF COND="Variables.AbortFlag!=true">
									<THEN>
										<WORKFLOWENGINE.ISOBJECTASSIGNEDTOUSER OBJECT="workflowasset" VARNAME="isAssigned"/>
										<IF COND="Variables.isAssigned=true">
											<THEN>
												<SETVAR NAME="AbortFlag" VALUE="true"/>
												<SETVAR NAME="ErrorName" VALUE="WorkflowActive"/>
												<SETVAR NAME="severity" VALUE="info"/>
											</THEN>
										</IF>
									</THEN>
								</IF>

								<!-- If the asset is already assigned to a group, we should not be able to add the asset to group -->

								<IF COND="Variables.AbortFlag!=true">
									<THEN>
										<WORKFLOWENGINE.ISOBJECTASSIGNEDTOGROUP OBJECT="workflowasset" VARNAME="isAssigned"/>
										<IF COND="Variables.isAssigned=true">
											<THEN>
												<SETVAR NAME="AbortFlag" VALUE="true"/>
												<SETVAR NAME="ErrorName" VALUE="WorkflowActive"/>
												<SETVAR NAME="severity" VALUE="info"/>
											</THEN>
										</IF>
									</THEN>
								</IF>
								<!-- end checks for B -->

								<IF COND="Variables.AbortFlag!=true">
									<THEN>
										<IF COND="IsVariable.groupcomment!=true">
											<THEN>
												<setvar NAME="groupcomment" VALUE=""/>
											</THEN>
											<ELSE>
												<!-- Make unsafe characters safe again (late fix) -->
												<SUBSTITUTE STR="Variables.groupcomment" WHAT="%26" WITH=" AND " OUTSTR="groupcomment"/>
												<SUBSTITUTE STR="Variables.groupcomment" WHAT="'" WITH=" " OUTSTR="groupcomment"/>
												<SUBSTITUTE STR="Variables.groupcomment" WHAT="%22" WITH=" " OUTSTR="groupcomment"/>
											</ELSE>
										</IF>
							
		

										<IF COND="IsVariable.assigneeroles=true">
											<THEN>
												<!-- from set assignees for ask step screen -->
												<WORKFLOWASSET.LOAD ASSETTYPE="Variables.AssetType" ID="Variables.ID" OBJVARNAME="workflowasset" />
												<WORKFLOWENGINE.NEWPARTICIPANTS  OBJVARNAME="partobj"/>
												<STRINGLIST NAME="AssigneeRoles" STR="Variables.assigneeroles" DELIM=","/>
												<LOOP LIST="AssigneeRoles">
													<SETVAR NAME="users" VALUE="Variables.ask:AssigneeRoles.ITEM"/>
													<STRINGLIST STR="Variables.users" NAME="userList" DELIM=";"/>
													<LOOP LIST="userList">
														<PARTICIPANTS.ADDPARTICIPANT NAME="partobj" ROLE="AssigneeRoles.ITEM" USER="userList.ITEM"/>
													</LOOP>
												</LOOP>
							

												<IF COND="Variables.useDefaultDeadline=true">
													<THEN>
														<WORKFLOWENGINE.ADDNEWOBJECTTOGROUP OBJECT="workflowasset" ID="Variables.groupid" COMMENT="Variables.groupcomment" SITE="SessionVariables.pubid" ASSIGNMENTLIST="partobj" />
													</THEN>
													<ELSE>
														<WORKFLOWENGINE.ADDNEWOBJECTTOGROUP OBJECT="workflowasset" ID="Variables.groupid" COMMENT="Variables.groupcomment" SITE="SessionVariables.pubid" ASSIGNMENTLIST="partobj" DEADLINE="Variables.deadline" />
													</ELSE>
												</IF>
											</THEN>
											<ELSE>
												<IF COND="Variables.useDefaultDeadline=true">
													<THEN>
														<WORKFLOWENGINE.ADDNEWOBJECTTOGROUP OBJECT="workflowasset" ID="Variables.groupid" COMMENT="Variables.groupcomment" SITE="SessionVariables.pubid" />
													</THEN>
													<ELSE>
														<WORKFLOWENGINE.ADDNEWOBJECTTOGROUP OBJECT="workflowasset" ID="Variables.groupid" COMMENT="Variables.groupcomment" SITE="SessionVariables.pubid" DEADLINE="Variables.deadline" />
													</ELSE>
												</IF>
											</ELSE>
										</IF>
							
										<IF COND="Variables.errno!=0">
											<THEN>
												<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
													<ARGUMENT NAME="error" VALUE="AddToGroupFailed"/>
													<ARGUMENT NAME="errorassetname" VALUE="Variables.assetname"/>
													<ARGUMENT NAME="groupname" VALUE="Variables.groupname"/>
												</CALLELEMENT>
												<REMOVEVAR NAME="error"/>
												<REMOVEVAR NAME="elem"/>
											</THEN>
											<ELSE>
												<ASSETTYPE.LOAD NAME="type" TYPE="Variables.AssetType"/>
												<ASSETTYPE.GET NAME="type" FIELD="description" OUTPUT="ATdesc"/>
												<XLAT.LOOKUP KEY="dvin/UI/AddedToWorkflowGroup" VARNAME="_XLAT_"/>
												<div class="width-outer-70">
												<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
													<ARGUMENT NAME="msgtext" VALUE="Variables._XLAT_"/>
													<ARGUMENT NAME="severity" VALUE="info"/>
												</CALLELEMENT>
												</div>
												<PROPERTY.GET PARAM="xcelerate.treeType" INIFILE="futuretense_xcel.ini" VARNAME="proptreetype"/>
												<IF  COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
													<THEN>
														<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype">
															<ARGUMENT NAME="__TreeRefreshKeys__" VALUE="Self:Variables.groupid"/>
														</CALLELEMENT>
													</THEN>
												</IF>
											</ELSE>
										</IF>
									</THEN>
									<ELSE>
										<!-- error message here if cannot add the asset to the group -->
										<!-- Error: <CSVAR NAME="Variables.ErrorName"/> for id=<CSVAR NAME="Variables.ID"/> -->

									</ELSE>
									
								</IF>
								<IF COND="Variables.needUnlock=true">
									<THEN>
										<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.ID" NAME="Release-Asset"/>
										<ASSET.UNDOCHECKOUT NAME="Release-Asset"/>
									</THEN>
								</IF>
							</ELSE>
						</IF>
					</THEN>
				</IF>
				<REMOVEVAR NAME="elem"/>
				<REMOVEVAR NAME="error"/>
			</LOOP>
			<!-- Save and restore ID and AssetType since ParseTreeNode clobbers them-->
			<IF COND="IsVariable.SaveID=true">
				<THEN>
					<SETVAR NAME="ID" VALUE="Variables.SaveID"/>
				</THEN>
			</IF>
			<IF COND="IsVariable.SaveAssetType=true">
				<THEN>
					<SETVAR NAME="AssetType" VALUE="Variables.SaveAssetType"/>
				</THEN>
			</IF>
		</THEN>
		<!--Here means that we need to ask-->
		<ELSE>
			<IF COND="IsVariable.groupcomment=true">
				<THEN>
					<![CDATA[<INPUT TYPE="HIDDEN" NAME="groupcomment" VALUE="]]><STRING.STREAM VALUE="Variables.groupcomment"/><![CDATA["/>]]>
				</THEN>
			</IF>
			<INPUT TYPE="HIDDEN" NAME="useDefaultDeadline" VALUE="Variables.useDefaultDeadline" REPLACEALL="Variables.useDefaultDeadline"/>
			<IF COND="Variables.useDefaultDeadline!=true" >
				<THEN>
					<INPUT TYPE="HIDDEN" NAME="deadline" VALUE="Variables.deadline" REPLACEALL="Variables.deadline"/>
				</THEN>
			</IF>
	
			<!--Get the first asset from the tree list - ask screen needs one of the assets-->
			<!---Save and restore ID and AssetType since ParseTreeNode clobbers them-->
			<IF COND="IsVariable.ID=true">
				<THEN>
					<SETVAR NAME="SaveID" VALUE="Variables.ID"/>
				</THEN>
			</IF>
			<IF COND="IsVariable.AssetType=true">
				<THEN>
					<SETVAR NAME="SaveAssetType" VALUE="Variables.AssetType"/>
				</THEN>
			</IF>
			<STRINGLIST NAME="ForGroupList" STR="Variables.TreeSelectStr" DELIM=":"/>
			<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/ParseTreeNodeID">
				<ARGUMENT NAME="TreeNodeID" VALUE="ForGroupList.ITEM"/>
			</CALLELEMENT>

			<INPUT TYPE="HIDDEN" NAME="AssetType" VALUE="Variables.AssetType" REPLACEALL="Variables.AssetType"/>
			<STRING.ENCODE VARIABLE="SelectedAssets" VARNAME="SelectedAssets"/>
			<INPUT TYPE="HIDDEN" NAME="SelectedAssets" VALUE="Variables.SelectedAssets" REPLACEALL="Variables.SelectedAssets"/>
			
			<INPUT TYPE="HIDDEN" NAME="id" VALUE="Variables.savelocalid" REPLACEALL="Variables.savelocalid"/>
			<INPUT TYPE="HIDDEN" NAME="groupid" VALUE="Variables.savelocalid" REPLACEALL="Variables.savelocalid"/>
			<INPUT TYPE="HIDDEN" NAME="pagename" VALUE="OpenMarket/Xcelerate/Actions/Variables.ThisPage" REPLACEALL="Variables.ThisPage"/>
			<INPUT TYPE="HIDDEN" NAME="wfpassetlist" VALUE="Variables.wfp:typestypes" REPLACEALL="Variables.wfp:typestypes"/>
			
			<IF COND="IsVariable.TreeSelectStr=true">
				<THEN>
					<STRING.ENCODE VARIABLE="TreeSelectStr" VARNAME="TreeSelectStr"/>
					<INPUT TYPE="HIDDEN" NAME="TreeSelectStr" VALUE="Variables.TreeSelectStr" REPLACEALL="Variables.TreeSelectStr"/>
				</THEN>
				<ELSE>
					<INPUT TYPE="HIDDEN" NAME="TreeSelectStr" VALUE=""/>
				</ELSE>
			</IF>

			<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Workflow/SetGroupAssigneesForAskStep">
				<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
				<ARGUMENT NAME="id"        VALUE="Variables.ID"/>
				<ARGUMENT NAME="AskStep"   VALUE="Variables.inistepid"/>
				<ARGUMENT NAME="groupid"   VALUE="Variables.groupid"/>
				<ARGUMENT NAME="cancelpage" VALUE="OpenMarket/Xcelerate/Actions/Variables.ThisPage"/>
			</CALLELEMENT>
			<SETVAR NAME="calledForAskStep" VALUE="true"/>
			<!---Save and restore ID and AssetType since ParseTreeNode clobbers them-->
			<IF COND="IsVariable.SaveID=true">
				<THEN>
					<SETVAR NAME="ID" VALUE="Variables.SaveID"/>
				</THEN>
			</IF>
			<IF COND="IsVariable.SaveAssetType=true">
				<THEN>
					<SETVAR NAME="AssetType" VALUE="Variables.SaveAssetType"/>
				</THEN>
			</IF>
	

		</ELSE>
	</IF>
</FTCS>
