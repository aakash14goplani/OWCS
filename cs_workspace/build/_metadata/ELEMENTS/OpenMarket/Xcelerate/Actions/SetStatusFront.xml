<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Actions/SetStatusFront
-
- INPUT
-
- OUTPUT
-
-->
<STRING.ENCODE VARIABLE="id" VARNAME="id"/>
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType" />
<STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
<CALLELEMENT NAME="OpenMarket/Xcelerate/Scripts/FormatDate" />
<callelement NAME="OpenMarket/Xcelerate/Util/ClientoffsetInMillis"/>
<SCRIPT LANGUAGE="JavaScript">
var clientOffset = <CSVAR NAME="Variables.clientOffset" />
<![CDATA[

function FinishMyAssignment()
{
   var obj = document.forms[0].elements[0];
   //if not singlestep
   if ((obj.form.elements['ChooseStep'].type) != 'hidden') {

       var cnt = obj.form.elements['ChooseStep'].length;
       var selectcount = 0;
       var selectedindex = 0;
       for (i=0; (i<cnt); i++)
       {
           if (obj.form.elements['ChooseStep'][i].checked)
           {
             selectedindex = i;
             selectcount++;
           }
       }

       if (selectcount==0) {
         ]]>
         alert("<XLAT.STREAM KEY="dvin/UI/Error/YouMustChooseAStepForThisAssignment" ESCAPE="true" ENCODE="false"/>");
         <![CDATA[
         return false;
       }
       if (selectcount>1) {
         ]]>
         alert("<XLAT.STREAM KEY="dvin/UI/Error/Youmaychooseonlyonestepassignment" ESCAPE="true" ENCODE="false"/>");
         <![CDATA[
         return false;
       }
   }
   else
   { //Is single step
   }
   if(obj.form.elements['dosetdeadline'].value=="true")
   {
   if (obj.form.elements['useDefaultDeadline'][1].checked)
   {
        var deadline_date = document.getElementById('deadlineFieldDiv').innerHTML;
        if (deadline_date == "")
        {
            ]]>
            alert("<XLAT.STREAM KEY="dvin/UI/Error/assignmentdeadlineenterednotvaliddate" ESCAPE="true" ENCODE="false"/>");
            <![CDATA[
            return false;
        }

        var now = new Date();
		var cur_date = new Date(now.getTime() + clientOffset + now.getTimezoneOffset()*60*1000 );
        deadlineVal = dateToObject(deadline_date).valueOf();
        if (deadlineVal < cur_date.valueOf())
        {
            ]]>
            alert("<XLAT.STREAM KEY="dvin/UI/Error/AssignmentDeadlineEarlierThanCurrentTime" ESCAPE="true" ENCODE="false"/>");
            <![CDATA[
            return false;
 
        }

        obj.form.elements['deadline'].value = deadlineVal;
   }
   }   
}

function ChangeUserRole()
{
   var obj = document.forms[0].elements[0];

   obj.form.elements['pagename'].value = "OpenMarket/Xcelerate/Actions/SetStatusFront";
   obj.form.submit();
   return false;
}

function reloadThisPage(id)
{
   var obj = document.forms[0].elements[0];
   //keeps track that the step changed, option should change.
   document.getElementById('reloaded').value = "true";
   obj.form.elements['pagename'].value = "OpenMarket/Xcelerate/Actions/SetStatusFront";
   chosenstepid = id
   obj.form.elements['chosenstepid'].value = chosenstepid;
   obj.form.submit();
   return false;
}

function setDefaultDeadline()
{
    var obj = document.getElementById('deadline_div');
    obj.style.visibility="hidden";
}

function setDeadline()
{
    var obj = document.forms[0].elements[0];

    var chosenStep = null;
    //ChooseStep is input form field of either type hidden for single choice, or type radio for multiple choices.
    if ((obj.form.elements['ChooseStep'].type) == 'hidden') {
        chosenStep = "Step0";
    }
    else {
        cnt = obj.form.elements['ChooseStep'].length;
        for (i=0; (i<cnt); i++)
        {
          if (obj.form.elements['ChooseStep'][i].checked) {
            chosenStep = "Step" + i;
            break;
          }
        }

        if (chosenStep == null)
            return;
    }

    if (typeof(obj.form.elements[chosenStep]) != 'undefined') {
        var rel_deadlineVal = parseInt(obj.form.elements[chosenStep].value);
        if (!isNaN(rel_deadlineVal) && rel_deadlineVal > 0) {
            var cur_time = new Date();
            var deadlineVal = cur_time.valueOf() + rel_deadlineVal;
            var deadline = new Date(deadlineVal);

            var jdbcdate = dateToJDBCString(deadline);
            document.getElementById('dField').value = jdbcdate;

            obj.form.elements['pagename'].value = "OpenMarket/Xcelerate/Actions/SetStatusFront";
            obj.form.submit();
        }
        else{
        var obj = document.getElementById('deadline_div');
        obj.style.visibility="visible";
        }
    }
}
]]>
</SCRIPT>
<STRING.ENCODE VARIABLE="deadline" VARNAME="deadline"/>
<STRING.ENCODE VARIABLE="PostPage" VARNAME="PostPage"/>
<setvar NAME="AssetType" VALUE="Variables.AssetType"/>
<setvar NAME="id" VALUE="Variables.id"/>

<WorkflowAsset.Load ASSETTYPE="Variables.AssetType" ID="Variables.id" OBJVARNAME="workflowasset" />

<setvar NAME="doproceed" VALUE="true"/>
<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="theAsset"/>
<ASSET.GET NAME="theAsset" FIELD="name" OUTPUT="assetname"/>
<ASSET.GET NAME="theAsset" FIELD="description" OUTPUT="assetdesc" />
<ASSET.GETASSETTYPE NAME="theAsset" OUTNAME="type"/>
<ASSETTYPE.GET NAME="type" FIELD="description" OUTPUT="atDescription"/>



<IF COND="Variables.AbortFlag!=true">
<THEN>
	<!-- check to see if there is a current active assignment for this user. -->
	<USERMANAGER.GETLOGINUSER VARNAME="theCurrentUserID"/>
	<LISTOBJECT.CREATE NAME="listobj" COLUMNS="ITEM" />
	<LISTOBJECT.ADDROW NAME="listobj" ITEM="Variables.theCurrentUserID" />
	<LISTOBJECT.TOLIST NAME="listobj" LISTVARNAME="userlist" />

	<WorkflowEngine.GetFilteredAssignments OBJECT="workflowasset" ASSIGNEDTO="userlist" NOTSTATUS="notactive" SITE="SessionVariables.pubid" LIMITASSIGNEEROLES="true" PREFIX="workflow_assignments"/>
	<if COND="Variables.workflow_assignmentsTotal=0">
	<then>
		<setvar NAME="AbortFlag" VALUE="true"/>
		<WorkflowEngine.GetFilteredAssignments OBJECT="workflowasset" NOTSTATUS="notactive" SITE="SessionVariables.pubid" LIMITASSIGNEEROLES="true" PREFIX="workflow_assignments"/>
		<if COND="Variables.workflow_assignmentsTotal=1">
		<then>
			<WorkflowAssignment.GetAssignedUserID NAME="workflow_assignments0" VARNAME="workflow_assignedto" />
			<if COND="IsVariable.workflow_assignedto!=true">
			<then>
				<!-- Assigned to everybody -->
				<setvar NAME="AbortFlag" VALUE="false"/>
			</then>
			</if>
		</then>
		</if>

		<if COND="Variables.AbortFlag=true">
		<then>
			<!-- no assignments to this user -->
			<setvar NAME="ErrorName" VALUE="NeedsAssignment"/>         
			<setvar NAME="severity" VALUE="info"/>
		</then>
		</if>
	</then>
	</if>
</THEN>
</IF>

<if COND="Variables.AbortFlag!=true">
<then>

<if COND="IsVariable.assignmentid!=true">
<then>
    <!-- from asset status page -->  
    <WorkflowAssignment.GetID NAME="workflow_assignments0" VARNAME="assignmentid" />
    <SETVAR NAME="assingment_id_Alloy_UI" VALUE="Variables.assignmentid" />
</then>
</if>

<WorkflowEngine.GetAssignmentId OBJVARNAME="assignment" ID="Variables.assignmentid" />
<WorkflowAssignment.GetAssignedUserRole NAME="assignment" VARNAME="assignrole"/>
<WorkflowAssignment.GetStatus NAME="assignment" VARNAME="status" />

<if COND="Variables.status!=active">
<then>
    <if COND="Variables.status=queued">
    <then>
        <XLAT.LOOKUP KEY="dvin/UI/ReVoteMyAssignmentForAsset" VARNAME="_XLAT_"/>
        <setvar NAME="titletext" VALUE="Variables._XLAT_" />
        <XLAT.LOOKUP KEY="dvin/UI/AssignmentAlreadyVoted" VARNAME="_XLAT_"/> 
        <setvar NAME="message" VALUE="Variables._XLAT_" />
        <WORKFLOWASSIGNMENT.GETQUEUEDWORKFLOWSTEPID NAME="assignment" VARNAME="queuedstepid" />
    </then>
    <else>
        <XLAT.LOOKUP KEY="dvin/UI/VoteMyAssignmentForAsset" VARNAME="_XLAT_"/>
        <setvar NAME="titletext" VALUE="Variables._XLAT_" />
        <XLAT.LOOKUP KEY="dvin/UI/YouAbstainedFromVoting" VARNAME="_XLAT_"/>
        <setvar NAME="message" VALUE="Variables._XLAT_" />
        <setvar NAME="queuedstepid" VALUE="Variables.empty" />
    </else>
    </if>
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
        <argument NAME="msgtext" VALUE="Variables.message"/>
        <argument NAME="severity" VALUE="info"/>
    </callelement>               
</then>
<else>
    <XLAT.LOOKUP KEY="dvin/UI/FinishMyAssignmentForAsset" VARNAME="_XLAT_"/>
    <setvar NAME="titletext" VALUE="Variables._XLAT_" />
    <setvar NAME="queuedstepid" VALUE="Variables.empty" />
</else>
</if>

<table class="width-outer-70" cellspacing="0" cellpadding="0" border="0">
	<tr><td>
		<span class="title-text"><STRING.STREAM VALUE="Variables.titletext" /></span>
	</td></tr>
	<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/TitleBar"/>
</table>

<table class="width-outer-70" BORDER="0" CELLSPACING="0" CELLPADDING="0">
    <tr>
        <td class="form-label-text">
            <STRING.STREAM VALUE="Variables.atDescription "/> <XLAT.STREAM KEY="dvin/AT/Common/Name"/>:
        </td>
        <td class="form-inset">
            <STRING.STREAM VALUE="Variables.assetname" />
            <!-- Code for Alloy UI , asset name and desc set in variables and is read by JSP pages -->
			<SETVAR NAME="asset_Name_For_JSP_Template" VALUE="Variables.assetname" />
            <!-- Code for Alloy UI , asset name and desc set in variables and is read by JSP pages -->
        </td>
    </tr>
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
    <tr>
        <td class="form-label-text">
            <XLAT.STREAM KEY="dvin/AT/Common/Description"/>:
        </td>
        <td class="form-inset">
           <STRING.STREAM VALUE="Variables.assetdesc" />
           <!-- Code for Alloy UI , asset name and desc set in variables and is read by JSP pages -->                
           	<SETVAR NAME="asset_Desc_For_JSP_Template" VALUE="Variables.assetdesc" />
			<!-- Code for Alloy UI , asset name and desc set in variables and is read by JSP pages -->
        </td>
    </tr>
    
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
    <tr>
        <td class="form-label-text">
            <XLAT.STREAM KEY="dvin/Common/WorkflowProcess"/>:
        </td>
        <td class="form-inset">
            <WorkflowEngine.GetObjectWorkflowProcess OBJECT="workflowasset" VARNAME="workflowid" />
		  <!-- Code For alloy UI -->
            	<SETVAR NAME="workflowProcessID_AlloyUI" VALUE="Variables.workflowid" />
            <!-- Code For Alloy UI -->
            
            <WorkflowEngine.GetProcessID ID="Variables.workflowid" OBJVARNAME="workflowobj" />
            <WorkflowProcess.GetProcessName NAME="workflowobj" VARNAME="workflowname" />
            <WorkflowAssignment.GetStateID NAME="workflow_assignments0" VARNAME="workflow_stateid" />
            <WorkflowEngine.GetStateID ID="Variables.workflow_stateid" OBJVARNAME="workflow_state" />
            <WorkflowState.GetStateDescription NAME="workflow_state" VARNAME="statedesc" />
		<!-- determine if user is workflowadmin -->
		<setvar NAME="userisworkflowadmin" VALUE="false"/>
		<WorkflowProcess.GetAdminRoles NAME="workflowobj" OBJVARNAME="adminrolesobj"/>
		<ROLELIST.ISALL NAME="adminrolesobj" VARNAME="roleisall"/>
		<!-- roleisall=true means Any role -->
		<if COND="Variables.roleisall=true">
		<then>
			<setvar NAME="userisworkflowadmin" VALUE="true"/>
		</then>
		<else>
			<ROLELIST.GETALL NAME="adminrolesobj" VARNAME="admnroles"/>
			<if COND="Variables.admnroles!=Variables.empty">
			<then>
				<STRINGLIST NAME="rlist" STR="Variables.admnroles" DELIM=","/>
				<loop LIST="rlist">
					<setvar NAME="errno" VALUE="0"/>
					<isinlist STR="SessionVariables.currentpubACLs" ITEM="rlist.ITEM"/>
					<if COND="Variables.errno=1">
					<then>
						<setvar NAME="userisworkflowadmin" VALUE="true"/>
					</then>
					</if>
				</loop>
			</then>
			</if>
		</else>
		</if>
        <STRING.STREAM VALUE="Variables.workflowname" /> - <STRING.STREAM VALUE="Variables.statedesc" />  
       	<!-- Code for alloy UI, workflow process name and state description set in variables and read by JSP page -->
		<SETVAR NAME="workflow_Process_Name_For_JSP_Template" VALUE="Variables.workflowname" />
		<SETVAR NAME="state_Desc_For_JSP_Template" VALUE="Variables.statedesc" />
		<!-- Code for alloy UI, workflow process name and state description set in variables and read by JSP page -->
        </td>
    </tr>
    
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
    <tr>
        <td class="form-label-text">
            <if COND="Variables.workflow_assignmentsTotal=1" >
            <then>
                <XLAT.STREAM KEY="dvin/UI/AssignedUserRole"/>:
            </then>
            <else>
                <span class="alert-color">*</span>
                <XLAT.STREAM KEY="dvin/UI/PickaUserRole"/>:
            </else>
            </if>
        </td>
        <td class="form-inset"> 
			<!-- Code for alloy UI, assigned user role set in variable and read by JSP page -->
			<!-- Create a list object so that the JSP page can simply read from the (ics)list of roles -->
           <SETVAR NAME="number_of_roles_for_assigned_user" VALUE="Variables.workflow_assignmentsTotal" />
           <LISTOBJECT.CREATE NAME="myUserRolesList" COLUMNS="roleName,assignmentID" />
			<!-- Code for alloy UI, assigned user role set in variable and read by JSP page -->

            <if COND="Variables.workflow_assignmentsTotal=1" >
            <then>
                <if COND="IsVariable.assignrole=true" >
                <then>
                    <STRING.STREAM VALUE="Variables.assignrole" />
                    <!-- Code for alloy UI, assigned user role set in variable and read by JSP page -->
					<LISTOBJECT.ADDROW NAME="myUserRolesList" assignmentID="Variables.assingment_id_Alloy_UI" roleName="Variables.assignrole" />
					<!-- Code for alloy UI, assigned user role set in variable and read by JSP page -->
                </then>
                <else>
                    <!-- from keep assign list -->
                    (<XLAT.STREAM KEY="dvin/Common/Unknown"/>)
					<!-- Code for alloy UI, assigned user role set in variable and read by JSP page -->
					<XLAT.LOOKUP KEY="dvin/Common/Unknown" VARNAME="assigned_user_role" />
					<LISTOBJECT.ADDROW NAME="myUserRolesList" assignmentID="Variables.assingment_id_Alloy_UI" roleName="Variables.assigned_user_role" />
					<!-- Code for alloy UI, assigned user role set in variable and read by JSP page -->
                </else>
                </if>
            </then>
            <else> 
                <SELECT NAME="assignmentid" SIZE="1" ONCHANGE="return ChangeUserRole();">
                    <SETCOUNTER NAME="count" VALUE="0"/>
                    <LOOP COUNT="Variables.workflow_assignmentsTotal">
                        <WorkflowAssignment.GetAssignedUserRole NAME="workflow_assignmentsCounters.count" VARNAME="cur_assignrole"/>
                        <WorkflowAssignment.GetID NAME="workflow_assignmentsCounters.count" VARNAME="cur_assignid" />
                        <if COND="Variables.assignmentid=Variables.cur_assignid">
                        <then>
                            <OPTION VALUE="Variables.cur_assignid" SELECTED="yes" REPLACEALL="Variables.cur_assignid" />
                        </then>
                        <else>
                            <OPTION VALUE="Variables.cur_assignid" REPLACEALL="Variables.cur_assignid"/>
                        </else>
                        </if>
                        <STRING.STREAM VALUE="Variables.cur_assignrole"/>
                        <!-- Code for alloy UI, assigned user role set in variable and read by JSP page -->
							<LISTOBJECT.ADDROW NAME="myUserRolesList" roleName="Variables.cur_assignrole" assignmentID="Variables.cur_assignid" />
						<!-- Code for alloy UI, assigned user role set in variable and read by JSP page -->
                        <INCCOUNTER NAME="count" VALUE="1"/>
    		        </LOOP>
                </SELECT>
            </else>
            </if>
            <!-- Code for alloy UI, assigned user role set in variable and read by JSP page -->
       		<!-- Convert the list object so that we can do a ics:listloop in the jsp page -->
       		<LISTOBJECT.TOLIST NAME="myUserRolesList" LISTVARNAME="assigned_User_Roles_List" />
            <!-- Code for alloy UI, assigned user role set in variable and read by JSP page -->   
        </td>
    </tr>
    
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
    <tr>
        <td class="form-label-text">
      		<span class="alert-color">*</span><XLAT.STREAM KEY="dvin/UI/ChooseStepState"/>:
        </td>
        <td class="form-inset">
            <table BORDER="0" CELLSPACING="0" CELLPADDING="0">
			<tr>
                <td>
		    <if COND="IsVariable.assignrole=true">
		    <then>
                        <WorkflowEngine.GetLegalNextWorkflowSteps OBJECT="workflowasset" ROLE="Variables.assignrole" SITE="SessionVariables.pubid" PREFIX="nextsteps" />
		    </then>
		    <else>
                        <WorkflowEngine.GetLegalNextWorkflowSteps OBJECT="workflowasset" SITE="SessionVariables.pubid" PREFIX="nextsteps" />
		    </else>
		    </if>

		    <!-- chosenstepid is the id of the step chosen if more than one steps are possible from a state 
			 See next comment. This variable is set while reposting the page -->
            <setvar NAME="stepdeadlinetype" VALUE="default" /> 
		    <if COND="IsVariable.chosenstepid!=true">
		    <then>
			    <setvar NAME="chosenstepid" VALUE="Variables.empty"/>
                <if COND="Variables.queuedstepid!=Variables.empty">
                <then>
                    <WorkflowEngine.GetStepID ID="Variables.queuedstepid" OBJVARNAME="queuedstepobj" />
                    <WorkflowStep.GetDeadlineType NAME="queuedstepobj" VARNAME="stepdeadlinetype"/>
                </then>
                </if>
		    </then>
            <else>
                <WorkflowEngine.GetStepID ID="Variables.chosenstepid" OBJVARNAME="chosenstepobj" />
                <WorkflowStep.GetDeadlineType NAME="chosenstepobj" VARNAME="stepdeadlinetype"/>
            </else>
		    </if>
			<STRING.ENCODE VARIABLE="chosenstepid" VARNAME="chosenstepid"/>
		    <INPUT TYPE="hidden" NAME="chosenstepid" VALUE="Variables.chosenstepid" REPLACEALL="Variables.chosenstepid"/>
		    
            <if COND="Variables.nextstepsTotal!=0">
            <then>
            				<!-- Code for alloy UI, create a list of step Name - > To State Name for displaying 
            							the list of Possible To States when Finish Assignment is clicked -->
            							
            							<LISTOBJECT.CREATE NAME="list_of_steps_and_states" COLUMNS="stepName,toStateName,stepID,stepType" /> 	
            								
            				<!-- Code for alloy UI -->
                <setcounter NAME="stepcount" VALUE="0"/>
                <loop FROM="0" COUNT="Variables.nextstepsTotal">
                    <setvar NAME="workflow_route" VALUE="nextstepsCounters.stepcount" />
                    <WorkflowStep.GetID NAME="Variables.workflow_route" VARNAME="stepid" />
                    <WorkflowStep.GetName NAME="Variables.workflow_route" VARNAME="stepname" />
                    <WorkflowStep.GetDeadlineType NAME="Variables.workflow_route" VARNAME="deadlinetype"/>
                    <WORKFLOWSTEP.GETSTEPTYPE NAME="Variables.workflow_route" VARNAME="steptype" />

                    <!-- We need deadlinetype of the next step to be taken.
                     If it is ask, the form can contain the deadline part,
                     if user is workflowadmin, or if not, privs allow.
                     Otherwise, the user should not be given a choice to  set deadline for the step.
                     If a single step is possible from a state it is easy. 
                     For more than one steps possible, from a sate, choosing a step will repost the page
                     if the chosen step has different deadline type with the current step's deadline type.
                    -->
                    <if COND="Variables.nextstepsTotal=1">
                    <then>
                        <INPUT TYPE="hidden" NAME="ChooseStep" VALUE="Variables.assignmentid,Variables.stepid,Variables.steptype" REPLACEALL="Variables.assignmentid,Variables.stepid,Variables.steptype" />
                        <setvar NAME="chosenstepid" VALUE="Variables.stepid"/>                        
                        <WorkflowEngine.GetStepID ID="Variables.chosenstepid" OBJVARNAME="chosenstepobj" />
                        <WorkflowStep.GetDeadlineType NAME="chosenstepobj" VARNAME="stepdeadlinetype"/>

                    </then>
                    <else>
                        <if COND="Variables.chosenstepid=Variables.empty">
                        <then>
                            <if COND="Variables.stepid=Variables.queuedstepid">
                            <then>
                                    <INPUT style="margin-left:0px" TYPE="radio" NAME="ChooseStep" CHECKED="true" VALUE="Variables.assignmentid,Variables.stepid,Variables.steptype" REPLACEALL="Variables.assignmentid,Variables.stepid,Variables.steptype"  OnClick="return reloadThisPage(Variables.stepid)" />
                            </then>
                            <else>
                                    <INPUT style="margin-left:0px" TYPE="radio" NAME="ChooseStep" VALUE="Variables.assignmentid,Variables.stepid,Variables.steptype" REPLACEALL="Variables.assignmentid,Variables.stepid,Variables.steptype" OnClick="return reloadThisPage(Variables.stepid)" />
                            </else>
                            </if>
                        </then>
                        <else>
                            <if COND="Variables.stepid=Variables.chosenstepid">
                            <then>
                                    <INPUT style="margin-left:0px" TYPE="radio" NAME="ChooseStep" CHECKED="true" VALUE="Variables.assignmentid,Variables.stepid,Variables.steptype"  REPLACEALL="Variables.assignmentid,Variables.stepid,Variables.steptype" OnClick="return reloadThisPage(Variables.stepid)"/>
                            </then>
                            <else>
                                    <INPUT style="margin-left:0px" TYPE="radio" NAME="ChooseStep" VALUE="Variables.assignmentid,Variables.stepid,Variables.steptype" REPLACEALL="Variables.assignmentid,Variables.stepid,Variables.steptype" OnClick="return reloadThisPage(Variables.stepid)"/>
                            </else>
                            </if>
                        </else>
                        </if>
                    </else>
                    </if>

                    <STRING.STREAM VALUE="Variables.stepname"/> ->
                    <WorkflowStep.GetEndState NAME="Variables.workflow_route" VARNAME="targetstate" />
                    
                    <CALLELEMENT NAME="OpenMarket/Xcelerate/Util/validateFields">
      					<ARGUMENT NAME="columnvalue" VALUE="Variables.targetstate"/>
      					<ARGUMENT NAME="type" VALUE="Long"/>
					</CALLELEMENT>
					
					<ics.getvar name="isDataValid" output="dataValid"/>
					<IF COND="Variables.validatedstatus=false">
  					<THEN>
  						<LOGMSG STR="false"/>
  						<removevar NAME="targetstate" />
 					</THEN>
 					</IF>
					
                    <if COND="IsVariable.targetstate=true">
                    <then>
                         <setvar NAME="tablename" VALUE="WorkflowStatusCode" />
						<CALLELEMENT NAME="OpenMarket/Xcelerate/Util/validateFields">
							<ARGUMENT NAME="columnvalue" VALUE="Variables.targetstate"/>
							<ARGUMENT NAME="type" VALUE="Long"/>
						</CALLELEMENT>
						<IF COND="Variables.validatedstatus=true">
						<THEN>
							<execsql LIST="MyStatusCode" SQL="select description from Variables.tablename where id=Variables.targetstate"/>
						</THEN>
						</IF>

                         <STRING.STREAM VALUE="MyStatusCode.description"/>
                        <!-- Code for Alloy UI -->
						<LISTOBJECT.ADDROW NAME="list_of_steps_and_states" stepName="Variables.stepname" toStateName="MyStatusCode.description" stepID="Variables.stepid" stepType="Variables.steptype"/>
					<!-- Code for Alloy UI -->
                         <removevar NAME="endstate_deadline" />
                         <WorkflowEngine.GetStateID ID="Variables.targetstate" OBJVARNAME="targetobj" />
                         <WorkflowState.GetEstimatedStateTime NAME="targetobj" VARNAME="endstate_deadline" />
                    </then>
                    <else>
                         (<XLAT.STREAM KEY="dvin/UI/nullstate"/>)
                        <!-- Code for Alloy UI -->
                        			<XLAT.LOOKUP KEY="dvin/UI/nullstate" VARNAME="null_state_description"/>
							<LISTOBJECT.ADDROW NAME="list_of_steps_and_states" stepName="Variables.stepname" toStateName="Variables.null_state_description" stepID="Variables.stepid" stepType="Variables.steptype"/>
					<!-- Code for Alloy UI -->
                    </else>
                    </if>
                    <br/>
                    <if COND="IsVariable.endstate_deadline!=true">
                    <then>
                         <setvar NAME="endstate_deadline" VALUE="-1" />
                    </then>
                    </if>
                    
                    <INPUT TYPE="hidden" NAME="StepCounters.stepcount" VALUE="Variables.endstate_deadline" REPLACEALL="Counters.stepcount,Variables.endstate_deadline" />
                    <inccounter NAME="stepcount" VALUE="1"/>    
                </loop>
                		<!-- Code for Alloy UI, convert the list object -->
                				<LISTOBJECT.TOLIST NAME="list_of_steps_and_states" LISTVARNAME="steps_And_States_List" />
                		<!-- Code for Alloy UI, convert the list object -->
            </then>
            <else>
                <XLAT.STREAM KEY="dvin/UI/Accordingworkflowdefnostatechangepossible"/>
                <!-- Code for Alloy UI, no possible state change -->
                		<SETVAR NAME="noStateChangePossible" VALUE="true" />
                <!-- Code for Alloy UI, no possible state change -->
            </else>
            </if>
            </td>
        </tr>
        </table>
        </td>
    </tr>
    
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
    <tr>
        <td class="form-label-text"><XLAT.STREAM KEY="dvin/Common/ActionTaken"/>:</td>
        <td class="form-inset">
            <TEXTAREA NAME="actiontaken" ROWS="6" COLS="60" WRAP="VIRTUAL">
            <if COND="IsVariable.actiontaken=true">
            <then>
                <STRING.STREAM VALUE="Variables.actiontaken" />
            </then>
            </if>
            </TEXTAREA>
        </td>
    </tr>
    
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
    <tr>
        <td class="form-label-text"><XLAT.STREAM KEY="dvin/Common/ActionlctoTake"/>:</td>
        <td class="form-inset">
            <TEXTAREA NAME="actiontotake" ROWS="6" COLS="60" WRAP="VIRTUAL">
            <if COND="IsVariable.actiontotake=true">
            <then>
                <STRING.STREAM VALUE="Variables.actiontotake" />
            </then>
            </if>
            </TEXTAREA>
        </td>
    </tr>


<!-- set deadline presented only if deadlinetype of step is ask. No function privs for this -->
<setvar NAME="dosetdeadline" VALUE="false"/>
<if COND="Variables.stepdeadlinetype=ask">
<then>
    <!-- if deadlinetype is ask, we do not need to check privs if the user is workflow admin -->
    <if COND="Variables.userisworkflowadmin=true">
    <then>
	<setvar NAME="dosetdeadline" VALUE="true"/>
    </then>
    </if>
    <!-- otherwise check privs -->
    <if COND="Variables.dosetdeadline=false">
    <then>
	<!-- Check Function Privs for set process deadline  -->
	<callelement NAME="OpenMarket/Xcelerate/Actions/Workflow/CheckPrivs">
		<argument NAME="AssetType" VALUE="Variables.AssetType"/>
		<argument NAME="assetObjectName" VALUE="theAsset"/>
		<argument NAME="Function" VALUE="setstepdeadline"/>
	</callelement>

	<if COND="Variables.PrivsFailed!=true">
	<then>
		<setvar NAME="dosetdeadline" VALUE="true"/>
	</then>
	</if>
    </then>
    </if>

    <if COND="Variables.dosetdeadline=true">
    <then>
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
    <tr>
        <td class="form-label-text">
     		<span class="alert-color">*</span><XLAT.STREAM KEY="dvin/UI/Common/AssignmentDeadline"/>:
        </td>
        <td class="form-inset" nowrap="nowrap">
               <if COND="Variables.useDefaultDeadline=true">
               <then>
                   <INPUT style="margin-left:0px" TYPE="RADIO" NAME="useDefaultDeadline" VALUE="true" CHECKED="true" OnClick="setDefaultDeadline()" /><XLAT.STREAM KEY="dvin/Common/Usedefault"/>
                   <br/>
                   <INPUT style="margin-left:0px" TYPE="RADIO" NAME="useDefaultDeadline" VALUE="false" OnClick="setDeadline()"/>
                   <setvar NAME="deadline_vis" VALUE="hidden"/>
               </then>
               <else>
                   <INPUT style="margin-left:0px" TYPE="RADIO" NAME="useDefaultDeadline" VALUE="true" OnClick="setDefaultDeadline()" /><XLAT.STREAM KEY="dvin/Common/Usedefault"/>
                   <br/>
                   <INPUT style="margin-left:0px" TYPE="Radio" NAME="useDefaultDeadline" VALUE="false" CHECKED="true" OnClick="setDeadline()"/>
                   <setvar NAME="deadline_vis" VALUE="visible"/>
               </else>
               </if>

               <XLAT.STREAM KEY="dvin/Common/Due"/>
               <IMG WIDTH="4" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/>
				<STRING.ENCODE VARIABLE="dField" VARNAME="dField" />
               <CALLELEMENT NAME="OpenMarket/Xcelerate/Util/GetLocalizedDate">
                    <ARGUMENT NAME="inputDate" VALUE="Variables.dField" />
                    <ARGUMENT NAME="outputVar" VALUE="localizedDeadlineValue" />
               </CALLELEMENT>
               <XLAT.LOOKUP KEY="fatwire/Alloy/UI/PickADate" VARNAME="pickADateString" />
               <span ID="deadline_div" style="visibility:Variables.deadline_vis;" REPLACEALL="Variables.deadline_vis">
				   <STRING.ENCODE VARIABLE="localizedDeadlineValue" VARNAME="localizedDeadlineValue"/>
                   <div id="deadlineFieldId" name="deadlineField" dojoType="fw.dijit.UIInput"  clearButton="true" readonly="true" VALUE="Variables.localizedDeadlineValue" REPLACEALL="Variables.localizedDeadlineValue"></div>
					<DIV ID="deadlineFieldDiv" STYLE="display:none"><ICS.GETVAR NAME="dField"/></DIV>
					<CALLELEMENT NAME="OpenMarket/Xcelerate/Scripts/DateTimeWidget">
						<ARGUMENT NAME="inputFieldId" value="deadlineFieldId"/>
						<ARGUMENT NAME="inputDivId" value="deadlineFieldDiv"/>
					</CALLELEMENT>
				</span>
               <INPUT TYPE="hidden" ID="dField" NAME="dField" VALUE="" REPLACEALL=""/>
        </td>
    </tr>
    </then>
    </if>
</then>
</if><!-- allowedbyprivs -->
		<STRING.ENCODE VARIABLE="PostPage" VARNAME="PostPage"/>
		<INPUT TYPE="hidden" name="pagename" value="OpenMarket/Xcelerate/Actions/Variables.PostPage" REPLACEALL="Variables.PostPage"/>
		<INPUT TYPE="hidden" NAME="id" VALUE="Variables.id" REPLACEALL="Variables.id"/>
		<INPUT TYPE="hidden" NAME="AssetType" VALUE="Variables.AssetType" REPLACEALL="Variables.AssetType"/>
		<INPUT TYPE="hidden" NAME="deadline" VALUE="-1" />
		<STRING.ENCODE VARIABLE="dosetdeadline" VARNAME="dosetdeadline"/>
		<INPUT TYPE="hidden" NAME="dosetdeadline" VALUE="Variables.dosetdeadline" REPLACEALL="Variables.dosetdeadline"/>
		<!-- reloaded is variable to help keep track if this page has been reloaded -->
		<INPUT TYPE="hidden" ID="reloaded" NAME="reloaded" value=""/>
		<!--Code for Alloy UI, tell the JSP whether deadline must be set or not -->
				<SETVAR NAME="do_set_deadline" VALUE="Variables.dosetdeadline" />
		<!--Code for Alloy UI, tell the JSP whether deadline must be set or not -->
		<XLAT.LOOKUP KEY="dvin/UI/Cancel" VARNAME="mouseover" ESCAPE="true"/>
		<XLAT.LOOKUP KEY="dvin/UI/Cancel" VARNAME="_XLAT_"/>
		<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/StatusDetailsFront" outstring="urlstatusdetfront">
			<satellite.argument name="cs_environment" value="Variables.cs_environment"/>
			<satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
		   <satellite.argument name="AssetType" value="Variables.AssetType"/>
		  <satellite.argument name="id" value="Variables.id"/>
		   </SATELLITE.LINK>
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/> 
		<tr><td></td><td>
		<A HREF="Variables.urlstatusdetfront" onmouseover="window.status='Variables.mouseover';return true;" onmouseout="window.status='';return true;"  REPLACEALL="Variables.urlstatusdetfront,Variables.mouseover"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/Cancel"/></CALLELEMENT></A>

		<if COND="Variables.nextstepsTotal!=0">
		<then>
			<XLAT.LOOKUP KEY="dvin/UI/AssetMgt/FinishMyAssignment" VARNAME="mouseover" ESCAPE="true"/>
			<XLAT.LOOKUP KEY="dvin/UI/AssetMgt/FinishMyAssignment" VARNAME="_XLAT_"/>
			<A HREF="javascript:void(0);" OnClick="if(FinishMyAssignment()!=false){document.forms['AppForm'].submit(); return false;}" onmouseover="window.status='Variables.mouseover';return true;" onmouseout="window.status='';return true;" REPLACEALL="Variables.mouseover"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/FinishMyAssignment"/></CALLELEMENT></A>
		</then>
		</if>
		</td></tr>
   
   </table>

</then>

<else> 
	<div class="width-outer-70">
	<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
        <argument NAME="elem" VALUE="Variables.ErrorName"/>
        <argument NAME="severity" VALUE="Variables.severity"/>
    </callelement>
	</div>
    <callelement NAME="OpenMarket/Xcelerate/Actions/StatusDetailsFront">
        <argument NAME="AssetType" VALUE="Variables.AssetType"/>
        <argument NAME="id"        VALUE="Variables.id"/>
    </callelement>    
</else>
</if>

</FTCS>