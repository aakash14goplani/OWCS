<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Actions/AddToGroupFront
-
- INPUT
-
- OUTPUT
-
-->
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType"/>
<STRING.ENCODE VARIABLE="id" VARNAME="id"/>

<CALLELEMENT NAME="OpenMarket/Xcelerate/Scripts/FormatDate" />
<SCRIPT LANGUAGE="JavaScript">
<![CDATA[
function SelectWorkflowGroup(singlegroup) 
{
    var obj = document.forms[0].elements[0];
    
    if (!singlegroup)
    { 
        cnt = obj.form.elements['AddToGroup'].length;
        
        selectcount = 0;
        for (i=0; (i<cnt); i++)
        {
         if (obj.form.elements['AddToGroup'][i].checked)
           selectcount++;
        }
        
        if (selectcount==0) {
         ]]>
         alert("<XLAT.STREAM KEY="dvin/UI/Error/YouMustChooseAGroupForAssignment" ESCAPE="true" ENCODE="false"/>");
         <![CDATA[
         return false;
        }
        if (selectcount>1) {
         ]]>
         alert("<XLAT.STREAM KEY="dvin/UI/Error/Youmaychooseonlyonegroupassignment" ESCAPE="true" ENCODE="false"/>");
         <![CDATA[
         return false;
        }
    }
    if(obj.form.elements['dosetsdeadline'].value=="true")
    {
    if (obj.form.elements['useDefaultDeadline'][1].checked) 
    {
        var deadline_date = document.getElementById('deadlineFieldDiv').innerHTML;
        if (deadline_date == "")
        {
        	]]>
            alert("<XLAT.STREAM KEY="dvin/UI/Error/assignmentdeadlineenterednotvaliddate"/>");
            <![CDATA[
            return false;
        }

        var cur_date = new Date();
        deadlineVal = dateToObject(deadline_date).valueOf();
        if (deadlineVal < cur_date.valueOf())
        {
           ]]>
           alert("<XLAT.STREAM KEY="dvin/UI/Error/assignmentdeadlineearliercurrenttime"/>");
           <![CDATA[
           return false;
 
        }

        obj.form.elements['deadline'].value = deadlineVal;
    }
    }
    return true;
}
function reloadThisPage(id)
{
   var obj = document.forms[0].elements[0];

   obj.form.elements['pagename'].value = "OpenMarket/Xcelerate/Actions/AddToGroupFront";
   obj.form.elements['chosengroupid'].value = id;
   obj.form.submit();
   return false;
}
function setDefaultDeadline()
{
    var obj = document.getElementById('deadline_div');
    obj.style.visibility='hidden';
}
    
function setDeadline()
{
    var obj = document.getElementById('deadline_div');
    obj.style.visibility='visible';
}

]]>
</SCRIPT>

<WorkflowAsset.Load ASSETTYPE="Variables.AssetType" ID="Variables.id" OBJVARNAME="workflowasset" />
<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="theAsset"/>
<ASSET.GET NAME="theAsset" FIELD="name" OUTPUT="assetname"/>
<ASSET.GET NAME="theAsset" FIELD="description" OUTPUT="assetdesc" />
<ASSET.GETASSETTYPE NAME="theAsset" OUTNAME="type"/>
<ASSETTYPE.GET NAME="type" FIELD="description" OUTPUT="atDescription"/>

<setvar NAME="AbortFlag" VALUE="false"/>

<!-- if the asset is checked out by someone, abort -->
<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
    <argument NAME="AssetType" VALUE="Variables.AssetType"/>
</callelement>
<if COND="Variables.trackingenabled=true">
<then>
    <history TABLE="Variables.AssetType" ASSET="Variables.id" LIST="ItsHistory"/>
    <if COND="ItsHistory.#numRows!=0">
    <then>
        <if COND="ItsHistory.lockedby!=Variables.empty">
        <then>
            <SETVAR NAME="AbortFlag" VALUE="true"/>
            <SETVAR NAME="ErrorName" VALUE="CantAddToGroupLocked"/>
            <SETVAR NAME="lockedby" VALUE="ItsHistory.lockedby" />
            <SETVAR NAME="severity" VALUE="info"/>
        </then>
        </if>
    </then>
    </if>
</then>
</if>

<!-- If the asset is already assigned to a user, we should not be able to add the asset to group -->
<if COND="Variables.AbortFlag!=true">
<then>
     <WorkflowEngine.IsObjectAssignedToUser OBJECT="workflowasset" VARNAME="isAssigned"/>
     <if COND="Variables.isAssigned=true">
     <then>
 	<SETVAR NAME="AbortFlag" VALUE="true"/>
	<SETVAR NAME="ErrorName" VALUE="WorkflowActive"/>
	<SETVAR NAME="severity" VALUE="info"/>
     </then>
     </if>
</then>
</if>

<!-- If the asset is already assigned to a group, we should not be able to add the asset to group -->
<if COND="Variables.AbortFlag!=true">
<then>
     <WorkflowEngine.IsObjectAssignedToGroup OBJECT="workflowasset" VARNAME="isAssigned"/>
     <if COND="Variables.isAssigned=true">
     <then>
 	<SETVAR NAME="AbortFlag" VALUE="true"/>
	<SETVAR NAME="ErrorName" VALUE="WorkflowActive"/>
	<SETVAR NAME="severity" VALUE="info"/>
     </then>
     </if>
</then>
</if>

<if COND="Variables.AbortFlag!=true">
<then>
     <WorkflowEngine.GetAvailableGroups PREFIX="groups" />
     <if COND="Variables.groupsTotal=0">
     <then>
          <SETVAR NAME="AbortFlag" VALUE="true"/>
	  <SETVAR NAME="ErrorName" VALUE="NoWorkflowGroups"/>
	  <SETVAR NAME="severity" VALUE="info"/>
     </then>
     </if>
</then>
</if>

<if COND="Variables.AbortFlag!=true">
<then>
    <setcounter NAME="count" VALUE="0"/>
	<setvar NAME="appgroups" VALUE="Variables.empty"/>
	<loop FROM="0" COUNT="Variables.groupsTotal">
		<WorkflowGroup.GetID NAME="groupsCounters.count" VARNAME="groupid" />
		<WorkflowGroup.GetWorkflowProcessID NAME="groupsCounters.count" VARNAME="workflowid" />
		<WorkflowEngine.GetProcessID ID="Variables.workflowid" OBJVARNAME="workflow"/>
		<WorkflowProcess.GetTypes NAME="workflow" OBJVARNAME="typesobj"/>
		<TypeList.GetAllAssetTypes NAME="typesobj" VARNAME="types"/>
		<WorkflowProcess.GetInitialStepID NAME="workflow" VARNAME="inistepid"/>
		<WorkflowProcess.GetStep NAME="workflow" VALUE="Variables.inistepid" OBJVARNAME="stepobj"/>
		<WorkflowStep.GetAuthorizationRoles NAME="stepobj" OBJVARNAME="rolesobj"/>
		<RoleList.GetAll NAME="rolesobj" VARNAME="aroles"/>
		<WorkflowEngine.CanEditGroup SITE="SessionVariables.pubid" ID="Variables.groupid" VARNAME="canedit"/>
		<WorkflowGroup.GetSites NAME="groupsCounters.count" OBJVARNAME="sitesobj"/>
		<SiteList.GetAll NAME="sitesobj" VARNAME="sites"/>
		<stringlist NAME="rolesofcurrentuser" STR="SessionVariables.currentpubACLs" DELIM=","/>

		<!-- If current user can add to this group -->
		<if COND="Variables.canedit=true">
		<then>
			<!-- If this group is for current site -->
			<if COND="SessionVariables.pubid=Variables.sites">
			<then>
				<!-- if the process of this group allows this assettype -->
				<setvar NAME="errno" VALUE="0"/>
				<if COND="IsVariable.types=true">
				<then>
				    <ISINLIST ITEM="Variables.AssetType" STR="Variables.types"/>
				</then>
				<else>
				<!-- workflow is ANY AssetType -->
				<setvar NAME="errno" VALUE="1" />
				</else>
				</if>
				<if COND="Variables.errno=1">
				<then>
					<!-- if roles of curent user can take the statrt step in the process of the group --->
					<setvar NAME="userallowedtotakestep" VALUE="false"/>
					<loop LIST="rolesofcurrentuser">
						<setvar NAME="errno" VALUE="0"/>
						<ISINLIST ITEM="rolesofcurrentuser.ITEM" STR="Variables.aroles"/>
						<if COND="Variables.errno=1">
						<then>
							<setvar NAME="userallowedtotakestep" VALUE="true"/>
						</then>
						</if>	
					</loop>
					<if COND="Variables.userallowedtotakestep=true">
					<then>
						<setvar NAME="appgroups" VALUE="Variables.appgroups,Variables.groupid"/>
					</then>
					</if>
				</then>
				</if>
			</then>
			</if>
		</then>
		</if>
        <inccounter NAME="count" VALUE="1"/>
	</loop>
	<if COND="Variables.appgroups=Variables.empty">
	<then>
		<SETVAR NAME="AbortFlag" VALUE="true"/>
		<SETVAR NAME="ErrorName" VALUE="NoAppropriateWorkflowGroups"/>
		<SETVAR NAME="severity" VALUE="info"/>
	</then>
	<else>
		<substring STR="Variables.appgroups" OUTSTR="appgroups" INDEX="1"/>
		<stringlist NAME="appgroups" STR="Variables.appgroups" DELIM=","/>
	</else>
	</if>
</then>
</if>

<if COND="Variables.AbortFlag!=true">
<then>
<table class="width-outer-70" cellspacing="0" cellpadding="0" border="0">
	<tr><td>
		<span class="title-text"><XLAT.STREAM KEY="dvin/UI/AddWorkflowGroupAssetTypeassetname"/></span>
	</td></tr>
	<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/TitleBar"/>
</table>
    
<!-- Table header -->
<table class="width-outer-50" BORDER="0" CELLSPACING="0" CELLPADDING="0">

	<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
    <tr>
        <td class="form-label-text">
            <XLAT.STREAM KEY="dvin/UI/VariablesAssetTypeName"/>:
        </td>
        <td class="form-inset">
            <STRING.STREAM VARIABLE="assetname" />
        </td>
    </tr>
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
    <tr>
        <td class="form-label-text">
            <XLAT.STREAM KEY="dvin/AT/Common/Description"/>:
        </td>
        <td class="form-inset">
         	<STRING.STREAM VARIABLE="assetdesc" />
        </td>
    </tr>
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
    <tr>
        <td class="form-label-text">
          	<span class="alert-color">*</span><XLAT.STREAM KEY="dvin/Common/AddtoGroup"/>:
        </td>
        
        <td class="form-inset">
    	<!-- chosengroupid is the id of the group selected if more than one groups are possible 
    	 This variable is set while reposting the page -->
    
    	<if COND="IsVariable.chosengroupid!=true">
    	<then>            
            <if COND="appgroups.#numRows=1">
            <then>
                <setvar NAME="chosengroupid" VALUE="appgroups.ITEM" />
            </then>
            <else>
                <setvar NAME="chosengroupid" VALUE="Variables.empty"/>
                <setvar NAME="stepdeadlinetype" VALUE="default" />
            </else>
            </if>
        </then>
        </if> 
        
        <if COND="Variables.chosengroupid!=Variables.empty">
        <then>
            <WorkflowEngine.GetGroupID ID="Variables.chosengroupid" OBJVARNAME="grpobj"/>
            <WorkflowGroup.GetWorkflowProcessID NAME="grpobj" VARNAME="workflowid" />
            <WorkflowEngine.GetProcessID ID="Variables.workflowid" OBJVARNAME="workflow"/>
            <WorkflowProcess.GetProcessName NAME="workflow" VARNAME="workflowname" />
            <WorkflowProcess.getinitialstepid NAME="workflow" VARNAME="startstep"/>
            <WorkflowProcess.getstep NAME="workflow" VALUE="Variables.startstep" OBJVARNAME="startstepobj"/>
            <WorkflowStep.GetDeadlineType NAME="startstepobj" VARNAME="stepdeadlinetype"/>
        </then>
        </if>
        <STRING.ENCODE VARIABLE="chosengroupid" VARNAME="chosengroupidenc"/>
	    <INPUT TYPE="hidden" NAME="chosengroupid" VALUE="Variables.chosengroupidenc" REPLACEALL="Variables.chosengroupidenc"/>

        <loop LIST="appgroups">
            <SETVAR NAME="groupid" VALUE="appgroups.ITEM"/>
            <WorkflowEngine.GetGroupID ID="appgroups.ITEM" OBJVARNAME="grpobj"/>
            <WorkflowGroup.GetName NAME="grpobj" VARNAME="groupname" />
            <WorkflowGroup.GetWorkflowProcessID NAME="grpobj" VARNAME="workflowid" />
            <WorkflowEngine.GetProcessID ID="Variables.workflowid" OBJVARNAME="workflow"/>
            <WorkflowProcess.GetProcessName NAME="workflow" VARNAME="workflowname" />                  
            <STRING.ENCODE VARIABLE="groupid" VARNAME="groupidenc"/>
            <if COND="appgroups.#numRows=1">
            <then>
                <INPUT type="hidden" name="AddToGroup" VALUE="Variables.groupidenc" REPLACEALL="Variables.groupidenc"/>
            </then>
            <else>
                <if COND="Variables.chosengroupid=Variables.groupid">
                <then>
                    <INPUT TYPE="RADIO" NAME="AddToGroup" VALUE="Variables.groupidenc" CHECKED="true" REPLACEALL="Variables.groupidenc"/>
                </then>
                <else>
                    <WorkflowProcess.getinitialstepid NAME="workflow" VARNAME="startstep"/>
                    <WorkflowProcess.getstep NAME="workflow" VALUE="Variables.startstep" OBJVARNAME="strtstpobj"/>
                    <WorkflowStep.GetDeadlineType NAME="strtstpobj" VARNAME="deadlinetype"/>

                    <if COND="Variables.stepdeadlinetype=Variables.deadlinetype">
                    <then>
                        <INPUT TYPE="RADIO" NAME="AddToGroup" VALUE="Variables.groupidenc" REPLACEALL="Variables.groupidenc"/>
                    </then>
                    <else>
                        <INPUT TYPE="RADIO" NAME="AddToGroup" VALUE="Variables.groupidenc"  OnClick="return reloadThisPage(Variables.groupidenc)" REPLACEALL="Variables.groupidenc"/>
                    </else>
                    </if>
                </else>
                </if>

            </else>
            </if>
            <SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/WorkflowGroupDetailsFront" outstring="urlworkdetails">
                <satellite.argument name="cs_environment" value="Variables.cs_environment"/>
                <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
                       <satellite.argument name="id" value="Variables.groupid"/>
                        </SATELLITE.LINK>
            <A HREF="Variables.urlworkdetails" REPLACEALL="Variables.groupid,Variables.urlworkdetails">
            <STRING.STREAM VARIABLE="groupname"/></A><br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<STRING.STREAM VARIABLE="workflowname"/>, 
            
            <WORKFLOWENGINE.GETFILTEREDASSIGNMENTS PREFIX="assignments" NOTSTATUS="notactive" GROUPID="Variables.groupid" EXCLUDECOMMENTS="true"/>
            <if COND="Variables.assignmentsTotal=0">
            <then>
                <XLAT.STREAM KEY="dvin/UI/workflowgroupisempty"/>
            </then>
            <else>
                <WorkflowAssignment.GetStateID NAME="assignments0" VARNAME="workflow_stateid" />
                <WorkflowEngine.GetStateID ID="Variables.workflow_stateid" OBJVARNAME="workflow_state" />
                <WorkflowState.GetStateDescription NAME="workflow_state" VARNAME="statedesc" />
                <XLAT.STREAM KEY="dvin/UI/assignmentsTotalassetinstate"/> <b><STRING.STREAM VALUE="Variables.statedesc"/></b>
            </else>
            </if>
            <br/>
        </loop>
        </td>
    </tr>

    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
    <tr>
        <td class="form-label-text"><XLAT.STREAM KEY="dvin/Common/ActionlctoTake"/>:</td>
        <td class="form-inset">
            <TEXTAREA NAME="groupcomment" ROWS="8" COLS="60" WRAP="VIRTUAL">
            <if COND="IsVariable.groupcomment=true">
            <then>
                <STRING.STREAM VARIABLE="Variables.groupcomment" />
            </then>
            </if>
            </TEXTAREA>
        </td>
    </tr>

    

    <!-- check if deadlinetype of the start step of the process for the group is as -->
    
    <setvar NAME="dosetpdeadline" VALUE="false"/>
    
   <if COND="Variables.stepdeadlinetype=ask">
    <then>
        <setvar NAME="dosetsdeadline" VALUE="true"/>
        <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
		<tr>
        <td class="form-label-text">
          	<span class="alert-color">*</span><XLAT.STREAM KEY="dvin/UI/Common/AssignmentDeadline"/>:
        </td>
        <td class="form-inset" nowrap="nowrap">
            <INPUT TYPE="RADIO" NAME="useDefaultDeadline" VALUE="true" CHECKED="true" OnClick="setDefaultDeadline()" /><XLAT.STREAM KEY="dvin/Common/Usedefault"/>
            <br/>
            <INPUT TYPE="RADIO" NAME="useDefaultDeadline" VALUE="false" OnClick="setDeadline()" />
               
           <XLAT.STREAM KEY="dvin/Common/Due"/>
		   <STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
           <IMG WIDTH="4" HEIGHT="1" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/>

           <XLAT.LOOKUP KEY="fatwire/Alloy/UI/PickADate" VARNAME="pickADateString" />
           <span ID="deadline_div" style="visibility:hidden">
               <div id="deadlineFieldId" name="deadlineField" dojoType="fw.dijit.UIInput"  clearButton="true" readonly="true"></div>
				<DIV ID="deadlineFieldDiv" STYLE="display:none"></DIV>
				<CALLELEMENT NAME="OpenMarket/Xcelerate/Scripts/DateTimeWidget">
					<ARGUMENT NAME="inputFieldId" value="deadlineFieldId"/>
					<ARGUMENT NAME="inputDivId" value="deadlineFieldDiv"/>
				</CALLELEMENT>
			</span>
           <SCRIPT>
                setDefaultDeadline();
           </SCRIPT>
        </td>
        </tr>
    </then>
    </if>    

</table>

<STRING.ENCODE VARIABLE="PostPage" VARNAME="PostPage"/>
<INPUT TYPE="hidden" name="pagename" value="OpenMarket/Xcelerate/Actions/Variables.PostPage" REPLACEALL="Variables.PostPage"/>
<STRING.ENCODE VARIABLE="id" VARNAME="idenc"/>
<INPUT TYPE="hidden" NAME="id" VALUE="Variables.idenc" REPLACEALL="Variables.idenc"/>
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetTypeenc"/>
<INPUT TYPE="hidden" NAME="AssetType" VALUE="Variables.AssetTypeenc" REPLACEALL="Variables.AssetTypeenc"/>
<if COND="IsVariable.dosetsdeadline!=true">
<then>
	<setvar NAME="dosetsdeadline" VALUE="false"/>
</then>
</if>
<STRING.ENCODE VARIABLE="dosetsdeadline" VARNAME="dosetsdeadline"/>
<INPUT TYPE="hidden" NAME="dosetsdeadline" VALUE="Variables.dosetsdeadline" REPLACEALL="Variables.dosetsdeadline"/>

<INPUT TYPE="hidden" NAME="deadline" VALUE="0" />
<XLAT.LOOKUP KEY="dvin/UI/Cancel" VARNAME="_XLAT_" ESCAPE="true"/>
<CALLELEMENT NAME="OpenMarket/Xcelerate/Util/GenerateLink">
	<ARGUMENT NAME="assettype" VALUE="Variables.AssetType"/>
	<ARGUMENT NAME="assetid" VALUE="Variables.id"/>
	<ARGUMENT NAME="varname" VALUE="urlShowStatus"/>
	<ARGUMENT NAME="function" VALUE="status"/>
</CALLELEMENT>
<div class="width-outer-70">
<table><tr><td>
<STRING.ENCODE VARIABLE="urlShowStatus" VARNAME="urlShowStatus"/>
<A HREF="Variables.urlShowStatus" onmouseover="window.status='Variables._XLAT_';return true;" onmouseout="window.status='';return true;"  REPLACEALL="Variables.urlShowStatus,Variables._XLAT_"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/Cancel"/></CALLELEMENT></A>
</td><td>
<if COND="appgroups.#numRows=1">
<then>
    <XLAT.LOOKUP KEY="dvin/UI/AddtoWorkflowGroup" VARNAME="_XLAT_" ESCAPE="true"/>
    <A HREF="javascript:void(0);" OnClick="if(SelectWorkflowGroup(true)!=false){document.forms['AppForm'].submit(); return false;}" onmouseover="window.status='Variables._XLAT_';return true;" onmouseout="window.status='';return true;" REPLACEALL="Variables._XLAT_"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/AddtoGroup"/></CALLELEMENT></A>
</then>
<else>
    <XLAT.LOOKUP KEY="dvin/UI/AddtoWorkflowGroup" VARNAME="_XLAT_" ESCAPE="true"/>
    <A HREF="javascript:void(0);" OnClick="if(SelectWorkflowGroup(false)!=false){document.forms['AppForm'].submit(); return false;}" onmouseover="window.status='Variables._XLAT_';return true;" onmouseout="window.status='';return true;" REPLACEALL="Variables._XLAT_"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/AddtoGroup"/></CALLELEMENT></A>
</else>
</if>
</td></tr></table>
</div>
</then>
<else>
	<div class="width-outer-70">
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
       	<argument NAME="elem" VALUE="Variables.ErrorName"/>
       	<argument NAME="severity" VALUE="Variables.severity"/>
    </callelement>
	</div>
    <callelement NAME="OpenMarket/Xcelerate/Actions/StatusDetailsFront">
    	<argument NAME="AssetType" VALUE="Variables.AssetType"/>
    	<argument NAME="id"        VALUE="Variables.id"/>
    </callelement>
</else>
</if>
</FTCS> 
