<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!--
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/Actions/SetStatusPost.xml $
$Revision: 54 $
$Modtime: 6/10/04 4:31p $
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- SetStatusPost.xml
-
- DESCRIPTION
-	Set the status of an item
-       Required input variables: ChooseStep, id and AssetType, ...more
-
- HISTORY
-->
<STRING.ENCODE VARIABLE="id" VARNAME="id"/>
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType" />
<if COND="IsVariable.useDefaultDeadline!=true">
<then>
	<setvar NAME="useDefaultDeadline" VALUE="true"/>
</then>
</if>
<!-- ChooseStep is in the form, "assignmentid,stepid" -->
<STRING.ENCODE VARIABLE="useDefaultDeadline" VARNAME="useDefaultDeadline"/>
<STRING.ENCODE VARIABLE="deadline" VARNAME="deadline"/>
<STRINGLIST NAME="statustest" STR="Variables.ChooseStep" DELIM=","/>
<SETVAR NAME="assignmentid" VALUE="statustest.ITEM"/>
<SETROW LIST="statustest" ACTION="NEXT"/>
<SETVAR NAME="NextStep" VALUE="statustest.ITEM"/>

<WorkflowEngine.GetStepID ID="Variables.NextStep" OBJVARNAME="stepobj" />
<WorkflowStep.GetStepType NAME="stepobj" VARNAME="steptype" />

<setvar NAME="needsetassignees" VALUE="true" />
<setvar NAME="showDetailsPage" VALUE="true"/>



<if COND="Variables.steptype!=ask">
<then>
     <setvar NAME="needsetassignees" VALUE="false" />
</then>
<else>
    <if COND="IsVariable.assigneeroles=true">
    <then>
         <setvar NAME="needsetassignees" VALUE="false" />
    </then>
    </if>
</else>
</if>

<if COND="Variables.needsetassignees!=true">
<then>

    <callelement NAME="OpenMarket/Xcelerate/Actions/Workflow/CheckCanSetStatus">
         <argument NAME="id" VALUE="Variables.id"/>
         <argument NAME="AssetType" VALUE="Variables.AssetType"/>
         <argument NAME="Step" VALUE="Variables.NextStep"/>
    </callelement>

    <if COND="Variables.foundcheckout=true">
    <then>
		<STRING.ENCODE VARIABLE="lockedby" VARNAME="lockedby"/>
         <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
             <argument NAME="error" VALUE="CantSetStatusLocked"/>
             <argument NAME="AssetType" VALUE="Variables.AssetType"/>
             <argument NAME="lockedby" VALUE="Variables.lockedby"/>
         </callelement>
    </then>
    <else>
          <if COND="IsVariable.assigneeroles=true">
          <then>
                <!-- from set assignees for ask step screen -->
                <WorkflowAsset.Load ASSETTYPE="Variables.AssetType" ID="Variables.id" OBJVARNAME="workflowasset" />
								<!--
                <WORKFLOWENGINE.GETOBJECTPARTICIPANTS OBJECT="workflowasset" OBJVARNAME="partobj"/>
    	        <PARTICIPANTS.CLEAR NAME="partobj"/>
							-->
								<WORKFLOWENGINE.NEWPARTICIPANTS  OBJVARNAME="partobj"/>
			
			<!-- Code modified for Alloy UI -->
			
			<IF COND="IsVariable.isAssigneeRolesAvailable_for_AlloyUI=true">
			<THEN>
					<!-- 
						userRolesList is created in completeFinishAssignment.jsp with data from the Alloy UI
						The list contains a list of roles and the set of users for each role, which are to be
						participants for this asset in the workflow
					-->

					<LOOP LIST="userRolesList">
						<ICS.LISTGET LISTNAME="userRolesList" FIELDNAME="roleName" output="myRole" />
						<ICS.LISTGET LISTNAME="userRolesList" FIELDNAME="userID" output="myUser" />
						<PARTICIPANTS.ADDPARTICIPANT NAME="partobj" ROLE="Variables.myRole" USER="Variables.myUser"/>
					</LOOP>

			</THEN>
			<ELSE>
               		<stringlist NAME="AssigneeRoles" STR="Variables.assigneeroles" DELIM=","/>
                		<LOOP LIST="AssigneeRoles">
               	     	<SETVAR NAME="users" VALUE="Variables.ask:AssigneeRoles.ITEM"/>
                    		<STRINGLIST STR="Variables.users" NAME="userList" DELIM=";"/>
                    		<LOOP LIST="userList">
                         		<PARTICIPANTS.ADDPARTICIPANT NAME="partobj" ROLE="AssigneeRoles.ITEM" USER="userList.ITEM"/>
                    		</LOOP>
                		</LOOP>
			</ELSE>
			</IF>
			
                <if COND="IsVariable.actiontotake=false">
                <then>
                    <setvar NAME="actiontotake" VALUE="Variables.empty"/>
                </then>
                </if>

                <if COND="IsVariable.actiontaken=false">
                <then>
                    <setvar NAME="actiontaken" VALUE="Variables.empty"/>
                </then>
                </if>

                <if COND="Variables.useDefaultDeadline=true">
                <then>

                    <WorkflowEngine.CompleteAssignment ID="Variables.assignmentid"
                       SITE="SessionVariables.pubid"
                       ACTION="Variables.actiontaken"
                       COMMENT="Variables.actiontotake"
                       NEXTSTEP="Variables.NextStep"
                       ASSIGNMENTLIST="partobj"
                       VARNAME="condcheckfailreason" />
                </then>
                <else>

                    <WorkflowEngine.CompleteAssignment ID="Variables.assignmentid"
                       SITE="SessionVariables.pubid"
                       ACTION="Variables.actiontaken"
                       COMMENT="Variables.actiontotake"
                       NEXTSTEP="Variables.NextStep"
                       DEADLINE="Variables.deadline"
                       ASSIGNMENTLIST="partobj"
                       VARNAME="condcheckfailreason" />
                </else>
                </if>
          </then>
          <else>

              <!-- if there is a comment, use it -->
              <if COND="IsVariable.actiontotake=false">
              <then>
                   <setvar NAME="actiontotake" VALUE="Variables.empty"/>
              </then>
              </if>
	
              <if COND="IsVariable.actiontaken=false">
              <then>
                    <setvar NAME="actiontaken" VALUE="Variables.empty"/>
              </then>
              </if>

              <if COND="Variables.useDefaultDeadline=true">
              <then>


                    <WorkflowEngine.CompleteAssignment ID="Variables.assignmentid"
                       SITE="SessionVariables.pubid"
                       ACTION="Variables.actiontaken"
                       COMMENT="Variables.actiontotake"
                       NEXTSTEP="Variables.NextStep"
                       VARNAME="condcheckfailreason" />
              </then>
              <else>

                    <WORKFLOWENGINE.COMPLETEASSIGNMENT ID="Variables.assignmentid"
                       SITE="SessionVariables.pubid"
                       ACTION="Variables.actiontaken"
                       COMMENT="Variables.actiontotake"
                       NEXTSTEP="Variables.NextStep"
                       DEADLINE="Variables.deadline"
                       VARNAME="condcheckfailreason" />
              </else>
              </if>
          </else>
          </if>

    
		<div class="width-outer-70">
        <if COND="Variables.errno=0">
        <then>
            <if COND="IsVariable.condcheckfailreason!=true">
            <then>
                <!-- workflow complete success -->
                <XLAT.LOOKUP KEY="dvin/UI/Assignmentcompletedsuccessfully" VARNAME="_XLAT_"/>
                <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                    <argument NAME="msgtext" VALUE="Variables._XLAT_"/>
                    <argument NAME="severity" VALUE="info"/>
                </callelement>
    
                <if COND="Variables.cs_environment=portal">
                <then>
                    <setvar NAME="showDetailsPage" VALUE="false"/>
                    <callelement NAME="OpenMarket/Flame/Common/Script/RefreshPortal"/>
                </then>
                </if>
				<if COND="Variables.cs_environment=ucform">
				<then>
					<SCRIPT TYPE="text/javascript">
						dojo.addOnLoad(function(){
							SitesApp.notifyModelUpdate('workflowStatus');
						});
					</SCRIPT>
				</then>
				</if>
            </then>
            <else>
                <!-- condition check failure prevented complete success -->
                <XLAT.LOOKUP KEY="dvin/UI/Admin/Conditiondoesnotallowthisstep" VARNAME="_XLAT_"/>
                <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                    <argument NAME="msgtext" VALUE="Variables._XLAT_"/>
                    <argument NAME="severity" VALUE="info"/>
                </callelement>
            </else>
            </if>
        </then>
        <else>
            <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                <argument NAME="elem" VALUE="CompleteAssignmentFailed"/>
                <argument NAME="severity" VALUE="error"/>
            </callelement>
        </else>
        </if>
        </div>
    </else>
    </if>

    <IF COND="Variables.showDetailsPage=true">
    <THEN>
    	   <callelement NAME="OpenMarket/Xcelerate/Actions/StatusDetailsFront">
            <argument NAME="AssetType" VALUE="Variables.AssetType"/>
            <argument NAME="id"        VALUE="Variables.id"/>
    	   </callelement>
    </THEN>
    </IF>
</then>
<else>
    <if COND="IsVariable.actiontotake=true">
    <then>
	<!-- passing the variable inside CDATA to preserve special characters.-->
        <![CDATA[<INPUT TYPE="hidden" NAME="actiontotake" VALUE="]]><STRING.STREAM VALUE="Variables.actiontotake"/><![CDATA["/>]]>
    </then>
    </if>

    <if COND="IsVariable.actiontaken=true">
    <then>
        <!-- needs to encode comment before placing in input field -->
        <STRING.ENCODE VARNAME="actiontaken" VARIABLE="actiontaken"/>
        <INPUT TYPE="hidden" NAME="actiontaken" VALUE="Variables.actiontaken" REPLACEALL="Variables.actiontaken"/>
    </then>
    </if>

    <INPUT TYPE="hidden" NAME="ChooseStep" VALUE="Variables.assignmentid,Variables.NextStep" REPLACEALL="Variables.assignmentid,Variables.NextStep"/>
    <INPUT TYPE="hidden" NAME="useDefaultDeadline" VALUE="Variables.useDefaultDeadline" REPLACEALL="Variables.useDefaultDeadline"/>
    <if COND="Variables.useDefaultDeadline!=true" >
    <then>
        <INPUT TYPE="hidden" NAME="deadline" VALUE="Variables.deadline" REPLACEALL="Variables.deadline"/>
    </then>
    </if>

    <INPUT type="hidden" name="pagename" value="OpenMarket/Xcelerate/Actions/SetStatusPost" />
    <INPUT TYPE="hidden" NAME="id" VALUE="Variables.id" REPLACEALL="Variables.id"/>
	<INPUT TYPE="hidden" NAME="AssetType" VALUE="Variables.AssetType" REPLACEALL="Variables.AssetType"/>

    <callelement NAME="OpenMarket/Xcelerate/Actions/SetAssigneesForAskStep">
    	<argument NAME="AssetType" VALUE="Variables.AssetType"/>
    	<argument NAME="id"        VALUE="Variables.id"/>
        <argument NAME="AskStep"   VALUE="Variables.NextStep"/>
    </callelement>

</else>
</if>

</FTCS>