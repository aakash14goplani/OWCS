<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Actions/Util/MakeSubtypeList
-
- INPUT
- Variables.AssetType
- Variables.Prefix
- Variables.fieldvalue
- Variables.subtypeslistexists - if it exists then the caller has generated the subtypes list
- OUTPUT
- If there is more than one subtype for this asset type and the subtype field
- is not filled in, display a list of subtypes to choose
-->
<SCRIPT LANGUAGE="JavaScript">
<![CDATA[
function refreshTemplateList( subtypefieldval, templatefield)
{
 	var tempObj = document.forms[0].elements[0];
	var templateWidget = dijit.getEnclosingWidget(templatefield);
	var selectedtemplate = templateWidget.get('value');	
	var tlistfield = "templates-" + subtypefieldval;
	var tlist = tempObj.form.elements[tlistfield].value;
	var templates = tlist.split(",");
	var dropDownData = [];
	selectTemplate = templateWidget.store.root;
	selectTemplate.length = 0;
	templateWidget.reset();
	for ( var i = 0; i < templates.length ; i++ ) {
			if ( templates[i]=="") {
				var notemplate = ]]>"<XLAT.STREAM KEY="dvin/UI/Util/Notemplatesavailable" ESCAPE="true" ENCODE="false"/>"<![CDATA[;
				selectTemplate.options[i] = new Option( notemplate, templates[i], false, false);
			}
			else {
				var tname = templates[i].split(';');
				selectTemplate.options[i] = new Option( tname[0], tname[0], false, tname[0] == selectedtemplate ? true : false);
				if(tname[0] == selectedtemplate)
					templateWidget.set('item', selectTemplate.options[i]);
			}
	}
	templateWidget.reset();
	return false;
}
]]>
</SCRIPT>


<IF COND="IsVariable.Prefix=true">
<THEN>
	<SETVAR NAME="Fieldname" VALUE="Variables.Prefix:subtype"/>
</THEN>
<ELSE>
	<SETVAR NAME="Fieldname" VALUE="subtype"/>
</ELSE>
</IF>

<if COND="IsVariable.subtypeslistexists=false">
<then>
	<setvar NAME="list" VALUE="subtypes"/>
	<ASSET.GetLegalSubtypes TYPE="Variables.AssetType" LIST="subtypes" PUBID="SessionVariables.pubid"/>
</then>
</if>
<if COND="IsList.subtypes=true">
<then>
	<if COND="subtypes.#numRows!=0">
	<then>
		<!-- if this is a new asset with an empty subtype field, set the value so that the subtype will be the first in the list-->
		<if COND="Variables.fieldvalue=Variables.empty">
		<then>
			<ASSET.ISNEW NAME="theCurrentAsset" VARNAME="isNew"/>
			<if COND="Variables.isNew=true">
			<then>
 				<SETVAR NAME="fieldvalue" VALUE="subtypes.subtype"/>
 			</then>
 			</if>
		</then>
		</if>
		<SELECT NAME="Variables.Fieldname" dojoType="fw.dijit.UISimpleSelect" showErrors="false" SIZE="1" REPLACEALL="Variables.Fieldname,Variables.Prefix" onChange="refreshTemplateList(this.get('value'), document.forms[0].elements['Variables.Prefix:template'])">
			<if COND="Variables.defaultFormStyle=true">
			<then>
				<script event='startup' type='dojo/connect'><![CDATA[
					dojo.addClass(this.domNode, "defaultFormStyle");
				]]></script>
			</then>
			</if> 
			<loop LIST="subtypes">
				<if COND="Variables.fieldvalue=subtypes.subtype">
				<then>
					<OPTION VALUE="subtypes.subtype" REPLACEALL="subtypes.subtype" SELECTED="true"/>
				</then>
				<else>
					<OPTION VALUE="subtypes.subtype" REPLACEALL="subtypes.subtype"/>
				</else>
				</if>
				<if COND="subtypes.subtype=Variables.empty">
				<then>
					<XLAT.STREAM KEY="dvin/UI/Util/Standardnosubtype"/>
				</then>
				<else>
					<if COND="IsColumn.subtypes.description=true">
					<then>
						<STRING.STREAM LIST="subtypes" COLUMN="description"/>
					</then>
					<else>
						<STRING.STREAM LIST="subtypes" COLUMN="subtype"/>
					</else>
					</if>
				</else>
				</if>
			</loop>
		</SELECT>

		<!-- Create hidden fields containing templates for each subtype so that if user changes subtype,
				we can present a new list of possible templates -->
		<if COND="subtypes.#numRows!=1">
		<then>
			<LOOP LIST="subtypes">
				<setvar NAME="varname" VALUE="templatesForsubtypes.subtype"/>
				<TEMPLATEMANAGER.GetTemplateNames LISTVARNAME="Templates" ASSETTYPES="Variables.AssetType" SUBTYPE="subtypes.subtype" PUBID="SessionVariables.pubid" EXCLUDEVARIANTS="true" TTYPE="l"/>
				<if COND="IsError.Variables.errno=false">
				<then>
					<if COND="Templates.#numRows!=0">
					<then>
					<LOOP LIST="Templates">
						<if COND="Templates.#curRow=1">
						<then>
							<SETVAR NAME="Variables.varname" VALUE="Templates.tname;Templates.name"/>
						</then>
						<else>
							<SETVAR NAME="Variables.varname" VALUE="Variables.Variables.varname,Templates.tname;Templates.name"/>
						</else>
						</if>
					</LOOP>
				</then>
				<else>
					<SETVAR NAME="Variables.varname" VALUE="Variables.empty"/>
				</else>
				</if>
				</then>
				<else>
					<SETVAR NAME="Variables.varname" VALUE="Variables.empty"/>
				</else>
				</if>
				<setvar NAME="templates" VALUE="Variables.Variables.varname"/>
				<INPUT TYPE="HIDDEN" NAME="templates-subtypes.subtype" VALUE="Variables.templates" REPLACEALL="subtypes.subtype,Variables.templates"/>
			</LOOP>
		</then>
		</if>
	</then>
	</if>
</then>
</if>
</FTCS>
