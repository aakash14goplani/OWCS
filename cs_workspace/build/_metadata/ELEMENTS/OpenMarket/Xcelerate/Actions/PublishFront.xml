<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- OpenMarket/Xcelerate/Actions/PublishFront.xml
-
- DESCRIPTION
-	Publish Front Page
-
- INPUT
-
-      Variables.target -- target id
-
-->
<STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
<STRING.ENCODE VARIABLE="target" VARNAME="target"/>
<!-- Continue only if conditions from prologactions are satisfied -->
<if COND="Variables.doproceed=true">
<then>
 <SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/PublishConsoleFront" outstring="urlpubconsfront">
     <satellite.argument name="cs_environment" value="Variables.cs_environment"/>
     <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
 </SATELLITE.LINK>
                                                            
 <SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/PublishConsoleFront" outstring="urlpubpost">
     <satellite.argument name="cs_environment" value="Variables.cs_environment"/>
     <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
     <satellite.argument name="target" value="Variables.target"/>
	 <satellite.argument name="startPublishing" value="true"/>
 </SATELLITE.LINK>
<SCRIPT LANGUAGE="JavaScript">
<replaceall LIST="Variables.urlpubconsfront,Variables.urlpubpost">
<![CDATA[

function CancelHandler()
{ ]]>
    <if cond="Variables.cs_environment=portal">
    <then>
        window.close();
    </then>
    <else>
        var pURL = "Variables.urlpubconsfront";
        parent.frames['XcelAction'].location=pURL;
    </else>
    </if> <![CDATA[
    return false;
}

function setCheck(form)
{
       ]]>
   if (confirm("<XLAT.STREAM KEY="dvin/UI/Publish/AboutToPublish" ESCAPE="true" ENCODE="false"/>")) {
   <![CDATA[
        var pURL = "Variables.urlpubpost";
            ]]>
            <if cond="Variables.cs_environment=portal">
            <then>
                window.location=pURL;
            </then>
            <else>
                parent.frames['XcelAction'].location=pURL;
            </else>
            </if><![CDATA[
     }

    return false;
}

]]>

</replaceall>
</SCRIPT>

<setvar NAME="AbortFlag" VALUE="false"/>
<PUBTARGETMANAGER.LOAD ID="Variables.target" OBJVARNAME="pubtgt"/>
<if COND="IsError.Variables.errno=true">
<then>
    <P><XLAT.STREAM KEY="dvin/UI/Error/loadpublishingtargeterrno" errno="Variables.errno" target="Variables.target" EVALALL="false"/>
    </P>
    <setvar NAME="AbortFlag" VALUE="true"/>
</then>
<else>
	<PUBTARGET.SCATTER NAME="pubtgt" PREFIX="pubtgt:"/>
	<PUBTARGET.GETFACTORS NAME="pubtgt" VARNAME="pubtgt:factors"/>
	<PUBTARGET.UNPACK NAME="pubtgt" PREFIX="pubtgt:" FIELD="factors"/>
</else>
</if>

<if COND="Variables.AbortFlag!=true">
<then>
  <DELIVERYTYPE.LOAD NAME="pubdt" OBJECTID="Variables.pubtgt:type"/>
    <if COND="IsError.Variables.errno=true">
    <then>
        <P><XLAT.STREAM KEY="dvin/UI/Error/loadpublishingdeliverytypeerrno" errno="Variables.errno" typeid="Variables.pubtgt:type" EVALALL="false"/>
        </P>
	    <setvar NAME="AbortFlag" VALUE="true"/>
    </then>
    <else>
		  <DELIVERYTYPE.GET NAME="pubdt" FIELD="path" OUTPUT="pubdt:path"/>
		  <DELIVERYTYPE.GET NAME="pubdt" FIELD="name" OUTPUT="pubdt:name"/>
		  <DELIVERYTYPE.GET NAME="pubdt" FIELD="dtype" OUTPUT="pubdt:dtype"/>
  </else>
	</if>
</then>
</if>

<PUBTARGETMANAGER.CANEDIT ID="Variables.target"/>
<if COND="Variables.errno=-12034">
<then>
	<setvar NAME="publishIsRunning" VALUE="true"/>
	<XLAT.LOOKUP KEY="dvin/UI/publishisrunning" VARNAME="_XLAT_"/>
    <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
       <argument NAME="msgtext" VALUE="Variables._XLAT_"/>
       <argument NAME="severity" VALUE="info"/>
   </callelement>  
</then>
</if>

<IF COND="IsElement.Variables.pubdt:path/PublishFront=true">
<THEN>	
	<CALLELEMENT NAME="Variables.pubdt:path/PublishFront"/>
</THEN>
<ELSE>
	<table class="width-outer-70" border="0" cellpadding="0" cellspacing="0">
	
		<tr>
			<td><span class="title-text"><XLAT.STREAM KEY="dvin/UI/Publishdestination"/>:  </span><span class="title-value-text"><STRING.STREAM VALUE="Variables.pubtgt:name"/></span></td>
		</tr>
	
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/TitleBar">
			<argument NAME="SpaceBelow" VALUE="No"/>
		</callelement>
	
		<tr>
		<td>
		
		<table border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td NOWRAP="NOWRAP" class="form-label-text"><XLAT.STREAM KEY="dvin/Common/Destination"/>:</td>
			<td><img height="1" width="5" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
			<td class="form-inset"><XLAT.STREAM KEY="dvin/UI/Publish/pubtgtnameusingpubdtname"/></td>
		</tr>
	
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
		<tr>
			<td class="form-label-text"><XLAT.STREAM KEY="dvin/Common/Arguments"/>:</td>
			<td><img height="1" width="5" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
			<td class="form-inset"><STRINGLIST   NAME="factorsList" STR="Variables.pubtgt:factors" DELIM="%26"/>
				<loop LIST="factorsList">
					<INDEXOF STR="factorsList.ITEM" WHAT="EMAILIDS" OUTSTR="index" INDEX="0"/>
					<IF COND="Variables.errno=0">
						<THEN>
						<span><STRING.STREAM VALUE="factorsList.ITEM"/><BR/></span>
						</THEN>
					</IF>
				</loop>
			</td>
		</tr>
	
		<tr>
		<td colspan="2"><BR/></td>
		<td>
		
		<if COND="Variables.AbortFlag!=true">
		<then>
		     <PROPERTY.GET PARAM="xcelerate.batchhost" INIFILE="futuretense_xcel.ini" VARNAME="batchhost"/>
		     <if COND="Variables.batchhost=Variables.empty">
		     <then>
		          <P><XLAT.STREAM KEY="dvin/UI/Error/notfoundxceleratepropertybatchhost"/>
		          </P>
		          <setvar NAME="AbortFlag" VALUE="true"/>
		     </then>
		     </if>
		</then>
		</if>
		
		<!-- default publish front assumes a mirror-type model (oneasset-one publish key) for approval -->
		<if COND="Variables.AbortFlag!=true">
		<then>
		    <CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Publish/HeldPublishableAssets">
				<ARGUMENT NAME="target" VALUE="Variables.target"/>
				<ARGUMENT NAME="targettype" VALUE="mirror"/>
				<ARGUMENT NAME="allowLinks" VALUE="true"/>
			</CALLELEMENT>
		</then>
		</if>
		
		</td></tr>
		    
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/FooterBar"/>
		<SETVAR NAME="errno" VALUE="0"/>
		<USERISMEMBER GROUP="xcelpublish"/>
		<IF COND="Variables.errno=1">
		<THEN>
		<tr>
			<td colspan="2"><BR/></td>
			<td align="left">
				<SETVAR NAME="errno" VALUE="0"/>
				<USERISMEMBER GROUP="xceladmin"/>
				<IF COND="Variables.errno=1">
				<THEN>	
			<satellite.link assembler="query" pagename="OpenMarket/Xcelerate/Admin/Publish/DestEdit" outstring="urlConfdest">
				<satellite.argument name="action" value="details"/>
				<satellite.argument name="cs_environment" value="Variables.cs_environment"/>
	            <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
	            <satellite.argument name="id" value="Variables.pubtgt:id"/>
			</satellite.link>
			<A HREF="Variables.urlConfdest" REPLACEALL="Variables.urlConfdest"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/ConfigureDestination_"/></CALLELEMENT></A>
			<img height="1" width="20" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/>
			<satellite.link assembler="query" pagename="OpenMarket/Xcelerate/Admin/Publish/PublishEventEdit" outstring="urlConfSch">
				<satellite.argument name="action" value="edit"/>
				<satellite.argument name="target" value="Variables.pubtgt:id"/>
				<satellite.argument name="cs_environment" value="Variables.cs_environment"/>
	            <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>                                 
			</satellite.link>
			<A HREF="Variables.urlConfSch" REPLACEALL="Variables.urlConfSch"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/EditPublishSchedule_"/></CALLELEMENT></A>
			</THEN>
			</IF>
			<if COND="Variables.AbortFlag!=true">
		      <then>
		            <if COND="Variables.publishIsRunning!=true">
		            <then>
		            	<if COND="Variables.PublishableAssetsCount!=0">
		            	<then>
		                 <img height="1" width="20" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/>
		                 <XLAT.LOOKUP KEY="dvin/UI/Publish" VARNAME="_XLAT_" ESCAPE="true"/>
		                 <A HREF="javascript:void(0)" onclick="return setCheck(document.forms[0]);" onmouseover="window.status='Variables._XLAT_';return true;" onmouseout="window.status='';return true;" REPLACEALL="Variables._XLAT_"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/Publish"/></CALLELEMENT></A>
		                 </then>
		            	</if>
		            </then>
		            </if>
		      </then>
		      </if>
			  <img height="1" width="20" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/>
			  <XLAT.LOOKUP KEY="dvin/UI/CancelPublish" VARNAME="_XLAT_" ESCAPE="true"/>
			<A HREF="javascript:void(0)" onclick="return CancelHandler()" onmouseover="window.status='Variables._XLAT_';return true;" onmouseout="window.status='';return true;" REPLACEALL="Variables._XLAT_"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/Cancel"/></CALLELEMENT></A>
		   </td>
		</tr>
		</THEN>
		</IF>
	
		</table>
		</td>
		</tr>
	</table>
</ELSE>
</IF>
<satellite.link pagename="OpenMarket/Xcelerate/PrologActions/Publish/AdvPub/PublishingStatController" assembler="query" outstring="pubStatcontrollerURL">
	<satellite.argument name="target" value="Variables.target"/>
	<satellite.argument name="action" value="getPubTargetStatus"/>
</satellite.link>
<replaceall list="CS.Property.ft.cgipath,Variables.pubdt:dtype,Variables.pubStatcontrollerURL,Variables.cs_imagedir">
<script type="text/javascript" src="CS.Property.ft.cgipathjs/prototype.js"></script>
<script type="text/javascript">
<![CDATA[
    var invokeIntervalId = 0;
	function init(){
		getTargetStatus();
		invokeIntervalId = setInterval(function() {getTargetStatus()},5000);
	}
	
	function getTargetStatus(){
		if('Variables.pubdt:dtype' == 'mirror' || 'Variables.pubdt:dtype' == 'realtime' ){
			new Ajax.Request('Variables.pubStatcontrollerURL',{
			method: 'get'});
		}
	}
	
	function updateStatus(req){
		var _targetStatusElm = document.getElementById('_targetStatus');
		if(req.readyState == 4){
			var targetStatus = req.responseText.evalJSON();
			if(targetStatus.pubTargetStatus.status){
				_targetStatusElm.src = "Variables.cs_imagedir/graphics/common/icon/available.gif";
				_targetStatusElm.title = ']]><XLAT.STREAM KEY="dvin/Common/Success" ENCODE="false" ESCAPE="true"/><![CDATA[';
			} else {
				_targetStatusElm.src = "Variables.cs_imagedir/graphics/common/icon/unavailable.gif";
				_targetStatusElm.title = ']]><XLAT.STREAM KEY="dvin/Common/Connection/Error" ENCODE="false" ESCAPE="true"/><![CDATA[';
				var unknownCreds = ']]><XLAT.STREAM KEY="dvin/UI/Invalidusernameorpassword" ENCODE="false" ESCAPE="true"/><![CDATA[';
				if (targetStatus.pubTargetStatus.msg == 'Unknown  username/password.')//ftMessage.noUser
				{
					_targetStatusElm.title = unknownCreds;
				}
			}
		} else{
			_targetStatusElm.src = "Variables.cs_imagedir/graphics/common/icon/unavailable.gif";
			_targetStatusElm.title = ']]><XLAT.STREAM KEY="dvin/Common/NetworkDownRetrying" ENCODE="false" ESCAPE="true"/><![CDATA[';
		}
	}
	
	function callIsActive (xmlhttp)
	{
        switch (xmlhttp.readyState)
        {
                  case 1: case 2: case 3:
                      return true;
                      break;
                  // Case 4 and 0
                  default:
                      return false;
                      break;
        }
	}

	function TimeOutCheck(request)
	{
		// If we have hit the timeout and the AJAX request is active, abort it and let the user know
		if (callIsActive(request.transport))
		{
           request.transport.abort();
           updateStatus(request.transport);
		}
	} 

	// Register global responders that will occur on all AJAX requests
	Ajax.Responders.register(
	{
        onCreate: function(request)
        {
            request['timeoutId'] = window.setTimeout(function () { TimeOutCheck(request); }, 2000); //Two Seconds
        },
        onComplete: function(request)
        {
            // Clear the timeout, the request completed ok
            window.clearTimeout(request['timeoutId']);
			updateStatus(request.transport);
		}
	}); 
	
	window.onload=init;
]]>
</script>
</replaceall>
</then></if>
</FTCS>
