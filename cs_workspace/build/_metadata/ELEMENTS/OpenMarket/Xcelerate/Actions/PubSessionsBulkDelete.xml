<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Actions/PubSessionsBulkDelete
-
- INPUT
-        Variables.id -- pubsession id 
-
- OUTPUT
-
-->
<STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
<!-- Continue only if conditions from prologactions are satisfied -->
<if COND="Variables.doproceed=true">
<then>
<div id="loading" style="width:200px;height:100px;position:absolute; top: 350px;left: 320px;" bgcolor="white">
<table width="100%" height="100%" cellspacing="0" cellpadding="0" bgcolor="#ffffff" align="center" style="border: 1px solid rgb(204,204,204);">
<tbody>
<tr>
<td valign="middle" align="center">
<img src="Variables.cs_imagedir/graphics/common/icon/wait_ax.gif" REPLACEALL="Variables.cs_imagedir"/>
<br/>
<br/>
<b>
<span id="loadingMsg"><XLAT.STREAM KEY="dvin/UI/Executing"/></span>
<img src="Variables.cs_imagedir/graphics/common/icon/short_Progress.gif" REPLACEALL="Variables.cs_imagedir"/>
</b>
<a id="hider2" style="cursor: pointer; text-decoration: underline;"/>
</td>
</tr>
</tbody>
</table>
</div>
<script type="text/javascript">
<![CDATA[
 var ld=(document.all);
  var ns4=document.layers;
 var ns6=document.getElementById&&!document.all;
 var ie4=document.all;
 if (ns4)
 	ld=document.loading;
 else if (ns6)
 	ld=document.getElementById("loading").style;
 else if (ie4)
 	ld=document.all.loading.style;
  function init()
 {
 if(ns4){ld.visibility="hidden";}
 else if (ns6||ie4) ld.display="none";
 }
 window.onload=init;
 ]]>
 </script>
<PUBTARGETMANAGER.FIND PREFIX="pbt" PUBID="SessionVariables.pubid" FILTERFORPUBLISH="true"/>
<PUBSESSIONMANAGER.GETALLFINISHED PREFIX="pubsess:" TARGETSARRAYPREFIX="pbt"/>
<if COND="IsVariable.ignoreErrors=false">
<then>
	<SETVAR NAME="ignoreErrors" VALUE="false"/>
</then>
</if>
<if COND="Variables.pubsess:Total=0">
<then>
     <!--Nothing to delete..This condition Should never get executed as this should be handled in the Publishing console.-->
</then>
<else>
<SETCOUNTER NAME="nthSession" VALUE="0"/>
<LOOP COUNT="Variables.pubsess:Total">
<PUBSESSION.GETID NAME="pubsess:Counters.nthSession" VARNAME="id"/>
<PUBSESSIONMANAGER.LOAD ID="Variables.id" OBJVARNAME="pubsess"/>
<if COND="IsError.Variables.errno=false">
<then>    
    <!-- delete the publish output file -->
    <PublishClient.Flush ID="Variables.id" />
    <PUBSESSION.GETSTARTDATE NAME="pubsess" VARNAME="publishdate" />
    <PUBSESSION.GETUSER NAME="pubsess" VARNAME="publishedby" />
    <PUBSESSION.GETTARGET NAME="pubsess" VARNAME="targetid" />
   <!-- get target name -->
 	 <PUBTARGETMANAGER.LOAD ID="Variables.targetid" OBJVARNAME="pubtgt"/>
	 <PUBTARGET.GETNAME NAME="pubtgt" VARNAME="pubtgt:name"/>

    <!-- delete the row from PubSession table -->
    <PUBSESSIONMANAGER.Delete ID="Variables.id" IGNOREERRORS="Variables.ignoreErrors"/>
    <if COND="IsError.Variables.errno=false">
    <then>
        
        <table cellpadding="0" cellspacing="0" border="0" class="width-outer-70">
        <tr>
            <td><XLAT.LOOKUP KEY="dvin/UI/Publish/PublishSessionDeletedSuccess" VARNAME="_XLAT_"/>
                <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                    <argument NAME="msgtext" VALUE="Variables._XLAT_"/>
                    <argument NAME="severity" VALUE="info"/>
                </callelement>
            </td>
        </tr>
        
        <tr>
            <td>
                <table cellpadding="0" cellspacing="0" border="0">
                <tr>
                    <td class="form-label-text"><XLAT.STREAM KEY="dvin/Common/Destination"/>:</td>
                    <td><img height="1" width="5" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
                    <td class="form-inset"><STRING.STREAM VALUE="Variables.pubtgt:name"/></td>
                </tr>       
                
                <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
                <tr>
                    <td class="form-label-text"><XLAT.STREAM KEY="dvin/UI/PublishTime"/>:</td>
                    <td><img height="1" width="5" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
                    <td class="form-inset">
                	<DATEFORMAT.GETDATETIME NAME="_FormatDate_" VALUE="Variables.publishdate" VALUETYPE="jdbcdate"  VARNAME="publishdate"/>
                    <STRING.STREAM VALUE="Variables.publishdate"/></td>
                </tr>
                
                <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
                <tr>
                    <td class="form-label-text"><XLAT.STREAM KEY="dvin/AT/Common/Status"/>:</td>
                    <td></td>
                    <td class="form-inset"><span class="alert-color"><XLAT.STREAM KEY="dvin/Common/Deleted"/></span></td>
                </tr>
                
                <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacer"/>
                <tr>
                    <td class="form-label-text"><XLAT.STREAM KEY="dvin/Common/Publishedby"/>:</td>
                    <td><img height="1" width="5" src="Variables.cs_imagedir/graphics/common/screen/dotclear.gif" REPLACEALL="Variables.cs_imagedir"/></td>
                    <td class="form-inset"><STRING.STREAM VALUE="Variables.publishedby"/></td>
                </tr>
                <!--<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/RowSpacerBar"/>-->       
                </table>
                
            </td>
        </tr>
        </table>
    </then>
    </if>
</then>
</if>     

<if COND="IsError.Variables.errno=true">
<then>
    <if COND="Variables.errno=-12047">
	<THEN>
		<SETVAR NAME="forceDelete" VALUE="true"/>
		<table cellpadding="0" cellspacing="0" border="0" class="width-outer-70" style="margin-top:0;">
		<tr>
			<td>  
				<XLAT.LOOKUP KEY="dvin/UI/Publish/PublishSessionDeleteRemoteFailure" ENCODE="false" VARNAME="_XLAT_"/>
				<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					<argument NAME="msgtext" VALUE="Variables._XLAT_"/>
					<argument NAME="severity" VALUE="error"/>
				</callelement>
			</td>
		</tr>
    </table>
	</THEN>
	<ELSE>
	<table cellpadding="0" cellspacing="0" border="0" class="width-outer-70">
    <tr>
        <td>  
            <XLAT.LOOKUP KEY="dvin/UI/Publish/PublishSessionDeletedFail" VARNAME="_XLAT_"/>
            <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                <argument NAME="msgtext" VALUE="Variables._XLAT_"/>
                <argument NAME="severity" VALUE="error"/>
            </callelement>
        </td>
    </tr>
    </table>
	</ELSE>
	</if>
</then>
<else>
    <if cond="Variables.cs_environment=portal">
    <then>
        <callelement NAME="OpenMarket/Flame/Common/Script/RefreshPortal"/>
    </then>
    </if>
</else>
</if>
<INCCOUNTER NAME="nthSession" VALUE="1"/>
</LOOP>
</else>
</if>
<if cond="Variables.pubsess:Total=0">
<then>
<table cellpadding="0" cellspacing="0" border="0" class="width-outer-70">
    <tr>
        <td>  
            <XLAT.LOOKUP KEY="dvin/UI/Publish/PublishSessionUnavailable" VARNAME="_XLAT_"/>
            <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
                <argument NAME="msgtext" VALUE="Variables._XLAT_"/>
                <argument NAME="severity" VALUE="info"/>
            </callelement>
        </td>
    </tr>
    </table>
</then>
</if>
<table class="width-outer-70"><tr><td align="left">
<if cond="Variables.forceDelete=true">
<then>
<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/PubSessionsBulkDelete" outstring="urlBulkRemPubSess">
	<satellite.argument name="cs_environment" value="Variables.cs_environment"/>
	<satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
	<satellite.argument name="ignoreErrors" value="true"/>
</SATELLITE.LINK>
<IMG src="Variables.cs_imagedir/graphics/common/icon/doubleArrow.gif" REPLACEALL="Variables.cs_imagedir"/><A HREF="Variables.urlBulkRemPubSess" REPLACEALL="Variables.urlBulkRemPubSess" onClick="return confirmForceDelete();"><b><XLAT.STREAM KEY="dvin/UI/Publish/ForceDelete"/></b></A>
</then>
</if>
</td><td align="right">
<IMG src="Variables.cs_imagedir/graphics/common/icon/doubleArrow.gif" REPLACEALL="Variables.cs_imagedir"/>
<if cond="Variables.cs_environment=portal">
<then>
    <a HREF="javascript:void(0);" onclick="window.close();">
    <b><XLAT.STREAM KEY="dvin/UI/GotoPublishConsole"/></b></a>
</then>
<else>
    <SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/PublishConsoleFront" outstring="urlpubconsfront">
        <satellite.argument name="cs_environment" value="Variables.cs_environment"/>
        <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
    </SATELLITE.LINK>
    <A HREF="Variables.urlpubconsfront" REPLACEALL="Variables.urlpubconsfront">
    <b><XLAT.STREAM KEY="dvin/UI/GotoPublishConsole"/></b></A>
</else>
</if>
</td>
</tr>
</table>
<script type="text/javascript">
<![CDATA[
	function confirmForceDelete(){
	]]>
		if(confirm("<XLAT.STREAM KEY="dvin/UI/Publish/ForceDeleteAllPublishSessionsConfirmation" ESCAPE="true" ENCODE="false"/>"))
		<![CDATA[
		{
			return true;
		}
		else
		{
		return false;
		}
    }
]]>
</script>
</then></if>
</FTCS> 
