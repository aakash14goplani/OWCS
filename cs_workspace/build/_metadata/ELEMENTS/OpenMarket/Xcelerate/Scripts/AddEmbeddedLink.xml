<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Scripts/AddEmbeddedLink
-
- INPUT
-
- OUTPUT
-
-->


<!--
	Script used for Ewebedit pro attribute editor. It is included here so that it can be used for both basic assets and flex assets.		
-->
<![CDATA[
<script language="JavaScript1.2">
	function pasteInEwebeditPro(link , fieldname) 
	{
		var ewebeditor = eWebEditPro.instances[fieldname].editor;							
		ewebeditor.pasteHTML(link);
	}


	function getSel(txtAreaElementName,editingStyle) {
		if(typeof(editingStyle) ==='undefined')
			editingStyle='single';
		if ('single' == editingStyle)
			if(navigator.userAgent.toLowerCase().indexOf('msie') != -1){
				var mytextrange = document.selection.createRange();
				return mytextrange.text //for IE
			} else {
				return getSelForSingleValue(txtAreaElementName);
			}
		else 
			return getSelForMultiValue(txtAreaElementName);
	}
	

	function getSelForSingleValue(txtAreaElementName) 
	{
		var txtarea = document.getElementsByName(txtAreaElementName).item(0);
		var selStart = txtarea.selectionStart;
		var selEnd = txtarea.selectionEnd;
		return (txtarea.value).substring(selStart, selEnd);
	}

	
	function getSelForMultiValue(txtAreaElementName) 
	{
		console.group('[getSelForMultiValue]: ', arguments);
						
		var node = null;
		var reqDijit = null;
	
		reqDijit = dijit.byId(txtAreaElementName);

		console.debug('reqDijit: ', reqDijit);
		console.groupEnd();
		return getSelectedValue(reqDijit);
	}
	
	function getSelectedValue(reqDijit) {
		console.group('[getSelectedValue]: ', arguments);
		var reqVal = '';
		console.debug('reqDijit.editorName: ', reqDijit.editorName);
		if (reqDijit.editor.containerNode) {
			var cNode = reqDijit.editor.containerNode;
			reqVal = reqDijit.editor.get('value');
			
			if (document.selection && document.selection.createRange )
			{ // IE support
				return document.selection.createRange().text;
			} else {
				return reqVal.substring(cNode.selectionStart, cNode.selectionEnd);
			}
		}
		console.groupEnd();
		return reqVal;
	}
		
</script>
]]>
<if COND="Variables.showSiteTree=true">
<then>

<SCRIPT LANGUAGE="JavaScript">

<![CDATA[

function _isEditorOfMultiVal (multiValAttrEditorId, attrName) {
	var reqDijit = dijit.byId(multiValAttrEditorId);
	if (!reqDijit) return false;
	if (attrName === reqDijit.get('attrName')) return true;
	
	return false;
}

function addEmbeddedLink(assetname, AssetType, fieldname, fielddesc, embedtype, isEWebEditPro, editingStyle, attrName)
{ 
   var EncodedString = parent.frames["XcelTree"].document.TreeApplet.exportSelections()+'';
   if(typeof(editingStyle) ==='undefined')
		editingStyle='single';
   
   if ( EncodedString!=null )
   {
	   var idArray = EncodedString.split(',');
	   var assetcheck = unescape(idArray[0]);
	   if (assetcheck.indexOf('assettype=')!=-1 && assetcheck.indexOf('id=')!=-1)
	   {
	       var test = new String(EncodedString);
	       var nameVal = test.split(",");
	       if (nameVal.length!=2) {
	           ]]>
	           alert("<XLAT.STREAM KEY="dvin/UI/PleaseSelectAssetFromTree" ESCAPE="true" ENCODE="false"/>");
	           <![CDATA[
	           return false;
	       }

	       var treeid = unescape(nameVal[0]);
	       var splitid = treeid.split(',');
	       if (splitid.length==1)
	       {
	           ]]>
	           alert("<XLAT.STREAM KEY="dvin/UI/PleaseSelectAssetFromTree" ESCAPE="true" ENCODE="false"/>");
	           <![CDATA[
	           return false;
	       }

	       var splitpair = splitid[0].split("=");
	       var tn_id = splitpair[1];
	       splitpair = splitid[1].split("=");
	       var tn_AssetType = splitpair[1];
	       if (isEWebEditPro) {
	           // using eWebEditPro
			  
			  
			   var selectedHTML = eWebEditPro.instances[fieldname].editor.getSelectedHTML();
			   if ( selectedHTML == "") {
				
	               ]]>
	               alert("<XLAT.STREAM KEY="dvin/UI/PleaseSelectLinkTextFrom" ESCAPE="true" ENCODE="false"/>".replace('Variables.assetType',AssetType).replace('Variables.fielddesc',fielddesc));
	               <![CDATA[
	               return false;

	           } else
			   {			   
			    var selectedHTMLhiddenField = eval("document.forms[0]."+fieldname +"_SelectedTextForEmbeddedLink");
	            selectedHTMLhiddenField.value = selectedHTML;
			   }
	       }else if(embedtype=="link"){
            var textrange;
            if (document.selection && document.selection.createRange) {
                textrange = document.selection.createRange();
                if (textrange.parentElement().name != fieldname && !_isEditorOfMultiVal(fieldname, attrName)) {
                   ]]>
                   alert("<XLAT.STREAM KEY="dvin/UI/PleaseSelectLinkTextFrom" ESCAPE="true" ENCODE="false"/>".replace('Variables.assetType',AssetType).replace('Variables.fielddesc',fielddesc));
                   <![CDATA[
                   return false;
                }
           } else {
	           if(getSel(fieldname, editingStyle).length<1) { // for mozilla and safari
                   ]]>
	               alert("<XLAT.STREAM KEY="dvin/UI/PleaseSelectLinkTextFrom" ESCAPE="true" ENCODE="false"/>".replace('Variables.assetType',AssetType).replace('Variables.fielddesc',fielddesc));
	               <![CDATA[
	               return false;
               }
           }
        }

		   
	       var pURL = "ContentServer?pagename=OpenMarket/Xcelerate/Actions/";
		   if (embedtype=="link") {
			pURL = pURL + "EmbeddedLink";
	       } else {
	       	pURL = pURL + "AddInclusion";
	       }
	       pURL = pURL + "&tn_id=" + tn_id;
	       pURL = pURL + "&tn_AssetType=" + tn_AssetType;
	       pURL = pURL + "&name=" + encodeURIComponent(assetname);
	       pURL = pURL + "&AssetType=" + AssetType;
	       pURL = pURL + "&fieldname=" + encodeURIComponent(fieldname);
	       pURL = pURL + "&fielddesc=" + encodeURIComponent(fielddesc); 
		   pURL = pURL + "&EditingStyle=" + encodeURIComponent(editingStyle);
		   
	       return window.open(pURL, "EmbeddedLinkControl", "directories=no,left=700,location=no,menubar=no,resizable=yes,toolbar=no,top=50,width=500,height=700");
	   }
	   else
	   {
	      ]]>
	      alert("<XLAT.STREAM KEY="dvin/UI/PleaseSelectAssetFromTree" ENCODE="false" ESCAPE="true"/>");
	      <![CDATA[
	   }
	}
   else
   {
      ]]>
      alert("<XLAT.STREAM KEY="dvin/UI/PleaseSelectAssetFromTree" ENCODE="false" ESCAPE="true"/>");
      <![CDATA[
   }
}

]]>
</SCRIPT>

</then>
<else>
    <SCRIPT LANGUAGE="JavaScript">
var environment = '';
<IF COND="IsVariable.cs_environment=true">
<THEN>
<replace STR="Variables.cs_environment">
 environment = 'Variables.cs_environment';
</replace>
</THEN>
</IF>

    <![CDATA[

	var _range;
    function addEmbeddedLink(assetname, AssetType, fieldname, fielddesc, embedtype, isEWebEditPro, editingStyle, attrName)	
    {		
		// Adding support for UC1 UI
		// Values for EditingStyle can be undefined (Single valued) or multiple/multiple-ordered (Multi valued)
		var isMultiVal = (editingStyle) ? true : false; 
		if(environment==="ucform"){
			var env = (dojo.isChrome || dojo.isSafari || dojo.isWebKit) ? "webkit" : ((dojo.isMozilla) ? "gecko" : "ie");
			if (dojo.isIE){
				_range = document.selection.createRange();
				if(_range.text==="") {
					]]>
					alert('<XLAT.STREAM KEY="UI/UC1/CKEditor/SelectLinkTextFirst" ESCAPE="true" ENCODE="false"/>');
					<![CDATA[
					return false;
				}
			}
			var linkText= getSel(fieldname, editingStyle);			
			if(embedtype==="include") {			
				var CK = new parent.fw.ui.controller.CKEditorController;
				CK.openCKDialog({
					args : {
						action : 'insert',
						item : 'asset',
						fieldName : fieldname ,
						DEPTYPE : 'exists',
						env : env,
						isMultiVal : isMultiVal
					},
					assettypes : '*'	
				});
			} else if(embedtype==="link"){	
				if(linkText.length<1) {
					]]>
					alert('<XLAT.STREAM KEY="UI/UC1/CKEditor/SelectLinkTextFirst" ESCAPE="true" ENCODE="false"/>');
					<![CDATA[
					return false;
				}				
				var CK = new parent.fw.ui.controller.CKEditorController;
				CK.openCKDialog({
					args: {
						action: 'insert',
						item: 'link',	
						fieldName: fieldname,
						linkText: linkText,
						DEPTYPE : 'exists',
						env : env,
						isMultiVal : isMultiVal
					},
					assettypes: '*'
				});
			}
		} else {
			if(typeof(editingStyle) ==='undefined')
			editingStyle='single';
			if (isEWebEditPro) {
				// using eWebEditPro
				var selectedHTML = eWebEditPro.instances[fieldname].editor.getSelectedHTML();
				if (selectedHTML == "") {
					]]>
					alert("<XLAT.STREAM KEY="dvin/UI/PleaseSelectLinkTextFrom" ESCAPE="true" ENCODE="false"/>".replace('Variables.assetType',AssetType).replace('Variables.fielddesc',fielddesc));
					<![CDATA[
					return false;
				} else {
					var selectedHTMLhiddenField = eval("document.forms[0]."+fieldname +"_SelectedTextForEmbeddedLink");
					selectedHTMLhiddenField.value = selectedHTML;
				}
			} else {
				var textrange;
				if (document.selection && document.selection.createRange) {
					textrange = document.selection.createRange();
					if (textrange.parentElement().name != fieldname && !_isEditorOfMultiVal(fieldname)) {
					   ]]>
					   alert("<XLAT.STREAM KEY="dvin/UI/PleaseSelectLinkTextFrom" ESCAPE="true"  ENCODE="false"/>".replace('Variables.assetType',AssetType).replace('Variables.fielddesc',fielddesc));
					   <![CDATA[
					   return false;
					}
			   } else {
				   if(getSel(fieldname, editingStyle).length<1) { // for mozilla and safari
					   ]]>
					   alert("<XLAT.STREAM KEY="dvin/UI/PleaseSelectLinkTextFrom" ESCAPE="true" ENCODE="false"/>".replace('Variables.assetType',AssetType).replace('Variables.fielddesc',fielddesc));
					   <![CDATA[
					   return false;
				   }
			   }
			}

			var pURL = "ContentServer?pagename=OpenMarket/Xcelerate/Actions/PickAssetPopup";

			var i=0, histString='', currentVal;
			if (parent.parent['XcelBanner'])
			{
				for (i=0;i<parent.parent['XcelBanner'].hist.length;i++)
				{
					currentVal = parent.parent['XcelBanner'].hist[i];
					if (i==0)
						histString=currentVal.id;
					else
						histString=histString+","+currentVal.id;
				}
			}

			pURL = pURL + "&name=" + encodeURIComponent(assetname);
			pURL = pURL + "&AssetType=" + AssetType;
			pURL = pURL + "&embedtype=" + embedtype;
			pURL = pURL + "&fieldname=" + encodeURIComponent(fieldname);
			pURL = pURL + "&fielddesc=" + encodeURIComponent(fielddesc);
			pURL = pURL + "&history=" + encodeURIComponent(histString);
				
			pURL = pURL + "&cs_CallbackSuffix=";
			pURL = pURL + "&cs_SelectionStyle=single";
			pURL = pURL + "&cs_History=" + encodeURIComponent(histString);
			pURL = pURL + "&cs_FieldName=" + encodeURIComponent(fieldname);
			pURL = pURL + "&IFCKEditor=false";   
			pURL = pURL + "&EditingStyle=" + encodeURIComponent(editingStyle);		

			return window.open(pURL, "EmbeddedLinkControl", "directories=no,left=700,location=no,menubar=no,toolbar=no,top=50,width=500,height=700");
		}        
    }
    
    function insertHTML_In_IE_Textarea(html,fieldname,isMultiVal){
    	//This is called in ucform text area for IE to insert html. Called by ApplicationController's include method.
    	var txtarea = isMultiVal ? dojo.byId(fieldname) : document.getElementsByName(fieldname).item(0);
    	txtarea.focus();
    	_range.text=html;
    }

    ]]>
    </SCRIPT>
</else>
</if>

</FTCS>
