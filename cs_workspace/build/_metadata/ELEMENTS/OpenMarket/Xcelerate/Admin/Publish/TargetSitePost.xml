<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
    <PROPERTY.GET PARAM="xcelerate.charset" INIFILE="futuretense_xcel.ini" VARNAME="charset"/>
<SETVAR NAME="cs.contenttype" VALUE="text/html; charset=Variables.charset"/>
<!-- OpenMarket/Xcelerate/Admin/Publish/TargetSitePost
-
- INPUT
-
- OUTPUT
-
-->
<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/BasicEnvironment"/>
<STRING.ENCODE VARIABLE="cs_environment" VARNAME="cs_environment"/>
<STRING.ENCODE VARIABLE="cs_formmode" VARNAME="cs_formmode"/>
<HTML>
<HEAD>
<PROPERTY.GET PARAM="xcelerate.domain" INIFILE="futuretense_xcel.ini" VARNAME="docDomain"/>
<IF COND="IsVariable.docDomain=true">
<THEN>
	<IF COND="Variables.docDomain!=Variables.empty">
	<THEN>
	    <SCRIPT LANGUAGE="JavaScript">
		document.domain = "<CSVAR NAME="Variables.docDomain"/>";
	    </SCRIPT>
	</THEN>
	</IF>
</THEN>
</IF>
</HEAD>

<setvar NAME="doproceed" VALUE="true"/>
<!-- first check to see if the user is logged in or not -->
<SETVAR NAME="errno" VALUE="0"/>
<USERISMEMBER GROUP="xceladmin"/>
<if COND="Variables.errno=0">
	<then>
        <SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/Util/ShowError" outstring="urlshowerror">
            <satellite.argument name="cs_environment" value="Variables.cs_environment"/>
            <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
                                          <satellite.argument name="error" value="AdminTimeoutError"/>
                                           </SATELLITE.LINK>
		<REPLACE STR="Variables.urlshowerror">
			<script LANGUAGE="JavaScript">
				parent.parent.location="Variables.urlshowerror";
			</script>
		</REPLACE>
		<throwexception/>
	</then>
</if>
<BODY BGCOLOR="#FFFFFF">

<PUBTARGETMANAGER.LOAD ID="Variables.pubtargetid" OBJVARNAME="pubtgt"/>
<PUBTARGET.GETNAME NAME="pubtgt" VARNAME="pubtgt:name"/>
<setcounter NAME="pubsDone" VALUE="0"/>

<PUBSESSIONMANAGER.CREATE TARGET="Variables.pubtargetid" USER="SessionVariables.username" VARNAME="pubsess:id"/>
<if COND="IsError.Variables.errno=true">
<then>
 	<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/notcreatepublishingsessionerrno" errno="Variables.errno" EVALALL="false" VARNAME="msgtext"/>
 	<div class="width-outer-70">
	<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
	    <ARGUMENT NAME="severity" VALUE="error"/>
	</CALLELEMENT>            
	</div>
 	<setvar NAME="doproceed" VALUE="false"/>            
	<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Variables.msgtext"/>
	<PUBSESSIONMANAGER.FAIL ID="Variables.pubsess:id"/>
</then>
<else>
	<PUBSESSIONMANAGER.LOAD ID="Variables.pubsess:id" OBJVARNAME="pubsess"/>
	<PROPERTY.GET PARAM="xcelerate.remotecall" INIFILE="futuretense_xcel.ini" VARNAME="propremotecall"/>
	<MIRRORQUEUE.CREATE NAME="pubMirrorQ" SESSION="pubsess" PAGENAME="Variables.propremotecall"/>
	<if COND="IsError.Variables.errno=true">
	<then>
    	<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/notcreatemirrorqueueerrno" errno="Variables.errno" EVALALL="false" VARNAME="msgtext"/>
		<if COND="IsVariable.errdetail1=true">
		<then>
			<SETVAR NAME="msgtext" VALUE="Variables.msgtext Variables.errdetail1"/>
		</then>
		</if>
		<div class="width-outer-70">
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
		    <ARGUMENT NAME="severity" VALUE="error"/>
		</CALLELEMENT>   
		</div>         
 		<setvar NAME="doproceed" VALUE="false"/>            
		<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Variables.msgtext"/>
		<PUBSESSIONMANAGER.FAIL ID="Variables.pubsess:id"/>
	</then>
	</if>
</else>
</if>

<if COND="Variables.doproceed=true">
<then>
	<IF COND="IsVariable.thePubs=true">
	<THEN>
		<STRINGLIST NAME="pubs" STR="Variables.thePubs" DELIM=";"/>
		<loop LIST="pubs">
			<SETVAR NAME="errno" VALUE="0"/>
			<inccounter NAME="pubsDone" VALUE="1"/>	
			
			<if COND="IsError.Variables.errno=false">
			<then>
				<PUBLICATION.LOAD NAME="pub" OBJECTID="pubs.ITEM"/>
				<PUBLICATION.GET NAME="pub" FIELD="description"/>
				<setvar NAME="pubid" VALUE="pubs.ITEM"/>
				<if COND="IsError.Variables.errno=false">
				<then>
					<!-- Mirror Publication -->
					<SETVAR NAME="site" VALUE="Variables.description"/>
					<XLAT.LOOKUP KEY="dvin/UI/Admin/Publish/TargetSitePost-mirroringPublication" VARNAME="msgtext"/>
					<div class="width-outer-70" style="margin-top:0">
					<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					    <ARGUMENT NAME="severity" VALUE="info"/>
					</CALLELEMENT>  
					</div>          
					<MIRRORQUEUE.SENDROW NAME="pubMirrorQ" TABLENAME="Publication" FIELD1="id" VALUE1="Variables.pubid"/>
					<!-- Mirror SitePlanTree root -->
					<MIRRORQUEUE.SENDROW NAME="pubMirrorQ" TABLENAME="SitePlanTree" FIELD1="oid" VALUE1="Variables.pubid"/>
					<!-- Mirror PublicationTree root -->
					<MIRRORQUEUE.SENDROW NAME="pubMirrorQ" TABLENAME="PublicationTree" FIELD1="oid" VALUE1="Variables.pubid"/>
					
					<!-- Mirror selected entries for Enabled Assets. -->
					<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/EnableAssetTypePub">
						<ARGUMENT NAME="upcommand" VALUE="ListEnabledAssetTypes"/>
						<ARGUMENT NAME="list" VALUE="EnabledAssetTypes"/>
						<ARGUMENT NAME="pubid" VALUE="Variables.pubid"/>
					</CALLELEMENT>
					<if COND="IsList.EnabledAssetTypes=true">
					<then>
						<SETVAR NAME="assettypes" VALUE="Variables.empty"/>
						<LOOP LIST="EnabledAssetTypes">
							<IF COND="Variables.assettypes=Variables.empty">
							<THEN>
								<SETVAR NAME="assettypes" VALUE="EnabledAssetTypes.assettype"/>
							</THEN>
							<ELSE>
								<SETVAR NAME="assettypes" VALUE="Variables.assettypes,EnabledAssetTypes.assettype"/>
							</ELSE>
							</IF>
						</LOOP>
						
						<ASSETTYPE.PublishAssetTypes ASSETTYPES="Variables.assettypes" MIRRORQUEUE="pubMirrorQ" PUBID="Variables.pubid"/>
						<IF COND="IsError.Variables.errno=true">
						<THEN>
							<XLAT.LOOKUP KEY="dvin/Admin/MirrorSite-ErrormirroringAssets" VARNAME="msgtext" errno="Variables.errno" errdetail1="Variables.errdetail1" EVALALL="false"/>
							<div class="width-outer-70" style="margin-top:0">
							<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
							    <ARGUMENT NAME="severity" VALUE="error"/>
							</CALLELEMENT>
							</div>
						</THEN>
						</IF>
					 </then>
					 </if>
			    </then>
			    <else>
			    	<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/loadingPublicationerrno" errno="Variables.errno" EVALALL="false" VARNAME="msgtext"/>
			    	<div class="width-outer-70" style="margin-top:0">
					<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					    <ARGUMENT NAME="severity" VALUE="error"/>
					</CALLELEMENT>  
					</div>
					<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Variables.msgtext"/>
					<PUBSESSIONMANAGER.FAIL ID="Variables.pubsess:id"/>
			    </else>
			    </if>
			    <!--Trigger AddSite event on target which in turn updates the site entries for shared templates on target-->
	    		<PUBLICATION.GET NAME="pub" FIELD="name" OUTPUT="pubname"/>
        		<MIRRORQUEUE.REMOTEEXECUTE NAME="pubMirrorQ" REMOTEMETHOD="AddSiteEventRemoteElement" pubname="Variables.pubname"/>
	    	</then>
	    	</if>
		</loop>
    </THEN>
	</IF>
		
	<!-- Auxilliary tables -->
	<SETCOUNTER NAME="catalogsDone" VALUE="0"/>
	 <if COND="IsVariable.catalogs=true">
	 <then>
	    <STRINGLIST NAME="tablesToMirror" STR="Variables.catalogs" DELIM=";"/>
	    <LOOP LIST="tablesToMirror">
			<PROPERTY.GET PARAM="cc.tablesToMirror.ITEMKey" INIFILE="futuretense.ini" VARNAME="key"/>
			<if COND="Variables.key=Variables.empty">
			<then>
				<PROPERTY.GET PARAM="cc.contentkey" INIFILE="futuretense.ini" VARNAME="key"/>
			</then>
			</if>
		    <SELECTTO LIST="allItems" FROM="tablesToMirror.ITEM" WHAT="*"/>
		    <if COND="IsList.allItems=true">
		    <then>
			    <if COND="allItems.#numRows!=0">
			    <then>
			    	<INCCOUNTER NAME="catalogsDone" VALUE="1"/>
				 	<XLAT.LOOKUP KEY="dvin/UI/Admin/AddingallItemtablesToMirrortablemirrorq" VARNAME="msgtext"/>
				 	<div class="width-outer-70" style="margin-top:0">
					<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					    <ARGUMENT NAME="severity" VALUE="info"/>
					</CALLELEMENT> 
					</div>           
				    <LOOP LIST="allItems">
					 	<MIRRORQUEUE.SENDROW NAME="pubMirrorQ" TABLENAME="tablesToMirror.ITEM" FIELD1="Variables.key" VALUE1="allItems.Variables.key"/>
					 </LOOP>
				 </then>
				 <else>
				 	<XLAT.LOOKUP KEY="dvin/UI/Admin/NorowsfoundfortablesToMirrorITEM" VARNAME="msgtext"/>
				 </else>
				 </if>
			</then>
			<else>
				<SETVAR NAME="tablename" VALUE="tablesToMirror.ITEM"/>
				<STRING.ENCODE VARIABLE="tablename" VARNAME="tablename"/>
		    	<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/ErrorGettingTableDaterrno" errno="Variables.errno" EVALALL="false" VARNAME="msgtext"/>
		    	<div class="width-outer-70" style="margin-top:0">
				<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
				    <ARGUMENT NAME="severity" VALUE="warning"/>
				</CALLELEMENT>   
				</div>         
			</else>
			</if>
		</LOOP>
	</then>
	</if>
	
	<!-- if no data to mirror, do nothing -->
	<if COND="Counters.pubsDone=0">
	<then>
		<if COND="Counters.catalogsDone=0">
		<then>
			<SETVAR NAME="cancelled" VALUE="true"/>
			<XLAT.LOOKUP KEY="dvin/UI/Admin/NoDatatomirror" VARNAME="msgtext"/>
			<div class="width-outer-70" style="margin-top:0">
			<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			    <ARGUMENT NAME="severity" VALUE="error"/>
			</CALLELEMENT> 
			</div>           
			<MIRRORQUEUE.CANCEL NAME="pubMirrorQ"/>
		</then>
		</if>
	</then>
	</if>
	
	<if COND="Variables.cancelled!=true">
	<then>
		<MIRRORQUEUE.CLOSE NAME="pubMirrorQ"/>
	</then>
	</if>

	<if COND="IsError.Variables.errno=false">
	<then>
		<XLAT.LOOKUP KEY="dvin/UI/Admin/Initializemirrordestpubtgtnameopcomplete" VARNAME="msgtext"/>
	
		<PUBSESSIONMANAGER.DONE ID="Variables.pubsess:id"/>
		<div class="width-outer-70" style="margin-top:0">
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
		    <ARGUMENT NAME="severity" VALUE="info"/>
		</CALLELEMENT>            
		</div>
	</then>
	<else>
		<SETVAR NAME="saveerrno" VALUE="Variables.errno"/>
	 	<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/duringmirroroperationerrno" errno="Variables.errno" EVALALL="false" VARNAME="msgtext"/>
		<if COND="Variables.saveerrno=-103">
		<then>
	 		<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/DescriptionOfError-103" VARNAME="errdetail1"/>
		</then>
		</if>
		<if COND="IsVariable.errdetail1=true">
		<then>
			<SETVAR NAME="msgtext" VALUE="Variables.msgtext Variables.errdetail1"/>
		</then>
		</if>
	 	<div class="width-outer-70" style="margin-top:0">
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
		    <ARGUMENT NAME="severity" VALUE="error"/>
		</CALLELEMENT>   
		</div>         
		<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Variables.msgtext"/>
		<PUBSESSIONMANAGER.FAIL ID="Variables.pubsess:id"/>
	</else>
	</if>
</then>
</if>
	
<!-- only save in PubHistory if we were unsuccessful -->
<PUBSESSIONMANAGER.STATUS ID="Variables.pubsess:id" VARNAME="status"/>
<if COND="Variables.status=done">
<then>
	<PUBSESSIONMANAGER.DELETE ID="Variables.pubsess:id"/>
</then>
</if>

<if cond="Variables.cs_environment=portal">
<then>
    <a href="javascript:void(0);" onclick="window.close();"><XLAT.STREAM KEY="dvin/Common/Done"/></a>
</then>
<else>
    <!-- put up the destination -->
    <CALLELEMENT NAME="OpenMarket/Xcelerate/Admin/Publish/DestEdit">
    	<ARGUMENT NAME="action" VALUE="details"/>
    	<ARGUMENT NAME="id" VALUE="Variables.pubtargetid"/>
    </CALLELEMENT>
</else>
</if>

</BODY>
</HTML>

</FTCS> 
