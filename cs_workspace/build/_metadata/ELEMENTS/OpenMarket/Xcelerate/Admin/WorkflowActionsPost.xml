<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Admin/WorkflowActions

 INPUT

 OUTPUT

-->
<!--
 [2007-09-17 KGF]
 * XSS fixes (adapted from 6.3 fixes):
   * isCleanString function usage
   * CSVAR -> STRING.STREAM
 * changed definitions of 'obj' to just forms[0] (not .elements[0])
 [2007-10-09 KGF]
 * XSS revision: minimized set of restricted characters.
 [2008-02-26 KGF]
 * Further XSS fix: encode HTML special chars in text fields
-->



	<STRING.ENCODE VARIABLE="acttype" VARNAME="acttype"/>
    <INPUT TYPE="HIDDEN" NAME="acttype" VALUE="Variables.acttype" REPLACEALL="Variables.acttype"/>

<!-- process deletion of stuff -->

    <!-- process deletion of stuff -->
    <if COND="Variables.action=delete">
    <then>
	  <if COND="Variables.acttype=Timed"><then>
		<XLAT.LOOKUP KEY="dvin/UI/Admin/TimedAction" VARNAME="_XLAT_"/>
		<WORKFLOWENGINE.GETASSIGNMENTACTIONID OBJVARNAME="anaction" ID="Variables.id"/>
	  </then></if>
	  <if COND="Variables.acttype=Step"><then>
		<XLAT.LOOKUP KEY="dvin/UI/Admin/StepAction" VARNAME="_XLAT_"/>
		<WORKFLOWENGINE.GETSTEPACTIONID OBJVARNAME="anaction" ID="Variables.id"/>
	  </then></if>
	  <if COND="Variables.acttype=Deadlock"><then>
		<XLAT.LOOKUP KEY="dvin/UI/Admin/DeadlockAction" VARNAME="_XLAT_"/>
		<WORKFLOWENGINE.GETDEADLOCKACTIONID OBJVARNAME="anaction" ID="Variables.id"/>
	  </then></if>
	  <if COND="Variables.acttype=Group"><then>
		<XLAT.LOOKUP KEY="dvin/UI/Admin/GroupDeadlockAction" VARNAME="_XLAT_"/>
		<WORKFLOWENGINE.GETGROUPACTIONID OBJVARNAME="anaction" ID="Variables.id"/>
	  </then></if>
	  <if COND="Variables.acttype=Delegate"><then>
		<XLAT.LOOKUP KEY="dvin/UI/Admin/DelegateAction" VARNAME="_XLAT_"/>
		<WORKFLOWENGINE.GETDELEGATEACTIONID OBJVARNAME="anaction" ID="Variables.id"/>
	  </then></if>
	  <if COND="Variables.acttype=Condition"><then>
		<XLAT.LOOKUP KEY="dvin/UI/Admin/StepCondition" VARNAME="_XLAT_"/>
		<WORKFLOWENGINE.GETCONDITIONID OBJVARNAME="anaction" ID="Variables.id"/>
	  </then></if>

	  <XLAT.STREAM KEY="dvin/Common/Delete"/><STRING.STREAM VALUE=" Variables._XLAT_: Variables.description"/><br/>

                <setvar NAME="errno" VALUE="0"/>

			<if COND="Variables.acttype=Timed"><then>
	  			<WORKFLOWENGINE.GETASSIGNMENTACTIONID OBJVARNAME="delaction" ID="Variables.id"/>
		    		<WORKFLOWACTION.SCATTER PREFIX="wfdelete:" NAME="delaction"/>
		    		<WORKFLOWENGINE.DELETEASSIGNMENTACTIONID OBJVARNAME="delaction" ID="Variables.wfdelete:id"/>
	  		</then></if>
	  		<if COND="Variables.acttype=Step"><then>
	  			<WORKFLOWENGINE.GETSTEPACTIONID OBJVARNAME="delaction" ID="Variables.id"/>
		    		<WORKFLOWACTION.SCATTER PREFIX="wfdelete:" NAME="delaction"/>
		    		<WORKFLOWENGINE.DELETESTEPACTIONID OBJVARNAME="delaction" ID="Variables.wfdelete:id"/>
	  		</then></if>
	  		<if COND="Variables.acttype=Deadlock"><then>
	  			<WORKFLOWENGINE.GETDEADLOCKACTIONID OBJVARNAME="delaction" ID="Variables.id"/>
		    		<WORKFLOWACTION.SCATTER PREFIX="wfdelete:" NAME="delaction"/>
		    		<WORKFLOWENGINE.DELETEDEADLOCKACTIONID OBJVARNAME="delaction" ID="Variables.wfdelete:id"/>
	  		</then></if>
	  		<if COND="Variables.acttype=Group"><then>
	  			<WORKFLOWENGINE.GETGROUPACTIONID OBJVARNAME="delaction" ID="Variables.id"/>
		    		<WORKFLOWACTION.SCATTER PREFIX="wfdelete:" NAME="delaction"/>
		    		<WORKFLOWENGINE.DELETEGROUPACTIONID OBJVARNAME="delaction" ID="Variables.wfdelete:id"/>
	  		</then></if>
	  		<if COND="Variables.acttype=Delegate"><then>
	  			<WORKFLOWENGINE.GETDELEGATEACTIONID OBJVARNAME="delaction" ID="Variables.id"/>
		    		<WORKFLOWACTION.SCATTER PREFIX="wfdelete:" NAME="delaction"/>
		    		<WORKFLOWENGINE.DELETEDELEGATEACTIONID OBJVARNAME="delaction" ID="Variables.wfdelete:id"/>
	  		</then></if>
	  		<if COND="Variables.acttype=Condition"><then>
	  			<WORKFLOWENGINE.GETCONDITIONID OBJVARNAME="delaction" ID="Variables.id"/>
		    		<WORKFLOWACTION.SCATTER PREFIX="wfdelete:" NAME="delaction"/>
		    		<WORKFLOWENGINE.DELETECONDITIONID OBJVARNAME="delaction" ID="Variables.wfdelete:id"/>
	  		</then></if>

                <if COND="Variables.errno!=0">
                <then>
                    <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
                        <argument NAME="error" VALUE="DeleteFailed"/>
                    </callelement>
                </then>
                <else>
                    <XLAT.STREAM KEY="dvin/UI/Deletesuccessful"/>
                    <callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowActionsFront">
                        <argument NAME="action" VALUE="list"/>
                        <argument NAME="acttype" VALUE="Variables.acttype"/>
                        <argument NAME="showtitle" VALUE="true"/>
                    </callelement>

                </else>
                </if>
    </then>
    </if>

    <!-- process addition of stuff -->
    <if COND="Variables.action=new">
    <then>
                <if COND="IsVariable.name!=true">
                <then>
                    <callelement NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
                        <argument NAME="error" VALUE="NoName"/>
                    </callelement>
                    <throwexception/>
                </then>
                </if>
                <!-- insert the specified information
                    into the table. Report any errors.
                    Refresh the navigation -->
                <if COND="IsVariable.description!=true">
                <then>
                    <setvar NAME="description" VALUE="Variables.empty"/>
                </then>
                </if>
                <if COND="IsVariable.arguments!=true">
                <then>
                    <setvar NAME="arguments" VALUE="none"/>
                </then>
                </if>
				
				<if COND="Variables.acttype=Timed"><then>
	  				<WORKFLOWENGINE.GETASSIGNMENTACTIONNAME NAME="Variables.name" OBJVARNAME="tempaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Step"><then>
	  				<WORKFLOWENGINE.GETSTEPACTIONNAME NAME="Variables.name" OBJVARNAME="tempaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Deadlock"><then>
	  				<WORKFLOWENGINE.GETDEADLOCKACTIONNAME NAME="Variables.name" OBJVARNAME="tempaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Group"><then>
	  				<WORKFLOWENGINE.GETGROUPACTIONNAME NAME="Variables.name" OBJVARNAME="tempaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Delegate"><then>
	  				<WORKFLOWENGINE.GETDELEGATEACTIONNAME NAME="Variables.name" OBJVARNAME="tempaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Condition"><then>
	  				<WORKFLOWENGINE.GETCONDITIONNAME NAME="Variables.name" OBJVARNAME="tempaction"/>
	  			</then></if>
	  			<IF COND="Variables.errno!=-12052">
	  			<THEN>
	  			<XLAT.LOOKUP KEY="dvin/UI/Wf/WorkflowActionAlreadyExist" VARNAME="_XLAT_"/>
		    		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
						<argument NAME="msgtext" VALUE="Variables._XLAT_"/>
						<argument NAME="severity" VALUE="error"/>
                    </callelement>
                </THEN>
                <ELSE>
                <if COND="Variables.existingaction=false">
		    	<then>
			  	<if COND="Variables.acttype=Timed"><then>
	  				<WORKFLOWENGINE.CREATENEWASSIGNMENTACTION OBJVARNAME="newaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Step"><then>
	  				<WORKFLOWENGINE.CREATENEWSTEPACTION OBJVARNAME="newaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Deadlock"><then>
	  				<WORKFLOWENGINE.CREATENEWDEADLOCKACTION OBJVARNAME="newaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Group"><then>
	  				<WORKFLOWENGINE.CREATENEWGROUPACTION OBJVARNAME="newaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Delegate"><then>
	  				<WORKFLOWENGINE.CREATENEWDELEGATEACTION OBJVARNAME="newaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Condition"><then>
	  				<WORKFLOWENGINE.CREATENEWCONDITION OBJVARNAME="newaction"/>
	  			</then></if>
		    </then>
		    <else>
	  			<if COND="Variables.acttype=Timed"><then>
	  				<WORKFLOWENGINE.GETASSIGNMENTACTIONID OBJVARNAME="newaction" ID="Variables.id"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Step"><then>
	  				<WORKFLOWENGINE.GETSTEPACTIONID OBJVARNAME="newaction" ID="Variables.id"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Deadlock"><then>
	  				<WORKFLOWENGINE.GETDEADLOCKACTIONID OBJVARNAME="newaction" ID="Variables.id"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Group"><then>
	  				<WORKFLOWENGINE.GETGROUPACTIONID OBJVARNAME="newaction" ID="Variables.id"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Delegate"><then>
	  				<WORKFLOWENGINE.GETDELEGATEACTIONID OBJVARNAME="newaction" ID="Variables.id"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Condition"><then>
	  				<WORKFLOWENGINE.GETCONDITIONID OBJVARNAME="newaction" ID="Variables.id"/>
	  			</then></if>
		    </else>
		    </if>
		    <WORKFLOWACTION.SCATTER PREFIX="wfa:" NAME="newaction"/>
		    <setvar NAME="wfa:name" VALUE="Variables.name"/>
		    <setvar NAME="wfa:description" VALUE="Variables.description"/>
		    <setvar NAME="wfa:elementname" VALUE="Variables.elementname"/>
		    <setvar NAME="wfa:arguments" VALUE="Variables.arguments"/>

		    <WORKFLOWACTION.GATHER PREFIX="wfa:" NAME="newaction"/>
		    <WORKFLOWACTION.SCATTER PREFIX="wf:" NAME="newaction"/>

	  			<if COND="Variables.acttype=Timed"><then>
	  				<WORKFLOWENGINE.SETASSIGNMENTACTION OBJECT="newaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Step"><then>
	  				<WORKFLOWENGINE.SETSTEPACTION OBJECT="newaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Deadlock"><then>
	  				<WORKFLOWENGINE.SETDEADLOCKACTION OBJECT="newaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Group"><then>
	  				<WORKFLOWENGINE.SETGROUPACTION OBJECT="newaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Delegate"><then>
	  				<WORKFLOWENGINE.SETDELEGATEACTION OBJECT="newaction"/>
	  			</then></if>
	  			<if COND="Variables.acttype=Condition"><then>
	  				<WORKFLOWENGINE.SETCONDITION OBJECT="newaction"/>
	  			</then></if>
	  			<WORKFLOWACTION.GETID NAME="newaction" VARNAME="actid"/>
	  			
		    	<if COND="IsVariable.actid=false">
		    	<then>
		    		<XLAT.LOOKUP KEY="dvin/UI/Wf/WorkflowActionCreateFailed" VARNAME="_XLAT_"/>
		    		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
						<argument NAME="msgtext" VALUE="Variables._XLAT_"/>
						<argument NAME="severity" VALUE="error"/>
                    </callelement>
                    <throwexception/>
		    	</then>
		    	</if>
	  			
                <callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowActionsFront">
                    <argument NAME="id" VALUE="Variables.actid"/>
                    <argument NAME="action" VALUE="details"/>
                    <argument NAME="showtitle" VALUE="true"/>
                </callelement>
                </ELSE>
                </IF>     
    </then>
    </if>


	<if COND="Variables.action=edit">
    <then>
        <if COND="Variables.existingaction=false">
    	<then>
		  	<if COND="Variables.acttype=Timed"><then>
  				<WORKFLOWENGINE.CREATENEWASSIGNMENTACTION OBJVARNAME="editaction"/>
  			</then></if>
  			<if COND="Variables.acttype=Step"><then>
  				<WORKFLOWENGINE.CREATENEWSTEPACTION OBJVARNAME="editaction"/>
  			</then></if>
  			<if COND="Variables.acttype=Deadlock"><then>
  				<WORKFLOWENGINE.CREATENEWDEADLOCKACTION OBJVARNAME="editaction"/>
  			</then></if>
  			<if COND="Variables.acttype=Group"><then>
  				<WORKFLOWENGINE.CREATENEWGROUPACTION OBJVARNAME="editaction"/>
  			</then></if>
  			<if COND="Variables.acttype=Delegate"><then>
  				<WORKFLOWENGINE.CREATENEWDELEGATEACTION OBJVARNAME="editaction"/>
  			</then></if>
  			<if COND="Variables.acttype=Condition"><then>
  				<WORKFLOWENGINE.CREATENEWCONDITION OBJVARNAME="editaction"/>
  			</then></if>
	    </then>
	    <else>
  			<if COND="Variables.acttype=Timed"><then>
  				<WORKFLOWENGINE.GETASSIGNMENTACTIONID OBJVARNAME="editaction" ID="Variables.id"/>
  			</then></if>
  			<if COND="Variables.acttype=Step"><then>
  				<WORKFLOWENGINE.GETSTEPACTIONID OBJVARNAME="editaction" ID="Variables.id"/>
  			</then></if>
  			<if COND="Variables.acttype=Deadlock"><then>
  				<WORKFLOWENGINE.GETDEADLOCKACTIONID OBJVARNAME="editaction" ID="Variables.id"/>
  			</then></if>
  			<if COND="Variables.acttype=Group"><then>
  				<WORKFLOWENGINE.GETGROUPACTIONID OBJVARNAME="editaction" ID="Variables.id"/>
  			</then></if>
  			<if COND="Variables.acttype=Delegate"><then>
  				<WORKFLOWENGINE.GETDELEGATEACTIONID OBJVARNAME="editaction" ID="Variables.id"/>
  			</then></if>
  			<if COND="Variables.acttype=Condition"><then>
  				<WORKFLOWENGINE.GETCONDITIONID OBJVARNAME="editaction" ID="Variables.id"/>
  			</then></if>
	    </else>
	    </if>
	    
	    <WORKFLOWACTION.SCATTER PREFIX="wfa:" NAME="editaction"/>
	    <setvar NAME="wfa:name" VALUE="Variables.name"/>
	    <setvar NAME="wfa:description" VALUE="Variables.description"/>
	    <setvar NAME="wfa:elementname" VALUE="Variables.elementname"/>
	    <setvar NAME="wfa:arguments" VALUE="Variables.arguments"/>

	    <WORKFLOWACTION.GATHER PREFIX="wfa:" NAME="editaction"/>
	    <WORKFLOWACTION.SCATTER PREFIX="wf:" NAME="editaction"/>

		<if COND="Variables.acttype=Timed"><then>
			<WORKFLOWENGINE.SETASSIGNMENTACTION OBJECT="editaction"/>
		</then></if>
		<if COND="Variables.acttype=Step"><then>
			<WORKFLOWENGINE.SETSTEPACTION OBJECT="editaction"/>
		</then></if>
		<if COND="Variables.acttype=Deadlock"><then>
			<WORKFLOWENGINE.SETDEADLOCKACTION OBJECT="editaction"/>
		</then></if>
		<if COND="Variables.acttype=Group"><then>
			<WORKFLOWENGINE.SETGROUPACTION OBJECT="editaction"/>
		</then></if>
		<if COND="Variables.acttype=Delegate"><then>
			<WORKFLOWENGINE.SETDELEGATEACTION OBJECT="editaction"/>
		</then></if>
		<if COND="Variables.acttype=Condition"><then>
			<WORKFLOWENGINE.SETCONDITION OBJECT="editaction"/>
		</then></if>
		<WORKFLOWACTION.GETID NAME="editaction" VARNAME="actid"/>
		
	  	<if COND="IsVariable.actid=false">
	  	<then>
	  		<XLAT.LOOKUP KEY="dvin/UI/Wf/WorkflowActionCreateFailed" VARNAME="_XLAT_"/>
	  		<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
				<argument NAME="msgtext" VALUE="Variables._XLAT_"/>
				<argument NAME="severity" VALUE="error"/>
            </callelement>
            <throwexception/>
	  	</then>
	  	</if>
		
        <callelement NAME="OpenMarket/Xcelerate/Admin/WorkflowActionsFront">
            <argument NAME="id" VALUE="Variables.actid"/>
            <argument NAME="action" VALUE="details"/>
            <argument NAME="showtitle" VALUE="true"/>
        </callelement>
    </then>
    </if>
    
	<PROPERTY.GET PARAM="xcelerate.treeType" INIFILE="futuretense_xcel.ini" VARNAME="proptreetype"/>
	<if COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
	<then>
		<callelement NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype">
			<argument NAME="__TreeRefreshKeys__" VALUE="Self:Workflow_Action_Variables.acttype"/>
		</callelement>
	</then>
	</if>


</FTCS>
