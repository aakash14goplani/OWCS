<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/Admin/DelegateAssignmentFront
-
- INPUT
-
- OUTPUT
-
-->
<PROPERTY.GET PARAM="xcelelem.manageuserpub" INIFILE="futuretense_xcel.ini" VARNAME="propmanageuserpub"/>
<STRING.ENCODE VARIABLE="AssetType" VARNAME="AssetType"/>
<STRING.ENCODE VARIABLE="id" VARNAME="id"/>
<STRING.ENCODE VARIABLE="cs_imagedir" VARNAME="cs_imagedir"/>
<STRING.ENCODE VARIABLE="cs_formmode" VARNAME="cs_formmode"/>
<STRING.ENCODE VARIABLE="cs_environment" VARNAME="cs_environment"/>
<WorkflowAsset.Load ASSETTYPE="Variables.AssetType" ID="Variables.id" OBJVARNAME="workflowasset" />
<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="theAsset"/>
<ASSET.GET NAME="theAsset" FIELD="name" OUTPUT="assetname"/>

<WorkflowEngine.GetObjectParticipants OBJECT="workflowasset" OBJVARNAME="participantsObj" />
 
<setvar NAME="AbortFlag" VALUE="false"/>
<WorkflowEngine.isFunctionLegal OBJECT="workflowasset" FUNCTIONNAME="delegate" SITE="SessionVariables.pubid" VARNAME="isLegal" REASONVARNAME="denialreason"/>
<if COND="Variables.isLegal=false">
<then>
     <setvar NAME="AbortFlag" VALUE="true"/>
     <setvar NAME="ErrorName" VALUE="IllegalTransition"/>
     <setvar NAME="severity" VALUE="info"/>
</then>
</if>

<!-- check if there is a current active assignment -->

<if COND="Variables.AbortFlag!=true">
<then>
      <if COND="IsVariable.assignmentid=false">
      <then>
	<!-- Locate the correct assignment -->
	<!-- This may require a selection -->
		<USERMANAGER.GETLOGINUSER VARNAME="loginUser"/>
		<LISTOBJECT.CREATE NAME="listobj" COLUMNS="ITEM" />
		<LISTOBJECT.ADDROW NAME="listobj" ITEM="Variables.loginUser" />
		<LISTOBJECT.TOLIST NAME="listobj" LISTVARNAME="assignlist" />
		<WorkflowEngine.GetFilteredAssignments OBJECT="workflowasset" STATUS="active" PREFIX="workflow_assignments" />
		<if COND="Variables.workflow_assignmentsTotal=0">
		<then>
			<setvar NAME="ErrorName" VALUE="NeedsAssignment"/>
			<setvar NAME="AbortFlag" VALUE="true"/>
			<setvar NAME="severity" VALUE="info"/>
		</then>
		</if>
     </then>
     </if>
</then>
</if>

<!-- Dicide if a choice exists to delegate to --> 
        <setcounter NAME="assCounter" VALUE="0"/>
	<loop COUNT="Variables.workflow_assignmentsTotal">
	   <WorkflowAssignment.GetID NAME="workflow_assignmentsCounters.assCounter" VARNAME="assignmentid"/>
	   <WorkflowAssignment.GetAssignedUserID NAME="workflow_assignmentsCounters.assCounter" VARNAME="assignedid"/>
	   <UserManager.GetUser USER="Variables.assignedid" OBJVARNAME="userobj"/>
	   <CCUser.GetDisplayableName NAME="userobj" VARNAME="assignedname"/>
	   <WorkflowAssignment.GetAssignedUserRole NAME="workflow_assignmentsCounters.assCounter" VARNAME="assignrole"/>
	   <UserManager.GetUsers ROLE="Variables.assignrole" SITE="SessionVariables.pubid" PREFIX="Users:"/>
	   <!-- Check if there is at least one user that t is not already a participant for this role
                Present a choice only if such a user exists. -->
	   <setvar NAME="haschoice" VALUE="false"/>
	   <setcounter NAME="userCounter" VALUE="0"/>
	   <loop COUNT="Variables.Users:Total">
		<CCUser.GetID NAME="Users:Counters.userCounter" VARNAME="userid"/>
		<Participants.DoesParticipantHaveRole NAME="participantsObj" VARNAME="boolean"
			ROLE="Variables.assignrole" USER="Variables.userid"/>
		<if COND="Variables.boolean=false">
		<then>
			<if COND="Variables.assignedname!=Variables.username">
			<then>
				<setvar NAME="haschoice" VALUE="true"/>
			</then>
			</if>
		</then>
		</if>
		<inccounter NAME="userCounter" VALUE="1"/>
	   </loop>
		
	    <inccounter NAME="assCounter" VALUE="1"/>
	    </loop>
	    <if COND="Variables.haschoice=false">
	    <then>
			<setvar NAME="AbortFlag" VALUE="true"/>
	          	<setvar NAME="ErrorName" VALUE="NoDelegateUsers"/>
		  	<setvar NAME="severity" VALUE="info"/>
	    </then>
            </if>

<!-- Display choices if any -->

<if COND="Variables.AbortFlag!=true">
<then>

<SCRIPT>
function Fixpagename(obj,ourPage)
{
	var obj = document.forms[0].elements[0];
	obj.form.elements['pagename'].value = ourPage;
	obj.form.submit();
	return false;
}
  </SCRIPT>
    <SATELLITE.FORM ASSEMBLER="query" ENCTYPE="application/x-www-form-urlencoded" METHOD="post">
	<STRING.ENCODE VARIABLE="charset" VARNAME="charsetEnc" />
    <INPUT TYPE="HIDDEN" NAME="_charset_" VALUE="Variables.charsetEnc" REPLACEALL="Variables.charsetEnc"/>
	<STRING.ENCODE VARIABLE="cs_environment" VARNAME="cs_environmentEnc" />
    <INPUT TYPE="hidden"  NAME="cs_environment" VALUE="Variables.cs_environmentEnc" REPLACEALL="Variables.cs_environmentEnc"/>
	<STRING.ENCODE VARIABLE="cs_formmode" VARNAME="cs_formmodeEnc" />
    <INPUT TYPE="hidden"  NAME="cs_formmode" VALUE="Variables.cs_formmodeEnc" REPLACEALL="Variables.cs_formmodeEnc"/> 
    <TABLE BORDER="0">
    <TR>
       <TD><span class="title-text"><XLAT.STREAM KEY="dvin/UI/AssetMgt/DelegateAssignment"/></span> <span class="title-value-text"><STRING.STREAM VALUE="Variables.AssetType"/>: <STRING.STREAM VALUE="Variables.assetname"/></span></TD>
    </TR>
    <TR>
       <TD>
          <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/TitleBar"/>
       </TD>
       <TD>
          <TABLE>
              
  <TR>
                   <TD align="left" class="form-label-text"><XLAT.STREAM KEY="dvin/UI/Admin/AssetID"/>:</TD>
                   <TD class="form-inset">
			<STRING.STREAM VALUE="Variables.id"/><br/>
		   </TD>
                </TR>
                <TR>
		   <if COND="Variables.workflow_assignmentsTotal=1">
	           <then>
                   <TD ALIGN="LEFT" VALIGN="TOP" BGCOLOR="#336699"><span class="form-label-text"><FONT COLOR="#FFFFFF"><XLAT.STREAM KEY="dvin/UI/Admin/Currentlyassignedto"/>:</FONT></span></TD>
		   </then>
		   <else>
                   <TD ALIGN="LEFT" VALIGN="TOP" BGCOLOR="#336699"><span class="form-label-text"><FONT COLOR="#FFFFFF"><XLAT.STREAM KEY="dvin/UI/Admin/Pickauser"/>:</FONT></span></TD>
		   </else>
		   </if>
		   <TD>&nbsp;</TD>
                   <TD ALIGN="LEFT" VALIGN="TOP" BGCOLOR="#336699"><span class="form-label-text"><FONT COLOR="#FFFFFF"><XLAT.STREAM KEY="dvin/UI/Admin/Deligateto"/>:</FONT></span></TD>


			<!-- Present a choice of roles -->
		        <setcounter NAME="assCounter" VALUE="0"/>
	   		<loop COUNT="Variables.workflow_assignmentsTotal">
			   <WorkflowAssignment.GetID NAME="workflow_assignmentsCounters.assCounter" VARNAME="assignmentid"/>
			   <WorkflowAssignment.GetAssignedUserID NAME="workflow_assignmentsCounters.assCounter" VARNAME="assignedid"/>
			   <UserManager.GetUser USER="Variables.assignedid" OBJVARNAME="userobj"/>
			   <CCUser.GetDisplayableName NAME="userobj" VARNAME="assignedname"/>
			   <WorkflowAssignment.GetAssignedUserRole NAME="workflow_assignmentsCounters.assCounter" VARNAME="assignrole"/>
			   <UserManager.GetUsers ROLE="Variables.assignrole" SITE="SessionVariables.pubid" PREFIX="Users:"/>

			   <!-- Check if there is at least one user that is not already a participant for this role
                                Present a choice only if such a user exists. -->
			   <setvar NAME="haschoice" VALUE="false"/>
			   <setcounter NAME="userCounter" VALUE="0"/>
			   <loop COUNT="Variables.Users:Total">
				<CCUser.GetID NAME="Users:Counters.userCounter" VARNAME="userid"/>
				<Participants.DoesParticipantHaveRole NAME="participantsObj" VARNAME="boolean"
					ROLE="Variables.assignrole" USER="Variables.userid"/>
				<if COND="Variables.boolean=false">
				<then>
					<setvar NAME="haschoice" VALUE="true"/>
				</then>
				</if>
				<inccounter NAME="userCounter" VALUE="1"/>
			   </loop>

				<if COND="Variables.haschoice=true">
				<then>
					<TR>
						<TD VALIGN="TOP">
							<STRING.ENCODE VARIABLE="assignmentid:Counters.assCounter" VARNAME="assignmentid:Counters.assCounter"/>
							<if COND="Variables.workflow_assignmentsTotal=1">
							<then>
								<INPUT TYPE="hidden" NAME="assignmentid" VALUE="Variables.assignmentid:Counters.assCounter"  REPLACEALL="Variables.assignmentid,Counters.assCounter" />
							</then>
							<else>	
								<if COND="Counters.assCounter=0">
								<then>				
								<INPUT TYPE="RADIO" NAME="assignmentid" VALUE="Variables.assignmentid:Counters.assCounter"  CHECKED="yes" REPLACEALL="Variables.assignmentid,Counters.assCounter" />
								</then>
								<else>
								<INPUT TYPE="RADIO" NAME="assignmentid" VALUE="Variables.assignmentid:Counters.assCounter"  REPLACEALL="Variables.assignmentid,Counters.assCounter" />
								</else>
								</if>
							</else>
							</if>
								<STRING.STREAM VALUE="Variables.assignedname"/><br/>
						</TD>
						<TD>&nbsp;</TD>
						<TD VALIGN="TOP">

						<SELECT Name="DelegateUserCounters.assCounter" SIZE="4" REPLACEALL="Counters.assCounter">
						    <setcounter NAME="userCounter" VALUE="0"/>
						    <loop COUNT="Variables.Users:Total">
							<CCUser.GetID NAME="Users:Counters.userCounter" VARNAME="userid"/>
							<CCUser.GetDisplayableName NAME="Users:Counters.userCounter" VARNAME="username"/>
							<Participants.DoesParticipantHaveRole NAME="participantsObj" VARNAME="boolean"
								ROLE="Variables.assignrole" USER="Variables.userid"/>
							<if COND="Variables.boolean=false">
							<then>
								<if COND="Variables.assignedname!=Variables.username">
								<then>
									<if COND="Counters.userCounter=0">
									<then>				
										<OPTION VALUE="Variables.userid" REPLACEALL="Variables.userid" SELECTED="yes"/><STRING.STREAM VALUE="Variables.username"/> 
									</then>
									<else>
										<OPTION VALUE="Variables.userid" REPLACEALL="Variables.userid"/><STRING.STREAM VALUE="Variables.username"/> 
									</else>
									</if>
								</then>
								</if>
							</then>
							</if>
						    <inccounter NAME="userCounter" VALUE="1"/>
						    </loop>
						 </SELECT>
						</TD>
					</TR>
				</then>

				</if>
					<inccounter NAME="assCounter" VALUE="1"/>
	    		</loop>

	        <INPUT TYPE="HIDDEN" NAME="numusers" VALUE="Counters.assCounter" REPLACEALL="Counters.assCounter"/>
                </TR>
		        <TR>
		            <TD></TD>
		        </TR>
		<if COND="IsVariable.assignmentid=true">
		<then>
                  <TR>
                   <TD ALIGN="RIGHT" class="form-label-text"><XLAT.STREAM KEY="dvin/Common/Comments"/>:</TD>
                   <TD class="form-inset">
                      <TEXTAREA NAME="delegatecomment" ROWS="2" COLS="24" WRAP="VIRTUAL" onChange="checkLength(this.form.elements['delegatecomment'].value, 255, 'Action To Take'); setField(this.form.elements['delegatecomment'].value, 255, 'delegatecomment', this)"></TEXTAREA>
                   </TD>
                  </TR>
		</then>
		</if>
          </TABLE>
       </TD>
       <TD>
          <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/FooterBar"/>
       </TD>
    </TR>
    <TR>
        <BR/>
        <TD ALIGN="RIGHT">
           <XLAT.LOOKUP KEY="dvin/UI/Cancel" VARNAME="_XLAT_" ESCAPE="true"/>
           <SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/StatusDetailsFront" outstring="urlstatusdetfront">
               <satellite.argument name="cs_environment" value="Variables.cs_environment"/>
               <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
                                          <satellite.argument name="AssetType" value="Variables.AssetType"/>
                                          <satellite.argument name="id" value="Variables.id"/>
                                           </SATELLITE.LINK>
           <A HREF="Variables.urlstatusdetfront" onmouseover="window.status='Variables._XLAT_';return true;" onmouseout="window.status='';return true;"  REPLACEALL="Variables.urlstatusdetfront,Variables._XLAT_"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/Cancel"/></CALLELEMENT></A>   
	  <if COND="IsVariable.assignmentid=true">
	  <then>
            <XLAT.LOOKUP KEY="dvin/UI/Addtogroup" VARNAME="_XLAT_" ESCAPE="true"/>
            <A HREF="javascript:void(0)" onclick="document.forms[0].submit(); return false;" onmouseover="window.status='Variables._XLAT_';return true;" onmouseout="window.status='';return true;" REPLACEALL="Variables._XLAT_"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/Delegate"/></CALLELEMENT></A>
	  </then>
	  <else>
            <XLAT.LOOKUP KEY="dvin/UI/Addtogroup" VARNAME="_XLAT_" ESCAPE="true"/>
            <A HREF="javascript:void(0)" onClick="return Fixpagename(this,'OpenMarket/Xcelerate/Actions/DelegateAssignmentFront')" onmouseover="window.status='Variables._XLAT_';return true;" onmouseout="window.status='';return true;" REPLACEALL="Variables._XLAT_"><CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/TextButton"><ARGUMENT NAME="buttonkey" VALUE="UI/Forms/Delegate"/></CALLELEMENT></A>
	  </else>
	  </if>
        </TD>
    </TR>

    </TABLE>
<setvar NAME="PostPage" VALUE="DelegateAssignmentPost"/>

    <if COND="IsVariable.assignmentid=true">
    <then>
       	<INPUT type="hidden" name="pagename" value="OpenMarket/Xcelerate/Admin/Variables.PostPage" REPLACEALL="Variables.PostPage"/>
    </then>
    <else>
	<INPUT type="hidden" name="PostPage" value="Variables.PostPage" REPLACEALL="Variables.PostPage"/>
	<INPUT TYPE="hidden" NAME="pagename" VALUE="xx"/>
    </else>
    </if>
    <INPUT type="hidden" name="AssetType" VALUE="Variables.AssetType" REPLACEALL="Variables.AssetType"/>
    <INPUT type="hidden" name="id" VALUE="Variables.id" REPLACEALL="Variables.id"/>
</SATELLITE.FORM>
</then>
<else>
     <callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
        <argument NAME="elem" VALUE="Variables.ErrorName"/>
        <argument NAME="severity" VALUE="Variables.severity"/>
     </callelement>
     <callelement NAME="OpenMarket/Xcelerate/Actions/StatusDetailsFront">
        <argument NAME="AssetType" VALUE="Variables.AssetType"/>
        <argument NAME="id"        VALUE="Variables.id"/>
     </callelement>
</else>
</if>


</FTCS> 
