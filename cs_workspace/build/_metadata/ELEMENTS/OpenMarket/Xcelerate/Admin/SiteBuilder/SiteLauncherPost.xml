<?xml version="1.0" ?>
<!DOCTYPE ftcs SYSTEM "futuretense_cs.dtd">
<ftcs version="1.2">
<!-- OpenMarket/Xcelerate/Admin/SiteBuilder/SiteLauncherPost
-
- DESCRIPTION - Replicates a source site. Creates a new site (Publication).
-		Uses specifications in the SitePrototype tables to determine 
-		whether to share or copy each asset type. Shares all 
-		start menu items, workflows, tree tabs, asset subtypes between source
-		and new site. Copies all client configuration info from source site
-		to new site. 
-		User can specify which publish destinations to enable and whether 
-		to initialize them.

- INPUT
-	Variables.srcpubid			- id of the source site (Publication)
-  Variables.Publication:name	- name for the new site
-	Variables.Publication:description	- description for the new site
-  Variables.nodataassettypes - semi-colon separated list of assettypes for whom no data should be copied at all
-  Variables.shareassettypes	- semi-colon separated list of assettypes to share between source and new site
-  Variables.copyassettypes	- semi-colon separated list of assettypes to copy from source to new site
-	Variables.pubtarget			- semi-colon separated list of publish destination id's to enable
-  Variables.initmirror			- semi-colon separated list of publish destination for which to do a Initialize mirror operation
-	Variables.mirrorsite			- semi-colon separated list of publish destinations for which to do a MirrorSite
-	Variables.startpoint			- semi-colon separated list of publishdestination for which to make a start point
-
- OUTPUT
-
-->

<SETVAR NAME="doProceed" VALUE="true"/>
<STRING.ENCODE VARIABLE="srcpubid" VARNAME="srcpubid"/>
<STRING.ENCODE VARIABLE="Publication:name" VARNAME="Publication:name"/>
<STRING.ENCODE VARIABLE="Publication:description" VARNAME="Publication:description"/>
<!-- Load the source site -->		
<PUBLICATION.LOAD NAME="srcpub" OBJECTID="Variables.srcpubid"/>
<PUBLICATION.SCATTER NAME="srcpub" PREFIX="srcpub"/>

<!-- calling SendKeepAlive so that some keep alive response continuously being sent to the browser
     and the browser does not end with timeout error-->
<CALLELEMENT NAME="OpenMarket/Xcelerate/Util/SendKeepAlive" />

<!-- Create a new site -->
<IF COND="IsError.Variables.errno=false">
<THEN>
	<PUBLICATION.CREATE NAME="newpub"/>
	<PUBLICATION.GATHER NAME="newpub" PREFIX="Publication"/>
	<PUBLICATION.SAVE NAME="newpub"/>
	<IF COND="IsError.Variables.errno=false">
	<THEN>	
		<PUBLICATION.GET NAME="newpub" FIELD="id" OUTPUT="newpubid"/>
		<STRING.ENCODE VARIABLE="newpubid" VARNAME="newpubid"/>
		<!-- share the tree tabs to the new site -->		
		<TTM.GetAllOrderedTabs PUBID="Variables.srcpubid" LISTVARNAME="tabs"/>
		<!-- display message about how many start menus we are sharing -->
		<SETVAR NAME="numTreeTabs" VALUE="tabs.#numRows"/>
		<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/SharingTreeTabsMessage" VARNAME="msgtext"/>
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			<ARGUMENT NAME="severity" VALUE="info"/>
			<ARGUMENT NAME="msgtext" VALUE="Variables.msgtext"/>
		</CALLELEMENT>
		<STREAM.FLUSH/>
		
		<LOOP LIST="tabs">
			<TTM.LOAD OBJVARNAME="tab" ID="tabs.id"/>
			
			<TREETAB.GETSITES NAME="tab" OBJVARNAME="sites"/>
			<SITELIST.ADD NAME="sites" PUBID="Variables.newpubid"/>
			<TREETAB.SETSITES NAME="tab" OBJECT="sites"/>
			
			<TREETAB.GETSECTIONS NAME="tab" OBJVARNAME="sections"/>
			<SECTIONLIST.GETALL NAME="sections" PREFIX="all:"/>
			<SECTIONLIST.CLEAR NAME="sections"/>
			<SETCOUNTER NAME="sectionNum" VALUE="0"/>
			<LOOP UNTIL="Counters.sectionNum=Variables.all:Total">
				<SECTION.GETSITES NAME="all:Counters.sectionNum" OBJVARNAME="sectsites"/>
				<SITELIST.ADD NAME="sectsites" PUBID="Variables.newpubid"/>
				<SECTION.SETSITES NAME="all:Counters.sectionNum" OBJECT="sectsites"/>
				<SECTIONLIST.SET NAME="sections" OBJECT="all:Counters.sectionNum"/>
				<INCCOUNTER NAME="sectionNum" VALUE="1"/>
			</LOOP>
			<TREETAB.SETSECTIONS NAME="tab" OBJECT="sections"/>
			
			<TTM.SAVE OBJECT="tab"/>
			<IF COND="IsError.Variables.errno=true">
			<THEN>
				<SETVAR NAME="theerrno" VALUE="Variables.errno"/>
				<TREETAB.GETTITLE NAME="tab" VARNAME="objname"/>
				<XLAT.LOOKUP KEY="dvin/UI/Admin/TreeTabs" VARNAME="object"/>
				<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/ErrorsCopyingObjects" VARNAME="msgtext" errno="Variables.theerrno" object="Variables.object" EVALALL="false"/>
				<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					<ARGUMENT NAME="severity" VALUE="error"/>
				</CALLELEMENT>
			</THEN>
			</IF>
		</LOOP>
							
		<PROPERTY.GET PARAM="xcelerate.treeType" INIFILE="futuretense_xcel.ini" VARNAME="proptreetype"/>
		<IF  COND="IsElement.OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype=true">
		<THEN>
			<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/UpdateTreeVariables.proptreetype">
				<ARGUMENT NAME="__TreeRefreshKeys__" VALUE="Self:Sites"/>
			</CALLELEMENT>		
		</THEN>
		</IF>
	</THEN>
	<ELSE>
		<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/ErrorCreatingSite" errno="Variables.errno" EVALALL="false" VARNAME="msgtext"/>
		<SETVAR NAME="doProceed" VALUE="false"/>
	</ELSE>
	</IF>
</THEN>
<ELSE>
	<XLAT.LOOKUP KEY="dvin/UI/Admin/Error/loadingPublicationerrno" errno="Variables.errno" EVALALL="false" VARNAME="msgtext"/>
	<SETVAR NAME="doProceed" VALUE="false"/>
</ELSE>
</IF>	

<!-- publication is created, now replicate the assets -->
<IF COND="Variables.doProceed=true">
<THEN>
	<SETVAR NAME="prefix" VALUE="Variables.Publication:cs_prefix"/>
	<SETVAR NAME="srcprefix" VALUE="Variables.srcpub:cs_prefix"/>
	<!-- create the replicator -->
	<REPLICATEMANAGER.CREATE OBJVARNAME="replicator" SRCPUBID="Variables.srcpubid" NEWPUBID="Variables.newpubid" SRCPREFIX="Variables.srcprefix" NEWPREFIX="Variables.prefix"/>
	
	<!-- Enabled each asset type in the new site -->
	<!-- make a list of the mapping from src asset types to new asset type -->
	<LISTOBJECT.CREATE NAME="listobj" COLUMNS="srcassettype,newassettype" />
	<IF COND="IsVariable.nodataassettypes=true">
	<THEN>
		<!-- make a map of src asset type to new assettype and copy mode -->
		<STRINGLIST STR="Variables.nodataassettypes" DELIM=";" NAME="nodatatypes"/>
		<LOOP LIST="nodatatypes">
			<LISTOBJECT.ADDROW NAME="listobj" srcassettype="nodatatypes.ITEM" newassettype="nodatatypes.ITEM"/>
			<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/EnableAssetTypePub">
				<ARGUMENT NAME="upcommand" VALUE="EnableAssetType"/>
				<ARGUMENT NAME="assettype" VALUE="nodatatypes.ITEM"/>
				<ARGUMENT NAME="pubid" VALUE="Variables.newpubid"/>
			</CALLELEMENT>
		</LOOP>
	</THEN>
	</IF>	
	<IF COND="IsVariable.shareassettypes=true">
	<THEN>
		<!-- make a map of src asset type to new assettype and copy mode -->
		<STRINGLIST STR="Variables.shareassettypes" DELIM=";" NAME="sharetypes"/>
		<LOOP LIST="sharetypes">
			<LISTOBJECT.ADDROW NAME="listobj" srcassettype="sharetypes.ITEM" newassettype="sharetypes.ITEM"/>
			<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/EnableAssetTypePub">
				<ARGUMENT NAME="upcommand" VALUE="EnableAssetType"/>
				<ARGUMENT NAME="assettype" VALUE="sharetypes.ITEM"/>
				<ARGUMENT NAME="pubid" VALUE="Variables.newpubid"/>
			</CALLELEMENT>
		</LOOP>
	</THEN>
	</IF>			
	<IF COND="IsVariable.copyassettypes=true">
	<THEN>
		<!-- make a map of src asset type to new assettype and copy mode -->
		<STRINGLIST STR="Variables.copyassettypes" DELIM=";" NAME="copytypes"/>
		<LOOP LIST="copytypes">
			<LISTOBJECT.ADDROW NAME="listobj" srcassettype="copytypes.ITEM" newassettype="copytypes.ITEM"/>
			<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/EnableAssetTypePub">
				<ARGUMENT NAME="upcommand" VALUE="EnableAssetType"/>
				<ARGUMENT NAME="assettype" VALUE="copytypes.ITEM"/>
				<ARGUMENT NAME="pubid" VALUE="Variables.newpubid"/>
			</CALLELEMENT>
		</LOOP>
	</THEN>
	</IF>	
	<LISTOBJECT.TOLIST NAME="listobj" LISTVARNAME="AssetTypeMap" />
	
	<!-- record the mapping of new to old asset types -->
	<REPLICATE.MapAssetTypes NAME="replicator" LIST="AssetTypeMap"/>

	<!-- Get the asset ids, for all the shared assettypes -->
	<SETVAR NAME="message" VALUE="Variables.empty"/>
	<SETVAR NAME="pubid" VALUE="Variables.srcpubid"/>
	<IF COND="IsList.sharetypes=true">
	<THEN>
		<LOOP LIST="sharetypes">
			<SETVAR NAME="assettype" VALUE="sharetypes.ITEM"/>
			<SELECTTO LIST="allSrcAsset" FROM="AssetPublication" WHERE="pubid,assettype"/>
			<REPLICATE.SPECIFYASSETS NAME="replicator" LIST="allSrcAsset" MODE="share"/>
			<!-- add message indicating how many assets of this type we are sharing -->
			<ASSETTYPE.LOAD NAME="at" FIELD="assettype" VALUE="Variables.assettype"/>
			<ASSETTYPE.GET NAME="at" FIELD="description" OUTPUT="at:description"/>
			<ASSETTYPE.GET NAME="at" FIELD="plural" OUTPUT="at:plural"/>
			<SETVAR NAME="numAssets" VALUE="allSrcAsset.#numRows"/>
			<IF COND="allSrcAsset.#numRows=1">
			<THEN>
				<SETVAR NAME="atdescription" VALUE="Variables.at:description"/>
			</THEN>
			<ELSE>
				<SETVAR NAME="atdescription" VALUE="Variables.at:plural"/>
			</ELSE>
			</IF>
			<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/SharingAssetsMessage" VARNAME="msgpart"/>				
			<SETVAR NAME="message" VALUE="Variables.message%3cbr/%3e Variables.msgpart"/>
			
		</LOOP>
	</THEN>
	</IF>
	<IF COND="IsList.copytypes=true">
	<THEN>
		<LOOP LIST="copytypes">
			<SETVAR NAME="assettype" VALUE="copytypes.ITEM"/>
			<SELECTTO LIST="allSrcAsset" FROM="AssetPublication" WHERE="pubid,assettype"/>
			<REPLICATE.SPECIFYASSETS NAME="replicator" LIST="allSrcAsset" MODE="copy"/>
			<!-- add message indicating how many assets of this type we are sharing -->
			<ASSETTYPE.LOAD NAME="at" FIELD="assettype" VALUE="Variables.assettype"/>
			<ASSETTYPE.GET NAME="at" FIELD="description" OUTPUT="at:description"/>
			<ASSETTYPE.GET NAME="at" FIELD="plural" OUTPUT="at:plural"/>
			<SETVAR NAME="numAssets" VALUE="allSrcAsset.#numRows"/>
			<IF COND="allSrcAsset.#numRows=1">
			<THEN>
				<SETVAR NAME="atdescription" VALUE="Variables.at:description"/>
			</THEN>
			<ELSE>
				<SETVAR NAME="atdescription" VALUE="Variables.at:plural"/>
			</ELSE>
			</IF>
			<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/CopyingAssetsMessage" VARNAME="msgpart"/>				
			<SETVAR NAME="message" VALUE="Variables.message%3cbr/%3e Variables.msgpart"/>
		</LOOP>
	</THEN>
	</IF>	
	<IF COND="Variables.message!=Variables.empty">
	<THEN>
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			<ARGUMENT NAME="severity" VALUE="info"/>
			<ARGUMENT NAME="msgtext" VALUE="Variables.message"/>
		</CALLELEMENT>
		<STREAM.FLUSH />
	</THEN>
	</IF>
	
	<!-- copy/share the assets -->
	<REPLICATEMANAGER.COMMENCE OBJECT="replicator"/>
	<if COND="IsError.Variables.errno=true">
	<then>
		<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/errorsfromreplicate" VARNAME="errtext"/>
		<SETVAR NAME="msgtext" VALUE="Variables.errtext Variables.errdetail1"/>
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			<ARGUMENT NAME="severity" VALUE="error"/>
		</CALLELEMENT>
		<REPLICATE.GETID NAME="replicator" VARNAME="repid"/>
		<!-- for testing -->
		<!--<REPLICATEMANAGER.VERIFY ID="Variables.repid" LISTVARNAME="verify" VARNAME="verifyerrors"/>-->
	</then>
	<else>
		<REPLICATE.GETID NAME="replicator" VARNAME="repid"/>
		<!-- for testing -->
		<!--<REPLICATEMANAGER.VERIFY ID="Variables.repid" LISTVARNAME="verify" VARNAME="verifyerrors"/>-->
		<!-- delete the replicate object if we have no errors -->
		<REPLICATEMANAGER.DELETE ID="Variables.repid"/>
		
	</else>
	</if>

	<!-- Share all Start Menus of source -->
	<SETVAR NAME="startmenuids" VALUE="Variables.empty"/>
	<STARTMENU.GETALLSTARTITEMS PUBID="Variables.srcpubid" LISTVARNAME="AllStartMenus"/>
	<IF COND="AllStartMenus.#numRows!=0">
	<THEN>
		<!-- display message about how many start menus we are sharing -->
		<SETVAR NAME="numStartMenuItems" VALUE="AllStartMenus.#numRows"/>
		<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/SharingStartMenuItemsMessage" VARNAME="msgtext"/>
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			<ARGUMENT NAME="severity" VALUE="info"/>
			<ARGUMENT NAME="msgtext" VALUE="Variables.msgtext"/>
		</CALLELEMENT>
		<STREAM.FLUSH/>
		<!-- share them -->
		<LOOP LIST="AllStartMenus">
			<STARTMENU.LOAD OBJVARNAME="sm" ID="AllStartMenus.id"/>
			<STARTMENUITEM.GETID NAME="sm" VARNAME="sm:id"/>
			<!-- make a list of id's in case we need to mirror site -->
			<IF COND="Variables.startmenuids=Variables.empty">
			<THEN>
				<SETVAR NAME="startmenuids" VALUE="Variables.sm:id"/>
			</THEN>
			<ELSE>
				<SETVAR NAME="startmenuids" VALUE="Variables.startmenuids,Variables.sm:id"/>
			</ELSE>
			</IF>
			<STARTMENUITEM.GETLEGALSITES NAME="sm" OBJVARNAME="sitelist"/>
			<!-- do nothing if it already set to all sites -->
			<SITELIST.ISALL NAME="sitelist" VARNAME="allsites"/>
			<IF COND="Variables.allssites!=true">
			<THEN>
				<!-- share to new site -->
				<SITELIST.ADD NAME="sitelist" PUBID="Variables.newpubid"/>
				<STARTMENUITEM.SETSITES NAME="sm" OBJECT="sitelist"/>
				<STARTMENUITEM.SETLEGALSITES NAME="sm" OBJECT="sitelist"/>
				<STARTMENU.SAVE OBJECT="sm"/>
				<IF COND="IsError.Variables.errno=true">
				<THEN>
					<SETVAR NAME="theerrno" VALUE="Variables.errno"/>
					<STARTMENUITEM.GETNAME NAME="sm" VARNAME="objname"/>
					<XLAT.LOOKUP KEY="dvin/UI/Admin/StartMenuItem" VARNAME="object"/>
					<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/ErrorsSharingObjects" VARNAME="msgtext" errno="Variables.theerrno" object="Variables.object" EVALALL="false"/>
					<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
						<ARGUMENT NAME="severity" VALUE="error"/>
					</CALLELEMENT>
				</THEN>
				</IF>
			</THEN>
			</IF>
		</LOOP>
	</THEN>
	</IF>
	
	<!-- Share any configurable subtypes -->
	<LOOP LIST="AssetTypeMap">
		<SUBTYPES.GETSUBTYPES LISTVARNAME="subtypes" ASSETTYPE="AssetTypeMap.srcassettype" PUBID="Variables.srcpubid"/>
		<if COND="subtypes.#numRows!=0">
		<then>
			<LOOP LIST="subtypes">
				<SUBTYPES.ADD ASSETTYPE="AssetTypeMap.srcassettype" PUBID="Variables.newpubid" SUBTYPE="subtypes.subtype"/>
				<IF COND="IsError.Variables.errno=true">
				<THEN>
					<SETVAR NAME="theerrno" VALUE="Variables.errno"/>
					<SETVAR NAME="objname" VALUE="subtypes.subtype"/>
					<XLAT.LOOKUP KEY="dvin/Common/Subtype" VARNAME="object"/>
					<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/ErrorsCopyingObjects" VARNAME="msgtext" errno="Variables.theerrno" object="Variables.object" EVALALL="false"/>
					<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
						<ARGUMENT NAME="severity" VALUE="error"/>
					</CALLELEMENT>
				</THEN>
				</IF>
			</LOOP>
		</then>
		</if>
	</LOOP>
   
	<!-- Copy any client configuration info -->
	<!-- CS-Desktop -->
	 <EXTERNALCLIENTSMANAGER.GetEnabledAssetTypesForAClient LISTVARNAME="desktopassettype"
	 	SITE="Variables.srcpubid" CLIENTAPP="MSWord"/>
	 <IF COND="desktopassettype.#numRows!=0">
	 <THEN>
	 	<!-- display message about CS-Desktop configuration-->
		<SETVAR NAME="assettypes" VALUE="Variables.empty"/>
		<LOOP LIST="desktopassettype">
		 	<IF COND="Variables.assettypes=Variables.empty">
		 	<THEN>
		 		<SETVAR NAME="assettypes" VALUE="desktopassettype.assettype"/>
			</THEN>
			<ELSE>
		 		<SETVAR NAME="assettypes" VALUE="Variables.assettypes,desktopassettype.assettype"/>
		 	</ELSE>
		 	</IF>
		</LOOP>
		<SETVAR NAME="numDesktop" VALUE="desktopassettype.#numRows"/>
		<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/CopyingCSDesktopConfigurationMessage" VARNAME="msgtext"/>
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			<ARGUMENT NAME="severity" VALUE="info"/>
			<ARGUMENT NAME="msgtext" VALUE="Variables.msgtext"/>
		</CALLELEMENT>
		<STREAM.FLUSH/>
		 <LOOP LIST="desktopassettype">
		 	<!-- get all the config information per asset type -->
			<EXTERNALCLIENTSCONFIGMANAGER.GETITEMLIST LISTVARNAME="cList" 
				CLIENTID="desktopassettype.id"/>
			<EXTERNALCLIENTSMANAGER.CREATE OBJVARNAME="newRec" />
			<EXTERNALCLIENTSITEM.SETASSETTYPE NAME="newRec" VALUE="desktopassettype.assettype"/>
			<EXTERNALCLIENTSITEM.SETCLIENTAPP NAME="newRec" VALUE="MSWord"/>
			<EXTERNALCLIENTSITEM.SETPUBID NAME="newRec" VALUE="Variables.newpubid"/>
			<EXTERNALCLIENTSMANAGER.SAVE OBJECT="newRec" />	
			<IF COND="IsError.Variables.errno=true">
			<THEN>
				<SETVAR NAME="theerrno" VALUE="Variables.errno"/>
				<SETVAR NAME="objname" VALUE="desktopassettype.assettype"/>
				<XLAT.LOOKUP KEY="dvin/UI/CSDesktop" VARNAME="object"/>
				<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/ErrorsCopyingObjects" VARNAME="msgtext" errno="Variables.theerrno" object="Variables.object" EVALALL="false"/>
				<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					<ARGUMENT NAME="severity" VALUE="error"/>
				</CALLELEMENT>
			</THEN>
			</IF>
			<EXTERNALCLIENTSITEM.GETID NAME="newRec" VARNAME="clientid" />	
			
			<LOOP LIST="cList">
				<EXTERNALCLIENTSCONFIGMANAGER.CREATE OBJVARNAME="aRec" />
				<EXTERNALCLIENTSCONFIGITEM.SETCLIENTID NAME="aRec" VALUE="Variables.clientid"/>
				<EXTERNALCLIENTSCONFIGITEM.SETSUBTYPE NAME="aRec" VALUE="cList.subtype"/>
				<EXTERNALCLIENTSCONFIGITEM.SETACTION NAME="aRec" VALUE="cList.action"/>
				<EXTERNALCLIENTSCONFIGITEM.SETVALUE NAME="aRec" VALUE="cList.value"/>
				<EXTERNALCLIENTSCONFIGITEM.SETPROPERTY NAME="aRec" VALUE="cList.property"/>
				<EXTERNALCLIENTSCONFIGMANAGER.SAVE OBJECT="aRec"/>
				<IF COND="IsError.Variables.errno=true">
				<THEN>
					<SETVAR NAME="theerrno" VALUE="Variables.errno"/>
					<SETVAR NAME="objname" VALUE="desktopassettype.assettype"/>
					<XLAT.LOOKUP KEY="dvin/UI/CSDesktop" VARNAME="object"/>
					<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/ErrorsCopyingObjects" VARNAME="msgtext" errno="Variables.theerrno" object="Variables.object" EVALALL="false"/>
					<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
						<ARGUMENT NAME="severity" VALUE="error"/>
					</CALLELEMENT>
				</THEN>
				</IF>
			</LOOP>
		</LOOP>
	</THEN>
	</IF>

	<!-- CS-DocLink -->
	<EXTERNALCLIENTSMANAGER.GetEnabledAssetTypesForAClient LISTVARNAME="doclinkassettype"
	 	SITE="Variables.srcpubid" CLIENTAPP="CSDocLink"/>
	<IF COND="doclinkassettype.#numRows!=0">
	<THEN>
	 	<!-- display message about CS-DocLink configuration-->
		<SETVAR NAME="assettypes" VALUE="Variables.empty"/>
		<LOOP LIST="doclinkassettype">
		 	<IF COND="Variables.assettypes=Variables.empty">
			<THEN>
				<SETVAR NAME="assettypes" VALUE="doclinkassettype.assettype"/>
			</THEN>
			<ELSE>
				<SETVAR NAME="assettypes" VALUE="Variables.assettypes,doclinkassettype.assettype"/>
		 	</ELSE>
		 	</IF>
		 </LOOP>
		<SETVAR NAME="numDocLink" VALUE="doclinkassettype.#numRows"/>
		<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/CopyingCSDocLinkConfigurationMessage" VARNAME="msgtext"/>
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			<ARGUMENT NAME="severity" VALUE="info"/>
			<ARGUMENT NAME="msgtext" VALUE="Variables.msgtext"/>
		</CALLELEMENT>
		<STREAM.FLUSH/>
		<LOOP LIST="doclinkassettype">
		 	<!-- get all the config information per asset type -->
			<EXTERNALCLIENTSCONFIGMANAGER.GETITEMLIST LISTVARNAME="cList" 
				CLIENTID="doclinkassettype.id"/>
			<EXTERNALCLIENTSMANAGER.CREATE OBJVARNAME="newRec" />
			<EXTERNALCLIENTSITEM.SETASSETTYPE NAME="newRec" VALUE="doclinkassettype.assettype"/>
			<EXTERNALCLIENTSITEM.SETCLIENTAPP NAME="newRec" VALUE="CSDocLink"/>
			<EXTERNALCLIENTSITEM.SETPUBID NAME="newRec" VALUE="Variables.newpubid"/>
			<EXTERNALCLIENTSMANAGER.SAVE OBJECT="newRec" />	
			<IF COND="IsError.Variables.errno=true">
			<THEN>
				<SETVAR NAME="theerrno" VALUE="Variables.errno"/>
				<SETVAR NAME="objname" VALUE="doclinkassettype.assettype"/>
				<XLAT.LOOKUP KEY="dvin/UI/Admin/CSDocLink" VARNAME="object"/>
				<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/ErrorsCopyingObjects" VARNAME="msgtext" errno="Variables.theerrno" object="Variables.object" EVALALL="false"/>
				<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					<ARGUMENT NAME="severity" VALUE="error"/>
				</CALLELEMENT>
			</THEN>
			</IF>
			<EXTERNALCLIENTSITEM.GETID NAME="newRec" VARNAME="clientid" />	
			<LOOP LIST="cList">
				<EXTERNALCLIENTSCONFIGMANAGER.CREATE OBJVARNAME="aRec" />
				<EXTERNALCLIENTSCONFIGITEM.SETCLIENTID NAME="aRec" VALUE="Variables.clientid"/>
				<EXTERNALCLIENTSCONFIGITEM.SETSUBTYPE NAME="aRec" VALUE="cList.subtype"/>
				<EXTERNALCLIENTSCONFIGITEM.SETACTION NAME="aRec" VALUE="cList.action"/>
				<EXTERNALCLIENTSCONFIGITEM.SETVALUE NAME="aRec" VALUE="cList.value"/>
				<EXTERNALCLIENTSCONFIGITEM.SETPROPERTY NAME="aRec" VALUE="cList.property"/>
				<EXTERNALCLIENTSCONFIGMANAGER.SAVE OBJECT="aRec"/>
				<IF COND="IsError.Variables.errno=true">
				<THEN>
					<SETVAR NAME="theerrno" VALUE="Variables.errno"/>
					<SETVAR NAME="objname" VALUE="doclinkassettype.assettype"/>
					<XLAT.LOOKUP KEY="dvin/UI/Admin/CSDocLink" VARNAME="object"/>
					<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/ErrorsCopyingObjects" VARNAME="msgtext" errno="Variables.theerrno" object="Variables.object" EVALALL="false"/>
					<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
						<ARGUMENT NAME="severity" VALUE="error"/>
					</CALLELEMENT>
				</THEN>
				</IF>
			</LOOP>
		</LOOP>
	</THEN>
	</IF>

	<!-- Workflow -->
	<WORKFLOWENGINE.GETALLPROCESSES  PREFIX="wf:" PUBID="Variables.srcpubid" />
	<IF COND="Variables.wf:Total!=0">
	<THEN>
	 	<!-- display message about Workflow processes-->
		<SETVAR NAME="numWorkflows" VALUE="Variables.wf:Total"/>
		<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/SharingWorkflowsMessage" VARNAME="msgtext"/>
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			<ARGUMENT NAME="severity" VALUE="info"/>
			<ARGUMENT NAME="msgtext" VALUE="Variables.msgtext"/>
		</CALLELEMENT>
		<STREAM.FLUSH/>
		<!-- make a list of workflow ids, in case we need them in init mirror publish -->
		<SETVAR NAME="workflowids" VALUE="Variables.empty"/>
		
		<!-- share each workflow process -->
		<SETCOUNTER NAME="nth" VALUE="0"/>
		<LOOP COUNT="Variables.wf:Total">
			<WORKFLOWPROCESS.GETID NAME="wf:Counters.nth" VARNAME="wf:id"/>
			<IF COND="Variables.workflowids=Variables.empty">
			<THEN>
				<SETVAR NAME="workflowids" VALUE="Variables.wf:id"/>
			</THEN>
			<ELSE>
				<SETVAR NAME="workflowids" VALUE="Variables.workflowids,Variables.wf:id"/>
			</ELSE>
			</IF>
			
			<WORKFLOWPROCESS.GETSITES NAME="wf:Counters.nth" OBJVARNAME="sitelist"/>
			<SITELIST.ISALL NAME="sitelist" VARNAME="allsites"/>
			<!-- if already set to all sites, do nothing -->
			<IF COND="Variables.allsites!=true">
			<THEN>
				<SITELIST.ADD NAME="sitelist" PUBID="Variables.newpubid"/>
				<WORKFLOWPROCESS.SETSITES NAME="wf:Counters.nth" OBJECT="sitelist"/>
			</THEN>
			</IF>
			<WORKFLOWENGINE.SETPROCESS OBJECT="wf:Counters.nth"/>
			<IF COND="IsError.Variables.errno=true">
			<THEN>
				<SETVAR NAME="theerrno" VALUE="Variables.errno"/>
				<WORKFLOWPROCESS.GETPROCESSNAME NAME="wf:Counters.nth" VARNAME="objname"/>
				<XLAT.LOOKUP KEY="dvin/Common/WorkflowProcess" VARNAME="object"/>
				<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/ErrorsCopyingObjects" VARNAME="msgtext" errno="Variables.theerrno" object="Variables.object" EVALALL="false"/>
				<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					<ARGUMENT NAME="severity" VALUE="error"/>
				</CALLELEMENT>
			</THEN>
			</IF>
			<INCCOUNTER NAME="nth" VALUE="1"/>
		</LOOP>
	</THEN>
	</IF>

	<!-- publish destinations --> 
	<IF COND="IsVariable.pubtarget=true">
	<THEN>
		<STRINGLIST NAME="targetids" STR="Variables.pubtarget" DELIM=";"/>
		<SETVAR NAME="numTargets" VALUE="targetids.#numRows"/>
	 	<!-- display message about Publish destinations-->
		<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/SharingPubTargetsMessage" VARNAME="msgtext"/>
		<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
			<ARGUMENT NAME="severity" VALUE="info"/>
			<ARGUMENT NAME="msgtext" VALUE="Variables.msgtext"/>
		</CALLELEMENT>
		<STREAM.FLUSH/>
		<!-- enable them -->
		<LOOP LIST="targetids">
			<PUBTARGETMANAGER.LOAD ID="targetids.ITEM" OBJVARNAME="pubtgt"/>
			<PUBTARGET.GETSITES NAME="pubtgt" OBJVARNAME="sites"/>
			<SITELIST.ADD NAME="sites" PUBID="Variables.newpubid"/>
			<PUBTARGET.SETSITES NAME="pubtgt" OBJECT="sites"/>
			<PUBTARGETMANAGER.SAVE OBJECT="pubtgt"/>
			<IF COND="IsError.Variables.errno=true">
			<THEN>
				<SETVAR NAME="theerrno" VALUE="Variables.errno"/>
				<PUBTARGET.GETNAME NAME="pubtgt" VARNAME="objname"/>
				<XLAT.LOOKUP KEY="dvin/UI/Publishdestination" VARNAME="object"/>
				<XLAT.LOOKUP KEY="dvin/CSSiteBuilder/ErrorsSharingObject" VARNAME="msgtext" errno="Variables.theerrno" object="Variables.object" EVALALL="false"/>
				<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					<ARGUMENT NAME="severity" VALUE="error"/>
				</CALLELEMENT>
			</THEN>
			</IF>
		</LOOP>
		<!-- set start points for static sites, if requested -->
		<IF COND="IsVariable.startpoint=true">
		<THEN>
			<!-- get the first page in the SitePlanTree-->
			<SITEPLAN.ROOT LIST="PubRoot" OBJECTID="Variables.newpubid"/>
			<SITEPLAN.LOAD NAME="root" NODEID="PubRoot.nid"/>
			<SITEPLAN.CHILDREN NAME="root" LIST="PlacedPages" OBJECTTYPE="Page" CODE="Placed" ORDER="nrank"/>

			<STRINGLIST NAME="startpoints" STR="Variables.startpoint" DELIM=";"/>
			<LOOP LIST="startpoints">
				<SETVAR NAME="target" VALUE="startpoints.ITEM"/>
				<SETVAR NAME="assetid" VALUE="PlacedPages.id"/>			
				<APPROVEDASSETS.GETPERM TARGET="Variables.target" ASSETID="Variables.assetid" OBJVARNAME="publishpoints" />
				<SETVAR NAME="ref" VALUE="c=Page&#38;cid=Variables.assetid&#38;pagename=OpenMarket/Xcelerate/Export" />
				<EXPORTKEY.CREATE REFERENCE="Variables.ref" ID="Variables.assetid" OBJVARNAME="exportkey" />
				<PUBLISHPOINTS.ADD NAME="publishpoints" KEY="exportkey"/>
				<APPROVEDASSETS.SETPERM TARGET="Variables.target" ASSETID="Variables.assetid" POINTS="publishpoints" />
			</LOOP>
		</THEN>
		</IF>
		
		<!-- initialize mirror sites -->
		<IF COND="IsVariable.initmirror=true">
		<THEN>
			<STRINGLIST NAME="inittarget" STR="Variables.initmirror" DELIM=";"/>
			<LOOP LIST="inittarget">
				<CALLELEMENT NAME="OpenMarket/Xcelerate/Admin/MirrorSitePost">
					<ARGUMENT NAME="pubid" VALUE="Variables.newpubid"/>
					<ARGUMENT NAME="target" VALUE="inittarget.ITEM"/>
					<ARGUMENT NAME="cs_ExcludeSite" VALUE="false"/>
					<ARGUMENT NAME="cs_ExcludePlan" VALUE="false"/>
					<ARGUMENT NAME="cs_Verbose" VALUE="false"/>
				</CALLELEMENT>
			</LOOP>	
		</THEN>
		</IF>
		
		<!-- initialize mirror sites -->
		<IF COND="IsVariable.mirrorsite=true">
		<THEN>
			<!-- list the assettypes -->
			<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/EnableAssetTypePub">
				<ARGUMENT NAME="upcommand" VALUE="ListEnabledAssetTypes"/>
				<ARGUMENT NAME="list" VALUE="EnabledAssetTypes"/>
				<ARGUMENT NAME="pubid" VALUE="Variables.newpubid"/>
			</CALLELEMENT>
			<SETVAR NAME="assettypes" VALUE="Variables.empty"/>
			<LOOP LIST="EnabledAssetTypes">
				<if COND="Variables.assettypes=Variables.empty">
				<then>
					<SETVAR NAME="assettypes" VALUE="EnabledAssetTypes.assettype"/>
				</then>
				<else>
					<SETVAR NAME="assettypes" VALUE="Variables.assettypes,EnabledAssetTypes.assettype"/>
				</else>
				</if>
			</LOOP>
			
			<STRINGLIST NAME="mirrorsite" STR="Variables.mirrorsite" DELIM=";"/>
			<LOOP LIST="mirrorsite">
				
				<CALLELEMENT NAME="OpenMarket/Xcelerate/Admin/MirrorSitePost">
					<ARGUMENT NAME="pubid" VALUE="Variables.newpubid"/>
					<ARGUMENT NAME="target" VALUE="mirrorsite.ITEM"/>
					<ARGUMENT NAME="cs_ExcludeSite" VALUE="false"/>
					<ARGUMENT NAME="cs_ExcludePlan" VALUE="false"/>
					<ARGUMENT NAME="cs_Verbose" VALUE="false"/>
					<ARGUMENT NAME="assettypes" VALUE="Variables.assettypes"/>
					<ARGUMENT NAME="assetsubtypes" VALUE="true"/>
					<ARGUMENT NAME="assetassociations" VALUE="true"/>
					<ARGUMENT NAME="cs-desktop" VALUE="true"/>
					<ARGUMENT NAME="cs-doclink" VALUE="true"/>
					<ARGUMENT NAME="startmenus" VALUE="Variables.startmenuids"/>
					<ARGUMENT NAME="workflows" VALUE="Variables.workflowids"/>
				</CALLELEMENT>
			</LOOP>	
		</THEN>
		</IF>
	</THEN>
	</IF>	

</THEN>
</IF>

<IF COND="Variables.doProceed=false">
<THEN>
	<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
		<ARGUMENT NAME="severity" VALUE="error"/>
	</CALLELEMENT>
</THEN>
</IF>

<!-- if we successfully created a new site, show that -->
<IF COND="IsVariable.newpubid=true">
<THEN>
	<CALLELEMENT NAME="OpenMarket/Xcelerate/Admin/SiteFront">
		<ARGUMENT NAME="pubid" VALUE="Variables.newpubid"/>
		<ARGUMENT NAME="action" VALUE="details"/>
		<ARGUMENT NAME="showtitle" VALUE="true"/>
	</CALLELEMENT>
	<IF COND="IsVariable.verifyerrors=true">
	<THEN>
		<STRINGLIST STR="Variables.verifyerrors" NAME="verifyerrs" DELIM=";"/>
		<LOOP LIST="verifyerrs">
			<STRING.STREAM VALUE="verifyerrs.ITEM"/><br/>
		</LOOP>
	</THEN>
	</IF>
	<IF COND="IsList.verify=true">
	<THEN>
		<table border="1">
			<LOOP LIST="verify">
				<tr>
					<td><STRING.STREAM VALUE="verify.srcid"/></td>
					<td>
						<STRINGLIST STR="verify.srcfields" NAME="diffs" DELIM=";"/>
						<LOOP LIST="diffs">
							<STRING.STREAM VALUE="diffs.ITEM"/><br/>
						</LOOP>
					</td>
					<td><STRING.STREAM VALUE="verify.newid"/></td>
					<td>
						<STRINGLIST STR="verify.newfields" NAME="diffs" DELIM=";"/>
						<LOOP LIST="diffs">
							<STRING.STREAM VALUE="diffs.ITEM"/><br/>
						</LOOP>
					</td>
				</tr>
			</LOOP>
		</table>
	</THEN>
	</IF>
</THEN>
<ELSE>
	<!-- if we failed to create a new site, show the source site -->
	<CALLELEMENT NAME="OpenMarket/Xcelerate/Admin/SiteFront">
		<ARGUMENT NAME="pubid" VALUE="Variables.srcpubid"/>
		<ARGUMENT NAME="action" VALUE="details"/>
		<ARGUMENT NAME="showtitle" VALUE="true"/>
	</CALLELEMENT>
</ELSE>
</IF>


</ftcs>