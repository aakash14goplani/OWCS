<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">

<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/AssetType/Page/UnplacedPageParents
-
- INPUT
-
- OUTPUT
-
-->

<!-- Signal that we handled the request -->
<SETVAR NAME="loadexecuted" VALUE="true"/>

<!-- expand the Unplaced Pages dummy node -->
<SITEPLAN.ROOT LIST="PubRoot" OBJECTID="SessionVariables.pubid"/>
	
<!-- No special criteria; just grab all the nodes -->
<setvar  NAME="tablename" VALUE="SitePlanTree"/>
<execsql LIST="children" TABLE="SitePlanTree,Page" 
    	 SQL="select siteplantree.nid,siteplantree.otype,siteplantree.oid,siteplantree.oversion from siteplantree,Page 
	          where siteplantree.nparentid = PubRoot.nid and
	          siteplantree.otype='Page' and siteplantree.ncode='UnPlaced'  and 
	          siteplantree.oid=Page.id and Page.status !='VO' order by Page.name" />
	          
<SETVAR NAME='tmpOkFunctions' VALUE='edit;delete;treerefresh' />

<SETVAR NAME='tmpOkFunctions' VALUE='Variables.tmpOkFunctions;copy-site-navigation;paste-site-navigation;approve' />

<IF COND="IsList.children=true">
<THEN>	
	<IF COND="children.#numRows!=0">
	<THEN>
	    <callelement NAME="OpenMarket/Xcelerate/Util/LoadProperty">
					<argument NAME="property" VALUE="xcelerate.treeMaxNodes"/>
					<argument NAME="ini" VALUE="futuretense_xcel.ini"/>
					<argument NAME="varname" VALUE="TOOMANY"/>
		</callelement>
		
		<!--  Set the Total Count in the immediate children ALL Result Set List -->				
		<setvar NAME="COUNT" VALUE="children.#numRows"/>					
				
		<!--  Set the Total Count in the immediate children ALL Result Set List -->				
		<setvar NAME="totalNodes" VALUE="children.#numRows"/>					
		<setvar NAME="FETCH" VALUE="Variables.COUNT"/>				   	  		  
	  	<setvar NAME="maxNodes" VALUE="no"/>	
	  		
	  	<!-- compare COUNT and TooMany, SET THE COUNT TO MAXNODES -->
		<CALCULATOR.GO VALUE="Variables.COUNT Variables.TOOMANY GT" VARNAME="ANS"/>							
		<if COND="Variables.ANS=1">
		<then>
			<!--   <CALCULATOR.GO VALUE="Variables.FROM Variables.TOOMANY +" VARNAME="FETCH"/>  --> 							
			<setvar NAME="FETCH" VALUE="Variables.TOOMANY"/>	
			<!-- Set the reached max nodes indicator parameter  --> 
		    <setvar NAME="maxNodes" VALUE="yes"/>	
	  	</then>
		</if>
		
		<!--  	
	  	  <LOGMSG STR="$UnplacedPageParents FETCHED = Variables.totalNodes MAX = Variables.TOOMANY FETCH = Variables.FETCH " />
	   	--> 
		<LOOP LIST="children" FROM="Variables.FROM"  COUNT="Variables.FETCH">
				
			<SITEPLAN.LOAD NAME="thePage" NODEID="children.nid"/>
			<ASSET.LOAD NAME="currentChild" TYPE="children.otype" OBJECTID="children.oid"/>
			<ASSET.GET NAME="currentChild" FIELD="name" OUTPUT="currentName"/>
			<ASSET.GET NAME="currentChild" FIELD="description" OUTPUT="currentDesc"/>
			<SITEPLAN.CHILDREN NAME="thePage" LIST="grandchildren" ORDER="nrank"/>
								
			<REMOVEVAR NAME="LoadURL"/>
			<IF COND="IsList.grandchildren=true">
			<THEN>
				<IF COND="grandchildren.#numRows!=0">
				<THEN>
					<SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Gator/UIFramework/LoadTab" outstring="LoadURL">
						<satellite.argument name="AssetType" value="children.otype"/>
						<satellite.argument name="populate" value="OpenMarket/Xcelerate/AssetType/children.otype/LoadSiteTree"/>
						<satellite.argument name="op" value="load"/>
						<satellite.argument name="loadpages" value="children.nid"/>
					</SATELLITE.LINK>
				</THEN>
				</IF>
			</THEN>
			</IF>
										
			<SETVAR NAME="oldat" VALUE="Variables.AssetType"/>
			<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNodeID" SCOPED="STACKED">
				<ARGUMENT NAME="ID" VALUE="children.oid"/>
				<ARGUMENT NAME="AssetType" VALUE="children.otype"/>
				<ARGUMENT NAME="TreeNodeID" VALUE="Variables.empty"/>
			</CALLELEMENT>
				
			<SETVAR NAME="AssetType" VALUE="Variables.oldat"/>
										
			<CALLELEMENT NAME="OpenMarket/Gator/UIFramework/BuildTreeNode">
				<ARGUMENT NAME="Label" VALUE="Variables.currentName"/>
				<ARGUMENT NAME="ID" VALUE="Variables.TreeNodeID"/>									   
				<ARGUMENT NAME="okFunctions" VALUE="Variables.tmpOkFunctions" />							
				<ARGUMENT NAME="executeFunction" VALUE="Variables.cs_defaultFunctionChild" />
				<ARGUMENT NAME="Image" VALUE="Variables.cs_imagedir/OMTree/TreeImages/AssetTypes/children.otype.png"/>
				<ARGUMENT NAME="RefreshKeys" VALUE="children.oid;children.nid"/>  
				<!--  
						  SitePlanTree SPN Node Record identifier  
						  Used to detect, track and manage 
					      spn dnd stale nodes 
				-->				
				<ARGUMENT NAME="nid" VALUE="children.nid"/>
				<ARGUMENT NAME="oid" VALUE="children.oid"/>
				<ARGUMENT NAME="otype" VALUE="children.otype"/>			
				<ARGUMENT NAME="oversion" VALUE="children.oversion"/>						
			</CALLELEMENT>
		</LOOP>
 	</THEN>
 	</IF>
</THEN>
</IF>	

<REMOVEVAR NAME='Variables.tmpOkFunctions' />				
</FTCS>