<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/PrologActions/RollbackFront.xml $ 
$Revision: 15 $ 
$Modtime: 6/28/04 1:10p $ 
-->

<!--
- Confidential and Proprietary Information of Open Market Inc.
-					All Rights Reserved.
-
- RollbackFront.xml
-
- DESCRIPTION
-	
-
- HISTORY 
-->
<setvar NAME="doproceed" VALUE="true"/>
<!-- 
    Can only rollback something if it has been
    locked. Also must be placed under revision
    control to start with!
-->
    <callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
        <argument NAME="AssetType" VALUE="Variables.AssetType"/>
    </callelement>

<if COND="Variables.trackingenabled!=true">
<then>
	<setvar NAME="doproceed" VALUE="RollbackWillFail"/>
</then>
</if>

<if COND="Variables.trackingenabled=true">
<then>
     <history TABLE="Variables.AssetType" ASSET="Variables.id" LIST="ItsHistory"/>
    <if COND="ItsHistory.#numRows!=0">
    <then>
        <if COND="ItsHistory.lockedby!=Variables.empty">
        <then>
            <SETVAR NAME="doproceed" VALUE="RollbackSomeCheckedOut"/>
        </then>
        </if>
    </then>
    </if>
</then>
</if>

<if COND="Variables.doproceed=true">
<then>
	 <setvar NAME="assetname" VALUE="theAsset"/>
	 <setvar NAME="assetObjectName" VALUE="theAsset"/>
	 <ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Variables.assetObjectName"/>
	<if COND="IsError.Variables.errno=true">
	    <then>        
	        <setvar NAME="doproceed" VALUE="InvalidContentId"/>
	    </then>
	</if>
		 
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="id" OUTPUT="id"/>
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="name" OUTPUT="tempassetname"/>
	<if COND="Variables.doproceed=true">
	<then>
		<!-- check whether we can perform this function on this asset -->
		<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/AccessCheck">
			<ARGUMENT NAME="assetObjectName" VALUE="Variables.assetObjectName"/>
			<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
			<ARGUMENT NAME="pubid" VALUE="SessionVariables.pubid"/>
			<ARGUMENT NAME="id" VALUE="Variables.id"/>
			<ARGUMENT NAME="Function" VALUE="rollback"/>
		</CALLELEMENT>
		<IF COND="Variables.error!=Variables.empty">
		<THEN>
		 	<!-- -12069 means allow edit but display warning, any other error means prohibit edit -->
		 	<if COND="Variables.errno=-12069">
		 	<then>
				<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					<argument NAME="elem" VALUE="EditNotAllowed"/>
					<argument NAME="severity" VALUE="info"/>
					<argument NAME="assettype" VALUE="Variables.AssetType"/>
					<argument NAME="id" VALUE="Variables.id"/>
				</callelement>
			</then>
			<else>
		     <setvar NAME="doproceed" VALUE="Variables.error"/>
		   </else>
		   </if>
		</THEN>
		</IF>
	</then>
	</if>
</then>
</if>

</FTCS>
