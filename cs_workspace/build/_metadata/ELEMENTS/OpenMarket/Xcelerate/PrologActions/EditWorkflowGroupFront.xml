<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/PrologActions/EditWorkflowGroupFront
-
- INPUT
-
- OUTPUT
-
-->
<if COND="Variables.id=true">
<then>
    <SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/WorkflowGroupDetailsFront" outstring="WorkflowFrontURL">
    <satellite.argument name="cs_environment" value="Variables.cs_environment"/>
      <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
      <satellite.argument name="id" value="Variables.id"/>
    </SATELLITE.LINK>
</then>
<else>
    <SATELLITE.LINK ASSEMBLER="query" pagename="OpenMarket/Xcelerate/Actions/ShowWorkflowFront" outstring="WorkflowFrontURL">
        <satellite.argument name="cs_environment" value="Variables.cs_environment"/>
      <satellite.argument name="cs_formmode" value="Variables.cs_formmode"/>
    </SATELLITE.LINK>
</else>
</if>

<if COND="Variables.new=true">
<then>
    <WORKFLOWENGINE.CREATENEWGROUP OBJVARNAME="newgroup"/>

    <WORKFLOWGROUP.SETNAME NAME="newgroup" VALUE="Variables.name"/>
    <WORKFLOWGROUP.SETDESCRIPTION NAME="newgroup" VALUE="Variables.description"/>
    <WORKFLOWGROUP.SETWORKFLOWPROCESSID NAME="newgroup" VALUE="Variables.process"/>
    <WORKFLOWGROUP.SCATTER PREFIX="wfg:" NAME="newgroup"/>
    <SETVAR NAME="action" VALUE="create"/> 
</then>
<else>
    <SETVAR NAME="errno" VALUE="0"/>
    <WORKFLOWENGINE.GETGROUPID OBJVARNAME="newgroup" ID="Variables.id"/>
    <SETVAR NAME="errno" VALUE="0"/>

    <WORKFLOWGROUP.SCATTER PREFIX="wfg:" NAME="newgroup"/>
    <substitute STR="Variables.wfg:editrolesroles" WHAT="," WITH=";" OUTSTR="editroles"/>
    <substitute STR="Variables.wfg:deleterolesroles" WHAT="," WITH=";" OUTSTR="removeroles"/>
    <substring STR="Variables.grpactions" OUTSTR="grpactions" INDEX="1"/>

    <if COND="Variables.wfg:groupactionsactionTotal!=0">
    <then>
        <setvar NAME="grpactions" VALUE="Variables.empty"/>
        <setcounter NAME="DLGACTIONS" VALUE="0"/>
        <loop FROM="0" COUNT="Variables.wfg:groupactionsactionTotal">
            <setvar NAME="tmp" VALUE="Variables.wfg:groupactionsactionCounters.DLGACTIONS"/>
            <setvar NAME="grpactions" VALUE="Variables.grpactions;Variables.tmp"/>
            <inccounter NAME="DLGACTIONS" VALUE="1"/>
        </loop>
    </then>
    </if>
</else>
</if> 

<if COND="Variables.subaction=setparticipants">
<then>
    <WORKFLOWGROUP.SETWORKFLOWPROCESSID NAME="newgroup" VALUE="Variables.process"/>
    <WORKFLOWGROUP.GETPARTICIPANTS NAME="newgroup" OBJVARNAME="pparticipants"/>
    <PARTICIPANTS.CLEAR NAME="pparticipants"/>
    
     <STRINGLIST NAME="rlist" STR="Variables.allRoles" DELIM=","/>
     <LOOP LIST="rlist">
        <SETVAR NAME="testvar" VALUE="Variables.rlist.ITEM"/>
        <STRINGLIST NAME="participants" STR="Variables.testvar" DELIM=";"/>
        <SETVAR NAME="postParts" VALUE="Variables.empty"/>
        <LOOP LIST="participants">
            <PARTICIPANTS.ADDPARTICIPANT NAME="pparticipants" ROLE="rlist.ITEM" USER="participants.ITEM"/>
            <IF COND="Variables.postParts=Variables.empty">
            <THEN>
                <SETVAR NAME="postParts" VALUE="participants.ITEM"/>
            </THEN>
            <ELSE>
                <SETVAR NAME="postParts" VALUE="Variables.postParts;participants.ITEM"/>
            </ELSE>
            </IF>
        </LOOP>
        <SETVAR NAME="rlist.ITEM" VALUE="Variables.postParts"/>
    </LOOP>
    <WORKFLOWGROUP.SETPARTICIPANTS NAME="newgroup" OBJECT="pparticipants"/>
    <WORKFLOWGROUP.SCATTER PREFIX="wfg:" NAME="newgroup"/>
</then>
</if>

<if COND="Variables.subaction=cancel">
<then>
    <if COND="IsVariable.cancel_process=true">
    <then>
        <WORKFLOWGROUP.SETWORKFLOWPROCESSID NAME="newgroup" VALUE="Variables.cancel_process"/>
    </then>
    </if>
    
    <if COND="IsVariable.cancel_allRoles=true">
    <then>    
        <WORKFLOWGROUP.GETPARTICIPANTS NAME="newgroup" OBJVARNAME="pparticipants"/>
        <PARTICIPANTS.CLEAR NAME="pparticipants"/>
        
         <STRINGLIST NAME="rlist" STR="Variables.cancel_allRoles" DELIM=","/>
         <LOOP LIST="rlist">
            <SETVAR NAME="testvar" VALUE="Variables.cancel_rlist.ITEM"/>
            <STRINGLIST NAME="participants" STR="Variables.testvar" DELIM=";"/>
            <SETVAR NAME="postParts" VALUE="Variables.empty"/>
            <LOOP LIST="participants">
                <PARTICIPANTS.ADDPARTICIPANT NAME="pparticipants" ROLE="rlist.ITEM" USER="participants.ITEM"/>
                <IF COND="Variables.postParts=Variables.empty">
                <THEN>
                    <SETVAR NAME="postParts" VALUE="participants.ITEM"/>
                </THEN>
                <ELSE>
                    <SETVAR NAME="postParts" VALUE="Variables.postParts;participants.ITEM"/>
                </ELSE>
                </IF>
            </LOOP>
            <SETVAR NAME="rlist.ITEM" VALUE="Variables.postParts"/>
        </LOOP>
        <WORKFLOWGROUP.SETPARTICIPANTS NAME="newgroup" OBJECT="pparticipants"/>
    </then>
    </if>

    <WORKFLOWGROUP.SCATTER PREFIX="wfg:" NAME="newgroup"/>
</then>
</if>

<STRINGLIST NAME="editroles" STR="Variables.editroles" DELIM=";"/>
<STRINGLIST NAME="removeroles" STR="Variables.removeroles" DELIM=";"/>
<STRINGLIST NAME="grpactions" STR="Variables.grpactions" DELIM=";"/>

<IF COND="Variables.action=update">
<THEN>
    <SETVAR NAME="actionTitle" VALUE="Edit"/>
</THEN>
</IF>

<IF COND="Variables.action=create">
<THEN>
    <SETVAR NAME="actionTitle" VALUE="Create"/>
</THEN>
</IF>
		
<!--
	If the roles for this group are the same as every available role, then we'll
	force the 'any' radio button to be selected on the form.
-->
<IF COND="IsVariable.addremove=false">
<THEN>
    <ROLEMANAGER.GETROLENAMES LISTVARNAME="ACLList"/>
    <SETVAR NAME="addremove" VALUE="any"/>
    <STRINGLIST NAME="roles" STR="Variables.editroles" DELIM=";"/>

    <IF COND="Variables.editroles=_ALL_">
    <THEN>
    </THEN>
    <ELSE>
        <LOOP LIST="ACLList">
            <SETVAR NAME="errno" VALUE="0"/>
            <ISINLIST LIST="roles" ITEM="ACLList.aclname"/>
            <IF COND="Variables.errno=1">
            <THEN>
            </THEN>
            <ELSE>
                <SETVAR NAME="addremove" VALUE="role"/>
            </ELSE>
            </IF>
       </LOOP>
   </ELSE>
   </IF>
</THEN>
</IF>

<IF COND="IsVariable.editdelete=false">
<THEN>
    <ROLEMANAGER.GETROLENAMES LISTVARNAME="ACLList"/>
    <SETVAR NAME="editdelete" VALUE="any"/>
    <STRINGLIST NAME="roles" STR="Variables.removeroles" DELIM=";"/>
    <IF COND="Variables.removeroles=_ALL_">
    <THEN>
    </THEN>
    <ELSE>
        <LOOP LIST="ACLList">
            <SETVAR NAME="errno" VALUE="0"/>
            <ISINLIST LIST="roles" ITEM="ACLList.aclname"/>
            <IF COND="Variables.errno=1">
            <THEN>
            </THEN>
            <ELSE>
                <SETVAR NAME="editdelete" VALUE="role"/>
            </ELSE>
            </IF>
        </LOOP>
    </ELSE>
    </IF>
</THEN>
</IF>

</FTCS> 
