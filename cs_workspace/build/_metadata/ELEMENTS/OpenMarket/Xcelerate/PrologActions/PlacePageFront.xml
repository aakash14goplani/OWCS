<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/PrologActions/PlacePageFront.xml $
$Revision: 24 $ 
$Modtime: 6/28/04 1:10p $ 
-->
<!-- OpenMarket/Xcelerate/PrologActions/PlacePageFront
--
-- INPUT
--		SessionVariables.pubid 
-- 	Optinally, ParentPage with id of parent page to place page
-- OUTPUT
--		Sets parentname, parentnodeid
--		Makes lists UnplcaedPages and PlacedPages
-->

<setvar NAME="doproceed" VALUE="true"/>
<setvar NAME="AssetType" VALUE="Page"/>
<SITEPLAN.ROOT LIST="PubRoot" OBJECTID="SessionVariables.pubid"/>
<CALLSQL LIST="UnplacedPages" QRYNAME="OpenMarket/Xcelerate/AssetType/Variables.AssetType/UnplacedPages"/>

<IF COND="IsVariable.ParentPage=true">
<THEN>

   <setvar NAME="id" VALUE="Variables.ParentPage"/>        
	<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.ParentPage" NAME="thePage"/>
	<if COND="IsError.Variables.errno=true">
	    <then>
	        <setvar NAME="doproceed" VALUE="InvalidContentId"/>
	    </then>
	</if>
	<ASSET.GET NAME="thePage" FIELD="name" OUTPUT="parentname"/> 

	<if COND="Variables.doproceed=true">
	<then>
		<!-- check whether we can perform this function on this asset -->
		<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/AccessCheck">
			<ARGUMENT NAME="assetObjectName" VALUE="thePage"/>
			<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
			<ARGUMENT NAME="pubid" VALUE="SessionVariables.pubid"/>
			<ARGUMENT NAME="id" VALUE="Variables.id"/>
			<ARGUMENT NAME="Function" VALUE="placepage"/>
		</CALLELEMENT>
		<IF COND="Variables.error!=Variables.empty">
		<THEN>
		 	<!-- -12069 means allow edit but display warning, any other error means prohibit edit -->
		 	<if COND="Variables.errno=-12069">
		 	<then>
				<callelement NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
					<argument NAME="elem" VALUE="EditNotAllowed"/>
					<argument NAME="severity" VALUE="info"/>
					<argument NAME="assettype" VALUE="Variables.AssetType"/>
					<argument NAME="id" VALUE="Variables.id"/>
				</callelement>
			</then>
			<else>
		     <setvar NAME="doproceed" VALUE="Variables.error"/>
		   </else>
		   </if>
		</THEN>
		</IF>
	</then>
	</if>
	
	<if COND="Variables.doproceed=true">
	<then>
		<!-- check to see if the table is tracked
	     if so, then the current record must
	     be locked by the current user -->
		<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/CheckTrackingEnabled">
		    <argument NAME="AssetType" VALUE="Variables.AssetType"/>
		</callelement>
		<if COND="Variables.trackingenabled=true">
		<then>
        	<history TABLE="Variables.AssetType" ASSET="Variables.id" LIST="ItsHistory"/>
     		<callelement NAME="OpenMarket/Xcelerate/Actions/RevisionTracking/LockIfNeeded">
	            <argument NAME="AssetType" VALUE="Variables.AssetType"/>
	            <argument NAME="id" VALUE="Variables.id"/>
	        </callelement>
	        <INPUT TYPE="HIDDEN" NAME="alreadylocked" VALUE="Variables.alreadylocked" REPLACEALL="Variables.alreadylocked"/>
			
			<!-- Add entry in CheckOutInfo for an implicit check out -->
			<if COND="Variables.checkoutmethod=implicit">
			<then>
				<usermanager.getloginuser VARNAME="userID"/>
				<implicitcheckout.logimplicitcheckout ASSETTYPE="Variables.AssetType"
					ASSETID="Variables.id" USER="Variables.userID"
					FUNCTION="placepage"/>

				<if COND="IsError.Variables.errno=false">
				<then>
					<!-- put out informational message: -->
					<!-- Variables.atdescription has been checked out for Variables.function. -->
					<ASSETTYPE.LOAD NAME="at" TYPE="Variables.AssetType"/>
					<ASSETTYPE.GET NAME="at" FIELD="description" OUTPUT="atdescription"/>
					<XLAT.LOOKUP KEY="dvin/UI/PlacePage" VARNAME="function"/>
					<XLAT.LOOKUP KEY="dvin/UI/AssetImplicitlyCheckout" VARNAME="msgtext"/>
					<CALLELEMENT NAME="OpenMarket/Xcelerate/UIFramework/Util/ShowMessage">
						<ARGUMENT NAME="severity" VALUE="info"/>
					</CALLELEMENT>
				</then>
				</if>	
			</then>
			</if>
	    </then>
		</if>

		<if COND="Variables.doproceed=true">
			<then>
				<!-- load node under which we will place pages -->
				<ASSET.GETSITENODE NAME="thePage" OUTPUT="parentnodeid"/> 
				
				<SITEPLAN.LOAD NAME="thePageNode" NODEID="Variables.parentnodeid"/>
				<SITEPLAN.CHILDREN NAME="thePageNode" OBJECTTYPE="Variables.AssetType" LIST="PlacedPages" ORDER="nrank" CODE="Placed"/>
				<SITEPLAN.UNPLACEDANCESTOR NAME="thePageNode" OUTPUT="pagenodeunplaced"/>
				<if COND="Variables.pagenodeunplaced=true">
				<then>
			    	<setvar NAME="doproceed" VALUE="PlacingUnplaced"/>
			   </then>
			   </if>
			</then>
			</if>
	</then>
	</if>
</THEN>
<ELSE>
	<ASSET.LOAD NAME="sitePlanAsset" TYPE="SitePlan" OBJECTID="Variables.ID"/>
	<ASSET.GET NAME="sitePlanAsset" FIELD="name" OUTPUT="parentname" />
	<ASSET.GETSITENODE NAME="sitePlanAsset" OUTPUT="parentnodeid"/>
	<EXECSQL LIST="PlacedPages" TABLE="SitePlanTree,Page" SQL="SELECT * FROM Page,SitePlanTree WHERE SitePlanTree.otype='Page' AND nparentid=Variables.parentnodeid AND Page.id=SitePlanTree.oid AND SitePlanTree.ncode='Placed' order by nrank" />
	
	<!-- <PUBLICATION.LOAD NAME="parent" OBJECTID="SessionVariables.pubid"/>
	<PUBLICATION.GET NAME="parent" FIELD="name" OUTPUT="parentname"/>
	<SITEPLAN.LOAD NAME="thePubNode" NODEID="PubRoot.nid"/>
	<SITEPLAN.CHILDREN NAME="thePubNode" OBJECTTYPE="Variables.AssetType" LIST="PlacedPages" CODE="Placed" ORDER="nrank"/>
	<SETVAR NAME="parentnodeid" VALUE="PubRoot.nid"/> -->
</ELSE>
</IF>
</FTCS> 
