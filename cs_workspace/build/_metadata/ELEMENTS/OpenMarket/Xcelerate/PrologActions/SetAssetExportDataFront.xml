<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/PrologActions/SetAssetExportDataFront
-
- INPUT
-
- OUTPUT
-
-->
<setvar NAME="doproceed" VALUE="true"/>

<SETVAR NAME="assetname" VALUE="theCurrentAsset"/>
<SETVAR NAME="assetObjectName" VALUE="theCurrentAsset"/>
<ASSET.LOAD TYPE="Variables.AssetType" OBJECTID="Variables.id" NAME="Variables.assetObjectName"/>
<if COND="IsError.Variables.errno=true">
    <then>        
        <setvar NAME="doproceed" VALUE="InvalidContentId"/>
    </then>
</if>


<if COND="Variables.doproceed=true">
<then>
		
	<callelement NAME="OpenMarket/Xcelerate/Scripts/ValidateInput"></callelement>
		
    <callelement NAME="OpenMarket/Xcelerate/Actions/Workflow/CheckPrivs">
        <argument NAME="AssetType" VALUE="Variables.AssetType"/>
        <argument NAME="assetObjectName" VALUE="Variables.assetObjectName"/>
        <argument NAME="Function" VALUE="setExportData"/>
    </callelement>
    
    <if COND="Variables.PrivsFailed=true">
        <then>
            <setvar NAME="doproceed" VALUE="Variables.PrivsFailedReason"/>
        </then>
	</if>
</then>
</if>

<if COND="Variables.doproceed=true">
<then>
	<ASSET.GETASSETTYPE NAME="Variables.assetObjectName" OUTNAME="type"/>
	<ASSETTYPE.GET NAME="type" FIELD="description" OUTPUT="atDescription"/>
	
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="id" OUTPUT="id"/>
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="name" />
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="createdby" OUTPUT="createdby"/>
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="createddate" OUTPUT="createddate"/>
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="updatedby" OUTPUT="updatedby"/>
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="updateddate" OUTPUT="updateddate"/>
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="description" OUTPUT="description"/>
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="status" OUTPUT="statuscode"/>
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="path" OUTPUT="path"/>
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="filename" OUTPUT="filename"/>
	<ASSET.GET NAME="Variables.assetObjectName" FIELD="template" OUTPUT="template"/>
	<ASSET.GETSUBTYPE NAME="Variables.assetObjectName" OUTPUT="subtype"/>

	<PUBTARGETMANAGER.LOAD ID="Variables.target" OBJVARNAME="pubtgt"/>
	<PUBTARGET.SCATTER NAME="pubtgt" PREFIX="pt:"/>
	<PUBTARGET.UNPACK NAME="pubtgt" PREFIX="pubfact:" FIELD="factors"/>
	
	<ApprovedAssets.GetPerm TARGET="Variables.target" ASSETID="Variables.id" OBJVARNAME="publishpoints" />
	<PublishPoints.GetAll NAME="publishpoints" PREFIX="refs" />
		
	<SETVAR NAME="numTemplates" VALUE="0"/>
	
	<if COND="Variables.pubfact:OLDTEMPLATE!=true">
	<then>				
		<TEMPLATEMANAGER.GetTemplateIds LISTVARNAME="Templates" PUBID="SessionVariables.pubid" ASSETTYPE="Variables.AssetType" SUBTYPE="Variables.subtype" TTYPE="x"/>				
		<if COND="IsError.Variables.errno=false">
		<then>
			<LOOP LIST="Templates">
				<if COND="IsVariable.templateids=true">
				<then>
					<SETVAR NAME="templateids" VALUE="Variables.templateids;Templates.id"/>
				</then>
				<else>
					<SETVAR NAME="templateids" VALUE="Templates.id"/>
				</else>
				</if>
			</LOOP>
			<ASSET.LOADALL TYPE="Template" IDS="Variables.templateids" PREFIX="template"/>
		</then>
		</if>
	</then>
	</if>

	<AssetTargetManager.Load OBJVARNAME="targetdata" TARGET="Variables.target" TYPE="Variables.AssetType" ID="Variables.id"/>
	<AssetTarget.GetFilename NAME="targetdata" VARNAME="ex:filename"/>
	<AssetTarget.GetPath NAME="targetdata" VARNAME="ex:path"/>
	<if COND="IsVariable.ex:filename=false">
	<then>
		<SETVAR NAME="ex:filename" VALUE="Variables.empty"/>
	</then>
	</if>
	<if COND="IsVariable.ex:path=false">
	<then>
		<SETVAR NAME="ex:path" VALUE="Variables.empty"/>
	</then>
	</if>
	
	
</then>
</if>


</FTCS> 
