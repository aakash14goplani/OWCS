<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- 
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/PrologActions/WorkflowReportPost.xml $ 
$Revision: 16 $ 
$Modtime: 7/31/04 5:50p $ 
-->
<!-- OpenMarket/Xcelerate/PrologActions/WorkflowReportPost
-
- INPUT
-
- OUTPUT
-
-->

<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Search/ManagewfReport"/>
<XLAT.LOOKUP KEY="UI/Forms/Report" VARNAME="filterstring"/>
<XLAT.LOOKUP KEY="UI/Forms/Report" VARNAME="Wf_Report"/>

<PROPERTY.GET PARAM="xcelelem.manageuserpub" INIFILE="futuretense_xcel.ini" VARNAME="propmanageuserpub"/>

<IF COND="Variables.report_assets=some">
<THEN>
	<XLAT.LOOKUP KEY="dvin/UI/Wf/OnlyAssetsOfType" VARNAME="filterstring" ENCODE="false"/>
</THEN>
</IF>

<IF COND="Variables.report_state=some">
<THEN>
<SETVAR NAME="showReportState" VALUE="true"/>
	<!-- wfstateList is used later on -->
	<SUBSTITUTE STR="Variables.wfstates" OUTSTR="wfstateList" WHAT=";" WITH=","/>
	<SETVAR NAME="tablename" VALUE="WorkflowStatusCode" />
	<SETVAR NAME="statedescription" VALUE="Variables.empty"/>
	<STRINGLIST NAME="statelist" STR="Variables.wfstates" DELIM=";"/>
	<LOOP LIST="statelist">
		<CALLELEMENT NAME="OpenMarket/Xcelerate/Util/validateFields">
			<ARGUMENT NAME="columnvalue" VALUE="statelist.ITEM"/>
			<ARGUMENT NAME="type" VALUE="Long"/>
		</CALLELEMENT>
		<IF COND="Variables.validatedstatus=true">
		<THEN>
			<EXECSQL LIST="MyStatusCode" SQL="select description from WorkflowStatusCode where id=statelist.ITEM"/>
		</THEN>
		</IF>
		<IF COND="Variables.statedescription=Variables.empty">
		<THEN>
			<SETVAR NAME="statedescription" VALUE="'MyStatusCode.description'"/>
		</THEN>
		<ELSE>
			<SETVAR NAME="statedescription" VALUE="Variables.statedescription, 'MyStatusCode.description'"/>
		</ELSE>
		</IF>
	</LOOP>
	<INDEXOF STR="Variables.statedescription" WHAT="," OUTSTR="dummy" />
    <IF COND="Variables.errno=1">
	<THEN>
		<XLAT.LOOKUP KEY="dvin/UI/Wf/OnlyAssetsInStates" VARNAME="filterstring" ENCODE="false"/>
	</THEN>
	<ELSE>	
			<XLAT.LOOKUP KEY="dvin/UI/Wf/OnlyAssetsInState" VARNAME="filterstring" ENCODE="false"/>
	</ELSE>
	</IF>
</THEN>
<ELSE>
	<SETVAR NAME="showReportState" VALUE="false"/>
</ELSE>
</IF>

<IF COND="Variables.report_assignto=user">
<THEN>
    <!-- Variables.users list is actually a userid list, so need to convert it to a list of user names -->
   	<STRINGLIST NAME="uidList" STR="Variables.users" DELIM=";"/>
    <SETVAR NAME="userNameList" VALUE="Variables.empty"/>
	<LOOP LIST="uidList">	
      <UserManager.GetDisplayableUserName USER="uidList.ITEM" VARNAME="temp"/>
	  <SETVAR NAME="userNameList" VALUE="Variables.userNameList;Variables.temp" />
	</LOOP>
    <XLAT.LOOKUP KEY="dvin/UI/Wf/AssignedToUsers" VARNAME="filterstring" ENCODE="false"/>
	            <REMOVEVAR NAME="roles"/>
</THEN>
</IF>

<IF COND="Variables.report_assignto=role">
<THEN>
	<!-- here we will restrict by role by converting the list of roles to a list of all users in those roles -->
	<SETVAR NAME="users" VALUE="Variables.empty"/>
	<STRINGLIST NAME="roleList" STR="Variables.roles" DELIM=";"/>
    
	<XLAT.LOOKUP KEY="dvin/UI/Wf/AssignedToRoles" VARNAME="filterstring" ENCODE="false"/>
	<LOOP LIST="roleList">
		<CALLELEMENT NAME="Variables.propmanageuserpub">
			<ARGUMENT NAME="upcommand"      VALUE="AclUserIDs"/>
			<ARGUMENT NAME="acl"            VALUE="roleList.ITEM"/>
			<ARGUMENT NAME="publication"    VALUE="SessionVariables.PublicationName"/>
			<ARGUMENT NAME="outname"        VALUE="roleUserList"/>
		</CALLELEMENT>
        
         <LOOP  LIST="roleUserList">
            <IF COND="Variables.users=Variables.empty">
    		<THEN>
    			<SETVAR NAME="users" VALUE="roleUserList.ITEM"/>
    		</THEN>
    		<ELSE>
    			<SETVAR NAME="users" VALUE="Variables.users;roleUserList.ITEM"/>
    		</ELSE>
		</IF>
        </LOOP>
         
	</LOOP>
	<SETVAR NAME="report_assignto" VALUE="user"/>
</THEN>
</IF>

<SETVAR NAME="DueMinutes" VALUE="Variables.empty"/>
<SETVAR NAME="doOverdue" VALUE="Variables.empty"/>
<IF COND="Variables.report_due=due">
<THEN>
    <SETVAR NAME="DueMinutes" VALUE="Variables.duetime"/>
	<XLAT.LOOKUP KEY="dvin/UI/Wf/DueWithin" VARNAME="filterstring" ENCODE="false"/>
	<SETVAR NAME="doOverdue" VALUE="false"/>
</THEN>
</IF>
<IF COND="Variables.report_due=past">
<THEN>
    <if COND="Variables.pastduetime!=0">
    <then>
         <SETVAR NAME="DueMinutes" VALUE="-Variables.pastduetime"/>
    </then>
    </if>
	<XLAT.LOOKUP KEY="dvin/UI/Wf/PastDueMoreThan" VARNAME="filterstring" ENCODE="false"/> 
	<SETVAR NAME="doOverdue" VALUE="true"/>
</THEN>
</IF>
    
<SETVAR NAME="processDueMinutes" VALUE="Variables.empty"/>
<SETVAR NAME="doProcessOverdue" VALUE="Variables.empty"/>
<IF COND="Variables.report_processdue=due">
<THEN>
    <SETVAR NAME="processDueMinutes" VALUE="Variables.processduetime"/>
	<XLAT.LOOKUP KEY="dvin/UI/Wf/ProcessDueWithin" VARNAME="filterstring" ENCODE="false"/>
	<SETVAR NAME="doProcessOverdue" VALUE="false"/>
</THEN>
</IF>
<IF COND="Variables.report_processdue=past">
<THEN>
    <if COND="Variables.pastprocessduetime!=0">
    <then>
         <SETVAR NAME="processDueMinutes" VALUE="-Variables.pastprocessduetime"/>
    </then>
    </if>
	<XLAT.LOOKUP KEY="dvin/UI/Wf/PastProcessDueByMoreThan" VARNAME="filterstring" ENCODE="false"/> 
    <SETVAR NAME="doProcessOverdue" VALUE="true"/>
</THEN>
</IF>
<IF COND="IsVariable.ResultLimit=false">
<THEN>
<SETVAR NAME="ResultLimit" VALUE="50"/>
</THEN>
</IF>

<IF COND="IsVariable.OrderBy=false">
<THEN>
<SETVAR NAME="OrderBy" VALUE="assigneddate"/>
</THEN>
</IF>

<IF COND="IsVariable.status=false">
<THEN>
<SETVAR NAME="status" VALUE="active"/>
</THEN>
</IF>
<IF COND="Variables.filterstring=Variables.Wf_Report">
<THEN>
    <XLAT.LOOKUP KEY="dvin/UI/Wf/AllAssignments" VARNAME="filterstring" ENCODE="false"/>
</THEN>
</IF>



	
</FTCS> 
