<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!-- OpenMarket/Xcelerate/PrologActions/Publish/Mirror1/PubSetupElement
-
- INPUT
-
- OUTPUT
-
-->

<!-- Before we do ANYTHING, check out those assets we are going to be changing -->
<ASSETPUBLISHLIST.CHECKOUTASSETS PUBSESSION="Variables.session"/>
<if COND="IsError.Variables.errno=false">
<then>
	<!-- load the cache with current versions of the asset we'll be publishing -->
	<ASSETPUBLISHLIST.PREPUBLISH PUBSESSION="Variables.session"/>

	<!-- Delete the AssetPublication entries for assets about to be published so changes in sharing are recorded accurately-->
	<setvar NAME="errno" VALUE="0"/>
	<setvar NAME="tablename" VALUE="AssetPublication"/>
	<EXECSQL SQL="DELETE FROM AssetPublication WHERE AssetPublication.assetid IN (SELECT AssetPublishList.assetid FROM AssetPublishList WHERE AssetPublishList.pubsession=Variables.session)" LIST="none"/>
	<!-- this gives a -502 error that can be ignored-->
	<if COND="Variables.errno=-502">
	<then>
		<setvar NAME="errno" VALUE="0"/>
	</then>
	</if>
	<if COND="IsError.Variables.errno=true">
	<then>
		<SETVAR NAME="result" VALUE="An error occurred trying to clear the AssetPublication table: Variables.errno (Variables.errdetail1)"/>
	</then>
	</if>

	<!-- Delete any Embedded Reference entries for assets about to be published -->
	<setvar NAME="errno" VALUE="0"/>
	<setvar NAME="tablename" VALUE="AssetPublication"/>
	<EXECSQL SQL="DELETE FROM EmbeddedReference WHERE cs_assetid IN (SELECT AssetPublishList.assetid as cs_assetid FROM AssetPublishList WHERE AssetPublishList.pubsession=Variables.session)" LIST="none"/>
	<!-- this gives a -502 error that can be ignored-->
	<if COND="Variables.errno=-502">
	<then>
		<setvar NAME="errno" VALUE="0"/>
	</then>
	</if>
	<if COND="IsError.Variables.errno=true">
	<then>
		<SETVAR NAME="result" VALUE="An error occurred trying to clear the EmbeddedReference table: Variables.errno (Variables.errdetail1)"/>
	</then>
	</if>
	<!-- Delete any LocaleTree entries -->
	<setvar NAME="errno" VALUE="0"/>
	<setvar NAME="tablename" VALUE="LocaleTree"/>
	<EXECSQL SQL="DELETE FROM LocaleTree" LIST="none"/>
	<!-- this gives a -502 error that can be ignored-->
	<if COND="Variables.errno=-502">
		<then>
			<setvar NAME="errno" VALUE="0"/>
		</then>
	</if>
	<if COND="IsError.Variables.errno=true">
		<then>
			<SETVAR NAME="result" VALUE="An error occurred trying to clear the LocaleTree table: Variables.errno (Variables.errdetail1)"/>
		</then>
	</if>
</then>
<else>
	<SETVAR NAME="result" VALUE="An error occurred trying to check out assets on the target.  The assets were:&#60;br/&#62;Variables.errdetail1&#60;br/&#62;"/>
</else>
</if>
<!-- if there is an error, clean-up -->
<if COND="Variables.result!=Variables.empty">
<then>
	<!-- delete the AssetPublishList entries -->
	<ASSETPUBLISHLIST.DeleteSessionAssets PUBSESSION="Variables.session"/>
</then>
</if>

</FTCS> 
