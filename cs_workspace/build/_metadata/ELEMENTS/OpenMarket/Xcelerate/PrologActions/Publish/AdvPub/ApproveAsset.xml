<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
    <!-- OpenMarket/Xcelerate/PrologActions/Publish/AdvPub/ApproveAsset
    -
    - INPUT
    - Variables.assetname - loadedasset
    - Variables.target - pubtarget
    - object AssetDT containing a hash of the asset id and updateddate

    - OUTPUT
    -
    -->
    <!-- call the delivery type specific pre-approve element -->
    <setvar NAME="errno" VALUE="0" />
    <if COND="IsElement.OpenMarket/Xcelerate/PrologActions/Publish/AdvPub/PreApprove=true">
        <then>
            <callelement NAME="OpenMarket/Xcelerate/PrologActions/Publish/AdvPub/PreApprove">
                <argument NAME="assetname" VALUE="Variables.assetname" />
                <argument NAME="target" VALUE="Variables.target" />
            </callelement>
        </then>
    </if>

    <!-- approve the asset -->
    <if COND="IsError.Variables.errno=false">
        <then>
            <SETVAR NAME="errno" VALUE="0" />
            <ASSET.GETPUBDEPS NAME="Variables.assetname" DEPTH="1" LIST="myDeps" />
            <ASSET.GET NAME="Variables.assetname" FIELD="name" />
            <ASSET.GET NAME="Variables.assetname" FIELD="id" />
            <if COND="IsList.myDeps=true">
                <then>
                    <if COND="myDeps.#numRows!=0">
                        <then>
                            <!-- debug--
                   <XLAT.STREAM KEY="dvin/UI/nameidhasnumRowsdependents"/> <br/>
                   <!-- debug -->
                            <LOOP LIST="myDeps">
                                <!-- debug--
                        <CSVAR NAME="myDeps.otype,myDeps.oid"/><br/>
                        <!-- debug-->
                                <!-- exact dependency -->
                                <if COND="myDeps.deptype=V">
                                    <then>
                                        <REMOVEVAR NAME="updateddate" />
                                        <HASH.GET NAME="AssetDT" VALUE="myDeps.oid" VARNAME="updateddate" />
                                        <IF COND="IsVariable.updateddate=false">
                                            <THEN>
                                                <ASSET.LIST LIST="deplist" TYPE="myDeps.otype" FIELD1="id"
                                                            VALUE1="myDeps.oid" EXCLUDEVOIDED="false" />
                                                <if COND="IsError.Variables.errno=false">
                                                    <then>
                                                        <SETVAR NAME="updateddate" VALUE="deplist.updateddate" />
                                                        <HASH.ADD NAME="AssetDT" KEY="myDeps.oid"
                                                                  VALUE="Variables.updateddate" />
                                                    </then>
                                                </if>
                                            </THEN>
                                        </IF>
                                        <IF COND="IsVariable.updateddate=true">
                                            <THEN>
                                                <APPROVALDEPENDENCIES.ADDEXACT TYPE="myDeps.otype" ID="myDeps.oid"
                                                                               DATE="Variables.updateddate"
                                                                               MODE="reference" />
                                            </THEN>
                                        </IF>
                                    </then>
                                    <else>
                                        <if COND="myDeps.deptype=G">
                                            <then>
                                                <HASH.GET NAME="AssetDT" VALUE="myDeps.oid" VARNAME="updateddate" />
                                                <IF COND="IsVariable.updateddate=false">
                                                    <THEN>
                                                        <ASSET.LIST LIST="deplist" TYPE="myDeps.otype" FIELD1="id"
                                                                    VALUE="myDeps.oid" EXCLUDEVOIDED="false" />
                                                        <if COND="IsError.Variables.errno=false">
                                                            <then>
                                                                <SETVAR NAME="updateddate"
                                                                        VALUE="deplist.updateddate" />
                                                                <HASH.ADD NAME="AssetDT" KEY="myDeps.oid"
                                                                          VALUE="Variables.updateddate" />
                                                            </then>
                                                        </if>
                                                    </THEN>
                                                </IF>
                                                <IF COND="IsVariable.updateddate=true">
                                                    <THEN>
                                                        <APPROVALDEPENDENCIES.ADDGREATER TYPE="myDeps.otype"
                                                                                         ID="myDeps.oid"
                                                                                         DATE="Variables.updateddate"
                                                                                         MODE="reference" />
                                                    </THEN>
                                                </IF>
                                            </then>
                                            <else>
                                                <APPROVALDEPENDENCIES.ADDEXISTS TYPE="myDeps.otype" ID="myDeps.oid"
                                                                                MODE="reference" />
                                            </else>
                                        </if>
                                    </else>
                                </if>
                            </LOOP>
                        </then>
                    </if>
                    <!-- note it in the in-memory approvals object -->
                    <Approvals.add NAME="approvals" ASSET="Variables.assetname" />

                    <!-- debug some feedback on what is being approved --
             <ASSET.GETASSETTYPE NAME="Variables.assetname" OUTNAME="assettype"/>
             <ASSETTYPE.GET NAME="assettype" FIELD="assettype"/>
             <CSVAR NAME="Variables.assettype"/>,<CSVAR NAME="Variables.id"/> - <CSVAR NAME="Variables.name"/><br/>
             <!-- end of feedback -->
                </then>
            </if>
        </then>
    </if>


</FTCS> 
