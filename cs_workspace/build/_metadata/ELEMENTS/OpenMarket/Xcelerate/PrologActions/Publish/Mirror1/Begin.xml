<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!--
$Logfile: /VerticalApps/XcelerateD/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/PrologActions/Publish/Mirror1/Begin.xml $
$Revision: 23 $
$Modtime: 6/10/04 3:17p $
-->

<!--
- Confidential and Proprietary Information of FutureTense Inc.
-					All Rights Reserved.
-
- DESCRIPTION
-    Begin mirror publishing.
-
-    This is called one time only, once a session as been established.
-    A corresponding End element will be callled if it exists.
-	  This Begin element does the following:
-			- creates a mirror queue, in which assets and other objects to mirror are collected
-			- for each asset to be published creates an entry in the AssetPublishList table
-			- makes sure that for each asset type to be mirrored the assettype table 
				has been installed on the target, by mirror the asset type
-			- mirrors the AssetPublishTable - cache manager will freeze these assets in cache on the target
-			
-
- INPUT
-    pubsess			Object pool name of the the PubSession.
-    pubdt			Object pool name of the DeliveryType.
-    pubtgt			Object pool name of the PubTarget.
-    Variables.pubtgt:*		Fields of the pubtgt object.
-    Variables.pubfact:*	Publishing factors.
-
- OUTPUT
-    HTML			None
-    Variables.pub:errno	0 if the framework succeeded.  Check the 
-				session object to see if actual publishing
-				worked -100 if the session could not be
-				created.
-    pubMirror*:*		Local lists, objects and variables
-				are created using these prefixes.
-->

<PUBSESSION.GETID NAME="pubsess" VARNAME="pubsess:id"/>
<if COND="Variables.pubfact:VERBOSE=true">
<then>
    <PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="BEGIN (standard mirror code)"/>
</then>
</if>

<PROPERTY.GET PARAM="xcelerate.remotecall" INIFILE="futuretense_xcel.ini" VARNAME="propremotecall"/>
<MIRRORQUEUE.CREATE NAME="pubMirrorQ" SESSION="pubsess" PAGENAME="Variables.propremotecall"/>
<setvar NAME="pub:errno" VALUE="Variables.errno"/>

<if COND="IsError.Variables.pub:errno=false">
<then>
	<if COND="Variables.pubfact:VERBOSE=true">
	<then>
		<XLAT.LOOKUP KEY="dvin/UI/Publish/Mirror1Begin-factor" VARNAME="msg"/>
		<if COND="IsVariable.pubfact:REMOTEUSER=true">
		<then>
			<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Variables.msg REMOTEUSER=Variables.pubfact:REMOTEUSER"/>
		</then>
		</if>
	</then>
	</if>
	
	<!-- Fill in the AssetPublishList table with assets to be published so that cache invalidation can occur properly -->
	<if COND="IsVariable.Variables.PREFIXTotal=true">
	<then>
		
		<if COND="Variables.pubfact:VERBOSE=true">
		<then>
			<TIME.SET NAME="addToAPLTime"/>
			<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Adding Variables.Variables.PREFIXTotal assets to AssetPublishList at CS.Date" />
		</then>
		</if>


		<LISTOBJECT.CREATE NAME="listobject" COLUMNS="assetid,assettype" />
		<SETCOUNTER NAME="count" VALUE="0"/>
		<setvar NAME="numAssets" VALUE="Variables.Variables.PREFIXTotal"/>
		<loop COUNT="Variables.numAssets">
			<MIRRORKEY.GETTYPE NAME="Variables.PREFIXCounters.count" VARNAME="assettype"/>
			<MIRRORKEY.GETID NAME="Variables.PREFIXCounters.count" VARNAME="assetid"/>
			<LISTOBJECT.ADDROW NAME="listobject"
				  assetid="Variables.assetid"
				  assettype="Variables.assettype" />
			<if COND="Variables.pubfact:VERBOSE=true">
			<then>
				<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Adding Variables.assettype with id Variables.assetid to AssetPublishList" />
			</then>
			</if>

			<INCCOUNTER NAME="count" VALUE="1"/>
		</loop>
		<LISTOBJECT.TOLIST NAME="listobject" LISTVARNAME="assetsToBePublished" />

		<ASSETPUBLISHLIST.ADDSESSIONASSETS PUBSESSION="Variables.pubsess:id" LIST="assetsToBePublished"/>
		<if COND="Variables.pubfact:VERBOSE=true">
		<then>
			<TIME.GET NAME="addToAPLTime"  OUTPUT="elapsed"/>
			<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="[TIME]Done adding assets to AssetPublishList in Variables.elapsed ms."/>
		</then>
		</if>

	</then>
	</if>

	<!-- mirror any asset types of the assets -->
	<if COND="IsError.Variables.errno=false">
	<then>
		<if COND="Variables.pubfact:PUBLISHASSETTYPES=false">
		<then>
			<if COND="Variables.pubfact:VERBOSE=true">
			<then>
				<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Mirroring assettypes disabled."/>
			</then>
			</if>
		</then>
		<else>

			<PROPERTY.GET PARAM="xcelerate.publishallassettypes" INIFILE="futuretense_xcel.ini" VARNAME="publishallassettypes"/>
			<IF COND="Variables.publishallassettypes=true">
			<THEN>
				<ASSETTYPE.LIST LIST="pubassettypes"/>
			</THEN>
			<ELSE>
				<SETVAR NAME="tablename" VALUE="AssetPublishList"/>
				<EXECSQL SQL="SELECT DISTINCT assettype FROM AssetPublishList WHERE pubsession=Variables.pubsess:id" LIST="pubassettypes"/>
			</ELSE>
			</IF>
			<IF COND="IsError.Variables.errno=false">
			<THEN>
				<SETVAR NAME="assettypes" VALUE="Variables.empty"/>
				<LOOP LIST="pubassettypes">
					<IF COND="Variables.assettypes=Variables.empty">
					<THEN>
						<SETVAR NAME="assettypes" VALUE="pubassettypes.assettype"/>
					</THEN>
					<ELSE>
						<SETVAR NAME="assettypes" VALUE="Variables.assettypes,pubassettypes.assettype"/>
					</ELSE>
					</IF>
					<ASSET.GETASSETTYPESONWHICHIDEPEND TYPE="pubassettypes.assettype" VARNAME="dependOnAssetTypes"/>
					<IF COND="Variables.dependOnAssetTypes!=Variables.empty">
					<THEN>
						<SETVAR NAME="assettypes" VALUE="Variables.assettypes,Variables.dependOnAssetTypes"/>
					</THEN>
					</IF>
				</LOOP>
				<if COND="Variables.pubfact:VERBOSE=true">
				<then>
					<TIME.SET NAME="pubAssetTypesTime"/>
					<XLAT.LOOKUP KEY="dvin/UI/Publish/Mirror1Begin-mirroringAssetTypes" VARNAME="msg"/>
					<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Variables.msg at CS.Date"/>
				</then>
				</if>
				<ASSETTYPE.PublishAssetTypes ASSETTYPES="Variables.assettypes" MIRRORQUEUE="pubMirrorQ"/>
				<if COND="Variables.pubfact:VERBOSE=true">
				<then>
					<TIME.GET NAME="pubAssetTypesTime"  OUTPUT="elapsed"/>
					<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="[TIME]Done mirroring assettypes in Variables.elapsed ms."/>
				</then>
				</if>

			</THEN>
			</IF>
		</else>
		</if>

	</then>
	</if>

	<if COND="IsError.Variables.errno=false">
	<then>
		<if COND="Variables.pubfact:VERBOSE=true">
		<then>
			<XLAT.LOOKUP KEY="dvin/UI/Publish/Mirror1End-mirroringAssetPublishList" VARNAME="msg"/>
			<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Variables.msg"/>
			<TIME.SET NAME="aplmirror"/>
		</then>
		</if>
		<!-- mirror over table with changed assets - for the cache manager to use to flush cache -->
		<ASSETPUBLISHLIST.AddMirrorQueue PUBSESSION="Variables.pubsess:id" MIRRORQUEUE="pubMirrorQ"/>
		<if COND="Variables.pubfact:VERBOSE=true">
		<then>
			<TIME.GET NAME="aplmirror"  OUTPUT="elapsed"/>
			<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="[TIME]Done mirroring AssetPublishList in Variables.elapsed ms."/>
		</then>
		</if>

	</then>
	</if>
	
	<if COND="IsError.Variables.errno=true">
	<then>
	 	<setvar NAME="pub:errno" VALUE="Variables.errno"/>
	   <MIRRORQUEUE.CANCEL NAME="pubMirrorQ"/>
		<!-- note: if the PubSetupElement fails, then the clean-up of the target is performed within
		that element. There is no need (and can be harmful) to call AssetPublishList.NotifyOfAbort here -->
		<!-- delete entries in AssetPublishList for this session -->
		<ASSETPUBLISHLIST.DeleteSessionAssets PUBSESSION="Variables.pubsess:id"/>
	</then>
	</if>
</then>
<else>
	<XLAT.LOOKUP KEY="dvin/UI/Publish/Mirror1Begin-errorCreatingMirrorQueue" VARNAME="msg"/>
	<PUBSESSIONMANAGER.LOGMESSAGE ID="Variables.pubsess:id" VALUE="Variables.msg"/>
</else>
</if>
</FTCS>
