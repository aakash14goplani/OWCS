<?xml version="1.0" ?>
<!DOCTYPE ftcs SYSTEM "futuretense_cs.dtd">
<ftcs version="1.2">
<!-- OpenMarket/CSClient/FinishAssignment
-
- INPUT
-   id
-   AssetType
- OUTPUT
-
-->
<!-- the checkprivs element needs SessionVariables.pubid -->
<SETSSVAR NAME="pubid" VALUE="Variables.primarypubid"/>

<WORKFLOWASSET.LOAD ASSETTYPE="Variables.AssetType" ID="Variables.id" OBJVARNAME="workflowasset" />
<WORKFLOWASSET.GETOBJECTNAME OBJECT="workflowasset" VARNAME="objectname" />

<WORKFLOWENGINE.GETOBJECTWORKFLOWPROCESS OBJECT="workflowasset" VARNAME="workflowid" />

<!-- For further use check if assigned to no one -->
<LISTOBJECT.CREATE NAME="listobj" COLUMNS="ITEM" />
<LISTOBJECT.ADDROW NAME="listobj" ITEM="Variables.empty" />
<LISTOBJECT.TOLIST NAME="listobj" LISTVARNAME="assignlist" />

<!-- Get the assignment for nobody.  If this exists, work with it preferentially -->
<WORKFLOWENGINE.GETFILTEREDASSIGNMENTS OBJECT="workflowasset" ASSIGNEDTO="assignlist" STATUS="active" PREFIX="workflow_assignments" />
<IF COND="Variables.workflow_assignmentsTotal=0">
<THEN>
	<!-- Remove the nobody assignment variable, in case something fails later -->
	<REMOVEVAR NAME="workflow_assignmentsTotal"/>
	
	<!-- check if active assignment of current user -->
	<USERMANAGER.GETLOGINUSER VARNAME="loginUser"/>
	<LISTOBJECT.CREATE NAME="listobj" COLUMNS="ITEM" />
	<LISTOBJECT.ADDROW NAME="listobj" ITEM="Variables.loginUser" />
	<LISTOBJECT.TOLIST NAME="listobj" LISTVARNAME="assignlist" />
	<WORKFLOWENGINE.GETFILTEREDASSIGNMENTS OBJECT="workflowasset" ASSIGNEDTO="assignlist" STATUS="active,queued,abstain" PREFIX="workflow_assignments" />
	<IF COND="Variables.workflow_assignmentsTotal!=0">
	<THEN>
		<WorkflowAssignment.GetAssignedUserRole NAME="workflow_assignments0" VARNAME="assignrole"/>
		<if COND="IsVariable.assignrole=true">
		<then>
			<WorkflowEngine.GetLegalNextWorkflowSteps OBJECT="workflowasset" ROLE="Variables.assignrole" SITE="Variables.primarypubid" PREFIX="nextsteps" />
		</then>
		<else>
			<WorkflowEngine.GetLegalNextWorkflowSteps OBJECT="workflowasset" SITE="Variables.primarypubid" PREFIX="nextsteps" />
		</else>
		</if>
		<if COND="Variables.nextstepsTotal!=0">
		<then>
			<!-- This element handles finish, delegate, and abstain -->
			<CALLELEMENT NAME="OpenMarket/CSClient/AskFinishInfo"/>
		</then>
		<else>
			<XLAT.LOOKUP VARNAME="_XLAT_" KEY="WorkflowAssignmentNotActive"/>
			<ERROR CODE="4" DESCRIPTION="Variables._XLAT_" SEVERITY="2" REPLACEALL="Variables._XLAT_"/>
		</else>
		</if>
	</THEN>
	<ELSE>
		<XLAT.LOOKUP VARNAME="_XLAT_" KEY="WorkflowAssignmentNotActive"/>
		<ERROR CODE="4" DESCRIPTION="Variables._XLAT_" SEVERITY="2" REPLACEALL="Variables._XLAT_"/>
	</ELSE>
	</IF>
</THEN>
<ELSE>
	<!-- assigned to nobody -->
	<WorkflowEngine.GetLegalNextWorkflowSteps OBJECT="workflowasset" SITE="Variables.primarypubid" PREFIX="nextsteps" />
	<if COND="Variables.nextstepsTotal!=0">
	<then>
		<!-- AskFinishInfo requires a scattered WorkflowAssignment to exist, with prefix 'workflow_assignments" -->
		<!-- This element handles finish, delegate, and abstain -->
		<CALLELEMENT NAME="OpenMarket/CSClient/AskFinishInfo"/>
	</then>
	<else>
		<XLAT.LOOKUP VARNAME="_XLAT_" KEY="WorkflowAssignmentNotActive"/>
		<ERROR CODE="4" DESCRIPTION="Variables._XLAT_" SEVERITY="2" REPLACEALL="Variables._XLAT_"/>
	</else>
	</if>
</ELSE>
</IF>

</ftcs>