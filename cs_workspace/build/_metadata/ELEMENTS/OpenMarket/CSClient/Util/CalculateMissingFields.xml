<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.2">
<!-- OpenMarket/CSClient/CalculateMissingFields
-
-
-  This element represents a "subroutine" used by Drop and TranslateUsingUpload
-  to calculate a list of missing required fields.  It operates completely within
-  the global variable context of those other elements.
-
- INPUT
-
- OUTPUT
-
-->

<SETVAR NAME="OKToSave" VALUE="true"/>
<HASH.CREATE NAME="hFieldList"/>
<!-- see if any other required information is needed -->
<INSPECTOR.GETMATCHINGFIELDS ASSETTYPE="Variables.AssetType" SUBTYPE="lCurrentSubtype.name" IGNORETYPE="file" PUBID="Variables.primarypubid" LISTVARNAME="lTypedAttrs"/>
<LISTOBJECT.CREATE NAME="MissingRequiredFields" COLUMNS="name,description,type,clienttype,required"/>

  <STARTMENU.GETMATCHINGSTARTITEMS ITEMTYPE="CSDocLink" PUBID="Variables.primarypubid" ASSETTYPE="Variables.AssetType" LISTVARNAME="lStartItems1"/>
  <STARTMENU.LOAD NAME="lStartItems1.name" ITEMTYPE="CSDocLink" OBJVARNAME="si"/>
  <STARTMENU.GETMATCHINGARGUMENTS ID="lStartItems1.id" LISTVARNAME="strArgList1"/>
  <EXTERNALCLIENTSCONFIGMANAGER.GETITEMLIST CLIENTID="Variables.clientid" LISTVARNAME="lDropField1" SUBTYPE="lCurrentSubtype.name" ACTION="enable"/>
 
<LOOP LIST="lTypedAttrs">
	<IF COND="lTypedAttrs.readonly!=readonly">
	<THEN>
		<IF COND="lTypedAttrs.required=true">
		<THEN>
			<IF COND="lTypedAttrs.clienttype!=unsupported">
			<THEN>
				<HASH.ADD NAME="hFieldList" VALUE="lTypedAttrs.name"/>
				<IF COND="lTypedAttrs.name!=Group_lCurrentParentDef.name">
				<THEN>
					<SETVAR NAME="errno" VALUE="0"/>
					<ICS.RESOLVEVARIABLES NAME="$(Variables.new:$(lTypedAttrs.name))" OUTPUT="currentVal" DELIMITED="true"/>
					<IF COND="Variables.errno!=0">
					<THEN>
						<INSPECTDATA.GETTYPESTRING SITE="Variables.primarypubid" ASSETTYPE="Variables.AssetType" SUBTYPE="lLegalSubtypes.subtype" ATTRIBUTE="lTypedAttrs.name" VARNAME="typeString"/>
						<INSPECTOR.PARSETYPESTRING VALUE="Variables.typeString" ATTRIBUTE="lTypedAttrs.name" LISTVARNAME="lTypeInfo"/>
						<LISTOBJECT.ADDROW NAME="MissingRequiredFields" name="lTypedAttrs.name" description="lTypeInfo.description" type="lTypeInfo.type" clienttype="lTypeInfo.clienttype" required="lTypeInfo.required" REPLACEALL="lTypedAttrs.name,lTypeInfo.description,lTypeInfo.type,lTypeInfo.clienttype,lTypeInfo.required"/>
					</THEN>
					<ELSE>
						<IF COND="lTypedAttrs.multiple=true">
						<THEN>
							<STRINGLIST NAME="lValues" STR="Variables.currentVal" DELIM=","/>
							<SETVAR NAME="new:lTypedAttrs.name:Total" VALUE="lValues.#numRows"/>
							<SETCOUNTER NAME="valueNum" VALUE="0"/>
							<LOOP LIST="lValues">
								<IF COND="lTypedAttrs.type=int">
								<THEN>
									<CALCULATOR.GO VALUE="lValues.ITEM 9999999999 GT" VARNAME="tooBig"/>
									<IF COND="Variables.tooBig=1">
									<THEN>
										<INSPECTDATA.GETTYPESTRING SITE="Variables.primarypubid" ASSETTYPE="Variables.AssetType" SUBTYPE="lLegalSubtypes.subtype" ATTRIBUTE="lTypedAttrs.name" VARNAME="typeString"/>
										<INSPECTOR.PARSETYPESTRING VALUE="Variables.typeString" ATTRIBUTE="lTypedAttrs.name" LISTVARNAME="lTypeInfo"/>
										<LISTOBJECT.ADDROW NAME="MissingRequiredFields" name="lTypedAttrs.name" description="lTypeInfo.description" type="lTypeInfo.type" clienttype="lTypeInfo.clienttype" required="lTypeInfo.required" REPLACEALL="lTypedAttrs.name,lTypeInfo.description,lTypeInfo.type,lTypeInfo.clienttype,lTypeInfo.required"/>
										<XLAT.LOOKUP KEY="dvin/CSDocLink/V1/IntValueTooLarge" VARNAME="OKToSave" EVALALL="false" fieldDesc="lTypeInfo.description"/>
									</THEN>
									</IF>
								</THEN>
								</IF>
								<SETVAR NAME="new:lTypedAttrs.name:Counters.valueNum" VALUE="lValues.ITEM"/>
								<INCCOUNTER NAME="valueNum" VALUE="1"/>
							</LOOP>
						</THEN>
						<ELSE>
					    <IF COND="lTypedAttrs.type=int">
						<THEN>
							  <CALCULATOR.GO VALUE="Variables.currentVal 9999999999 GT" VARNAME="tooBig"/>
							  <IF COND="Variables.tooBig=1">
							  <THEN>
								  <INSPECTDATA.GETTYPESTRING SITE="Variables.primarypubid" ASSETTYPE="Variables.AssetType" SUBTYPE="lLegalSubtypes.subtype" ATTRIBUTE="lTypedAttrs.name" VARNAME="typeString"/>
								  <INSPECTOR.PARSETYPESTRING VALUE="Variables.typeString" ATTRIBUTE="lTypedAttrs.name" LISTVARNAME="lTypeInfo"/>
								  <LISTOBJECT.ADDROW NAME="MissingRequiredFields" name="lTypedAttrs.name" description="lTypeInfo.description" type="lTypeInfo.type" clienttype="lTypeInfo.clienttype" required="lTypeInfo.required" REPLACEALL="lTypedAttrs.name,lTypeInfo.description,lTypeInfo.type,lTypeInfo.clienttype,lTypeInfo.required"/>
								  <XLAT.LOOKUP KEY="dvin/CSDocLink/V1/IntValueTooLarge" VARNAME="OKToSave" EVALALL="false" fieldDesc="lTypeInfo.description"/>
							  </THEN>
							  </IF>
						</THEN>
						<ELSE>
								  <IF COND="lTypedAttrs.type=date">
								  <THEN>
									  <CALLELEMENT NAME="OpenMarket/CSClient/Util/FixDate">
										  <ARGUMENT NAME="cs_InDate" VALUE="Variables.currentVal"/>
										  <ARGUMENT NAME="cs_OutDate" VALUE="cs_CurrentLongDate"/>
									  </CALLELEMENT>
									  <CALLELEMENT NAME="OpenMarket/CSClient/Util/TimestampToJDBCDate">
										  <ARGUMENT NAME="cs_InDate" VALUE="Variables.cs_CurrentLongDate"/>
										  <ARGUMENT NAME="cs_OutDate" VALUE="new:lTypedAttrs.name"/>
									  </CALLELEMENT>
								  </THEN>
								  </IF>
						  </ELSE>
						  </IF>
						</ELSE>
						</IF>
					</ELSE>
					</IF>
				</THEN>
				</IF>
			</THEN>
			</IF>
		</THEN>
		<ELSE>
		  <IF COND="lTypedAttrs.clienttype!=unsupported">
		  <THEN>
			  <IF COND="IsList.lDropField1=true">
			  <THEN>
				  <IF COND="lDropField1.#numRows!=0">
				  <THEN>
					  <LOOP LIST="lDropField1">
						<STRING.ENCODE LIST="lDropField1" COLUMN="property" VARNAME="enabledfields"/>
						<STRING.ENCODE LIST="lDropField1" COLUMN="value" VARNAME="enabledvalue"/>
						<IF COND="Variables.enabledvalue=true">
						<THEN>
						  <LOOP LIST="strArgList1">
							<IF COND="strArgList1.name=Variables.enabledfields">
							<THEN>
								<IF COND="Variables.enabledfields=Dimension">
								<THEN>
									<HASH.ADD NAME="hFieldList" VALUE="strArgList1.name"/>
									<SETVAR NAME="new:Dimension:0"  VALUE="strArgList1.value"/>
									<SETVAR NAME="new:Dimension:0_type" VALUE="Dimension"/>
									<SETVAR NAME="new:Dimension:Total" VALUE="1" />
								</THEN>
								<ELSE>
									<HASH.ADD NAME="hFieldList" VALUE="strArgList1.name"/>
									<SETVAR NAME="new:strArgList1.name" VALUE="strArgList1.value" />
								</ELSE>
								</IF>
							</THEN>
							</IF>
						  </LOOP>
						</THEN>
						</IF>
					  </LOOP>
				  </THEN>
				  </IF>
			  </THEN>
			  </IF>
		  </THEN>
		  </IF>
		</ELSE>
		</IF>
	</THEN>
	</IF>
</LOOP>

<!-- loop and add optional enabled fields if there are some required fields -->
<!-- or if an ini parameter says to always specify enabled fields -->
<!-- never, enabled, always -->
<!-- this is broken -->
<PROPERTY.GET PARAM="csdoclink.showoptionalattrs" INIFILE="futuretense_xcel.ini" VARNAME="propShowOptionalAttrs"/>
<IF COND="Variables.propShowOptionalAttrs=Variables.empty">
<THEN>
	<SETVAR NAME="propShowOptionalAttrs" VALUE="never"/>
</THEN>
</IF>
<SETVAR NAME="showOptionalAttrs" VALUE="false"/>
						
<IF COND="Variables.propShowOptionalAttrs!=never">
<THEN>
	<IF COND="Variables.propShowOptionalAttrs=always">
	<THEN>
		<SETVAR NAME="showOptionalAttrs" VALUE="true"/>
	</THEN>
	<ELSE>
		<!-- enabled -->
		<HASH.HASDATA NAME="hFieldList" VARNAME="hasData"/>
		<IF COND="Variables.hasData=true">
		<THEN>
			<SETVAR NAME="showOptionalAttrs" VALUE="true"/>
		</THEN>
		</IF>
	</ELSE>
	</IF>
		
	<IF COND="Variables.showOptionalAttrs=true">
	<THEN>
		<EXTERNALCLIENTSCONFIGMANAGER.GETITEMLIST CLIENTID="Variables.clientid" LISTVARNAME="lEnabledFields" SUBTYPE="lCurrentSubtype.name" ACTION="enable" VALUE="true"/>
		<IF COND="IsList.lEnabledFields=true">
		<THEN>
			<IF COND="lEnabledFields.#numRows!=0">
			<THEN>
				<HASH.CREATE NAME="hOptionalFieldList" LIST="lEnabledFields" COLUMN="property"/>
				<LOOP LIST="lTypedAttrs">
					<REMOVEVAR NAME="typeString"/>
					<INSPECTDATA.GETTYPESTRING SITE="Variables.primarypubid" ASSETTYPE="Variables.AssetType" SUBTYPE="lLegalSubtypes.subtype" ATTRIBUTE="lTypedAttrs.name" VARNAME="typeString"/>
					<IF COND="IsVariable.typeString=true">
					<THEN>
						<INSPECTOR.PARSETYPESTRING VALUE="Variables.typeString" ATTRIBUTE="lTypedAttrs.name" LISTVARNAME="lTypeInfo"/>
						<IF COND="lTypeInfo.readonly!=readonly">
						<THEN>
							<IF COND="lTypeInfo.clienttype!=unsupported">
							<THEN>
								<IF COND="lTypeInfo.required=false">
								<THEN>
									<HASH.CONTAINS NAME="hOptionalFieldList" VALUE="lTypedAttrs.name" VARNAME="hasit"/>
									<IF COND="Variables.hasit=true">
									<THEN>
										<HASH.ADD NAME="hFieldList" VALUE="lTypedAttrs.name"/>
										<IF COND="lTypedAttrs.name!=Group_lCurrentParentDef.name">
										<THEN>
											<SETVAR NAME="errno" VALUE="0"/>
											<ICS.RESOLVEVARIABLES NAME="$(Variables.new:$(lTypedAttrs.name))" OUTPUT="currentVal" DELIMITED="true"/>
											<IF COND="Variables.errno!=0">
											<THEN>
												<LISTOBJECT.ADDROW NAME="MissingRequiredFields" name="lTypedAttrs.name" description="lTypeInfo.description" type="lTypeInfo.type" clienttype="lTypeInfo.clienttype" required="lTypeInfo.required" REPLACEALL="lTypedAttrs.name,lTypeInfo.description,lTypeInfo.type,lTypeInfo.clienttype,lTypeInfo.required"/>
											</THEN>
											<ELSE>
												<IF COND="lTypedAttrs.multiple=true">
												<THEN>
													<STRINGLIST NAME="lValues" STR="Variables.currentVal" DELIM=","/>
													<SETVAR NAME="new:lTypedAttrs.name:Total" VALUE="lValues.#numRows"/>
													<SETCOUNTER NAME="valueNum" VALUE="0"/>
													<LOOP LIST="lValues">
														<SETVAR NAME="new:lTypedAttrs.name:Counters.valueNum" VALUE="lValues.ITEM"/>
														<INCCOUNTER NAME="valueNum" VALUE="1"/>
													</LOOP>
												</THEN>
												</IF>
											</ELSE>
											</IF>
										</THEN>
										</IF>
									</THEN>
									</IF>
								</THEN>
								</IF>
							</THEN>
							</IF>
						</THEN>
						</IF>
					</THEN>
					</IF>
				</LOOP>
			</THEN>
			</IF>
		</THEN>
		</IF>
	</THEN>
	</IF>
</THEN>
</IF>

<LISTOBJECT.TOLIST NAME="MissingRequiredFields" LISTVARNAME="lMissingFields"/>
<HASH.TOSTRING NAME="hFieldList" VARNAME="fieldList" DELIM=","/>

</FTCS>
